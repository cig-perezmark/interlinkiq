<?php
    include_once ('database_iiq.php');

    // GENERAL
    $base_url = "https://interlinkiq.com/";
    $empty_signature = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAACWCAYAAABkW7XSAAAAAXNSR0IArs4c6QAABGJJREFUeF7t1AEJAAAMAsHZv/RyPNwSyDncOQIECEQEFskpJgECBM5geQICBDICBitTlaAECBgsP0CAQEbAYGWqEpQAAYPlBwgQyAgYrExVghIgYLD8AAECGQGDlalKUAIEDJYfIEAgI2CwMlUJSoCAwfIDBAhkBAxWpipBCRAwWH6AAIGMgMHKVCUoAQIGyw8QIJARMFiZqgQlQMBg+QECBDICBitTlaAECBgsP0CAQEbAYGWqEpQAAYPlBwgQyAgYrExVghIgYLD8AAECGQGDlalKUAIEDJYfIEAgI2CwMlUJSoCAwfIDBAhkBAxWpipBCRAwWH6AAIGMgMHKVCUoAQIGyw8QIJARMFiZqgQlQMBg+QECBDICBitTlaAECBgsP0CAQEbAYGWqEpQAAYPlBwgQyAgYrExVghIgYLD8AAECGQGDlalKUAIEDJYfIEAgI2CwMlUJSoCAwfIDBAhkBAxWpipBCRAwWH6AAIGMgMHKVCUoAQIGyw8QIJARMFiZqgQlQMBg+QECBDICBitTlaAECBgsP0CAQEbAYGWqEpQAAYPlBwgQyAgYrExVghIgYLD8AAECGQGDlalKUAIEDJYfIEAgI2CwMlUJSoCAwfIDBAhkBAxWpipBCRAwWH6AAIGMgMHKVCUoAQIGyw8QIJARMFiZqgQlQMBg+QECBDICBitTlaAECBgsP0CAQEbAYGWqEpQAAYPlBwgQyAgYrExVghIgYLD8AAECGQGDlalKUAIEDJYfIEAgI2CwMlUJSoCAwfIDBAhkBAxWpipBCRAwWH6AAIGMgMHKVCUoAQIGyw8QIJARMFiZqgQlQMBg+QECBDICBitTlaAECBgsP0CAQEbAYGWqEpQAAYPlBwgQyAgYrExVghIgYLD8AAECGQGDlalKUAIEDJYfIEAgI2CwMlUJSoCAwfIDBAhkBAxWpipBCRAwWH6AAIGMgMHKVCUoAQIGyw8QIJARMFiZqgQlQMBg+QECBDICBitTlaAECBgsP0CAQEbAYGWqEpQAAYPlBwgQyAgYrExVghIgYLD8AAECGQGDlalKUAIEDJYfIEAgI2CwMlUJSoCAwfIDBAhkBAxWpipBCRAwWH6AAIGMgMHKVCUoAQIGyw8QIJARMFiZqgQlQMBg+QECBDICBitTlaAECBgsP0CAQEbAYGWqEpQAAYPlBwgQyAgYrExVghIgYLD8AAECGQGDlalKUAIEDJYfIEAgI2CwMlUJSoCAwfIDBAhkBAxWpipBCRAwWH6AAIGMgMHKVCUoAQIGyw8QIJARMFiZqgQlQMBg+QECBDICBitTlaAECBgsP0CAQEbAYGWqEpQAAYPlBwgQyAgYrExVghIgYLD8AAECGQGDlalKUAIEDJYfIEAgI2CwMlUJSoCAwfIDBAhkBAxWpipBCRAwWH6AAIGMgMHKVCUoAQIGyw8QIJARMFiZqgQlQMBg+QECBDICBitTlaAECBgsP0CAQEbAYGWqEpQAgQdWMQCX4yW9owAAAABJRU5ErkJggg==';
	$arnel_signature_old = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAATIAAACXCAMAAAChviceAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAMAUExURf///wAAACkpKTo6Os7OzqWlpUpKSvf37yEZIebv7+be5hAQGd7W1ggACAgQCGNaWnNapXOlY5yUnKVazhBaUkJazqVahEJahBBaGWNaEHNazhBazhBahHuEhK1aUmMxUmMxGa1aGYxaUoxaGVJaWqXvWkrv3kLvWkqt3kKtWkqtnKXvGUKtGUrvnKWUMaUZpULvGaUZ70IZ70IZpe+cpXPvWhCtWnPvGRCtGXOUMXMZpXMZ7xAZ7xAZpXvvnBDvWhDvGXvv3t73xUrO3kLOWkrOnELOGc6cpRDOWhDOGcXFvWtrY62ttRAQUoyUlHNrc6Va7zFaUkJa76VapUJapaWlYzFaGWNaMXNa7xBa7xBapRAxUqWEY63v3u8Qpe8ZEM4Qpc4ZEHN7c7W9tYyEjN73EDEQUhAxGe8Q5u9aEO/OEO+UEBmM7xmMrc4Q5s5aEM7OEM6UEBmMzhmMjFIQUlIQGe8xpe8ZMe9zpe8pY85zpc4pY84xpc4ZMe9Spe8IY85Spc4IY62l5t73lO/Ota3mrXul7973QnulxaXOa0qM70KMa0qMraXOKUKMKaWlEKUphKUpzkIpzkIphHPOaxCMa3POKRCMKXOlEHMphHMpzhApzhAphHvOrXvO7973a62MvXNSe62E5u/OlK3mjHuE73uExaXOSkqMzkKMSkqMjKXOCEKMCKWEEKUIhKUIzkIIzkIIhHPOShCMSnPOCBCMCHOEEHMIhHMIzhAIzhAIhHvOjHvOznOllO/Oc+9z5u9ac+8x5u9aMe/OMa0pUu+15u+UMe+Uc60pGRmt7xmtrRnv7xnvrc7Oc85z5s5ac4wpUs615s6Uc4wpGRnO7xnOre/OUu9S5u9aUs4x5s5aMc7OMa0IUu+U5s6UMe+UUq0IGRmtzhmtjBnvzhnvjM7OUs5S5s5aUowIUs6U5s6UUowIGRnOzhnOjM7OnHMQUnMQGa3O763OzikQCK3FlHOEWjExEK2MjDoxWs7W762tjN73/wAQCP/v/wAACAAAAAPZ4XcAAAEAdFJOU////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////wBT9wclAAAACXBIWXMAABcRAAAXEQHKJvM/AAAQzElEQVR4Xu1cUW+jvNIuGBsbOyD5Hn03/jUQJZfn3iDl/zc6F42S1feMDWlI0u6e1Tbpvq8frbpNoDCMxzPPjMe8JCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCT8E6FMMQy8MGr6nPAzmGF0uWSiLaYvEj6F6qx3MiNIW05fJnwMZXgPfelsBZUd/fNnpnpR5akMPyAM/n2zUVTD2AtorM5dO/Zs/0yVwZ8W3cCt937cjL4dvd8crLV8GMx0yvNRGksWlmnW2E4Z65w9TYceB1UqVRlTcDu2/daJfP9jlTOdSQm5ACHcdhwK9S0ik1p7tiONOVtgHI0X29dHzwLTDYMdfe+EyJnc7bUmn3qGXh0zvYfq3PgNTK0srNtn2Q/J/EAjqCxjhyoeewQUERs+Oihrf5w09Anyxj5bZ6ehz2lE2cgjGxucdI/jGMoMiNMsJ7v6EZWiZZ7D0nR2zGP8XkIL/ty5aTjxCs0wJ+fPObOPkqk03DeMFLOSwVs1PVw+XP1m3Ph+O469cw3Mj8GhnaHHZ5qZKkY4WAzcGObky0u1YbX0jzKyU4fba2I1eeM3dngzFQKAmlDRD3xERMC8JTkj6mYS9hkobM8gA2uHyXcZi89ieFC4VIPPSQd50/LBmBBx3g52qKbYcw5BpSmIZk9aq8XDZsE1VOEF/G3NbJQW6FydyYfZvbFBYwwmPg+S8VKzuwKUqrBN8LqZ9E+amQbpJO6vmwtvykWmHzYtX4oeGmANf1eAggDZUQx3KU5pulGADK3u6/TLoYqW5qSWzaV8pnX94xyFsYKJyGwmgOBAqP34kQivPejQ8XHh6RJq3Ui4XS1scXl7ot+PE4cIWWEuHWfRhiRkvGtlABcgItp3Hx3/QlQHohZH2R+WCqrwDM8YwQnqIMhZ3beikgoHdFh+aIRfiMpG0fx6yfLNRsC1PJD5L6GGhsTK71brTGF9kFo33fTV46DgRYkLsf7KoswIT7Lqu2fZWRFqA7K/mXcKuTrSz0Bnn0L+u15SLif9Ff8yY06cw62f4CkI1Ug62fULsai8AU4mdjTIJLUY1KPlOw0+jJYYl9ZUxmiV7f2TCv/x/it2YURwXx2n6gaFqoDcz6z7cVBDsH7w1yvFqAMj29PuUdz/CoqH+0dmT+mSCQWO/j1R0lpinOPZD0TZbSfGfcUGwZGCbMI+x/uXA1EusnEozHTrDTJyIcR7LUMz0YzDOU95GCYbQ6y8undILkmwJ1WwT3D9RLmYLbrBQl0s+NsJOmeiHw+vT5BNrbdBY/D80zcTDI82Bk/yHN9vNmFa5g62lee7fV2TOAErzWBe3Vs1Z+uPBFF+EkL6YumvkNrFMc2/MntTg7UfOG9lkVsCkrGpzgjofS6c6723Tyv2wF1EjV2nkfN0zY79F3pXxXup+yvzjlBD1Fh2now/9pKJ7YYXpqrUw1nFDLWeNdZd8TE7LfgijE5f/XmoYqS5z+6ozAzWncMi/JZwggqOnHdPKVi84wQGC4mQV16xiHLyY0R6vqzuc+o8LZNm4kplCtHRehY81xEsQrLG8/XwbGUFlEVksMxf2Vg1hFyX4O7Xqf4AVOdzxvSRLVeHkGiH4BjuLkXvN7S8q8rTs3zXAgXljzD7a2diYi2b8HWVOzV4xnqf5+OlGSuzbt3s7lfMc2hrOvQdEDJuQPArP7Y5s+uvK8ca3uRi9I1Y3MHwnsmZS9TCknVNh74DoJkgGGvfpm8ikKUEiQHZfFEFA8mrQ6bDt+yyRqKKg5M1nFccsSfVpj/GpLEVEriFt0ImPId1fV0J+mMA55LCci8WVRsyb4nJ2gfXL9tvprGJqUqxWRJoM9MhmhhfRfvBuSTSIMvYQi3FVmfMdkOfr4j33KVrT0ThSCtaLKvWZciSdB3qKvkXrXOVlHEIjlmYbxeu0ox5JkiTJNk173k6pkJYvllqpWhZrRnLgwf+qlInLSI5aMblV2opX/taOkeUcO/WX+QTfhdTZglnNX0RoGgRUQsfV1Nvss4/A2VaJt2h4ELelOHK2Y9q98R+gbuYMkvdLIYy5AK12MQq2U3W+YdgRqkxK0ljt1ZsYneBXAr2DaBiniSXrR9IkXfQoo1NETDAL/ElxuZwoJiV8Ga3aimiyj5YGn8eTibkSbulxgxHHozxR6SH89/fMYE/AcVdLmwHjnHvBsbSvaGyryLQvwsKTEB+KXP5Zol0MAsLJKnzr1mvrw7QlR1atrtHYEL3BeHZDXY3GAK/WC3aEqNtSW+m6rUrzk9UUrM4bLP8jeRF4Y9U/HuCWrsdA4OFN7u3nNDN9R7tnlQI/gDKhirB5XKS6jwUhdSpKAfy/RdrTapYU0qjjG2XrRq/AEPNwf69N4ziNBt5Sxq7vdRpqqtIiLLfPrOn4RplaEeiZZvzQKog7F4gp1NhqRW5SjxYVtx7jq+ptXBJ4kpVfWp2ZTVYpD7yPfSeEKdzb32+Y/x2Vaic6irS0/D9vGtSKXPRu778FFCGdsfpQwS++p1+91hS311worLbyiNNBmikC5N2LvpRgQY5AEysyY9XfXkwu8Mnj6WK0QmkixiBOf5hYLToe4ns8o7csVErg6VTF8aRjZ8vBCrux/OigTLcb8eFYSozcN/3fPoYYSyN//+M2ORwUderQmTfhS68UA86Th2Byqx7ucrHomtDVfuilcSYYQQhnbw0NThdDTIMlzExbnqh5TbQFVp5P0rG9N1ZOVWiaglyHQdVvPdR3oK2bkDz8RmgndFhNC64nCl42zCd/YBzLuJOCtjcT2T+CLFQcUH7acUCEyHOniHI3QQjwwHcVPZ2FDnLd2QAk5ppUAUMU8ZlAZJY9AvyibibC7/meBLmp9HnYpVJWV+ntREmVpxixmE8XMeRXSVzFyDR6v30DIamgiapzyqmZCxUkPR2oIZCOhBkrrN8DGfckfkjgOHTpd7de3WgZiQdl0tiZJB0kBoqwdMkZpJg+AFDlPEZTrg5jIcEavEnBfcOj7voVa3WW5jYGkLiP3owGlPSA8zI3Wu8Al2jo9mUJ3WhQYqN9yuyZGI4HlprcHtYGP0p3EZUGb7CWGP6O8HwQ2YNfBCm5CTzCAZwT+YPoYL9vxdWwClwobnZyLR0VXiychgxJCvNwm1HHtpcppOKkXRItgryVq77fB9EuUhXFdgXG+3oWG87qsbR1ocmkMH7aZgaXKydTK2K0CA+HcVdOwuhiCYuLhTmWqzinv0vXILcsZ53HfdMw65wooky0y1s+QKZQw/MVYr9AUwwsnk1tyw25Dai5weM38GTbYfCBqtiec6E6G1RwLtoPAA9ULFxbjv2NMt6Tk5EhqUNOKE5ngRLlr5tXLR8skof2z6gMbqGWa4WIYgHQ5mnGp47jOQKruBawdS2SBVIGr9q8AI5HmP7d+dMkUpjqOAS46Yiqu3iN9eP2+Bn+LARkDlYzrL29AFiAXGyl6nH/j3XNH61ykS7ofHQeeNFnjsLvwnTnFwQBUJ/eA3ziHkLEoGfNOUmtwqHWr6RSTLh+jAFaVik8Jhqq1rGAGLsYonk9OapWyU7utdzFDdtUPFtLdsg16Ja8sFUGEip93kP2pLtpohF2zzC3AfHCcUaXKF8bRvPoTbyxyTznn6Soc4yR9u+i7lfrA/cnnrm8QEam71L5TF+FNXIHjYwk8bDTkr8UR1VYmwPr04bW2HYWgCQpRhxfh9MUA3cxHtAqmBioTGf9Vu22onGBxuDI7ls4yxVMPUryt81Yaqy6x7YjtbrtLPdGo5SMuf5K9/KjMUlH+ogjB2PcB+00Y/8IW8EJs5ZZnYj87Tv6D4iwdaIGicKNCQU7nCWasqWYA4OLOewbXEoqBnhAYcreBHWDxWPyXO2h8dAOjS4OttvcBxTwfd8DQVIEaIrhVZ2hKfk8FXIxmma0QYpt74c2JBw4OkWG7FVaJ8kF7XU2YBopHcUxncrpKuIWqSmydPAjSHQVmH2StriJP0r+B7MzszpK2TGUAaZJckMW/WfFoCjynKQgwIhlx4895ftRoEd7XPnaYNj1YVRwM1WjgIqVWwYjkxdZxjr0PSocE3t4Hwr68T/eQ8HItpA7yuauJmGFcMf7NuKbgRHLMVmMRUGsnUYx2IOzsvS14usilYGVvCfknp/iFjh2vDjdEEoL5A+xCQyQAEKuMGsxXfdvPoPmYnzQOZVkFlZNwX1D6DmZl0w4yjQdVMZ7Nm140VTdtk1eJqipH35iIOtOU3rKTr30RV0+IwsOwQv1vJ+8hFgjmTGxMteTlYeSUBKZqGxq52dljzZ6roYVK6DxRNVWxwwW7q5hJON3w8Osy2o9a1lteAkiMDh1npZswYEDeLck5kdcKoXcGzLG1yhCF71iCEKSof+lxqjJzXVJSk2m3zlBkMxVMMJGMzToOwaATSeRvTXDQik+53gpsATwF4wR8O+dOktTkNaGziQGsDXbiRch93FN0ml6SN7eGdEhFPRHzMo5NBFKQ3sBQ9Pvx7YCvoFnwQn2xSG3L/W8j/wLjFzRtC4lLkBMUD8cJ9lGUB1iEMXAK98jyQt3wpQNLoWYwunOxlwKB0hBM5kuCQVMkrAg2czUJnb2JCuZMxtaMaUoFmMq2qgrZS3+3OHUHear3eG4mLSmb9YHi4xFr09b4wmTzLxcjUiH2k8sZ5AAWjVsYYx4tSQOUPm2bzDsL/L/DmqsLslQEMFPzsdKqNorPfUxVuQB0IwWFGnkCknzSra2rbSOu8DuSs9LFDva10jNZro+wlMldmCb4W4twscQWcn7+x1KOdl+6WdhT2Z8+/wUdBo8N4VcR293zHHw3MhZ6MCMH49yzx7+SAzTHCS+SfA7MWVkR+7ln/GR2ZMMZZNTgCECenA5kLXKvgcDGGksqe4ORB/QY2/4YzgyoloeH83nFPSc7cp0cT5hKtvL3X2jhKkuSa30RVmzkxjTMIxpBybSJ8gc76QuQzxE2H9l7oNT7TiiswRV/sFhdE49jI6sfi5Ovh2mSViboRAOn0EmZQyBy2b3AaB0miiQ597jVvEHV/0dPc3HhTQqezXg21bGzwT7csvb943omwo+l2gwsBfyPwTnKrX9WEofrUv9wR2yof3ETq9BXZ1gdIsTiiL4cAHfHFxg7IqDpYXy0D5CwB9mnR2mwYAgUbqZrQtUuGe48ZrekHFDUpz/Y6nK5n/STgvoNzZb4mgLGr4d3otywhu9nUNqn8XgoMi3FQdaLKD3Vi4sUoVbb1fFmD/xVhPyVmWL6oaVCLUF5vwC/9BhPgXAtEuqmzhzpCoUpXuvSSuin+mZ/odlEVYig46m1kwVSzh42q2SWq6BzVXAWZ3pgw4w9btf7CrbsKEGVXcXA6EzP6la/1I+6OPT9gc/bdg2vUeXy9C76FrOW/0hSNLuEFYFa5DSqzWlJTTOmL+pE2ifwdU1wrRU0oMMtbYN9r7kifX/ylKNaU8vHHcEL1lc9dIwqdQ3PfWGOTq325PwDeFWvt+rd5GCbrxjNfV/H2obAONVf/Nr1+bkfAB1NA4q6jqqJ/5Rry/COW6p4V70tjTXg3zd0GZVoyGtqpdbVZI+AiFb9quGPNa//e9jSzhE5RWNHZo86xONvZrKI3P3aaXdd18r+7274vT0OhcUKx83rvn/jIo7uosWy1fq5nwGWIbUE69Wwm/COr2vN85m/ARVNF1yY0lJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCT8u/Hy8v/8auvzrEavqQAAAABJRU5ErkJggg==';
	$arnel_signature = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAANwAAABjCAYAAADwxm4hAAAACXBIWXMAAA9hAAAPYQGoP6dpAAAKT2lDQ1BQaG90b3Nob3AgSUNDIHByb2ZpbGUAAHjanVNnVFPpFj333vRCS4iAlEtvUhUIIFJCi4AUkSYqIQkQSoghodkVUcERRUUEG8igiAOOjoCMFVEsDIoK2AfkIaKOg6OIisr74Xuja9a89+bN/rXXPues852zzwfACAyWSDNRNYAMqUIeEeCDx8TG4eQuQIEKJHAAEAizZCFz/SMBAPh+PDwrIsAHvgABeNMLCADATZvAMByH/w/qQplcAYCEAcB0kThLCIAUAEB6jkKmAEBGAYCdmCZTAKAEAGDLY2LjAFAtAGAnf+bTAICd+Jl7AQBblCEVAaCRACATZYhEAGg7AKzPVopFAFgwABRmS8Q5ANgtADBJV2ZIALC3AMDOEAuyAAgMADBRiIUpAAR7AGDIIyN4AISZABRG8lc88SuuEOcqAAB4mbI8uSQ5RYFbCC1xB1dXLh4ozkkXKxQ2YQJhmkAuwnmZGTKBNA/g88wAAKCRFRHgg/P9eM4Ors7ONo62Dl8t6r8G/yJiYuP+5c+rcEAAAOF0ftH+LC+zGoA7BoBt/qIl7gRoXgugdfeLZrIPQLUAoOnaV/Nw+H48PEWhkLnZ2eXk5NhKxEJbYcpXff5nwl/AV/1s+X48/Pf14L7iJIEyXYFHBPjgwsz0TKUcz5IJhGLc5o9H/LcL//wd0yLESWK5WCoU41EScY5EmozzMqUiiUKSKcUl0v9k4t8s+wM+3zUAsGo+AXuRLahdYwP2SycQWHTA4vcAAPK7b8HUKAgDgGiD4c93/+8//UegJQCAZkmScQAAXkQkLlTKsz/HCAAARKCBKrBBG/TBGCzABhzBBdzBC/xgNoRCJMTCQhBCCmSAHHJgKayCQiiGzbAdKmAv1EAdNMBRaIaTcA4uwlW4Dj1wD/phCJ7BKLyBCQRByAgTYSHaiAFiilgjjggXmYX4IcFIBBKLJCDJiBRRIkuRNUgxUopUIFVIHfI9cgI5h1xGupE7yAAygvyGvEcxlIGyUT3UDLVDuag3GoRGogvQZHQxmo8WoJvQcrQaPYw2oefQq2gP2o8+Q8cwwOgYBzPEbDAuxsNCsTgsCZNjy7EirAyrxhqwVqwDu4n1Y8+xdwQSgUXACTYEd0IgYR5BSFhMWE7YSKggHCQ0EdoJNwkDhFHCJyKTqEu0JroR+cQYYjIxh1hILCPWEo8TLxB7iEPENyQSiUMyJ7mQAkmxpFTSEtJG0m5SI+ksqZs0SBojk8naZGuyBzmULCAryIXkneTD5DPkG+Qh8lsKnWJAcaT4U+IoUspqShnlEOU05QZlmDJBVaOaUt2ooVQRNY9aQq2htlKvUYeoEzR1mjnNgxZJS6WtopXTGmgXaPdpr+h0uhHdlR5Ol9BX0svpR+iX6AP0dwwNhhWDx4hnKBmbGAcYZxl3GK+YTKYZ04sZx1QwNzHrmOeZD5lvVVgqtip8FZHKCpVKlSaVGyovVKmqpqreqgtV81XLVI+pXlN9rkZVM1PjqQnUlqtVqp1Q61MbU2epO6iHqmeob1Q/pH5Z/YkGWcNMw09DpFGgsV/jvMYgC2MZs3gsIWsNq4Z1gTXEJrHN2Xx2KruY/R27iz2qqaE5QzNKM1ezUvOUZj8H45hx+Jx0TgnnKKeX836K3hTvKeIpG6Y0TLkxZVxrqpaXllirSKtRq0frvTau7aedpr1Fu1n7gQ5Bx0onXCdHZ4/OBZ3nU9lT3acKpxZNPTr1ri6qa6UbobtEd79up+6Ynr5egJ5Mb6feeb3n+hx9L/1U/W36p/VHDFgGswwkBtsMzhg8xTVxbzwdL8fb8VFDXcNAQ6VhlWGX4YSRudE8o9VGjUYPjGnGXOMk423GbcajJgYmISZLTepN7ppSTbmmKaY7TDtMx83MzaLN1pk1mz0x1zLnm+eb15vft2BaeFostqi2uGVJsuRaplnutrxuhVo5WaVYVVpds0atna0l1rutu6cRp7lOk06rntZnw7Dxtsm2qbcZsOXYBtuutm22fWFnYhdnt8Wuw+6TvZN9un2N/T0HDYfZDqsdWh1+c7RyFDpWOt6azpzuP33F9JbpL2dYzxDP2DPjthPLKcRpnVOb00dnF2e5c4PziIuJS4LLLpc+Lpsbxt3IveRKdPVxXeF60vWdm7Obwu2o26/uNu5p7ofcn8w0nymeWTNz0MPIQ+BR5dE/C5+VMGvfrH5PQ0+BZ7XnIy9jL5FXrdewt6V3qvdh7xc+9j5yn+M+4zw33jLeWV/MN8C3yLfLT8Nvnl+F30N/I/9k/3r/0QCngCUBZwOJgUGBWwL7+Hp8Ib+OPzrbZfay2e1BjKC5QRVBj4KtguXBrSFoyOyQrSH355jOkc5pDoVQfujW0Adh5mGLw34MJ4WHhVeGP45wiFga0TGXNXfR3ENz30T6RJZE3ptnMU85ry1KNSo+qi5qPNo3ujS6P8YuZlnM1VidWElsSxw5LiquNm5svt/87fOH4p3iC+N7F5gvyF1weaHOwvSFpxapLhIsOpZATIhOOJTwQRAqqBaMJfITdyWOCnnCHcJnIi/RNtGI2ENcKh5O8kgqTXqS7JG8NXkkxTOlLOW5hCepkLxMDUzdmzqeFpp2IG0yPTq9MYOSkZBxQqohTZO2Z+pn5mZ2y6xlhbL+xW6Lty8elQfJa7OQrAVZLQq2QqboVFoo1yoHsmdlV2a/zYnKOZarnivN7cyzytuQN5zvn//tEsIS4ZK2pYZLVy0dWOa9rGo5sjxxedsK4xUFK4ZWBqw8uIq2Km3VT6vtV5eufr0mek1rgV7ByoLBtQFr6wtVCuWFfevc1+1dT1gvWd+1YfqGnRs+FYmKrhTbF5cVf9go3HjlG4dvyr+Z3JS0qavEuWTPZtJm6ebeLZ5bDpaql+aXDm4N2dq0Dd9WtO319kXbL5fNKNu7g7ZDuaO/PLi8ZafJzs07P1SkVPRU+lQ27tLdtWHX+G7R7ht7vPY07NXbW7z3/T7JvttVAVVN1WbVZftJ+7P3P66Jqun4lvttXa1ObXHtxwPSA/0HIw6217nU1R3SPVRSj9Yr60cOxx++/p3vdy0NNg1VjZzG4iNwRHnk6fcJ3/ceDTradox7rOEH0x92HWcdL2pCmvKaRptTmvtbYlu6T8w+0dbq3nr8R9sfD5w0PFl5SvNUyWna6YLTk2fyz4ydlZ19fi753GDborZ752PO32oPb++6EHTh0kX/i+c7vDvOXPK4dPKy2+UTV7hXmq86X23qdOo8/pPTT8e7nLuarrlca7nuer21e2b36RueN87d9L158Rb/1tWeOT3dvfN6b/fF9/XfFt1+cif9zsu72Xcn7q28T7xf9EDtQdlD3YfVP1v+3Njv3H9qwHeg89HcR/cGhYPP/pH1jw9DBY+Zj8uGDYbrnjg+OTniP3L96fynQ89kzyaeF/6i/suuFxYvfvjV69fO0ZjRoZfyl5O/bXyl/erA6xmv28bCxh6+yXgzMV70VvvtwXfcdx3vo98PT+R8IH8o/2j5sfVT0Kf7kxmTk/8EA5jz/GMzLdsAAAAEZ0FNQQAAsY58+1GTAAAAIGNIUk0AAHolAACAgwAA+f8AAIDpAAB1MAAA6mAAADqYAAAXb5JfxUYAAFCqSURBVHja7F13fBVV9v/Om9d7eiMJKYQESCjSkSaC4ioK6NrFVbGvDRUVESy4rqKuuqsudgSBlS5IDTVCBEINCSSB9P7yktf7zO+PnHkMbxPAguL+cj+f94G8mTf33nPO97R77h2G53l0ta7W1X6bJukiQVfral2A62pdrQtwXa2rdbUuwHW1rtYFuK7W1bpaF+C6Wlf7XZu0oy8PHz78mw9Eo9HA5XKhrKwMLpcLHMchPDwcSUlJ4DgONpsNc+bMgcPhwLXXXotrr70WDMPg/fffh9PpxLRp02C1WrF161bcfffdMBqN+Nvf/oannnqKOXnyZNr69evH5+bmXtnY2BjVp0+f7UOHDv1Mo9FUcRx3UefFMAzq6uoQFRWF0aNHw2g04rPPPsOyZcuQk5ODOXPmoK2tDQzDICkpCQzDnNGGEglcLhcqKytRXV0Nj8cDu90OuVyO1NRUHDx4ELGxsYiPjwfLsuhsLhKJBJs3b4ZUKsWQIUNQUVGB7du3Iz09HVOnToXb7cbp06eRkpKCxYsXIy4uDocPH8a0adOQkpKCmpoaHDx4EEVFRUhOTkZrayvsdjsUCgVkMhk8Hg+GDBkCpVIJnU6HmJgYREREAABee+01jBw5Es8++yzkcjl+7WUolmWxZs0arFq1CiaTCVqtFpMmTYLFYsHy5cvxpz/9CdnZ2SgrKwPDMLBYLEhISIBKpcLF4r3RaMTSpUuxYcMGADhrztL/RS3CMAxkMhmkUqm6uro6rqKiIqelpSXL5/OlAohwuVw9rVZrilarrea7FiK72u9t4f7oYON5Xt7Q0BDlcrkmPv300/eXlpYOEt9TWlp6s9vtjr/nnnuus9vtlos9nj8yLSUSCSQSiYxhGBUAGdPeeIZhQB+eYRiOYZgA/euTSCQ+iUTSpcj+1wHHMAzDsqyupqZmwjPPPPNcVVXVZSK3yieRSDiO46Qcx7F6vV6XnJycaLFYLirgpFIp6urqcAkbUkb0b/DDMAzj8/kkbrc70uPx9PX7/eM5jsvx+/2SQHvjA4FAQCKRuAOBQKvP52thWbbJ6/WWejyekx6Ppx6Ag2EYDkAAANcFt/8RwPE8D4lEAp1Ol15WVvbSZ5999mefzyeeW1u/fv3mjRo1an9+fv6T+fn511ssFm9BQUGr0+m8aGNiWRZZWVmXbsZMIoFMJtMHAoE4qVQaI5PJYiUSSSzLsil6vT5+8eLF8S0tLclOpzOS4zgpz/OS0tJSQXmINQh//PhxAOAZhuGkUqnDaDQ2Go3GcoPBsI9l2V0ymWyPRCLx/JpxE8MwkEqlXYD7rcEWHR2NXbt2Tfv3v//9nM1mS/F6vXJRUH2ie/fuT48bN26r0+nMqaqqSqTf7a+urm7weDwXZVwcx4HneWRmZl5StFIoFFAqldl6vf6aY8eODd+7d28GwzBGj8cjl0gkUqfTKZVKpZJAICDx+XxSnuclFzpfofl8PoXL5QprbGxMl0qlo4qKih50uVzPTp48+VuNRuMOBAK/Ctj8fj9yc3MRFRX1hwGe9I8MNK1Wi7i4uO6rV69+obGx8bqWlpZY8T2ZmZlfnDhx4v0ZM2Yc79mzZ8Qrr7zydF1d3YDY2NgfhgwZ8o7Vag38mmNiGAaBQAA+nw8GgwFDhw6FRCK5JNxJnucRGRmZuWLFimdKSkpGORyOcI/How8EAmIZ8ADgyDuQarVam9FoXGG1WoutVmu0VqsNT0hIiGttbY2zWq0RgUAgzOfzaTojB8dxMq/XK/N6vdoNGzbcPXbs2O9lMpnb5/P9aoAzm83BjGgX4C5S4zgOSUlJWLJkyVUrVqx4orS0dAzHcUrRLU2RkZFvKBSKFe+//37Vrbfeinnz5t1fUFAwOS4urmzo0KGvqVSq0xaLBRLJL1uKtNvt8Pl8QQGIiYlBZmYmqqqqEBkZiYvlsv7UptVqh+Tl5c09ffr0FT6fTy5yK82JiYkrjUbjpoSEhOZhw4YFvv7668dKSkomBwIBZtSoUWtPnDix+eDBg2qZTKbQ6XRqh8OhlslkyuzsbJXf748wmUw9XC5XFsdxPaxWa6bf7zeG9t/Q0NBfqVTG6HS6ll8KOJ7nIZVKodFoIJPJulzKi62p4+LipO+99970RYsWPVheXp4jvh4eHr6rd+/eb58+fXqjzWbzGgwGHDlyJGLLli1/stvtntTU1PcjIyO3trW1gef5n219WJYFz/O47rrr0K1btyDofD4fSkpKwHEc/H7/b5pRpAxth9dKS0ufOHny5NXCdyqV6lRWVtZGvV6/sa6u7pBOp6uNjY3FuHHjsGjRoqcASNxut9pgMHSfPn26Y8GCBY5Dhw7B4/GgtbUVTqczqFBsNpsSQLTdbo+OioqKV6lUvVtaWq6wWCxXgIoreJ43AoiRSCTFDMPwv4T/CoUCPp8P8+fPh0ql+kNlgv9wgFOpVMnffffdg7m5udOdTqfYl3CmpaUtufzyyz+RSCQ/Hj58GJMmTYLRaERzc7PMbreHh4eH7zEYDMsrKir8HMfB7Xb/JGbxPA+GYaDT6dDW1ga1Wo1BgwZhwIABcLlcUCgUOHXqFA4dOvRbZ2fh9/vBcRykUul/gY5hGFRXV59gWXZtt27dnH6//zTP83t79OixR6FQmCsqKjBs2DCoVCqmqKgorampaQAACc/zsNls/VJTU6OnTJnSpNFooFQq0b9/fzQ0NMDv92PMmDEoLCx0Hzx4sCo+Pr4qJSUFKSkpa6urqxtXr159hXgYPM/zHMf97AVnnuehUqkQCASwdu1arFq1CjfffHMX4C5Gtk+v10MqlQ6qqal5fOfOnbeL75HL5VVarfaL1NTUD3NycpoOHDiACRMmYMSIEZg0aRJWrFgRa7Va1REREW3Dhg0LREZGwufz/WR3UojRDhw4gIqKCshkMjidTlitVrhcLsjlcrhcrt9FAITYkdbN/gt0MpnsPYVCYczIyLC7XC5TRUUFmpqakJGRgYkTJ2L06NGwWCz8119/fbPD4YgOBnUeD1dXV8enpqZi8uTJOHToEKZOnYqTJ09i69atmDBhAqRSKY4dO4a0tDT07dtXarfbh9pstrEQlQ5KJJJamUxWK5PJfnatgUwmQ0tLC3bs2IG9e/ciPDz8D7fOKb3UwaZQKOBwOOQ7duwYU19fP6ekpGR4SGxSnJCQ8KbP5/uytbUVLpcL8fHxuOKKK1BTU4OtW7dmL1y48K8mkynK7/fn9OzZM+eee+7Z+nOW3yQSCdxuN44ePRp04S6VxjAMOI6D1+uFXC7vCHRtPM+3OZ1O2O12REZGIj09HampqVAoFDhy5AgCgUBWbm7uX3w+n5IE3KrT6Q64XC5zUVER6uvrg+VRdrsdEokEPp8PgUAAcrk8rKGhIVmhUIw+cuTI/SUlJb1EffvHjBmzyOfz1ba2tl6wqy2RSIIW2+/3Q6VS4dChQ1iyZAn69u2LysrKP1z+QXopg00ul8Pv9+u+//77ybNnz34VQJJIwFyxsbH7evfu/bLb7d7e1NSExMREyGQyxMfHw2azqSsrK4fNnj379aampsEA0NramlZeXp7u8Xi2Wq3WnxwfsSwLv99/yS5iCxZYAJ04ySQIrV6vh9vtRk5ODv785z/jyJEjWLZsGdRqdUpLS8tLfr8/jcDm0uv1i+Ry+fKysrLAmjVrYLFYcNNNN0Emk0mkUqmKZVn16dOn9dXV1Rk+n2/YkSNHJu3bt6/vWQImldqio6N3TZs27Z22tjanyWS6IKAxDAOXywUhsWUwGKBWq9HS0oKIiAj8USvyLlnA0bqKdt26dffNnj377wBkItfCzrLs6jvuuON5l8tVs3PnTlx55ZWYMGECjh49CgD6urq6ya+//vrbAMRxnkShUEgVCgW0Wu0FCzHP8/B6vQgEAhCSLZdqE1s6jUYDnuehVCohk8kgk8kwdOhQVFRUAABsNhsYhpGo1eoUl8v19OHDh28RnhMTE3PC5XJ9nJ+fb0lPTzdERERI3G43a7Va9Y2Njalms7mn1+vtOWfOnJHV1dX9OkgquVQqVUtaWtqq0aNHv+xyuVpYlj3vehnDMHA6nZBKpaivr8eGDRugVCpx7bXXIjY29pJZZvmfAhzDMNBqtfJly5Y98Pnnn78uAhsvlUq9PXv2nF9bW/uOw+GwORwOXH311RgzZgzq6+vBsqyhsbHxrnfeeeed0PlJJJITMpnspM/nw4UseAsuo9vtRm1tLfbv349PP/0UaWlpv3g54WI2juOgUCiQkJAAnueRlpaG7t27Y8yYMYiJiUFRURE0Gg04jpP6/f4+ZrP59UOHDk0UP8Pr9fo4jpsskUh8PM8nMwwTZbVao//zn/8kL168OB4AG9ot1VJyCoWiOSkpad3gwYO/yM7O/rGkpOSC+e52u7Fx40ZIJBKkpqZCrVZDJpP94YF2yQKO53mEh4dj6dKljy9evHguAHHViOXOO+988vjx48v9fr/dbrdj4sSJUCqVsFqtUCgU6vr6+rs+/vjj+R3NbeTIkXssFsvB559//rzM43kearUaJSUl0Ov1ePrpp8Gy7Fmu2qXQWJaFTCZT8DzvR3vN4llz4Hk+6FIGAoHgd3q9nt23b9+d77777qxAINA99LnNzc0DAfQ/fPgwjhw5wvA8z3Acx6DjPZQWhmGqunXr9mNiYuLmzMzMH7VabUN1dbX/QqtKpFIp7HY7vvjiC8TExPzhSrb+kIDjeR7x8fF49913X1i3bt2zfr9fLWg+jUZTERUV9ZBcLt/FMIzTZrOhX79+SE9PR3l5OfR6vbSgoOCuL7744jW/398RKpovv/zy7ydNmmRubW09b6ImJiYGn3/+OTZs2IBbbrnlksuGqdVqGAyGCatWrbqjqamp10033fT6wIEDVzqdzmD8G6pUBPcyNjZ21Jo1a55pbm4e6fP59DhTwCy+VwJaGhAnQyUSSXlsbGxNWFhYXV1d3YmrrrrqqNlsPrlv3z5TIBBwsyzrkslk3o6WJzqjNQAcO3YMmzZtuqQ9h/8pwPE8j27duuG5556bsX79+idcLpdBlIk8Nm7cuEeOHTu2F4C/srISr732Gq644gpYrVZERUVh165dt/7rX/+a63A49B09f8CAAcsyMzN3yeVyXqfTdToOjUaDbdu2Ydu2bSgqKoJCoQDLspcMwyQSCRQKRcZ77733UnNz83Cz2RwXCASUq1at6pWXl7eS4zhYrVbExcXh1VdfhcvlCtI3Ojo6cdGiRU8cO3bsBpPJlMhx3LnKNOwKhaI4Ozu7WKfTVZjN5uqUlJTK6OjoulWrVjnkcrmXZVmnXq93eDwen+DyiT/na1qtFgcOHMDJkyeRk5MDi8XyhyrT+sMCTgDbO++8M3358uWPO53OKOFadHT03htuuOEJh8Oxj+M4mEwmzJ8/H9nZ2WBZFlFRUfj222+nLFiw4JWmpqaYjp4fExNzMDo6ehHHcWYhjd3RGPR6Pex2O2pqanDkyBG0tLTAaDReMgqJypgmfPvtt69UVlZeJvBPp9PZW1paTjU3NwMA4uPjcfvtt8Pr9YJhGERGRkKv19+0bt26B6qqqoZ4vd4OM0ZpaWl7AewZNmzYiba2toqDBw82abXatqioKFsgEHDExsZ6ExISgplawU29kIVsqVQKrVaL1tZWeDweGI1GuN1unDp1Cs3NzZDJZJeUYvtNAfdbTpxlWWi1Wrz//vtTPvjgg2fb2toSRRpwV//+/Z9OTU3dn5+fD7PZjNtuuw1XXXUVKioqEBUVhbVr147/5JNP5tbW1nbvpAvz9OnT/56Tk3MoMjISLMvCYDAI63tBTSyRSJCbm4vk5GRIpVKoVCrIZLJLpvBYpVKxbW1tkzdv3vxSZWVltvj6mDFj1qWlpe1qbW2FUqlEdnY2Bg8ejLa2Nvh8PuWcOXOeOHr06D01NTU9OrHqJ/v06fOB3+//kWXZ0/369TPX1NSgsLAQPp8Pfr8/uLAugPinNK/Xi/r6ehQWFmLq1KlIT09Hbm4uqqurO3V//18B7iLvyTwrm2a1WlFRUTFk/vz5c1taWtJFYNudmZk5MywsbL/ZbIZEIsGsWbMwfvx4uN1uREZGYuvWrYPefvvtOdXV1dmddTFq1Ki3r7766rWJiYlen88HpVKJ48ePo6ysDJdddlkQVBKJBEePHkVUVNQlpWmF5E1bW9sVW7ZsefnUqVPiBWXI5fLyjIyMLwYPHlzr9XphsVhQU1ODsrIysCyr8ng8937++eezAHRo1ZKSkg7dfvvts06fPr2huLgYPM/D5XLB4/FcMAj8fj88Hg98Ph+sVis8Hg+0Wq2QbUZycjIsFgvy8/Mxbdo09OrVCytWrEBDQ8Mll4T6XQDX1tZ20TsW1rfq6upS33rrrb+3tLQEQZOamnogPT19Fs/z+Xa7HRERERg6dCgmT54Mh8MBo9GI7777LnPOnDkvl5WVjeisj8GDB389efLkf0mlUrff70dxcTGsVisOHTqEU6dOISMjA1qtNlhorFQqLzmwabVanDp1akBubu6Lx44d6xVyi+Ouu+56e/jw4bu1Wi3UajXWr1+PDz74AGFhYQCg4zju3s7AFh0dXfboo4/OGT58+IbXXnvtJ43L5XLB6XRCIpEgNjYWaWlpSExMRHZ2NrRaLcxmM1wuF0pLS9G/f3+cPHlSWIqA2+0Wsqu/aYH3JQu4i50pYhgGcrkcXq834vDhwzOrqqpGiy6fHjt27IuRkZG7d+zYAZ1OB5/Ph9TUVGzdulVwCRNnz579cllZ2dWd9WEwGLbffPPNswOBgEUul8PhcGDDhg0oLi4W9tEFKxoutTItlmXBMAzUajVOnz4dv2bNmhlHjhwZFWpYRowY8dWTTz75ZXJysstmsyEqKgpHjhyBw+GAQqEQ6MwxDMOFbiQ1GAyWG2+88d9Tpkz5rqCg4ILnz3EcWJZF3759ER0djfr6egwYMAAAMG7cOIwdOxa7d+/GqlWr4Ha7kZeXh+zsbHS1cwDuYu4xEirbW1tbZadPn776o48+ul8kBOZAIDDX6/VuEqrvPR4PcnNzsX37dnAcB71eH9XY2DinpKRkakfpbIZheLlcfiIiIuJZi8VSrVKpcPr0aZSXl8NkMiE6Ojq4HnWpNUHobTYbvF4vDAaD5quvvpqem5t7c8itgd69e2947LHH5ioUCofZbA4eJRgeHo7LL78cYWFhCAQC3tra2iMNDQ05EK2fyWQy96BBg/4zYsSIL+vr6yGRSOD3+89ZtiZex4uJicH06dNhsVjw1FNPBbcnWa1WOBwOVFRUoLCwEAkJCfg1Npv+zwPuYqZm5XI56uvrmY0bN2Z89913M0Ra3XvllVe+d/To0TVerzfIfLlcDplMJrgjYRKJ5MX9+/ffEwgEOlTJOp2uesiQIfNaW1sPaDQa2Gw2zJgxA2PGjIHBYPjN4tOfm/IHgOPHj6O2tpYtKyu74cCBA/fg7KqOQHh4eMHMmTMfZxim2ev1Bq2Z1WrFuHHjMGnSJLAsi+bmZt/DDz98urCwkBdnZpOTk4917979U4fDYRKsVnh4ODwez1lVHcKCOcdxkMvl0Gq10Ol06NmzJ6xWK6xWa7BQWgxMoUCg6wTCCwTcxTwclZ4d4XK57mhqauov8CklJSVXJpN9CsCqUCjQ2tqKpqYmJCcnk/JnDB6P55nvv//+rx1ZNhJYa3Z29tJXX311scVigcFgwObNm6HRaISqc/Hvfi9pYETj5zsah0wmY1QqVU5ZWdnjzc3N4oJtzmAwFN5+++33eTyeciHhIPCLYRh4PB64XC7IZDKmtrY25scff7yW4zg2RKHWduvWzRoTExM8XPbxxx8PJmjy8vIAIHjQq8/nQ9++fXHbbbfh2LFj8Hq9Xcj5NQF3MTWTUqnEqVOnBi5btuwBkdC1XXPNNa9ERETUJyYmYsiQIdi9e3fQHWFZVu/xeGZu2rTp6RCw8eK/s7Ozd86dO/fV2tpafPjhh3jppZeCbhrFRUaWZQ0MwwRYljVLpVLHb5kAkUqlkMvl4SzLpgHQMgxTx7LsSYlEwouthE6nMyxYsGB2WVnZZeJnREZGHnnooYfuaWhoOC7wiGVZ2O12OBwOyOVymEwmFBUVobKyMvrgwYOvmEymQaHx2/79+68LDw8vHDly5GzhOcIGVp/Ph8bGRtxwww246qqr4PF4oFKpAABWq7XLal0MwMXHx180sFVUVMTv3Lnz+kAgECbIYnx8/MdyubyI4zg+PDw8WOVO2j7MarW+tH///gcCgYBUr9cfHjRo0KIjR47cZTKZckTxX8nQoUMXuFwu+86dO+H3+4UtHYP1ev2YtWvXXm6329N5ntdyHAeJRNJcX1+/4q233nrHbre75XL5RUucUNwTvWDBgocPHjz4Z7vdHglAYjKZjq5evfqBtra2UoVCgenTpyMmJgbz5s17uaysbIIYKAkJCQX333//gx6P5yhEZzyazeZgeZTg/rEsq7JarTfn5eVN7ejULY7j2G3btk3Pysqquvvuuz8Rdg+EKgeFQgGO44JLJx2BjcrFND6fL0mhUNRLpdI2MR2pLA8qlSpVIpF4ADQC6DQ1KZVKIZPJMuVyeZpSqTRLJJL8c+1YVSgUUKvV4RzHmV0uF5RK5SW9KbVDwF3o1pWf2gwGAzZt2tR3/fr1Nwn8kkgkddOnT18UFRVl02g0sNvtwdhBoVBEWCyWeQUFBdPcbreyd+/e/6ipqfnoiiuusFdWVt4i3ls1bty43IkTJ25Zvnw54uPjdQzD3DZt2rSJJpOpd1tbW5jD4TCEzDcxPz/fs2TJko+bm5vdtbW1kMvlCAsLg1ar7SWVSq+SSCSZLMtalUrlWqVSuVvgu1KpVEml0rFyudyo1Wo36XS6FmGxvLW19b9c8rCwsMylS5fOr6ioGOF2u43BNKPfrxw4cKAtNTUVH3zwAaKjozFr1qzZeXl5twYCgeBpWGlpaXtvvPHGJ71e70GbzcbZbDa4XC5kZGSAZVkEAoHgMovBYEBdXd24lStXzhI2kgJARkbGwrCwMP748eM32u12jcfjifnyyy8ft1qtDVOnTv2uo7pLgQ8dgU04akKv11+zePHiR/1+f3pjY+MnRqPxXbfb7ae4O81kMt36+uuvDzaZTBkej6cuEAjcz/N8mfA8oYJGr9dn8Dx/c3Fx8cDS0tJMhmFUcrncr1arf+jVq9f7Mplsv7hIQaVSJfM8f9vKlSuHrVu3LnXixInzrr/++pX79u3z0HKKTCqVTtBqtVq9Xr+J5/m2SwGIHQJuz549F6WzsLAwxY8//jjUZrNFEOE8KSkpW9PT00/5/X5+06ZN6NatGwYOHIjw8PDejY2Ns6qqqm72eDzOcePGPWGz2ZZqtdrGrVu3xptMJrXw3Li4uAP19fX/XLBggYdhmPvy8vJuaW1tzWptbY0/V0bQ4/HY9uzZYxs/fjx27tyJYcOGdfvnP/95f2lp6dX19fXJXq/X6HK5vHv37u0xatSoipiYmBaWZR/My8sbZ7Va02tqahQLFy5MTk9P/7fP5zPbbLbgJk+hj/Dw8O67du1698SJE1eJ3d8+ffosHjdu3NtGo7Fh+PDh+PDDDzOefvrpR7Zv336rz+cLlrbFxMRsGT58+Kw+ffrsz8rKgtvths/ng9FoDO59E5JL0dHR2LJlS/+FCxe+1NLSEjwmISkpaZtUKn1DpVLZk5KSKsrKyp7wer0Gs9nca+nSpS/5fD7+xRdfXFdTU3PBrrFOp9O/+eabz50+ffoGi8WSRe6tVafT+Q0GQ0JbW9v08vLyaxwOR5rdbg+nhFl3vV5vMBqNwpEZCA8P737gwIGHPvnkk/F1dXU9fT6fOiSe7eZwOHJiY2PfvOyyyxYbjUaJw+H46+7du29ra2tL83g8EQCwbdu2R8eNG5eXnZ3dmpube3tlZeXEioqKXl9//bVsx44d140cOfLRQCBg+R1j984Bt3DhwovSmUajySgsLBwmch88qampufv27fNlZWWhpKQEPXv2xMaNG6esWrXqr2azeYxKpaq94oorXoiLi1t25MgRz+WXXw6e56MAKERCwJSVlU1qbm6+PyEh4cba2tqEzuRFEHqlUmnp37//suTkZN+AAQOwdu3aa/Py8h4oLi6+guf5INN9Pp/8yJEj41599dX3jEZj4NSpU1eYzeZw4frx48f7OhwOLcdx5sbGRsjlcgwfPhwsy0Kj0cR99tlnbxw/fjy4XqhWq6tGjhz5QVRU1Bd2u72ltbW198yZM6ccPHhwXF1d3XCINtpef/31qzIzM18qLS0tbGtrQ05OjrBpFBzH4ejRo/B4PFAoFCgvL0ddXV23bdu2zaiurh4kSiS1Pfroo6/L5fLi9evXw263/1Or1UY5HI77PR6P1G63D1yxYsXLERERknvvvXft+Y71k8lkjNvtzpw/f/6srVu3ThZoZTAYmlmWlX7zzTf3FBYW3lJVVTXM6XSe5SpFR0fvTkpKatm1axcqKipQXl7+p/r6+ierq6vHApAolcomjuP4QCCgFvjk8/lkzc3NOVVVVdlbtmzpt2nTpvtqampucjqd0eJnnzp1asA//vGPNwGwhYWFI+12eyzQfoxhXV2dasqUKSq1Wm0pKir6XePQDgFXXV19UdaYAoFAWk1NTU/hO5VK5R41atTxH3/8kevfvz9iYmJ65+fn33D06NG76+vr0wGUp6SkzO7evftiu92OzMxMpKamQqPR6Hbt2hXMvJlMpkyJRPIcAENtbe1Z4Ypery/u3bt3YUlJSb+WlpYM6teTlJT0eWRk5Bfx8fFxn3766S3l5eX3VldX9+5o7B6PR3v48OHJHV1LSko6npGRYW5paYHNZoNCoYBOp4Pf7x+2bNmyB3bv3n2zKKmzIRAIvN27d+9chUKRuWTJkruLi4uv3rNnzyiI9v0B8I0fP35Rnz595pjN5mqPx9PTarXKPB5PodvtDsYugmup0WhQU1MTvnTp0gdPnjw5WbwmOX78+C+GDh26XafTweVyITU11RQREfHuli1bUvfv3381CeWAjz76aJ5SqWSnTZu2SlxtIz5+TyKRwOv1Jh49evS1urq6KWctDAYC0n379v2luro6lef5sA5IZbnvvvveczgcdbt27UJ+fv7tpaWlL1it1l4qlco5cODAhTKZrGTHjh0vAFCHyI6/qKhoSGFhYd+GhobOih2U+fn5t3SQuQ6kpqYeT05ONufm5vJyuRxyuRwsy/';
    $arnel_signature .= '7qBR7C9iehVveCAXeu7Ss/t8lkMtTV1Rna2trCRcTgjEaj3GAwZG3fvn14bW3tlKNHj14DAImJiYURERFzJRLJCuGw1cTERLS1tcHtdvu9Xq9KFAtpROt59ujo6CqdTnciKSnpSGxs7IHU1FRvc3Pzyy0tLQzDMG29e/f+tm/fvh8XFhZe3tjYeM+uXbvuxH/vYD6rxcTEHIuPj88vLi6+xu12xwNgdDpdc2tr6yapVGqPjo5W1NbWxre1tXXfs2fPwBMnTlxbXl4+CgD0en1ZTk7O0lGjRn35ww8/eHfv3v2Q0Wi8qaKiYmxowkKpVDYOGzbsyzlz5rzyxRdfKJcvXz4jKytriFQqXS+VSgulUik4jkNVVVUwdpNKpWhubh7f3Nx8L8dxakHQYmNjDw4ePPhdp9PJeb1e9O/fHwMGDIDRaCwD8M/KysqspqamZABwuVx95s+f/zbDMHqGYb6RSqU+oT5SOJ6BkihhDQ0NY0PpY7fbw+x2+2Vyudyfk5Oz0+Fw+IuLi0eSIuGuuuqqT2688caNFovFX1paemNJSclrNputu1KptA4ePHjJ2LFjP9q0adMtHMd1tD+Pr6urG3MBIUt9WFhYgclkirNarQMAMCqVqm3gwIHfJSQkePbs2RMTFhbWk+O4FrVafYrjOPevCbaIiIjgsklZWdmFA+5i1LcxDAOv18t6vd6gWnE4HNqlS5fexzBMbF5e3rXC9ykpKT/ecsstL5pMpq25ubnQaDRIS0uDUqkULGNFTEzMZp1O189gMCg8Hk/A5XI5JRJJncFgOBAZGbm/R48eP1xxxRVWl8uFNWvWvNjU1NSLgF+tVqsPOZ3O8adOnXreZDIlkMWweL1eXWhWT6FQOPV6/Y4ePXq8N2XKlK1LlixZVlBQMJnjOFan01UVFxdHcRw3OiIiYlR1dXX/ioqKARaLRVg85OLj4/ePHj363+np6VtPnDhxWV1d3ROlpaWjyb2063Q6a2NjoxBruocNG/bmM888805NTU33srKyVywWy50mk6kgKSnpaFNTE9xuNziOQ21tLZRKJdRqNaKiolBcXDzKZDIFj3rX6/WmW2655V2dTlctCIRwLksgEEBGRsbWnJycz7Zu3ToXVIXi9XpT5s2b99748ePZCRMmfKNQKNxmsxkymQxutxvNzc1wuVxN/fv331pQUHBTSHbRkpmZWdynT5/1/fr1W1lSUjKwuLh4OMMwXFRU1OFbbrnlbZvN5j99+nTW9u3bZ9lstu6kYOxKpdKxe/fuaXv37n2qE2GWAfBLpVIHz/PaQCDAhvDI2qtXrx+TkpKWulyu1Q6H424CHBiGCbS1tWk3bNhwp9PpHHHgwIEhGRkZf0tISCj/NdcTjUYj8vPz8e23357ztO3zVpoIB9L80gwPwzBITU1t8ng8TSUlJd2JwboffvjhPpHFcyYlJeU9/PDDs5KTkw8sWbIEfr8f0dHReOyxx2Cz2QQL3JCXl/dobGxs5sCBAyPq6+s9FRUV9SzLlnq9Xv/+/ftht9vR3NwMlmU1+fn511qtViP1EbZ3795ZPp8vAUAgLCzsRERExAEAMeXl5aMDgYBcZG0a0tLSVoSHh88zmUz1VVVVxuTkZO/Bgwd5AGhqauoWFRX1+u7du7M4jpNFRkaWS6VSt3g+AwYM+CwpKcn6n//85/MTJ05cScJpT0lJOTZgwIDNfr+fWbFixUsUX1qzsrLW5+XlpXz11Vef1dbWjo2MjDxw9dVXP9erV69DhYWFwfrPlJSUIE9iY2NhNBr1on79mZmZu6dNm/aflpYWeDwecBwHs9kMoTKloaHBo1ar10dGRt5sMpnErrRhy5Yt74wZM8aXnZ39rVKpdDMMg5MnT2LPnj2IiIho7dmz56qjR4+OZhhGCcCVkJDQJJfLv7vjjjs+S0pKOr1169b0/Pz8KQBUWq3WNHny5HcqKysbwsPD8eGHHz5YU1OTIXTW1tYWv2nTpqdYlkVSUlKh2+2WNDU1ZUJUihYeHl6bk5PzPQDk5+ffEQgEVKKEWa1cLl/89NNPzz927FjzypUrYbFYJIKVtNvtEWvWrHlxzZo1ClrL3DF58uS9OTk5TmFz7q+03IXXXnvtvEfbdwi4lJSU4P/lcjni4uJ+lZo4g8FQuGXLll0lJSVJOPtsDF4ul1s0Gs3K119/fXZycnLdoUOHgvFDIBCA1WoNToaspdXhcOyzWCyw2WxwOp1gWTY4TqVSCYvFAr1en8QwTFCDuN3ubhKJxB0ZGVmenp6+OSIiYkFycvLBI0eOLKytrQ34fD4fy7Lu+Pj48rS0tHdVKtWXTU1NcLlc2Lx5s5Tn+TiO46TkCcTU19fHKBQKa58+fT6/44475jY2NvaeP3/+Or/frwwEAoq8vLwXv/vuuyRyd/0qlaopJSXlm+nTp8/PyMho/Pe//z0KwCxyaaNWr179qtls7sFxXK++fftuGjJkyAv9+vU7aLFYgltZhKSJADi/3y/RaDRWqVTq8vv9suTk5CM33njjexaLJSCsoymVSuTn56Ouri5YvhUZGVncr1+/r7dt2/aaMCeBVbNmzZr/17/+1T5ixIh1UqnUJ5FI0NzcjIaGBjeADdHR0UaFQpHi9/tL582b9/3mzZtr8/Ly0KtXr7TS0tJXi4qKrgfAx8bGnrzuuuu+/dvf/ibr1q1bbH19/Sgh0cIwDKfRaOwqlao6Jyfn2zvuuOPzoqKi8C+++OJzp9PZA4BPr9eX3HbbbW89+eSTK3ft2nXNrl27ppOX4zAYDKceffTRVxYtWrSipaUFgUAAgwcPhl6v9xcUFAgF2ywAVqVS2eRy+f777rvvfoPBUN3W1vazPDlxobvAh9raWowZM+aCKnA6BNwbb7wBUfoahw4dgsvl+sXZHb1eX6FQKBasXr06x+l09uF5XiKRSPwajaa8b9++b5SXly+xWq2eX2pRjUYjRo0aBZ/PB61W65XL5V6GYTiJRBLgeb68W7duSx966KGvxowZc3rGjBmIj4+XqVSqhuTk5ENer9eWkpKy+YknnvimsrKyYeHChdBqtcjIyADDMC6/37+9rKxsIM/zCgB8TExM4YgRI97U6XQrGxoa/JGRkYpBgwat/PHHH//M87y0tbU1SSKRBAD4U1NTcydOnDjP6/Xuqa+vR69evZCZmWkyGAyHrVZrP57nJQ0NDTcaDIa6m2666WmXy/VZa2urU3hvQWfN5XJxQ4YMeS8/P58rKSnJHDdu3MKHH344r6mpCaLsKAwGA1paWoIBPcdxLq1Wu75bt25Tq6qqBoU8Nvqzzz57qbq6uvGuu+7ae/fdd/Opqal4/fXXoVAo2jiO+0jY9WE2mxEXF8dotdqk3NzcVwsKCm4hS+5WKpUNmzdv7iuTyeLef//96xoaGlIB8CzL+iMiIk7ecccdn4aFhX29cuVKYVmlevbs2Y8WFBRcCeDI1VdfnctxnCM/Px/Hjx/XSqVSu1wuN40dO3bJ1KlTP6ysrKwRr3t6vV6o1epynU5X5XA4uhGoaydMmLAwMzPzXY7jLD/XlRQK7wWlLpFI4HQ6MWLEiAvGxnmPWCgqKkJWVhZOnjz5iwt/XS4X+vbtu/f555+/Y/PmzQ/W1dUNzMrK+s+4ceO+3bx5c6Pf7/f90udnZmZi3rx5QW2j1+tPr127donNZhubk5Oz0WQyLa6rq2v2+/1+kdX2AZjF8zxL598HfD5fQEhKCDEQz/MOiUTy5siRI3f06dMn22q11k6YMCG/rq7OtGvXrkDv3r1xzz33VPXv3//l559/3l1WVjZKIpF4ExMTf1QoFCv8fv8PbrfbKrLSiI6OPvnwww/f/80337zc1NTUa+zYsSsffPDBT6qrq09v3brVf6GnV3EcV8rz/Ay0vybKH1r57/P50Lt3b8TGxp51IpZCoShNS0v75O233w4FHJxOZ47T6bxTJpOVWK1WU3Z2Nl566SXMnj0bPM9j7NixuPXWW0Guf4/9+/e/XVxcPFGUC1AdO3ZsYlFR0XVULcKSJa0fP378P9Rq9UKr1WrS6XSBkBzCj4FA4AAATqPRBD7//HNs3LgROTk52z766KPRZrO5af369Y0+n88fkpFEIBBAYmLiYbVa/QmA1N69e28zm817zGZzrd/v9/+czKSwOB8TE4OPPvoIc+fO/dmlkNILYCTKysrQs2dPHDt2DH6//2fHdFRJzvn9/uK+ffu+uHDhQuUjjzxiUygUv9o7nRiGgVKpDFZ7eDwe/pFHHnlv9OjRHxcWFjo3bdrUWV8++pyveViW3SuTyQ7IZLKAUqn0Cm/SYRgGMpmMB1AWFxc3Y/ny5Vqz2czNnDnTYTabnQzD+DqgSSA8PPzIzJkz7+7WrZt61apVFpZlbSzL/tQz+HkA3gtxh8S843neYzQac3v37r35+PHjE0Kz6jt37rx92LBh+UOHDv3K4XBAp9MhKioKd955J+rr6xEREQG9Xn/VkiVLXmlubu4nKpT2paenfzlhwoQv16xZ80Btbe1dAHDttdcu6N+//78AnCooKHB0MkdOXL4m7Cj3+/0tSqXSrFAouHPRhmGYGpZl32MYRiqTydxSqfRnv3WT4zikp6fjqaeewurVq2Gz2SAszfxq63AdtbKyMgwZMgQ7d+6EVquF3W7/2aALBAKcXC63dOvWzfJL3qZyLiIJDOE4DgaDwRYZGWmTyWS/Sl88z/vpc1ZfopIojmXZtqSkpDa1Wg0xIDuiB9q33LTExcW1CFr6116c5TgOERERHR7WExkZWTlt2rQ3n3322aEA9CFrkLotW7ZMcjqdu1tbW09zHAeNRoOwsDA4HA4888wzjx07duzBxsbGTGE3hl6vd0yaNGn+4MGDP6qoqGhUKpUV6enpeSNHjvQaDIbter2+SkjkXKgSFdYVOY7jL+B3AZ7nHSLP5GfTrGfPnnj88cfx9ddfB5N2v6T9JPt69OhRXH/99WhubkZ4eDjCwsLO+vwUYRbS1L9FCwQCv/k7AXieDx66cyH9CrHBxRyjkDwRFn+Fj1KpDPTo0SP/L3/5yzsd/e7QoUPDq6urh3fv3h3Hjh2DTCaDWq2OX7du3Qe5ubkzGxoasgSwyeVya0RExJsajeaDpKSkRjobpU6j0SxMTk5eLJVKq7xe70XdAvZz+SWTyRAbGxv89OzZE0888QS+/PLLXwVsP8nCCW3Xrl249957kZiYeBZgLrvsMjz22GMA2ivY/2ivEfr/0ASLHBrHULbO0a9fv4+HDx/eY8+ePbeHxMaxPM8PHjhw4KLVq1fD6/UO+/jjj184evTo1SEy5JkyZcqHt912278cDkdLa2trUA44jvNcqPL5LZtgsaOjo3Hy5Em88MIL4vgWS5Yswa/xTvKfDTgA2LRp03999/3336OtrQ1yuRzPPfccgPb9U36/vwt8f4BGh/s0ZmVlzW1ra5MWFxffLIAjLi7O7Pf7965ZswYqlerGwsLCx2tray8PxfM111zzxVNPPfX+gAEDWsrKyrBjx45Lfs6xsbE4cOAAPvjgA5SXl2PVqlUXtc9f7SBYk8mEOXPmCOtt8Hq9uPfeexEeHg673X7B7qNw/LVGowlu31epVDAYDHA4HP8FXvHeLYZhoFAo/qc2SYq2r5x1pNzFUmIul6ssPT39Bb/fb25pablMIpHYb7rppsVKpXLjRx99dEdkZOTc2tratNDfDRs2bMXMmTPf6NmzZ31tbe3v9mLKnwK26OhoFBUV4e2338aWLVt+k34vysnLDz/8cFAoEhISMGjQICQlJZ03jmIYBgaDAeXl5cjPz0dlZSUcDgcKCwuxfv16jBkzBsJ73QRB1Ol0OHXqFEpLS+H3+4PrTReaSaLMYjCtLFRy/MTMK6RSaTA58ms1iUQCjUaDxsZGbNiwQbwDHjfddBM6i4UEuojfECSVSqFWqxEIBIIupfAuOXGBMr2S63R6evoMrVbbR6FQ1IeFhdU0Njbe43A43rbZbMbQ/gYOHLjz5Zdffik9Pb2yqakpWIL3U+cqxJfC0Q6dLUwL7+qjmPGCipBptz0kEgnUajWio6Nx4sQJzJo1C7t37/7NgH5Rjzp//PHHAQCzZ8/GDTfcgMjISOh0Okil0iCRxP/6/X5UV1dj3bp1ZxFhxYoVWLFiBTZu3IisrCwoFAqhPAkVFRXYuXMn9u/fDwAoKSnB7bffjtTU1LNAx7Js8Pg5oeBXLpeD4zgIJ1e53e5gGZRcLg+OU/iIhVt4nkqlgs1mg8lkgt1uDwqbWAgYhgkCWRAU2tkMoRhZJpMFq9iF64KVWLNmDfbt23cWbRMSEjBw4EAolUooFIqzaFpfX49du3adtW7KsizKy8vPsjxarRYxMTHBGkupVAqj0Sj838UwzH673c4uXrz4voqKir9xHPdfYEtISCh66623ZiQkJBS3tLRAo9GcUyYE5STQRDhwyO12o6SkBHV1dfB4PGhsbERYWNhZgBIW2oVwRSqVorKyMlhlFAo8gc8Mw8BkMqGyshISiQQHDx6E3W7Hk08+iQMHDvymlvU3ebfAq6++ildffRUPPPAAnnrqKZjN5qCmFQ4T9fl8sNlsmDlzZqfPufrqq7F161ZERkaC4zisWLEC33777Vn31NTU4PLLL8eBAwcgHG0ulUphsViEo78RCATQ0tKC+vp6mM1m7N27F8OHD0dNTQ18Ph8iIyPR2NgIk8kEt9sdfPWteMuFUFLW2tqKbdu2Yffu3dDpdLj//vvBsmxQCFiWhdfrhdvtDp6sJQhefX09TCZT8KxHhUIBq9UapMeJEydQXl7eIS2mTZuGRYsWITExMXiWiaAQ1q5di7Vr156XLwMHDsSzzz6LlpYWUDofgwcPDp7aZTAYmA0bNkw+dOjQC36/PzLUKzMYDBWzZs26T6vVFtDrws7pSbAsGzxkOBAIBN+PLrzPYf78+Wf9ZuzYsWhubg6W9Hk8HjQ3N6OyshIFBQVoaGjAxx9/HFQyXq83qFQFBW6xWGAymbBz507s3LkTAPD555//bq4s05EL9Fv43kOGDMG6desQFRWFd999F3Pnzv3Vj7ArLCyETqeD2+3G7bff/ou0mVarxYgRI+Dz+cCyLLZv396hyzNhwgTMmDEjuHxiMpkwdOhQNDY2XnBfS5YswccffxwUkIvVhg8fjocffhg2m63DIxT0en3MP//5zy/37t0bugeN12g01fPmzZum0+l29ezZk1OpVJDL5VCr1UEFsG/fPhw7dgzr16+HWq3G1KlT8cknn6C+vv6izSctLQ1+vx9OpxNFRUUoLS29JOLw3x1w9Nol4Ui3i7JOJhwoI6z5/dK1H/GCcWepYsGiCqdd8Tz/k87pF+IS4RSti82DtLQ0TJky5b+q3BUKBX744YdnDhw48ILP5zOGXKsYO3bsfRMmTNip0+n8WVlZ6AhwBw4cwOHDh/Hhhx/+Ju9IF1x/cdHDpfIylt/UpewsSyRsj7hYp/P+khKcjtqFrMcI+80o4/ez+vmtCgKErVcdJR2kUmlEY2PjeJ/PZxB/HxUVdfjZZ599aMuWLQWg07eEtSzhI5yA1tbWhq+++uqsN7Fe7Plcagvqv0sM19Uu3ebxeFBRUQHxIjUAqFSqkc3NzdkQ7b7u27fv19OmTXtToVAc53me1+v1MBgMyMrKwnPPPYf8/PxgcigQCMBsNsNut3cR+VKI4brapdFkMhmSk5MxZsyYs2JohmEy3W73/dXV1f3VanX1yJEjt2ZlZe0AUNXW1oaNGzeiuroaLMsiIiIC+/bt6wLXpexSdrVLo/l8PpSXl8NgMGD48OFBl4zjuBNGo/FthmEiNRpN68iRI6siIyNx+PBhqFQqHD58+KIlP/6XWxfguhoCgQAKCgrOSjJQYUEtwzC1OTk5kEqlMBgMcLlc+O6777rA1uVSdrWL0fR6PbKzs9G7d29ERkYiPz8f27Zt6yLMz3QpuwDX1braJRTDsQC6of1gzuJz3KcGkED/CrlzDu27kJ0AGgB4AGgApAOIBWAHcIquBWN4AMkAUug55QCqRM/sqEkAxNFz5QBq6HfiNQEdXY8DYAFQCqAp5DkJAFJpjLUAygCcL6+fBCCNxi3066JxJNKzhDy18GoqF/Ud+uae3vRdtWi+DIB46kMZ0se5WizN9TD++2hvYWzJonFXhIwnkugVBqAZQAkAawg9U6gfH425Aud4SQc1gbdSUb9u0VxjiQd6olFpSL8GGlcUyVU1gEoRjTuT4RTqm6HfnMbZu/uNADIAhANoIbk0i64rAXQnfvvoeo2oX4aen0Q8b6I+WjtEX+hHJMgDACwBsOg8hBwAYCPa34xSBOAEgGMkuN/QhOUA/kLXLTTxT4mIAmGuAbCDJt0CYC2AEefpuy+ApTS5BgC7AdwqUiZyAI8CKKR+GwG8T0wTiJVE86wgBp+gZyjO0W8fAKuJuCYAPwC4mYQ4AcC3xJQTInrUEZ2GhwhEbwAHAbyIs9/H3ZfoZ6a5/QDgDoiOQ++gaQDMAPBdJ8J3LYBcGnMLgEMAHhDNVQ1gPikcCym8x3HmNORwAE8SGGoJkDsBjDzHuBgA2QDWA6in3/wAYDLOnDidDOBLolEDAWkG9QcC4TM0nkaSn60ABqHzQ3xlJD+7iE8NAPIBjBWNVQ/gORqXiYDyN6KjgIMbAOQRPVqI731F1wcB2EBja6Z/X6SxK87CVieAU5BArScN+a8L0PRPAngHwCsA5hCYOBJuJYAJZCWXkia7hQj3KhEsmSa9iZgzkMD3A/2+s6TPd6T1byBB/zsRRQDqWGLiW9Tvo8TMt+l6BIGjGMAoUg67STFc0Um/CgD76DfXE3g/IVCPJSF6kPp8DcBLxMQ2AFsIYML4h9KzOAAzRYyWEy2qRHN7ncA3Bp3v1u8P4Guia2hLJyDtICWZBmAhABuAqwkYD5FgPULz+pCE+y/0jKk01reIVv0BnCSB7HcOD2g/0XQC8eEbAEfpbwB4miz3dWSdXyF63UjX/0rC/AaN6wp63l4A0Z30m0PXT9B8e5Cyyadxg+ShDsBces5jZHWvFynj4yRnGTTegwC+p+sqmkcBgCtJnt4lmn0C4LoLAVwuabCjJHxfni/5QsIjo4+CmL6ZJgkAXwDYBqAX3R8G4HliloyI828Aw0TCdA8RqzPBv4E09FMEWoaEaA1pIYae+R1pJIYE+QMAB4hYA8mqXSPSlMMIkBM7cWGH029uFfXbk4ToUxGYBHqwBLqDACbRM6QAHiblsJks9AsiwN1CAvW0qI9UACtJEXZmfa8lBTKsg2t3EYivpTEwZJkOklVjARwBsIAALri0awB8TM+YAWA7zYuh5zxMfLy5E6U4ikB9Jf0tzGUrCSVLAP4xxH2sRPuZnQAwD8Aq8gAEPl5JfBjUCS36kdzdIJrvDaSgx9E9i0hWhPlEEg/Xk6J/kWgyia6zAO4lZdud5lEsspqCa7yUQDdfjK3OYrjNZFpLqUPN+eJCkf8uJYaOJwacooGkkeasoPttFBukkjUtBvAsxRIcabmh5JZ1VnUcjfaTqhpFcY+DhHg4Tb4HabR6nDnZ6jiAwaSxMikeOEouTiZZoRc7iR0Z8vkdRB/hnmqaXz9irj9E095P4N9E89MSjR+i8ewQAUvwGkBukNCHnbT8eKJpR6dR9aAY62AH11bS3NpE8UeAXJ9W6juatHUr0aueLEAvsiwLyP32iXgfSXP2dqKgjHStRkSXRrIkQkx3jORlOHkKN9P8jtP9bxPI7KJxx9I9bZ3Ix3HyvJw0XxkBrZzGkk7xbKFoPk5SHpfT2NNJZgW5DRDfXKSslpDVaxY9Q07K3Ekycd6kyQK6OR6dvE/7HC2CXKPNpBk40lZy0kYuEcGsNAYDDdYt0mb302BfDAmcxa2cLGVqyJwGE3F1JAxtIcJpob7iqW8ZgI9Io+nJfXmT3OHQFiAQxBKQBGXQnZgUIGKLkxCvkLb+XjQOB3kPfhL4UDofJZqlh8RgQ2m88g7GlkCu+alOwGgXCSwAxFB8FiCeh5GQ1YUAyiGiZTEpS7Gbej/NLa+DPr0U6+kAZJHHAgJaGrnIPMW2d5JCaiIgvEuKCCFJDFDY8QaAFSTsHTUf8V5NcvQXUuTTCFRX0rjsIcajlX7DkLExhcigg2SoO/Ev9HVTL5LH8waFROcFnJBdUVGn4kyXnggvaGMzDUgIUoeS+zZDNEjBjfCFPCsgEiRGpBF/IIEZCeA20rilIuGTENN/IGA/RAysJN/cSFZOSoLpD7FWAVIESrpHT79dRQrhHmJOFblnqTRGQfiKASwnxTCM5p9CAnxMRFcJEX4Muc+FIWNwiOgW2n4gYXuIhK+K6BoRIvCh1s3QieB35B38g2LdR0hou4tAIs78ccQfWQdCv5To8RE9I5zGKPzOSp7MGlJg40lYM4lmRcSvidT/30iAhwG4ihTaipDxjCZv4SS5olayvnriE0f8bxXReh/RewKA+0jZeYhHoVlOf4iS84Z8x9F3Hbn1H1D89xbJjv1CACdGe2i7nLRiODHgKyJkgJh4GxHpoGgiLhGAJSIGykUT9Isms4E03Y2UQbqNCPy5yL/fTcmZl8k9uZKeV0CEHUiTdYjiKPG8WWK8EId8KbJWZvLrhxAQX6c+PRRnzKC45TESDC0JuYesjFPErLtJy+7pxOp01mwAZhPQxpFyOEzzGdHJs3JIeH+4gKzyWwTkpwkMgmAKiQA2RCEGQqz2VNLg1TTOQ/T9JFISEqLDOurrrxRrX0Zu6g5SUAy5q3eSgL4hkoFV1M9hUrgMKcMXyV18nqy5EJ9OIj5ZSV4W0zUPWdB19NlOzz1EvJF1sHTCiWRTFQIulr4Tu4vxAN4jmXmLYlN7RwHtT231lAbWUcelImDGkfZ5J2StyEkCpKWBu0TA8RDRLiOt9z1ppgBlturIavkp6cKQuS8iTaqkBM339Jsq0tyN9OwmWktUhLhSeuo3kYRD/CbHZvqtkYi2jebro/nqSUg+Iga6SaP2Imb7RIyZQFb4p9ZCGcmTWEgBPEfgfxMdv5iepbm00hg7a8MoOcMSCDaFgJwni86EeDVt5EqzAG4ipZNH2b1K0b0VRC9B0E+QW9adFFcW0bSeLL+TBD6FACQIuomUZ39ydUHJikcIPHOJDkIrISBp6PkV5F2MJeXZIIrrGkk55dI4jCFuaBQpF57mnU78F5qWjMtR+juNssIJFE4tOecqeCfrcCABWkOa5nxNAmCKyLqEpq1fpgHeJXJ/louYM5kE/SkCEUua8gQJSEctjCb3d5GA3ErguYf+Flw5Ib2cQYmDraRwLiOLNku0Jvgwpc+f6aRfAwnDi6J5zqD5TRclVzJIiG86z9pZMjF2jmgdLpo0/nzR3G4mhfJAB8qyN4Hz2XP0k06WpYGEN4HmP4A0tJQSK/kUGoDcuoOktUHLB9VkHQaQUA8kd1ffSb/hBM6/ir57kmL8aQTG3bQEES6K8QrISkVTv7VkvfuQchbGru2k3z8Rb98UhUejSc6EN63+nfg2QLSs8iN5bTIAfybwvkB/R5DbWETyF0l88pHHk060EAxIwoVkKUPjjAvZNqsgBtZQHBPqFy+h9O1MGmRPGtTjJLS7iMC3kzbxEAhPkQXrLNasJzDJSCv+iZ7zDd2zjHzqhynzdzlZ4tfJShwnRt9NTGkjHz+PCNlRsxKTbhdp/5tIgFaIvIcsosMpnPu9BRwBU+wmNpEmvpGUTxPN7RjRI9TCDSFX6Ng5+plKPBDS4teTdndSLPYlAfwbkQW7lWTgW7Iet5LHUEjKTEv8MhFN93XiHpcBeIJobycXMo+WbKyitUMXAXogCfR/6Nm3kFI4SsIvZEYDNNbCDvotJAVyK83RSs85TFbPSVbuSkrQrKAsaRS5pD4qvriJfielfscTjVppOelGsrCX0xKWnjBzgpTVZ0E3JPRNIADw8ssvh8Y6p2mQ5wOckbTnjg6um2gAacR4JU1yGc6UPG0hhtxAYNwuimM6az8S2KaS5ttJDLCJQHmc0vVTSLjfFpl9P41XR8sZI8jqziPNhnMsnUTQby4j13IezpSMsaStnXTvuTaLsSTM+UTrgChxIngOOWQFZoSmmkVWUqi+cJ8jqdJM7q+CaOGjsRURWKvJkowggJeT5c0nV1xI4LjoGR56joXi1PpOFMoWEuRrCEzLKUFiouvHiFYCDyTU71ryKKKJl3ayTC5KXLiJXy0d9Gsh3hoovhtICZ6nKeECUoanqc+r6LlzaC6CfBwkYzKVQL+YrKaEaGont1ohcqXdpDBr586dG1SCXcXLXe1SbB1lDv+w7Y+8AVVCbpP3d2AIS5ZURW6UmzSbD+cv2r3UGityx4SMMXORacqIeHe+EIX7n1Ul50maXGpCMoBihOH4iW/++YVNSX78enIZveSy5qG9Fi/sD8b2yZRJHkV/d8f5i8R/Kdh6ULw26P+buRZjS/IHGrdQmbKXkhS/lWbIpDhiGVm4tymT+jaB728UN436A9GyOyVZwijOfBZnipMvVnNQLGTB/+P2a7iUGrSv7Wgog1TegXYbSsmQg6JEhFDh4aFgOo0C3zZKvIj3SekpaG5EexFtVQjgskmDlnSQrYok4XLjzOJ0KKCy6Nl7Qq5lU2KnG2X1DqE9/e6luXQja/sCJUxmhGTptJS5YigBElqi1ofGXYEzC8egZIyXXNZstKfIj3SQxBlEYygXJbWEUjklzl5bjCWl1YwzVSN+SkAMICBEoz2NLrjIAwmcdWjP/HpwZtFXSfcNowxkGfEkiZJITURPYR9gK9oLhYUxxRCvhWJwHmcqjMQtFe1p9nqc2VVxrpaD9uWYEx3IQhyNTfBOAiIZVhANYmnexyiZArL+Ourf/Hu6lAPQvkZXQZMTqtuFlkjXS+hzgoQSNIFH0J623UrXPqeM0w0hRJqL9rRxFmW7BosEej4RRnj+P3BmO8/NRLjjaF+u+J4ILgDxGfptAQntagKg4MK+S8C6jITsEwJ7Fdqr//+N9nXFa2gOH4t+eyWB4DgJ436c2YoSTc+uo/GVob2qXSiJugPt60BL0Z51raJxCNX4KppnEfVRg/YK9xQSnGfQviYnbu+ivaZTQ27wJrQvf8yiONRJGT01gWwF0fMogWQxziyIT0R7VnYlKarn6Pv76DelxI+1OFPnmkZeQh/6eyY9cyFlDkvRvuYrbBQFWd7jlFGsIPlIPIfif4fuLaN/Xxc96y/0nTCfjSJZyCE5WkDyJ9D1VqJzPimq5TizD+43dynV5FpFE/HmkAZ4iIgmRXvqVEj/P09gmUqC4ybtPpl+9xba11zi0J6OFhZAk9Ge0q2gPq/Emf1PfyVhX4f2fWfbKda6kTTt80TA2SRYarQvuCaQANxLRJxD/QvrKCAXsS8JRAHaF0gnEdM/IfDcTxbme+o7Ge1LI8K+PBcx8nWy0tMJ0NPQnupfSC7pQnreDJxZTphOVmABzc1FAhhNHsP1AP5Jc/sP0WUsWYgMkVISa/4+lLgI4EzFTyEpnVM0Di+NKQPtZXtzab4ZpFx4GtefyFLMIxrfh/YSvC1E93eoj3ki5Xi1iK9DSKAtJCeLyYu4l67fTgo5n56xDO21tU90Io8zSJY2kWL5gZ5xH1msN9BeuifsUUwjxdSNfn8V/X45jQfEQyPaF7q/Iks37fdyKTm0r6rryTocQPt6059IY2aSUL1CyQYHuYqXEeOWE8MbiQhCoemVaK8GGEBW4zLS/B+RuQe5Znoi6BEinIc05D5yTe8k8P6HtKeDxnQ7uUG1NH4b2tfy1tF9gsswku5ZSRb3LhKkjwTFRa6QsO5WQy5gGglkFjFIcBUr6ft0Am4BWQaIrNYDaK/H89J8luNMPaCMBCCZvINEtK9h5ZO23kRaWEu/tXcQQ4mLGNQk7HkEOifO1KpupxhVqC2tIp4I1slPz/kU7WuDIKWiImAU0/PDSJllEq8tIndVQZZoAVn5cFIYgnt5P1mkl6l/lqxOR5uRtcTXraT8XWivxbyOaDmVvnsKZ8rBGLp3NOUFXCQHH9L1eFLSS4i235Oi6/V7Ac5NLtST5PocpAGvJFdpGDF+BGlHIWYQzqvQkaYtC4lt1pC2z6EYYCDdU0cuE+i5wlkrB0V+v4VcM5biKg7tO6+lRNBkGncYuU/L0F6BMoHciJUEYIhioxa0VxaYRGADuTrVIsBJcOY8kyyyGOK4LJf+nULuz8qQ5Y61BMAYEqrTITGbUKOpJfd0J1miWqL7WhJIPTreUsV38LcQj4XuBFhA1uY1Gk8kuZmnRMIqnCkigEdFinE60Zsj62AiJXSS+mREzziJM0UNavp/HM5s4vwYZ3aiBNB5jaJwlsg2nKnTbSYFEkbKdxXOrr3MJdntQfRsIeAJuLAQj0+Jvmv7pUsWv8SlZMnMComCdPr/EpEm9JCgWEnj2khTfEVMYgmEYuDvJmHLIPcuBmfKpUIr/gP4702iChIOlvp34UwxdCFp5UPEyCfJLZORdl1GLotGlBRQkxCcCulnJIG0DGfqJt10n6GDcckILGE0rkAHySWBJxICFxNCb2HHcT0J9mr6+8809jtozL5OeM1cgBwoCWjvk3JIJv6ZQn7vF4FYLgKhBWf23ZVROCFsQmZCPCSug3GIQekLuUfZyRKMvAOlIux6SBU9i+nASxPu5XD2eqqMeCQT3SP5pdnxX2LhtKQFK9BeZyZo72WkUZbTJD8jv15o6Tiz2VSOjg+AySN//xFyg7aGEEtG/frQXpMplBjFkLVSUHDMk9sguKthZLlqiBH9KD6YR/PZRBZvLc4ufzKTdY0SxZ630Vybyf8fRNa5iQARRW6fYAXGkCIQdp33x5mFYAXOHPXQRPdIQ+YsZnYGaXUhAZVAbuAtpLmFnRnCtho9uUi2c2hoXmQtZpFr+wLObEReECLsEhFQHSSsB0iJBUSJMSFjmN2BwEpCLJ5EJPwmikPXEa/l5BqGU0wlbLlyE40d5O4JspBAsqAnSzWaLLWwWbUfzuwSERSZtAN8dDS+383CPU3WSigIdpHrV0tWpI588HFEgPtJMGaSJuzs+LuVxJirCTglIWNVk3uwhfzqKQSkG0g7R5P7l0199SDh/5pAkUOaexGNL54EtJWEw0KgSaDvt5DgzCXL8qkoo3gdxamF1KeEBI+jZ3ensc2kOLCIXGWheDiBEjRPktvThDM1rB3FzQEC93c4U9ArJ5rXkqKoJ5dsIvV9Ky1n8CGaXrCkLqJZLD3LTAIcReN7lmJzFzquSOFE8fsc6vMytBdDf0+K0HcBMicINUvW+0qKd7tRcuxZnDnzZiDxXUpz3k3JOEEWJtNYYgm0fUn+upM8PEku7HZSDNIOxvLrr/X+wmWBsRQ/COdV1JDfLBRxClsd2kgIHORyRtMkXyJwdbRz9n0iyCQRwIUzTsaK1qu+IoA0U1LmIxFj/0r91tMY6ojowm/niTRkA4FtJF2/gXx7Ye/YGzTPBmLW1zS+BrLE0cTMCGLeTXSthgTiNCkQkLVcJKJbIwX5CaLs62YSOIiWOIpJ4BiKm000divFL8LBQVkUowpne35P1vstovtdBNg/0f1P0lh+JJDNJeAL415KiuobctOuJVolhijgt4gXwtGBJ3FmW1QvUkRCpclXBEi9KEnxL7TvShBcxA9w5lg9O8mOkT4f0tjCRd7LYpw5gcBEvxfCjOdpPrVk6Q+JMtLD6NmPiSzbdAJqhmgZaZEosfSzMPZLi5clNOFsEjRhLcwruq4h8x1DBCoik88Q8+VEnNCB6MmStYqSIgqauEn0DCX13030fK+IcPGk3QJkLRvI/WHoecmk/a3EhFbS2MI63O3kun1JboxgFQQXxEfM/pD6upuynVIS3gH0vEMkOOJd1T3Jta2kTJ1QZ6ijedlEBQAqnDk6QnBDe1NCop7cJgv1JaE4cgDRN19kiaxEVzUJsYv66y9KPHAEkB40tkKajxpnjq4QDokNjXtScOZQ28N0vxALRRAgvPR/XpSIYHHmiIQWuianMWQS347QcyWixf1GEU3lJGuJFD+KZUFOXlh/4nGhiNdyooFQsieETCq6x0/jMtK1lp8KuF/Lwol9XcU53IXzXf+ljSWidfZ8Oc59SKmik+tx5D7yFFc+SVanLzF2MoGyhQR+Ygeuybn6loiSRz83JFCcIxaX4twbX0Pvlf8KY2POM+efM0f5TxgHex5Zk+M3Ltq/kHMpu9qZFkuLsTtIG7eSlm4hbVhBa1b90PFJWl3t/3n7oxYv/16tAe2L1MJZhOJaQhD4Doe40l2tq3Vs/rssWlfrar9d67JwXa2rdQGuq3W1LsB1ta7W1boA19W6WhfgulpX62pdgOtqXe33bf83ADmyeBS4RzLUAAAAAElFTkSuQmCC';
    $arnel_signature_spi = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAANwAAABjCAYAAADwxm4hAAAACXBIWXMAAA9hAAAPYQGoP6dpAAAKT2lDQ1BQaG90b3Nob3AgSUNDIHByb2ZpbGUAAHjanVNnVFPpFj333vRCS4iAlEtvUhUIIFJCi4AUkSYqIQkQSoghodkVUcERRUUEG8igiAOOjoCMFVEsDIoK2AfkIaKOg6OIisr74Xuja9a89+bN/rXXPues852zzwfACAyWSDNRNYAMqUIeEeCDx8TG4eQuQIEKJHAAEAizZCFz/SMBAPh+PDwrIsAHvgABeNMLCADATZvAMByH/w/qQplcAYCEAcB0kThLCIAUAEB6jkKmAEBGAYCdmCZTAKAEAGDLY2LjAFAtAGAnf+bTAICd+Jl7AQBblCEVAaCRACATZYhEAGg7AKzPVopFAFgwABRmS8Q5ANgtADBJV2ZIALC3AMDOEAuyAAgMADBRiIUpAAR7AGDIIyN4AISZABRG8lc88SuuEOcqAAB4mbI8uSQ5RYFbCC1xB1dXLh4ozkkXKxQ2YQJhmkAuwnmZGTKBNA/g88wAAKCRFRHgg/P9eM4Ors7ONo62Dl8t6r8G/yJiYuP+5c+rcEAAAOF0ftH+LC+zGoA7BoBt/qIl7gRoXgugdfeLZrIPQLUAoOnaV/Nw+H48PEWhkLnZ2eXk5NhKxEJbYcpXff5nwl/AV/1s+X48/Pf14L7iJIEyXYFHBPjgwsz0TKUcz5IJhGLc5o9H/LcL//wd0yLESWK5WCoU41EScY5EmozzMqUiiUKSKcUl0v9k4t8s+wM+3zUAsGo+AXuRLahdYwP2SycQWHTA4vcAAPK7b8HUKAgDgGiD4c93/+8//UegJQCAZkmScQAAXkQkLlTKsz/HCAAARKCBKrBBG/TBGCzABhzBBdzBC/xgNoRCJMTCQhBCCmSAHHJgKayCQiiGzbAdKmAv1EAdNMBRaIaTcA4uwlW4Dj1wD/phCJ7BKLyBCQRByAgTYSHaiAFiilgjjggXmYX4IcFIBBKLJCDJiBRRIkuRNUgxUopUIFVIHfI9cgI5h1xGupE7yAAygvyGvEcxlIGyUT3UDLVDuag3GoRGogvQZHQxmo8WoJvQcrQaPYw2oefQq2gP2o8+Q8cwwOgYBzPEbDAuxsNCsTgsCZNjy7EirAyrxhqwVqwDu4n1Y8+xdwQSgUXACTYEd0IgYR5BSFhMWE7YSKggHCQ0EdoJNwkDhFHCJyKTqEu0JroR+cQYYjIxh1hILCPWEo8TLxB7iEPENyQSiUMyJ7mQAkmxpFTSEtJG0m5SI+ksqZs0SBojk8naZGuyBzmULCAryIXkneTD5DPkG+Qh8lsKnWJAcaT4U+IoUspqShnlEOU05QZlmDJBVaOaUt2ooVQRNY9aQq2htlKvUYeoEzR1mjnNgxZJS6WtopXTGmgXaPdpr+h0uhHdlR5Ol9BX0svpR+iX6AP0dwwNhhWDx4hnKBmbGAcYZxl3GK+YTKYZ04sZx1QwNzHrmOeZD5lvVVgqtip8FZHKCpVKlSaVGyovVKmqpqreqgtV81XLVI+pXlN9rkZVM1PjqQnUlqtVqp1Q61MbU2epO6iHqmeob1Q/pH5Z/YkGWcNMw09DpFGgsV/jvMYgC2MZs3gsIWsNq4Z1gTXEJrHN2Xx2KruY/R27iz2qqaE5QzNKM1ezUvOUZj8H45hx+Jx0TgnnKKeX836K3hTvKeIpG6Y0TLkxZVxrqpaXllirSKtRq0frvTau7aedpr1Fu1n7gQ5Bx0onXCdHZ4/OBZ3nU9lT3acKpxZNPTr1ri6qa6UbobtEd79up+6Ynr5egJ5Mb6feeb3n+hx9L/1U/W36p/VHDFgGswwkBtsMzhg8xTVxbzwdL8fb8VFDXcNAQ6VhlWGX4YSRudE8o9VGjUYPjGnGXOMk423GbcajJgYmISZLTepN7ppSTbmmKaY7TDtMx83MzaLN1pk1mz0x1zLnm+eb15vft2BaeFostqi2uGVJsuRaplnutrxuhVo5WaVYVVpds0atna0l1rutu6cRp7lOk06rntZnw7Dxtsm2qbcZsOXYBtuutm22fWFnYhdnt8Wuw+6TvZN9un2N/T0HDYfZDqsdWh1+c7RyFDpWOt6azpzuP33F9JbpL2dYzxDP2DPjthPLKcRpnVOb00dnF2e5c4PziIuJS4LLLpc+Lpsbxt3IveRKdPVxXeF60vWdm7Obwu2o26/uNu5p7ofcn8w0nymeWTNz0MPIQ+BR5dE/C5+VMGvfrH5PQ0+BZ7XnIy9jL5FXrdewt6V3qvdh7xc+9j5yn+M+4zw33jLeWV/MN8C3yLfLT8Nvnl+F30N/I/9k/3r/0QCngCUBZwOJgUGBWwL7+Hp8Ib+OPzrbZfay2e1BjKC5QRVBj4KtguXBrSFoyOyQrSH355jOkc5pDoVQfujW0Adh5mGLw34MJ4WHhVeGP45wiFga0TGXNXfR3ENz30T6RJZE3ptnMU85ry1KNSo+qi5qPNo3ujS6P8YuZlnM1VidWElsSxw5LiquNm5svt/87fOH4p3iC+N7F5gvyF1weaHOwvSFpxapLhIsOpZATIhOOJTwQRAqqBaMJfITdyWOCnnCHcJnIi/RNtGI2ENcKh5O8kgqTXqS7JG8NXkkxTOlLOW5hCepkLxMDUzdmzqeFpp2IG0yPTq9MYOSkZBxQqohTZO2Z+pn5mZ2y6xlhbL+xW6Lty8elQfJa7OQrAVZLQq2QqboVFoo1yoHsmdlV2a/zYnKOZarnivN7cyzytuQN5zvn//tEsIS4ZK2pYZLVy0dWOa9rGo5sjxxedsK4xUFK4ZWBqw8uIq2Km3VT6vtV5eufr0mek1rgV7ByoLBtQFr6wtVCuWFfevc1+1dT1gvWd+1YfqGnRs+FYmKrhTbF5cVf9go3HjlG4dvyr+Z3JS0qavEuWTPZtJm6ebeLZ5bDpaql+aXDm4N2dq0Dd9WtO319kXbL5fNKNu7g7ZDuaO/PLi8ZafJzs07P1SkVPRU+lQ27tLdtWHX+G7R7ht7vPY07NXbW7z3/T7JvttVAVVN1WbVZftJ+7P3P66Jqun4lvttXa1ObXHtxwPSA/0HIw6217nU1R3SPVRSj9Yr60cOxx++/p3vdy0NNg1VjZzG4iNwRHnk6fcJ3/ceDTradox7rOEH0x92HWcdL2pCmvKaRptTmvtbYlu6T8w+0dbq3nr8R9sfD5w0PFl5SvNUyWna6YLTk2fyz4ydlZ19fi753GDborZ752PO32oPb++6EHTh0kX/i+c7vDvOXPK4dPKy2+UTV7hXmq86X23qdOo8/pPTT8e7nLuarrlca7nuer21e2b36RueN87d9L158Rb/1tWeOT3dvfN6b/fF9/XfFt1+cif9zsu72Xcn7q28T7xf9EDtQdlD3YfVP1v+3Njv3H9qwHeg89HcR/cGhYPP/pH1jw9DBY+Zj8uGDYbrnjg+OTniP3L96fynQ89kzyaeF/6i/suuFxYvfvjV69fO0ZjRoZfyl5O/bXyl/erA6xmv28bCxh6+yXgzMV70VvvtwXfcdx3vo98PT+R8IH8o/2j5sfVT0Kf7kxmTk/8EA5jz/GMzLdsAAAAEZ0FNQQAAsY58+1GTAAAAIGNIUk0AAHolAACAgwAA+f8AAIDpAAB1MAAA6mAAADqYAAAXb5JfxUYAAEhISURBVHja7F13fE33+3/fPTJulgwZBCEhYsbIt4RSozZFbBXUrFptVc2i1F6RUtTWoqX21lgRI2JGImTJHjfz7nt/f+Q518l1E6qo9nef1+u+knvPOZ/xfJ79PJ/P4RgMBljAAhZ4N8C1oMACFrAwnAUsYGE4C1jAAhaGs4AFLAxnAQtYwMJwFrCAheEsYAELw1nAAhawMJwFLGBhOAtYwAIWhrOABd434L/PgzMYDMjNzQWPxwOXy4VUKoVAIIBKpYJSqYRSqcSGDRswfPhweHh4IDY2Frt378bw4cOh0WggEAhQtWpVSKVSpKenY8eOHRg6dChyc3Nx6dKlukeOHGl37NixKq1bt4754IMPDgQEBEAikeBt1pfq9Xo4ODjAwcEBJSUl0Gq1iIyMxPTp01GtWjVs27YNOp0OgYGBsLGxqRQ3BoMBGo0G2dnZuHDhAqRSKXJyclBcXAw/Pz98+OGHUCgU5Z7jcDjQ6/U4d+4cqlWrBrFYjMuXL0OlUuHp06f44IMPUFBQAA6Hg+7duyM8PBwzZ87E3r17UaNGDRw5cgRTpkzBzZs3sXfvXsybNw9xcXGIjIyEo6MjatWqhQcPHqBZs2Zo0KABLly4ALFYjLS0NDg7O4PD4SA6OhohISGoWrXqW8Hx2bNnMWDAABQUFGDIkCGYNWsWFi5cCHt7e8ybNw+PHj1C1apVwePxIBQKsW3bNjRr1gwymQx6vf61+vT19f33M9wbU+NcLmQyGYqKiiTr1q0LPXDgQI+4uLgWAKwBICIiAgkJCdsHDhwYyuFwtG+T4XQ6HTp06AAu999rXHA4HAiFQggEAlhbW0MqlUIkEkEsFhv/Z67zeDyLWvv/xHDW1tZQqVSc9evXD1y3bt0XhYWFTc3d9+zZs/5eXl6zGjVqlPw2x6NSqeDi4gKtVvveMxWXywWfX0YiYrEY1tbWEIvF4PF4ePToUZ24uLhGe/fu5aWnpxvi4+MN1tbWuoSEhNK0tLQce3v7HEdHx4KSkpJcNzc3vVQqhZWVFfR6/b9a2FgYrgIQCoWwsbHBoUOHWqxaterbCxcudGFfFwgETxo1anQ7Pj6+Tn5+fj0AOplMJrCzs3trY1Kr1QgICEBxcTHS09PfK+bi8XgQCASwsrKCWq2GVquFXq8XZmRk2EZGRrpGRUVViYqK8rh48WKtY8eONYmMjPxAp9PJzp49a9bi3bZtW4lUKs0XiUTJ9erVe+Du7h5XpUqVx97e3nfVanWCRCKxMNx/ATgcDkQiEVJSUkQLFy4ctX379h8MBoPEROsddXJyGrdixYrkb775ZkNEREQ9Pp//bNeuXWm//vrra9vxLzMlnZ2dsXDhQvB4PHA4nPcCV1KpFHq9Hnl5eU5JSUneu3bt8snNzW0QHx9fe8mSJbXi4+PtV61a5QhA/FeaVqvV1mq12hqAZ2Zm5v9Y1wpcXV1vOzg4TBk4cOAtrVb7RnHB5/Oh0+neC/z+5xmOy+VCLBbjzz//rD1t2rRV2dnZnU1u0bi6ui7p27fvnI8//lgfHh7ePyIiYhQAfc2aNb/Lzs5WmAYZ3hQIBAJ8/fXX8PT0RHJy8nuBK5FIhBs3btQLDw8PjY2N7adSqdxf4dESADqiHRGAv+qkyTIyMoIXLlw4w87Orq9arX5jc9JqtbC3t4dIJLJouLc+ET4fYrEYp06d6nfr1q11paWlVUykecbgwYNDvby8jg0cOBDFxcW++/fvXwuAV61atR9DQ0N3eHp6QqVSvZZ0NBgMLzzH/MblclGnTh00bNgQpaWl74yh+Hy+0QdjazWDwQAej4e5c+d+euDAgbUArMzgM9bV1TVJJBLpMzMz6xQXF9fgcrmGgQMH9jt8+PC9goICsY2NjSw0NNT99OnTXnl5ed4A6mRnZ3saDAYPnU5XqW2emJjYKSMjo2a3bt0SSkpK3oi2ViqV2L17Nzp06GBhuLcJNjY2yM7OlkyePHnJpUuXJgAoR/kikeiMh4fH6Pbt2z9t0KABatSogT59+kxSKpVVAFycNWvW1NDQ0L89Dr1eX45hORwOdDod9u3bB1tbW+h0undmKhYWFiI5ORkqleqFa3w+H/v37x984MCBjSY0oHd2dj4ZEBCwxtPTM0IoFJYOGzYMM2bMCPvzzz/H6vV6TlFRkceYMWOOrVu3DjweD2PGjLmenJwMsVgMpVIJoVAozM/Pd87OzvZ8/PhxQ61W26G0tDQIgLNpPCs5ObmhjY1Nwpsw4UUiERITE1FaWvpeB2X+1QzH4/EgkUiwc+fOWqtWrdqZmJjY3PSeevXqzenTp8/i9evXqw0GAxwcHPDo0SPcvn3bn8vlyr28vMYeOnSopKio6LV9Nw6HA4FAADs7O3z88cfQ6/VGLaLVanHp0iU0atTonfkVfD4faWlp2LdvHzQaTbl+GSFw6NChEaz1z5fJZAeaNGmyuVGjRpFyuRz29vZo2bIlxGIx4uLijJHdqKiovlu2bNnYv39/jBw5EoWFhSgpKQGHw0FxcTE8PDzUSqUy1draOtXFxeVqnTp1NhQUFDiLRKL2Z86c+QmAhDVOdwZXf9dcT0tLQ0RExHvru/3rGU4oFEKn0+HMmTMdz5w58yOAaibMmOzn5zd56NChv9nY2KBu3bpwdHSEQCCAg4MDeDyels/n3/3yyy/vi8ViFBcXv3bOSK1WQ6FQwMnJCUVFReDxeEaGY5jxXRKCRqNBrVq1ULduXWRmZpabF5fLhVarxcaNG6cWFhbWa9++vVwoFD4oLi5+UrduXeh0Omg0GrRq1QoNGzbEnj17GmVlZfkzzyuVSkeVSsVt1KiR/ujRo4iKikKtWrWgVCpRp04dWFtbQ6PR4Pbt2+Dz+ejRowcaNmyYtXbtWo2ZQNJTpqjh72hzrVaLEydOQKlUvvcph38lw4lEImRkZGDOnDnjzpw5sxSA1OSWq507dx4jEonuAEDNmjWxe/duJCYmwsHBAbt27Wqdk5PjDUAqk8lcvby8MjQazd9y1q9duwZra2sjEbD//hOg1Wpha2uLgoICFBYWGpmOYTiDwRANILpOnTrQarV4+PAhCgoK4OXlhTZt2kAikSA2NhYbN278QqfTGbWSo6Njpk6n0xcUFCAzMxN79uzBokWLcO3aNXh5ecHV1RWXLl1Ceno6XF1dUVpa6rBw4cIJBw8enMWmN4FA8MTb2/tqdnY2lErlazMbj8dDXl4eHj58CE9Pz3fmI/+/YrgHDx5Ihw4d+t3NmzenmGHGH1u3bj3D3t4+Py8vDy4uLmjXrh24XC5u376NUaNGTdqxY8f3TKrg5MmT7RctWrTzdaOTXC4Xp06dei8T2RwOB87OZa5TUVGRWemvVqtRUlICmUwGPz8/uLu7o0ePHlAqlZg0aVKnJ0+e9GPdnuno6Ljo8uXLyMnJwdGjR2Frawsul2vU4hKJBAqFAhkZGb5Pnz7t/tNPP32q0WhM6570n3766Zft2rXLKSwsfGXBxOPxoNPpIBKJmDwh0tLSkJeXB6FQ+O8I7v2bGE0gECAjI0M2bNiwDTdv3hxgclnZpk2bWVKpdBmTvO3QoQM6d+4MLpeL9PR0ybfffrs4Jibmc/ZDJSUlTdzd3Xe+7ph0Op3Rh3nfgPGNGKYrKCiAQCCAXq83agI+nw8fHx+0bdsWDg4OuHv3LgBgw4YNdTdu3LgZlH/jcDia/v37Txk2bNhFb29vREdHg8vlQigUgs/no7Cw0CYlJaX6pUuX/NetW9crJSWlo8FgsDUzrIKgoKBZw4cPP+Dj4/NKgoqJtObl5cHa2hrXrl3Dw4cPkZWVhfr16/+rysf+NQxna2uLU6dOVf3mm2+23rx50zTumzp48OCRDRs2PBkdHQ2DwYCQkBB069YNubm5iIuLs+/fv//PMTEx3c00fT89PR0qleqVnHculwu9Xg+tVguhUGgsIn5fnXVmbFWqVIFUKkVRURHEYjHatGmDNm3awNbWFvXr14dUKoVSqQSHw8HmzZuDp0yZsgNAVZYpef/JkyfnwsLCqo4cOdIuNjbW/tmzZ05xcXE+PXv2bPLkyZMmeXl5NVBxXq7E1dX19EcffTSnQ4cOdxiNVFnkltGc2dnZuH//PjZv3oz169cjIiIC+fn5yMzMRL169d77QMm/juFkMhlOnTpVpXfv3gdLS0sD2dccHBweDBgwoMfAgQMfnzhxAjqdDmPGjEFwcDAAIDo62jEkJGR/bm5uGzMLml6vXr2jFy9efCF8XpFJU1JSgipVqqBatWrIzMyEi4vLeyNhmdwbU+/I4XCMxGgwGFCrVi08efIEdnZ2WLx4MaRSKf7880+j8CgoKOAtWrTo83v37v1gShu5ubl1c3Jy7gDgHT582AplSe+XxpOEQmGin5/fkTZt2vzE4/Eeuri4QKlUvjQizOxqOHXqFA4fPgxfX1+jWSwSiSAQCP41ZuS/iuFsbW1x9OhR98GDB+83ZTYAR77++uvQ8ePHZ0VFRaGoqAirVq2Ci4sLACA9Pd1u3Lhxv5pjNgBo0aLF9j59+qRTEOGlUdGioiJcv34dbm5uaNSoEa5du4b34ah4DocDsVgMtVqNtLS0Gjdu3AgaMmTIeaFQ+IwhbJ1OZ0xX6PV647YdkUgEDoeD8PDwD3/55Ze5ycnJrSrQlEIAVSoZhp7P5+fKZLJkADeVSuXVFi1aXHd2dn7aoEGDUnd3d1y/fh0vqyxhorparRZhYWE4evQoateuDaFQ+J/YefBeMxyHw8Eff/zhPHTo0JMKhaIe+1q9evW2+/n5jdZoNKqSkhLY2NhgyJAhRmZLSUmx6tq16474+PgPK2g+87PPPltfpUoVvCxCyeFwcOnSJVy8eLFcAvtt1Fz+VRAKhRAKhbh161aTbdu2fZeTk/OBWq22iYmJmW9lZTWHqSsUCAQ4efKk0R9itizduXOn+ty5cxfeu3ev31+gh1KRSJQkk8keVa1a9YaVldV9Pz+/pJiYmGdt2rTJ5XA4urCwMDg6OjK7NV7JgmA0cnx8PGQyGVJTU8Hn8/9TuwsqRPCbrHF7XULKysqynThx4gFTZmvYsOHKkSNHzrh3756qpKQEIpEIPj4+sLW1ZZiN16NHj0137tzpWlH7QUFBC+rUqZPy7NmzSk00nU4HiUSCx48fg8fjvVdSlsvl4tKlS1i0aNH048ePzwQgY65pNJoiJycnaLVaaDQatG/fHs7OzsjPz4dEIgGXy8WSJUsmrFmzZoZWq61sJ6jW2dn5tkgkilSr1XebNGnypHbt2skFBQXPMjMzS3r06IHIyEgEBQXh3r174HK5RnOQ0aovM9MZZuPxeIiMjMSFCxcwYsSId56//EcZ7p+cKEUjuX379g3PyMj4wCRitWratGlTvb29DRcvXoRMJjMyGgBkZ2fj888/XxwdHT2govYdHBwOrFixYlOdOnXK7Yg2rcjQaDTIyMhATk6OkZDeJ+2fnp4umDRp0tJbt25NMrms+eabb04GBQVBoVCAz+ejSZMmxiDEgwcPHKdNm7b86tWrwyrp4nHfvn1/LioqOj9kyJDrDx480Gzfvh01a9ZEkyZNcO3aNWi1WiiVSmg0GiiVSmMA6VUCOTweDyqVCjk5OTAYDODz+Xj48CHu37//3uymeKcMd//+/X9MavN4PIwbN27xpUuXyjFN3bp157u6us4xGAwoKiqCv78/PvzwQ+OmRq1WixEjRsw9cuTItEq6uL9x48YJTZo0USmVStjY2IDP50MgEKCoqMi4tYPL5eLBgwfIzs6Gh4fHP8JQlUFRURFGjx698tatW+PN+KbLhw4delcikRjnwsDTp09d+vXrd0Aul/+vora9vb0PNW/efPyXX3757JdffgE7oqjRaKBSqV7LnGaqQiQSCXJzc9GjRw9MmjTJaDbGxMSAGfN/FSpkuGrVqv1j2m3atGnDIiIippuYmGs6duw459mzZ1AoFNDpdJg4cSJkMhl0Oh3UajU+//zzYUeOHJldSfPFo0ePHtW2bdsMoGwXM5/PR0ZGBi5cuAB/f39j+ZdarS5XofEuwWAwVGrS63Q6DB06dPqRI0fGm8Hf3TVr1iyUSqXQarUoLCzEkydPwOfzodfrOV9//fXsypjNy8vr0L59+/pdvnxZnZ+fD7VajVetd2Q0l0ajQWlpKQwGA5RKJXQ6HbhcLlQqFezs7IyBmuvXr0MsFsNgMBhzev91qJDh7O3t/5EBXb16temWLVvWmfhbm5o1a/aFu7s7+Hw+7OzsEBwcDCsrK+MiT5gwocePP/64ASY7BVjSVd+lS5fR33777VWtVovc3FwolUrcvn0bERERSElJQZ06dd4Ls1qv1yM3N9e4ObScQ6XVYt26db0PHjy4yMyjhevXrx8WGBhYzPjBDx48wOPHj5nqDG5SUlJgJab2zYMHDw5r1KiR+vDhw39Ji+l0OhgMBuTk5KBOnToYP348JBIJvLy8yu1eaN++vZHJmL//n+C9Cv/cv39fNmTIkHCNRmPN+vlMUFDQWH9/f4NQKISPjw86d+4MKysrI1Ps3bu3RXh4+A6wKtFNwcrKaumiRYv2eHp6QiaTgcfjYdu2bThx4gQ0Gg2kUul7ZcoYDAaIRCJIJJJyn9mzZ1ebOXPmGjPCUjts2LBRo0aNimZ+UCgUKCkpgYODA2QyGWQymU4ikTyqIHiRO2/evFGNGjUqAICAgADjGSQvA5VKBXt7e7Rr1w6pqamQSqUICQmBg4MDJk6ciO7duyMrK8tYNPD/+a27/MoW/F36KxqNBqGhoXMSEhKasPy5xCVLlgxdtmyZLjMzE3w+HwsXLoROp0NpaSmkUil+//33+kOHDj0AoMIz5RwdHY/36tVrJlPZfvXqVaSnpyMnJ+e9lrLscVEtqGjz5s07AbywM7t///5frl+//lf2c1wuF82aNTP6cDweD127dj0fHh4+2FRBjRkzZsaECROimcBH7969IZfLjaZhRWYvl8tFp06d0KlTJ9jY2ODOnTtQq9UoLS01MqupH/n/GfiVmQjvbBB8Pn788cd2165dm8Be0y+//HLEoEGD0tu0aQOlUgkXFxc4OzujoKAA7u7u2LRpk+/UqVOPazSaCsPaYrE4/ttvvx3q6+urUyqViIqKQkZGBnQ6nbGu8H0DDocDhUIBrVYLnU4HoVAIlUqFMWPGLCguLv7A9P66det+N3LkyJVsrc9E/hjXgNHeqampLqbP29jYXB8/fvwm9rrr9XpYW1vDy8sLPB4ParW63DWxWAxHR0c8e/YMffr0gcFgMNZFmtv5boGXMNzf2a7yV5ktNTVVtGrVqtkABMzvtWvXXjNkyJDzCoUCMpkMzs7OqFKlCkpKSmBtbY3jx497T5069deioqLKzuFQDBw4cMzQoUNzkpOT4efnZ8wVMecnMiaOUCiEWCx+p8gXiUTGMxwZQqXghvGQUgDIycnB/Pnzu1+7du0L0zaaNm26Ys2aNXNcXFxQVFRkrJ1km8hMQnnt2rUfHTly5NsXIknFxXX37dv34ZgxY84VFBSUu9avXz+4ubkhIyMDtra2UCgUsLGxgUQiQYMGDZCbmwuNRmNhqr/LcO9K8nM4HCxcuPCzhISE1iwmfNCpU6dvjh8/Do1GA19fX9SoUQMymQwCgQDHjx+vO2rUqL3FxcX16ZFEHo8n1el05bbx16tXb9PMmTPPqdVqXL16FbVq1YJUKkVubq7VvXv3msTExAQWFBS4AuAIhcKnkZGRxzp27PjUnFRm0hV8Pt+sr8euW3wZ8Hg82Nra4vLlyy6nTp0aHBMTEwTAKisrKy0iIuILmUxWqFar4evrCz6fj8OHD/utXbt2k+l6BQYGLv/555+/8vb2NigUCigUCqPvx95jZmVlhRs3blSfPn36Zry4dxAGg8F2wYIF62vVqtWpZ8+eSdnZ2RAKhVAoFMbzKCdMmIDu3bvj4sWLePjwoTENY27OYrEYVlZWL5ynwghYxh9lcGrulC3GDGUEj0QiMR48WxGemUinlZWVMXLNbvuvrNE7ZzjGPHnbkJ+fb3XixInR7N98fHxWCQSC0qSkJNSqVQteXl7g8/mwsbHB1q1bG82YMWNHcXFxPQCFDRs2XD5gwIAty5cvP5CVleXM0h6Phg4dujAiIgJ+fn4QCARYv359h8uXL3c7e/bsh6Wlpb6mQaNx48bFR0dHt3B1dc3Ly8uDUqmEVCqFRCJBSUmJMCcnp4ZCodByOJzHDFPy+XyIRCKUlJQYI2+M6cWYdqYEV1hYiHXr1vXdtGnT9xqNpiZzrbS0FA8ePFgeGBh4X6PRgM/nY9euXdUmTZr0C0zOBGnUqNHSzZs3z/Dz89Pl5OQYCc7a2hoikaicH3fu3DnrsWPHrlWpVJ5sPqMPlywa3+nTp//s5OTUq1WrVnLmdGXGCuDxePDy8kLt2rVx+/ZtmDtXkrn/3LlzHx88eLCVq6vreQCnmHnz+Xzk5eVZR0REtCooKGhQUFCgfvr06SZXV9ciNnMy7Wi1Wuu0tLQWSUlJQVevXq2VnZ2t3rBhw04AF4RCIdRqtXENBAIBSkpKrO/cufNBXl5ebR8fn/1fffVVWn5+vtGCYYTdu6Ltv8Rw72JDJY/Hw7p167okJiYaS7ekUunT2bNn7/bz84NcLoevry+ysrIgEAjw1VdfBYeFhW0pLS2tweVyn3bv3n2Mq6vrqXv37klLSkrK+XFdu3YN69KlS9b169e569ev73ju3Lnxz54961LZeLRardV3332nDggIQJ8+fWBjY4OEhASXvXv39v7jjz+GFxUV+XE4HG10dPSWTZs2TbOzs0Nubq7w5s2bwX/++WcnnU5Xe+zYsd8PGjToikajMVan6HQ6aLVa4/FtCxcuHLJr166tMNnK4ufnt6lLly4pLVq0QHx8PH799VfvUaNG7VQoFPXZ9zVp0mT5zz///KWvry+Ki4uNzMVUfDBVH3w+H0qlEvPmzfs2Li6OXeamadq0aUjPnj3Tw8LCNqSlpTUAgLS0tDaDBw/+cdKkSZ9Onjy51JylY3pGCsPUVlZWePz4cbWIiIhvcnNzRwNA/fr168TExJzy8PBAfn6+/b179z45e/bshKKiogDW41HBwcGXYmNjYTAYIJVKcffuXdepU6f23LNnz+ji4uJGJkJxmL+//+rmzZuvbtCgQYqNjQ1SUlIkN27c+OTRo0eTSktLm1y4cAE+Pj6dR4wY0fnw4cNISUnh5OXltfztt98GXrlyxfmjjz7aM3HixEM8Hk//rsvH/lGTUq/X4/jx45+wf/P09DwTEBBQQr4FOBwOSkpKsGLFijE///zzSgBiJyenK3379h0+YMCA+M2bNyMpKcm2tLSUfThNpkgk+mPjxo1Nzp07N+fevXvdXmU8Hh4eZ+VyeTHzkomDBw/23rp162KNRuPDDgBERUVN/eWXX85zuVzuzz//PCM1NbUlc33BggV27du3b2Nvb69LS0uDk5OTsU4QAJYvX951165dm9jMJhQKk5s0aTJ91KhRv4aEhCAuLs5pyZIln5w9e/YbAGytpG/Xrt3X48ePX1q9enXjGR5somFMSUZDfffddwNMiwiaN2++ccSIEb+1adMGer2+x/z58w9qtdqGAJCdnd3vhx9+EDVp0mRocHBwoTlfnl3CxZh+YWFhbefMmbOltLS0OsvkPRYdHS3dv39/n02bNn1DVgVb4CocHBxKs7KycPjwYdja2uK3334bduzYse+0Wq1nRTR77969qWq12mPQoEEhERERjTZs2LAyMzMzmH1TfHx8x7Vr136UmJhoM2PGjLEZGRntASA9PR1Xr17tyOFwakil0lym5vNdRVErZLg9e/a83QQgl4vc3Fzru3fvNjIJ4Z+PiopCtWrVYDAYcPPmTZfJkycvf/To0SC65UJoaGifDz74IM/a2hqTJk3C06dPxRcvXhSwCML64MGDR0pLS2uighODORyO0mAwsK+VhoSEfD9jxgycPXvWtnfv3t/fuXNnXEXjX7Ro0QGY2RPm6uqaz+Px9Hq9HkeOHEGvXr2MAZmVK1e2nTZt2mb2c1Kp9MyECRM+HTZsWOq5c+ekU6ZM6b9169av5XJ5bdM41rhx4z6fOHFieGpqKpKSksCcRyKVSsHlcmF6TPuSJUsC1q5du5JtOotEovQFCxbMCQwMBIfDQdeuXZOKioo+W7FixRmdTmcDAIWFhT1CQkJ2HzlypH9QUFCJqW8lEAjYRypwv/rqq0/Onz+/le0fcrlc9aNHj3y3bdv2p06nM/s+h4CAgF+bNm16Kzk5Gbdv3xbFxMSsfPLkyVgmvefs7HwjJyentl6vf2FbkJubW+HixYs/PXXq1OoKUkKcefPm/Q4zZ25KJBJ59erV1Xw+H0+ePIFWq8XfPczobzMcs4HzbYFEIsGxY8e8i4uLy5mCvXr1Sh0+fDiuXLkiWL58eciZM2e+U6lU1Yg497u7u48SCARyjUYDHo/H7L4WsOei0+msSktL65n2aW1tnS4UCi/PmTPnx507d464fv36ACIOTZ8+fUZ379794cqVK/+3dOnSdcXFxQ1fFmQEUIqyZLvRJrGzszt15coVA+P3iEQiaDQam4kTJw49ffr09yziKGnevPnsmTNnrrC1tRVv3bp19KZNmyYXFBSYe+9RweDBg4etXr360PLly8Xnz5/v0qJFC+3UqVMPKRQKcLlcFBUVITMz08gQKSkpDosXL/4ZADsNYOjZs+f05s2b5yqVShQXF0Mmk+GLL76IiouL++7QoUM/GDssKOjSo0ePPw4ePNi/VatWOUz0s379+rCzszOay3FxcW6LFi16IRij1+uFly9fnlqJO5G0ZMmSuRKJBElJSfxjx45tValUA+ha8aRJk/rm5eUptm/fvs/c85cvX+6u1WpHvWSNrFj+KodlRT3w9vYu2rJlCzgcDqpVq4bc3FyOSqUyvG3LrkKG69at21vtmMp9qpouVGZmpt2MGTN6bNmyZWZWVlYgK/y9NTAwcMyNGzfUBoMBqampyM/Ph0AgQHJyssJgMFRkiMu9vLzOBQQEbBs+fPiVpKSkHK1WGxATE9OJxqFu27btpN69e/8xadKkNVFRUWPxCvvCnJ2df+3Vq9fc33777afs7OwgIpS8jz766Ne8vDyIRCLruLi4+hMnTux26dKlfgqFwhgcqVKlSmRISMin/v7+sXv27Blx+vTpr3NycnwqyCM+XL58+YDOnTvHLFu2rNmiRYt+LCoqatihQ4eu1tbWxqgpE5pnAjUrVqz4VC6Xl7MeataseTg8PHwXKxAEuVwOlUqF6dOnr7p8+XL7nJwc4/EVeXl5H/bs2fPwhAkTug4fPjzX29sb1tbWkEgkYCKZNjY2eXZ2dklyubxeBajKHTBgwE/29vY3wsLCNgOwBYD+/ftPb9y4cSKHw8HcuXPnM8wmEAi0Y8aMGQIgYffu3X+a027kb7u8bI3s7OyuBQcHr4+JiXFPTEz8nvm9Y8eO2xs3bowNGzbUvXXrVo/IyEiuu7v791wu1/C66Y2WLVv+PYZbu3btW2U4egdA9tdff60GYKxaXbZs2SYTqQwfH58lO3bsmHPs2DH1xYsXwefz0aVLF8jlcnA4HNSrVy/jxIkTvYRCYXsXFxcvtVqtzMvLe+Dk5HRPrVbfb926daJSqYSDgwNq166NAQMGzFGr1UyxaEZCQkLg8OHDv2Y0KQCdWCxOUSqV1c0MvaRGjRrTBw8e/ONXX32lf/bs2a0jR44EkSmrOX369GepqalNCwsLA0pKSkyf1wcEBCz94osvVkVFRXX89ttv92RnZzdkaf0sW1vbxMzMzECSyAXdunXr3qxZs8dLly7ts2HDhi0AbFu1arWuT58+J9LT0415RHd3d7i5uRk7srW1rWFiUeTPnz//K4lEAuakLAcHBzg5OTE41kyePHn+zJkz27H9y7y8vBZLly49EBgYGOLt7Z2hUChgb28PsVgMkUgEDw8PRfPmzY+dPHmynonLkB0cHLx28eLFO+vVq/e0V69e4xnh6uvru3fNmjUHHB0d8f3337eJjY39ki2LT548OS8+Pr6awWCQVUJCOolE8lihUPiYRps5HE5G3759vxk6dOjeS5cuKU6fPt2bfX3nzp2TfvvttylJSUn+AMRbt25tO2zYMD1TD/qPaLg2bdq8dXu2Zs2aD9atW5eQmprqx/qZzWzKkJCQcWPHjt1qb29v3DVsMBhQo0Y5etJWq1btZEhIyMmuXbsiJycHZ86cQWJiIhITE6FUKlGtWjUmgStNSEhowPL3vBITE0cwiXIvL69tDRo02FxcXDzk/Pnzn5sIiYtBQUGTfX19b1pbWyMxMRFZWVnVWWaUy/';
    $arnel_signature_spi .= 'Xr1+czBDFkyJDR+fn51keOHFnB3KLRaDwXLFjwx5MnT9hFxPn9+vVbOGDAgF9iYmK8586dG8G4eHK5vNGUKVMaXLx48RcAvC5duiyxt7efM3DgQB0TjQwODsaKFSvKbS1SKpXl9hR17NhxeUhISCzDbDweD7GxscjKyjL6L02bNr3s6+u7LTY2dkS56gGFInj06NG/btiwoWfjxo3zZDIZLly4gC1btsDBwQF5eXlhYrE4SKvV1uLz+UldunTZ9cknnxwsKChIbtasGUaNGtXt9OnTK4nelPPnz18sl8v1xcXF2L59+yA2g2s0Gl5cXFwAgNy+ffvOyMzMVEVERJQ7Y6VGjRqnRo0aNdvBwUE8ZsyY82wmqVOnzqnZs2dPcHNzi+fxeIiKioJMJhOxz6vMzs42ntAdFBT0eWBg4IWnT5/i77zJx8fH5+8x3LuAKlWqKPv3779q+fLlP5rRgLeqVq06PSws7JzBYIBpBYS5NAaD1OLiYpSWlkKlUkGtVkMqlaJz585wcHCAUCiU0GuU2JAeGBi4e9KkSXv5fP6NR48eYffu3T+wooiPunfvvvV///tf+P79+wscHBzg7u6OyMhIJCUlvbB/x8nJ6VK3bt1mzp49OyI5OVl8+vTpL1QqlRcA/sOHDweyfarmzZtvr1Wr1orvvvvuzp07d3Dt2jUnAHqS2oLTp0//SnnR+C5dusxdvHjx7mnTpuHKlSvGRgYNGvRCUrdjx47bz58/31Kn01WpVq3aiWXLlq1kzo1kglZqtRr5+fnGBLVUKsXHH3+8OjY2dgBMCsHT09NbDRs2bM3evXs/7dSpkyY4ONh4wE/Dhg0T+/Xr187f39/p6tWr2fPmzVMzFTTjxo1r+9NPP20BVRE1aNDggEqlilmyZAlq1qzZKC4urlyqxtbWNjY0NHRLixYt9n/44YdPHz9+jPnz5/OioqLGWltb327Tps3Rzz77bFfz5s1VV65cacW4EjweL6dbt26r161bt9LBwaHkzJkzcHR0xMqVK3Ho0KHU2bNn69makMvlprRv337e4MGDN1epUsV4YvY/FjR5F6VdXC4X06ZN23jt2jWHq1evfq7T6dzEYvHToKCg3UOGDPlh9+7dhQqF4m8hQqfToVatWnBwcIBer4dEIil0dnZ+kJGR4WJjY/PIzc3tYI0aNX5s37790969e+PRo0fo2rUrVCrVtIyMjAYSiSQ3MzMzYtCgQXIej4fi4mI4OzujR48e0Ov1SE9PH7N169bZAoGgicFgyPf39z8wbNiwnzIyMlQ6nQ7NmzdXTpgw4Zvly5evBuDIaG47O7srLVq0WDd37tzfz58/j7y8PPTo0QNt27aNad++/bTr168vASDg8XjZwcHBu6dNm7ZQLpdn8/n8ciF5g8EAmexFy2v06NEHjhw5kiCRSDy6d+8e4e3tXWr6lpoGDRrA39+/XCVGu3bt7kRGRoZduXLlhYBHQUHBoPDw8AcdO3Zc5ObmhrCwMOTn5yM1NRUeHh4qNze3Z97e3pDJZEhOTsbBgwe7btiwYRsAB5aP3mT16tVbbt++7aHVapszPp1EIkns3r37lqlTp65v1KhRXnJyMuRyOWrVqoV9+/YtKy4u3vjjjz8WdurUCQAwbdo0PHjwIL1x48a7ZTJZ/GeffbanZcuWj6pWrYrc3FzI5XIkJydDKBRCqVTeEolEcWq12t3T0/Ohi4vLpXHjxq3jcrlPCwsL32k97T+ah2NertG3b9/FgwcP/jUnJ6e1k5PT0YCAACNhvUmbWq1Ww83NTbNly5bBy5cvD27YsOFxhUIhZxLGRUVFsLW1hZWVFby9vW8FBATcEggEOHLkCEpLS42JaybRS8nq5BEjRoxs3bo1V6VS6QsLC+Ht7Y3Hjx8bq1CWLFmyy8fH52ZycnIHvV6P+Pj4i3w+P9rT0xN8Pt9oKuv1ehQUFBjGjx+/Mi4u7mZCQkLzbt26HezcuXO8XC7H+fPnzRaVm1srtVoNBweH2zVq1Ljt5ORk1PhsYOpJ2QxMr7Fa3KtXrwGmxQQAcOjQoa+3bdt2avjw4TfEYjHCwsKwbt06uLu7Izk5GcOGDYNGo+HNmzdv7KlTp5aZpE7ybWxs7t64cWMAK11TEBQUtK1Zs2bfz5kzJ4PD4aCgoAAKhcJ4wjKXy4WLi0shU9RdUlKClStXQigUPl6xYsUgT09PBAQEGC0a5kyV1NRUpgStZNasWd3kcjmnW7dujyMjIw1BQUE4d+7c+1Np8rovtWPKbV4VGFOwZcuWTwIDA59ERESguLgYb/KVtOzxaLVatGjRIq1nz5575HI5CgoKylXVMMSr0WiMFfumBM1uT6VSMffomePnmEVnoLi4GH379o11cHCIBYCZM2fi0aNHZo8qYA6Z7d69e4RGo4nw8/NDSUnJax3qxNQTMr4JW5Mxm3DNRY+bNm2aExgYOP/ChQvhZpq1WbFixUx/f/9ejFk6ffp02NnZYeHChbh+/bp0+fLlqx4+fFguZC8UCnP69u0b0r1797ObN29ucO7cuc1SqdRu1qxZocHBwX+eOXMGRUVFEIlEL1g0THKaLRikUikEAgFUKhUUCkW5F3kwJXZubm7g8XgoLS2Fh4fH44yMDOPOi7f14s3XZrgVK1a8ciOenp7w8vKCUChEw4YNzRLpy4CRvu/itDCVSmXc+v8mmboyQVNaWgp7e3toNJqXmusGgwEKheKtEQazS57L5Zods06nw4wZMzbfvXu3f25ublvT63fv3u149uzZxn369Ln14MEDODk5wc7ODrGxsXUWLVoUXlpa2saE2VJ27drVTSgUxuTl5cFgMMS0aNEiOCAgQDxlypTcCxcuvHEXxmAwGNeXLXj+6e1YFTLc1KlTX8snmz59OhYvXgyNRvNe7jWzgDHxXOkxGh06dNBu3rx5eL9+/SLVarWbyWXJ9u3bewuFwlv5+fmoV68eZs2a1WPv3r2btFqtad4se9WqVV0++eSTu7t27TKecyKRSErEYnHJX7WI3iW8jd0Fb7SWRa/XY8mSJfj6668hEAgsu3zfc2C0rblPYWEhevTokTx9+vQhKKuoMV1r3759+0IoFGLo0KFfLViw4BdTZhOJRPKlS5f2Cw0NvavX6+Ho6Fju3Mr39bgFxmRlvzviZZ+/reH+DixZsgQAsHjx4gpNx7+DjP8Ppzu9C6J6mUBUKBSYOXPm2fT09N5btmzZDDrawd7e/sHKlStna7Va4ebNmzcmJiaaO99Ss2TJkk8nTZp0gXmXgKenJ/Ly8t5rvEgkEhgMBhw8eBA7d+5EUVHRKz13586df47hGKbT6XT45JNPjH6ZnZ0d6tev/1qMx2z+5HK52LVrF5RKJebOnVtpyoC9afS/DMxO9VexKAQCgfF+5m05lVksKpUKM2fOPGltbf3x8ePHe9vZ2eW3aNHiN7lcXvThhx/uT0xMNFsDOHLkyK/Hjx9/kNkmxOFwULt2bePBsQKB4K0LlL8KMpkMFy9exPLly3H58uV368O9CVi2bBmWLVtWTnr0798fo0aNQlBQkDFq+NJB8vmQy+U4ffo07t27B51OhwULFuD+/fvYt2+f8RW/7PulUinUajVycnKQkZHx2ovwJhjhVcDKyuq1THAOh4OtW7ciKioK7u7umDp1qtEUYgcQGEZ7/PgxTp48CV9fX3To8PytXyUlJS/43MxePoPBgFatWt1JSUm5Q5rPJjQ09A/T4AgDEydOnL1ixYoVfD6/3I5rZpfBy0ywl1Xuv2wdmfmzNwNXJpCZ9MhPP/2EuXPnvtW3qL5T0a9QKPDzzz9jx44d+Oyzz/Dpp5+iadOm5VIQfD7fuCuXx+MZk7rjxo17IW/y+++/IyQkBHv27CkXTpbL5Th16hR+//13yOVyMFGw0aNHlwstMzuFma35IpEIUmlZLTVT4CsQCIy7lRkiYBMDo0HFYjE4HI7xnBKBQIDo6Gh06tQJVlZWUCgUxj7ZzzPz3b9/P1q3bo26deuWIyymfx6PB7FYDLFYXO55g8GACxcu4MKFCwCAa9eu4ddffzWeRsbhcGBjY4OMjAxs3LgR4eHhyM3NhZWVFRYvXgw7OzvmNK8XLAHGfJdIJKhSpQrGjBkDnU4nHDx4cFhFzNauXbvw+fPnf8eczWLKHAyezDGRlZUVxGIx8vLyoNFo4ODg8AKDst/vwIxPKBQaNaZIJML58+cxc+ZMNG3aFC1btiynTZlnmHeRJyYm4urVq7h9+zZmzpz51g/P+kdsLZ1Oh7CwMISHh2PYsGEQi8Vo3brsSJPc3FykpKQgMjISN2/exMyZM5GcnFxhknL//v0QiUTGF9sfPXoUM2bMML7JEyg7Fvyzzz5DTk4OvvnmG9jYlO2QSU9Px9OnT5GdnQ1KSOPWrVuQy+W4evUqBAIBeDwecnJykJ2dDXt7e/D5fGg0GqNtX1BQgKysLERHR0OpVEIul4PH4+HWrVuYOHEiunbtiqlTpxpfiMgk2blcLiQSCUpLS3Hy5ElcunQJQqEQa9euhb29vfFcjpSUFDx9+hTXrl1DQUEBHBwcUFxcbGQ2Uzh06BAGDRqEsLAwY67qxIkT+Pzzz5GYmFhOo02cONH4/eTJk+U0HptBZDIZmE25Y8eODc3Lyxtsbi38/f33rlu3bhKzL8+clmIO82UznVAohF6vx5kzZ3DkyBGcP38eIpEI7dq1w8iRIxEYGAi9Xg+RSASVSoUffvjB+M6EhIQEqFQqODs7w8nJCfv370doaKjxxOmoqCj0798fHh4eEAqFzJYifP/99zh06BBycnLKWWFvHf5u1OVNwbhx47B69Wo4Ojq+1vNCoRAODg4vvW/OnDk4fvw4vL29X5C0lSX7mWPhHBwc4OzsDBcXF7i4uIDZImNqEpmCg4OD8Zg/qVSKKlWqoGXLlvD09HzBzJk4cSK+/PJL+Pv7mz1/41VK3dq3b4/WrVvD1dX1lfDXp08fPHnyBPfu3cP9+/df+MTFxWHVqlX1AeTi+Xkoxo+tre3+2NhYcWWRvJSUFPTv3x9OTk5o1aoVvvzySxgMBuzevdvI0Kbg4eFhfA9faGgovLy8zJqGNjY2FbYhk8mwZMkSfPXVV2jevPk75aMX+Op9YTgL/LMglUpx7NgxPHnyBLGxseU+jx49QlxcHFq0aLHBHLPVq1dv84QJEwRMxb05erp+/Xq5l6LweDw0btwYkydPNprxFQFTu/p30kwikeitpqleleE4FTHXf/kNJhYwD7Vq1cL06dNfqG7h8Xh4/Pix8+rVq2+g/BkraNiw4cI//vhj9u3bt/XVq1dH3bp1jRpYqVRCpVIhOjoaPXv2fOmOj38zvKqSsmSmLWCE5ORkREREQCgUQqfTGT8GgwFyudwdrKP6bG1tI6dMmdJ5/fr133p6euqLi4uNPm9kZCR69OiBunXrolatWujQocN/mtne+6CJBd5PUKvV2LdvH9RqNapXr17OPORwOLcXL17cJiMjo4FcLn/Wv3//szVq1FDI5XKjD11aWorJkydj/fr17+zkbgvDWeBfz3S///678XVgXC6XCbwYPv3008jCwsLIP//8Ez4+PpDL5cY8qk6nQ79+/ZCQkGBBooXhLPBXQKvV4uzZs8bvVatWhbe3N5KTk2Fvb298bzhzcGteXh7WrFljYbZXAEvQxAKvDF5eXggODoa/vz969OgBoVCIpKQkzJo1C5cuXfp/jZtXjuxb0gIW+KsgFAoREBCA0aNHo3r16haE4J9LCwwDcBhARSXhtQHUYo8TgBbAUwCP6bcWAEIApAL4CYCcdX89AAMBqABsB5D4kvE0BjAIQBa1xd7iLAMwCmUV8AcAmIroHgDaAbgNYBf1WRG4AwhF2TFwOwDcp99rAqhjZr4ZAO6atDEOwGkA8azfXGiMtgC2sdqtCEYT/tNNfhcD6A+gKYAHNMZi1vWGhCc5gE2EL6NiAzAUZRHKwzTGyqANgJ40j58BsA9SqUrzsSGcRrOuWQMYACAAQAyA3TCzLYgFfjSuUgBbADxjywQAg2lepwAcMXn2fwD6Ef1sBlDIuuZLNGYF4CCAi++rhvuCCMqrknvm0gKU0ILn0zPf0PWJtOjhAM7TojG7JPsDKACwE8BeIorKjoeeTPdvJQJLIAYAyg61uQfgAvWVC4B9NuIuAHEA1tLfP8E6O9MEWhCBHwOwnoTHZ3RtOmu+JTQ3A42JDRPo9/YmRJEB4ASANSSAhlQyXx/CiekBqQ4AbhCzrgAQRUzHlOWEAsghgXQUQBKev2H1A7r2G4B11P7mSsawCkA24fR3Yihn1vieAdgHYCO1xRwl70zju0ljvGfyrCn0IvrZAWAPgDQSjiChd57aWEdru4r17DRahw0AIggXzGnYI+j+3TSHHABL3qSGexMM5wHgEAAlabaqldwrJs0iIwmyDEAsyk6zsiECYx8jd48YGUQos1jXVhDDmAMnAEUswmfuP8sijCusa4OI+TkA2gJQAHBjtZUC4KMK+oomSc7AJ7Ro1ig7QIc93xlEHB4sQjtAElZtIkCOE7Mx0Jaeraj2rS+AM2Z+nwEgGc8P7eGQZGe29D8F8DXr/j9YAuEBER4DzQFoyNIwheokNNhv6dlN8wMx9HnWte9YGnsirT1jVgkAPAIw3kw/XLIO2LRwjBgcALqRcBKxNKGcNJcVCYQ+rGcfsejkGdEkA71pXaq8KYZ7E4nvYGK0HkSolRX6KUnrFJAknkxSLhdAM3r2d9b9+0j1MwS10gTxFe3tYd799qvJ4rcEYEeEc4p17QItdjUyU/aQ1nKjuXmZMTkZ08XVxMyKIOL2JzOUma8MwFek9VLp3gDCyYckIPisudWncYAlcFCJBdGWNJEpHKS1UbLMWkYg2BA+DrPuP0Dj4REjzGZdSwKgg5mXOtJc8k1wcZbWFaTR2Of5WbHGdIoEFSPpNcQY5voxEFMtNfmdKfMPIkHNuAAPybrxIxdDR0KFgd/JhWFcotWsayksAfBG4E2kBX4hE6xGJWaXOdhMBHWOJSGziWkZSCDzhkOLzUid4cRUHStoO4uQVJ2IgCEICUkrMet3EAEqqM3qJEEPkCTnkllhzpTS0sfNRONLTX4DgB8AXCVcMXCetJKNCe4MZM74mZiGjsQgpmBLxPSdmWsPTb63B9CApLwPEWAG63oh4UfMsggYWExrEmOmn3RiYlfWWlUjXAhJIzUnwVFAeBrE0jKPWG2FkP81tgKGY3z3ocSobvSXMV1TTZ4pIRxbAcgkhmbgMetZUwthDoBIE5/2H2c4RsuIWBLqZVCbtI2/ibYwPbJLQ4zDY/XDJwS4kaRbY6b9ODIzdgP4nhA9jqWBBSZI19PHmpg7FMAYCkL0I9/shhlC05OfMJ2c92LSJkUmmt6NAgndKpDKprgzkJ+zjMzBQgooVITfABpL+kvw3pb8tJlEtDXpOa3JnLhmLJU5ALrQ/NQVmNZ3yLz+iRhvGOFEC6AzmefnSfvIAHQHcMuknY9p3cabCSyZAo8YqDq1v44YPN0MkzK0bhr8UpvRYFxa88YkJN7c20nfYNDEjxiBKW51JPPqBn3Y71pbb+JDgQIC8Sa/jSAJxKkgGqYjZO9l9RPOIuLlZC7uIILPIckaDWCKiXmTQY73NRNTFAAuA1hIWoHp5wrLFxtN0vEIMcYTE+27lKKdnEp8zkKW4w9WQINpdzBpgZYVBKzCX7I+w6kP9ssZm5DJ7Gzig2bg+VHnQvLpUljmIeMTM7g4TEQrA/Aj4XwDBaLiSStnE54YqE9CrzHrtzEkuNj39asA52zoRkzlRhHLHSbXL5E27U9+qWl0+KHJWhymcfv8XT4y/bzNSpMisv8ZSZnIiiL1ZTntbNPHnhZHzkoDJBAyh1OINoFlbnLJF1zBijTlkzSrbdLHANJwaUR4bEfYmUyo+8QsPDMmiZTMi69YmiCXtPQ20kiM/+jCWlgORdU2/QULAJQ++ZVlytpTsCfDzL3tKtD0DEwhc3MYgP2s3xNJaFVjmU2ONF8lMdEBchf+R9qWgW2kLcG6190kUDWTcM0ls/cm69pdWmdv0nJfEr30AnCSdd8VE5wXkiA6TmsJWhfGkoimNmCSAiqg8TuRgC1h0dhjFrMdJI3WmGj4zcIb1HB1iQA9X3KfP03Iz4x5+wjAApbPksWKWsaSpOUREU8i4rOqwFSOZy2UjIjrW1bKIIkQDIrSpbPMLi3L3G1EjNqqgvkcI8bg0ifcxPS0pYXrWQlOnIgA2GmBcNKsTLsbSMrzzDDmLZh5GytBJ2L0MdSPJ30YX/AOgDDCqTV9Z96ltoHGVZ+ECPOsub6siYGY9XInc4/RVrdIKDHm26fUtiMF3gzkn1dh9WNTQZQyGWV5WIYWFpEGFZMFkM9KAXUj/HvRs09YdFCFaJaJWp4kuqlBzOtJGpX3pjTcm2S4OkTUHi+5rzUxiksFpkEOLfoTImYhi/AfUwTqDoWzP6qknxBa8Nvk0/3GaktAkapEausZ+Q4MLKdFjaZriyvppwa1cZc+N01MEW8SHA0qacORcNLGBJ/3WPN9QH2ZwijCU0Wwhgg7hcbBfGaz1iORxh6PspyjmDRqOpmcaSbP/q+CviYTvm7T+oSZ4OE+zeM2tTmcru0ipjAd48gK+qlPY2Zwk8SiBT71m0aCL99E6/YhJmNo6BAxoisxbTbNmxkDOy/5txnuTVaaCGjQ6S9xMplIYSqZCKbgRgRbSlKRfY8daUYuacOcl4zJgyRdAS2yqcPdkDTkY5Z5wvZJnYkRHr2kH1siAj0tcqmZ1EFaJXjh0lizWKFyRms0IOkfg/JVG+zoJbcSXFShOZpKaTmeV9440XzVhCcVrWdVloZlQ5pJNJkNNWkuOXixMsaaLAehCc7dWcExNuTQ2pkDO7KqOOSO5JmxpByJzkyrqt3JMigmGjOQ1q7KWg92wCX5ZYGTV1VSluJlC1jgDblmrwLv+47vb1CWyAQ51R+9J+MaQJHRsyhL2v4IIPAvtsHHX8tbvg58QWF8c/A/lOUGQb7TIFb0d8Y7wGFLMmv/X0n2953hxqOs4JaJJNr8w+PxQVnI+yeKWj4kvyOAQs+rXsXBJl/sKJ7Xib4tGFGJkLIiUxcoy2ExQZ0WMJ9wftPQGMDn/98Y7lXTAt5ks5uGpIUoCymno3z1Odsf47BsdSfy4VJe4V6QI80kWaeZeaY6EXhCJf6EOT+AS9cy8GLo14V8jQQz/uBxCopUJ+faFs8rzTtRVE+H8ukIW2ozheWf1SBNojGDAzE586hgviXUt7m5FlOgiIESChow803G88TvKTwvb1Oy/E6VGZzwqe8nZvxuAY2b7ZN70lomVzCHfFqTvxp2r0FzyjT5XURRyLQK/FxzNJtqxg/1YEVBK+o/i0Xr1ckXlv8l27OSKKUXypKuT4gIFrLMoI9Zka1YlIWdQVL7AEX67hBRf4WyHNBN+s68YN0BZXmh1SxtsZKlJWJZEaZNLLOnOcqS6g8pihSF59tgFpKm2ULRyWSUlQCxo6TRxFDxKAtPM0GUBazfT6Msl8dAOEW0mP4fEaGGoywPOJY0YCYtKCgK94DufYiyKKyI8KAl/HmTEPqJ+mais97URgfC0TpqI4uED5cVzTxFQYgEmgNz7Tyt3yFqNxZlOwBAY2G2raxGWV6NiTQywY7vCJ/HaP1v0tyZcZ0iIfSUTH8nlO3mYMayh6VFrVFWQZJI6/U7RRkZ8/Yga9xcGjOTJqmNspB9Aq03O7/bkegsnsY9tBJy70b3PqZ16c4KwGyj9h+jLM1TjfXMTpSlIeLonq54XnifCqDrm0gL2KKs6uIYIbIpRWz60GC0ZBJY029MpbiYpPxBipAxJUl/EPI/pu+1yUTUoiwU7Y6yyocCPN8qw2a4K3heHXKXECAlZF3G89D4dmp/CLX/HWlJGzxPgH5L/4fSvd4oy+s9obmJUZbzu0cSvBoh2pGEkAZl1TL/Q1ktqAFlW2yAshD3JNJqOpTl9bjEJJlkyoWSdO9IDLiDFrM24ewQnieJe+P5FiYZCQgDmbFCIpwwGrM3WRsMns7geQWLjAgphSUM0l7CcAwuB5Ag3UYExmOteShF92zI3L5K36vSujBJ6c0keNxpnvGs6G9XEow8FsOloKxAgkvjOUwCugn124HaKkBZ7o9PzKGE+ZxpA6K18TTWadQOs88vmtbWhejxOj03CM/zmDISfgaUVezYkSCMeRMMN5zMDPbRvcG0qOF4XnTMwDKUVYJYkxT2Z5lUxSirw2M0YCExsDWZF+ySoc9ICoGI6TOWtJ7EMll4hDhP0g5X6dpulN802JgWgdlwamqudaY5JaOszKcGaaoAMq/aEnEx2m0vym8L8iCGZkq55qOs2LkKmVjzqH0mzM4jbZBPzCYhE5FdsuVMuG9CAqoYz7fXgMbamnCaRgTsQ2OfQ4zNJb/yR9ZzXSh8ziFCevIShtuL59trQGPNJb+wC5lSzLhcyURjz6Mpjb0JzbcN69pIVv+dSeCwGS6efv+A6IXtv39IeF9Ja1Gd5l+NBK+5vORmlC/GFhCj16Fxs3OLdYhmvFFWWpZu4hdnsrRxdwAP3kRplz8xDttv+5P+NjTDcNdoISQ0WA3LVFPheXU+uxCZR8TGru5OQsXbIZhJ+hJSq9CC8vC8PIeH8rt/uXheUlUPL9ZrHiep5kgM/Tn9rqexMEnRNJKiH5PEZ/sPOXi+e9mP8JSNstq9NSgrccpEWUXEenqGQ3/FhCu2X5JFi+xLbStN5qOmOTH+5u8sYtXh+f43vYn/ysfzgulXAQ5LQ4EIM5HGlUDfmaAHY/U8Zt2fSIIjgObIzhXeq8DvB56f6qwnrZNs4u+dY/nbvrSGHNazkWba9DARthoyqWvgxTzmU8IbU9xdaoKTApa/yof5fPJfDppkkXYSsRxtH1rYDLy4L8uDFlPDGhjzl2MSEWUjxwrl9z1ZVTIBJfVzgPymUyz/sZuZ9k37ysaLmwkb0Bx1xGznaKwq1tibsvAlMAlafE6mURb5N01IU/LIVDlKGjyQxpxmImBUeL6DgQGm0iPTjPDhsOakJ0KpT/cZiBn5RPz8CnDxVxjOyeQ3J5oDx2QscpqHIws/9mT2MhtC2XORseIBHBq7jrVWUvpbhOe70xmoy6LJS2R6CmnOugroutRMlDuI8KVD+XI1ZsNwlpm+OX8nslpZWuB3GsgEluY4gbKSqdUkvRvStaqUu/mdRUCV9cNlSWNHaoshtG/wfGcwz4RxtcRwNhQUYXYcjDPD4Kb9icn+rk+hb0YqR1KU7SAFHDQ0h4/IjncljVmdGP4yyo5eCEDZkRGfk7/RH2XlYwuI4OrT3xpk9iwlie7EYgodSctUlN/BPIHGfIUsBnP4k1AgwYP8EhW1G0bRUnO4YAs+0/85Zn4vJZ/RlWXu25GgMx1XApmr7F3a42hMF1FW0fGtyTUxK5rqwWLuYeSfMWaxNZ7vNuESHXajQFovchtU1N4pVgDPjaUY9tAzvvS9Ea0ljywZ9rin0Vrfpza5FeDQ3PfX1nDx5POEkR/jQvZ7OGm4DSS9o8hUi0RZItUaL1bF6yv5XkiRpSBCcgmL+Aystgw0+dtEwIxDXpXM2QYsKccz05+YNNFCYoxrJDAOkn92g0yMaFqAtuTXZBDhLyUzezhpwZtk1m4np70t+Wt7yAeIJ/ycpOdr05h3k8AoomujqM1DdL2I8DmKCJ5XAf6EZHaOI5+xE0nlOqxorgEv7rPTV/C/oYLfi2nMJaTpp9IYBSbj0pJfFkZmtYGETSgRL1PzeYGEmj2eH2txB2Wla1H0v4DwJ6V7xpG/1oloJJHWJp+CFkfJh/ejvhgfbhUxXEsKGAUTzm+SJRJGdBBKwa7zJCBqE9PqiJn0FeDQ3Pe/lRZgcg2fE1HxzKjkySi/j4tPpqeIpaXqsMxG5ruEJFoOIWIIaQmeSW7JnqWNHFl+U3/SBDVZZgafGNDDxNH3MzFnAmncH5nJKYXQtUYm1+aRJmpC39kFrUwwpDGZuF+YOPhTWCFosELdn+P57gobEjxjTdq2JXyxNVUtE/OoOuEi1MQE8kb5InEbVvpEhucnqLnieR2hIwun+0iwNqSx+piYXbXNSHdHYryRZswxa5TtHuhL8/JG+XNMhtAcmACTzGQuk8h/Nu2zJa1ZL5N19mLNhZ0Wmkx/2WBHfY82cTvsUP6kOdPvNgBq/lteV+VCEqU53n/gUqRLTWH8fhRA6UwEtJ3MwwX478Bh0m4WeE3F9S43oL4KqCjCVPgvwKmeJOBOkpDfksRmonexlBu69h+io+uoeFeABV4DOJZTli1ggXdrJlnAAhawMJwFLGBhOAtYwAIWhrOABSwMZwELWMAE/m8AhwxO7Lysl3kAAAAASUVORK5CYII=';
    $local_date = date('Y-m-d');


    // PHP MAILER FUNCTION
	use PHPMailer\PHPMailer\PHPMailer;
	use PHPMailer\PHPMailer\SMTP;
	use PHPMailer\PHPMailer\Exception;
    require 'PHPMailer/src/Exception.php';
    require 'PHPMailer/src/PHPMailer.php';
    require 'PHPMailer/src/SMTP.php';
	function php_mailer($to, $user, $subject, $body) {
		// require 'PHPMailer/src/Exception.php';
		// require 'PHPMailer/src/PHPMailer.php';
		// require 'PHPMailer/src/SMTP.php';

		$mail = new PHPMailer(true);
		try {
		    $mail->isSMTP();
			// $mail->SMTPDebug  = SMTP::DEBUG_SERVER;
		    $mail->Host       = 'interlinkiq.com';
		    $mail->CharSet 	  = 'UTF-8';
		    $mail->SMTPAuth   = true;
		    $mail->Username   = 'admin@interlinkiq.com';
		    $mail->Password   = 'L1873@2019new';
		    $mail->SMTPSecure = PHPMailer::ENCRYPTION_SMTPS;
		    $mail->Port       = 465;
		    $mail->clearAddresses();
		    $mail->setFrom('services@interlinkiq.com', 'Interlink IQ');
		    $mail->addAddress($to, $user);
            // $mail->addReplyTo('services@interlinkiq.com', 'Interlink IQ');
            // $mail->addReplyTo($to, $user);
		    // $mail->addCC('services@interlinkiq.com');

		    $mail->isHTML(true);
		    $mail->Subject = $subject;
		    $mail->Body    = $body;

		    $mail->send();
		    $msg = 'Message has been sent';
		} catch (Exception $e) {
		    $msg = "Message could not be sent. Mailer Error: {$mail->ErrorInfo}";
		}

		return $msg;


        // // This email address must be verified with Amazon SES to send.
        // $sender = 'admin@interlinkiq.com';
        // $senderName = 'IIQ';
         
        // // is still in the sandbox, this address must be verified.
        // $recipient = 'greeggimongala@gmail.com';
         
        // // Replace smtp_username with your Amazon SES SMTP user name.
        // $username = 'AKIAROKUUVANWTUPGMV6';
         
        // // Replace smtp_password with your Amazon SES SMTP password.
        // $password = 'BPnAVc81PnSOt9/Q/UXtQoToXARkfF6NuzRP/kU66JYO';
         
         
        // // If you're using Amazon SES in a region other than US West (Oregon),
        // // replace email-smtp.us-west-2.amazonaws.com with the Amazon SES SMTP
        // // endpoint in the appropriate region.
        // $host = 'email-smtp.us-west-2.amazonaws.com'; // please enter you endpoint
        // $port = 587;
         
        // // The subject line of the email
        // $subject = 'Testing';
         
        // // If you are sending The plain-text body of the email then uncomment below code line
        // //$bodyText =  "-- Put body text here --";
         
        // // The HTML-formatted body of the email
        // $bodyHtml = 'Enter body html here';
         
        // $mail = new PHPMailer(true);
         
        // try {
        //     // Specify the SMTP settings.
        //     $mail->isSMTP();
        //     $mail->setFrom($sender, $senderName);
        //     $mail->Username   = $username;
        //     $mail->Password   = $password;
        //     $mail->Host       = $host;
        //     $mail->Port       = $port;
        //     $mail->SMTPAuth   = true;
        //     $mail->SMTPSecure = 'tls';
        //   //  $mail->addCustomHeader('X-SES-CONFIGURATION-SET', $configurationSet);
         
        //     // Specify the message recipients.
        //     $mail->addAddress($recipient);
        //     // You can also add CC, BCC, and additional To recipients here.
         
        //     //If you want to send reply to specific email , then use below code for Reply To
        //     $mail->ClearReplyTos();
        //     $mail->addReplyTo('Enter Reply to Email here', 'Enter Reply to name here');
         
        //     //Add attachments
        //     $mail->addAttachment('/tmp/image.jpg', 'new.jpg');    //Optional name
         
        //     // Specify the content of the message.
        //     $mail->isHTML(true);
        //     $mail->Subject    = $subject;
        //     $mail->Body       = $bodyHtml;
        //     $mail->AltBody    = $bodyText;
        //     $mail->Send();
        //     $msg = "Email sent successfully!";
        // } catch (phpmailerException $e) {
        //     $msg = "An error occurred. {$e->errorMessage()}", PHP_EOL; //Catch errors from PHPMailer.
        // } catch (Exception $e) {
        //     $msg = "Email not sent. {$mail->ErrorInfo}", PHP_EOL; //Catch errors from Amazon SES.
        // }

        // return $msg;


		// try {
		// 	// $mail->isMail();
		// 	// $mail->SMTPDebug = SMTP::DEBUG_SERVER;
		// 	// $mail->isSMTP();
		// 	// $mail->Host       = 'interlinkiq.com';
		// 	// $mail->SMTPAuth   = true;
		// 	// $mail->Username   = 'admin@interlinkiq.com';
		// 	// $mail->Password   = 'L1873@2019new';
		// 	// $mail->SMTPSecure = PHPMailer::ENCRYPTION_SMTPS;
		// 	// $mail->Port       = 465;
		// 	// $mail->setFrom('services@interlinkiq.com', 'Interlink IQ');
		// 	// $mail->addAddress('greeggimongala@gmail.com', 'Joe User');     //Add a recipient

		// 	// Server settings
		// 	$mail->isSMTP();                                            //Send using SMTP
		// 	$mail->SMTPDebug = SMTP::DEBUG_SERVER;                      //Enable verbose debug output
		// 	$mail->Host       = 'email-smtp.us-east-1.amazonaws.com';   //Set the SMTP server to send through
		// 	$mail->Port       = 587;                                    //TCP port to connect to; use 587 if you have set `SMTPSecure = PHPMailer::ENCRYPTION_STARTTLS`
		// 	$mail->SMTPSecure = 'TLS';                                  //Enable implicit TLS encryption
		// 	$mail->SMTPAuth   = true;                                   //Enable SMTP authentication
		// 	$mail->Username   = 'AKIAROKUUVANUHT3CDM5';                     //SMTP username
		// 	$mail->Password   = 'BCtHVM5jTXvdcjOc5Q3qxb0MGNJcXZOKg1Ngcw4BXSki';                               //SMTP password


		// 	$mail->setFrom('services@interlinkiq.com', 'Interlink IQ');
		// 	$mail->addAddress($to, $user);
	        

		// 	$mail->isHTML(true);
		// 	$mail->Subject = $subject;
		// 	$mail->Body    = $body;

		// 	$mail->send();
		// 	$msg = 'Message has been sent';
		// } catch (Exception $e) {
		//     $msg = "Message could not be sent. Mailer Error: {$mail->ErrorInfo}";
		// }

		// return $msg;
	}
	function php_mailer_cig($to, $user, $subject, $body) {
		// require 'PHPMailer/src/Exception.php';
		// require 'PHPMailer/src/PHPMailer.php';
		// require 'PHPMailer/src/SMTP.php';

		$mail = new PHPMailer(true);
		try {
		    $mail->isSMTP();
			// $mail->SMTPDebug  = SMTP::DEBUG_SERVER;
		    $mail->Host       = 'interlinkiq.com';
		    $mail->CharSet 	  = 'UTF-8';
		    $mail->SMTPAuth   = true;
		    $mail->Username   = 'admin@interlinkiq.com';
		    $mail->Password   = 'L1873@2019new';
		    $mail->SMTPSecure = PHPMailer::ENCRYPTION_SMTPS;
		    $mail->Port       = 465;
		    $mail->clearAddresses();
		    $mail->setFrom('services@interlinkiq.com', 'Interlink IQ');
		    $mail->addAddress($to, $user);

		    $mail->isHTML(true);
		    $mail->Subject = $subject;
		    $mail->Body    = $body;

		    $mail->send();
		    $msg = 'Message has been sent';
		} catch (Exception $e) {
		    $msg = "Message could not be sent. Mailer Error: {$mail->ErrorInfo}";
		}

		return $msg;
	}
	function php_mailer_request_service($to, $to2, $to3, $user, $subject, $body) {
		// require 'PHPMailer/src/Exception.php';
		// require 'PHPMailer/src/PHPMailer.php';
		// require 'PHPMailer/src/SMTP.php';

		$mail = new PHPMailer(true);
		try {
		    $mail->isSMTP();
			// $mail->SMTPDebug  = SMTP::DEBUG_SERVER;
		    $mail->Host       = 'interlinkiq.com';
		    $mail->CharSet 	  = 'UTF-8';
		    $mail->SMTPAuth   = true;
		    $mail->Username   = 'admin@interlinkiq.com';
		    $mail->Password   = 'L1873@2019new';
		    $mail->SMTPSecure = PHPMailer::ENCRYPTION_SMTPS;
		    $mail->Port       = 465;
		    $mail->clearAddresses();
		    $mail->setFrom('services@interlinkiq.com', 'Interlink IQ');
		    $mail->addAddress($to, $user);
		    $mail->addAddress($to2, $user);
		    $mail->addAddress($to3, $user);

		    $mail->isHTML(true);
		    $mail->Subject = $subject;
		    $mail->Body    = $body;

		    $mail->send();
		    $msg = 'Message has been sent';
		} catch (Exception $e) {
		    $msg = "Message could not be sent. Mailer Error: {$mail->ErrorInfo}";
		}

		return $msg;
	}
	function php_mailer_chat($to, $user, $subject, $body, $from, $name) {
		// require 'PHPMailer/src/Exception.php';
		// require 'PHPMailer/src/PHPMailer.php';
		// require 'PHPMailer/src/SMTP.php';

		$mail = new PHPMailer(true);
		try {
		    $mail->isSMTP();
			// $mail->SMTPDebug  = SMTP::DEBUG_SERVER;
		    $mail->Host       = 'interlinkiq.com';
		    $mail->CharSet 	  = 'UTF-8';
		    $mail->SMTPAuth   = true;
		    $mail->Username   = 'admin@interlinkiq.com';
		    $mail->Password   = 'L1873@2019new';
		    $mail->SMTPSecure = PHPMailer::ENCRYPTION_SMTPS;
		    $mail->Port       = 465;
		    $mail->clearAddresses();
		    $mail->setFrom('services@interlinkiq.com', 'Interlink IQ');
		    $mail->addReplyTo($from, $name);
		    $mail->addAddress($to, $user);
		    $mail->addBCC('services@interlinkiq.com');
		    $mail->addBCC('enterprise@interlinkiq.com');
		    // $mail->addBCC('virginia@consultareinc.com');

		    // $mail->addBCC('nworldbizintl@gmail.com');
		    // $mail->addBCC('lazpro101@gmail.com');
		    // $mail->addBCC('proximaproducts@gmail.com');

		    $mail->isHTML(true);
		    $mail->Subject = $subject;
		    $mail->Body    = $body;

		    $mail->send();
		    $msg = 'Message has been sent';
		} catch (Exception $e) {
		    $msg = "Message could not be sent. Mailer Error: {$mail->ErrorInfo}";
		}

		return $msg;
	}
	function php_mailer_dynamic($sender, $recipients, $subject, $body) {
		$mail = new PHPMailer(true);
		try {
		    $mail->isSMTP();
			// $mail->SMTPDebug  = SMTP::DEBUG_SERVER;
		    $mail->Host       = 'interlinkiq.com';
		    $mail->CharSet 	  = 'UTF-8';
		    $mail->SMTPAuth   = true;
		    $mail->Username   = 'admin@interlinkiq.com';
		    $mail->Password   = 'L1873@2019new';
		    $mail->SMTPSecure = PHPMailer::ENCRYPTION_SMTPS;
		    $mail->Port       = 465;
		    $mail->clearAddresses();

            $mail->setFrom('services@interlinkiq.com', 'Interlink IQ');
            foreach($sender as $email => $name) {
               $mail->addReplyTo($email, $name);
            }
            foreach($recipients as $email => $name) {
               $mail->addAddress($email, $name);
            }

		    $mail->isHTML(true);
		    $mail->Subject = $subject;
		    $mail->Body    = $body;

		    $mail->send();
		    $msg = 'Message has been sent';
		} catch (Exception $e) {
		    $msg = "Message could not be sent. Mailer Error: {$mail->ErrorInfo}";
		}

		return $msg;
	}
    function php_mailer_1($to, $user, $subject, $body, $from, $name) {
        // require 'PHPMailer/src/Exception.php';
        // require 'PHPMailer/src/PHPMailer.php';
        // require 'PHPMailer/src/SMTP.php';

        $mail = new PHPMailer(true);
        try {
            $mail->isSMTP();
            // $mail->SMTPDebug  = SMTP::DEBUG_SERVER;
            $mail->Host       = 'interlinkiq.com';
            $mail->CharSet    = 'UTF-8';
            $mail->SMTPAuth   = true;
            $mail->Username   = 'admin@interlinkiq.com';
            $mail->Password   = 'L1873@2019new';
            $mail->SMTPSecure = PHPMailer::ENCRYPTION_SMTPS;
            $mail->Port       = 465;
            $mail->clearAddresses();
            $mail->setFrom('services@interlinkiq.com', 'Interlink IQ');
            $mail->addAddress($to, $user);
            $mail->addReplyTo($from, $name);
            $mail->isHTML(true);
            $mail->Subject = $subject;
            $mail->Body    = $body;

            $mail->send();
            $msg = 'Message has been sent';
        } catch (Exception $e) {
            $msg = "Message could not be sent. Mailer Error: {$mail->ErrorInfo}";
        }

        return $msg;
    }
	function php_mailer_2($to, $user, $subject, $body, $from, $name) {
		$mail = new PHPMailer(true);
		try {
		    $mail->isSMTP();
			// $mail->SMTPDebug  = SMTP::DEBUG_SERVER;
		    $mail->Host       = 'interlinkiq.com';
		    $mail->CharSet 	  = 'UTF-8';
		    $mail->SMTPAuth   = true;
		    $mail->Username   = 'admin@interlinkiq.com';
		    $mail->Password   = 'L1873@2019new';
		    $mail->SMTPSecure = PHPMailer::ENCRYPTION_SMTPS;
		    $mail->Port       = 465;
		    $mail->clearAddresses();
		    $mail->setFrom('services@interlinkiq.com', 'Interlink IQ');
		    $mail->addAddress($to, $user);
		    $mail->addReplyTo($from, $name);

		    $mail->isHTML(true);
		    $mail->Subject = $subject;
		    $mail->Body    = $body;

		    $mail->send();
		    $msg = 'Message has been sent';
		} catch (Exception $e) {
		    $msg = "Message could not be sent. Mailer Error: {$mail->ErrorInfo}";
		}

		return $msg;
	}
	function php_mailer_multi($recipients, $recipientsCC, $subject, $body, $from_email, $from_name) {
		// require 'PHPMailer/src/Exception.php';
		// require 'PHPMailer/src/PHPMailer.php';
		// require 'PHPMailer/src/SMTP.php';

		$mail = new PHPMailer(true);
		try {
		    $mail->isSMTP();
			// $mail->SMTPDebug  = SMTP::DEBUG_SERVER;
		    $mail->Host       = 'interlinkiq.com';
		    $mail->CharSet 	  = 'UTF-8';
		    $mail->SMTPAuth   = true;
		    $mail->Username   = 'admin@interlinkiq.com';
		    $mail->Password   = 'L1873@2019new';
		    $mail->SMTPSecure = PHPMailer::ENCRYPTION_SMTPS;
		    $mail->Port       = 465;
		    $mail->clearAddresses();
		    $mail->setFrom('services@interlinkiq.com', 'Interlink IQ');

		    foreach($recipients as $email => $name) {
				$mail->addAddress($email, $name);
			}

		    foreach($recipientsCC as $email => $name) {
				$mail->addCC($email, $name);
			}

		    $mail->addReplyTo($from_email, $from_name);
		    $mail->isHTML(true);
		    $mail->Subject = $subject;
		    $mail->Body    = $body;

		    $mail->send();
		    $msg = 'Message has been sent';
		} catch (Exception $e) {
		    $msg = "Message could not be sent. Mailer Error: {$mail->ErrorInfo}";
		}

		return $msg;
	}
	function php_mailer_11($to, $user, $subject, $body, $from, $name) {
		// require 'PHPMailer/src/Exception.php';
		// require 'PHPMailer/src/PHPMailer.php';
		// require 'PHPMailer/src/SMTP.php';

		$mail = new PHPMailer(true);
		try {
		    $mail->isSMTP();
		  //  $mail->SMTPDebug  = SMTP::DEBUG_SERVER;
		    $mail->Host       = 'interlinkiq.com';
		    $mail->CharSet 	  = 'UTF-8';
		    $mail->SMTPAuth   = true;
		    $mail->Username   = 'admin@interlinkiq.com';
		    $mail->Password   = 'L1873@2019new';
		    $mail->SMTPSecure = PHPMailer::ENCRYPTION_SMTPS;
		    $mail->Port       = 465;
		    $mail->clearAddresses();
		    $mail->setFrom($from, $name);
		    $mail->addAddress($to, $user);

		    $mail->isHTML(true);
		    $mail->Subject = $subject;
		    $mail->Body    = $body;

		    $mail->send();
		    $msg = 'Message has been sent';
		} catch (Exception $e) {
		    $msg = "Message could not be sent. Mailer Error: {$mail->ErrorInfo}";
		}

		return $msg;
	}
	function php_mailer_22($to, $user, $subject, $body, $from, $name) {
		// require 'PHPMailer/src/Exception.php';
		// require 'PHPMailer/src/PHPMailer.php';
		// require 'PHPMailer/src/SMTP.php';

		$mail = new PHPMailer(true);
		try {
		    $mail->isSMTP();
		  //  $mail->SMTPDebug  = SMTP::DEBUG_SERVER;
		    $mail->Host       = 'interlinkiq.com';
		    $mail->CharSet 	  = 'UTF-8';
		    $mail->SMTPAuth   = true;
		    $mail->Username   = 'admin@interlinkiq.com';
		    $mail->Password   = 'L1873@2019new';
		    $mail->SMTPSecure = PHPMailer::ENCRYPTION_SMTPS;
		    $mail->Port       = 465;
		    $mail->clearAddresses();
		    $mail->setFrom($from, $name);
		    $mail->addAddress($to, $user);

		    $mail->isHTML(true);
		    $mail->Subject = $subject;
		    $mail->Body    = $body;

		    $mail->send();
		    $msg = 'Message has been sent';
		} catch (Exception $e) {
		    $msg = "Message could not be sent. Mailer Error: {$mail->ErrorInfo}";
		}

		return $msg;
	}
    function php_mailer_contact($to, $to2, $to3, $user, $from_email, $from_name, $subject, $body) {
        // require 'PHPMailer/src/Exception.php';
        // require 'PHPMailer/src/PHPMailer.php';
        // require 'PHPMailer/src/SMTP.php';

        $mail = new PHPMailer(true);
        try {
            $mail->isSMTP();
            // $mail->SMTPDebug  = SMTP::DEBUG_SERVER;
            $mail->Host       = 'interlinkiq.com';
            $mail->CharSet    = 'UTF-8';
            $mail->SMTPAuth   = true;
            $mail->Username   = 'admin@interlinkiq.com';
            $mail->Password   = 'L1873@2019new';
            $mail->SMTPSecure = PHPMailer::ENCRYPTION_SMTPS;
            $mail->Port       = 465;
            $mail->clearAddresses();
            $mail->setFrom('services@interlinkiq.com', 'Interlink IQ');
            $mail->addAddress($to, $user);
            $mail->addAddress($to2, $user);
            $mail->addAddress($to3, $user);
            $mail->addReplyTo($from_email, $from_name);

            $mail->isHTML(true);
            $mail->Subject = $subject;
            $mail->Body    = $body;

            $mail->send();
            $msg = 'Message has been sent';
        } catch (Exception $e) {
            $msg = "Message could not be sent. Mailer Error: {$mail->ErrorInfo}";
        }

        return $msg;
    }


	// LOGIN SECTION
	if( isset($_GET['logout']) ) {
		unset($_COOKIE['ID']);
    	setcookie('ID', '', time() - 3600, '/'); // empty value and old timestamp
    	
		unset($_COOKIE['first_name']);
    	setcookie('first_name', '', time() - 3600, '/'); // empty value and old timestamp
    	
		unset($_COOKIE['last_name']);
    	setcookie('last_name', '', time() - 3600, '/'); // empty value and old timestamp

		unset($_COOKIE['locked']);
    	setcookie('locked', '', time() - 3600, '/'); // empty value and old timestamp

		unset($_COOKIE['switchAccount']);
    	setcookie('switchAccount', '', time() - 3600, '/'); // empty value and old timestamp
    	
    	unset($_COOKIE['employee_id']);
    	setcookie('employee_id', '', time() - 3600, '/'); // empty value and old timestamp
    	
    	unset($_COOKIE['driver_license']);
    	setcookie('driver_license', '', time() - 3600, '/'); // empty value and old timestamp

        if( isset($_COOKIE['client']) ) {
        	if ($_COOKIE['client'] == 1)  {
    			unset($_COOKIE['client']);
    	    	setcookie('client', '', time() - 3600, '/'); // empty value and old timestamp
        		echo '<script>window.location.href = "CannOS-Login"</script>';
        	} else if ($_COOKIE['client'] == 2)  {
                unset($_COOKIE['client']);
                setcookie('client', '', time() - 3600, '/'); // empty value and old timestamp
                echo '<script>window.location.href = "FoodSafety360"</script>';
            } else if ($_COOKIE['client'] == 3)  {
                unset($_COOKIE['client']);
                setcookie('client', '', time() - 3600, '/'); // empty value and old timestamp
                echo '<script>window.location.href = "SafeCannabis360"</script>';
            } else if ($_COOKIE['client'] == 4)  {
                unset($_COOKIE['client']);
                setcookie('client', '', time() - 3600, '/'); // empty value and old timestamp
                echo '<script>window.location.href = "Exim360"</script>';
            } else {
    			unset($_COOKIE['client']);
    	    	setcookie('client', '', time() - 3600, '/'); // empty value and old timestamp
        		echo '<script>window.location.href = "login"</script>';
        	}
        }
	}
	if( isset($_POST['btnSignIn']) ) {
		$client = $_POST['client'];
		$email = $_POST['email'];
		$password = $_POST['password'];
		$password_hash = password_hash($password, PASSWORD_DEFAULT);
		$exist = false;
		$exist_email = false;
		$exist_username = false;
		$isPasswordCorrect = false;
		$message = 'Incorrect details. Please try again!<br>If you need some help, please click <a href="#modalService" data-toggle="modal"><strong>here</strong></a>';

		$selectEmail = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE client = $client AND is_active = 1 AND email = '". $email ."'" );
		if ( mysqli_num_rows($selectEmail) > 0 ) {
			while($rowUser = mysqli_fetch_array($selectEmail)) {
				$ID = $rowUser['ID'];
				$first_name = $rowUser['first_name'];
				$last_name = $rowUser['last_name'];
				$password_verify = $rowUser['password'];
				$client = $rowUser['client'];
				$is_verified = $rowUser['is_verified'];
				$is_active = $rowUser['is_active'];
				$employee_id = $rowUser['employee_id'];

				$driver_license = '';
				$selectUserInfo = mysqli_query( $conn,"SELECT * FROM tbl_user_info WHERE user_id = $ID" );
				if ( mysqli_num_rows($selectUserInfo) > 0 ) {
					$rowUserInfo = mysqli_fetch_array($selectUserInfo);
					$driver_license = $rowUserInfo['driver_license'];
				}

				$isPasswordCorrect = password_verify($password, $password_verify);
				if ($isPasswordCorrect == true) {
					if ($is_active == 1 and $is_verified == 1) {
						$exist = true;
						$message = "Log In successfully";

						setcookie('ID', $ID, time() + (86400 * 1), "/");  // 86400 = 1 day
						setcookie('first_name', $first_name, time() + (86400 * 1), "/");  // 86400 = 1 day
						setcookie('last_name', $last_name, time() + (86400 * 1), "/");  // 86400 = 1 day
						setcookie('employee_id', $employee_id, time() + (86400 * 1), "/");  // 86400 = 1 day
						setcookie('client', $client, time() + (86400 * 1), "/");  // 86400 = 1 day
						setcookie('driver_license', $driver_license, time() + (86400 * 1), "/");  // 86400 = 1 day
					} else if ($is_active == 1 and $is_verified == 0) {
						$message = 'Please check your email to verify this account!<br>If you need some help, please click <a href="#modalService" data-toggle="modal"><strong>here</strong></a>';
					}
				}
			}
		}

		unset($_COOKIE['locked']);
    	setcookie('locked', '', time() - 3600, '/'); // empty value and old timestamp

		$output = array(
			'message' => $message,
			'password' => $isPasswordCorrect,
			'exist' => $exist
		);
		echo json_encode($output);
	}
	if( isset($_POST['btnSignUp']) ) {
		$ID = $_POST['ID'];
		if (empty($ID)) { $ID = 0; }
		
		$client = $_POST['client'];
		$first_name = addslashes($_POST['first_name']);
		$last_name = addslashes($_POST['last_name']);
		$email = $_POST['email'];
		$password = $_POST['password'];
		$password_hash = password_hash($password, PASSWORD_DEFAULT);
		$exist = false;
		$message = 'Email Address is already exist. Please try again!<br>If you need some help, please click <a href="#modalService" data-toggle="modal"><strong>here</strong></a>';

		$selectEmail = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE email = '".$email."'");
		if ( mysqli_num_rows($selectEmail) > 0 ) { $exist = true; }

		if ($exist == false) {
			$sql = "INSERT INTO tbl_user (employee_id, first_name, last_name, email, password, client)
			VALUES ( '$ID', '$first_name', '$last_name', '$email', '$password_hash', '$client')";
			if (mysqli_query($conn, $sql)) {
				// $last_id = mysqli_insert_id($conn);

				// $to = $email;
				// $user = $first_name .' '. $last_name;
				// $subject = 'Welcome to InterlinkIQ.com';
				// $body = 'Hi '. $first_name .', please click <a href="'. $base_url .'login?c=1&i='. $last_id .'">here</a> to confirm your account';
				
				// $mail = php_mailer($to, $user, $subject, $body);
				// $message = 'Registration success. Please check your email for validation.';
				$message = 'Welcome to InterlinkIQ Community! Please log in to your account.';
            }
            // else {
            //     $message = "Error: " . $sql . "<br>" . mysqli_error($conn);
            // }
		}
		$output = array(
			'exist' => $exist,
			'message' => $message
		);
		echo json_encode($output);
	}
	if( isset($_POST['btnReset']) ) {
		$email = $_POST['email'];
		$random = rand(1000,1000000);
		$exist = false;

		$selectEmail = mysqli_query( $conn,'SELECT * FROM tbl_user WHERE is_active = 1 AND email="'. $email .'"' );
		if ( mysqli_num_rows($selectEmail) > 0 ) {
			while($rowUser = mysqli_fetch_array($selectEmail)) {
				$ID = $rowUser['ID'];

				mysqli_query( $conn,"UPDATE tbl_user set verification_code='". $random ."' WHERE ID='". $ID ."'" );

				$to = $rowUser['email'];
				$user = $rowUser['first_name'] .' '. $rowUser['last_name'];
				$subject = 'Reset your password';
				$body = 'Hi '.$user.',<br><br>

				We received a request that you want to update your password. You can do this by selecting the button below. You will be asked to enter your verification code, and then you can update your password.<br><br>

				Your verification code is <b>'.$random.'</b>.<br><br>

				<a href="'. $base_url .'login?p=1&i='. $ID .'" target="_blank" style="font-weight: 600; padding: 10px 20px!important; text-decoration: none; color: #fff; background-color: #27a4b0; border-color: #208992; display: inline-block;">Update Password</a>';

				$mail = php_mailer($to, $user, $subject, $body);

				$message = 'Please check your email to reset your password.';
				$exist = true;
			}
		} else {
			$message = 'Email Address does not exist. Please try again! If you need some help, please click <a href="#modalService" data-toggle="modal"><strong>here</strong></a>';
		}
		$output = array(
			'exist' => $exist,
			'message' => $message
		);
		echo json_encode($output);
	}
	if( isset($_POST['btnResetPassword']) ) {
		$ID = $_POST['ID'];
		$code = $_POST['code'];
		$password = $_POST['npassword'];
		$password_hash = password_hash($password, PASSWORD_DEFAULT);
		$exist = false;
		$message = 'Verification Code is Incorrect. Please try again! If you need some help, please click <a href="#modalService" data-toggle="modal"><strong>here</strong></a>';

		$selectUser = mysqli_query( $conn,'SELECT * FROM tbl_user WHERE verification_code IS NOT NULL AND is_active = 1 AND ID="'. $ID .'"' );
		if ( mysqli_num_rows($selectUser) > 0 ) {
			while($rowUser = mysqli_fetch_array($selectUser)) {
				$verification_code = $rowUser['verification_code'];

				if ($verification_code == $code) {
					mysqli_query( $conn,"UPDATE tbl_user set password='". $password_hash ."' WHERE ID='". $ID ."'" );

					$to = $rowUser['email'];
					$user = $rowUser['first_name'] .' '. $rowUser['last_name'];
					$subject = 'Password Updated!';
					$body = 'Hi '.$user.',<br><br>

					Please login your account using your new password!<br><br>

					<a href="'. $base_url .'login" target="_blank" style="font-weight: 600; padding: 10px 20px!important; text-decoration: none; color: #fff; background-color: #27a4b0; border-color: #208992; display: inline-block;">Login Here</a>';

					$mail = php_mailer($to, $user, $subject, $body);

					$exist = true;
					$message = 'Password Updated! Kindly login with your updated details.';
				}
			}
		}

		$output = array(
			'exist' => $exist,
			'message' => $message
		);
		echo json_encode($output);
	}


	// CANN OS LOGIN SECTION
	if( isset($_POST['btn_SignIn']) ) {
		$client = $_POST['client'];
		$email = $_POST['email'];
		$password = $_POST['password'];
		$password_hash = password_hash($password, PASSWORD_DEFAULT);
		$exist = false;
		$exist_email = false;
		$isPasswordCorrect = false;
		$message = 'Incorrect details. Please try again!';

		$selectEmail = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE client = $client AND is_active = 1 AND email = '". $email ."'" );
		if ( mysqli_num_rows($selectEmail) > 0 ) {
			while($rowUser = mysqli_fetch_array($selectEmail)) {
				$ID = $rowUser['ID'];
				$first_name = $rowUser['first_name'];
				$last_name = $rowUser['last_name'];
				$password_verify = $rowUser['password'];
				$client = $rowUser['client'];
				$is_verified = $rowUser['is_verified'];
				$is_active = $rowUser['is_active'];
				$employee_id = $rowUser['employee_id'];

				$driver_license = '';
				$selectUserInfo = mysqli_query( $conn,"SELECT * FROM tbl_user_info WHERE user_id = $ID" );
				if ( mysqli_num_rows($selectUserInfo) > 0 ) {
					$rowUserInfo = mysqli_fetch_array($selectUserInfo);
					$driver_license = $rowUserInfo['driver_license'];
				}

				$isPasswordCorrect = password_verify($password, $password_verify);
				if ($isPasswordCorrect == true) {
					if ($is_active == 1 and $is_verified == 1) {
						$exist = true;
						$message = "Logged In successfully";

						setcookie('ID', $ID, time() + (86400 * 1), "/");  // 86400 = 1 day
						setcookie('first_name', $first_name, time() + (86400 * 1), "/");  // 86400 = 1 day
						setcookie('last_name', $last_name, time() + (86400 * 1), "/");  // 86400 = 1 day
						setcookie('employee_id', $employee_id, time() + (86400 * 1), "/");  // 86400 = 1 day
						setcookie('client', $client, time() + (86400 * 1), "/");  // 86400 = 1 day
						setcookie('driver_license', $driver_license, time() + (86400 * 1), "/");  // 86400 = 1 day
					} else if ($is_active == 1 and $is_verified == 0) {
						$message = 'Please check your email to verify this account!<br>If you need some help, please click <a href="#modalService" data-toggle="modal"><strong>here</strong></a>';
					}
				}
			}
		}

		unset($_COOKIE['locked']);
    	setcookie('locked', '', time() - 3600, '/'); // empty value and old timestamp

		$output = array(
			'message' => $message,
			'password' => $isPasswordCorrect,
			'exist' => $exist
		);
		echo json_encode($output);
	}
	if( isset($_POST['btn_SignUp']) ) {
		$ID = $_POST['ID'];
		if (empty($ID)) { $ID = 0; }
		
		$client = $_POST['client'];
		$first_name = addslashes($_POST['first_name']);
		$last_name = addslashes($_POST['last_name']);
		$email = $_POST['email'];
		$password = $_POST['password'];
		$password_hash = password_hash($password, PASSWORD_DEFAULT);
		$exist = false;
		$message = 'Email Address is already exist. Please try again!';

		$selectEmail = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE email = '".$email."'");
		if ( mysqli_num_rows($selectEmail) > 0 ) { $exist = true; }

		if ($exist == false) {
			$sql = "INSERT INTO tbl_user (employee_id, first_name, last_name, email, password, client)
			VALUES ( '$ID', '$first_name', '$last_name', '$email', '$password_hash', '$client')";
			if (mysqli_query($conn, $sql)) {
				// $last_id = mysqli_insert_id($conn);

				// $to = $email;
				// $user = $first_name .' '. $last_name;
				// $subject = 'Welcome to InterlinkIQ.com';
				// $body = 'Hi '. $first_name .', please click <a href="'. $base_url .'login?c=1&i='. $last_id .'">here</a> to confirm your account';
				
				// $mail = php_mailer($to, $user, $subject, $body);
				// $message = 'Registration success. Please check your email for validation.';
				$message = 'Welcome to our Community! Please logged in to your account.';
			}
		}
		$output = array(
			'exist' => $exist,
			'message' => $message
		);
		echo json_encode($output);
	}
	if( isset($_POST['btn_Fotgot']) ) {
		$email = $_POST['email'];
		$random = rand(1000,1000000);
		$exist = false;

		$selectEmail = mysqli_query( $conn,'SELECT * FROM tbl_user WHERE is_active = 1 AND email="'. $email .'"' );
		if ( mysqli_num_rows($selectEmail) > 0 ) {
			while($rowUser = mysqli_fetch_array($selectEmail)) {
				$ID = $rowUser['ID'];

				mysqli_query( $conn,"UPDATE tbl_user set verification_code='". $random ."' WHERE ID='". $ID ."'" );

				$to = $rowUser['email'];
				$user = $rowUser['first_name'] .' '. $rowUser['last_name'];
				$subject = 'Reset your password';
				$body = 'Hi '.$user.',<br><br>

				We received a request that you want to update your password. You can do this by selecting the button below. You will be asked to enter your verification code, and then you can update your password.<br><br>

				Your verification code is <b>'.$random.'</b>.<br><br>

				<a href="'. $base_url .'CannOS-Login?p=1&i='. $ID .'" target="_blank" style="font-weight: 600; padding: 10px 20px!important; text-decoration: none; color: #fff; background-color: #27a4b0; border-color: #208992; display: inline-block;">Update Password</a><br><br>

                Cann OS Team';

				php_mailer($to, $user, $subject, $body);

				$message = 'Please check your email to reset your password.';
				$exist = true;
			}
		} else {
			$message = 'Email Address does not exist. Please try again!';
		}
		$output = array(
			'exist' => $exist,
			'message' => $message
		);
		echo json_encode($output);
	}
	if( isset($_POST['btn_FotgotPassword']) ) {
		$ID = $_POST['ID'];
		$code = $_POST['code'];
		$password = $_POST['npassword'];
		$password_hash = password_hash($password, PASSWORD_DEFAULT);
		$exist = false;
		$message = 'Verification Code is Incorrect. Please try again!';

		$selectUser = mysqli_query( $conn,'SELECT * FROM tbl_user WHERE is_active = 1 AND ID="'. $ID .'"' );
		if ( mysqli_num_rows($selectUser) > 0 ) {
			while($rowUser = mysqli_fetch_array($selectUser)) {
				$verification_code = $rowUser['verification_code'];

				if ($verification_code == $code) {
					mysqli_query( $conn,"UPDATE tbl_user set password='". $password_hash ."' WHERE ID='". $ID ."'" );

					$to = $rowUser['email'];
					$user = $rowUser['first_name'] .' '. $rowUser['last_name'];
					$subject = 'Password Updated!';
					$body = 'Hi '.$user.',<br><br>

					Please login your account using your new password!<br><br>

					<a href="'.  $base_url .'CannOS-Login" target="_blank" style="font-weight: 600; padding: 10px 20px!important; text-decoration: none; color: #fff; background-color: #27a4b0; border-color: #208992; display: inline-block;">Login Here</a>';

					php_mailer($to, $user, $subject, $body);

					$exist = true;
					$message = 'Password Updated!';
				}
			}
		}

		$output = array(
			'exist' => $exist,
			'message' => $message
		);
		echo json_encode($output);
	}
	if( isset($_POST['btn_UpdatePassword']) ) {
		$ID = $_POST['ID'];
		$password = $_POST['npassword'];
		$password_hash = password_hash($password, PASSWORD_DEFAULT);
		$last_modified = date('Y-m-d');
		$exist = false;
		$message = 'Invalid Account!';

		$selectUser = mysqli_query( $conn,'SELECT * FROM tbl_user WHERE is_active = 0 AND ID="'. $ID .'"' );
		if ( mysqli_num_rows($selectUser) > 0 ) {
			while($rowUser = mysqli_fetch_array($selectUser)) {

				mysqli_query( $conn,"UPDATE tbl_user set password='". $password_hash ."', last_modified='". $last_modified ."' WHERE ID='". $ID ."'" );

				$to = $rowUser['email'];
				$user = $rowUser['first_name'] .' '. $rowUser['last_name'];
				$subject = 'Password Updated!';
				$body = 'Hi '.$user.',<br><br>

				Thank you for updating your password! You may now use your account again.<br><br>

				<a href="https:'.  $base_url .'CannOS-Login" target="_blank" style="font-weight: 600; padding: 10px 20px!important; text-decoration: none; color: #fff; background-color: #27a4b0; border-color: #208992; display: inline-block;">Login Here</a>';

				php_mailer($to, $user, $subject, $body);

				$exist = true;
				$message = 'Account Retrieved!';
			}
		}

		$output = array(
			'exist' => $exist,
			'message' => $message
		);
		echo json_encode($output);
	}


    // FOOD SAFETY 360
    if( isset($_POST['btnSignIn_FS360']) ) {
        $client = $_POST['client'];
        $email = $_POST['email'];
        $password = $_POST['password'];
        $password_hash = password_hash($password, PASSWORD_DEFAULT);
        $exist = false;
        $exist_email = false;
        $exist_username = false;
        $isPasswordCorrect = false;
        $message = 'Incorrect details. Please try again!<br>If you need some help, please click <a href="#modalService" data-toggle="modal"><strong>here</strong></a>';

        $selectEmail = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE client = $client AND is_active = 1 AND email = '". $email ."'" );
        if ( mysqli_num_rows($selectEmail) > 0 ) {
            while($rowUser = mysqli_fetch_array($selectEmail)) {
                $ID = $rowUser['ID'];
                $first_name = $rowUser['first_name'];
                $last_name = $rowUser['last_name'];
                $password_verify = $rowUser['password'];
                $client = $rowUser['client'];
                $is_verified = $rowUser['is_verified'];
                $is_active = $rowUser['is_active'];
                $employee_id = $rowUser['employee_id'];

                $driver_license = '';
                $selectUserInfo = mysqli_query( $conn,"SELECT * FROM tbl_user_info WHERE user_id = $ID" );
                if ( mysqli_num_rows($selectUserInfo) > 0 ) {
                    $rowUserInfo = mysqli_fetch_array($selectUserInfo);
                    $driver_license = $rowUserInfo['driver_license'];
                }

                $isPasswordCorrect = password_verify($password, $password_verify);
                if ($isPasswordCorrect == true) {
                    if ($is_active == 1 and $is_verified == 1) {
                        $exist = true;
                        $message = "Log In successfully";

                        setcookie('ID', $ID, time() + (86400 * 1), "/");  // 86400 = 1 day
                        setcookie('first_name', $first_name, time() + (86400 * 1), "/");  // 86400 = 1 day
                        setcookie('last_name', $last_name, time() + (86400 * 1), "/");  // 86400 = 1 day
                        setcookie('employee_id', $employee_id, time() + (86400 * 1), "/");  // 86400 = 1 day
                        setcookie('client', $client, time() + (86400 * 1), "/");  // 86400 = 1 day
                        setcookie('driver_license', $driver_license, time() + (86400 * 1), "/");  // 86400 = 1 day
                    } else if ($is_active == 1 and $is_verified == 0) {
                        $message = 'Please check your email to verify this account!<br>If you need some help, please click <a href="#modalService" data-toggle="modal"><strong>here</strong></a>';
                    }
                }
            }
        }

        unset($_COOKIE['locked']);
        setcookie('locked', '', time() - 3600, '/'); // empty value and old timestamp

        $output = array(
            'message' => $message,
            'password' => $isPasswordCorrect,
            'exist' => $exist
        );
        echo json_encode($output);
    }
    if( isset($_POST['btnSignUp_FS360']) ) {
        $ID = $_POST['ID'];
        if (empty($ID)) { $ID = 0; }
        
        $client = $_POST['client'];
        $first_name = addslashes($_POST['first_name']);
        $last_name = addslashes($_POST['last_name']);
        $email = $_POST['email'];
        $password = $_POST['password'];
        $password_hash = password_hash($password, PASSWORD_DEFAULT);
        $exist = false;
        $message = 'Email Address is already exist. Please try again!<br>If you need some help, please click <a href="#modalService" data-toggle="modal"><strong>here</strong></a>';

        $selectEmail = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE email = '".$email."'");
        if ( mysqli_num_rows($selectEmail) > 0 ) { $exist = true; }

        if ($exist == false) {
            $sql = "INSERT INTO tbl_user (employee_id, first_name, last_name, email, password, client)
            VALUES ( '$ID', '$first_name', '$last_name', '$email', '$password_hash', '$client')";
            if (mysqli_query($conn, $sql)) {
                // $last_id = mysqli_insert_id($conn);

                // $to = $email;
                // $user = $first_name .' '. $last_name;
                // $subject = 'Welcome to InterlinkIQ.com';
                // $body = 'Hi '. $first_name .', please click <a href="'. $base_url .'login?c=1&i='. $last_id .'">here</a> to confirm your account';
                
                // $mail = php_mailer($to, $user, $subject, $body);
                // $message = 'Registration success. Please check your email for validation.';
                $message = 'Welcome to InterlinkIQ Community! Please log in to your account.';
            }
            // else {
            //     $message = "Error: " . $sql . "<br>" . mysqli_error($conn);
            // }
        }
        $output = array(
            'exist' => $exist,
            'message' => $message
        );
        echo json_encode($output);
    }
    if( isset($_POST['btnReset_FS360']) ) {
        $email = $_POST['email'];
        $random = rand(1000,1000000);
        $exist = false;

        $selectEmail = mysqli_query( $conn,'SELECT * FROM tbl_user WHERE is_active = 1 AND email="'. $email .'"' );
        if ( mysqli_num_rows($selectEmail) > 0 ) {
            while($rowUser = mysqli_fetch_array($selectEmail)) {
                $ID = $rowUser['ID'];

                mysqli_query( $conn,"UPDATE tbl_user set verification_code='". $random ."' WHERE ID='". $ID ."'" );

                $to = $rowUser['email'];
                $user = $rowUser['first_name'] .' '. $rowUser['last_name'];
                $subject = 'Reset your password';
                $body = 'Hi '.$user.',<br><br>

                We received a request that you want to update your password. You can do this by selecting the button below. You will be asked to enter your verification code, and then you can update your password.<br><br>

                Your verification code is <b>'.$random.'</b>.<br><br>

                <a href="'. $base_url .'FoodSafety360?p=1&i='. $ID .'" target="_blank" style="font-weight: 600; padding: 10px 20px!important; text-decoration: none; color: #fff; background-color: #27a4b0; border-color: #208992; display: inline-block;">Update Password</a>';

                $mail = php_mailer($to, $user, $subject, $body);

                $message = 'Please check your email to reset your password.';
                $exist = true;
            }
        } else {
            $message = 'Email Address does not exist. Please try again! If you need some help, please click <a href="#modalService" data-toggle="modal"><strong>here</strong></a>';
        }
        $output = array(
            'exist' => $exist,
            'message' => $message
        );
        echo json_encode($output);
    }
    if( isset($_POST['btnResetPassword_FS360']) ) {
        $ID = $_POST['ID'];
        $code = $_POST['code'];
        $password = $_POST['npassword'];
        $password_hash = password_hash($password, PASSWORD_DEFAULT);
        $exist = false;
        $message = 'Verification Code is Incorrect. Please try again! If you need some help, please click <a href="#modalService" data-toggle="modal"><strong>here</strong></a>';

        $selectUser = mysqli_query( $conn,'SELECT * FROM tbl_user WHERE verification_code IS NOT NULL AND is_active = 1 AND ID="'. $ID .'"' );
        if ( mysqli_num_rows($selectUser) > 0 ) {
            while($rowUser = mysqli_fetch_array($selectUser)) {
                $verification_code = $rowUser['verification_code'];

                if ($verification_code == $code) {
                    mysqli_query( $conn,"UPDATE tbl_user set password='". $password_hash ."' WHERE ID='". $ID ."'" );

                    $to = $rowUser['email'];
                    $user = $rowUser['first_name'] .' '. $rowUser['last_name'];
                    $subject = 'Password Updated!';
                    $body = 'Hi '.$user.',<br><br>

                    Please login your account using your new password!<br><br>

                    <a href="'. $base_url .'FoodSafety360" target="_blank" style="font-weight: 600; padding: 10px 20px!important; text-decoration: none; color: #fff; background-color: #27a4b0; border-color: #208992; display: inline-block;">Login Here</a>';

                    $mail = php_mailer($to, $user, $subject, $body);

                    $exist = true;
                    $message = 'Password Updated! Kindly login with your updated details.';
                }
            }
        }

        $output = array(
            'exist' => $exist,
            'message' => $message
        );
        echo json_encode($output);
    }


	// COLLABORATION
	if( isset($_POST['btnSave_Collab']) ) {
		$ID = $_POST['ID'];
		$site = $_POST['site'];
		$assigned_to_id = '';
		$msg = 'No one selected!';

		if (!empty($_POST['assigned_to_id'])) {
			$assigned_to_id = array();
			for($i=0; $i<count($_POST['assigned_to_id']); $i++){
				array_push($assigned_to_id, $_POST['assigned_to_id'][$i]);
			}
			$assigned_to_id_final = array(
				$ID => array (
					"assigned_to_id" => $assigned_to_id
				)
			);

			$msg = "new data";
			$selectMenu = mysqli_query( $conn,'SELECT * FROM tbl_menu WHERE name="'. $site .'"' );
			if ( mysqli_num_rows($selectMenu) > 0 ) {
				$rowMenu = mysqli_fetch_array($selectMenu);
				$data_assigned_to_id = $rowMenu['assigned_to_id'];

				if (!empty($data_assigned_to_id)) {
					$output = json_decode($data_assigned_to_id, true);
					$exist = 0;
					foreach ($output as $key => $value) {
						if ($ID == $key) {

							$exist++;
							$output[$key]['assigned_to_id'] = $assigned_to_id;
							break;
						}
					}

					if ($exist > 0) {
						$msg = "update new data";
						$result = json_encode($output);
					} else {
						$msg = "append new data";
						$result = $output + $assigned_to_id_final;
						$result = json_encode($result);
					}
				} else {
					$msg = "save new data";
					$result = json_encode($assigned_to_id_final);
				}

				mysqli_query( $conn,"UPDATE tbl_menu set assigned_to_id='". $result ."' WHERE name='". $site ."'" );
			}
		} else {
			$selectMenu = mysqli_query( $conn,'SELECT * FROM tbl_menu WHERE name="'. $site .'"' );
			if ( mysqli_num_rows($selectMenu) > 0 ) {
				$rowMenu = mysqli_fetch_array($selectMenu);
				$data_assigned_to_id = $rowMenu['assigned_to_id'];

				if (!empty($data_assigned_to_id)) {
					$output = json_decode($data_assigned_to_id, true);
					$exist = 0;
					foreach ($output as $key => $value) {
						if ($ID == $key) {

							$exist++;
							// $output[$key]['assigned_to_id'] = $assigned_to_id;
							$msg = "update new data";
							unset($output[$key]);
							$result = json_encode($output);

							mysqli_query( $conn,"UPDATE tbl_menu set assigned_to_id='". $result ."' WHERE name='". $site ."'" );
							break;
						}
					}
				}
			}
		}

		$output = array(
			"ID" => $ID,
			"site" => $site,
			"assigned_to_id" => $assigned_to_id,
			"msg" => $msg
		);

		echo json_encode($output);
	}
	if( isset($_POST['btnSave_Collaborator']) ) {
		$ID = $_POST['ID'];
		$itemCollab = $_POST['itemCollab'];
		$assigned_to_id = '';
		$msg = 'No one selected!';

		if (!empty($_POST['assigned_to_id'])) {
			$assigned_to_id = array();
			for($i=0; $i<count($_POST['assigned_to_id']); $i++){
				array_push($assigned_to_id, $_POST['assigned_to_id'][$i]);
			}
			$assigned_to_id_final = array(
				$ID => array (
					"assigned_to_id" => $assigned_to_id
				)
			);

			$msg = "new data";
			$selectLibrary = mysqli_query( $conn,'SELECT * FROM tbl_library WHERE ID="'. $itemCollab .'"' );
			if ( mysqli_num_rows($selectLibrary) > 0 ) {
				$rowLibrary = mysqli_fetch_array($selectLibrary);
				$data_assigned_to_id = $rowLibrary['collaborator_id'];

				if (!empty($data_assigned_to_id)) {
					$output = json_decode($data_assigned_to_id, true);
					$exist = 0;
					foreach ($output as $key => $value) {
						if ($ID == $key) {

							$exist++;
							$output[$key]['assigned_to_id'] = $assigned_to_id;
							break;
						}
					}

					if ($exist > 0) {
						$msg = "update new data";
						$result = json_encode($output);
					} else {
						$msg = "append new data";
						$result = $output + $assigned_to_id_final;
						$result = json_encode($result);
					}
				} else {
					$msg = "save new data";
					$result = json_encode($assigned_to_id_final);
				}

				mysqli_query( $conn,"UPDATE tbl_library set collaborator_id='". $result ."' WHERE ID='". $itemCollab ."'" );
			}
		} else {
			$selectLibrary = mysqli_query( $conn,'SELECT * FROM tbl_library WHERE ID="'. $itemCollab .'"' );
			if ( mysqli_num_rows($selectLibrary) > 0 ) {
				$rowLibrary = mysqli_fetch_array($selectLibrary);
				$data_assigned_to_id = $rowLibrary['collaborator_id'];

				if (!empty($data_assigned_to_id)) {
					$output = json_decode($data_assigned_to_id, true);
					$exist = 0;
					foreach ($output as $key => $value) {
						if ($ID == $key) {

							$exist++;
							// $output[$key]['assigned_to_id'] = $assigned_to_id;
							$msg = "update new data";
							unset($output[$key]);
							$result = json_encode($output);

							mysqli_query( $conn,"UPDATE tbl_library set collaborator_id='". $result ."' WHERE ID='". $itemCollab ."'" );
							break;
						}
					}
				}
			}
		}

		$output = array(
			"ID" => $ID,
			"itemCollab" => $itemCollab,
			"assigned_to_id" => $assigned_to_id,
			"msg" => $msg
		);

		echo json_encode($output);
	}
	if( isset($_GET['modalCollaborator']) ) {
		$id = $_GET['modalCollaborator'];
		// $user_id = $_COOKIE['ID'];
		// $current_userEmployerID = employerID($user_id);

        if (!empty($_COOKIE['switchAccount'])) {
			$portal_user = $_COOKIE['ID'];
			$user_id = $_COOKIE['switchAccount'];
		}
		else {
			$portal_user = $_COOKIE['ID'];
			$user_id = employerID($portal_user);
		}

		echo '<input class="form-control" type="hidden" name="ID" value="'.$user_id.'" />
        <input class="form-control" type="hidden" name="itemCollab" value="'.$id.'" />
        <div class="form-group">
	        <label class="col-md-3 control-label">Select Users</label>
	        <div class="col-md-8">
	            <select class="form-control mt-multiselect btn btn-default" name="assigned_to_id[]" multiple="multiple">';

	                $selectEmployee = mysqli_query( $conn,"SELECT * FROM tbl_hr_employee WHERE status = 1 AND user_id=$user_id" );
	                if ( mysqli_num_rows($selectEmployee) > 0 ) {
	                    while($rowEmployee = mysqli_fetch_array($selectEmployee)) {
	                        $rowEmployeeID = $rowEmployee["ID"];
	                        $rowEmployeeFName = $rowEmployee["first_name"];
	                        $rowEmployeeLName = $rowEmployee["last_name"];
	                        $rowEmployeeSelected = "";

	                        // Base on Current Page
	                        $selectLibrary = mysqli_query( $conn,"SELECT * FROM tbl_library WHERE ID=$id" );
	                        if ( mysqli_num_rows($selectLibrary) > 0 ) {
	                            $rowLibrary = mysqli_fetch_array($selectLibrary);
	                            $collaborator_id = $rowLibrary['collaborator_id'];

	                            if (!empty($collaborator_id)) {
	                                $output = json_decode($collaborator_id, true);
	                                $exist = 0;
	                                foreach ($output as $key => $value) {
	                                    if ($user_id == $key) {
	                                        if (in_array($rowEmployeeID, $value['assigned_to_id'])) {
	                                            $exist++;
	                                            break;
	                                        }
	                                    }
	                                }

	                                if ($exist > 0) { $rowEmployeeSelected = "SELECTED"; }
	                            }
	                        }

	                        echo '<option value="'. $rowEmployeeID .'" '. $rowEmployeeSelected .'>'. $rowEmployeeFName .' '. $rowEmployeeLName .'</option>';
	                    }

	                }

                    if (!empty($_COOKIE['switchAccount']) AND $_COOKIE['client'] == 0) {
                    	$selectEmployeeSwitch = mysqli_query( $conn,"SELECT * FROM tbl_hr_employee WHERE status = 1 AND (ID = 90 OR ID = 91 OR ID = 75 OR ID = 76 OR ID = 79 OR ID = 71 OR ID = 81 OR ID = 68 OR ID = 69 OR ID = 84 OR ID = 129 OR ID = 74 OR ID = 209)" );
		                if ( mysqli_num_rows($selectEmployeeSwitch) > 0 ) {
		                    while($rowEmployeeSwitch = mysqli_fetch_array($selectEmployeeSwitch)) {
		                        $rowEmployeeIDSwitch = $rowEmployeeSwitch["ID"];
		                        $rowEmployeeFNameSwitch = $rowEmployeeSwitch["first_name"];
		                        $rowEmployeeLNameSwitch = $rowEmployeeSwitch["last_name"];
		                        $rowEmployeeSelectedSwitch = "";

		                        // Base on Current Page
		                        $selectLibrary = mysqli_query( $conn,"SELECT * FROM tbl_library WHERE ID=$id" );
		                        if ( mysqli_num_rows($selectLibrary) > 0 ) {
		                            $rowLibrary = mysqli_fetch_array($selectLibrary);
		                            $collaborator_id = $rowLibrary['collaborator_id'];

		                            if (!empty($collaborator_id)) {
		                                $output = json_decode($collaborator_id, true);
		                                $exist = 0;
		                                foreach ($output as $key => $value) {
		                                    if ($user_id == $key) {
		                                        if (in_array($rowEmployeeIDSwitch, $value['assigned_to_id'])) {
		                                            $exist++;
		                                            break;
		                                        }
		                                    }
		                                }

		                                if ($exist > 0) { $rowEmployeeSelectedSwitch = "SELECTED"; }
		                            }
		                        }
                        		echo '<option value="'. $rowEmployeeIDSwitch .'" '. $rowEmployeeSelectedSwitch .'>'. $rowEmployeeFNameSwitch .' '. $rowEmployeeLNameSwitch .'</option>';
		                    }
		                }
                    }

	            echo '</select>
	        </div>
	    </div>';

        mysqli_close($conn);
	}


	// SWITCH ACCOUNT
	function switchAccount($id) {
		global $conn;
		$enterp_userID = '';

		$selectSupplier = mysqli_query( $conn,"SELECT * FROM tbl_supplier WHERE ID=$id" );
        if ( mysqli_num_rows($selectSupplier) > 0 ) {
            $rowSupplier = mysqli_fetch_array($selectSupplier);
            $sup_email = $rowSupplier['email'];

            $selectEnterprise = mysqli_query( $conn,"SELECT * from tblEnterpiseDetails WHERE businessemailAddress = '".$sup_email."'" );
            if ( mysqli_num_rows($selectEnterprise) > 0 ) {
                $rowEnterprise = mysqli_fetch_array($selectEnterprise);
                $enterp_userID = $rowEnterprise['users_entities'];
            }
        }

        return $enterp_userID;
	}
	if( isset($_GET['modalSwitch']) ) {
		$id = $_GET['modalSwitch'];
		$current_userID = $_COOKIE['ID'];
        $current_userEmployeeID = employeeID($current_userID);
        $current_userEmployerID = employerID($current_userID);

        if ($current_userEmployerID == $id) {
			unset($_COOKIE['switchAccount']);
	    	setcookie('switchAccount', '', time() - 3600, '/'); // empty value and old timestamp
        } else {
            // Check if the user allowed to switch into that account
            $selectEnterprise = mysqli_query( $conn,"SELECT * from tblEnterpiseDetails WHERE users_entities = $id" );
            if ( mysqli_num_rows($selectEnterprise) > 0 ) {
                $rowEnterprise = mysqli_fetch_array($selectEnterprise);
                $enterp_id = $rowEnterprise['enterp_id'];
                $enterp_logo = $rowEnterprise['BrandLogos'];
                $enterp_name = $rowEnterprise['businessname'];
                $enterp_userID = $rowEnterprise['users_entities'];
                $enterp_email = $rowEnterprise['businessemailAddress'];
                
                $selectSupplier = mysqli_query( $conn,"SELECT * from tbl_supplier WHERE page = 2 AND is_deleted = 0 AND status = 1 AND email = '".$enterp_email."'" );
                if ( mysqli_num_rows($selectSupplier) > 0 ) {
                    while($rowSupplier = mysqli_fetch_array($selectSupplier)) {
                        $employee_id = $rowSupplier["employee_id"];
        
                        if (!empty($employee_id)) {
                            $employee_id_arr = explode(", ", $employee_id);
                            if (in_array($current_userEmployeeID, $employee_id_arr)) {
                                setcookie('switchAccount', $id, time() + (86400 * 1), "/");  // 86400 = 1 day
                            }
                        }
                    }
                }
            }
        }
	}


	// SIDEBAR SETTING
	if( isset($_GET['modalView_Sidebar']) ) {
		$id = $_GET['modalView_Sidebar'];

        $portal_user = $_COOKIE['ID'];
        $user_id = employerID($portal_user);

    	$current_dateNow_o = date('Y/m/d');
        $current_dateNow = new DateTime($current_dateNow_o);
        $current_dateNow = $current_dateNow->format('M d, Y');

		echo '<input class="form-control" type="hidden" name="ID" value="'.$id.'" />
        <div class="tabbable tabbable-tabdrop">
            <ul class="nav nav-tabs">
                <li class="active">
                    <a href="#tabTrial" data-toggle="tab">Trial</a>
                </li>
                <li>
                    <a href="#tabPaid" data-toggle="tab">Paid</a>
                </li>
                <li>
                    <a class="hide" href="#tabExclusive" data-toggle="tab">Exclusive</a>
                </li>
            </ul>
            <div class="tab-content margin-top-20">
                <div class="tab-pane active" id="tabTrial">
                	<a href="#modalNew" class="btn btn-success btn-circle pull-right margin-bottom-15" data-toggle="modal" onclick="btnNew('.$id.', 1)">Add New Account</a>
                    <table class="table table-bordered table-hover tableDataModal" id="tableData_1">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th class="text-center" style="width: 135px;">Start Date</th>
                                <th class="text-center" style="width: 135px;">End Date</th>
                                <th class="text-center" style="width: 135px;">Status</th>
                                <th class="text-center" style="width: 135px;">Action</th>
                            </tr>
                        </thead>
                        <tbody>';

                            $selectMenuSubs = mysqli_query( $conn,"SELECT * FROM tbl_menu_subscription WHERE deleted = 0 AND type = 1 AND menu_id = $id AND switch_id = $user_id ORDER BY date_end DESC" );
		                    if ( mysqli_num_rows($selectMenuSubs) > 0 ) {
		                        while($rowMenuSub = mysqli_fetch_array($selectMenuSubs)) {
		                            $sub_ID = $rowMenuSub["ID"];
		                            $sub_user_id = $rowMenuSub["user_id"];

		                            $sub_date_start = $rowMenuSub["date_start"];
						            $sub_date_start = new DateTime($sub_date_start);
						            $sub_date_start_o = $sub_date_start->format('Y/m/d');
						            $sub_date_start = $sub_date_start->format('M d, Y');

		                            $sub_date_end = $rowMenuSub["date_end"];
						            $sub_date_end = new DateTime($sub_date_end);
						            $sub_date_end_o = $sub_date_end->format('Y/m/d');
						            $sub_date_end = $sub_date_end->format('M d, Y');

		                            $selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE is_verified = 1 AND is_active = 1 AND ID = $sub_user_id" );
				                    if ( mysqli_num_rows($selectUser) > 0 ) {
				                        while($rowUser = mysqli_fetch_array($selectUser)) {
				                            $rowUser_ID = $rowUser["ID"];
				                            $rowUser_name = $rowUser["first_name"] .' '. $rowUser["last_name"];

				                            echo '<tr class="tr_'.$sub_ID.'">
				                        		<td>'.$rowUser_name.'</td>
				                        		<td class="text-center">'.$sub_date_start.'</td>
				                        		<td class="text-center">'.$sub_date_end.'</td>
				                        		<td class="text-center">'; 

				                        			if ($sub_date_start_o <= $current_dateNow_o && $sub_date_end_o >= $current_dateNow_o) { echo '<span class="label label-sm label-success btn-circle">Running</span>'; }
				                        			else if ($sub_date_start_o > $current_dateNow_o && $sub_date_end_o > $current_dateNow_o) { echo '<span class="label label-sm label-warning btn-circle">Not Yet Started</span>'; }
				                        			else if ($sub_date_start_o < $current_dateNow_o && $sub_date_end_o < $current_dateNow_o) { echo '<span class="label label-sm label-danger btn-circle">Expired</span>'; }
				                        		
				                        		echo '</td>
												<td class="text-center">
				                                    <div class="btn-group btn-group-circle">
				                                        <a href="#modalEdit" class="btn btn-outline dark btn-sm" data-toggle="modal" onclick="btnEdit('.$sub_ID.', 1)">Edit</a>
				                                        <a href="javascript:;" class="btn btn-danger btn-sm" onclick="btnDeleteAccount('.$sub_ID.', 1)">Delete</a>
				                                    </div>
				                                </td>
				                        	</tr>';
				                        }
				                    }
		                        }
		                    }

                        echo '</tbody>
                    </table>
                </div>
                <div class="tab-pane" id="tabPaid">
                	<a href="#modalNew" class="btn btn-success btn-circle pull-right margin-bottom-15" data-toggle="modal" onclick="btnNew('.$id.', 2)">Add New Account</a>
                    <table class="table table-bordered table-hover tableDataModal" id="tableData_2">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th class="text-center" style="width: 135px;">Start Date</th>
                                <th class="text-center" style="width: 135px;">End Date</th>
                                <th class="text-center" style="width: 135px;">Status</th>
                                <th class="text-center" style="width: 135px;">Action</th>
                            </tr>
                        </thead>
                        <tbody>';

                        	$selectMenuSubs = mysqli_query( $conn,"SELECT * FROM tbl_menu_subscription WHERE deleted = 0 AND type = 2 AND menu_id = $id AND switch_id = $user_id ORDER BY date_end DESC" );
		                    if ( mysqli_num_rows($selectMenuSubs) > 0 ) {
		                        while($rowMenuSub = mysqli_fetch_array($selectMenuSubs)) {
		                            $sub_ID = $rowMenuSub["ID"];
		                            $sub_user_id = $rowMenuSub["user_id"];

		                            $sub_date_start = $rowMenuSub["date_start"];
						            $sub_date_start = new DateTime($sub_date_start);
						            $sub_date_start_o = $sub_date_start->format('Y/m/d');
						            $sub_date_start = $sub_date_start->format('M d, Y');

		                            $sub_date_end = $rowMenuSub["date_end"];
						            $sub_date_end = new DateTime($sub_date_end);
						            $sub_date_end_o = $sub_date_end->format('Y/m/d');
						            $sub_date_end = $sub_date_end->format('M d, Y');

		                            $selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE is_verified = 1 AND is_active = 1 AND ID = $sub_user_id" );
				                    if ( mysqli_num_rows($selectUser) > 0 ) {
				                        while($rowUser = mysqli_fetch_array($selectUser)) {
				                            $rowUser_ID = $rowUser["ID"];
				                            $rowUser_name = $rowUser["first_name"] .' '. $rowUser["last_name"];

				                            echo '<tr class="tr_'.$sub_ID.'">
				                        		<td>'.$rowUser_name.'</td>
				                        		<td class="text-center">'.$sub_date_start.'</td>
				                        		<td class="text-center">'.$sub_date_end.'</td>
				                        		<td class="text-center">'; 

				                        			if ($sub_date_start_o <= $current_dateNow_o && $sub_date_end_o >= $current_dateNow_o) { echo '<span class="label label-sm label-success btn-circle">Running</span>'; }
				                        			else if ($sub_date_start_o > $current_dateNow_o && $sub_date_end_o > $current_dateNow_o) { echo '<span class="label label-sm label-warning btn-circle">Not Yet Started</span>'; }
				                        			else if ($sub_date_start_o < $current_dateNow_o && $sub_date_end_o < $current_dateNow_o) { echo '<span class="label label-sm label-danger btn-circle">Expired</span>'; }
				                        		
				                        		echo '</td>
												<td class="text-center">
				                                    <div class="btn-group btn-group-circle">
				                                        <a href="#modalEdit" class="btn btn-outline dark btn-sm" data-toggle="modal" onclick="btnEdit('.$sub_ID.', 2)">Edit</a>
				                                        <a href="javascript:;" class="btn btn-danger btn-sm" onclick="btnDeleteAccount('.$sub_ID.', 2)">Delete</a>
				                                    </div>
				                                </td>
				                        	</tr>';
				                        }
				                    }
		                        }
		                    }

                        echo '</tbody>
                    </table>
                </div>
                <div class="tab-pane" id="tabExclusive">
                	<a href="#modalNew" class="btn btn-success btn-circle pull-right margin-bottom-15" data-toggle="modal" onclick="btnNew('.$id.', 3)">Add New Account</a>
                    <table class="table table-bordered table-hover tableDataModal" id="tableData_2">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th class="text-center" style="width: 135px;">Start Date</th>
                                <th class="text-center" style="width: 135px;">End Date</th>
                                <th class="text-center" style="width: 135px;">Status</th>
                                <th class="text-center" style="width: 135px;">Action</th>
                            </tr>
                        </thead>
                        <tbody>';

                        	$selectMenuSubs = mysqli_query( $conn,"SELECT * FROM tbl_menu_subscription WHERE deleted = 0 AND type = 3 AND menu_id = $id ORDER BY date_end DESC" );
		                    if ( mysqli_num_rows($selectMenuSubs) > 0 ) {
		                        while($rowMenuSub = mysqli_fetch_array($selectMenuSubs)) {
		                            $sub_ID = $rowMenuSub["ID"];
		                            $sub_user_id = $rowMenuSub["user_id"];

		                            $sub_date_start = $rowMenuSub["date_start"];
						            $sub_date_start = new DateTime($sub_date_start);
						            $sub_date_start_o = $sub_date_start->format('Y/m/d');
						            $sub_date_start = $sub_date_start->format('M d, Y');

		                            $sub_date_end = $rowMenuSub["date_end"];
						            $sub_date_end = new DateTime($sub_date_end);
						            $sub_date_end_o = $sub_date_end->format('Y/m/d');
						            $sub_date_end = $sub_date_end->format('M d, Y');

		                            $selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE is_verified = 1 AND is_active = 1 AND ID = $sub_user_id" );
				                    if ( mysqli_num_rows($selectUser) > 0 ) {
				                        while($rowUser = mysqli_fetch_array($selectUser)) {
				                            $rowUser_ID = $rowUser["ID"];
				                            $rowUser_name = $rowUser["first_name"] .' '. $rowUser["last_name"];

				                            echo '<tr class="tr_'.$sub_ID.'">
				                        		<td>'.$rowUser_name.'</td>
				                        		<td class="text-center">'.$sub_date_start.'</td>
				                        		<td class="text-center">'.$sub_date_end.'</td>
				                        		<td class="text-center">'; 

				                        			if ($sub_date_start_o <= $current_dateNow_o && $sub_date_end_o >= $current_dateNow_o) { echo '<span class="label label-sm label-success btn-circle">Running</span>'; }
				                        			else if ($sub_date_start_o > $current_dateNow_o && $sub_date_end_o > $current_dateNow_o) { echo '<span class="label label-sm label-warning btn-circle">Not Yet Started</span>'; }
				                        			else if ($sub_date_start_o < $current_dateNow_o && $sub_date_end_o < $current_dateNow_o) { echo '<span class="label label-sm label-danger btn-circle">Expired</span>'; }
				                        		
				                        		echo '</td>
												<td class="text-center">
				                                    <div class="btn-group btn-group-circle">
				                                        <a href="#modalEdit" class="btn btn-outline dark btn-sm" data-toggle="modal" onclick="btnEdit('.$sub_ID.', 3)">Edit</a>
				                                        <a href="javascript:;" class="btn btn-danger btn-sm" onclick="btnDeleteAccount('.$sub_ID.', 3)">Delete</a>
				                                    </div>
				                                </td>
				                        	</tr>';
				                        }
				                    }
		                        }
		                    }

                        echo '</tbody>
                    </table>
                </div>
            </div>
        </div>';
	}
	if( isset($_GET['modalNew_SidebarAccount']) ) {
		$ID = $_GET['modalNew_SidebarAccount'];
		$type = $_GET['type'];

        $portal_user = $_COOKIE['ID'];
        $user_id = employerID($portal_user);

		echo '<input class="form-control" type="hidden" name="ID" value="'.$ID.'" />
		<input class="form-control" type="hidden" name="type" value="'.$type.'" />
		<div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label class="control-label">Enterprise Users</label>
                    <select class="form-control mt-multiselect" name="user_id" required>
                    	<option value="">Select</option>';

                        if ($user_id == 27) {
                            $selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE employee_id = 0 AND client = 1 AND is_verified = 1 AND is_active = 1 ORDER BY first_name" );
                        } else if ($user_id == 464) {
                            $selectUser = mysqli_query( $conn,"SELECT 
                                u.ID AS ID,
                                u.first_name AS first_name,
                                u.last_name AS last_name,
                                u.email AS u_email,
                                s.ID AS s_ID,
                                s.name AS s_name
                                FROM tbl_user AS u

                                INNER JOIN (
                                    SELECT
                                    *
                                    FROM tbl_supplier
                                    WHERE is_deleted = 0
                                    AND page = 2
                                    AND user_id = $user_id
                                ) AS s
                                ON u.email = s.email

                                WHERE u.employee_id = 0 
                                AND u.is_verified = 1 
                                AND u.is_active = 1 

                                ORDER BY u.first_name" );
                        } else {
                            $selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE employee_id = 0 AND is_verified = 1 AND is_active = 1 ORDER BY first_name" );
                        }
	                    if ( mysqli_num_rows($selectUser) > 0 ) {
	                        while($rowUser = mysqli_fetch_array($selectUser)) {
	                            $rowUser_ID = $rowUser["ID"];
	                            $rowUser_name = $rowUser["first_name"] .' '. $rowUser["last_name"];

	                            $selectMenuSubs = mysqli_query( $conn,"SELECT * FROM tbl_menu_subscription WHERE deleted = 0 AND type = $type AND menu_id = $ID AND user_id = $rowUser_ID" );
	                            if ( mysqli_num_rows($selectMenuSubs) == 0 ) {
									echo '<option value="'. $rowUser_ID .'">'. $rowUser_name .'</option>';
	                            }
	                        }
	                    }

                    echo '</select>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label class="control-label">Date Range</label>
	                <div class="input-group">
	                    <input type="text" class="form-control daterange" name="daterange" />
	                    <span class="input-group-btn">
	                        <button class="btn default date-range-toggle" type="button">
	                            <i class="fa fa-calendar"></i>
	                        </button>
	                    </span>
	                </div>
                </div>
            </div>
        </div>
		';
	}
	if( isset($_GET['modalEdit_SidebarAccount']) ) {
		$ID = $_GET['modalEdit_SidebarAccount'];
		$type = $_GET['type'];

        $portal_user = $_COOKIE['ID'];
        $user_id = employerID($portal_user);

		$rowMenuSub_user_id = '';
        $selectMenuSubs = mysqli_query( $conn,"SELECT * FROM tbl_menu_subscription WHERE deleted = 0 AND type = $type AND ID = $ID" );
        if ( mysqli_num_rows($selectMenuSubs) > 0 ) {
            $rowMenuSub = mysqli_fetch_array($selectMenuSubs);
            $rowMenuSub_user_id = $rowMenuSub["user_id"];
            $rowMenuSub_date_start = $rowMenuSub["date_start"];
            $rowMenuSub_date_end = $rowMenuSub["date_end"];
        }

		echo '<input class="form-control" type="hidden" name="ID" value="'.$ID.'" />
		<input class="form-control" type="hidden" name="type" value="'.$type.'" />
		<div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label class="control-label">Enterprise Users</label>
                    <select class="form-control mt-multiselect" name="user_id" required>
                    	<option value="">Select</option>';

	                    if ($user_id == 27) {
                            $selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE employee_id = 0 AND client = 1 AND is_verified = 1 AND is_active = 1 ORDER BY first_name" );
                        } else {
                            $selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE employee_id = 0 AND is_verified = 1 AND is_active = 1 ORDER BY first_name" );
                        }
                        if ( mysqli_num_rows($selectUser) > 0 ) {
                            while($rowUser = mysqli_fetch_array($selectUser)) {
                                $rowUser_ID = $rowUser["ID"];
                                $rowUser_name = $rowUser["first_name"] .' '. $rowUser["last_name"];

                                echo '<option value="'. $rowUser_ID .'" '; echo $rowUser_ID == $rowMenuSub_user_id ? 'SELECTED':''; echo '>'. $rowUser_name .'</option>';
                            }
                        }

                    echo '</select>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label class="control-label">Date Range</label>
	                <div class="input-group">
	                    <input type="text" class="form-control daterange" name="daterange" value="'.$rowMenuSub_date_start.' - '.$rowMenuSub_date_end.'" />
	                    <span class="input-group-btn">
	                        <button class="btn default date-range-toggle" type="button">
	                            <i class="fa fa-calendar"></i>
	                        </button>
	                    </span>
	                </div>
                </div>
            </div>
        </div>
		';
	}
	if( isset($_GET['btnDelete_Sidebar']) ) {
		$id = $_GET['btnDelete_Sidebar'];

		mysqli_query($conn,"UPDATE tbl_menu set deleted = 1 WHERE ID = $id");
	}
	if( isset($_GET['btnDelete_SidebarAccount']) ) {
		$id = $_GET['btnDelete_SidebarAccount'];

		mysqli_query($conn,"UPDATE tbl_menu_subscription set deleted = 1 WHERE ID = $id");
	}
	if( isset($_POST['btnSave_New_Account']) ) {
		$ID = $_POST['ID'];	 
		$type = $_POST['type'];
		$user_id = $_POST['user_id'];

        $portal_user = $_COOKIE['ID'];
        $switch_id = employerID($portal_user);

		$date = $_POST['daterange'];
		$date = explode(' - ', $date);
		$date_start = $date[0];
		$date_end = $date[1];

        $sql = "INSERT INTO tbl_menu_subscription (menu_id, type, user_id, switch_id, date_start, date_end)
        VALUES ('$ID', '$type', '$user_id', '$switch_id', '$date_start', '$date_end')";
		
		if (mysqli_query($conn, $sql)) {
			$last_id = mysqli_insert_id($conn);

			$selectData = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $user_id" );
			if ( mysqli_num_rows($selectData) > 0 ) {
				$rowData = mysqli_fetch_array($selectData);
				$data_ID = $rowData['ID'];
				$data_name = $rowData['first_name'] .' '. $rowData['last_name'];
			}

            $data_date_start = new DateTime($date_start);
            $data_date_start = $data_date_start->format('M d, Y');
			
            $data_date_end = new DateTime($date_end);
            $data_date_end = $data_date_end->format('M d, Y');

			$output = array(
				"ID" => $ID,
				"type" => $type,
				"name" => $data_name,
				"date_start" => $data_date_start,
				"date_end" => $data_date_end
			);
			echo json_encode($output);
		}
	}
	if( isset($_POST['btnUpdate_New_Account']) ) {
		$ID = $_POST['ID'];	 
		$type = $_POST['type'];
		$user_id = $_POST['user_id'];

		$date = $_POST['daterange'];
		$date = explode(' - ', $date);
		$date_start = $date[0];
		$date_end = $date[1];

		mysqli_query( $conn,"UPDATE tbl_menu_subscription set user_id='". $user_id ."', date_start='". $date_start ."', date_end='". $date_end ."' WHERE ID='". $ID ."'" );
		
		$selectData = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $user_id" );
		if ( mysqli_num_rows($selectData) > 0 ) {
			$rowData = mysqli_fetch_array($selectData);
			$data_ID = $rowData['ID'];
			$data_name = $rowData['first_name'] .' '. $rowData['last_name'];
		}

        $data_date_start = new DateTime($date_start);
        $data_date_start = $data_date_start->format('M d, Y');
		
        $data_date_end = new DateTime($date_end);
        $data_date_end = $data_date_end->format('M d, Y');

		$output = array(
			"ID" => $ID,
			"type" => $type,
			"name" => $data_name,
			"date_start" => $data_date_start,
			"date_end" => $data_date_end
		);
		echo json_encode($output);
	}


    // EMPLOYEE PAGE
    if( isset($_GET['modalNew_HR_Employee']) ) {
        $switch_user_id = $_GET['modalNew_HR_Employee'];
        $current_client = $_GET['c'];

        echo '<input class="form-control" type="hidden" name="client" value="'.$current_client.'" />
        <div class="form-group">
            <label class="col-md-3 control-label">Email Address</label>
            <div class="col-md-8">
                <input class="form-control" type="email" name="email" id="email" required />
            </div>
        </div>
        <div class="form-group">
            <label class="col-md-3 control-label">First Name</label>
            <div class="col-md-8">
                <input class="form-control" type="text" name="first_name" id="first_name" required />
            </div>
        </div>
        <div class="form-group">
            <label class="col-md-3 control-label">Last Name</label>
            <div class="col-md-8">
                <input class="form-control" type="text" name="last_name" id="last_name" required />
            </div>
        </div>
        <div class="form-group">
            <label class="col-md-3 control-label">Type</label>
            <div class="col-md-8">
                <select class="form-control mt-multiselect btn btn-default" name="type_id" required >
                    <option value="">Select</option>
                    <option value="1">Full-time</option>';

                    echo $current_client == 1 ? '<option value="2">Part-Time</option>':'<option value="2">Part-Time Project</option>';
                    if ($current_client = 0) {
                        echo 'option value="3">OJT</option>
                        <option value="4">Freelance</option>
                        <option value="5">Part-Time Apprentice</option>
                        <option value="6">Trainee</option>
                        <option value="7">Consultant</option>';
                    } else if ($current_client = 1) {
                        echo '<option value="8">Contractor</option>
                        <option value="9">Salaried</option>
                        <option value="10">Seasonal</option>';
                    }

                echo '</select>
            </div>
        </div>
        <div class="form-group">
            <label class="col-md-3 control-label">Badge/ID Number</label>
            <div class="col-md-8">
                <input class="form-control" type="text" name="id_number" id="id_number" required />
            </div>
        </div>
        <div class="form-group '; echo $current_client == 1 ? '':'hide'; echo '">
            <label class="col-md-3 control-label">Key(s) Assigned</label>
            <div class="col-md-8">
                <input class="form-control" type="text" name="keys_assigned" id="keys_assigned" />
            </div>
        </div>
        <div class="form-group '; echo $current_client == 1 ? '':'hide'; echo '">
            <label class="col-md-3 control-label">Alarm Code</label>
            <div class="col-md-8">
                <input class="form-control" type="text" name="alarm_code" id="alarm_code" />
            </div>
        </div>
        <div class="form-group">
            <label class="col-md-3 control-label">Date Hired</label>
            <div class="col-md-8">
                <input class="form-control" type="date" name="date_hired" id="date_hired" required />
            </div>
        </div>
        <div class="form-group">
            <label class="col-md-3 control-label">Department</label>
            <div class="col-md-8">
                <select class="form-control mt-multiselect btn btn-default" name="department_id[]" multiple="multiple">
                    <option value="">Select</option>';

                    $selectDepartment = mysqli_query( $conn,"SELECT * FROM tbl_hr_department WHERE status=1 AND user_id = $switch_user_id" );
                    if ( mysqli_num_rows($selectDepartment) > 0 ) {
                        while($rowDepartment = mysqli_fetch_array($selectDepartment)) {
                            echo '<option value="'. $rowDepartment["ID"] .'">'. $rowDepartment["title"] .'</option>';
                        }
                    }

                echo '</select>
            </div>
        </div>
        <div class="form-group">
            <label class="col-md-3 control-label">Job Description</label>
            <div class="col-md-8">
                <select class="form-control mt-multiselect btn btn-default" name="job_description_id[]" multiple="multiple">';

                    $selectJB = mysqli_query( $conn,"SELECT * FROM tbl_hr_job_description WHERE status=1 AND user_id = $switch_user_id" );
                    if ( mysqli_num_rows($selectJB) > 0 ) {
                        while($rowJD = mysqli_fetch_array($selectJB)) {
                            echo '<option value="'. $rowJD["ID"] .'">'. $rowJD["title"] .'</option>';
                        }
                    }

                echo '</select>
            </div>
        </div>
        <div class="form-group">
            <label class="col-md-3 control-label">Reporting To</label>
            <div class="col-md-8">
                <select class="form-control mt-multiselect btn btn-default" name="reporting_to_id">';

                    $selectEmployee = mysqli_query( $conn,"SELECT * FROM tbl_hr_employee WHERE status = 1 AND user_id = $switch_user_id" );
                    if ( mysqli_num_rows($selectEmployee) > 0 ) {
                        echo '<option value="">Select</option>';
                        while($rowEmployee = mysqli_fetch_array($selectEmployee)) {
                            echo '<option value="'. $rowEmployee["ID"] .'">'. $rowEmployee["first_name"] .' '. $rowEmployee["last_name"] .'</option>';
                        }
                    } else {
                        echo '<option disabled>No Available</option>';
                    }

                echo '</select>
            </div>
        </div>';
    }
	if( isset($_GET['modalView_HR_Employee']) ) {
		$id = $_GET['modalView_HR_Employee'];
        $num = $_GET['num'];

        $current_client = 0;
        if (isset($_COOKIE['client'])) { $current_client = $_COOKIE['client']; }

		if (!empty($_COOKIE['switchAccount'])) {
			$portal_user = $_COOKIE['ID'];
			$user_id = $_COOKIE['switchAccount'];
		}
		else {
			$portal_user = $_COOKIE['ID'];
			$user_id = employerID($portal_user);
		}

		$selectData = mysqli_query( $conn,"SELECT * FROM tbl_hr_employee WHERE ID = $id" );
		if ( mysqli_num_rows($selectData) > 0 ) {
            $row = mysqli_fetch_array($selectData);
            $user_id = $row['user_id'];

            $client = $row['client'];
			$client_url = 'login';
			if ($client == 1) {
				$client_url = 'CannOS-Login';
			} else if ($client == 2) {
                $client_url = 'FoodSafety360';
            } else if ($client == 3) {
                $client_url = 'SafeCannabis360';
            } else if ($client == 4) {
                $client_url = 'Exim360';
            }
        }

		echo '<input class="form-control" type="hidden" name="ID" value="'. $row['ID'] .'" />
        <input class="form-control" type="hidden" name="num" value="'. $num .'" />
        <div class="tabbable tabbable-tabdrop">
            <ul class="nav nav-tabs">
                <li class="active">
                    <a href="#tabBasic" data-toggle="tab">Employee Details</a>
                </li>
                <li>
                    <a href="#tabTraining" data-toggle="tab">Training Progress</a>
                </li>
                <li>
                    <a href="#tabFile" data-toggle="tab">Employee Files</a>
                </li>
            </ul>
            <div class="tab-content margin-top-20">
                <div class="tab-pane active" id="tabBasic">
			        <div class="form-group">
			            <label class="col-md-3 control-label">Email Address</label>
			            <div class="col-md-8">
			                <input class="form-control" type="email" name="email" value="'. $row['email'] .'" required />
			            </div>
			        </div>
			        <div class="form-group">
			            <label class="col-md-3 control-label">First Name</label>
			            <div class="col-md-8">
			                <input class="form-control" type="text" name="first_name" value="'. $row['first_name'] .'" required />
			            </div>
			        </div>
			        <div class="form-group">
			            <label class="col-md-3 control-label">Last Name</label>
			            <div class="col-md-8">
			                <input class="form-control" type="text" name="last_name" value="'. $row['last_name'] .'" required />
			            </div>
			        </div>
			        <div class="form-group">
			            <label class="col-md-3 control-label">Type</label>
			            <div class="col-md-8">
			                <select class="form-control mt-multiselect btn btn-default" name="type_id" required >
			                    <option value="">Select</option>
			                    <option value="1" '; if ($row['type_id'] == 1) { echo 'selected'; } echo '>Full-time</option>
                                <option value="2" '; if ($row['type_id'] == 2) { echo 'selected'; } echo '>Part-Time'; echo $_COOKIE['client'] == 1 ? '':' Project'; echo '</option>';

			                    if ($current_client == 0) {
                                    echo '<option value="3" '; if ($row['type_id'] == 3) { echo 'selected'; } echo '>OJT</option>
				                    <option value="4" '; if ($row['type_id'] == 4) { echo 'selected'; } echo '>Freelance</option>
				                    <option value="5" '; if ($row['type_id'] == 5) { echo 'selected'; } echo '>Part-Time Apprentice</option>
				                    <option value="6" '; if ($row['type_id'] == 6) { echo 'selected'; } echo '>Trainee</option>
				                    <option value="7" '; if ($row['type_id'] == 7) { echo 'selected'; } echo '>Consultant</option>';
                                } else if ($current_client == 1) {
                                    echo '<option value="8" '; if ($row['type_id'] == 8) { echo 'selected'; } echo '>Contractor</option>
                                    <option value="9" '; if ($row['type_id'] == 9) { echo 'selected'; } echo '>Salaried</option>
                                    <option value="10" '; if ($row['type_id'] == 10) { echo 'selected'; } echo '>Seasonal</option>';
                                }

			                echo '</select>
			            </div>
			        </div>
			        <div class="form-group">
			            <label class="col-md-3 control-label">Badge/ID Number</label>
			            <div class="col-md-8">
			                <input class="form-control" type="text" name="id_number" id="id_number" value="'. $row['id_number'] .'" required />
			            </div>
			        </div>
			        <div class="form-group '; echo $current_client == 1 ? '':'hide'; echo '">
			            <label class="col-md-3 control-label">Key(s) Assigned</label>
			            <div class="col-md-8">
			                <input class="form-control" type="text" name="keys_assigned" id="keys_assigned" value="'. $row['keys_assigned'] .'" />
			            </div>
			        </div>
                    <div class="form-group '; echo $current_client == 1 ? '':'hide'; echo '">
                        <label class="col-md-3 control-label">Alarm Code</label>
                        <div class="col-md-8">
                            <input class="form-control" type="text" name="alarm_code" id="alarm_code" value="'. $row['alarm_code'] .'" />
                        </div>
                    </div>
			        <div class="form-group">
			            <label class="col-md-3 control-label">Date Hired</label>
			            <div class="col-md-8">
			                <input class="form-control" type="date" name="date_hired" id="date_hired" value="'. $row['date_hired'] .'" required />
			            </div>
			        </div>
                    <div class="form-group">
                        <label class="col-md-3 control-label">Department</label>
                        <div class="col-md-8">
                            <select class="form-control mt-multiselect btn btn-default" name="department_id[]" multiple="multiple">';

                                $array_Dept = explode(", ", $row["department_id"]);
                                $selectDepartment = mysqli_query( $conn,"SELECT * FROM tbl_hr_department WHERE status = 1 AND user_id = $user_id ORDER BY title" );
                                if ( mysqli_num_rows($selectDepartment) > 0 ) {
                                    while($rowDepartment = mysqli_fetch_array($selectDepartment)) {
                                        if (in_array($rowDepartment["ID"], $array_Dept)) {
                                            echo '<option value="'. $rowDepartment["ID"] .'" selected>'. $rowDepartment["title"] .'</option>';
                                        } else {
                                            echo '<option value="'. $rowDepartment["ID"] .'">'. $rowDepartment["title"] .'</option>';
                                        }
                                    }
                                } else {
                                    echo '<option disabled>No Available</option>';
                                }

                            echo '</select>
                        </div>
                    </div>
			        <div class="form-group">
			            <label class="col-md-3 control-label">Job Description</label>
			            <div class="col-md-8">
			            	<select class="form-control mt-multiselect btn btn-default" name="job_description_id[]" multiple="multiple">';

			                	$array_Job = explode(", ", $row["job_description_id"]);
			                    $resultJob = mysqli_query( $conn,"SELECT * FROM tbl_hr_job_description WHERE status = 1 AND user_id = $user_id ORDER BY title" );
			                    if ( mysqli_num_rows($resultJob) > 0 ) {
			                        while($rowJob = mysqli_fetch_array($resultJob)) {
										if (in_array($rowJob["ID"], $array_Job)) {
											echo '<option value="'. $rowJob["ID"] .'" selected>'. $rowJob["title"] .'</option>';
										} else {
											echo '<option value="'. $rowJob["ID"] .'">'. $rowJob["title"] .'</option>';
										}
			                        }
			                    } else {
			                    	echo '<option value="" disabled>No Available</option>';
			                    }

			                echo '</select>
			            </div>
			        </div>
                    <div class="form-group">
                        <label class="col-md-3 control-label">Alternate</label>
                        <div class="col-md-8">
                            <select class="form-control mt-multiselect btn btn-default" name="alternate">';

                                $selectEmployee = mysqli_query( $conn,"SELECT * FROM tbl_hr_employee WHERE status = 1 AND user_id = $user_id AND ID != $id ORDER BY first_name" );
                                if ( mysqli_num_rows($selectEmployee) > 0 ) {
                                    echo '<option value="">Select</option>';
                                    while($rowEmployee = mysqli_fetch_array($selectEmployee)) {
                                        if ( $rowEmployee["ID"] === $row["reporting_to_id"] ) {
                                            echo '<option value="'. $rowEmployee["ID"] .'" selected>'. $rowEmployee["first_name"] .' '. $rowEmployee["last_name"] .'</option>';
                                        } else {
                                            echo '<option value="'. $rowEmployee["ID"] .'">'. $rowEmployee["first_name"] .' '. $rowEmployee["last_name"] .'</option>';
                                        }
                                    }
                                } else {
                                    echo '<option disabled>No Available</option>';
                                }

                            echo '</select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-md-3 control-label">Reporting To</label>
                        <div class="col-md-8">
                            <select class="form-control mt-multiselect btn btn-default" name="reporting_to_id">';

                                $selectEmployee = mysqli_query( $conn,"SELECT * FROM tbl_hr_employee WHERE status = 1 AND user_id = $user_id AND ID != $id ORDER BY first_name" );
                                if ( mysqli_num_rows($selectEmployee) > 0 ) {
                                    echo '<option value="">Select</option>';
                                    while($rowEmployee = mysqli_fetch_array($selectEmployee)) {
                                        if ( $rowEmployee["ID"] === $row["reporting_to_id"] ) {
                                            echo '<option value="'. $rowEmployee["ID"] .'" selected>'. $rowEmployee["first_name"] .' '. $rowEmployee["last_name"] .'</option>';
                                        } else {
                                            echo '<option value="'. $rowEmployee["ID"] .'">'. $rowEmployee["first_name"] .' '. $rowEmployee["last_name"] .'</option>';
                                        }
                                    }
                                } else {
                                    echo '<option disabled>No Available</option>';
                                }

                            echo '</select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-md-3 control-label">Team</label>
                        <div class="col-md-8">
                            <select class="form-control mt-multiselect btn btn-default" name="team[]" multiple="multiple">';

                                $array_team = explode(", ", $row["team"]);
                                echo '<option value="1" '; echo in_array(1, $array_team) ? 'selected':''; echo'>HACCP</option>
                                <option value="2" '; echo in_array(2, $array_team) ? 'selected':''; echo'>Food Defense</option>
                                <option value="3" '; echo in_array(3, $array_team) ? 'selected':''; echo'>Food Safety</option>
                            </select>
                        </div>
                    </div>
			        <div class="form-group">
			            <label class="control-label col-md-3">Suspended</label>
			            <div class="col-md-8">
			            	<input type="checkbox" class="make-switch" name="suspended" id="suspended" data-off-text="No" data-on-text="Yes" data-on-color="warning" data-off-color="default"'; echo $row['suspended'] === "1" ? "checked" : "";  echo '>
			            </div>
			        </div>
			        <div class="form-group">
			            <label class="control-label col-md-3">Status</label>
			            <div class="col-md-8">
			            	<input type="checkbox" class="make-switch" name="status" data-on-text="Active" data-off-text="Inactive" data-on-color="success" data-off-color="danger"'; echo $row['status'] === "1" ? "checked" : "";  echo '>
			            </div>
			        </div>
			        <div class="form-group">
			            <label class="control-label col-md-3">Admin Access</label>
			            <div class="col-md-8">
			            	<input type="checkbox" class="make-switch" name="admin" data-on-text="Yes" data-off-text="No" data-on-color="success" data-off-color="danger"'; echo $row['admin'] === "1" ? "checked" : "";  echo '>
			            </div>
			        </div>
			        <div class="form-group">
			            <label class="control-label col-md-3">Re-invite?</label>
			            <div class="col-md-8">
			            	<a href="javascript:;" class="btn btn-outline dark" data-toggle="modal" onclick="btnReinvite('.$id.')">Send</a>
							<a href="javascript:;" class="btn purple-seance mt-clipboard" onclick="btnCopy('.$id.')">Copy Link</a>
							<input type="text" value="'.$base_url. $client_url .'?r=1&i='.$id.'" id="copy_'.$id.'" style="opacity: 0;"/>
			            </div>
			        </div>
                    <div class="form-group">
                        <label class="control-label col-md-3"></label>
                        <div class="col-md-8">
                            <button type="submit" class="btn green ladda-button" name="btnUpdate_HR_Employee" id="btnUpdate_HR_Employee" data-style="zoom-out"><span class="ladda-label">Update</span></button>
                        </div>
                    </div>
                </div>
                <div class="tab-pane" id="tabTraining">
                    <div class="table-scrollable">
                        <table class="table table-bordered table-hover" id="tableData_training">
                            <thead>
                                <tr>
                                    <th>Description</th>
                                    <th class="text-center" style="width: 150px;">Date Completed</th>
                                    <th class="text-center" style="width: 150px;">Due Date</th>
                                    <th style="width: 140px;">Status</th>
                                    <th class="text-center" style="width: 150px;">Record</th>
                                </tr>
                            </thead>
                            <tbody>';
								$selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE employee_id = $id" );
								if ( mysqli_num_rows($selectUser) > 0 ) {
						            $rowUser = mysqli_fetch_array($selectUser);
						            $current_userID = $rowUser['ID'];
							        $current_userEmployeeID = employeeID($current_userID);
							        $current_userEmployerID = employerID($current_userID);

	                                $selectTrainings = mysqli_query( $conn,"SELECT 
										*
										FROM (
										    SELECT
										    t.ID AS t_ID,
										    t.title AS t_title,
										    t.job_description_id AS t_job_description_id,
										    replace(t.quiz_id , ' ','') AS t_quiz_id,
										    t.last_modified AS t_last_modified,
                                            t.frequency AS t_frequency,
										    q.ID AS q_ID,
										    q.quiz_id AS q_quiz_id,
										    q.result AS q_result,
										    q.last_modified AS q_last_modified
										    FROM tbl_hr_trainings AS t
										    
										    LEFT JOIN (
										        SELECT * 
												FROM tbl_hr_quiz_result 
												WHERE ID IN 
												( 
												SELECT MAX(ID) 
												FROM tbl_hr_quiz_result
												WHERE user_id = $current_userID
												GROUP BY quiz_id 
												)
										    ) AS q
										    ON FIND_IN_SET(q.quiz_id, t.quiz_id) > 0
										    
										    WHERE t.status = 1
										    AND t.deleted = 0
										    AND t.user_id = $current_userEmployerID
										) AS r" );
	                                if ( mysqli_num_rows($selectTrainings) > 0 ) {
	                                    while($rowTraining = mysqli_fetch_array($selectTrainings)) {
	                                        $training_ID = $rowTraining['t_ID'];
	                                        $title = $rowTraining['t_title'];
	                                        $array_rowTraining = explode(", ", $rowTraining["t_job_description_id"]);

                                            $array_frequency = array(
                                                0 => '+1 month',
                                                1 => '+3 month',
                                                2 => '+6 month',
                                                3 => '+1 year'
                                            );

	                                        $found = null;
	                                        $selectEmployee = mysqli_query( $conn,"SELECT * FROM tbl_hr_employee WHERE ID = $current_userEmployeeID" );
	                                        if ( mysqli_num_rows($selectEmployee) > 0 ) {
	                                            $rowEmployee = mysqli_fetch_array($selectEmployee);
	                                            $array_row = explode(", ", $rowEmployee["job_description_id"]);
	                                            foreach($array_row as $emp_JD) {
	                                                if (in_array($emp_JD,$array_rowTraining)) {
	                                                    $found = true;
	                                                }
	                                            }
	                                        }

	                                        if ( $found == true ) {
		                                        $trainingStatus = "Not Yet Started";
		                                        $trainingResult = 0;
		                                        $completed_date = '';
	                                            $due_date = '';
	                                            $pdf_quiz = '';
	                                            if (!empty($rowTraining['t_quiz_id'])) {
	                                                $trainingQuizID = $rowTraining['q_quiz_id'];
													$trainingResult = $rowTraining['q_result'];
													$pdf_quiz = $rowTraining['q_ID'];

													if ($trainingResult == 100) {
														$trainingStatus = "Completed";

														$completed_date = $rowTraining['q_last_modified'];
														$completed_date = new DateTime($completed_date);
														$completed_date = $completed_date->format('M d, Y');

														$due_date = date('Y-m-d', strtotime($array_frequency[$rowTraining['t_frequency']], strtotime($completed_date)) );
														$due_date = new DateTime($due_date);
														$due_date = $due_date->format('M d, Y');

                                                        if (date('Y-m-d') > date('Y-m-d', strtotime($array_frequency[$rowTraining['t_frequency']], strtotime($completed_date)) )) {
                                                            $trainingStatus = '<i class="text-danger sbold">Pass Due</i>';
                                                        }
													}
	                                            }

	                                            echo '<tr id="tr_'.$training_ID.'">
	                                                <td >'. htmlentities($title) .'</td>
	                                                <td class="text-center">'; echo $trainingResult == 100 ? $completed_date:''; echo '</td>
	                                                <td class="text-center">'; echo $trainingResult == 100 ? $due_date:''; echo '</td>
	                                                <td>'.$trainingStatus.'</td>
	                                                <td class="text-center">'; echo $trainingResult == 100 ? '<a href="'.$base_url.'pdf?id='.$pdf_quiz.'" target="_blank" class="btn btn-circle btn-success">View</a>':''; echo '</td>
	                                            </tr>';
	                                        }
	                                    }
	                                }

	                                // $selectTrainings = mysqli_query( $conn,"SELECT * FROM tbl_hr_trainings WHERE status = 1 AND deleted = 0 AND user_id = $current_userEmployerID" );
	                                // if ( mysqli_num_rows($selectTrainings) > 0 ) {
	                                //     while($rowTraining = mysqli_fetch_array($selectTrainings)) {
	                                //         $training_ID = $rowTraining['ID'];
	                                //         $title = $rowTraining['title'];
	                                        
	                                //         $data_last_modified = $rowTraining['last_modified'];
	                                //         $data_last_modified = new DateTime($data_last_modified);
	                                //         $data_last_modified = $data_last_modified->format('M d, Y');

	                                //         $found = null;
	                                //         $selectEmployee = mysqli_query( $conn,"SELECT * FROM tbl_hr_employee WHERE ID = $current_userEmployeeID" );
	                                //         if ( mysqli_num_rows($selectEmployee) > 0 ) {
	                                //             $rowEmployee = mysqli_fetch_array($selectEmployee);
	                                //             $array_row = explode(", ", $rowEmployee["job_description_id"]);
	                                //             $array_rowTraining = explode(", ", $rowTraining["job_description_id"]);
	                                //             foreach($array_row as $emp_JD) {
	                                //                 if (in_array($emp_JD,$array_rowTraining)) {
	                                //                     $found = true;
	                                //                 }
	                                //             }
	                                //         }

	                                //         $trainingStatus = "Not Yet Started";
	                                //         $trainingResult = 0;
	                                //         $completed_date = '';
                                    //         $due_date = '';
                                    //         $pdf_quiz = '';
	                                //         $selectQuizResult = mysqli_query( $conn,"SELECT * FROM tbl_hr_quiz_result WHERE user_id = $current_userID " );
	                                //         if ( mysqli_num_rows($selectQuizResult) > 0 ) {
	                                //             while($rowQuizResult = mysqli_fetch_array($selectQuizResult)) {
	                                //                 $trainingResultID = $rowQuizResult['ID'];
	                                //                 $trainingQuizID = $rowQuizResult['quiz_id'];

	                                //                 if (!empty($rowTraining['quiz_id'])) {
	                                //                     $array_quiz_id = explode(', ', $rowTraining['quiz_id']);
	                                //                     if (in_array($trainingQuizID, $array_quiz_id)) {
	                                //                         $trainingResult = $rowQuizResult['result'];
	                                //                         $pdf_quiz = $trainingResultID;

	                                //                         if ($trainingResult == 100) { $trainingStatus = "Completed"; }
	                                //                         else { $trainingStatus = "Not Yet Started"; }
	                                        
	                                //                         $completed_date = $rowQuizResult['last_modified'];
	                                //                         $completed_date = new DateTime($completed_date);
	                                //                         $completed_date = $completed_date->format('M d, Y');
	                                                        
                                    //                         $due_date = date('Y-m-d', strtotime('+1 year', strtotime($completed_date)) );
                                    //                         $due_date = new DateTime($due_date);
                                    //                         $due_date = $due_date->format('M d, Y');
	                                //                     }
	                                //                 }

	                                //             }
	                                //         }

	                                //         if ( $found == true ) {
	                                //             echo '<tr id="tr_'.$training_ID.'">
	                                //                 <td >'. $title .'</td>
	                                //                 <td class="text-center">'; echo $trainingResult == 100 ? $completed_date:''; echo '</td>
	                                //                 <td class="text-center">'; echo $trainingResult == 100 ? $due_date:''; echo '</td>
	                                //                 <td>'.$trainingStatus.'</td>
	                                //                 <td class="text-center">'; echo $trainingResult == 100 ? '<a href="'.$base_url.'pdf?id='.$pdf_quiz.'" target="_blank" class="btn btn-circle btn-success">View</a>':''; echo '</td>
	                                //             </tr>';
	                                //         }
	                                //     }
	                                // }
						        }

                            echo '</tbody>
                        </table>
                    </div>
                </div>
                <div class="tab-pane" id="tabFile">
                	<a href="#modalNewFile" data-toggle="modal" class="btn green" onclick="btnNew_File('.$id.')">Add New File</a>
                    <div class="table-scrollable">
                        <table class="table table-bordered table-hover">
                            <thead>
                                <tr>
                                    <th style="width: 80px;" class="text-center">File</th>
                                    <th>File Name</th>
                                    <th>Description</th>
                                    <th>Document Date</th>
                                    <th>Uploaded Date</th>
                                    <th>Review Status</th>
                                    <th>Reviewed By</th>
                                    <th style="width: 135px;">Action</th>
                                </tr>
                            </thead>
                            <tbody>';

				                $selectFile = mysqli_query( $conn,"SELECT * FROM tbl_hr_file WHERE deleted = 0 AND user_id = $user_id AND employee_id = $id ORDER BY filename" );
						        if ( mysqli_num_rows($selectFile) > 0 ) {
							        while($rowFile = mysqli_fetch_array($selectFile)) {
                                        $file_ID = $rowFile["ID"];
                                        $file_name = $rowFile["filename"];
                                        $file_description = $rowFile["description"];
                                        $file_status = $rowFile["status"];
                                        $file_reviewed_by = $rowFile["reviewed_by"];

							            $filetype = $rowFile['filetype'];
										$files = $rowFile["files"];
										$type = 'iframe';
										if ($filetype == 1) {
										    $fileExtension = fileExtension($files);
											$src = $fileExtension['src'];
											$embed = $fileExtension['embed'];
											$type = $fileExtension['type'];
											$file_extension = $fileExtension['file_extension'];
										    $url = $base_url.'uploads/hr/';

										    $files = $src.$url.rawurlencode($files).$embed;
										} else if ($filetype == 3) {
											$files = preg_replace('#[^/]*$#', '', $files).'preview';
										}

                                        $file_start_date = $rowFile["start_date"];
                                        $file_uploaded_date = $rowFile["uploaded_date"];
                                        $file_due_date = $rowFile["due_date"];
                                        $file_due_date = new DateTime($file_due_date);
                                        $file_due_date = $file_due_date->format('M d, Y');
                                        if (empty($rowFile["start_date"])) {
                                            $file_start_date = new DateTime($file_due_date);
                                            $file_start_date = $file_start_date->format('Y-m-d');
                                            $file_start_date = strtotime($file_start_date.' -1 year');
                                            $file_start_date = date('Y-m-d', $file_start_date);
                                            $file_start_date = strtotime($file_start_date.' -1 day');
                                            $file_uploaded_date = date('Y-m-d', $file_start_date);
                                            $file_start_date = date('M d, Y', $file_start_date);
                                        } else {
                                            $file_start_date = new DateTime($file_start_date);
                                            $file_start_date = $file_start_date->format('M d, Y');
                                        }
                                        $file_uploaded_date = new DateTime($file_uploaded_date);
                                        $file_uploaded_date = $file_uploaded_date->format('M d, Y');

							        	echo '<tr id="tr_'.$file_ID.'">
		                                    <td><p style="margin: 0;"><a href="'.$files.'" data-src="'.$files.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a></p></td>
		                                    <td >'. $file_name .'</td>
		                                    <td >'. $file_description .'</td>
                                            <td >'. $file_start_date .' - '. $file_due_date .'</td>
                                            <td >'. $file_uploaded_date .'</td>
		                                    <td >For Review</td>
		                                    <td >NA</td>
					                        <td class="text-center">
			                                    <div class="btn-group btn-group-circle">
			                                        <a href="#modalEditFile" class="btn btn-outline dark btn-sm" data-toggle="modal" onclick="btnEdit('.$file_ID.')">Edit</a>
			                                        <a href="javascript:;" class="btn btn-danger btn-sm" onclick="btnDelete('.$file_ID.')">Delete</a>
			                                   </div>
			                                </td>
		                                </tr>';
							        }
						        }

                             echo '</tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>';

        mysqli_close($conn);
	}
    if( isset($_GET['modalView_HR_Employee_Chart']) ) {
        $ID = $_GET['modalView_HR_Employee_Chart'];

        $selectData = mysqli_query( $conn,"SELECT 
            jd1.ID AS jd1_ID,
            jd1.title AS jd1_title,
            jd1.reporting_to_id AS jd1_reporting_to_id,
            jd2.title AS jd2_title,
            e.ID AS e_ID,
            e.first_name AS e_first_name,
            e.last_name AS e_last_name,
            e.email AS e_email,
            e.team AS e_team,
            e.reporting_to_id AS e_reporting_to_id,
            e2.first_name AS e2_first_name,
            e2.last_name AS e2_last_name
            FROM tbl_hr_job_description AS jd1

            LEFT JOIN (
                SELECT
                *
                FROM tbl_hr_job_description
                WHERE status = 1
                AND user_id = $ID
            ) AS jd2
            ON FIND_IN_SET(jd2.ID, REPLACE(jd1.reporting_to_id, ' ', '')) > 0

            LEFT JOIN (
                SELECT
                *
                FROM tbl_hr_employee
                WHERE suspended = 0
                AND user_id = $ID
                AND status = 1
            ) AS e
            ON FIND_IN_SET(jd1.ID, REPLACE(e.job_description_id, ' ', '')) > 0

            LEFT JOIN (
                SELECT
                *
                FROM tbl_hr_employee
                WHERE suspended = 0
                AND user_id = $ID
                AND status = 1
            ) AS e2
            ON e.reporting_to_id = e2.ID

            WHERE jd1.status = 1
            AND jd1.user_id = $ID" );
        if ( mysqli_num_rows($selectData) > 0 ) {

            $data_chart = array();
            while($rowData = mysqli_fetch_array($selectData)) {
                $jd1_ID = $rowData['jd1_ID'];
                $jd1_title = $rowData['jd1_title'];
                $jd1_reporting_to_id = $rowData['jd1_reporting_to_id'];

                $jd_user = $rowData['e_first_name'].' '.$rowData['e_last_name'];
                if (strlen(trim($jd_user)) == 0) { $jd_user = '(Open)'; }

                $jd_user_alternate = $rowData['e2_first_name'].' '.$rowData['e2_last_name'];
                if (strlen(trim($jd_user_alternate)) == 0) { $jd_user_alternate = 'No Alternate'; }
                else { $jd_user_alternate = 'Alternate user is '. $jd_user_alternate; }

                $jd_food_safety = '';
                if (!empty($rowData['e_team'])) {
                    $e_team_arr = explode(", ", $rowData['e_team']);
                    if (in_array(3, $e_team_arr)) {
                        $jd_food_safety = '*';
                    }
                }

                $data_arr = array();
                $data_entity = array(
                    'v' => $jd1_ID,
                    'f' => $jd_user.$jd_food_safety.'<div style="color:red; font-style:italic">'.$jd1_title.'</div>'
                );
                array_push($data_arr, $data_entity);
                array_push($data_arr, $jd1_reporting_to_id ?? '');
                array_push($data_arr, $jd_user_alternate);
                
                array_push($data_chart, $data_arr);
            }
        }

        echo json_encode($data_chart);
    }
	if( isset($_GET['training']) ) {
		$trainings_id = $_GET['training'];
		$ID = $_POST['pk'];
		$status = $_POST['value'];

		$selectEmployee = mysqli_query( $conn,"SELECT * FROM tbl_hr_employee WHERE ID='". $ID ."'" );
		if ( mysqli_num_rows($selectEmployee) > 0 ) {
            $rowEmployee = mysqli_fetch_array($selectEmployee);

            $trainings_id_status = $rowEmployee['trainings_id_status'];

            if ( !empty($trainings_id_status) ) {
            	$output = json_decode($trainings_id_status,true);
				$output[$trainings_id] = $status;
				$value = $output;
            } else {

				$value = array ( $trainings_id=>$status );
            }

            $id_status = json_encode($value); 
            mysqli_query( $conn,"UPDATE tbl_hr_employee set trainings_id_status='". $id_status ."' WHERE ID='". $ID ."'" );
        }
	}
    if( isset($_GET['resend']) ) {
		$ID = $_GET['resend'];

		// $selectData = mysqli_query( $conn,'SELECT * FROM tbl_hr_employee WHERE suspended="0" AND status="1" AND user_id="'. $ID .'"' );
		$selectData = mysqli_query( $conn,'SELECT * FROM tbl_hr_employee WHERE ID="'. $ID .'"' );
		if ( mysqli_num_rows($selectData) > 0 ) {
			while($rowData = mysqli_fetch_array($selectData)) {
				$user_id = $rowData['user_id'];
				$data_ID = $rowData['ID'];
				$data_first_name = $rowData['first_name'];
				$data_last_name = $rowData['last_name'];
				$data_email = $rowData['email'];

	            $client = $rowData['client'];
				$client_url = 'login';
				if ($client == 1) {
					$client_url = 'CannOS-Login';
				} else if ($client == 2) {
                    $client_url = 'FoodSafety360';
                } else if ($client == 3) {
                    $client_url = 'SafeCannabis360';
                } else if ($client == 4) {
                    $client_url = 'Exim360';
                }

                $selectEnterprise = mysqli_query( $conn,"SELECT * FROM tblEnterpiseDetails WHERE users_entities = $user_id" );
                if ( mysqli_num_rows($selectEnterprise) > 0 ) {
                    $rowEnterprise = mysqli_fetch_array($selectEnterprise);
                    $data_company = $rowEnterprise["businessname"];
                }

				$to = $data_email;
				$user = $data_first_name .' '. $data_last_name;
                if ($user_id == 564) {
                	$from = 'hrrecruitment.cig@gmail.com';
                	$name = 'Human Resouce';
					$subject = 'InterlinkIQ-Consultare Inc. Group Invitation';
					
					$body = 'Dear '. $data_first_name .',<br><br>


					Welcome to Consultare Inc. Group.<br><br>


					Please connect with your assigned trainings by accessing this link: <a href="'.$base_url.'login?r=1&i='.$ID.'" target="_blank">InterlinkIQ.com</a><br><br>


					Thank you.<br><br>

					HR Training Team<br>
					hr@consultareinc.com<br>
					Consultare Inc. Group<br>
					<a href="www.InterlinkIQ.com" target="_blank">www.InterlinkIQ.com</a>';
					
					php_mailer_1($to, $user, $subject, $body, $from, $name);
                } else {
                	if ($_COOKIE['client'] == 1) {
                        $subject = 'Welcome to Cann OS!';
                        $body = 'Hi '. $data_first_name .',<br><br>

                        Your employer, '.$data_company.',<br><br>

                        invites you to join <a href="'. $base_url . $client_url .'?r=1&i='. $last_id .'" target="_blank">Cann OS</a> to connect with your assigned duties, work, and tasks. 
                        If you experience difficulties opening the website, kindly use this link instead <a href="'. $base_url . $client_url .'?r=1&i='. $last_id .'" target="_blank">'. $base_url . $client_url .'?r=1&i='. $last_id .'</a><br><br>

                        Should you need assistance, kindly email <a href="mailto:CannOS@begreenlegal.com" target="_blank">CannOS@begreenlegal.com</a><br><br>

                        Cann OS Team';
                	} elseif ($_COOKIE['client'] == 2) {
                        $subject = 'Welcome to Food Safety 360!';
                        $body = 'Hi '. $data_first_name .',<br><br>

                        Your employer, '.$data_company.',<br><br>

                        invites you to join <a href="'. $base_url . $client_url .'?r=1&i='. $last_id .'" target="_blank">FoodSafety360</a> to connect with your assigned duties, work, and tasks. 
                        If you experience difficulties opening the website, kindly use this link instead <a href="'. $base_url . $client_url .'?r=1&i='. $last_id .'" target="_blank">'. $base_url . $client_url .'?r=1&i='. $last_id .'</a><br><br>

                        Should you need assistance, kindly email <a href="mailto:foodsafety360r@gmail.com" target="_blank">foodsafety360r@gmail.com</a><br><br>

                        Cann OS Team';
                    } elseif ($_COOKIE['client'] == 3) {
                        $subject = 'Welcome to Food Safety 360!';
                        $body = 'Hi '. $data_first_name .',<br><br>

                        Your employer, '.$data_company.',<br><br>

                        invites you to join <a href="'. $base_url . $client_url .'?r=1&i='. $last_id .'" target="_blank">SafeCannabis360</a> to connect with your assigned duties, work, and tasks. 
                        If you experience difficulties opening the website, kindly use this link instead <a href="'. $base_url . $client_url .'?r=1&i='. $last_id .'" target="_blank">'. $base_url . $client_url .'?r=1&i='. $last_id .'</a><br><br>

                        Should you need assistance, kindly email <a href="mailto:cannabis360r@gmail.com @gmail.com" target="_blank">cannabis360r@gmail.com</a><br><br>

                        Cann OS Team';
                    } elseif ($_COOKIE['client'] == 4) {
                        $subject = 'Welcome to Food Safety 360!';
                        $body = 'Hi '. $data_first_name .',<br><br>

                        Your employer, '.$data_company.',<br><br>

                        invites you to join <a href="'. $base_url . $client_url .'?r=1&i='. $last_id .'" target="_blank">Exim360</a> to connect with your assigned duties, work, and tasks. 
                        If you experience difficulties opening the website, kindly use this link instead <a href="'. $base_url . $client_url .'?r=1&i='. $last_id .'" target="_blank">'. $base_url . $client_url .'?r=1&i='. $last_id .'</a><br><br>

                        Should you need assistance, kindly email <a href="mailto:exim360r@gmail.com" target="_blank">exim360r@gmail.com</a><br><br>

                        Cann OS Team';
                    } else {
						$subject = 'You are invited!';
						$body = 'Hi '. $data_first_name .',<br><br>

						Your employer, '.$data_company.', invites you to join <a href="'.$base_url. $client_url .'?r=1&i='.$ID.'" target="_blank">InterlinkIQ.com</a> to connect with your assigned duties, work, and tasks.
						If you experience difficulties opening the website, kindly use this link instead <a href="'. $base_url . $client_url .'?r=1&i='. $ID .'" target="_blank">'. $base_url . $client_url .'?r=1&i='. $ID .'</a><br><br>

						Should you need assistance, kindly call 202-982-3002 or email <a href="mailto:services@interlinkIQ.com" target="_blank">services@interlinkIQ.com</a><br><br>
						 
						InterlinkIQ.com Team<br>
						Consultare Inc. Group';
					}
					
					php_mailer($to, $user, $subject, $body);
                }
			}
		}
	}
	if( isset($_POST['btnSave_HR_Employee']) ) {
		if (!empty($_COOKIE['switchAccount'])) {
			$portal_user = $_COOKIE['ID'];
			$user_id = $_COOKIE['switchAccount'];
		}
		else {
			$portal_user = $_COOKIE['ID'];
			$user_id = employerID($portal_user);
		}

		$client = $_POST['client'];
		$email = $_POST['email'];
		$first_name = addslashes($_POST['first_name']);
		$last_name = addslashes($_POST['last_name']);
		$type_id = $_POST['type_id'];
		$id_number = addslashes($_POST['id_number']);
		$keys_assigned = $_POST['keys_assigned'];
        $alarm_code = $_POST['alarm_code'];
		$date_hired = $_POST['date_hired'];
		$reporting_to_id = $_POST['reporting_to_id'];
		$last_modified = date('Y-m-d');
		$exist = false;

        $department_id = '';
        if (!empty($_POST['department_id'])) {
            $department_id = implode(", ",$_POST['department_id']);
        }

		$job_description_id = '';
		if (!empty($_POST['job_description_id'])) {
			$job_description_id = implode(", ",$_POST['job_description_id']);
		}

		$selectEmployee = mysqli_query( $conn,'SELECT * FROM tbl_hr_employee WHERE email="'. $email .'"' );
		if ( mysqli_num_rows($selectEmployee) > 0 ) {
			$exist = true;
			$result = array(
				"exist" => $exist,
				"message" => 'Email Address is already used! Please try another email'
			);
		}
		$selectUser = mysqli_query( $conn,'SELECT * FROM tbl_user WHERE email="'. $email .'"' );
		if ( mysqli_num_rows($selectUser) > 0 ) {
			$exist = true;
			$result = array(
				"exist" => $exist,
				"message" => 'Email Address is already used! Please try another email'
			);
		}

		if ($exist == false) {
			$sql = "INSERT INTO tbl_hr_employee (user_id, portal_user, first_name, last_name, email, client, type_id, id_number, keys_assigned, alarm_code, date_hired, department_id, job_description_id, reporting_to_id, last_modified)
			VALUES ('$user_id', '$portal_user', '$first_name', '$last_name', '$email', '$client', '$type_id', '$id_number', '$keys_assigned', '$alarm_code', '$date_hired', '$department_id', '$job_description_id', '$reporting_to_id', '$last_modified')";
			
			if (mysqli_query($conn, $sql)) {
				$last_id = mysqli_insert_id($conn);

				$selectData = mysqli_query( $conn,'SELECT * FROM tbl_hr_employee WHERE user_id="'. $user_id .'" AND ID="'. $last_id .'" ORDER BY ID LIMIT 1' );
				if ( mysqli_num_rows($selectData) > 0 ) {
					$rowData = mysqli_fetch_array($selectData);
					$data_ID = $rowData['ID'];
                    $data_first_name = stripcslashes(htmlentities($rowData['first_name'] ?? ''));
                    $data_last_name = stripcslashes(htmlentities($rowData['last_name'] ?? ''));
					$data_email = $rowData['email'];
					$data_date_hired = $rowData['date_hired'];
					$data_type_id = $rowData['type_id'];
					$data_suspended = $rowData['suspended'];
					$data_status = $rowData['status'];
					$data_company = "";

					$client_url = 'login';
					if ($client == 1) {
						$client_url = 'CannOS-Login';
					} else if ($client == 2) {
                        $client_url = 'FoodSafety360';
                    } else if ($client == 3) {
                        $client_url = 'SafeCannabis360';
                    } else if ($client == 4) {
                        $client_url = 'Exim360';
                    }

					$position = array();
					$jd = $rowData["job_description_id"];
					if (!empty($jd)) {
					    $jd_arr = explode(", ", $jd);
					    foreach ($jd_arr as $value) {
					        $resultJD = mysqli_query( $conn,"SELECT * FROM tbl_hr_job_description WHERE ID = $value" );
					        if ( mysqli_num_rows($resultJD) > 0 ) {
					            $rowJD = mysqli_fetch_array($resultJD);
					            array_push($position, $rowJD["title"]);
					        }
					    }
					    $position = implode(', ', $position);
					}
					
                    $selectEnterprise = mysqli_query( $conn,"SELECT * FROM tblEnterpiseDetails WHERE users_entities = $user_id" );
                    if ( mysqli_num_rows($selectEnterprise) > 0 ) {
                        $rowEnterprise = mysqli_fetch_array($selectEnterprise);
                        $data_company = $rowEnterprise["businessname"];
                    }


					$to = $data_email;
					$user = $data_first_name .' '. $data_last_name;
                    if ($user_id == 564) {
                    	$from = 'hrrecruitment.cig@gmail.com';
                    	$name = 'Human Resouce';
						$subject = 'InterlinkIQ-Consultare Inc. Group Invitation';
						
						$body = 'Dear '. $data_first_name .',<br><br>


						Welcome to Consultare Inc. Group.<br><br>


						Please connect with your assigned trainings by accessing this link: <a href="'.$base_url.'login?r=1&i='.$last_id.'" target="_blank">InterlinkIQ.com</a><br><br>


						Thank you.<br><br>

						HR Training Team<br>
						hr@consultareinc.com<br>
						Consultare Inc. Group<br>
						<a href="www.InterlinkIQ.com" target="_blank">www.InterlinkIQ.com</a>';
						
						php_mailer_1($to, $user, $subject, $body, $from, $name);
                    } else {
                    	if ($_COOKIE['client'] == 1) {
                            $subject = 'Welcome to Cann OS!';
                            $body = 'Hi '. $data_first_name .',<br><br>

                            Your employer, '.$data_company.',<br><br>

                            invites you to join <a href="'. $base_url . $client_url .'?r=1&i='. $last_id .'" target="_blank">Cann OS</a> to connect with your assigned duties, work, and tasks. 
                            If you experience difficulties opening the website, kindly use this link instead <a href="'. $base_url . $client_url .'?r=1&i='. $last_id .'" target="_blank">'. $base_url . $client_url .'?r=1&i='. $last_id .'</a><br><br>

                            Should you need assistance, kindly email <a href="mailto:CannOS@begreenlegal.com" target="_blank">CannOS@begreenlegal.com</a><br><br>

                            Cann OS Team';
                    	} else if ($_COOKIE['client'] == 2) {
                            $subject = 'Welcome to Cann OS!';
                            $body = 'Hi '. $data_first_name .',<br><br>

                            Your employer, '.$data_company.',<br><br>

                            invites you to join <a href="'. $base_url . $client_url .'?r=1&i='. $last_id .'" target="_blank">Food Safety 360</a> to connect with your assigned duties, work, and tasks. 
                            If you experience difficulties opening the website, kindly use this link instead <a href="'. $base_url . $client_url .'?r=1&i='. $last_id .'" target="_blank">'. $base_url . $client_url .'?r=1&i='. $last_id .'</a><br><br>

                            Should you need assistance, kindly email <a href="mailto:foodsafety360r@gmail.com" target="_blank">foodsafety360r@gmail.com</a><br><br>

                            Cann OS Team';
                        } else if ($_COOKIE['client'] == 3) {
                            $subject = 'Welcome to Cann OS!';
                            $body = 'Hi '. $data_first_name .',<br><br>

                            Your employer, '.$data_company.',<br><br>

                            invites you to join <a href="'. $base_url . $client_url .'?r=1&i='. $last_id .'" target="_blank">Food Safety 360</a> to connect with your assigned duties, work, and tasks. 
                            If you experience difficulties opening the website, kindly use this link instead <a href="'. $base_url . $client_url .'?r=1&i='. $last_id .'" target="_blank">'. $base_url . $client_url .'?r=1&i='. $last_id .'</a><br><br>

                            Should you need assistance, kindly email <a href="mailto:cannabis360r@gmail.com" target="_blank">cannabis360r@gmail.com</a><br><br>

                            Cann OS Team';
                        } else if ($_COOKIE['client'] == 4) {
                            $subject = 'Welcome to Cann OS!';
                            $body = 'Hi '. $data_first_name .',<br><br>

                            Your employer, '.$data_company.',<br><br>

                            invites you to join <a href="'. $base_url . $client_url .'?r=1&i='. $last_id .'" target="_blank">Food Safety 360</a> to connect with your assigned duties, work, and tasks. 
                            If you experience difficulties opening the website, kindly use this link instead <a href="'. $base_url . $client_url .'?r=1&i='. $last_id .'" target="_blank">'. $base_url . $client_url .'?r=1&i='. $last_id .'</a><br><br>

                            Should you need assistance, kindly email <a href="mailto:exim360r@gmail.com" target="_blank">exim360r@gmail.com</a><br><br>

                            Cann OS Team';
                        } else {
							$subject = 'You are invited!';
							$body = 'Hi '. $data_first_name .',<br><br>

							Your employer, '.$data_company.', invites you to join <a href="'.$base_url. $client_url .'?r=1&i='.$last_id.'" target="_blank">InterlinkIQ.com</a> to connect with your assigned duties, work, and tasks.
							If you experience difficulties opening the website, kindly use this link instead <a href="'. $base_url . $client_url .'?r=1&i='. $last_id .'" target="_blank">'. $base_url . $client_url .'?r=1&i='. $last_id .'</a><br><br>

							Should you need assistance, kindly call 202-982-3002 or email <a href="mailto:services@interlinkIQ.com" target="_blank">services@interlinkIQ.com</a><br><br>
							 
							InterlinkIQ.com Team<br>
							Consultare Inc. Group';
                    	}
						
						php_mailer($to, $user, $subject, $body);
                    }

					if ($_COOKIE['client'] == 1) {
                        $employment_type = array(
                            1 => 'Full-time',
                            2 => 'Part-Time',
                            3 => 'OJT',
                            4 => 'Freelance',
                            5 => 'Part-Time Apprentice',
                            6 => 'Trainee',
                            7 => 'Consultant',
                            8 => 'Contractor',
                            9 => 'Salaried',
                            10 => 'Seasonal'
                        );
                    } else {
                        $employment_type = array(
                            1 => 'Full-time',
                            2 => 'Part-Time Project',
                            3 => 'OJT',
                            4 => 'Freelance',
                            5 => 'Part-Time Apprentice',
                            6 => 'Trainee',
                            7 => 'Consultant',
                            8 => 'Contractor',
                            9 => 'Salaried',
                            10 => 'Seasonal'
                        );
                    }

					$selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE email ='".$data_email."'" );
					if ( mysqli_num_rows($selectUser) > 0 ) {
					    $registered = '<span class="label label-sm label-success">Yes</span>';
					} else {
					    $registered = '<span class="label label-sm label-danger">No</span>';
					}

					$counterup_tbl = counterup_tbl('employee');
					$output = array(
						"exist" => $exist,
						"message" => 'okay',
						"ID" => $data_ID,
						"first_name" => $data_first_name,
						"last_name" => $data_last_name,
						"position" => $position,
						"email" => $data_email,
						"registered" => $registered,
						"date_hired" => $data_date_hired,
						"suspended" => $data_suspended,
						"status" => $data_status,
						"employment_type" => $employment_type[$data_type_id]
					);

					$result = array_merge($counterup_tbl, $output);
				}
			}
			mysqli_close($conn);
		}
		echo json_encode($result);
	}
	if( isset($_POST['btnUpdate_HR_Employee']) ) {
        if (!empty($_COOKIE['switchAccount'])) {
            $portal_user = $_COOKIE['ID'];
            $user_id = $_COOKIE['switchAccount'];
        }
        else {
            $portal_user = $_COOKIE['ID'];
            $user_id = employerID($portal_user);
        }

		$ID = $_POST['ID'];
        $num = $_POST['num'];
		$first_name = addslashes($_POST['first_name']);
		$last_name = addslashes($_POST['last_name']);
		$email = $_POST['email'];
		$type_id = $_POST['type_id'];
		$id_number = addslashes($_POST['id_number']);
		$keys_assigned = $_POST['keys_assigned'];
        $alarm_code = $_POST['alarm_code'];
		$date_hired = $_POST['date_hired'];
		$alternate = $_POST['alternate'];
        $reporting_to_id = $_POST['reporting_to_id'];
		$suspended = isset($_POST['suspended']) ? 1 : 0;
		$status = isset($_POST['status']) ? 1 : 0;
		$admin = isset($_POST['admin']) ? 1 : 0;
		$status_last_modified = date('Y-m-d');

        $department_id = '';
        if (!empty($_POST['department_id'])) {
            $department_id = implode(", ",$_POST['department_id']);
        }

		$job_description_id = '';
		if (!empty($_POST['job_description_id'])) {
			$job_description_id = implode(", ",$_POST['job_description_id']);
		}

        $team = '';
        if (!empty($_POST['team'])) {
            $team = implode(", ",$_POST['team']);
        }

		mysqli_query( $conn,"UPDATE tbl_hr_employee set first_name='". $first_name ."', last_name='". $last_name ."', email='". $email ."', type_id='". $type_id ."', id_number='". $id_number ."', keys_assigned='". $keys_assigned ."', alarm_code='". $alarm_code ."', date_hired='". $date_hired ."', department_id='". $department_id ."', job_description_id='". $job_description_id ."', alternate='". $alternate ."', reporting_to_id='". $reporting_to_id ."', team='". $team ."', suspended='". $suspended ."', status='". $status ."', admin='". $admin ."', last_modified='". $status_last_modified ."' WHERE ID='". $ID ."'" );
		
		$selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE email = '".$email."'" );
		if ( mysqli_num_rows($selectUser) > 0 ) {
			mysqli_query( $conn,"UPDATE tbl_user set is_active='". $status ."' WHERE email='". $email ."'" );
		}

		if (!mysqli_error($conn)) {
			if ($_COOKIE['client'] == 1) {
                $employment_type = array(
                    1 => 'Full-time',
                    2 => 'Part-Time',
                    3 => 'OJT',
                    4 => 'Freelance',
                    5 => 'Part-Time Apprentice',
                    6 => 'Trainee',
                    7 => 'Consultant',
                    8 => 'Contractor',
                    9 => 'Salaried',
                    10 => 'Seasonal'
                );
            } else {
                $employment_type = array(
                    1 => 'Full-time',
                    2 => 'Part-Time Project',
                    3 => 'OJT',
                    4 => 'Freelance',
                    5 => 'Part-Time Apprentice',
                    6 => 'Trainee',
                    7 => 'Consultant',
                    8 => 'Contractor',
                    9 => 'Salaried',
                    10 => 'Seasonal'
                );
            }

            $position = array();
            if (!empty($job_description_id)) {
                $jd_arr = explode(", ", $job_description_id);
                foreach ($jd_arr as $value) {
                    $resultJD = mysqli_query( $conn,"SELECT * FROM tbl_hr_job_description WHERE ID = $value" );
                    if ( mysqli_num_rows($resultJD) > 0 ) {
                        $rowJD = mysqli_fetch_array($resultJD);
                        array_push($position, $rowJD["title"]);
                    }
                }
                $position = implode(', ', $position);
            }

            $selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE email ='".$email."'" );
            if ( mysqli_num_rows($selectUser) > 0 ) {
                $registered = '<span class="label label-sm label-success">Yes</span>';
            } else {
                $registered = '<span class="label label-sm label-danger">No</span>';
            }

            $array_training_list = array();
            $selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE employee_id = $ID" ); // 83
            if ( mysqli_num_rows($selectUser) > 0 ) {
                $rowUser = mysqli_fetch_array($selectUser);
                $current_userID = $rowUser['ID'];

                $selectTrainings = mysqli_query( $conn,"SELECT 
                    *
                    FROM (
                        SELECT
                        t.ID AS t_ID,
                        t.title AS t_title,
                        t.job_description_id AS t_job_description_id,
                        replace(t.quiz_id , ' ','') AS t_quiz_id,
                        t.last_modified AS t_last_modified,
                        t.frequency AS t_frequency,
                        q.ID AS q_ID,
                        q.quiz_id AS q_quiz_id,
                        q.result AS q_result,
                        q.last_modified AS q_last_modified
                        FROM tbl_hr_trainings AS t
                        
                        LEFT JOIN (
                            SELECT * 
                            FROM tbl_hr_quiz_result 
                            WHERE ID IN ( 
                                SELECT MAX(ID) 
                                FROM tbl_hr_quiz_result
                                WHERE user_id = $current_userID
                                GROUP BY quiz_id 
                            )
                        ) AS q
                        ON FIND_IN_SET(q.quiz_id, t.quiz_id) > 0
                        
                        WHERE t.status = 1
                        AND t.deleted = 0
                        AND t.user_id = $user_id
                    ) AS r" );
                if ( mysqli_num_rows($selectTrainings) > 0 ) {
                    while($rowTraining = mysqli_fetch_array($selectTrainings)) {
                        $training_ID = $rowTraining['t_ID'];
                        $title = $rowTraining['t_title'];
                        $array_rowTraining = explode(", ", $rowTraining["t_job_description_id"]);

                        $found = null;
                        $selectEmployee = mysqli_query( $conn,"SELECT * FROM tbl_hr_employee WHERE ID = $ID" );
                        if ( mysqli_num_rows($selectEmployee) > 0 ) {
                            $rowEmployee = mysqli_fetch_array($selectEmployee);
                            $array_row = explode(", ", $rowEmployee["job_description_id"]);
                            foreach($array_row as $emp_JD) {
                                if (in_array($emp_JD,$array_rowTraining)) {
                                    $found = true;
                                }
                            }
                        }

                        if ( $found == true ) {
                            $trainingStatus = "Not Yet Started";
                            $trainingResult = 0;
                            $completed_date = '';
                            $due_date = '';
                            $pdf_quiz = '';
                            if (!empty($rowTraining['t_quiz_id'])) {
                                $trainingQuizID = $rowTraining['q_quiz_id'];
                                $trainingResult = $rowTraining['q_result'];
                                $pdf_quiz = $rowTraining['q_ID'];

                                if (empty($trainingResult)) {
                                   array_push($array_training_list, $title);
                                }
                            }
                        }
                    }
                }
            }
            if (!empty($array_training_list)) {
                $subject = 'New Training Assigned!';
                $body = 'Hi '. htmlentities($first_name ?? '') .',<br><br>

                The following training has been assigned:<br>
                <ol>';

                foreach ($array_training_list as $value) {
                    $body .= '<li>'.$value.'</li>';
                }

                $body .= '</ol>

                Navigate to the training module to complete your assigned training and assessment.<br><br>';

                if ($_COOKIE['client'] == 1) {
                    $from = 'CannOS@begreenlegal.com';
                    $name = 'BeGreenLegal';
                    $body .= 'Cann OS Team';
                } else if ($_COOKIE['client'] == 2) {
                    $from = 'foodsafety360r@gmail.com';
                    $name = 'FoodSafety360';
                    $body .= 'Food Safety Procedure';
                } else if ($_COOKIE['client'] == 3) {
                    $from = 'cannabis360r@gmail.com';
                    $name = 'SafeCannabis360';
                    $body .= 'Food Safety Procedure';
                } else if ($_COOKIE['client'] == 4) {
                    $from = 'exim360r@gmail.com';
                    $name = 'Exim360';
                    $body .= 'Food Safety Procedure';
                } else {
                    $from = 'services@interlinkiq.com';
                    $name = 'InterlinkIQ';
                    $body .= 'InterlinkIQ.com Team<br>
                    Consultare Inc.';
                }
                php_mailer_1($email, $first_name .' '. $last_name, $subject, $body, $from, $name);
            }

		    $counterup_tbl = counterup_tbl('employee');
			$output = array(
				'ID' => $ID,
                'num' => $num,
                'first_name' => stripcslashes(htmlentities($first_name ?? '')),
                'last_name' => stripcslashes(htmlentities($last_name ?? '')),
				'position' => $position,
				'email' => $email,
				'registered' => $registered,
				'date_hired' => $date_hired,
				'employment_type' => $employment_type[$type_id],
				'suspended' => $suspended,
				'status' => $status
			);

			$result = array_merge($counterup_tbl, $output);
			echo json_encode($result);
		}

		mysqli_close($conn);
	}

	// File Section
	if( isset($_GET['modalNew_File']) ) {
		$ID = $_GET['modalNew_File'];

		echo '<input class="form-control" type="hidden" name="ID" value="'. $ID .'" />
		<div class="form-group">
	        <label class="col-md-3 control-label">Upload File</label>
	        <div class="col-md-8">
	            <select class="form-control" name="filetype" onchange="changeType(this)" required>
	            	<option value="0">Select option</option>
	            	<option value="1">Manual Upload</option>
	            	<option value="2">Youtube URL</option>
	            	<option value="3">Google Drive URL</option>
	            </select>
	            <input class="form-control margin-top-15 fileUpload" type="file" name="file" style="display: none;" />
	            <input class="form-control margin-top-15 fileURL" type="url" name="fileurl" style="display: none;" placeholder="https://" />
	        </div>
	    </div>
	    <div class="form-group">
	        <label class="col-md-3 control-label">File Name</label>
	        <div class="col-md-8">
	            <input class="form-control" type="text" name="filename" required />
	        </div>
	    </div>
	    <div class="form-group">
	        <label class="col-md-3 control-label">Description</label>
	        <div class="col-md-8">
	            <textarea class="form-control" name="description" required></textarea>
	        </div>
	    </div>
        <div class="form-group">
            <label class="col-md-3 control-label">Document Date</label>
            <div class="col-md-8">
                <div class="input-group">
                    <input type="text" class="form-control daterange" name="daterange" />
                    <span class="input-group-btn">
                        <button class="btn default date-range-toggle" type="button">
                            <i class="fa fa-calendar"></i>
                        </button>
                    </span>
                </div>
            </div>
        </div>';
	}
	if( isset($_GET['modalEdit_File']) ) {
		$ID = $_GET['modalEdit_File'];

		$selectData = mysqli_query( $conn,"SELECT * FROM tbl_hr_file WHERE ID = $ID" );
        if ( mysqli_num_rows($selectData) > 0 ) {
            $row = mysqli_fetch_array($selectData);
            $filename = $row['filename'];
            $description = $row['description'];
            $uploaded_date = $row['uploaded_date'];

            $due_date = new DateTime($row['due_date']);
            $due_date = $due_date->format('m/d/Y');
            if (empty($row['start_date'])) {
                $start_date = new DateTime($due_date);
                $start_date = $start_date->format('Y-m-d');
                $start_date = strtotime($start_date.' -1 year');
                $start_date = date('Y-m-d', $start_date);
                $start_date = strtotime($start_date.' -1 day');
                $uploaded_date = date('Y-m-d', $start_date);
                $start_date = date('m/d/Y', $start_date);
            } else {
                $start_date = new DateTime($row['start_date']);
                $start_date = $start_date->format('m/d/Y');
            }

			$filetype = $row['filetype'];
			$files = $row["files"];
			$type = 'iframe';
			if ($filetype == 1) {
			    $fileExtension = fileExtension($files);
				$src = $fileExtension['src'];
				$embed = $fileExtension['embed'];
				$type = $fileExtension['type'];
				$file_extension = $fileExtension['file_extension'];
			    $url = $base_url.'uploads/hr/';

			    $files = $src.$url.rawurlencode($files).$embed;
			} else if ($filetype == 3) {
				$files = preg_replace('#[^/]*$#', '', $files).'preview';
			}
        }

		echo '<input class="form-control" type="hidden" name="ID" value="'. $ID .'" />
        <input class="form-control" type="hidden" name="uploaded_date" value="'. $uploaded_date .'" />
		<div class="form-group">
	        <label class="col-md-3 control-label">Upload File</label>
	        <div class="col-md-8">
	            <select class="form-control '; echo !empty($files) ? 'hide':''; echo '" name="filetype" onchange="changeType(this)" required>
	            	<option value="0">Select option</option>
	            	<option value="1">Manual Upload</option>
	            	<option value="2">Youtube URL</option>
	            	<option value="3">Google Drive URL</option>
	            </select>
	            <input class="form-control margin-top-15 fileUpload" type="file" name="file" style="display: none;" />
	            <input class="form-control margin-top-15 fileURL" type="url" name="fileurl" style="display: none;" placeholder="https://" />
                <p class="'; echo !empty($files) ? '':'hide'; echo '" style="margin: 0;"><a data-src="'.$files.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a> | <button type="button" class="btn btn-link uploadNew" onclick="uploadNew(this)">Upload New</button></p>
	        </div>
	    </div>
	    <div class="form-group">
	        <label class="col-md-3 control-label">File Name</label>
	        <div class="col-md-8">
	            <input class="form-control" type="text" name="filename" value="'.$filename.'" required />
	        </div>
	    </div>
	    <div class="form-group">
	        <label class="col-md-3 control-label">Description</label>
	        <div class="col-md-8">
	            <textarea class="form-control" name="description" required>'.$description.'</textarea>
	        </div>
	    </div>
        <div class="form-group">
            <label class="col-md-3 control-label">Document Date</label>
            <div class="col-md-8">
                <div class="input-group">
                    <input type="text" class="form-control daterange" name="daterange" value="'.$start_date.' - '.$due_date.'" />
                    <span class="input-group-btn">
                        <button class="btn default date-range-toggle" type="button">
                            <i class="fa fa-calendar"></i>
                        </button>
                    </span>
                </div>
            </div>
        </div>';
	}
	if( isset($_GET['btnDelete_Files']) ) {
		$id = $_GET['btnDelete_Files'];
		mysqli_query( $conn,"UPDATE tbl_hr_file set deleted='1' WHERE ID='". $id ."'" );
	}
	if( isset($_POST['btnSave_HR_File']) ) {
		if (!empty($_COOKIE['switchAccount'])) {
			$portal_user = $_COOKIE['ID'];
			$user_id = $_COOKIE['switchAccount'];
		}
		else {
			$portal_user = $_COOKIE['ID'];
			$user_id = employerID($portal_user);
		}

		$ID = $_POST['ID'];
		$filename = addslashes($_POST['filename']);
		$description = addslashes($_POST['description']);
        $arr_item = array();
        $process = true;

		$filetype = $_POST['filetype'];
		if ($filetype == 1) {
			$files = $_FILES['file']['name'];
			if (!empty($files)) {
				$path = 'uploads/hr/';
                $filesize = $_FILES['file']['size'];
				$tmp = $_FILES['file']['tmp_name'];
                $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                $ext = strtolower(pathinfo($files, PATHINFO_EXTENSION));
				$files = rand(1000,1000000) . ' - ' . $files;
				$path = $path.$files;

                if(!in_array($ext, $invalid_extensions)) {
                    move_uploaded_file($tmp,$path);
                } else {
                    $process = false;
                }
			}
		} else {
			$files = $_POST['fileurl'];
            $filesize = 0;
		}

        if ($process == true) {
            $last_modified = date('Y-m-d');
            $date = $_POST['daterange'];
            $date = explode(' - ', $date);
            $date_start = $date[0];
            $date_end = $date[1];

            $output = array (
                'type'  =>  $filetype,
                'name' =>  $files,
                'size' =>  $filesize,
                'date' =>  $local_date
            );
            array_push($arr_item, $output);
            $file_history = json_encode($arr_item, JSON_HEX_APOS | JSON_UNESCAPED_UNICODE);

            $sql = "INSERT INTO tbl_hr_file (user_id, portal_user, employee_id, files, filetype, filename, filesize, file_history, description, start_date, due_date, uploaded_date)
            VALUES ('$user_id', '$portal_user', '$ID', '$files', '$filetype', '$filename', '$filesize', '$file_history', '$description', '$date_start', '$date_end', '$last_modified')";
            
    		if (mysqli_query($conn, $sql)) {
    			$last_id = mysqli_insert_id($conn);

    			$selectData = mysqli_query( $conn,'SELECT * FROM tbl_hr_file WHERE user_id="'. $user_id .'" AND ID="'. $last_id .'" ORDER BY ID LIMIT 1' );
    			if ( mysqli_num_rows($selectData) > 0 ) {
    				$rowData = mysqli_fetch_array($selectData);
    				$data_ID = $rowData['ID'];
    				$data_filename = stripcslashes($rowData['filename']);
    				$data_description = stripcslashes($rowData['description']);

    				$data_files = $rowData['files'];
    				$type = 'iframe';
    				if (!empty($data_files)) {
    					if ($filetype == 1) {
    						$fileExtension = fileExtension($data_files);
    						$src = $fileExtension['src'];
    						$embed = $fileExtension['embed'];
    						$type = $fileExtension['type'];
    						$file_extension = $fileExtension['file_extension'];
    			            $url = $base_url.'uploads/hr/';

    			            $data_files = $src.$url.rawurlencode($data_files).$embed;
    					} else if ($filetype == 3) {
    						$data_files = preg_replace('#[^/]*$#', '', $data_files).'preview';
    					}
    		            $files = '<p style="margin: 0;"><a data-src="'.$data_files.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a></p>';
    				}

                    $data_uploaded_date = new DateTime($last_modified);
                    $data_uploaded_date = $data_uploaded_date->format('M d, Y');

                    $data_date_start = new DateTime($date_start);
                    $data_date_start = $data_date_start->format('M d, Y');
                    
                    $data_date_end = new DateTime($date_end);
                    $data_date_end = $data_date_end->format('M d, Y');

    				$output = array(
                        "ID" => $data_ID,
                        "files" => $files,
                        "filename" => $data_filename,
                        "description" => $data_description,
                        "start_date" => $data_date_start,
                        "due_date" => $data_date_end,
                        "uploaded_date" => $data_uploaded_date
                    );
    			}
    		}
    		mysqli_close($conn);
    		echo json_encode($output);
    	}
    }
	if( isset($_POST['btnUpdate_HR_File']) ) {
		$ID = $_POST['ID'];
		$filename = addslashes($_POST['filename']);
		$description = addslashes($_POST['description']);

        $uploaded_date = $_POST['uploaded_date'];
        $last_modified = date('Y-m-d');
        $date = $_POST['daterange'];
        $date = explode(' - ', $date);
        $date_start = $date[0];
        $date_end = $date[1];
        $process = true;

        mysqli_query( $conn,"UPDATE tbl_hr_file set filename='". $filename ."', description='". $description ."', start_date='". $date_start ."', due_date='". $date_end ."', uploaded_date='". $uploaded_date ."' WHERE ID='". $ID ."'" );

		$selectData = mysqli_query( $conn,'SELECT * FROM tbl_hr_file WHERE ID="'. $ID .'" ORDER BY ID LIMIT 1' );
		if ( mysqli_num_rows($selectData) > 0 ) {
			$rowData = mysqli_fetch_array($selectData);
			$data_ID = $rowData['ID'];
			$data_filename = stripcslashes($rowData['filename']);
			$data_description = stripcslashes($rowData['description']);

            $files = '';
            $arr_item = array();
            if (!empty($rowData["file_history"])) {
                $arr_item = json_decode($rowData["file_history"],true);
            }
            $filetype = $_POST['filetype'];
            if ($filetype > 0) {
                if ($filetype == 1) {
                    $files = $_FILES['file']['name'];
                    if (!empty($files)) {
                        $path = 'uploads/';
                        $filesize = $_FILES['file']['size'];
                        $tmp = $_FILES['file']['tmp_name'];
                        $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                        $ext = strtolower(pathinfo($files, PATHINFO_EXTENSION));
                        $files = rand(1000,1000000) . ' - ' . $files;
                        $path = $path.$files;

                        if(!in_array($ext, $invalid_extensions)) {
                            move_uploaded_file($tmp,$path);

                            $filesize_tot = $filesize + $rowData["filesize"];

                            mysqli_query( $conn,"UPDATE tbl_hr_file SET filesize='". $filesize_tot ."', uploaded_date = '".$last_modified."' WHERE ID='". $ID ."'" );
                        } else {
                            $process = false;
                        }
                    }
                } else {
                    $files = $_POST['fileurl'];
                    $filesize = 0;
                }

                if (!empty($files) AND $process == true) {
                    $output = array (
                        'type'  =>  $filetype,
                        'name' =>  $files,
                        'size' =>  $filesize,
                        'date' =>  $local_date
                    );
                    array_push($arr_item, $output);
                    $file_history = json_encode($arr_item, JSON_HEX_APOS | JSON_UNESCAPED_UNICODE);

                    mysqli_query( $conn,"UPDATE tbl_hr_file SET files='". $files ."', filetype='". $filetype ."', file_history='". $file_history ."' WHERE ID='". $ID ."'" );
                }
            }

            if ($process == true) {
    			$data_files = $rowData['files'];
    			$type = 'iframe';
    			if (!empty($data_files)) {
    				if ($filetype == 1) {
    					$fileExtension = fileExtension($data_files);
    					$src = $fileExtension['src'];
    					$embed = $fileExtension['embed'];
    					$type = $fileExtension['type'];
    					$file_extension = $fileExtension['file_extension'];
    		            $url = $base_url.'uploads/hr/';

    		            $data_files = $src.$url.rawurlencode($data_files).$embed;
    				} else if ($filetype == 3) {
    					$data_files = preg_replace('#[^/]*$#', '', $data_files).'preview';
    				}
    	            $files = '<p style="margin: 0;"><a data-src="'.$data_files.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a></p>';
    			}

                $data_uploaded_date = $rowData['uploaded_date'];
                $data_uploaded_date = new DateTime($data_uploaded_date);
                $data_uploaded_date = $data_uploaded_date->format('M d, Y');

                $data_date_start = new DateTime($date_start);
                $data_date_start = $data_date_start->format('M d, Y');
                
                $data_date_end = new DateTime($date_end);
                $data_date_end = $data_date_end->format('M d, Y');

    			$output = array(
                    "ID" => $data_ID,
                    "files" => $files,
                    "filename" => $data_filename,
                    "description" => $data_description,
                    "start_date" => $data_date_start,
                    "due_date" => $data_date_end,
                    "uploaded_date" => $data_uploaded_date
                );
                mysqli_close($conn);
                echo json_encode($output);
    		}
        }
	}
	
	
	// JOB DESCRIPTION PAGE
    if( isset($_GET['modalView_HR_Job_Description_Type']) ) {
        if (!empty($_COOKIE['switchAccount'])) {
            $portal_user = $_COOKIE['ID'];
            $user_id = $_COOKIE['switchAccount'];
        }
        else {
            $portal_user = $_COOKIE['ID'];
            $user_id = employerID($portal_user);
        }

        $id = $_GET['modalView_HR_Job_Description_Type'];
        $status = $_GET['status'];
        $result = mysqli_query( $conn,"SELECT
            j.ID AS j_ID,
            j.user_id AS j_user_id,
            j.title AS j_title,
            j.description AS j_description,
            j.files AS j_files,
            j.filetype AS j_filetype,
            j.status AS j_status,

            -- t.ID AS t_ID,
            COUNT(t.job_description_id) AS t_job_description_id

            FROM tbl_hr_job_description AS j
            LEFT JOIN (
                SELECT
                ID, 
                user_id,
                job_description_id
                FROM tbl_hr_trainings
                WHERE status = 1
                AND user_id = $user_id
                AND deleted = 0
            ) AS t 
            ON FIND_IN_SET(j.ID, REPLACE(t.job_description_id, ' ', ''))
            WHERE j.status = $status
            AND FIND_IN_SET($id, REPLACE(j.department_id, ' ', ''))
            AND j.user_id = $user_id
            GROUP BY j.ID

            ORDER BY j.title" );
        if ( mysqli_num_rows($result) > 0 ) {
            $table_counter = 1;
            while($row = mysqli_fetch_array($result)) {
                $filetype = $row['j_filetype'];
                $files = $row["j_files"];
                $type = 'iframe';
                if (!empty($files)) {
                    if ($filetype == 1) {
                        $fileExtension = fileExtension($files);
                        $src = $fileExtension['src'];
                        $embed = $fileExtension['embed'];
                        $type = $fileExtension['type'];
                        $file_extension = $fileExtension['file_extension'];
                        $url = $base_url.'uploads/';

                        $files = $src.$url.rawurlencode($files).$embed;
                    } else if ($filetype == 3) {
                        $files = preg_replace('#[^/]*$#', '', $files).'preview';
                    }
                }

                echo '<tr id="tr_'. $row["j_ID"] .'">
                    <td>'. $table_counter .'</td>
                    <td>'. htmlentities($row["j_title"]) .'</td>
                    <td>'. htmlentities($row["j_description"]) .'</td>
                    <td>'. $row["t_job_description_id"] .'</td>
                    <td class="text-center"><p class="'; echo !empty($files) ? '':'hide'; echo '" style="margin: 0;"><a href="'.$files.'" data-src="'.$files.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a></p></td>';

                    if ( $row["j_status"] == 0 ) {
                        echo '<td class="text-center"><span class="label label-sm label-danger">Inactive</span></td>';
                    } else if ( $row["j_status"] == 1 ) {
                        echo '<td class="text-center"><span class="label label-sm label-success">Active</span></td>';
                    } else {
                        echo '<td class="text-center"><span class="label label-sm label-warning">Suspended</span></td>';
                    }

                    echo '<td class="text-center">
                        <a href="#modalView" class="btn btn-outline dark btn-sm btnView" data-toggle="modal" onclick="btnView('. $row["j_ID"].', '.$table_counter++.', \'modalView\')">View</a>
                    </td>
                </tr>';
            }
            
        } else {
            echo '<tr class="text-center text-default"><td colspan="6">Empty Record</td></tr>';
        }

        mysqli_close($conn);
    }
	if( isset($_GET['modalView_HR_Job_Description']) ) {
		$ID = $_GET['modalView_HR_Job_Description'];
        $c = $_GET['c'];

        $selectData = mysqli_query( $conn,"SELECT * FROM tbl_hr_job_description WHERE ID = $ID" );
        if ( mysqli_num_rows($selectData) > 0 ) {
            $row = mysqli_fetch_array($selectData);
            $user_id = $row['user_id'];

			$filetype = $row['filetype'];
			$files = $row["files"];
			$type = 'iframe';
			if (!empty($files)) {
				if ($filetype == 1) {
				    $fileExtension = fileExtension($files);
					$src = $fileExtension['src'];
					$embed = $fileExtension['embed'];
					$type = $fileExtension['type'];
					$file_extension = $fileExtension['file_extension'];
				    $url = $base_url.'uploads/';

				    $files = $src.$url.rawurlencode($files).$embed;
				} else if ($filetype == 3) {
					$files = preg_replace('#[^/]*$#', '', $files).'preview';
				}
			}
        }

        echo '<input class="form-control" type="hidden" name="ID" value="'. $row['ID'] .'" />
        <input class="form-control" type="hidden" name="c" value="'. $c .'" />
        <input class="form-control" type="hidden" name="files" id="files" value="'. $row['files'] .'" />
        <div class="form-group">
            <label class="col-md-3 control-label">Title</label>
            <div class="col-md-8">
                <input class="form-control" type="text" name="title" value="'. $row['title'] .'" required />
            </div>
        </div>
        <div class="form-group">
            <label class="col-md-3 control-label">Description</label>
            <div class="col-md-8">
                <textarea class="form-control" name="description" style="height:100px !important;" required >'. $row['description'] .'</textarea>
            </div>
        </div>
        <div class="form-group">
            <label class="col-md-3 control-label">Department</label>
            <div class="col-md-8">
                <select class="form-control mt-multiselect btn btn-default" name="department_id[]" multiple="multiple">';

                    $array_Dept = explode(", ", $row["department_id"]);
                    $selectDepartment = mysqli_query( $conn,"SELECT * FROM tbl_hr_department WHERE status = 1 AND user_id = $user_id ORDER BY title" );
                    if ( mysqli_num_rows($selectDepartment) > 0 ) {
                        while($rowDepartment = mysqli_fetch_array($selectDepartment)) {
                            if (in_array($rowDepartment["ID"], $array_Dept)) {
                                echo '<option value="'. $rowDepartment["ID"] .'" selected>'. $rowDepartment["title"] .'</option>';
                            } else {
                                echo '<option value="'. $rowDepartment["ID"] .'">'. $rowDepartment["title"] .'</option>';
                            }
                        }
                    } else {
                        echo '<option disabled>No Available</option>';
                    }

                echo '</select>
            </div>
        </div>
        <div class="form-group">
            <label class="col-md-3 control-label">Reporting To</label>
            <div class="col-md-8">
                <select class="form-control mt-multiselect btn btn-default" name="reporting_to_id">';

                    $array_Job = explode(", ", $row["reporting_to_id"]);
                    $resultJob = mysqli_query( $conn,"SELECT * FROM tbl_hr_job_description WHERE status = 1 AND user_id = $user_id ORDER BY title" );
                    if ( mysqli_num_rows($resultJob) > 0 ) {
                        echo '<option value="">Select</option>';
                        while($rowJob = mysqli_fetch_array($resultJob)) {
                            if (in_array($rowJob["ID"], $array_Job)) {
                                echo '<option value="'. $rowJob["ID"] .'" selected>'. $rowJob["title"] .'</option>';
                            } else {
                                echo '<option value="'. $rowJob["ID"] .'">'. $rowJob["title"] .'</option>';
                            }
                        }
                    } else {
                        echo '<option value="" disabled>No Available</option>';
                    }

                echo '</select>
            </div>
        </div>
        <div class="form-group">
            <label class="control-label col-md-3">Exempt</label>
            <div class="col-md-8">
                <input type="checkbox" class="make-switch" name="exempt" id="exempt" data-off-text="No" data-on-text="Yes" data-on-color="info" data-off-color="default"'; echo $row['exempt'] === "1" ? "checked" : "";  echo '>
            </div>
        </div>
        <div class="form-group">
            <label class="col-md-3 control-label">Document</label>
            <div class="col-md-8">
                <select class="form-control '; echo !empty($files) ? 'hide':''; echo '" name="filetype" onchange="changeType(this)" required>
                    <option value="0">Select option</option>
                    <option value="1">Manual Upload</option>
                    <option value="2">Youtube URL</option>
                    <option value="3">Google Drive URL</option>
                </select>
                <input class="form-control margin-top-15 fileUpload" type="file" name="file" style="display: none;" />
                <input class="form-control margin-top-15 fileURL" type="url" name="fileurl" style="display: none;" placeholder="https://" />
                <p class="'; echo !empty($files) ? '':'hide'; echo '" style="margin: 0;"><a href="'.$files.'" data-src="'.$files.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a> | <button type="button" class="btn btn-link uploadNew" onclick="uploadNew(this)">Upload New</button></p>
            </div>
        </div>
        <div class="form-group">
            <label class="control-label col-md-3">Status</label>
            <div class="col-md-8">
            	<input type="checkbox" class="make-switch" name="status" data-on-text="Active" data-off-text="Inactive" data-on-color="success" data-off-color="danger"'; echo $row['status'] === "1" ? "checked" : "";  echo '>
            </div>
        </div>

        <ul class="nav nav-tabs">
            <li class="active">
                <a href="#tabTraining" data-toggle="tab">Required Training</a>
            </li>
            <li>
                <a href="#tabEmployee" data-toggle="tab">Employees</a>
            </li>
        </ul>
        <div class="tab-content margin-top-20">
            <div class="tab-pane active" id="tabTraining">
                <div class="form-group">
                    <label class="col-md-1 control-label"></label>
                    <div class="col-md-10">
                        <div class="portlet-body">
                            <div class="table-scrollable">
                                <table class="table table-bordered table-hover">
                                    <thead>
                                        <tr>
                                            <th>Nos.</th>
                                            <th>Title</th>
                                            <th>Description</th>
                                            <th class="text-center" style="width: 90px;">Document</th>
                                            <th class="text-center" style="width: 90px;">Annual Review</th>
                                            <th class="text-center" style="width: 90px;">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>';
                                        
                                        $selectTrainings = mysqli_query( $conn,"SELECT * FROM tbl_hr_trainings WHERE status = 1 AND deleted = 0 AND user_id = $user_id ORDER BY title" );
                                        if ( mysqli_num_rows($selectTrainings) > 0 ) {
                                            $countTraining = 0;
                                            $counting = 1;
                                            while($rowTraining = mysqli_fetch_array($selectTrainings)) {
                                                $array_jd = explode(", ", $rowTraining["job_description_id"]);
                                                foreach ($array_jd as $value) {
                                                    if ( $value == $row["ID"] ) {
                                                        $countTraining++;

                                                        // $filetype = $rowTraining['filetype'];
                                                        $files = $rowTraining["files"];
                                                        // $type = 'iframe';
                                                        // if ($filetype == 1) {
                                                        //     $fileExtension = fileExtension($files);
                                                        //     $src = $fileExtension['src'];
                                                        //     $embed = $fileExtension['embed'];
                                                        //     $type = $fileExtension['type'];
                                                        //     $file_extension = $fileExtension['file_extension'];
                                                        //     $url = $base_url.'uploads/';

                                                        //     $files = $src.$url.rawurlencode($files).$embed;
                                                        // } else if ($filetype == 3) {
                                                        //     $files = preg_replace('#[^/]*$#', '', $files).'preview';
                                                        // }

                                                        $last_modified = $rowTraining["last_modified"];
                                                        $last_modified = new DateTime($last_modified);
                                                        $last_modified = $last_modified->format('M d, Y');

                                                        echo '<tr>
                                                            <td>'. $counting++ .'</td>
                                                            <td>'. htmlentities($rowTraining["title"]) .'</td>
                                                            <td>'. htmlentities($rowTraining["description"]) .'</td>
                                                            <td class="text-center"><p class="'; echo !empty($files) ? '':'hide'; echo '" style="margin: 0;"><a href="#modalViewTraining" data-toggle="modal" class="btn btn-link" onclick="btnViewTraining('.$rowTraining["ID"].')">View</a></p></td>
                                                            <td class="text-center">'.$last_modified.'</td>
                                                            <td class="text-center">';

                                                                if ( $rowTraining["status"] == 0 ) {
                                                                    echo '<span class="label label-sm label-danger">Inactive</span>';
                                                                } else if ( $rowTraining["status"] == 1 ) {
                                                                    echo '<span class="label label-sm label-success">Active</span>';
                                                                } else {
                                                                    echo '<span class="label label-sm label-warning">Suspended</span>';
                                                                }

                                                            echo '</td>
                                                        </tr>';
                                                    }
                                                }
                                            }

                                            if ( $countTraining < 1 ) {
                                                echo '<tr class="text-center text-default"><td colspan="6">Empty Record</td></tr>';
                                            }
                                        } else {
                                            echo '<tr class="text-center text-default"><td colspan="6">Empty Record</td></tr>';
                                        }
                                        
                                    echo '</tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="tab-pane" id="tabEmployee">
                <div class="form-group">
                    <label class="col-md-1 control-label"></label>
                    <div class="col-md-10">
                        <div class="portlet-body">
                            <div class="table-scrollable">
                                <table class="table table-bordered table-hover">
                                    <thead>
                                        <tr>
                                            <th>Nos.</th>
                                            <th>First Name</th>
                                            <th>Last Name</th>
                                            <th>Email</th>
                                        </tr>
                                    </thead>
                                    <tbody>';

                                        $selectEmployee = mysqli_query( $conn,"SELECT * FROM tbl_hr_employee WHERE suspended = 0 AND status = 1 AND user_id = $user_id AND job_description_id IN ($ID) ORDER BY first_name" );
                                        if ( mysqli_num_rows($selectEmployee) > 0 ) {
                                            $counting = 1;
                                            while($rowEmployee = mysqli_fetch_array($selectEmployee)) {
                                                echo '<tr>
                                                    <td>'. $counting++ .'</td>
                                                    <td>'. $rowEmployee["first_name"] .'</td>
                                                    <td>'. $rowEmployee["last_name"] .'</td>
                                                    <td>'. $rowEmployee["email"] .'</td>
                                                </tr>';
                                            }
                                        } else {
                                            echo '<tr class="text-center text-default"><td colspan="4">Empty Record</td></tr>';
                                        }

                                    echo '</tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>';

        mysqli_close($conn);
	}
    if( isset($_GET['modalView_HR_Job_Description_Training']) ) {
        $id = $_GET['modalView_HR_Job_Description_Training'];

        $selectData = mysqli_query( $conn,"SELECT * FROM tbl_hr_trainings WHERE ID = $id" );
        if ( mysqli_num_rows($selectData) > 0 ) {
            $row = mysqli_fetch_array($selectData);
            $user_id = $row['user_id'];
            $type = $row['type'];
            $t_quiz_id = $row['quiz_id'];
            $t_job_description_id = $row["job_description_id"];

            $files = $row['files'];
            if (!empty($files)) {
                $output_file = json_decode($files,true);
            }
        }

        echo '<table class="table table-bordered table-hover">
            <thead>
                <tr>
                    <th>Language</th>
                    <th class="text-center" style="width: 90px;">Action</th>
                </tr>
            </thead>
            <tbody>';

                if (!empty($output_file)) {
                    foreach ($output_file as $key => $value) {
                        $file_lang = $value['file_lang'];

                        $filetype = 1;
                        if (!empty($value['file_type'])) { $filetype = $value['file_type']; }

                        $file_doc = $value['file_doc'];
                        $file_doc_temp = $value['file_doc'];
                        $type = 'iframe';
                        if ($filetype == 1) {
                            $fileExtension = fileExtension($file_doc);
                            $src = $fileExtension['src'];
                            $embed = $fileExtension['embed'];
                            $type = $fileExtension['type'];
                            $file_extension = $fileExtension['file_extension'];
                            $url = $base_url.'uploads/';

                            $file_doc = $src.$url.rawurlencode($file_doc).$embed;
                        } else if ($filetype == 3) {
                            $file_doc = preg_replace('#[^/]*$#', '', $file_doc).'preview';
                        }

                        if (!empty($file_doc)) {
                            echo '<tr>
                                <td>'.$file_lang.'</td>
                                <td class="text-center"><a href="'.$file_doc.'" data-src="'.$file_doc.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a></td>
                            </tr>';
                        }
                    }
                }

            echo '</tbody>
        </table>';

        mysqli_close($conn);
    }
	if( isset($_POST['btnSave_HR_Job_Description']) ) {
		$ID = $_POST['ID'];
		$title = addslashes($_POST['title']);
		$description = addslashes($_POST['description']);
        $arr_item = array();
        $process = true;
        
        $department_id = '';
        if (!empty($_POST['department_id'])) {
            $department_id = implode(", ",$_POST['department_id']);
        }

		$filetype = $_POST['filetype'];
		if ($filetype == 1) {
			$files = $_FILES['file']['name'];
			if (!empty($files)) {
				$path = 'uploads/';
                $filesize = $_FILES['file']['size'];
				$tmp = $_FILES['file']['tmp_name'];
                $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                $ext = strtolower(pathinfo($files, PATHINFO_EXTENSION));
				$files = rand(1000,1000000) . ' - ' . $files;
				$path = $path.$files;

                if(!in_array($ext, $invalid_extensions)) {
                    move_uploaded_file($tmp,$path);
                } else {
                    $process = false;
                }
			}
		} else {
			$files = $_POST['fileurl'];
            $filesize = 0;
		}

        if ($process == true) {
            $output = array (
                'type'  =>  $filetype,
                'name' =>  $files,
                'size' =>  $filesize,
                'date' =>  $local_date
            );
            array_push($arr_item, $output);
            $file_history = json_encode($arr_item, JSON_HEX_APOS | JSON_UNESCAPED_UNICODE);

            $sql = "INSERT INTO tbl_hr_job_description (user_id, title, description, department_id, files, filetype, filesize, file_history)
            VALUES ('$ID', '$title', '$description', '$department_id', '$files', '$filetype', '$filesize', '$file_history')";
        
    		if (mysqli_query($conn, $sql)) {

    			$last_id = mysqli_insert_id($conn);
                $selectData = mysqli_query( $conn,"SELECT * FROM tbl_hr_job_description WHERE ID = $last_id" );
    			
    			if ( mysqli_num_rows($selectData) > 0 ) {
    				$rowData = mysqli_fetch_array($selectData);
    				$data_ID = $rowData['ID'];
    				$data_title = stripcslashes($rowData['title']);
    				$data_description = stripcslashes($rowData['description']);

                    $filetype = $rowData['filetype'];
                    $files = $rowData["files"];
                    $type = 'iframe';
                    if (!empty($files)) {
                        if ($filetype == 1) {
                            $fileExtension = fileExtension($files);
                            $src = $fileExtension['src'];
                            $embed = $fileExtension['embed'];
                            $type = $fileExtension['type'];
                            $file_extension = $fileExtension['file_extension'];
                            $url = $base_url.'uploads/';

                            $files = $src.$url.rawurlencode($files).$embed;
                        } else if ($filetype == 3) {
                            $files = preg_replace('#[^/]*$#', '', $files).'preview';
                        }
                    }
                    $viewFile = '<p class="'; $viewFile .= !empty($files) ? '':'hide'; $viewFile .= '" style="margin: 0;"><a href="'.$files.'" data-src="'.$files.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a></p>';

    		        $countTraining = 0;
    				$selectTrainings = mysqli_query( $conn,"SELECT * FROM tbl_hr_trainings" );
    		        while($rowTraining = mysqli_fetch_array($selectTrainings)) {
    		            $array_jd = explode(", ", $rowTraining["job_description_id"]);
    		            foreach ($array_jd as $value) {
    		                if ( $value == $data_ID ) {
    		                    $countTraining++;
    		                }
    		            }
    		        }

                	$counterup_tbl = counterup_tbl('job-description');
    				$output = array(
    					'ID' => $data_ID,
    					'title' => $title,
    					'description' => $description,
                        'viewFile' => $viewFile,
    					'countTraining' => $countTraining
    				);

    				$result = array_merge($counterup_tbl, $output);
    				echo json_encode($result);
    			}
    		}
    		mysqli_close($conn);
        }
	}
	if( isset($_POST['btnUpdate_HR_Job_Description']) ) {
		$ID = $_POST['ID'];
        $c = $_POST['c'];
		$title = addslashes($_POST['title']);
		$description = addslashes($_POST['description']);
        $reporting_to_id = $_POST['reporting_to_id'];
		$files = $_POST['files'];
        $exempt = isset($_POST['exempt']) ? 1 : 0;
		$status = isset($_POST['status']) ? 1 : 0;
		$status_last_modified = date('Y-m-d');
        $process = true;
        
        $department_id = '';
        if (!empty($_POST['department_id'])) {
            $department_id = implode(", ",$_POST['department_id']);
        }

		mysqli_query( $conn,"UPDATE tbl_hr_job_description set title='". $title ."', description='". $description ."', department_id='". $department_id ."', reporting_to_id='". $reporting_to_id ."', exempt='". $exempt ."', status='". $status ."', last_modified='". $status_last_modified ."' WHERE ID='". $ID ."'" );
		if (!mysqli_error($conn)) {

            $selectData = mysqli_query( $conn,"SELECT * FROM tbl_hr_job_description WHERE ID = $ID" );
            if ( mysqli_num_rows($selectData) > 0 ) {
                $rowData = mysqli_fetch_array($selectData);
                $data_ID = $rowData['ID'];
                $data_title = stripcslashes($rowData['title']);
                $data_description = stripcslashes($rowData['description']);

                $files = '';
                $arr_item = array();
                if (!empty($rowData["file_history"])) {
                    $arr_item = json_decode($rowData["file_history"],true);
                }
                
                $filetype = $_POST['filetype'];
                if ($filetype > 0) {
                    if ($filetype == 1) {
                        $files = $_FILES['file']['name'];
                        if (!empty($files)) {
                            $path = 'uploads/';
                            $filesize = $_FILES['file']['size'];
                            $tmp = $_FILES['file']['tmp_name'];
                            $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                            $ext = strtolower(pathinfo($files, PATHINFO_EXTENSION));
                            $files = rand(1000,1000000) . ' - ' . $files;
                            $path = $path.$files;

                            if(!in_array($ext, $invalid_extensions)) {
                                move_uploaded_file($tmp,$path);

                                $filesize_tot = $filesize + $rowData["filesize"];

                                mysqli_query( $conn,"UPDATE tbl_hr_job_description SET files='". $files ."', filetype='". $filetype ."', filesize='". $filesize_tot ."' WHERE ID='". $ID ."'" );

                                $fileExtension = fileExtension($files);
                                $src = $fileExtension['src'];
                                $embed = $fileExtension['embed'];
                                $type = $fileExtension['type'];
                                $file_extension = $fileExtension['file_extension'];
                                $url = $base_url.'uploads/';

                                $files = $src.$url.rawurlencode($files).$embed;

                                $viewFile = '<p class="'; $viewFile .= !empty($files) ? '':'hide'; $viewFile .= '" style="margin: 0;"><a href="'.$files.'" data-src="'.$files.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a></p>';
                            } else {
                                $process = false;
                            }
                        }
                    } else {
                        $files = $_POST['fileurl'];
                        $filesize = 0;
                        $type = 'iframe';

                        mysqli_query( $conn,"UPDATE tbl_hr_job_description SET files='". $files ."', filetype='". $filetype ."' WHERE ID='". $ID ."'" );

                        if ($filetype == 3) {
                            $files = preg_replace('#[^/]*$#', '', $files).'preview';
                        }
                        $viewFile = '<p class="'; $viewFile .= !empty($files) ? '':'hide'; $viewFile .= '" style="margin: 0;"><a href="'.$files.'" data-src="'.$files.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a></p>';
                    }

                    if (!empty($files) AND $process == true) {
                        $output = array (
                            'type'  =>  $filetype,
                            'name' =>  $files,
                            'size' =>  $filesize,
                            'date' =>  $local_date
                        );
                        array_push($arr_item, $output);
                        $file_history = json_encode($arr_item, JSON_HEX_APOS | JSON_UNESCAPED_UNICODE);

                        mysqli_query( $conn,"UPDATE tbl_hr_job_description SET file_history='". $file_history ."' WHERE ID='". $ID ."'" );
                    }
                } else {
                    $filetype = $rowData['filetype'];
                    $files = $rowData["files"];
                    $type = 'iframe';
                    if (!empty($files)) {
                        if ($filetype == 1) {
                            $fileExtension = fileExtension($files);
                            $src = $fileExtension['src'];
                            $embed = $fileExtension['embed'];
                            $type = $fileExtension['type'];
                            $file_extension = $fileExtension['file_extension'];
                            $url = $base_url.'uploads/';

                            $files = $src.$url.rawurlencode($files).$embed;
                        } else if ($filetype == 3) {
                            $files = preg_replace('#[^/]*$#', '', $files).'preview';
                        }
                    }
                    $viewFile = '<p class="'; $viewFile .= !empty($files) ? '':'hide'; $viewFile .= '" style="margin: 0;"><a href="'.$files.'" data-src="'.$files.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a></p>';
                }

                if ($process == true) {
                    $countTraining = 0;
                    $selectTrainings = mysqli_query( $conn,"SELECT * FROM tbl_hr_trainings" );
                    while($rowTraining = mysqli_fetch_array($selectTrainings)) {
                        $array_jd = explode(", ", $rowTraining["job_description_id"]);
                        foreach ($array_jd as $value) {
                            if ( $value == $data_ID ) {
                                $countTraining++;
                            }
                        }
                    }

                    $counterup_tbl = counterup_tbl('job-description');
                    $output = array(
                        'ID' => $data_ID,
                        'c' => $c,
                        'title' => $title,
                        'description' => $description,
                        'viewFile' => $viewFile,
                        'countTraining' => $countTraining,
                        'status' => $status
                    );

                    $result = array_merge($counterup_tbl, $output);
                    echo json_encode($result);
                    mysqli_close($conn);
                }
            }
		}

	}


	// TRAINING PAGE
	if( isset($_GET['modalNew_HR_Trainings']) ) {
		if (!empty($_COOKIE['switchAccount'])) {
			$portal_user = $_COOKIE['ID'];
			$user_id = $_COOKIE['switchAccount'];
		}
		else {
			$portal_user = $_COOKIE['ID'];
			$user_id = employerID($portal_user);
		}
		
		echo '<div class="form-group">
            <label class="col-md-3 control-label">Type</label>
            <div class="col-md-8">
                <select class="form-control" name="type" onchange="selectType(this)">
                    <option value="">Select</option>';

                    $result = mysqli_query( $conn,"SELECT * FROM tbl_hr_trainings_type ORDER BY name" );
                    if ( mysqli_num_rows($result) > 0 ) {
                        while($row = mysqli_fetch_array($result)) {
                            $ID = $row['ID'];
                            $name = $row['name'];
	                        $records = 0;

	                        $selectTrainings = mysqli_query( $conn,'SELECT * FROM tbl_hr_trainings WHERE deleted = 0 AND user_id="'.$user_id.'" AND type="'. $ID .'"' );
	                        if ( mysqli_num_rows($selectTrainings) > 0 ) {
	                            while($row = mysqli_fetch_array($selectTrainings)) {
	                                $records++;
	                            }
	                        }

	                        if ($records > 0) {
	                            echo '<option value="'.$ID.'">'. $name.'</option>';
	                        }
                        }
                    }

                    echo '<option value="other">Other</option>
                </select>
                <input class="form-control margin-top-15 type_other '; echo mysqli_num_rows($result) > 0 ? 'hide':''; echo '" type="text" name="type_other" placeholder="If other, please specific here" required />
            </div>
        </div>
        <div class="form-group">
            <label class="col-md-3 control-label">Title</label>
            <div class="col-md-8">
                <input class="form-control" type="text" name="title" required />
            </div>
        </div>
        <div class="form-group">
            <label class="col-md-3 control-label">Description</label>
            <div class="col-md-8">
                <textarea class="form-control" name="description" style="height:150px;" required ></textarea>
            </div>
        </div>
        <div class="form-group">
            <label class="col-md-3 control-label">Job Description</label>
            <div class="col-md-8">
                <select class="form-control mt-multiselect btn btn-default" name="job_description_id[]" multiple="multiple" required>';

                    $result = mysqli_query( $conn,"SELECT * FROM tbl_hr_job_description WHERE status = 1 and user_id = $user_id ORDER BY title" );
                    if ( mysqli_num_rows($result) > 0 ) {
                        while($row = mysqli_fetch_array($result)) {
                            echo '<option value="'. $row["ID"] .'">'. $row["title"] .'</option>';
                        }
                    } else {
                        echo '<option value="" disabled>No Available</option>';
                    }

                echo '</select>
            </div>
        </div>
        <div class="form-group">
            <label class="col-md-3 control-label">Frequency</label>
            <div class="col-md-8">
                <select class="form-control mt-multiselect btn btn-default" name="frequency" required>
                    <option value="0">Monthly</option>
                    <option value="1">Quarterly</option>
                    <option value="2">Bi-Annual</option>
                    <option value="3">Annually</option>
                </select>
            </div>
        </div>
        <div class="form-group">
            <label class="col-md-3 control-label">Document</label>
            <div class="col-md-8">
                <div class="mt-repeater mt-repeater-file">
                    <div data-repeater-list="document">
                        <div class="mt-repeater-item row" data-repeater-item>
                            <div class="col-md-6">
                                <select class="form-control" name="filetype" onchange="changeType(this)" required>
					            	<option value="0">Select option</option>
					            	<option value="1">Manual Upload</option>
					            	<option value="2">Youtube URL</option>
					            	<option value="3">Google Drive URL</option>
					            </select>
					            <input class="form-control margin-top-15 fileUpload" type="file" name="file" style="display: none;" />
					            <input class="form-control margin-top-15 fileURL" type="url" name="fileurl" style="display: none;" placeholder="https://" />
                            </div>
                            <div class="col-md-4">
                                <select class="form-control" name="language" required="">
                                    <option value="0">English</option>
                                    <option value="1">Spanish</option>
                                    <option value="2">Arabic</option>
                                </select>
                            </div>
                            <div class="col-md-2 text-right">
                                <a href="javascript:;" data-repeater-delete class="btn btn-danger"><i class="fa fa-close"></i></a>
                            </div>
                        </div>
                    </div>
                    <div class="filePprogressBar"></div>
                    <a href="javascript:;" data-repeater-create class="btn btn-success mt-repeater-add"><i class="fa fa-plus"></i> Add more</a>
                </div>
            </div>
        </div>
        <div class="form-group">
            <label class="col-md-3 control-label">Select Quiz</label>
            <div class="col-md-8">
                <select class="form-control mt-multiselect btn btn-default" name="quiz_id[]" multiple="multiple">';

                    $result = mysqli_query( $conn,"SELECT * FROM tbl_hr_quiz_set WHERE status = 1 and user_id = $user_id ORDER BY title" );
                    if ( mysqli_num_rows($result) > 0 ) {
                        while($row = mysqli_fetch_array($result)) {
                            echo '<option value="'. $row["ID"] .'">'. $row["title"] .'</option>';
                        }
                    } else {
                        echo '<option value="" disabled>No Available</option>';
                    }

                echo '</select>
                <i class="text-muted">(Quiz not listed? Click here to <a href="'.$base_url.'quiz" target="_blank">add more</a>)</i>
            </div>
        </div>
        <div class="form-group uploadPercentage hide">
            <label class="col-md-3 control-label"></label>
            <div class="col-md-8">
                <div class="progress-info">
                    <div class="progress">
                        <span class="progress-bar progress-bar-success green-sharp" style="width: 0%;"></span>
                    </div>
                    <div class="status">
                        <div class="status-title">Uploading...</div><div class="status-number">0%</div>
                    </div>
                </div>
            </div>
        </div>';
	}
	if( isset($_GET['modalView_HR_Trainings']) ) {
		$id = $_GET['modalView_HR_Trainings'];
        $c = $_GET['c'];
		
		if (!empty($_COOKIE['switchAccount'])) {
			$portal_user = $_COOKIE['ID'];
			$user_id = $_COOKIE['switchAccount'];
		}
		else {
			$portal_user = $_COOKIE['ID'];
			$user_id = employerID($portal_user);
		}

        $selectData = mysqli_query( $conn,"SELECT * FROM tbl_hr_trainings WHERE ID = $id" );
        if ( mysqli_num_rows($selectData) > 0 ) {
            $row = mysqli_fetch_array($selectData);
            $user_id = $row['user_id'];
            $type = $row['type'];
            $t_quiz_id = $row['quiz_id'];
            $t_job_description_id = $row["job_description_id"];

            $files = $row['files'];
            if (!empty($files)) {
                $output_file = json_decode($files,true);
            }
        }

        echo '<input class="form-control" type="hidden" name="ID" value="'. $row['ID'] .'" />
        <input class="form-control" type="hidden" name="c" value="'. $c .'" />
        <div class="tabbable tabbable-tabdrop">
            <ul class="nav nav-tabs">
                <li class="active">
                    <a href="#tabBasic" data-toggle="tab">Training Details</a>
                </li>
                <li>
                    <a href="#tabTraining" data-toggle="tab">Training Progress</a>
                </li>
            </ul>
            <div class="tab-content margin-top-20">
                <div class="tab-pane active dashboard-stat2" id="tabBasic" style="padding: 0;">
                    <div class="form-group">
                        <label class="col-md-3 control-label">Type</label>
                        <div class="col-md-8">
                            <select class="form-control" name="type" onchange="selectType(this)">
                                <option value="">Select</option>';

                                $resultType = mysqli_query( $conn,"SELECT * FROM tbl_hr_trainings_type ORDER BY name" );
                                if ( mysqli_num_rows($resultType) > 0 ) {
                                    while($rowType = mysqli_fetch_array($resultType)) {
                                        $ID = $rowType['ID'];
                                        $name = $rowType['name'];
                                        $records = 0;

                                        $selectTrainings = mysqli_query( $conn,'SELECT * FROM tbl_hr_trainings WHERE deleted = 0 AND user_id="'.$user_id.'" AND type="'. $ID .'"' );
                                        if ( mysqli_num_rows($selectTrainings) > 0 ) {
                                            while($rowTrainings = mysqli_fetch_array($selectTrainings)) {
                                                $records++;
                                            }
                                        }

                                        if ($records > 0) {
                                            echo '<option value="'.$ID.'" '; echo $type == $ID ? 'SELECTED':''; echo '>'. $name.'</option>';
                                        }
                                    }
                                }

                                echo '<option value="other">Other</option>
                            </select>
                            <input class="form-control margin-top-15 type_other '; echo mysqli_num_rows($resultType) > 0 ? 'hide':''; echo '" type="text" name="type_other" placeholder="If other, please specific here" required />
                        </div>
                    </div>
			        <div class="form-group">
			            <label class="col-md-3 control-label">Title</label>
			            <div class="col-md-8">
			                <input class="form-control" type="text" name="title" value="'. $row['title'] .'" required />
			            </div>
			        </div>
			        <div class="form-group">
			            <label class="col-md-3 control-label">Description</label>
			            <div class="col-md-8">
			                <textarea class="form-control" name="description" style="height:100px !important;" required >'. $row['description'] .'</textarea>
			            </div>
			        </div>
			        <div class="form-group">
			            <label class="col-md-3 control-label">Job Description</label>
			            <div class="col-md-8">
			            	<select class="form-control mt-multiselect btn btn-default" name="job_description_id[]" multiple="multiple">';
			                    
			                    $array_jd = explode(", ", $row["job_description_id"]);
			                    $resultJD = mysqli_query( $conn,"SELECT * FROM tbl_hr_job_description WHERE status = 1 and user_id = $user_id ORDER BY title" );
			                    if ( mysqli_num_rows($resultJD) > 0 ) {
			                        while($rowJD = mysqli_fetch_array($resultJD)) {
										if (in_array($rowJD["ID"], $array_jd)) {
											echo '<option value="'. $rowJD["ID"] .'" selected>'. $rowJD["title"] .'</option>';
										} else {
											echo '<option value="'. $rowJD["ID"] .'">'. $rowJD["title"] .'</option>';
										}
			                        }
			                    } else {
			                    	echo '<option value="" disabled>No Available</option>';
			                    }
			                    
			                echo '</select>
			            </div>
			        </div>
                    <div class="form-group">
                        <label class="col-md-3 control-label">Frequency</label>
                        <div class="col-md-8">
                            <select class="form-control mt-multiselect btn btn-default" name="frequency" required>
                                <option value="0" '; echo $row['frequency'] == 0 ? 'SELECTED':''; echo '>Monthly</option>
                                <option value="1" '; echo $row['frequency'] == 1 ? 'SELECTED':''; echo '>Quarterly</option>
                                <option value="2" '; echo $row['frequency'] == 2 ? 'SELECTED':''; echo '>Bi-Annual</option>
                                <option value="3" '; echo $row['frequency'] == 3 ? 'SELECTED':''; echo '>Annually</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-md-3 control-label">Document</label>
                        <div class="col-md-8">
                            <div class="mt-repeater mt-repeater-file">
                            	<div data-repeater-list="document">';

				                    if (!empty($output_file)) {
                                        echo '<div class="mt-repeater-item mt-repeater-item-hide row" data-repeater-item>
                                            <div class="col-md-6">
                                                <select class="form-control" name="filetype" onchange="changeType(this)" required>
                                                    <option value="0">Select option</option>
                                                    <option value="1">Manual Upload</option>
                                                    <option value="2">Youtube URL</option>
                                                    <option value="3">Google Drive URL</option>
                                                </select>
                                                <input class="form-control margin-top-15 fileUpload" type="file" name="file" style="display: none;" />
                                                <input class="form-control margin-top-15 fileURL" type="url" name="fileurl" style="display: none;" placeholder="https://" />
                                            </div>
                                            <div class="col-md-4">
                                                <select class="form-control" name="language" required="">
                                                    <option value="0">English</option>
                                                    <option value="1">Spanish</option>
                                                    <option value="2">Arabic</option>
                                                </select>
                                            </div>
                                            <div class="col-md-2 text-right">
                                                <a href="javascript:;" data-repeater-delete class="btn btn-danger"><i class="fa fa-close"></i></a>
                                            </div>
                                        </div>';

		                                foreach ($output_file as $key => $value) {
		                                    $file_lang = $value['file_lang'];

                                            $filetype = 1;
                                            if (!empty($value['file_type'])) { $filetype = $value['file_type']; }

			                                $file_doc = $value['file_doc'];
                                            $file_doc_temp = $value['file_doc'];
											$type = 'iframe';
											if ($filetype == 1) {
									            $fileExtension = fileExtension($file_doc);
												$src = $fileExtension['src'];
												$embed = $fileExtension['embed'];
												$type = $fileExtension['type'];
												$file_extension = $fileExtension['file_extension'];
									            $url = $base_url.'uploads/';

			    								$file_doc = $src.$url.rawurlencode($file_doc).$embed;
											} else if ($filetype == 3) {
												$file_doc = preg_replace('#[^/]*$#', '', $file_doc).'preview';
											}

		                                    echo '<div class="mt-repeater-item row" data-repeater-item>
		                                        <div class="col-md-6">
                                                    <input type="hidden" name="file_doctype_temp" value="'.$filetype.'" />
                                                    <input type="hidden" name="file_doc_temp" value="'.$file_doc_temp.'" />
					                                <select class="form-control '; echo !empty($file_doc) ? 'hide':''; echo '" name="filetype" onchange="changeType(this)" required>
										            	<option value="0">Select option</option>
										            	<option value="1">Manual Upload</option>
										            	<option value="2">Youtube URL</option>
										            	<option value="3">Google Drive URL</option>
										            </select>
										            <input class="form-control margin-top-15 fileUpload" type="file" name="file" style="display: none;" value="'.$file_doc.'" />
										            <input class="form-control margin-top-15 fileURL" type="url" name="fileurl" style="display: none;" placeholder="https://" value="'.$file_doc.'" />
                                                    <p class="'; echo !empty($file_doc) ? '':'hide'; echo '" style="margin: 0;"><a href="'.$file_doc.'" data-src="'.$file_doc.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a> | <button type="button" class="btn btn-link uploadNew" onclick="uploadNew(this)">Upload New</button></p>
		                                        </div>
		                                        <div class="col-md-4">
                                                    <select class="form-control" name="language" required="">
                                                        <option value="0" '; echo $file_lang == 0 ? 'SELECTED':''; echo '>English</option>
                                                        <option value="1" '; echo $file_lang == 1 ? 'SELECTED':''; echo '>Spanish</option>
                                                        <option value="2" '; echo $file_lang == 2 ? 'SELECTED':''; echo '>Arabic</option>
                                                    </select>
		                                        </div>
		                                        <div class="col-md-2 text-right">
		                                            <a href="javascript:;" data-repeater-delete class="btn btn-danger"><i class="fa fa-close"></i></a>
		                                        </div>
		                                    </div>';
		                                }
		                            } else {
			                            echo '<div class="mt-repeater-item row" data-repeater-item>
	                                        <div class="col-md-6">
				                                <select class="form-control" name="filetype" onchange="changeType(this)" required>
									            	<option value="0">Select option</option>
									            	<option value="1">Manual Upload</option>
									            	<option value="2">Youtube URL</option>
									            	<option value="3">Google Drive URL</option>
									            </select>
									            <input class="form-control margin-top-15 fileUpload" type="file" name="file" style="display: none;" />
									            <input class="form-control margin-top-15 fileURL" type="url" name="fileurl" style="display: none;" placeholder="https://" />
	                                        </div>
	                                        <div class="col-md-4">
                                                <select class="form-control" name="language" required="">
                                                    <option value="0">English</option>
                                                    <option value="1">Spanish</option>
                                                    <option value="2">Arabic</option>
                                                </select>
	                                        </div>
	                                        <div class="col-md-2 text-right">
	                                            <a href="javascript:;" data-repeater-delete class="btn btn-danger"><i class="fa fa-close"></i></a>
	                                        </div>
	                                    </div>';
		                            }

                                echo '</div>
                                <a href="javascript:;" data-repeater-create class="btn btn-success mt-repeater-add"><i class="fa fa-plus"></i> Add more</a>
                            </div>
                        </div>
                    </div>
			        <div class="form-group">
			            <label class="col-md-3 control-label">Select Quiz</label>
			            <div class="col-md-8">
			                <select class="form-control mt-multiselect btn btn-default" name="quiz_id[]" multiple="multiple">';
			                    
			                    $array_quiz = explode(", ", $row["quiz_id"]);
			                    $resultQuiz = mysqli_query( $conn,"SELECT * FROM tbl_hr_quiz_set WHERE deleted = 0 AND status = 1 and user_id = $user_id ORDER BY title" );
			                    if ( mysqli_num_rows($resultQuiz) > 0 ) {
			                        while($rowQuiz = mysqli_fetch_array($resultQuiz)) {
										if (in_array($rowQuiz["ID"], $array_quiz)) {
											echo '<option value="'. $rowQuiz["ID"] .'" selected>'. $rowQuiz["title"] .'</option>';
										} else {
											echo '<option value="'. $rowQuiz["ID"] .'">'. $rowQuiz["title"] .'</option>';
										}
			                        }
			                    } else {
			                        echo '<option value="" disabled>No Available</option>';
			                    }
			                    
			                echo '</select>
			                <i class="text-muted">(Quiz not listed? Click here to <a href="'.$base_url.'quiz" target="_blank">add more</a>)</i>
			            </div>
			        </div>
			        <div class="form-group">
			            <label class="control-label col-md-3">Status</label>
			            <div class="col-md-8">
			            	<input type="checkbox" class="make-switch" name="status" data-on-text="Active" data-off-text="Inactive" data-on-color="success" data-off-color="danger"'; echo $row['status'] == "1" ? "checked" : ""; echo '>
			            </div>
			        </div>
                    <div class="form-group uploadPercentage hide">
                        <label class="col-md-3 control-label"></label>
                        <div class="col-md-8">
                            <div class="progress-info">
                                <div class="progress">
                                    <span class="progress-bar progress-bar-success green-sharp" style="width: 0%;"></span>
                                </div>
                                <div class="status">
                                    <div class="status-title">Uploading...</div><div class="status-number">0%</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="tab-pane" id="tabTraining">
                    <div class="table-scrollable">
                        <table class="table table-bordered table-hover">
                            <thead>
                                <tr>
                                    <th>Employee ID#</th>
                                    <th>First Name</th>
                                    <th>Last Name</th>
                                    <th>Email</th>
                                    <th>Completed(Y/N)</th>
                                </tr>
                            </thead>
                            <tbody>';

                                $countTraining = 1;
                            	// if ($portal_user == 43) {
				                    $selectEmployee = mysqli_query( $conn,"SELECT
                                        u.ID AS u_ID,
                                        e.ID AS e_ID,
                                        e.first_name AS e_first_name,
                                        e.last_name AS e_last_name,
                                        e.email AS e_email,
                                        e.job_description_id AS e_job_description_id

                                        FROM tbl_hr_employee AS e

                                        LEFT JOIN (
                                            SELECT
                                            ID,
                                            employee_id
                                            FROM tbl_user
                                            WHERE is_verified = 1
                                            AND is_active = 1
                                        ) AS u
                                        ON u.employee_id = e.ID
                                        
                                        WHERE e.suspended = 0
                                        AND e.status = 1
                                        AND e.user_id = $user_id
                                        AND u.ID IS NOT NULL
                                        ORDER BY e.first_name" );
				                    if ( mysqli_num_rows($selectEmployee) > 0 ) {
				                        while($rowEmployee = mysqli_fetch_array($selectEmployee)) {
                                            $e_ID = $rowEmployee["e_ID"];
                                            $e_job_description_id = $rowEmployee["e_job_description_id"];
                                            $u_ID = $rowEmployee["u_ID"];
                                            $found = null;

                                            $array_rowEmployee = explode(", ", $e_job_description_id);
                                            $array_rowTraining = explode(", ", $t_job_description_id);
											foreach($array_rowEmployee as $emp_JD) {
												if (in_array($emp_JD,$array_rowTraining)) {
													$found = true;
												}
											}

											if ( $found == true ) {
                                                $trainingResult = 0;

                                                $selectQuizResult = mysqli_query( $conn,"SELECT
                                                    ID,
                                                    user_id,
                                                    quiz_id,
                                                    result
                                                    FROM tbl_hr_quiz_result 
                                                    WHERE ID IN ( 
                                                        SELECT MAX(ID) 
                                                        FROM tbl_hr_quiz_result
                                                        WHERE user_id = $u_ID
                                                        GROUP BY quiz_id 
                                                    )" );
                                                if ( mysqli_num_rows($selectQuizResult) > 0 ) {
                                                    while($rowQuizResult = mysqli_fetch_array($selectQuizResult)) {
                                                        $trainingResultID = $rowQuizResult['ID'];
                                                        $trainingQuizID = $rowQuizResult['quiz_id'];

                                                        if (!empty($t_quiz_id)) {
                                                            $array_quiz_id = explode(', ', $t_quiz_id);
                                                            if (in_array($trainingQuizID, $array_quiz_id)) {
                                                                $trainingResult = $rowQuizResult['result'];
                                                            }
                                                        }
                                                    }
                                                }

												echo '<tr>
													<td>'.$countTraining++.'</td>
													<td>'.$rowEmployee["e_first_name"] .'</td>
													<td>'.$rowEmployee["e_last_name"] .'</td>
													<td>'.$rowEmployee["e_email"] .'</td>
													<td class="text-center">'; echo $trainingResult == 100 ? '<span class="label label-sm label-success">YES</span>':'<span class="label label-sm label-danger">NO</span>'; echo '</td>
												</tr>';											}
				                        }

				                        if ( $countTraining < 1 ) {
				                        	echo '<tr class="text-center text-default"><td colspan="5">Empty Record</td></tr>';
				                        }
				                    } else {
				                    	echo '<tr class="text-center text-default"><td colspan="5">Empty Record</td></tr>';
				                    }
                            	// } else {
				                //     $selectEmployee = mysqli_query( $conn,"SELECT * FROM tbl_hr_employee WHERE status = 1 AND user_id = $user_id ORDER BY first_name" );
				                //     if ( mysqli_num_rows($selectEmployee) > 0 ) {
				                //         while($rowEmployee = mysqli_fetch_array($selectEmployee)) {


				                //         	// Option 1
								// 			// $trainings_id = $row['ID'];
								// 			// $trainings_id_status = $rowEmployee["trainings_id_status"];
								// 			// $output = json_decode($trainings_id_status,true);

								// 			// if ( !empty($trainings_id_status) ) {
								// 			// 	if ( array_key_exists($trainings_id, $output) ) {
								// 			// 		if ( $output[$trainings_id] == 1 ) {

								// 			// 			echo '<tr>
								// 			// 				<td>'. $rowEmployee["ID"] .'</td>
								// 			// 				<td>'. $rowEmployee["first_name"] .'</td>
								// 			// 				<td>'. $rowEmployee["last_name"] .'</td>
								// 			// 				<td>'. $rowEmployee["email"] .'</td>
								// 			// 				<td>
								// 			// 				<span class="label label-sm label-success">YES</span>
								// 			// 				</td>
								// 			// 			</tr>';
						                                
								// 			// 			$countTraining++;
								// 			// 		}
								// 			// 	}
								// 			// }

				                //         	// Option 2
								// 			$found = null;
								// 			$array_rowEmployee = explode(", ", $rowEmployee["job_description_id"]);
								// 			$array_rowTraining = explode(", ", $row["job_description_id"]);
								// 			foreach($array_rowEmployee as $emp_JD) {
								// 				if (in_array($emp_JD,$array_rowTraining)) {
								// 					$found = true;
								// 				}
								// 			}

								// 			if ( $found == true ) {
								// 				$employee_id = $rowEmployee["ID"];

	                            //                 $trainingStatus = "Not Yet Started";
	                            //                 $trainingResult = 0;
	                            //                 $completed_date = '';
	                            //                 $due_date = '';

								// 				$selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE employee_id = $employee_id" );
	                            //                 if ( mysqli_num_rows($selectUser) > 0 ) {
	                            //                     $rowUser = mysqli_fetch_array($selectUser);
	                            //                     $employee_user_ID = $rowUser['ID'];

	                            //                     $selectQuizResult = mysqli_query( $conn,"SELECT * FROM tbl_hr_quiz_result WHERE user_id = $employee_user_ID " );
	                            //                     if ( mysqli_num_rows($selectQuizResult) > 0 ) {
	                            //                         while($rowQuizResult = mysqli_fetch_array($selectQuizResult)) {
	                            //                             $trainingResultID = $rowQuizResult['ID'];
	                            //                             $trainingQuizID = $rowQuizResult['quiz_id'];

	                            //                             if (!empty($row['quiz_id'])) {
	                            //                                 $array_quiz_id = explode(', ', $row['quiz_id']);
	                            //                                 if (in_array($trainingQuizID, $array_quiz_id)) {
	                            //                                     $trainingResult = $rowQuizResult['result'];

	                            //                                     if ($trainingResult == 100) { $trainingStatus = "Completed"; }
	                            //                                     else { $trainingStatus = "Not Yet Started"; }
	                                                
	                            //                                     $completed_date = $rowQuizResult['last_modified'];
	                            //                                     $completed_date = new DateTime($completed_date);
	                            //                                     $completed_date = $completed_date->format('M d, Y');
	                                                                
	                            //                                     $due_date = date('Y-m-d', strtotime('+1 year', strtotime($completed_date)) );
	                            //                                     $due_date = new DateTime($due_date);
	                            //                                     $due_date = $due_date->format('M d, Y');
	                            //                                 }
	                            //                             }
	                            //                         }
	                            //                     }
	                            //                 }
								// 				echo '<tr>
								// 					<td>'. $rowEmployee["ID"] .'</td>
								// 					<td>'. $rowEmployee["first_name"] .'</td>
								// 					<td>'. $rowEmployee["last_name"] .'</td>
								// 					<td>'. $rowEmployee["email"] .'</td>
								// 					<td class="text-center">'; echo $trainingResult == 100 ? '<span class="label label-sm label-success">YES</span>':'<span class="label label-sm label-danger">NO</span>'; echo '</td>
								// 				</tr>';

								// 				$countTraining++;
								// 			}
				                //         }

				                //         if ( $countTraining < 1 ) {
				                //         	echo '<tr class="text-center text-default"><td colspan="5">Empty Record</td></tr>';
				                //         }
				                //     } else {
				                //     	echo '<tr class="text-center text-default"><td colspan="5">Empty Record</td></tr>';
				                //     }
                            	// }
                                
                            echo '</tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>';

        mysqli_close($conn);
	}
	if( isset($_GET['modalView_HR_Trainings_Type']) ) {
		if (!empty($_COOKIE['switchAccount'])) {
			$portal_user = $_COOKIE['ID'];
			$user_id = $_COOKIE['switchAccount'];
		}
		else {
			$portal_user = $_COOKIE['ID'];
			$user_id = employerID($portal_user);
		}

		$id = $_GET['modalView_HR_Trainings_Type'];
        $result = mysqli_query( $conn,"SELECT
            t_ID,
            t_title,
            t_description,
            t_status,

            SUM(TOTAL_APPROVE) AS TOTAL_APPROVE,
            SUM(TOTAL_EMP_HAS_JB) AS TOTAL_EMPLOYEE
            FROM (
            SELECT
                t.ID AS t_ID,
                t.user_id AS t_user_id,
                t.title AS t_title,
                t.description AS t_description,
                t.job_description_id AS t_job_description_id,
                t.quiz_id AS t_quiz_id,
                t.status AS t_status,
                t.type AS t_type,

                e1.e_ID AS e1_ID,
                e1.e_job_description_id AS e1_job_description_id,
                e1.e_first_name AS e1_first_name,
                e1.u_ID AS e1_userID,

                q1.q_ID AS q1_ID,
                q1.q_user_id AS q1_user_id,
                q1.q_quiz_id AS q1_quiz_id,
                q1.q_result AS q1_result,
                CASE WHEN q1.q_result = '100' THEN 1 ELSE 0 END AS TOTAL_APPROVE,
                CASE WHEN LENGTH(e1.e_job_description_id) > 0 THEN 1 ELSE 0 END AS TOTAL_EMP_HAS_JB
                FROM tbl_hr_trainings AS t

                LEFT JOIN (
                    SELECT
                    u.ID AS u_ID,
                    e.ID AS e_ID,
                    e.user_id AS e_user_id,
                    e.first_name AS e_first_name,
                    e.job_description_id AS e_job_description_id

                    FROM tbl_hr_employee AS e

                    LEFT JOIN (
                        SELECT
                        ID,
                        employee_id
                        FROM tbl_user
                        WHERE is_verified = 1
                        AND is_active = 1
                    ) AS u
                    ON u.employee_id = e.ID

                    WHERE e.suspended = 0
                    AND e.status = 1
                    AND u.ID IS NOT NULL
                ) AS e1
                ON e1.e_user_id = t.user_id
                AND t.job_description_id REGEXP CONCAT('\\\\b', REPLACE(e1.e_job_description_id, ', ', '|'), '\\\\b')

                LEFT JOIN (
                    SELECT
                    q.ID AS q_ID,
                    q.user_id AS q_user_id,
                    q.quiz_id AS q_quiz_id,
                    q.result AS q_result,
                    q.last_modified AS q_last_modified

                    FROM tbl_hr_quiz_result AS q
                ) AS q1
                ON q1.q_user_id = e1.u_ID
                AND LENGTH(q1.q_quiz_id) > 0
                AND FIND_IN_SET(q1.q_quiz_id, REPLACE(t.quiz_id, ' ', ''))

                WHERE t.deleted = 0
                AND t.type = $id
                AND t.user_id = $user_id

                GROUP BY e1.u_ID
                , t.ID

                ORDER BY e1.e_first_name DESC
            ) r

            GROUP BY t_ID

            ORDER BY t_title ASC" );
        if ( mysqli_num_rows($result) > 0 ) {
            $i=1;
            while($row = mysqli_fetch_array($result)) {
                $t_ID = $row["t_ID"];
                $t_title = $row["t_title"];
                $t_description = $row["t_description"];
                $t_status = $row["t_status"];
                $countApproved = $row["TOTAL_APPROVE"];
                $countEmployee = $row["TOTAL_EMPLOYEE"];
                $percentage = 0;
                
                echo '<tr id="tr_'.$t_ID.'">
                    <td>'.$i.'</td>
                    <td>'.htmlentities($t_title ?? '').'</td>
                    <td>'.htmlentities($t_description ?? '').'</td>';

                    // $array_jd = explode(", ", $row["job_description_id"]);
                    // $job_title = array();
                    // foreach ($array_jd as $value) {
                    //     $resultJD = mysqli_query( $conn,"SELECT * FROM tbl_hr_job_description WHERE ID=$value " );
                    //     while($rowJD = mysqli_fetch_array($resultJD)) {
                    //         $job_title[] = $rowJD["title"];
                    //     }
                    // }

                    // echo '<td>'. implode(", ",$job_title) .'</td>';

                    if ($countEmployee > 0) {
                        $percentage = (100 / $countEmployee) * $countApproved;
                    } else {
                        $countApproved = 0;
                    }

                    echo ' <td class="text-center">'. intval($percentage) .'% ('. $countApproved .'/'. $countEmployee .')</td>';

                    if ( $t_status == 0 ) {
                        echo '<td class="text-center"><span class="label label-sm label-danger">Inactive</span></td>';
                    } else if ( $t_status == 1 ) {
                        echo '<td class="text-center"><span class="label label-sm label-success">Active</span></td>';
                    } else {
                        echo '<td class="text-center"><span class="label label-sm label-warning">Suspended</span></td>';
                    }

                    echo '<td class="text-center">
                        <div class="mt-action-buttons">
                            <div class="btn-group btn-group-circle">
                                <a href="#modalView" type="button" class="btn btn-outline dark btn-sm" data-toggle="modal" onclick="btnView('.$t_ID.', '.$i.', \'modalView\')">View</a>
                                <a href="javascript:;" type="button" class="btn red btn-sm" onclick="btnDelete('.$t_ID.')">Delete</a>
                            </div>
                        </div>
                    </td>
                </tr>';
                $i++;
            }
        }

        mysqli_close($conn);
	}
	if( isset($_GET['modalView_HR_Trainings_TypeAll']) ) {
		$id = $_GET['modalView_HR_Trainings_TypeAll'];
        $id = employerID($id);

        $result = mysqli_query( $conn,"SELECT
            t_ID,
            t_title,
            t_description,
            t_status,

            SUM(TOTAL_APPROVE) AS TOTAL_APPROVE,
            SUM(TOTAL_EMP_HAS_JB) AS TOTAL_EMPLOYEE
            FROM (
            SELECT
                t.ID AS t_ID,
                t.user_id AS t_user_id,
                t.title AS t_title,
                t.description AS t_description,
                t.job_description_id AS t_job_description_id,
                t.quiz_id AS t_quiz_id,
                t.status AS t_status,
                t.type AS t_type,

                e1.e_ID AS e1_ID,
                e1.e_job_description_id AS e1_job_description_id,
                e1.e_first_name AS e1_first_name,
                e1.u_ID AS e1_userID,

                q1.q_ID AS q1_ID,
                q1.q_user_id AS q1_user_id,
                q1.q_quiz_id AS q1_quiz_id,
                q1.q_result AS q1_result,
                CASE WHEN q1.q_result = '100' THEN 1 ELSE 0 END AS TOTAL_APPROVE,
                CASE WHEN LENGTH(e1.e_job_description_id) > 0 THEN 1 ELSE 0 END AS TOTAL_EMP_HAS_JB
                FROM tbl_hr_trainings AS t

                LEFT JOIN (
                    SELECT
                    u.ID AS u_ID,
                    e.ID AS e_ID,
                    e.user_id AS e_user_id,
                    e.first_name AS e_first_name,
                    e.job_description_id AS e_job_description_id

                    FROM tbl_hr_employee AS e

                    LEFT JOIN (
                        SELECT
                        ID,
                        employee_id
                        FROM tbl_user
                        WHERE is_verified = 1
                        AND is_active = 1
                    ) AS u
                    ON u.employee_id = e.ID

                    WHERE e.suspended = 0
                    AND e.status = 1
                    AND u.ID IS NOT NULL
                ) AS e1
                ON e1.e_user_id = t.user_id
                AND t.job_description_id REGEXP CONCAT('\\\\b', REPLACE(e1.e_job_description_id, ', ', '|'), '\\\\b')

                LEFT JOIN (
                    SELECT
                    q.ID AS q_ID,
                    q.user_id AS q_user_id,
                    q.quiz_id AS q_quiz_id,
                    q.result AS q_result,
                    q.last_modified AS q_last_modified

                    FROM tbl_hr_quiz_result AS q
                ) AS q1
                ON q1.q_user_id = e1.u_ID
                AND LENGTH(q1.q_quiz_id) > 0
                AND FIND_IN_SET(q1.q_quiz_id, REPLACE(t.quiz_id, ' ', ''))

                WHERE t.deleted = 0
                AND t.user_id = $user_id

                GROUP BY e1.u_ID
                , t.ID

                ORDER BY e1.e_first_name DESC
            ) r

            GROUP BY t_ID

            ORDER BY t_title ASC" );
	    if ( mysqli_num_rows($result) > 0 ) {
            $i=1;
	        while($row = mysqli_fetch_array($result)) {
                $t_ID = $row["t_ID"];
                $t_title = $row["t_title"];
                $t_description = $row["t_description"];
                $t_status = $row["t_status"];
                $countApproved = $row["TOTAL_APPROVE"];
                $countEmployee = $row["TOTAL_EMPLOYEE"];
                $percentage = 0;
	            
                echo '<tr id="tr_'.$t_ID.'">
                    <td>'.$i.'</td>
                    <td>'.htmlentities($t_title ?? '').'</td>
                    <td>'.htmlentities($t_description ?? '').'</td>';

	                // $array_jd = explode(", ", $row["job_description_id"]);
	                // $job_title = array();
	                // foreach ($array_jd as $value) {
	                //     $resultJD = mysqli_query( $conn,"SELECT * FROM tbl_hr_job_description WHERE ID=$value " );
	                //     while($rowJD = mysqli_fetch_array($resultJD)) {
	                //         $job_title[] = $rowJD["title"];
	                //     }
	                // }

	                // echo '<td>'. implode(", ",$job_title) .'</td>';

	                if ($countEmployee > 0) {
	                    $percentage = (100 / $countEmployee) * $countApproved;
	                } else {
	                    $countApproved = 0;
	                }

	                echo ' <td class="text-center">'. intval($percentage) .'% ('. $countApproved .'/'. $countEmployee .')</td>';

                    if ( $t_status == 0 ) {
                        echo '<td class="text-center"><span class="label label-sm label-danger">Inactive</span></td>';
                    } else if ( $t_status == 1 ) {
                        echo '<td class="text-center"><span class="label label-sm label-success">Active</span></td>';
                    } else {
                        echo '<td class="text-center"><span class="label label-sm label-warning">Suspended</span></td>';
                    }

                    echo '<td class="text-center">
                        <div class="mt-action-buttons">
                            <div class="btn-group btn-group-circle">
                                <a href="#modalView" type="button" class="btn btn-outline dark btn-sm" data-toggle="modal" onclick="btnView('.$t_ID.', '.$i.', \'modalView\')">View</a>
                                <a href="javascript:;" type="button" class="btn red btn-sm" onclick="btnDelete('.$t_ID.')">Delete</a>
                            </div>
                        </div>
                    </td>
	            </tr>';
                $i++;
	        }
	    }

        mysqli_close($conn);
	}
	if( isset($_GET['modalView_HR_Trainings_Delete']) ) {
		$id = $_GET['modalView_HR_Trainings_Delete'];
		mysqli_query( $conn,"UPDATE tbl_hr_trainings set deleted = 1 WHERE ID = $id" );
	}
	if( isset($_POST['btnSave_HR_Trainings']) ) {
		if (!empty($_COOKIE['switchAccount'])) {
			$portal_user = $_COOKIE['ID'];
			$user_id = $_COOKIE['switchAccount'];
		}
		else {
			$portal_user = $_COOKIE['ID'];
			$user_id = employerID($portal_user);
		}

		$type = $_POST['type'];
		if ($type == "other") {
			$type_other = $_POST['type_other'];

			$sql = "INSERT INTO tbl_hr_trainings_type (user_id, portal_user, name)
			VALUES ('$user_id', '$portal_user', '$type_other')";
			if (mysqli_query($conn, $sql)) {
				$type = mysqli_insert_id($conn);
			}
		}

		$title = addslashes($_POST['title']);
		$description = addslashes($_POST['description']);
		$job_description_id = implode(", ", $_POST['job_description_id']);
        $frequency = $_POST["frequency"];
        $arr_item = array();
        $process = true;

		$quiz_id = '';
		if (!empty($quiz_id)) { $quiz_id = implode(", ", $_POST['quiz_id']); }

		$arr_file = array();
        $path = 'uploads/';
        $random = rand(1000,1000000);
        $file_docs = '';
        $file_history = '';
        if (!empty($_POST['document'])) {
            $document = $_POST['document'];
            for ($i=0; $i < count($document); $i++) {
                $language = addslashes($_POST['document'][$i]['language']);
                $filetype = addslashes($_POST['document'][$i]['filetype']);

                if ($filetype == 1) {
                    $files = implode('*', $_FILES['document']['name'][$i]);
                    $filesize = implode('*', $_FILES['document']['size'][$i]);
                    $tmp_docs = implode('*', $_FILES['document']['tmp_name'][$i]);
                    $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                    $ext = strtolower(pathinfo($files, PATHINFO_EXTENSION));
                    $file_docs = $random.' - '.$files;
                    $path_docs = $path.$file_docs;

                    if(!in_array($ext, $invalid_extensions)) {
                        move_uploaded_file($tmp_docs,$path_docs);
                    } else {
                        $process = false;
                    }
                } else {
                    $file_docs = addslashes($_POST['document'][$i]['fileurl']);
                    $filesize = 0;
                }

                if ($process == true) {
                    $output = array (
                        'type'  =>  $filetype,
                        'name' =>  $files,
                        'size' =>  $filesize,
                        'date' =>  $local_date
                    );
                    array_push($arr_item, $output);;

                    $file_data = array (
                        'file_type' => $filetype,
                        'file_doc' => $file_docs,
                        'file_lang' => $language
                    );
                    array_push( $arr_file, $file_data );
                }
            }
        }
        $file_history = json_encode($arr_item, JSON_HEX_APOS | JSON_UNESCAPED_UNICODE);
        $file_docs = json_encode($arr_file);

        if ($process == true) {
            $sql = "INSERT INTO tbl_hr_trainings (user_id, portal_user, type, title, description, job_description_id, frequency, files, file_history, quiz_id)
            VALUES ('$user_id', '$portal_user', '$type', '$title', '$description', '$job_description_id', '$frequency', '$file_docs', '$file_history', '$quiz_id')";
            
    		if (mysqli_query($conn, $sql)) {

    			$last_id = mysqli_insert_id($conn);
    			$selectData = mysqli_query( $conn,'SELECT * FROM tbl_hr_trainings WHERE user_id="'. $user_id .'" AND ID="'. $last_id .'" ORDER BY ID LIMIT 1' );

    			if ( mysqli_num_rows($selectData) > 0 ) {
    				$rowData = mysqli_fetch_array($selectData);
    				$data_ID = $rowData['ID'];
    				$data_title = stripcslashes($rowData['title']);
    				$data_description = stripcslashes($rowData['description']);

    				$array_jd = $_POST['job_description_id'];
    	            $job_title = array();
    	            foreach ($array_jd as $value) {
    	                $selectData = mysqli_query( $conn,"SELECT * FROM tbl_hr_job_description WHERE ID=$value " );
    	                while($rowJD = mysqli_fetch_array($selectData)) {
    	                    $job_title[] = $rowJD["title"];
    	                }
    	            }

    	            $countTraining = 0;
    	            $countApproved = 0;
    	            $countEmployee = 0;
    	            $selectEmployee = mysqli_query( $conn,"SELECT * FROM tbl_hr_employee" );
    	            if ( mysqli_num_rows($selectEmployee) > 0 ) {
    	                while($rowEmployee = mysqli_fetch_array($selectEmployee)) {
    	                    $found = null;
    	                    $array_rowEmployee = explode(", ", $rowEmployee["job_description_id"]);
    	                    $array_rowTraining = explode(", ", $job_description_id);
    	                    foreach($array_rowEmployee as $emp_JD) {
    	                        if (in_array($emp_JD,$array_rowTraining)) {
    	                            $found = true;
    	                        }
    	                    }

    	                    if ( $found == true ) {
    	                        $trainings_id = $data_ID;
    	                        $trainings_id_status = $rowEmployee["trainings_id_status"];
    	                        $output = json_decode($trainings_id_status,true);

    	                        if ( !empty($trainings_id_status) ) {
    	                            if ( array_key_exists($trainings_id, $output) ) {
    	                                if ( $output[$trainings_id] == 1 ) {
    	                                    $countApproved++;
    	                                }
    	                            }
    	                        }

    	                        $countEmployee++;
    	                    }
    	                }
    	            }
    	            $percentage = (100 / $countEmployee) * $countApproved;
    	            $compliance = strval(intval($percentage)) .'% ('.  strval(intval($countApproved)) .'/'. strval(intval($countEmployee)) .')';

                	$counterup_tbl = counterup_tbl('trainings');
    				$output = array(
    					'ID' => $data_ID,
    					'title' => $title,
    					'description' => $description,
    					'job_description_id' => implode(", ",$job_title),
    					'compliance' => $compliance
    				);

    				$result = array_merge($counterup_tbl, $output);
    				echo json_encode($result);
    			}
    		}
    		mysqli_close($conn);
    	}
    }
	if( isset($_POST['btnUpdate_HR_Trainings']) ) {
		$ID = $_POST['ID'];
        $c = $_POST['c'];

		if (!empty($_COOKIE['switchAccount'])) {
			$portal_user = $_COOKIE['ID'];
			$user_id = $_COOKIE['switchAccount'];
		}
		else {
			$portal_user = $_COOKIE['ID'];
			$user_id = employerID($portal_user);
		}

		$type = $_POST['type'];
		if ($type == "other") {
			$type_other = $_POST['type_other'];

			$sql = "INSERT INTO tbl_hr_trainings_type (user_id, portal_user, name)
			VALUES ('$user_id', '$portal_user', '$type_other')";
			if (mysqli_query($conn, $sql)) {
				$type = mysqli_insert_id($conn);
			}
		}

		$title = addslashes($_POST['title']);
		$description = addslashes($_POST['description']);
        $frequency = $_POST["frequency"];
        $process = true;
        
        $job_description_id = '';
        if (!empty($_POST['job_description_id'])) { $job_description_id = implode(", ", $_POST['job_description_id']); }

		$status = isset($_POST['status']) ? 1 : 0;
		$status_last_modified = date('Y-m-d');

		$quiz_id = '';
		if (!empty($_POST['quiz_id'])) { $quiz_id = implode(", ", $_POST['quiz_id']); }

		$selectData = mysqli_query( $conn,"SELECT * FROM tbl_hr_trainings WHERE ID = $ID" );
        if ( mysqli_num_rows($selectData) > 0 ) {
            $row = mysqli_fetch_array($selectData);
            $user_id = $row['user_id'];

            $files = $row['files'];
            if (!empty($files)) {
                $output_file = json_decode($files,true);
            }
        }

		mysqli_query( $conn,"UPDATE tbl_hr_trainings set type='". $type ."',  title='". $title ."', description='". $description ."', job_description_id='". $job_description_id ."', frequency='". $frequency ."', quiz_id='". $quiz_id ."', status='". $status ."', last_modified='". $status_last_modified ."' WHERE ID='". $ID ."'" );
		
		if (!mysqli_error($conn)) {
            $selectData = mysqli_query( $conn,"SELECT * FROM tbl_hr_trainings WHERE ID = $ID" );
            if ( mysqli_num_rows($selectData) > 0 ) {
                $rowData = mysqli_fetch_array($selectData);

                $files = '';
                $arr_item = array();
                if (!empty($rowData["file_history"])) {
                    $arr_item = json_decode($rowData["file_history"],true);
                }
                $arr_file = array();
                $path = 'uploads/';
                $random = rand(1000,1000000);
                $file_docs = '';
                $file_history = '';
                if (!empty($_POST['document'])) {
                    $document = $_POST['document'];
                    for ($i=0; $i < count($document); $i++) {
                        $language = addslashes($_POST['document'][$i]['language']);
                        $filetype = addslashes($_POST['document'][$i]['filetype']);

                        if ($filetype == 0) {
                            if (isset($_POST['document'][$i]['file_doctype_temp']) OR isset($_POST['document'][$i]['file_doc_temp'])) {
                                $filetype = addslashes($_POST['document'][$i]['file_doctype_temp']);
                                $file_docs = addslashes($_POST['document'][$i]['file_doc_temp']);
                                $filesize = 0;
                            }
                        } else if ($filetype == 1) {
                            $files = implode('*', $_FILES['document']['name'][$i]);
                            $filesize = implode('*', $_FILES['document']['size'][$i]);
                            $tmp_docs = implode('*', $_FILES['document']['tmp_name'][$i]);
                            $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                            $ext = strtolower(pathinfo($files, PATHINFO_EXTENSION));
                            $file_docs = $random.' - '.$files;
                            $path_docs = $path.$file_docs;

                            if(!in_array($ext, $invalid_extensions)) {
                                move_uploaded_file($tmp_docs,$path_docs);
                            } else {
                                $process = false;
                            }
                        } else {
                            $file_docs = addslashes($_POST['document'][$i]['fileurl']);
                            $filesize = 0;
                        }

                        if (!empty($file_docs) AND $process == true) {
                            $output = array (
                                'type'  =>  $filetype,
                                'name' =>  $files,
                                'size' =>  $filesize,
                                'date' =>  $local_date
                            );
                            array_push($arr_item, $output);;

                            $file_data = array (
                                'file_type' => $filetype,
                                'file_doc' => $file_docs,
                                'file_lang' => $language
                            );
                            array_push( $arr_file, $file_data );
                        }
                    }
                    if ($process == true) {
                        $file_history = json_encode($arr_item, JSON_HEX_APOS | JSON_UNESCAPED_UNICODE);
                        $file_docs = json_encode($arr_file);
                        mysqli_query( $conn,"UPDATE tbl_hr_trainings set files='". $file_docs ."', file_history='". $file_history ."' WHERE ID='". $ID ."'" );
                    }
                }
            }

            if ($process == true) {
    			$array_jd = $_POST['job_description_id'];
                $job_title = array();
                foreach ($array_jd as $value) {
                    $selectData = mysqli_query( $conn,"SELECT * FROM tbl_hr_job_description WHERE ID=$value " );
                    while($rowJD = mysqli_fetch_array($selectData)) {
                        $job_title[] = $rowJD["title"];
                    }
                }

                $percentage = 0;
                $countTraining = 0;
                $countApproved = 0;
                $countEmployee = 0;
                $selectEmployee = mysqli_query( $conn,"SELECT * FROM tbl_hr_employee" );
                if ( mysqli_num_rows($selectEmployee) > 0 ) {
                    while($rowEmployee = mysqli_fetch_array($selectEmployee)) {
                        $found = null;
                        $array_rowEmployee = explode(", ", $rowEmployee["job_description_id"]);
                        $array_rowTraining = explode(", ", $job_description_id);
                        foreach($array_rowEmployee as $emp_JD) {
                            if (in_array($emp_JD,$array_rowTraining)) {
                                $found = true;
                            }
                        }

                        if ( $found == true ) {
                            $trainings_id = $ID;
                            $trainings_id_status = $rowEmployee["trainings_id_status"];
                            $output = json_decode($trainings_id_status,true);

                            if ( !empty($trainings_id_status) ) {
                                if ( array_key_exists($trainings_id, $output) ) {
                                    if ( $output[$trainings_id] == 1 ) {
                                        $countApproved++;
                                    }
                                }
                            }

                            $countEmployee++;
                        }
                    }
                }

                if ($countEmployee > 0) {
                    $percentage = (100 / $countEmployee) * $countApproved;
                }
                $compliance = strval(intval($percentage)) .'% ('.  strval(intval($countApproved)) .'/'. strval(intval($countEmployee)) .')';

                $counterup_tbl = counterup_tbl('trainings');
    			$output = array(
    				'ID' => $ID,
                    'c' => $c,
                    'title' => stripcslashes(htmlentities($title ?? '')),
                    'description' => stripcslashes(htmlentities($description ?? '')),
    				'job_description_id' => implode(", ",$job_title),
    				'compliance' => $compliance,
    				'status' => $status
    			);

    			$result = array_merge($counterup_tbl, $output);
    			echo json_encode($result);
                mysqli_close($conn);
    		}
        }
	}

	// Training Progress Section
	if( isset($_GET['modalView_HR_Trainings_Progress']) ) {
		$id = $_GET['modalView_HR_Trainings_Progress'];
		$training = $_GET['t'];

        echo '<div class="table-scrollable">
        	<table class="table table-bordered table-hover">
	            <thead>
	                <tr>
	                    <th class="text-center">Date Completed</th>
	                    <th class="text-center">Record</th>
	                </tr>
	            </thead>
	            <tbody>';

			        $selectData = mysqli_query( $conn,"SELECT * FROM tbl_hr_trainings WHERE deleted = 0 AND ID = $training" );
			        if ( mysqli_num_rows($selectData) > 0 ) {
			        	$row = mysqli_fetch_array($selectData);

			        	$selectQuizResult = mysqli_query( $conn,"SELECT * FROM tbl_hr_quiz_result WHERE user_id = $id " );
				        if ( mysqli_num_rows($selectQuizResult) > 0 ) {
				            while($rowQuizResult = mysqli_fetch_array($selectQuizResult)) {
				            	$trainingResultID = $rowQuizResult['ID'];
			                    $trainingQuizID = $rowQuizResult['quiz_id'];

			                    if (!empty($row['quiz_id'])) {
			                        $array_quiz_id = explode(', ', $row['quiz_id']);
			                        if (in_array($trainingQuizID, $array_quiz_id)) {
			                            $trainingResult = $rowQuizResult['result'];
			            
			                            $completed_date = $rowQuizResult['last_modified'];
			                            $completed_date = new DateTime($completed_date);
			                            $completed_date_o = $completed_date->format('Y/m/d');
			                            $completed_date = $completed_date->format('M d, Y');
			                            
			                            $due_date = date('Y-m-d', strtotime('+1 year', strtotime($completed_date)) );
			                            $due_date = new DateTime($due_date);
			                            $due_date_o = $due_date->format('Y/m/d');
			                            $due_date = $due_date->format('M d, Y');

			                            $current_date = date('M d, Y');
			                            $current_date = 'Oct 27, 2022';
			                            $current_date = new DateTime($current_date);
			                            $current_date_o = $current_date->format('Y/m/d');
			                            $current_date = $current_date->format('M d, Y');

			                            if ($trainingResult == 100) {
									        echo '<tr>
							                    <td class="text-center">'.$completed_date.'</td>
							                    <td class="text-center"><a href="'.$base_url.'pdf?id='.$trainingResultID.'" target="_blank" class="btn btn-circle btn-success">View</a></td>
							                </tr>';
			                            }

			                        }
			                    }
				            }
				        }
			        }

        		echo '</tbody>
        	</table>
        </div>';

        mysqli_close($conn);
	}
	if( isset($_GET['modalView_HR_Employee_TP']) ) {
		$id = $_GET['modalView_HR_Employee_TP'];
		$selectData = mysqli_query( $conn,"SELECT * FROM tbl_hr_employee WHERE ID = $id" );
		if ( mysqli_num_rows($selectData) > 0 ) {
            $row = mysqli_fetch_array($selectData);
            $user_id = $row['user_id'];
        }

		echo '<input class="form-control" type="hidden" name="ID" value="'. $row['ID'] .'" />
        <div class="tabbable tabbable-tabdrop">
            <div class="table-scrollable">
                <table class="table table-bordered table-hover" id="tableData_training">
                    <thead>
                        <tr>
                            <th>Description</th>
                            <th class="text-center">Date Completed</th>
                            <th class="text-center">Due Date</th>
                            <th class="text-center">Status</th>
                            <th class="text-center">Record</th>
                        </tr>
                    </thead>
                    <tbody>';
						$selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE employee_id = $id" );
						if ( mysqli_num_rows($selectUser) > 0 ) {
				            $rowUser = mysqli_fetch_array($selectUser);
				            $current_userID = $rowUser['ID'];
					        $current_userEmployeeID = employeeID($current_userID);
					        $current_userEmployerID = employerID($current_userID);

                            $selectTrainings = mysqli_query( $conn,"SELECT * FROM tbl_hr_trainings WHERE deleted = 0 AND user_id = $current_userEmployerID ORDER BY title" );
                            if ( mysqli_num_rows($selectTrainings) > 0 ) {
                                while($rowTraining = mysqli_fetch_array($selectTrainings)) {
                                    $training_ID = $rowTraining['ID'];
                                    $title = $rowTraining['title'];
                                    
                                    $data_last_modified = $rowTraining['last_modified'];
                                    $data_last_modified = new DateTime($data_last_modified);
                                    $data_last_modified = $data_last_modified->format('M d, Y');

                                    $found = null;
                                    $selectEmployee = mysqli_query( $conn,"SELECT * FROM tbl_hr_employee WHERE ID = $current_userEmployeeID" );
                                    if ( mysqli_num_rows($selectEmployee) > 0 ) {
                                        $rowEmployee = mysqli_fetch_array($selectEmployee);
                                        $array_row = explode(", ", $rowEmployee["job_description_id"]);
                                        $array_rowTraining = explode(", ", $rowTraining["job_description_id"]);
                                        foreach($array_row as $emp_JD) {
                                            if (in_array($emp_JD,$array_rowTraining)) {
                                                $found = true;
                                            }
                                        }
                                    }

                                    $trainingStatus = "Not Yet Started";
                                    $trainingResult = 0;
                                    $completed_date = '';
                                    $due_date = '';
                                    $pdf_quiz = '';
                                    $selectQuizResult = mysqli_query( $conn,"SELECT * FROM tbl_hr_quiz_result WHERE user_id = $current_userID " );
                                    if ( mysqli_num_rows($selectQuizResult) > 0 ) {
                                        while($rowQuizResult = mysqli_fetch_array($selectQuizResult)) {
                                            $trainingResultID = $rowQuizResult['ID'];
                                            $trainingQuizID = $rowQuizResult['quiz_id'];

                                            if (!empty($rowTraining['quiz_id'])) {
                                                $array_quiz_id = explode(', ', $rowTraining['quiz_id']);
                                                if (in_array($trainingQuizID, $array_quiz_id)) {
                                                    $trainingResult = $rowQuizResult['result'];
	                                                $pdf_quiz = $trainingResultID;

                                                    if ($trainingResult == 100) { $trainingStatus = "Completed"; }
                                                    else { $trainingStatus = "Not Yet Started"; }
                                    
                                                    $completed_date = $rowQuizResult['last_modified'];
                                                    $completed_date = new DateTime($completed_date);
                                                    $completed_date = $completed_date->format('M d, Y');
                                                    
                                                    $due_date = date('Y-m-d', strtotime('+1 year', strtotime($completed_date)) );
                                                    $due_date = new DateTime($due_date);
                                                    $due_date = $due_date->format('M d, Y');
                                                }
                                            }

                                        }
                                    }

                                    if ( $found == true ) {
                                        echo '<tr id="tr_'.$training_ID.'">
                                            <td >'. htmlentities($title) .'</td>
                                            <td class="text-center">'; echo $trainingResult == 100 ? $completed_date:''; echo '</td>
                                            <td class="text-center">'; echo $trainingResult == 100 ? $due_date:''; echo '</td>
                                            <td class="text-center">'.$trainingStatus.'</td>
                                            <td class="text-center">'; echo $trainingResult == 100 ? '<a href="pdf?id='.$pdf_quiz.'" target="_blank" class="btn btn-circle btn-sm btn-success">View</a>':''; echo '</td>
                                        </tr>';
                                    }
                                }
                            }
				        }

                    echo '</tbody>
                </table>
            </div>
        </div>';

        mysqli_close($conn);
	}
	if( isset($_GET['modalView_HR_Trainings_TP']) ) {
		$id = $_GET['modalView_HR_Trainings_TP'];

        $selectData = mysqli_query( $conn,"SELECT * FROM tbl_hr_trainings WHERE ID = $id" );
        if ( mysqli_num_rows($selectData) > 0 ) {
            $row = mysqli_fetch_array($selectData);
            $user_id = $row['user_id'];
            $type = $row['type'];

            $files = $row['files'];
            if (!empty($files)) {
                $output_file = json_decode($files,true);
            }
        }

        echo '<input class="form-control" type="hidden" name="ID" value="'. $row['ID'] .'" />
        <div class="table-scrollable">
            <table class="table table-bordered table-hover">
                <thead>
                    <tr>
                        <th>Last Name</th>
                        <th>First Name</th>
                        <th>Email</th>
                        <th>Completed(Y/N)</th>
                    </tr>
                </thead>
                <tbody>';

                    $countTraining = 0;
                    $selectEmployee = mysqli_query( $conn,"SELECT * FROM tbl_hr_employee WHERE status = 1 AND user_id = $user_id ORDER BY last_name" );
                    if ( mysqli_num_rows($selectEmployee) > 0 ) {
                        while($rowEmployee = mysqli_fetch_array($selectEmployee)) {
							$found = null;
							$array_rowEmployee = explode(", ", $rowEmployee["job_description_id"]);
							$array_rowTraining = explode(", ", $row["job_description_id"]);
							foreach($array_rowEmployee as $emp_JD) {
								if (in_array($emp_JD,$array_rowTraining)) {
									$found = true;
								}
							}

							if ( $found == true ) {
								$employee_id = $rowEmployee["ID"];

                                $trainingStatus = "Not Yet Started";
                                $trainingResult = 0;
                                $completed_date = '';
                                $due_date = '';

								$selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE employee_id = $employee_id" );
                                if ( mysqli_num_rows($selectUser) > 0 ) {
                                    $rowUser = mysqli_fetch_array($selectUser);
                                    $employee_user_ID = $rowUser['ID'];

                                    $selectQuizResult = mysqli_query( $conn,"SELECT * FROM tbl_hr_quiz_result WHERE user_id = $employee_user_ID " );
                                    if ( mysqli_num_rows($selectQuizResult) > 0 ) {
                                        while($rowQuizResult = mysqli_fetch_array($selectQuizResult)) {
                                            $trainingResultID = $rowQuizResult['ID'];
                                            $trainingQuizID = $rowQuizResult['quiz_id'];

                                            if (!empty($row['quiz_id'])) {
                                                $array_quiz_id = explode(', ', $row['quiz_id']);
                                                if (in_array($trainingQuizID, $array_quiz_id)) {
                                                    $trainingResult = $rowQuizResult['result'];

                                                    if ($trainingResult == 100) { $trainingStatus = "Completed"; }
                                                    else { $trainingStatus = "Not Yet Started"; }
                                    
                                                    $completed_date = $rowQuizResult['last_modified'];
                                                    $completed_date = new DateTime($completed_date);
                                                    $completed_date = $completed_date->format('M d, Y');
                                                    
                                                    $due_date = date('Y-m-d', strtotime('+1 year', strtotime($completed_date)) );
                                                    $due_date = new DateTime($due_date);
                                                    $due_date = $due_date->format('M d, Y');
                                                }
                                            }
                                        }
                                    }
                                }
								echo '<tr>
									<td>'. htmlentities($rowEmployee["last_name"]) .'</td>
									<td>'. htmlentities($rowEmployee["first_name"]) .'</td>
									<td>'. $rowEmployee["email"] .'</td>
									<td class="text-center">'; echo $trainingResult == 100 ? '<span class="label label-sm label-success">YES</span>':'<span class="label label-sm label-danger">NO</span>'; echo '</td>
								</tr>';

								$countTraining++;
							}
                        }

                        if ( $countTraining < 1 ) {
                        	echo '<tr class="text-center text-default"><td colspan="5">Empty Record</td></tr>';
                        }
                    } else {
                    	echo '<tr class="text-center text-default"><td colspan="5">Empty Record</td></tr>';
                    }
                    
                echo '</tbody>
            </table>
        </div>';

        mysqli_close($conn);
	}
    if( isset($_GET['modalView_HR_Employee_TP2']) ) {
        $id = $_GET['modalView_HR_Employee_TP2'];
        $type = $_GET['type'];

        $selectData = mysqli_query( $conn,"SELECT * FROM tbl_hr_employee WHERE ID = $id" );
        if ( mysqli_num_rows($selectData) > 0 ) {
            $row = mysqli_fetch_array($selectData);
            $user_id = $row['user_id'];
        }

        echo '<input class="form-control" type="hidden" name="ID" value="'. $row['ID'] .'" />
        <div class="tabbable tabbable-tabdrop">
            <div class="table-scrollable">
                <table class="table table-bordered table-hover" id="tableData_training">
                    <thead>
                        <tr>
                            <th>Description</th>
                            <th class="text-center">Date Completed</th>
                            <th class="text-center">Due Date</th>
                            <th class="text-center">Status</th>
                            <th class="text-center">Record</th>
                        </tr>
                    </thead>
                    <tbody>';
                        $selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE employee_id = $id" );
                        if ( mysqli_num_rows($selectUser) > 0 ) {
                            $rowUser = mysqli_fetch_array($selectUser);
                            $current_userID = $rowUser['ID'];
                            $current_userEmployeeID = employeeID($current_userID);
                            $current_userEmployerID = employerID($current_userID);

                            $selectTrainings = mysqli_query( $conn,"SELECT * FROM tbl_hr_trainings WHERE deleted = 0 AND user_id = $current_userEmployerID ORDER BY title" );
                            if ( mysqli_num_rows($selectTrainings) > 0 ) {
                                while($rowTraining = mysqli_fetch_array($selectTrainings)) {
                                    $training_ID = $rowTraining['ID'];
                                    $title = $rowTraining['title'];
                                    
                                    $data_last_modified = $rowTraining['last_modified'];
                                    $data_last_modified = new DateTime($data_last_modified);
                                    $data_last_modified = $data_last_modified->format('M d, Y');

                                    $found = null;
                                    $selectEmployee = mysqli_query( $conn,"SELECT * FROM tbl_hr_employee WHERE ID = $current_userEmployeeID" );
                                    if ( mysqli_num_rows($selectEmployee) > 0 ) {
                                        $rowEmployee = mysqli_fetch_array($selectEmployee);
                                        $array_row = explode(", ", $rowEmployee["job_description_id"]);
                                        $array_rowTraining = explode(", ", $rowTraining["job_description_id"]);
                                        foreach($array_row as $emp_JD) {
                                            if (in_array($emp_JD,$array_rowTraining)) {
                                                $found = true;
                                            }
                                        }
                                    }

                                    $trainingStatus = "Not Yet Started";
                                    $trainingResult = 0;
                                    $completed_date = '';
                                    $due_date = '';
                                    $pdf_quiz = '';
                                    $selectQuizResult = mysqli_query( $conn,"SELECT * FROM tbl_hr_quiz_result WHERE user_id = $current_userID " );
                                    if ( mysqli_num_rows($selectQuizResult) > 0 ) {
                                        while($rowQuizResult = mysqli_fetch_array($selectQuizResult)) {
                                            $trainingResultID = $rowQuizResult['ID'];
                                            $trainingQuizID = $rowQuizResult['quiz_id'];

                                            if (!empty($rowTraining['quiz_id'])) {
                                                $array_quiz_id = explode(', ', $rowTraining['quiz_id']);
                                                if (in_array($trainingQuizID, $array_quiz_id)) {
                                                    $trainingResult = $rowQuizResult['result'];
                                                    $pdf_quiz = $trainingResultID;

                                                    if ($trainingResult == 100) { $trainingStatus = "Completed"; }
                                                    else { $trainingStatus = "Not Yet Started"; }
                                    
                                                    $completed_date = $rowQuizResult['last_modified'];
                                                    $completed_date = new DateTime($completed_date);
                                                    $completed_date = $completed_date->format('M d, Y');
                                                    
                                                    $due_date = date('Y-m-d', strtotime('+1 year', strtotime($completed_date)) );
                                                    $due_date = new DateTime($due_date);
                                                    $due_date = $due_date->format('M d, Y');
                                                }
                                            }

                                        }
                                    }

                                    if ($type == 1 AND $trainingResult == 100) { $found = true; }
                                    else if ($type == 2 AND $trainingResult != 100) { $found = true; }
                                    else if ($type == 3 AND $trainingResult == 100) { $found = true; }
                                    else {
                                        $found = false;
                                    }

                                    if ( $found == true ) {
                                        echo '<tr id="tr_'.$training_ID.'">
                                            <td >'. htmlentities($title) .'</td>
                                            <td class="text-center">'; echo $trainingResult == 100 ? $completed_date:''; echo '</td>
                                            <td class="text-center">'; echo $trainingResult == 100 ? $due_date:''; echo '</td>
                                            <td class="text-center">'.$trainingStatus.'</td>
                                            <td class="text-center">'; echo $trainingResult == 100 ? '<a href="'.$base_url.'pdf?id='.$pdf_quiz.'" target="_blank" class="btn btn-circle btn-sm btn-success">View</a>':''; echo '</td>
                                        </tr>';
                                    }
                                }
                            }
                        }
                    echo '</tbody>
                </table>
            </div>
        </div>';

        mysqli_close($conn);
    }

	// Quiz Section
	if (isset($_GET['modalNew_HR_Quiz'])) {
		$modal = $_GET['modalNew_HR_Quiz'];
		
		echo '<input class="form-control" type="hidden" name="modal" value="'.$modal.'" />
		<div class="form-group">
	        <label class="col-md-3 control-label">Question</label>
	        <div class="col-md-8">
	            <textarea class="form-control" name="question" style="height:150px;" required ></textarea>
	        </div>
	    </div>
	    <div class="form-group">
	        <label class="col-md-3 control-label">Choices</label>
	        <div class="col-md-8">
	            <div class="mt-repeater">
	                <div data-repeater-list="choices">
	                    <div class="mt-repeater-item row" data-repeater-item>
	                        <div class="col-md-10">
	                            <input type="text" class="form-control" name="choice" required />
	                        </div>
	                        <div class="col-md-2 text-right">
	                            <a href="javascript:;" data-repeater-delete class="btn btn-danger"><i class="fa fa-close"></i></a>
	                        </div>
	                    </div>
	                </div>
	                <a href="javascript:;" data-repeater-create class="btn btn-success mt-repeater-add"><i class="fa fa-plus"></i> Add option</a>
	            </div>
	        </div>
	    </div>
	    <div class="form-group">
	        <label class="col-md-3 control-label">Answer</label>
	        <div class="col-md-8">
	            <select class="form-control" name="answer" id="answer" required>
	                <option value="0">a</option>
	            </select>
	        </div>
	    </div>';
	}
	if (isset($_GET['modalEdit_HR_Quiz'])) {
		$id = $_GET['modalEdit_HR_Quiz'];
		$modal = $_GET['m'];
		
		$selectData = mysqli_query( $conn,"SELECT * FROM tbl_hr_quiz WHERE ID = $id" );
        if ( mysqli_num_rows($selectData) > 0 ) {
            $row = mysqli_fetch_array($selectData);
	        $data_choices = $row['choices'];
	        $data_answer = $row['answer'];
	        $count_answer = 0;
        }

		echo '<input class="form-control" type="hidden" name="ID" value="'.$row['ID'].'" />
		<input class="form-control" type="hidden" name="modal" value="'.$modal.'" />
		<div class="form-group">
	        <label class="col-md-3 control-label">Question</label>
	        <div class="col-md-8">
	            <textarea class="form-control" name="question" style="height:150px;" required >'.$row['question'].'</textarea>
	        </div>
	    </div>
	    <div class="form-group">
	        <label class="col-md-3 control-label">Choices</label>
	        <div class="col-md-8">
	            <div class="mt-repeater">
	                <div data-repeater-list="choices">';

	                	if (!empty($data_choices)) {
							$choices_arr = explode(" | ", $data_choices);
							foreach ($choices_arr as $value) {
		                		echo '<div class="mt-repeater-item row" data-repeater-item>
			                        <div class="col-md-10">
			                            <input type="text" class="form-control" name="choice" value="'.$value.'" required />
			                        </div>
			                        <div class="col-md-2 text-right">
			                            <a href="javascript:;" data-repeater-delete class="btn btn-danger"><i class="fa fa-close"></i></a>
			                        </div>
			                    </div>';

			                    $count_answer++;
							}
	                	} else {
	                		echo '<div class="mt-repeater-item row" data-repeater-item>
		                        <div class="col-md-10">
		                            <input type="text" class="form-control" name="choice" required />
		                        </div>
		                        <div class="col-md-2 text-right">
		                            <a href="javascript:;" data-repeater-delete class="btn btn-danger"><i class="fa fa-close"></i></a>
		                        </div>
		                    </div>';

			                $count_answer++;
	                	}

	                echo '</div>
	                <a href="javascript:;" data-repeater-create class="btn btn-success mt-repeater-add"><i class="fa fa-plus"></i> Add option</a>
	            </div>
	        </div>
	    </div>
	    <div class="form-group">
	        <label class="col-md-3 control-label">Answer</label>
	        <div class="col-md-8">
	            <select class="form-control" name="answer" id="answer" required>';

	            	$alphabet = range('a', 'z');
	            	for ($i=0; $i < $count_answer; $i++) {
	            		echo '<option value="'.$i.'" '; echo $data_answer == $i ? 'SELECTED':''; echo '>'.$alphabet[$i].'</option>';
	            	}
	                
	            echo '</select>
	        </div>
	    </div>';
	}
	if (isset($_GET['modalEdit_HR_QuizSet'])) {
		$id = $_GET['modalEdit_HR_QuizSet'];
		
		$selectData = mysqli_query( $conn,"SELECT * FROM tbl_hr_quiz_set WHERE ID = $id" );
        if ( mysqli_num_rows($selectData) > 0 ) {
            $row = mysqli_fetch_array($selectData);
	        $title = $row['title'];
	        $language = $row['language'];
	        $status = $row['status'];
	        $quiz_id = $row['quiz_id'];
        }

	    echo '<input class="form-control" type="hidden" name="ID" value="'.$id.'" />
	    <div class="form-group">
            <label class="col-md-3 control-label">Title</label>
            <div class="col-md-8">
                <input class="form-control" type="text" name="title" value="'.$title.'" required />
            </div>
        </div>
	    <div class="form-group">
	        <label class="col-md-3 control-label">Language</label>
	        <div class="col-md-8">
	            <select class="form-control" name="language" required>
	                <option value="0" '; echo $language == 0 ? 'SELECTED':''; echo '>English</option>
	                <option value="1" '; echo $language == 1 ? 'SELECTED':''; echo '>English - Spanish</option>
	                <option value="2" '; echo $language == 2 ? 'SELECTED':''; echo '>English - Arabic</option>
	            </select>
	        </div>
	    </div>
        <div class="form-group">
            <label class="col-md-3 control-label">Add Question</label>
            <div class="col-md-8">
                <a href="#modalNew_HR_Quiz" data-toggle="modal" class="btn green" onclick="btnNew_Quiz(2)">Create</a>
            </div>
        </div>
        <div class="form-group">
            <label class="control-label col-md-3">Status</label>
            <div class="col-md-8">
                <input type="checkbox" class="make-switch" name="status" data-on-text="Active" data-off-text="Inactive" data-on-color="success" data-off-color="danger" '; echo $status == 1 ? 'checked':''; echo ' />
            </div>
        </div>

        <div class="table-scrollable">
            <table class="table table-bordered table-hover" id="tableData_Quiz_2">
                <thead>
                    <tr>
                        <th>Item</th>
                        <th class="text-center" style="width: 80px;">Answer</th>
                        <th class="text-center" style="width: 135px;">Action</th>
                    </tr>
                </thead>
                <tbody>';

                	if (!empty($quiz_id)) {
                		$arr_quiz = explode(', ', $quiz_id);
                		foreach ($arr_quiz as $value) {
		                    $selectDataQuiz = mysqli_query( $conn,"SELECT * FROM tbl_hr_quiz WHERE ID = $value" );
					        if ( mysqli_num_rows($selectDataQuiz) > 0 ) {
					            $rowQuiz = mysqli_fetch_array($selectDataQuiz);
						        $ID = $rowQuiz['ID'];
						        $question = $rowQuiz['question'];

                        		$data_choices = $rowQuiz['choices'];
								$choices_arr = explode(" | ", $data_choices);
								$choices = '<ol type="a">';
								foreach ($choices_arr as $value) { $choices .= '<li>'.$value.'</li>'; }
								$choices .= '</ol>';

						        $answer = $rowQuiz['answer'];
						        $alphabet = range('a', 'z');

						        echo '<tr id="tr_'.$ID.'">
	                                <td><strong>'.htmlentities($question ?? '').'</strong><br>'.$choices.'</td>
	                                <td class="text-center">'.$alphabet[$answer].'</td>
	                                <td class="text-center">
	                                    <input class="form-control" type="hidden" name="item[]" value="'.$ID.'" />
	                                    <div class="btn-group btn-group-circle">
	                                        <a href="#modalUpdate_HR_Quiz" class="btn btn-outline dark btn-sm" data-toggle="modal" onclick="btnEdit_Quiz('.$ID.', 2)">Edit</a>
	                                        <a href="javascript:;" class="btn btn-danger btn-sm" onclick="btnDelete_Quiz('.$ID.', 2)">Delete</a>
	                                    </div>
	                                </td>
	                            </tr>';
					        }
		                }
                	}

                echo '</tbody>
            </table>
        </div>';
	}
	if( isset($_GET['btnDelete_Quiz']) ) {
		$id = $_GET['btnDelete_Quiz'];

    	$current_userID = $_COOKIE['ID'];
		$reason = addslashes($_GET['reason']);

        $message = array();
		array_push($message, $current_userID);
		array_push($message, $reason);
		$message = implode(" | ",$message);

		mysqli_query( $conn,"UPDATE tbl_hr_quiz SET deleted = 1, reason = '". $message ."' WHERE ID='". $id ."'" );
	}
    if( isset($_GET['btnDelete_Q']) ) {
        $id = $_GET['btnDelete_Q'];
        mysqli_query( $conn,"UPDATE tbl_hr_quiz_set set deleted = 1 WHERE ID = $id" );
    }
	if( isset($_POST['btnSave_HR_Quiz']) ) {
		if (!empty($_COOKIE['switchAccount'])) {
			$portal_user = $_COOKIE['ID'];
			$user_id = $_COOKIE['switchAccount'];
		}
		else {
			$portal_user = $_COOKIE['ID'];
			$user_id = employerID($portal_user);
		}

		$modal = $_POST['modal'];
		$question = addslashes($_POST['question']);
		$answer = $_POST['answer'];
		$last_modified = date('Y-m-d');

		$choices = '';
		$arr_choices = array();
		if (!empty($_POST["choices"])) {
			for ($i=0; $i < count($_POST["choices"]); $i++) {
				$choices = implode('*', $_POST['choices'][$i]);
				array_push( $arr_choices, addslashes($choices) );
			}
			$choices = implode(' | ', $arr_choices);
		}

		$sql = "INSERT INTO tbl_hr_quiz (user_id, portal_user, question, choices, answer, last_modified)
		VALUES ('$user_id', '$portal_user', '$question', '$choices', '$answer', '$last_modified')";

		if (mysqli_query($conn, $sql)) {
			$last_id = mysqli_insert_id($conn);

			$selectData = mysqli_query( $conn,'SELECT * FROM tbl_hr_quiz WHERE user_id="'. $user_id .'" AND ID="'. $last_id .'" ORDER BY ID LIMIT 1' );
			if ( mysqli_num_rows($selectData) > 0 ) {
				$rowData = mysqli_fetch_array($selectData);
				$data_ID = $rowData['ID'];
				$data_question = stripcslashes(htmlentities($rowData['question']));

				$data_choices = $rowData['choices'];
				$choices_arr = explode(" | ", $data_choices);
				$choices = '<ol type="a">';
				foreach ($choices_arr as $value) { $choices .= '<li>'.htmlentities($value).'</li>'; }
				$choices .= '</ol>';

				$data_answer = $rowData['answer'];
            	$alphabet = range('a', 'z');

				$output = array(
					"modal" => $modal,
					"ID" => $data_ID,
					"question" => $data_question,
					"choices" => $choices,
					"answer" => $alphabet[$data_answer]
				);
				echo json_encode($output);
			}
		}
		mysqli_close($conn);
	}
	if( isset($_POST['btnUpdate_HR_Quiz']) ) {
		if (!empty($_COOKIE['switchAccount'])) {
			$portal_user = $_COOKIE['ID'];
			$user_id = $_COOKIE['switchAccount'];
		}
		else {
			$portal_user = $_COOKIE['ID'];
			$user_id = employerID($portal_user);
		}

		$ID = $_POST['ID'];
		$modal = $_POST['modal'];
		$question = addslashes($_POST['question']);
		$answer = $_POST['answer'];
		$last_modified = date('Y-m-d');

		$choices = '';
		$arr_choices = array();
		if (!empty($_POST["choices"])) {
			for ($i=0; $i < count($_POST["choices"]); $i++) {
				$choices = implode('*', $_POST['choices'][$i]);
				array_push( $arr_choices, addslashes($choices) );
			}
			$choices = implode(' | ', $arr_choices);
		}

		mysqli_query( $conn,"UPDATE tbl_hr_quiz set user_id='". $user_id ."', portal_user='". $portal_user ."', question='". $question ."', choices='". $choices ."', answer='". $answer ."', last_modified='". $last_modified ."' WHERE ID='". $ID ."'" );

		if (!mysqli_error($conn)) {
			$selectData = mysqli_query( $conn,'SELECT * FROM tbl_hr_quiz WHERE ID="'. $ID .'" ORDER BY ID LIMIT 1' );
			if ( mysqli_num_rows($selectData) > 0 ) {
				$rowData = mysqli_fetch_array($selectData);
				$data_ID = $rowData['ID'];
                $data_question = stripcslashes(htmlentities($rowData['question']));

				$data_choices = $rowData['choices'];
				$choices_arr = explode(" | ", $data_choices);
				$choices = '<ol type="a">';
                foreach ($choices_arr as $value) { $choices .= '<li>'.htmlentities($value).'</li>'; }
				$choices .= '</ol>';

				$data_answer = $rowData['answer'];
            	$alphabet = range('a', 'z');

				$output = array(
					"modal" => $modal,
					"ID" => $data_ID,
					"question" => $data_question,
					"choices" => $choices,
					"answer" => $alphabet[$data_answer]
				);
				echo json_encode($output);
			}
		}
		mysqli_close($conn);
	}
	if( isset($_POST['btnSave_HR_QuizSet']) ) {
		if (!empty($_COOKIE['switchAccount'])) {
			$portal_user = $_COOKIE['ID'];
			$user_id = $_COOKIE['switchAccount'];
		}
		else {
			$portal_user = $_COOKIE['ID'];
			$user_id = employerID($portal_user);
		}

		$title = addslashes($_POST['title']);
		$language = $_POST['language'];
		$status = isset($_POST['status']) ? 1 : 0;
		$last_modified = date('Y-m-d');

		$item = "";
		if (!empty($_POST["item"])) { $item = implode(", ", $_POST["item"]); }

		$sql = "INSERT INTO tbl_hr_quiz_set (user_id, portal_user, title, language, quiz_id, status, last_modified)
		VALUES ('$user_id', '$portal_user', '$title', '$language', '$item', '$status', '$last_modified')";

		if (mysqli_query($conn, $sql)) {
			$last_id = mysqli_insert_id($conn);

			$selectData = mysqli_query( $conn,'SELECT * FROM tbl_hr_quiz_set WHERE user_id="'. $user_id .'" AND ID="'. $last_id .'" ORDER BY ID LIMIT 1' );
			if ( mysqli_num_rows($selectData) > 0 ) {
				$rowData = mysqli_fetch_array($selectData);
				$data_ID = $rowData['ID'];

				$output = array(
					"ID" => $data_ID,
                    "title" => stripcslashes(htmlentities($title ?? '')),
					"status" => $status
				);
				echo json_encode($output);
			}
		}
		mysqli_close($conn);
	}
	if( isset($_POST['btnUpdate_HR_QuizSet']) ) {
		if (!empty($_COOKIE['switchAccount'])) {
			$portal_user = $_COOKIE['ID'];
			$user_id = $_COOKIE['switchAccount'];
		}
		else {
			$portal_user = $_COOKIE['ID'];
			$user_id = employerID($portal_user);
		}

		$ID = addslashes($_POST['ID']);
		$title = addslashes($_POST['title']);
		$language = $_POST['language'];
		$status = isset($_POST['status']) ? 1 : 0;
		$last_modified = date('Y-m-d');

		$item = "";
		if (!empty($_POST["item"])) { $item = implode(", ", $_POST["item"]); }

		mysqli_query( $conn,"UPDATE tbl_hr_quiz_set set title='". $title ."', language='". $language ."', quiz_id='". $item ."', status='". $status ."', last_modified='". $last_modified ."' WHERE ID='". $ID ."'" );

		if (!mysqli_error($conn)) {
			$last_id = mysqli_insert_id($conn);

			$selectData = mysqli_query( $conn,'SELECT * FROM tbl_hr_quiz_set WHERE ID="'. $ID .'" ORDER BY ID LIMIT 1' );
			if ( mysqli_num_rows($selectData) > 0 ) {
				$rowData = mysqli_fetch_array($selectData);
				$data_ID = $rowData['ID'];

				$output = array(
					"ID" => $data_ID,
                    "title" => stripcslashes(htmlentities($title ?? '')),
					"status" => $status
				);
				echo json_encode($output);
			}
		}
		mysqli_close($conn);
	}


	// DEPARTMENT PAGE
	if( isset($_GET['modalView_HR_Department']) ) {
		$id = $_GET['modalView_HR_Department'];
        $c = $_GET['c'];

        $selectData = mysqli_query( $conn,"SELECT * FROM tbl_hr_department WHERE ID = $id" );
        if ( mysqli_num_rows($selectData) > 0 ) {
            $row = mysqli_fetch_array($selectData);

			$filetype = $row['filetype'];
			$files = $row["files"];
			$type = 'iframe';
			if (!empty($files)) {
				if ($filetype == 1) {
				    $fileExtension = fileExtension($files);
					$src = $fileExtension['src'];
					$embed = $fileExtension['embed'];
					$type = $fileExtension['type'];
					$file_extension = $fileExtension['file_extension'];
				    $url = $base_url.'uploads/';

				    $files = $src.$url.rawurlencode($files).$embed;
				} else if ($filetype == 3) {
					$files = preg_replace('#[^/]*$#', '', $files).'preview';
				}
			}
        }

        echo '<input class="form-control" type="hidden" name="ID" value="'. $row['ID'] .'" />
        <input class="form-control" type="hidden" name="c" value="'. $c .'" />
        <input class="form-control" type="hidden" name="files" id="files" value="'. $row['files'] .'" />
        <div class="form-group">
            <label class="col-md-3 control-label">Department Name</label>
            <div class="col-md-8">
                <input class="form-control" type="text" name="title" value="'. $row['title'] .'" required />
            </div>
        </div>
        <div class="form-group">
            <label class="col-md-3 control-label">Description</label>
            <div class="col-md-8">
                <textarea class="form-control" name="description" style="height:100px !important;" required >'. $row['description'] .'</textarea>
            </div>
        </div>
        <div class="form-group '; echo $_COOKIE['client'] == 1 ? 'hide':''; echo '">
            <label class="col-md-3 control-label">Document</label>
            <div class="col-md-8">
            	<select class="form-control '; echo !empty($files) ? 'hide':''; echo '" name="filetype" onchange="changeType(this)" required>
	            	<option value="0">Select option</option>
	            	<option value="1">Manual Upload</option>
	            	<option value="2">Youtube URL</option>
	            	<option value="3">Google Drive URL</option>
	            </select>
	            <input class="form-control margin-top-15 fileUpload" type="file" name="file" style="display: none;" />
	            <input class="form-control margin-top-15 fileURL" type="url" name="fileurl" style="display: none;" placeholder="https://" />
                <p class="'; echo !empty($files) ? '':'hide'; echo '" style="margin: 0;"><a href="'.$files.'" data-src="'.$files.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a> | <button type="button" class="btn btn-link uploadNew" onclick="uploadNew(this)">Upload New</button></p>
            </div>
        </div>
        <div class="form-group">
            <label class="control-label col-md-3">Status</label>
            <div class="col-md-8">
            	<input type="checkbox" class="make-switch" name="status" data-on-text="Active" data-off-text="Inactive" data-on-color="success" data-off-color="danger"'; echo $row['status'] === "1" ? "checked" : "";  echo '>
            </div>
        </div>

        <div class="form-group">
            <label class="col-md-1 control-label"></label>
            <div class="col-md-10">
                <label>EMPLOYEE</label>
                <div class="portlet-body">
                    <div class="table-scrollable">
                        <table class="table table-bordered table-hover">
                            <thead>
                                <tr>
                                    <th>Nos.</th>
                                    <th>First Name</th>
                                    <th>Last Name</th>
                                    <th>Position</th>
                                    <th>Status</th>
                                    <th>Email</th>
                                </tr>
                            </thead>
                            <tbody>';

                            	$ID = $row["ID"];
                                $selectEmployee = mysqli_query( $conn,"SELECT * FROM tbl_hr_employee WHERE suspended = 0 AND status = 1 AND FIND_IN_SET($ID, REPLACE(department_id, ' ', '')) ORDER BY last_name" );
                                if ( mysqli_num_rows($selectEmployee) > 0 ) {
                                    $table_counter = 1;
			                        while($rowEmployee = mysqli_fetch_array($selectEmployee)) {
                                        if ($_COOKIE['client'] == 1) {
                                            $employment_type = array(
                                                1 => 'Full-time',
                                                2 => 'Part-Time',
                                                3 => 'OJT',
                                                4 => 'Freelance',
                                                5 => 'Part-Time Apprentice',
                                                6 => 'Trainee',
                                                7 => 'Consultant',
                                                8 => 'Contractor',
                                                9 => 'Salaried',
                                                10 => 'Seasonal'
                                            );
                                        } else {
                                            $employment_type = array(
                                                1 => 'Full-time',
                                                2 => 'Part-Time Project',
                                                3 => 'OJT',
                                                4 => 'Freelance',
                                                5 => 'Part-Time Apprentice',
                                                6 => 'Trainee',
                                                7 => 'Consultant',
                                                8 => 'Contractor',
                                                9 => 'Salaried',
                                                10 => 'Seasonal'
                                            );
                                        }

                                        $position = array();
                                        $jd = $rowEmployee["job_description_id"];
                                        if (!empty($jd)) {
                                            $jd_arr = explode(", ", $jd);
                                            foreach ($jd_arr as $value) {
                                                $resultJD = mysqli_query( $conn,"SELECT * FROM tbl_hr_job_description WHERE ID = $value" );
                                                if ( mysqli_num_rows($resultJD) > 0 ) {
                                                    $rowJD = mysqli_fetch_array($resultJD);
                                                    array_push($position, $rowJD["title"]);
                                                }
                                            }
                                        }
                                        $position = implode(', ', $position);

			                        	echo '<tr>
                                            <td>'. $table_counter++ .'</td>
                                            <td>'. $rowEmployee["last_name"] .'</td>
                                            <td>'. $rowEmployee["first_name"] .'</td>
                                            <td>'. $position .'</td>
                                            <td>'. $employment_type[$rowEmployee["type_id"]] .'</td>
                                            <td>'. $rowEmployee["email"] .'</td>
                                        </tr>';
			                        }
			                    } else {
			                    	echo '<tr class="text-center text-default"><td colspan="5">Empty Record</td></tr>';
			                    }
                                
                            echo '</tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>';

        mysqli_close($conn);
	}
    if( isset($_GET['btnDelete_HR_Department']) ) {
        $id = $_GET['btnDelete_HR_Department'];
        mysqli_query( $conn,"UPDATE tbl_hr_department set deleted = 1 WHERE ID = $id" );
    }
	if( isset($_POST['btnSave_HR_Department']) ) {
		$ID = $_POST['ID'];
		$title = addslashes($_POST['title']);
		$description = addslashes($_POST['description']);
		// $capacity = $_POST['capacity'];
		$capacity = 0;
        $arr_item = array();
        $process = true;

		$filetype = $_POST['filetype'];
		if ($filetype == 1) {
			$files = $_FILES['file']['name'];
			if (!empty($files)) {
				$path = 'uploads/';
                $filesize = $_FILES['file']['size'];
				$tmp = $_FILES['file']['tmp_name'];
                $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                $ext = strtolower(pathinfo($files, PATHINFO_EXTENSION));
				$files = rand(1000,1000000) . ' - ' . $files;
				$path = $path.$files;

                if(!in_array($ext, $invalid_extensions)) {
                    move_uploaded_file($tmp,$path);
                } else {
                    $process = false;
                }
			}
		} else {
			$files = $_POST['fileurl'];
            $filesize = 0;
		}

        if ($process == true) {
            $output = array (
                'type'  =>  $filetype,
                'name' =>  $files,
                'size' =>  $filesize,
                'date' =>  $local_date
            );
            array_push($arr_item, $output);
            $file_history = json_encode($arr_item, JSON_HEX_APOS | JSON_UNESCAPED_UNICODE);

            $sql = "INSERT INTO tbl_hr_department (user_id, title, description, files, filetype, filesize, file_history, capacity)
            VALUES ('$ID', '$title', '$description', '$files', '$filetype', '$filesize', '$file_history', '$capacity')";

    		if (mysqli_query($conn, $sql)) {

    			$last_id = mysqli_insert_id($conn);
    			$selectData = mysqli_query( $conn,'SELECT * FROM tbl_hr_department WHERE user_id="'. $ID .'" AND ID="'. $last_id .'" ORDER BY ID LIMIT 1' );

    			if ( mysqli_num_rows($selectData) > 0 ) {
    				$rowData = mysqli_fetch_array($selectData);
    				$data_ID = $rowData['ID'];

                    $filetype = $rowData['filetype'];
                    $files = $rowData["files"];
                    $type = 'iframe';
                    if (!empty($files)) {
                        if ($filetype == 1) {
                            $fileExtension = fileExtension($files);
                            $src = $fileExtension['src'];
                            $embed = $fileExtension['embed'];
                            $type = $fileExtension['type'];
                            $file_extension = $fileExtension['file_extension'];
                            $url = $base_url.'uploads/';

                            $files = $src.$url.rawurlencode($files).$embed;
                        } else if ($filetype == 3) {
                            $files = preg_replace('#[^/]*$#', '', $files).'preview';
                        }
                    }
                    $viewFile = '<p class="'; $viewFile .= !empty($files) ? '':'hide'; $viewFile .= '" style="margin: 0;"><a href="'.$files.'" data-src="'.$files.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a></p>';

                	$counterup_tbl = counterup_tbl('department');
    				$output = array(
    					"ID" => $data_ID,
    					"title" => stripcslashes($title),
    					"description" => stripcslashes($description),
                        "viewFile" => $viewFile,
    					"capacity" => $capacity
    				);

    				$result = array_merge($counterup_tbl, $output);
    				echo json_encode($result);
    			}
    		}
    		mysqli_close($conn);
    	}
    }
	if( isset($_POST['btnUpdate_HR_Department']) ) {
		$ID = $_POST['ID'];	 
        $c = $_POST['c'];  
		$title = addslashes($_POST['title']);
		$description = addslashes($_POST['description']);
		$files = $_POST['files'];
		//$files = "";
		// $capacity = $_POST['capacity'];
		$capacity = 0;
		$status = isset($_POST['status']) ? 1 : 0;
		$status_last_modified = date('Y-m-d');
        $process = true;

		mysqli_query( $conn,"UPDATE tbl_hr_department set title='". $title ."', description='". $description ."', capacity='". $capacity ."', status='". $status ."', last_modified='". $status_last_modified ."' WHERE ID='". $ID ."'" );
		
		if (!mysqli_error($conn)) {
            $selectData = mysqli_query( $conn,"SELECT * FROM tbl_hr_department WHERE ID = $ID" );
            if ( mysqli_num_rows($selectData) > 0 ) {
                $rowData = mysqli_fetch_array($selectData);

                $files = '';
                $arr_item = array();
                if (!empty($rowData["file_history"])) {
                    $arr_item = json_decode($rowData["file_history"],true);
                }
                $filetype = $_POST['filetype'];
                if ($filetype > 0) {
                    if ($filetype == 1) {
                        $files = $_FILES['file']['name'];
                        if (!empty($files)) {
                            $path = 'uploads/';
                            $filesize = $_FILES['file']['size'];
                            $tmp = $_FILES['file']['tmp_name'];
                            $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                            $ext = strtolower(pathinfo($files, PATHINFO_EXTENSION));
                            $files = rand(1000,1000000) . ' - ' . $files;
                            $path = $path.$files;

                            if(!in_array($ext, $invalid_extensions)) {
                                move_uploaded_file($tmp,$path);

                                $filesize_tot = $filesize + $rowData["filesize"];

                                mysqli_query( $conn,"UPDATE tbl_hr_department SET filesize='". $filesize_tot ."' WHERE ID='". $ID ."'" );
                            } else {
                                $process = false;
                            }
                        }
                    } else {
                        $files = $_POST['fileurl'];
                        $filesize = 0;
                    }

                    if (!empty($files) AND $process == true) {
                        $output = array (
                            'type'  =>  $filetype,
                            'name' =>  $files,
                            'size' =>  $filesize,
                            'date' =>  $local_date
                        );
                        array_push($arr_item, $output);
                        $file_history = json_encode($arr_item, JSON_HEX_APOS | JSON_UNESCAPED_UNICODE);

                        mysqli_query( $conn,"UPDATE tbl_hr_department SET files='". $files ."', filetype='". $filetype ."', file_history='". $file_history ."' WHERE ID='". $ID ."'" );
                    }
                }
            }

            if ($process == true) {

    			//echo "Updated!" . mysqli_error($conn);

                $filetype = $rowData['filetype'];
                $files = $rowData["files"];
                $type = 'iframe';
                if (!empty($files)) {
                    if ($filetype == 1) {
                        $fileExtension = fileExtension($files);
                        $src = $fileExtension['src'];
                        $embed = $fileExtension['embed'];
                        $type = $fileExtension['type'];
                        $file_extension = $fileExtension['file_extension'];
                        $url = $base_url.'uploads/';

                        $files = $src.$url.rawurlencode($files).$embed;
                    } else if ($filetype == 3) {
                        $files = preg_replace('#[^/]*$#', '', $files).'preview';
                    }
                }
                $viewFile = '<p class="'; $viewFile .= !empty($files) ? '':'hide'; $viewFile .= '" style="margin: 0;"><a href="'.$files.'" data-src="'.$files.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a></p>';

    			// $dept_id = $row["ID"];
                $countDepartment = 0;
                $selectEmployee = mysqli_query( $conn,"SELECT * FROM tbl_hr_employee WHERE department_id = $ID " );
                if ( mysqli_num_rows($selectEmployee) > 0 ) {
                    while($rowEmployee = mysqli_fetch_array($selectEmployee)) {
                        $countDepartment++;
                    }
                }
                // $capacityPercentage = intval( ( $countDepartment / $capacity ) * 100);
                // $compliance = $capacityPercentage .'% ('. $countDepartment .'/'.$capacity.')';

                $counterup_tbl = counterup_tbl('department');
    			$output = array(
    				'ID' => $ID,
                    'c' => $c,
    				'title' => stripcslashes($title),
    				'description' => stripcslashes($description),
    				// 'compliance' => $compliance,
                    'viewFile' => $viewFile,
    				'status' => $status
    			);

    			$result = array_merge($counterup_tbl, $output);
    			echo json_encode($result);
                mysqli_close($conn);
    		}
        }
	}


	// FFVA PAGE
	if( isset($_GET['modalNew_FFVA']) ) {
		$id = $_GET['modalNew_FFVA'];

		if (!empty($_COOKIE['switchAccount'])) {
			$portal_user = $_COOKIE['ID'];
			$user_id = $_COOKIE['switchAccount'];
		}
		else {
			$portal_user = $_COOKIE['ID'];
			$user_id = employerID($portal_user);
		}

		// Override arnel signature into SPI if match
		if ($user_id == 250) {
			$arnel_signature = $arnel_signature_spi;
		}

		$selectUser = mysqli_query( $conn,"SELECT * from tbl_user WHERE ID = 35" );
        if ( mysqli_num_rows($selectUser) > 0 ) {
            $rowUser = mysqli_fetch_array($selectUser);
            $current_userFName = $rowUser['first_name'];
            $current_userLName = $rowUser['last_name'];
        }

        $selectEnterprise = mysqli_query( $conn,"SELECT * from tblEnterpiseDetails WHERE users_entities = $user_id" );
        if ( mysqli_num_rows($selectEnterprise) > 0 ) {
            $rowEnterprise = mysqli_fetch_array($selectEnterprise);
            $enterp_name = $rowEnterprise['businessname'];
        } else {
        	$enterp_name = "";
        }

		echo '<input type="hidden" value="'.$id.'" name="tab" />
		<div class="tabbable tabbable-tabdrop" id="tabdrop_1">
            <ul class="nav nav-tabs">
                <li class="active">
                    <a href="#tabProfile" data-toggle="tab">Profile</a>
                </li>
                <li>
                    <a href="#tabQuestionaire" data-toggle="tab">Questionaire</a>
                </li>
                <li>
                    <a href="#tabActivities" data-toggle="tab">Activities</a>
                </li>
                <li>
                    <a href="#tabAssigned" data-toggle="tab">Assigned</a>
                </li>
            </ul>
            <div class="tab-content margin-top-20">
                <div class="tab-pane active" id="tabProfile">
                    <div class="row '; echo $id == 2 ? 'hide':''; echo '">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="control-label">Supplier Name</label>
                                <input class="form-control" type="text" name="company" '; echo $id == 1 ? 'required':''; echo ' />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="control-label">Website</label>
                                <input class="form-control" type="text" name="website" '; echo $id == 1 ? 'required':''; echo ' />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="control-label">Headquarters</label>
                                <input class="form-control" type="text" name="headquarters" '; echo $id == 1 ? 'required':''; echo ' />
                            </div>
                        </div>
                    </div>
                    <div class="row '; echo $id == 2 ? 'hide':''; echo '">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="control-label">Telephone Number</label>
                                <input class="form-control" type="text" name="telephone" '; echo $id == 1 ? 'required':''; echo ' />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="control-label">Email</label>
                                <input class="form-control" type="email" name="email" '; echo $id == 1 ? 'required':''; echo ' />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="control-label">Contact Person</label>
                                <input class="form-control" type="text" name="person"  '; echo $id == 1 ? 'required':''; echo ' />
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label class="control-label">Product or ingredient or raw material</label>
                                <textarea class="form-control" name="product" required ></textarea>
                            </div>
                        </div>
                        <div class="col-md-12">
                            <div class="form-group">
                                <label class="control-label">Materials names and/or codes included in this assessment</label>
                                <textarea class="form-control" name="assessment" required ></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="control-label">Category</label>
                                <select class="form-control" name="category">';

                                    $selectCategory = mysqli_query( $conn,"SELECT * FROM tbl_ffva_category" );
                                    if ( mysqli_num_rows($selectCategory) > 0 ) {
                                        while($rowCategory = mysqli_fetch_array($selectCategory)) {
                                            echo '<option value="'.$rowCategory["ID"].'">'.$rowCategory["name"].'</option>';
                                        }
                                    }

                                echo '</select>
                                <input class="form-control margin-top-15" type="text" name="category_other" placeholder="Specify if other" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="control-label">Industry</label>
                                <select class="form-control" name="industry">';

                                    $selectIndustry = mysqli_query( $conn,"SELECT * FROM tbl_ffva_industry" );
                                    if ( mysqli_num_rows($selectIndustry) > 0 ) {
                                        while($rowIndustry = mysqli_fetch_array($selectIndustry)) {
                                            echo '<option value="'.$rowIndustry["ID"].'">'.$rowIndustry["name"].'</option>';
                                        }
                                    }

                                echo '</select>
                                <input class="form-control margin-top-15" type="text" name="industry_other" placeholder="Specify if other" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="control-label">Document Number</label>
                                <input class="form-control" type="text" name="code" required />
                            </div>
                            <div class="form-group">
                                <label class="col-md-4 control-label mt-radio-inline">Receive Notification?</label>
                                <div class="col-md-8">
                                    <div class="mt-radio-inline">
                                        <label class="mt-radio">
                                            <input type="radio" name="notification" value="0" checked /> No
                                            <span></span>
                                        </label>
                                        <label class="mt-radio">
                                            <input type="radio" name="notification"  value="1" /> Yes
                                            <span></span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="tab-pane" id="tabQuestionaire">
                    <h4><strong>Likelihood Questionnaire</strong></h4>
                    <h5>Assessment of Likelihood That Food Fraud Will Affect This Material</h5>

                    <div class="table-scrollable">
                        <table class="table table-bordered">
                            <tr class="bg-default">
                                <th class="text-center" colspan="5">Legend</th>
                            </tr>
                            <tr>
                                <td style="width: 20%; background: #80d3a8;">1 - Very Unlikely</td>
                                <td style="width: 20%; background: #c7e39f;">2 - Unlikely</td>
                                <td style="width: 20%; background: #fff980;">3 - Fairly Likely</td>
                                <td style="width: 20%; background: #fcc98e;">4 - Likely</td>
                                <td style="width: 20%; background: #f68d92;">5 - Very Likely or Certain</td>
                            </tr>
                        </table>
                    </div>

                    <div class="table-scrollable">
                        <table class="table table-bordered tableQuestionaire_1">
                            <thead>
                                <tr class="bg-default">
                                    <th class="text-center">Element</th>
                                    <th class="text-center">Question</th>
                                    <th class="text-center">Answer</th>
                                    <th class="text-center" style="width: 300px;">Comment</th>
                                    <th class="text-center" style="width: 210px;">Determination</th>
                                    <th class="text-center" style="width: 110px;">Action</th>
                                </tr>
                            </thead>
                            <tbody>';

                            	$selectLikelihood = mysqli_query( $conn,"SELECT * FROM tbl_ffva_likelihood" );
                                if ( mysqli_num_rows($selectLikelihood) > 0 ) {
                                    while($rowLikelihood = mysqli_fetch_array($selectLikelihood)) {
                                    	$likelihood_type_arr = explode(', ', $rowLikelihood["type"]);
                                    	if (in_array($id, $likelihood_type_arr)) {
	                                    	$likelihood_ID = $rowLikelihood["ID"];
	                                    	$likelihood_element = $rowLikelihood["element"];
	                                    	$likelihood_question = $rowLikelihood["question"];
	                                    	$likelihood_very_unlikely = $rowLikelihood["very_unlikely"];
	                                    	$likelihood_unlikely = $rowLikelihood["unlikely"];
	                                    	$likelihood_fairly_likely = $rowLikelihood["fairly_likely"];
	                                    	$likelihood_likely = $rowLikelihood["likely"];
	                                    	$likelihood_very_likely = $rowLikelihood["very_likely"];

											$ref_content = '';
											$resultRef = mysqli_query( $conn,"SELECT * FROM tbl_ffva_reference WHERE type = 1 AND element = $likelihood_ID" );
									        if ( mysqli_num_rows($resultRef) > 0 ) {
									        	$rowRef = mysqli_fetch_array($resultRef);
									        	$ref_content = $rowRef["content"];
									        }

	                                        echo '<tr class="tr_'.$likelihood_ID.'">
			                                    <td>'.$likelihood_element.'</td>
			                                    <td>'.$likelihood_question;

			                                    	if (!empty($ref_content)) {
			                                    		echo '<br><br><b>References:</b><br>'.nl2br($ref_content);
			                                    	}
			                                    	
			                                    echo '</td>
			                                    <td>
			                                        <div class="mt-radio-list">
			                                            <label class="mt-radio mt-radio-outline"> Yes
			                                                <input type="radio" value="1" name="likelihood_answer_'.$likelihood_ID.'" onclick="questionaireAnswer(1, 1, '.$likelihood_ID.', 1, this)" required />
			                                                <span></span>
			                                            </label>
			                                            <label class="mt-radio mt-radio-outline"> No
			                                                <input type="radio" value="0" name="likelihood_answer_'.$likelihood_ID.'" onclick="questionaireAnswer(1, 1, '.$likelihood_ID.', 0, this)" required />
			                                                <span></span>
			                                            </label>
			                                        </div>
			                                        <input type="hidden" class="likelihood_answer" name="likelihood_answer[]" value="" />
			                                    </td>
			                                    <td>
			                                    	<textarea class="form-control" name="likelihood_comment[]" placeholder="Enter comment here"></textarea>
			                                    	<input type="file" class="form-control margin-top-15 hide" name="likelihood_file[]" />
			                                    	<p style="margin: 0;"><button type="button" class="btn btn-link uploadNew" onclick="uploadNew(this)">Upload File</button></p>
			                                    </td>
			                                    <td class="radioRate">
			                                        <div class="mt-radio-list">';

			                                        	if (!empty($likelihood_very_unlikely)) {
			                                        		echo '<label class="mt-radio mt-radio-outline"> <b>1 - Very Unlikely</b><br><i>'.$likelihood_very_unlikely.'</i>
				                                                <input type="radio" value="1" name="likelihood_rate_'.$likelihood_ID.'" onclick="questionaireRate(1, 1, '.$likelihood_ID.', 1)" required />
				                                                <span></span>
				                                            </label>';
			                                        	}
			                                        	if (!empty($likelihood_unlikely)) {
			                                        		echo '<label class="mt-radio mt-radio-outline"> <b>2 - Unlikely</b><br><i>'.$likelihood_unlikely.'</i>
				                                                <input type="radio" value="2" name="likelihood_rate_'.$likelihood_ID.'" onclick="questionaireRate(1, 1, '.$likelihood_ID.', 2)" required />
				                                                <span></span>
				                                            </label>';
			                                        	}
			                                        	if (!empty($likelihood_fairly_likely)) {
			                                        		echo '<label class="mt-radio mt-radio-outline"> <b>3 - Fairly Likely</b><br><i>'.$likelihood_fairly_likely.'</i>
				                                                <input type="radio" value="3" name="likelihood_rate_'.$likelihood_ID.'" onclick="questionaireRate(1, 1, '.$likelihood_ID.', 3)" required />
				                                                <span></span>
				                                            </label>';
			                                        	}
			                                        	if (!empty($likelihood_likely)) {
			                                        		echo '<label class="mt-radio mt-radio-outline"> <b>4 - Likely</b><br><i>'.$likelihood_likely.'</i>
				                                                <input type="radio" value="4" name="likelihood_rate_'.$likelihood_ID.'" onclick="questionaireRate(1, 1, '.$likelihood_ID.', 4)" required />
				                                                <span></span>
				                                            </label>';
			                                        	}
			                                        	if (!empty($likelihood_very_likely)) {
			                                        		echo '<label class="mt-radio mt-radio-outline"> <b>5 - Very Likely or Certain</b><br><i>'.$likelihood_very_likely.'</i>
				                                                <input type="radio" value="5" name="likelihood_rate_'.$likelihood_ID.'" onclick="questionaireRate(1, 1, '.$likelihood_ID.', 5)" required />
				                                                <span></span>
				                                            </label>';
			                                        	}
			                                            
			                                        echo '</div>
			                                        <input type="hidden" class="likelihood_rate" name="likelihood_rate[]" value="" />
			                                    </td>
			                                    <td class="text-center hide"><a href="javascript:;" class="btn btn-danger btn-circle" onclick="btnRemove(1, 1, '.$likelihood_ID.')">Remove</a></td>
			                                </tr>';
                                    	}
                                    }
                                }
                                
                            echo '</tbody>
                            <tfoot>
                            	<tr>
                                    <td><textarea class="form-control likelihood_element" placeholder="Enter element here"></textarea></td>
                                    <td><textarea class="form-control likelihood_question" placeholder="Enter question here"></textarea></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td class="text-center"><a href="javascript:;" class="btn btn-success btn-circle" onclick="btnNew_Questionaire(1, 1)">Add</a></td>
                                </tr>
                                <tr>
                                    <td>Likelihood</td>
                                    <td colspan="2">Likelihood of this material being affected by food fraud.</td>
                                    <td><textarea class="form-control" name="likelihood_comment_summary" placeholder="Enter comment here"></textarea></td>
                                    <td colspan="2"><span class="likelihood_result">Undefine</span></td>
                                </tr>
                                <tr>
                                    <td>Additional Notes:</td>
                                    <td colspan="5"><textarea class="form-control" name="likelihood_note" placeholder="Enter comment here"></textarea></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <hr>

                    <h4><strong>Consequence Questionnaire</strong></h4>
                    <h5>Assessment of the Consequences of Food Fraud</h5>

                    <div class="table-scrollable">
                        <table class="table table-bordered">
                            <tr class="bg-default">
                                <th class="text-center" colspan="5">Legend</th>
                            </tr>
                            <tr>
                                <td style="width: 20%; background: #80d3a8;">1 - Negligible</td>
                                <td style="width: 20%; background: #c7e39f;">2 - Minor</td>
                                <td style="width: 20%; background: #fff980;">3 - Moderate</td>
                                <td style="width: 20%; background: #fcc98e;">4 - Significant</td>
                                <td style="width: 20%; background: #f68d92;">5 - Severe</td>
                            </tr>
                        </table>
                    </div>

                    <div class="table-scrollable">
                        <table class="table table-bordered tableQuestionaire_2">
                            <thead>
                                <tr class="bg-default">
                                    <th class="text-center">Element</th>
                                    <th class="text-center">Question</th>
                                    <th class="text-center">Answer</th>
                                    <th class="text-center" style="width: 300px;">Comment</th>
                                    <th class="text-center" style="width: 210px;">Determination</th>
                                    <th class="text-center" style="width: 110px;">Action</th>
                                </tr>
                            </thead>
                            <tbody>';

                            	$selectConsequence = mysqli_query( $conn,"SELECT * FROM tbl_ffva_consequence" );
                                if ( mysqli_num_rows($selectConsequence) > 0 ) {
                                    while($rowConsequence = mysqli_fetch_array($selectConsequence)) {
                                    	$consequence_ID = $rowConsequence["ID"];
                                    	$consequence_element = $rowConsequence["element"];
                                    	$consequence_question = $rowConsequence["question"];
                                    	$consequence_negligible = $rowConsequence["negligible"];
                                    	$consequence_minor = $rowConsequence["minor"];
                                    	$consequence_moderate = $rowConsequence["moderate"];
                                    	$consequence_significant = $rowConsequence["significant"];
                                    	$consequence_severe = $rowConsequence["severe"];

										$ref_content = '';
										$resultRef = mysqli_query( $conn,"SELECT * FROM tbl_ffva_reference WHERE type = 2 AND element = $consequence_ID" );
								        if ( mysqli_num_rows($resultRef) > 0 ) {
								        	$rowRef = mysqli_fetch_array($resultRef);
								        	$ref_content = $rowRef["content"];
								        }

                                        echo '<tr class="tr_'.$consequence_ID.'">
		                                    <td>'.$consequence_element.'</td>
		                                    <td>'.$consequence_question;

		                                    	if (!empty($ref_content)) {
		                                    		echo '<br><br><b>References:</b><br>'. $ref_content;
		                                    	}

		                                    echo '</td>
		                                    <td>
		                                        <div class="mt-radio-list">
		                                            <label class="mt-radio mt-radio-outline"> Yes
		                                                <input type="radio" value="1" name="consequence_answer_'.$consequence_ID.'" onclick="questionaireAnswer(1, 2, '.$consequence_ID.', 1, this)" required />
		                                                <span></span>
		                                            </label>
		                                            <label class="mt-radio mt-radio-outline"> No
		                                                <input type="radio" value="0" name="consequence_answer_'.$consequence_ID.'" onclick="questionaireAnswer(1, 2, '.$consequence_ID.', 0, this)" required />
		                                                <span></span>
		                                            </label>
		                                        </div>
		                                        <input type="hidden" class="consequence_answer" name="consequence_answer[]" value="" />
		                                    </td>
		                                    <td>
		                                    	<textarea class="form-control" name="consequence_comment[]" placeholder="Enter comment here"></textarea>
		                                    	<input type="file" class="form-control margin-top-15 hide" name="consequence_file[]" />
		                                    	<p style="margin: 0;"><button type="button" class="btn btn-link uploadNew" onclick="uploadNew(this)">Upload File</button></p>
		                                    </td>
		                                    <td class="radioRate">
		                                        <div class="mt-radio-list">
		                                            <label class="mt-radio mt-radio-outline"> <b>1 - Negligible</b><br><i>'.$consequence_negligible.'</i>
		                                                <input type="radio" value="1" name="consequence_rate_'.$consequence_ID.'" onclick="questionaireRate(1, 2, '.$consequence_ID.', 1)" required />
		                                                <span></span>
		                                            </label>
		                                            <label class="mt-radio mt-radio-outline"> <b>2 - Minor</b><br><i>'.$consequence_minor.'</i>
		                                                <input type="radio" value="2" name="consequence_rate_'.$consequence_ID.'" onclick="questionaireRate(1, 2, '.$consequence_ID.', 2)" required />
		                                                <span></span>
		                                            </label>
		                                            <label class="mt-radio mt-radio-outline"> <b>3 - Moderate</b><br><i>'.$consequence_moderate.'</i>
		                                                <input type="radio" value="3" name="consequence_rate_'.$consequence_ID.'" onclick="questionaireRate(1, 2, '.$consequence_ID.', 3)" required />
		                                                <span></span>
		                                            </label>
		                                            <label class="mt-radio mt-radio-outline"> <b>4 - Significant</b><br><i>'.$consequence_significant.'</i>
		                                                <input type="radio" value="4" name="consequence_rate_'.$consequence_ID.'" onclick="questionaireRate(1, 2, '.$consequence_ID.', 4)" required />
		                                                <span></span>
		                                            </label>
		                                            <label class="mt-radio mt-radio-outline"> <b>5 - Severe</b><br><i>'.$consequence_severe.'</i>
		                                                <input type="radio" value="5" name="consequence_rate_'.$consequence_ID.'" onclick="questionaireRate(1, 2, '.$consequence_ID.', 5)" required />
		                                                <span></span>
		                                            </label>
		                                        </div>
		                                        <input type="hidden" class="consequence_rate" name="consequence_rate[]" value="" />
		                                    </td>
		                                    <td class="text-center hide"><a href="javascript:;" class="btn btn-danger btn-circle" onclick="btnRemove(1, 2, '.$consequence_ID.')">Remove</a></td>
		                                </tr>';
                                    }
                                }

                            echo '</tbody>
                            <tfoot>
                            	<tr>
                                    <td><textarea class="form-control consequence_element" placeholder="Enter element here"></textarea></td>
                                    <td><textarea class="form-control consequence_question" placeholder="Enter question here"></textarea></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td class="text-center"><a href="javascript:;" class="btn btn-success btn-circle" onclick="btnNew_Questionaire_Consequence(1, 2)">Add</a></td>
                                </tr>
                                <tr>
                                    <td>Consequence</td>
                                    <td colspan="2">Consequences of food fraud on this material.</td>
                                    <td><textarea class="form-control" name="consequence_comment_summary" placeholder="Enter comment here"></textarea></td>
                                    <td colspan="2"><span class="consequence_result">Undefine</span></td>
                                </tr>
                                <tr>
                                    <td>Additional Notes:</td>
                                    <td colspan="5"><textarea class="form-control" name="consequence_note" placeholder="Enter comment here"></textarea></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <hr>

                    <h4><strong>Risk Matrix</strong></h4>

                    <div class="row" style="display: flex; align-items: center;">
                        <div class="col-md-5" style="display: flex; justify-content: center;">
                            <table id="tableMatrix">
                                <tr>
                                    <td></td>
                                    <td class="text-center" style="font-weight: bold; vertical-align: bottom;">Very<br>Unlikely</td>
                                    <td class="text-center" style="font-weight: bold; vertical-align: bottom;">Unlikely</td>
                                    <td class="text-center" style="font-weight: bold; vertical-align: bottom;">Fairly<br>Likely</td>
                                    <td class="text-center" style="font-weight: bold; vertical-align: bottom;">Likely</td>
                                    <td class="text-center" style="font-weight: bold; vertical-align: bottom;">Very<br>Likely/<br>Certain</td>
                                </tr>
                                <tr>
                                    <td class="text-right" style="font-weight: bold; padding: 5px;">Negligible</td>
                                    <td class="text-center matrix-1-1" style="background: #28a745; border: 1px solid; width: 70px; height: 70px;"><i class="fa fa-circle hidden"></i></td>
                                    <td class="text-center matrix-1-2" style="background: #28a745; border: 1px solid; width: 70px; height: 70px;"><i class="fa fa-circle hidden"></i></td>
                                    <td class="text-center matrix-1-3" style="background: #ffc107; border: 1px solid; width: 70px; height: 70px;"><i class="fa fa-circle hidden"></i></td>
                                    <td class="text-center matrix-1-4" style="background: #ffc107; border: 1px solid; width: 70px; height: 70px;"><i class="fa fa-circle hidden"></i></td>
                                    <td class="text-center matrix-1-5" style="background: #dc3545; border: 1px solid; width: 70px; height: 70px;"><i class="fa fa-circle hidden"></i></td>
                                </tr>
                                <tr>
                                    <td class="text-right" style="font-weight: bold; padding: 5px;">Minor</td>
                                    <td class="text-center matrix-2-1" style="background: #28a745; border: 1px solid; width: 70px; height: 70px;"><i class="fa fa-circle hidden"></i></td>
                                    <td class="text-center matrix-2-2" style="background: #28a745; border: 1px solid; width: 70px; height: 70px;"><i class="fa fa-circle hidden"></i></td>
                                    <td class="text-center matrix-2-3" style="background: #ffc107; border: 1px solid; width: 70px; height: 70px;"><i class="fa fa-circle hidden"></i></td>
                                    <td class="text-center matrix-2-4" style="background: #ffc107; border: 1px solid; width: 70px; height: 70px;"><i class="fa fa-circle hidden"></i></td>
                                    <td class="text-center matrix-2-5" style="background: #dc3545; border: 1px solid; width: 70px; height: 70px;"><i class="fa fa-circle hidden"></i></td>
                                </tr>
                                <tr>
                                    <td class="text-right" style="font-weight: bold; padding: 5px;">Moderate</td>
                                    <td class="text-center matrix-3-1" style="background: #28a745; border: 1px solid; width: 70px; height: 70px;"><i class="fa fa-circle hidden"></i></td>
                                    <td class="text-center matrix-3-2" style="background: #ffc107; border: 1px solid; width: 70px; height: 70px;"><i class="fa fa-circle hidden"></i></td>
                                    <td class="text-center matrix-3-3" style="background: #ffc107; border: 1px solid; width: 70px; height: 70px;"><i class="fa fa-circle hidden"></i></td>
                                    <td class="text-center matrix-3-4" style="background: #dc3545; border: 1px solid; width: 70px; height: 70px;"><i class="fa fa-circle hidden"></i></td>
                                    <td class="text-center matrix-3-5" style="background: #dc3545; border: 1px solid; width: 70px; height: 70px;"><i class="fa fa-circle hidden"></i></td>
                                </tr>
                                <tr>
                                    <td class="text-right" style="font-weight: bold; padding: 5px;">Significant</td>
                                    <td class="text-center matrix-4-1" style="background: #ffc107; border: 1px solid; width: 70px; height: 70px;"><i class="fa fa-circle hidden"></i></td>
                                    <td class="text-center matrix-4-2" style="background: #ffc107; border: 1px solid; width: 70px; height: 70px;"><i class="fa fa-circle hidden"></i></td>
                                    <td class="text-center matrix-4-3" style="background: #dc3545; border: 1px solid; width: 70px; height: 70px;"><i class="fa fa-circle hidden"></i></td>
                                    <td class="text-center matrix-4-4" style="background: #dc3545; border: 1px solid; width: 70px; height: 70px;"><i class="fa fa-circle hidden"></i></td>
                                    <td class="text-center matrix-4-5" style="background: #dc3545; border: 1px solid; width: 70px; height: 70px;"><i class="fa fa-circle hidden"></i></td>
                                </tr>
                                <tr>
                                    <td class="text-right" style="font-weight: bold; padding: 5px;">Severe</td>
                                    <td class="text-center matrix-5-1" style="background: #ffc107; border: 1px solid; width: 70px; height: 70px;"><i class="fa fa-circle hidden"></i></td>
                                    <td class="text-center matrix-5-2" style="background: #dc3545; border: 1px solid; width: 70px; height: 70px;"><i class="fa fa-circle hidden"></i></td>
                                    <td class="text-center matrix-5-3" style="background: #dc3545; border: 1px solid; width: 70px; height: 70px;"><i class="fa fa-circle hidden"></i></td>
                                    <td class="text-center matrix-5-4" style="background: #dc3545; border: 1px solid; width: 70px; height: 70px;"><i class="fa fa-circle hidden"></i></td>
                                    <td class="text-center matrix-5-5" style="background: #dc3545; border: 1px solid; width: 70px; height: 70px;"><i class="fa fa-circle hidden"></i></td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-7">
                            <table id="tableMatrixData">
                                <tr>
                                    <td style="padding: 10px;" class="text-right"><strong>Likelihood</strong></td>
                                    <td style="padding: 10px;"><span class="likelihood_result">Undefine</span></td>
                                </tr>
                                <tr>
                                    <td style="padding: 10px;" class="text-right"><strong>Consequence</strong></td>
                                    <td style="padding: 10px;"><span class="consequence_result">Undefine</span></td>
                                </tr>
                                <tr>
                                    <td style="padding: 10px;" class="text-right"><strong>Vulnerability Risk Estimate</strong></td>
                                    <td style="padding: 10px;"><span class="vulnerability_result">Undefine</span></td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="tab-pane" id="tabActivities">
                    <h4><strong>Prevention and Deterrence</strong></h4>
                    <div class="mt-checkbox-list" id="list_activity_1">';

                    	$selectPrevention = mysqli_query( $conn,"SELECT * FROM tbl_ffva_prevention" );
                        if ( mysqli_num_rows($selectPrevention) > 0 ) {
                            while($rowPrevention = mysqli_fetch_array($selectPrevention)) {
                            	$prevention_ID = $rowPrevention["ID"];
                            	$prevention_name = $rowPrevention["name"];

                            	echo '<label class="mt-checkbox mt-checkbox-outline"> '.$prevention_name.'
		                            <input type="checkbox" value="'.$prevention_ID.'" name="prevention[]" />
		                            <span></span>
		                        </label>';
                            }
                        }

                    echo '</div>
                    <div class="form-group">
                        <label class="control-label">Other</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="txtActivity_1" placeholder="Specify">
                            <span class="input-group-btn">
                                <button class="btn btn-success" type="button" onclick="btnNew_Activity(1)">Add</button>
                            </span>
                        </div>
                    </div>

                    <hr>

                    <h4><strong>Detection</strong></h4>
                    <div class="mt-checkbox-list" id="list_activity_2">';

                    	$selectDetection = mysqli_query( $conn,"SELECT * FROM tbl_ffva_detection" );
                        if ( mysqli_num_rows($selectDetection) > 0 ) {
                            while($rowDetection = mysqli_fetch_array($selectDetection)) {
                            	$detection_ID = $rowDetection["ID"];
                            	$detection_name = $rowDetection["name"];

                            	echo '<label class="mt-checkbox mt-checkbox-outline"> '.$detection_name.'
		                            <input type="checkbox" value="'.$detection_ID.'" name="detection[]" />
		                            <span></span>
		                        </label>';
                            }
                        }
                        
                    echo '</div>
                    <div class="form-group">
                        <label class="control-label">Other</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="txtActivity_2" placeholder="Specify">
                            <span class="input-group-btn">
                                <button class="btn btn-success" type="button" onclick="btnNew_Activity(2)">Add</button>
                            </span>
                        </div>
                    </div>

                    <hr>
                    
                    <h4><strong>Mitigation</strong></h4>
                    <div class="mt-checkbox-list" id="list_activity_3">';

                    	$selectMitigation = mysqli_query( $conn,"SELECT * FROM tbl_ffva_mitigation" );
                        if ( mysqli_num_rows($selectMitigation) > 0 ) {
                            while($rowMitigation = mysqli_fetch_array($selectMitigation)) {
                            	$mitigation_ID = $rowMitigation["ID"];
                            	$mitigation_name = $rowMitigation["name"];

                            	echo '<label class="mt-checkbox mt-checkbox-outline"> '.$mitigation_name.'
		                            <input type="checkbox" value="'.$mitigation_ID.'" name="mitigation[]" />
		                            <span></span>
		                        </label>';
                            }
                        }
                        
                    echo '</div>
                    <div class="form-group">
                        <label class="control-label">Other</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="txtActivity_3" placeholder="Specify">
                            <span class="input-group-btn">
                                <button class="btn btn-success" type="button" onclick="btnNew_Activity(3)">Add</button>
                            </span>
                        </div>
                    </div>
                </div>
                <div class="tab-pane" id="tabAssigned">
                    <table class="table table-bordered text-center">
                        <tr>
                            <td rowspan="2" style="width: 200px;"><strong>Prepared By</strong></td>
                            <td>
				        		<div class="signatureContainer">
				        			<div class="form-group">
							            <label class="col-md-3 control-label">Signature</label>
							            <div class="col-md-5">
							            	<select class="form-control margin-bottom-15" onchange="selectType(this)" name="prepared_type">
							            		<option value="">Select</option>
							            		<option value="1">Sign</option>
							            		<option value="2">Upload</option>
							            	</select>
							            </div>
							        </div>
					                <input type="hidden" name="prepared_signature_default_temp" value="'.$arnel_signature.'" />
					                <img class="img img-fluid sign signature_default" src="'.$arnel_signature.'" />
					                <input type="file" class="form-control hide sign signature_upload" name="prepared_file" />
					                <div class="hide sign signature_sign">
					                	<input type="button" class="btn btn-danger btnClear" onclick="btnClear(this)" value="Clear" />
					                	<div class="signature prepared_signature"></div>
					                </div>
				                </div>
				                <input type="hidden" name="prepared_by" value="35" />
                            	'.$current_userFName.' '.$current_userLName.'
                            </td>
                            <td>Date:</td>
                            <td><input type="date" class="form-control text-center" name="prepared_date" value="'.date('Y-m-d').'" required /></td>
                        </tr>
                        <tr>
                            <td><input type="hidden" name="prepared_position" value="PCQI" required />PCQI</td>
                            <td colspan="2">Consulate Inc. Group</td>
                        </tr>
                    </table><br><br>

                    <table class="table table-bordered text-center">
                        <tr>
                            <td rowspan="2" style="width: 200px;"><strong>Reviewed By</strong></td>
                            <td>
				        		<div class="signatureContainer">
				        			<div class="form-group">
							            <label class="col-md-3 control-label">Signature</label>
							            <div class="col-md-5">
							            	<select class="form-control margin-bottom-15" onchange="selectType(this)" name="reviewed_type">
							            		<option value="">Select</option>
							            		<option value="1">Sign</option>
							            		<option value="2">Upload</option>
							            	</select>
							            </div>
							        </div>
					                <input type="hidden" name="reviewed_signature_default_temp" value="'.$empty_signature.'" />
					                <img class="img img-fluid sign signature_default" src="'.$empty_signature.'" />
					                <input type="file" class="form-control margin-bottom-15 hide sign signature_upload" name="reviewed_file" />
					                <div class="hide sign signature_sign">
					                	<input type="button" class="btn btn-danger btnClear" onclick="btnClear(this)" value="Clear" />
					                	<div class="signature reviewed_signature"></div>
					                </div>
				                </div>
                            	<select class="form-control mt-multiselect" name="reviewed_by">
                            		<option value="">Select Reviewer</option>';

									$selectEmployee = mysqli_query( $conn,"SELECT * from tbl_hr_employee WHERE user_id = $user_id AND suspended = 0 AND status = 1" );
									if ( mysqli_num_rows($selectEmployee) > 0 ) {
										while($rowEmployee = mysqli_fetch_array($selectEmployee)) {
									        $employee_id = $rowEmployee['ID'];

									        $selectUserEnterprise = mysqli_query( $conn,"SELECT * from tbl_user WHERE employee_id = $employee_id AND is_verified = 1 AND is_active = 1" );
									        if ( mysqli_num_rows($selectUserEnterprise) > 0 ) {
									        	$rowUserEnt = mysqli_fetch_array($selectUserEnterprise);
									            $currentEnt_userID = $rowUserEnt['ID'];
									            $currentEnt_userFName = $rowUserEnt['first_name'];
									            $currentEnt_userLName = $rowUserEnt['last_name'];

									        	echo '<option value="'.$currentEnt_userID.'">'.$currentEnt_userFName.' '.$currentEnt_userLName.'</option>';
									        }
									    }
									}
                            	echo '</select>
                            </td>
                            <td>Date:</td>
                            <td><input type="date" class="form-control text-center" name="reviewed_date" value="" /></td>
                        </tr>
                        <tr>
                            <td><input type="text" class="form-control text-center" name="reviewed_position" placeholder="Position Title" /></td>
                            <td colspan="2">'.$enterp_name.'</td>
                        </tr>
                    </table><br><br>

                    <table class="table table-bordered text-center">
                        <tr>
                            <td rowspan="2" style="width: 200px;"><strong>Approved By</strong></td>
                            <td>
				        		<div class="signatureContainer">
				        			<div class="form-group">
							            <label class="col-md-3 control-label">Signature</label>
							            <div class="col-md-5">
							            	<select class="form-control margin-bottom-15" onchange="selectType(this)" name="approved_type">
							            		<option value="">Select</option>
							            		<option value="1">Sign</option>
							            		<option value="2">Upload</option>
							            	</select>
							            </div>
							        </div>
					                <input type="hidden" name="approved_signature_default_temp" value="'.$empty_signature.'" />
					                <img class="img img-fluid sign signature_default" src="'.$empty_signature.'" />
					                <input type="file" class="form-control margin-bottom-15 hide sign signature_upload" name="approved_file" />
					                <div class="hide sign signature_sign">
					                	<input type="button" class="btn btn-danger btnClear" onclick="btnClear(this)" value="Clear" />
					                	<div class="signature approved_signature"></div>
					                </div>
				                </div>
                            	<select class="form-control mt-multiselect" name="approved_by">
                            		<option value="">Select Approver</option>';

                                	$selectEmployee = mysqli_query( $conn,"SELECT * from tbl_hr_employee WHERE user_id = $user_id AND suspended = 0 AND status = 1" );
									if ( mysqli_num_rows($selectEmployee) > 0 ) {
										while($rowEmployee = mysqli_fetch_array($selectEmployee)) {
									        $employee_id = $rowEmployee['ID'];

									        $selectUserEnterprise = mysqli_query( $conn,"SELECT * from tbl_user WHERE employee_id = $employee_id AND is_verified = 1 AND is_active = 1" );
									        if ( mysqli_num_rows($selectUserEnterprise) > 0 ) {
									        	$rowUserEnt = mysqli_fetch_array($selectUserEnterprise);
									            $currentEnt_userID = $rowUserEnt['ID'];
									            $currentEnt_userFName = $rowUserEnt['first_name'];
									            $currentEnt_userLName = $rowUserEnt['last_name'];

									        	echo '<option value="'.$currentEnt_userID.'">'.$currentEnt_userFName.' '.$currentEnt_userLName.'</option>';
									        }
									    }
									}
                            	echo '</select>
                            </td>
                            <td>Date:</td>
                            <td><input type="date" class="form-control text-center" name="approved_date" value="" /></td>
                        </tr>
                        <tr>
                            <td><input type="text" class="form-control text-center" name="approved_position" placeholder="Position Title" /></td>
                            <td colspan="2">'.$enterp_name.'</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>';
	}
	if( isset($_GET['modalEdit_FFVA']) ) {
		$id = $_GET['modalEdit_FFVA'];

		if (!empty($_COOKIE['switchAccount'])) {
			$portal_user = $_COOKIE['ID'];
			$user_id = $_COOKIE['switchAccount'];
		}
		else {
			$portal_user = $_COOKIE['ID'];
			$user_id = employerID($portal_user);
		}

		// Override arnel signature into SPI if match
		if ($user_id == 250) {
			$arnel_signature = $arnel_signature_spi;
		}

		$result = mysqli_query( $conn,"SELECT * FROM tbl_ffva WHERE ID = $id" );
        if ( mysqli_num_rows($result) > 0 ) {
            while($row = mysqli_fetch_array($result)) {
            	$likelihood_answer = $row["likelihood_answer"];
            	$likelihood_answer_arr = explode(', ', $likelihood_answer);

            	$likelihood_comment = $row["likelihood_comment"];
            	$likelihood_comment_arr = explode(' | ', $likelihood_comment);

            	$likelihood_rate = $row["likelihood_rate"];
            	$likelihood_rate_arr = explode(', ', $likelihood_rate);

            	$likelihood_file = $row["likelihood_file"];
            	$likelihood_file_arr = explode(' | ', $likelihood_file);

            	$consequence_answer = $row["consequence_answer"];
            	$consequence_answer_arr = explode(', ', $consequence_answer);

            	$consequence_comment = $row["consequence_comment"];
            	$consequence_comment_arr = explode(' | ', $consequence_comment);

            	$consequence_file = $row["consequence_file"];
            	$consequence_file_arr = explode(' | ', $consequence_file);

            	$consequence_rate = $row["consequence_rate"];
            	$consequence_rate_arr = explode(', ', $consequence_rate);

            	$prepared_signature = $row["prepared_signature"];
            	$prepared_position = $row["prepared_position"];
            	$prepared_date = $row["prepared_date"];

            	if(!empty($row["prepared_by"])) { $prepared_by = $row["prepared_by"]; }
            	else { $prepared_by = 35; }
				$selectUser = mysqli_query( $conn,"SELECT * from tbl_user WHERE ID = $prepared_by" );
		        if ( mysqli_num_rows($selectUser) > 0 ) {
		            $rowUser = mysqli_fetch_array($selectUser);
		            $current_userFName = $rowUser['first_name'];
		            $current_userLName = $rowUser['last_name'];
		        }

		        $enterp_name = "";
		        $selectEnterprise = mysqli_query( $conn,"SELECT * from tblEnterpiseDetails WHERE users_entities = $prepared_by" );
		        if ( mysqli_num_rows($selectEnterprise) > 0 ) {
		            $rowEnterprise = mysqli_fetch_array($selectEnterprise);
		            $enterp_name = $rowEnterprise['businessname'];
		        }


            	$reviewed_by = $row["reviewed_by"];
            	$reviewed_signature = $row["reviewed_signature"];
            	$reviewed_position = $row["reviewed_position"];
            	$reviewed_date = $row["reviewed_date"];
            	$reviewed_by_employer = '';
			    $reviewed_enterp_name = "";
            	if (!empty($reviewed_by)) {
	            	$reviewed_by_employer = employerID($reviewed_by);
			        $selectEnterprise = mysqli_query( $conn,"SELECT * from tblEnterpiseDetails WHERE users_entities = $reviewed_by_employer" );
			        if ( mysqli_num_rows($selectEnterprise) > 0 ) {
			            $rowEnterprise = mysqli_fetch_array($selectEnterprise);
			            $reviewed_enterp_name = $rowEnterprise['businessname'];
			        }
            	}

            	$approved_by = $row["approved_by"];
            	$approved_signature = $row["approved_signature"];
            	$approved_position = $row["approved_position"];
            	$approved_date = $row["approved_date"];
            	$approved_by_employer = '';
		        $approved_enterp_name = "";
            	if (!empty($approved_by)) {
            		$approved_by_employer = employerID($approved_by);
			        $selectEnterprise = mysqli_query( $conn,"SELECT * from tblEnterpiseDetails WHERE users_entities = $approved_by_employer" );
			        if ( mysqli_num_rows($selectEnterprise) > 0 ) {
			            $rowEnterprise = mysqli_fetch_array($selectEnterprise);
			            $approved_enterp_name = $rowEnterprise['businessname'];
			        }
            	}

				echo '<input type="hidden" value="'.$row["type"].'" name="tab" />
				<input type="hidden" value="'.$row["ID"].'" name="ID" />
				<div class="tabbable tabbable-tabdrop" id="tabdrop_2">
		            <ul class="nav nav-tabs">
		                <li class="active">
		                    <a href="#tabProfile_2" data-toggle="tab">Profile</a>
		                </li>
		                <li>
		                    <a href="#tabQuestionaire_2" data-toggle="tab">Questionaire</a>
		                </li>
		                <li>
		                    <a href="#tabActivities_2" data-toggle="tab">Activities</a>
		                </li>
		                <li>
		                    <a href="#tabAssigned_2" data-toggle="tab">Assigned</a>
		                </li>
		            </ul>
		            <div class="tab-content margin-top-20">
		                <div class="tab-pane active" id="tabProfile_2">
		                    <div class="row '; echo $row["type"] == 2 ? 'hide':''; echo '">
		                        <div class="col-md-4">
		                            <div class="form-group">
		                                <label class="control-label">Company Name</label>
		                                <input class="form-control" type="text" name="company" value="'.$row["company"].'" '; echo $row["type"] == 1 ? 'required':''; echo ' />
		                            </div>
		                        </div>
		                        <div class="col-md-4">
		                            <div class="form-group">
		                                <label class="control-label">Website</label>
		                                <input class="form-control" type="text" name="website" value="'.$row["website"].'" '; echo $row["type"] == 1 ? 'required':''; echo ' />
		                            </div>
		                        </div>
		                        <div class="col-md-4">
		                            <div class="form-group">
		                                <label class="control-label">Headquarters</label>
		                                <input class="form-control" type="text" name="headquarters" value="'.$row["headquarters"].'" '; echo $row["type"] == 1 ? 'required':''; echo ' />
		                            </div>
		                        </div>
		                    </div>
		                    <div class="row '; echo $row["type"] == 2 ? 'hide':''; echo '">
		                        <div class="col-md-4">
		                            <div class="form-group">
		                                <label class="control-label">Telephone Number</label>
		                                <input class="form-control" type="text" name="telephone" value="'.$row["telephone"].'" '; echo $row["type"] == 1 ? 'required':''; echo ' />
		                            </div>
		                        </div>
		                        <div class="col-md-4">
		                            <div class="form-group">
		                                <label class="control-label">Email</label>
		                                <input class="form-control" type="email" name="email" value="'.$row["email"].'" '; echo $row["type"] == 1 ? 'required':''; echo ' />
		                            </div>
		                        </div>
		                        <div class="col-md-4">
		                            <div class="form-group">
		                                <label class="control-label">Contact Person</label>
		                                <input class="form-control" type="text" name="person" value="'.$row["person"].'"  '; echo $row["type"] == 1 ? 'required':''; echo ' />
		                            </div>
		                        </div>
		                    </div>
		                    <div class="row">
		                        <div class="col-md-12">
		                            <div class="form-group">
		                                <label class="control-label">Product or ingredient or raw material</label>
		                                <textarea class="form-control" name="product" required >'.$row["product"].'</textarea>
		                            </div>
		                        </div>
		                        <div class="col-md-12">
		                            <div class="form-group">
		                                <label class="control-label">Materials names and/or codes included in this assessment</label>
		                                <textarea class="form-control" name="assessment" required >'.$row["assessment"].'</textarea>
		                            </div>
		                        </div>
		                    </div>
		                    <div class="row">
		                        <div class="col-md-4">
		                            <div class="form-group">
		                                <label class="control-label">Category</label>
		                                <select class="form-control" name="category">';

		                                    $selectCategory = mysqli_query( $conn,"SELECT * FROM tbl_ffva_category" );
		                                    if ( mysqli_num_rows($selectCategory) > 0 ) {
		                                        while($rowCategory = mysqli_fetch_array($selectCategory)) {
		                                            echo '<option value="'.$rowCategory["ID"].'"'; echo $row["category_id"] == $rowCategory["ID"] ? 'SELECTED':'';  echo '>'.$rowCategory["name"].'</option>';
		                                        }
		                                    }

		                                echo '</select>
		                                <input class="form-control margin-top-15" type="text" name="category_other" placeholder="Specify if other" value="'.$row["category_other"].'" />
		                            </div>
		                        </div>
		                        <div class="col-md-4">
		                            <div class="form-group">
		                                <label class="control-label">Industry</label>
		                                <select class="form-control" name="industry">';

		                                    $selectIndustry = mysqli_query( $conn,"SELECT * FROM tbl_ffva_industry" );
		                                    if ( mysqli_num_rows($selectIndustry) > 0 ) {
		                                        while($rowIndustry = mysqli_fetch_array($selectIndustry)) {
		                                            echo '<option value="'.$rowIndustry["ID"].'"'; echo $row["industry_id"] == $rowIndustry["ID"] ? 'SELECTED':'';  echo '>'.$rowIndustry["name"].'</option>';
		                                        }
		                                    }

		                                echo '</select>
		                                <input class="form-control margin-top-15" type="text" name="industry_other" placeholder="Specify if other" value="'.$row["industry_other"].'" />
		                            </div>
		                        </div>
		                        <div class="col-md-4">
		                            <div class="form-group">
		                                <label class="control-label">Document Number</label>
		                                <input class="form-control" type="text" name="code" value="'.$row["code"].'" required />
		                            </div>
		                            <div class="form-group">
		                                <label class="col-md-4 control-label mt-radio-inline">Receive Notification?</label>
		                                <div class="col-md-8">
		                                    <div class="mt-radio-inline">
		                                        <label class="mt-radio">
		                                            <input type="radio" name="notification" value="0" '; echo $row["notification"] == 0 ? 'checked':''; echo ' /> No
		                                            <span></span>
		                                        </label>
		                                        <label class="mt-radio">
		                                            <input type="radio" name="notification"  value="1" '; echo $row["notification"] == 1 ? 'checked':''; echo ' /> Yes
		                                            <span></span>
		                                        </label>
		                                    </div>
		                                </div>
		                            </div>
		                        </div>
		                    </div>
		                </div>
		                <div class="tab-pane" id="tabQuestionaire_2">
		                    <h4><strong>Likelihood Questionnaire</strong></h4>
		                    <h5>Assessment of Likelihood That Food Fraud Will Affect This Material</h5>

		                    <div class="table-scrollable">
		                        <table class="table table-bordered">
		                            <tr class="bg-default">
		                                <th class="text-center" colspan="5">Legend</th>
		                            </tr>
		                            <tr>
		                                <td style="width: 20%; background: #80d3a8;">1 - Very Unlikely</td>
		                                <td style="width: 20%; background: #c7e39f;">2 - Unlikely</td>
		                                <td style="width: 20%; background: #fff980;">3 - Fairly Likely</td>
		                                <td style="width: 20%; background: #fcc98e;">4 - Likely</td>
		                                <td style="width: 20%; background: #f68d92;">5 - Very Likely or Certain</td>
		                            </tr>
		                        </table>
		                    </div>

		                    <div class="table-scrollable">
		                        <table class="table table-bordered tableQuestionaire_1">
		                            <thead>
		                                <tr class="bg-default">
		                                    <th class="text-center">Element</th>
		                                    <th class="text-center">Question</th>
		                                    <th class="text-center">Answer</th>
		                                    <th class="text-center" style="width: 300px;">Comment</th>
		                                    <th class="text-center" style="width: 210px;">Determination</th>
		                                    <th class="text-center" style="width: 110px;">Action</th>
		                                </tr>
		                            </thead>
		                            <tbody>';

										$index = 0;
		                            	$selectLikelihood = mysqli_query( $conn,"SELECT * FROM tbl_ffva_likelihood" );
		                                if ( mysqli_num_rows($selectLikelihood) > 0 ) {
		                                    while($rowLikelihood = mysqli_fetch_array($selectLikelihood)) {
		                                    	$likelihood_type_arr = explode(', ', $rowLikelihood["type"]);
		                                    	if (in_array($row["type"], $likelihood_type_arr)) {
			                                    	$likelihood_ID = $rowLikelihood["ID"];
			                                    	$likelihood_element = $rowLikelihood["element"];
			                                    	$likelihood_question = $rowLikelihood["question"];
			                                    	$likelihood_very_unlikely = $rowLikelihood["very_unlikely"];
			                                    	$likelihood_unlikely = $rowLikelihood["unlikely"];
			                                    	$likelihood_fairly_likely = $rowLikelihood["fairly_likely"];
			                                    	$likelihood_likely = $rowLikelihood["likely"];
			                                    	$likelihood_very_likely = $rowLikelihood["very_likely"];

													$ref_content = '';
													$resultRef = mysqli_query( $conn,"SELECT * FROM tbl_ffva_reference WHERE type = 1 AND element = $likelihood_ID" );
											        if ( mysqli_num_rows($resultRef) > 0 ) {
											        	$rowRef = mysqli_fetch_array($resultRef);
											        	$ref_content = $rowRef["content"];
											        }

											        if (empty($likelihood_answer_arr[$index])) { $likelihood_answer_arr[$index] = 0; }
											        if (empty($likelihood_comment_arr[$index])) { $likelihood_comment_arr[$index] = ''; }
											        if (empty($likelihood_rate_arr[$index])) { $likelihood_rate_arr[$index] = 1; }

			                                        echo '<tr class="tr_'.$likelihood_ID.'">
					                                    <td>'.$likelihood_element.'</td>
					                                    <td>'.$likelihood_question;

					                                    	if (!empty($ref_content)) {
					                                    		echo '<br><br><b>References:</b><br>'. nl2br($ref_content);
					                                    	}
					                                    	
					                                    echo '</td>
					                                    <td>
					                                        <div class="mt-radio-list">
					                                            <label class="mt-radio mt-radio-outline"> Yes
					                                                <input type="radio" value="1" name="likelihood_answer_'.$likelihood_ID.'" onclick="questionaireAnswer(2, 1, '.$likelihood_ID.', 1, this)" required '; echo $likelihood_answer_arr[$index] == 1 ? 'checked':''; echo ' />
					                                                <span></span>
					                                            </label>
					                                            <label class="mt-radio mt-radio-outline"> No
					                                                <input type="radio" value="0" name="likelihood_answer_'.$likelihood_ID.'" onclick="questionaireAnswer(2, 1, '.$likelihood_ID.', 0, this)" required '; echo $likelihood_answer_arr[$index] == 0 ? 'checked':''; echo ' />
					                                                <span></span>
					                                            </label>
					                                        </div>
					                                        <input type="hidden" class="likelihood_answer" name="likelihood_answer[]" value="'.$likelihood_answer_arr[$index].'" />
					                                    </td>
					                                    <td>
					                                    	<textarea class="form-control" name="likelihood_comment[]" placeholder="Enter comment here">'.$likelihood_comment_arr[$index].'</textarea>';

					                                    	if (!empty($likelihood_file_arr[$index])) {
										                    	$fileExtension = fileExtension($likelihood_file_arr[$index]);
																$src = $fileExtension['src'];
																$embed = $fileExtension['embed'];
																$type = $fileExtension['type'];
																$file_extension = $fileExtension['file_extension'];
										                        $url = $base_url.'uploads/ffva/';

                                                                $files = $src.$url.rawurlencode($likelihood_file_arr[$index]).$embed;

										                        echo '<input type="hidden" name="likelihood_file_temporary[]" value="'.$likelihood_file_arr[$index].'" />
										                        <input type="file" class="form-control '; echo !empty($likelihood_file_arr[$index]) ? 'hide':''; echo '" name="likelihood_file[]" />
									                    		<p class="'; echo !empty($likelihood_file_arr[$index]) ? '':'hide'; echo '" style="margin: 0;"><a href="'.$files.'" data-src="'.$files.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a> | <button type="button" class="btn btn-link uploadNew" onclick="uploadNew(this)">Upload</button></p>';
										                    } else {
										                    	echo '<input type="hidden" name="likelihood_file_temporary[]" value="" />
										                    	<input type="file" class="form-control margin-top-15 hide" name="likelihood_file[]" />
					                                    		<p style="margin: 0;"><button type="button" class="btn btn-link uploadNew" onclick="uploadNew(this)">Upload File</button></p>';
										                    }
					                                    
					                                    echo '</td>
					                                    <td class="radioRate">
					                                        <div class="mt-radio-list">';

					                                        	if (!empty($likelihood_very_unlikely)) {
					                                        		echo '<label class="mt-radio mt-radio-outline"> <b>1 - Very Unlikely</b><br><i>'.$likelihood_very_unlikely.'</i>
						                                                <input type="radio" value="1" name="likelihood_rate_'.$likelihood_ID.'" onclick="questionaireRate(2, 1, '.$likelihood_ID.', 1)" required '; echo $likelihood_rate_arr[$index] == 1 ? 'checked':''; echo ' />
						                                                <span></span>
						                                            </label>';
					                                        	}
					                                        	if (!empty($likelihood_unlikely)) {
					                                        		echo '<label class="mt-radio mt-radio-outline"> <b>2 - Unlikely</b><br><i>'.$likelihood_unlikely.'</i>
						                                                <input type="radio" value="2" name="likelihood_rate_'.$likelihood_ID.'" onclick="questionaireRate(2, 1, '.$likelihood_ID.', 2)" required '; echo $likelihood_rate_arr[$index] == 2 ? 'checked':''; echo ' />
						                                                <span></span>
						                                            </label>';
					                                        	}
					                                        	if (!empty($likelihood_fairly_likely)) {
					                                        		echo '<label class="mt-radio mt-radio-outline"> <b>3 - Fairly Likely</b><br><i>'.$likelihood_fairly_likely.'</i>
						                                                <input type="radio" value="3" name="likelihood_rate_'.$likelihood_ID.'" onclick="questionaireRate(2, 1, '.$likelihood_ID.', 3)" required '; echo $likelihood_rate_arr[$index] == 3 ? 'checked':''; echo ' />
						                                                <span></span>
						                                            </label>';
					                                        	}
					                                        	if (!empty($likelihood_likely)) {
					                                        		echo '<label class="mt-radio mt-radio-outline"> <b>4 - Likely</b><br><i>'.$likelihood_likely.'</i>
						                                                <input type="radio" value="4" name="likelihood_rate_'.$likelihood_ID.'" onclick="questionaireRate(2, 1, '.$likelihood_ID.', 4)" required '; echo $likelihood_rate_arr[$index] == 4 ? 'checked':''; echo ' />
						                                                <span></span>
						                                            </label>';
					                                        	}
					                                        	if (!empty($likelihood_very_likely)) {
					                                        		echo '<label class="mt-radio mt-radio-outline"> <b>5 - Very Likely or Certain</b><br><i>'.$likelihood_very_likely.'</i>
						                                                <input type="radio" value="5" name="likelihood_rate_'.$likelihood_ID.'" onclick="questionaireRate(2, 1, '.$likelihood_ID.', 5)" required '; echo $likelihood_rate_arr[$index] == 5 ? 'checked':''; echo ' />
						                                                <span></span>
						                                            </label>';
					                                        	}
					                                            
					                                        echo '</div>
					                                        <input type="hidden" class="likelihood_rate" name="likelihood_rate[]" value="'.$likelihood_rate_arr[$index].'" />
					                                    </td>
					                                    <td class="text-center hide"><a href="javascript:;" class="btn btn-danger btn-circle" onclick="btnRemove(2, 1, '.$likelihood_ID.')">Remove</a></td>
					                                </tr>';

					                                $index++;
					                            }
		                                    }
		                                }

		                                if (!empty($row["likelihood_element_other"])) {
							            	$likelihood_element_other = explode(' | ', $row["likelihood_element_other"]);
							            	$likelihood_question_other = explode(' | ', $row["likelihood_question_other"]);
							            	$likelihood_answer_other = explode(', ', $row["likelihood_answer_other"]);
							            	$likelihood_comment_other = explode(' | ', $row["likelihood_comment_other"]);
							            	$likelihood_file_other = explode(' | ', $row["likelihood_file_other"]);
							            	$likelihood_rate_other = explode(', ', $row["likelihood_rate_other"]);

											$index = 0;
							            	foreach ($likelihood_element_other as $value) {

		                                        echo '<tr class="tr_other_'.$index.'">
				                                    <td><input type="hidden" name="likelihood_element_other[]" value="'.$value.'" />'.$value.'</td>
				                                    <td><input type="hidden" name="likelihood_question_other[]" value="'.$likelihood_question_other[$index].'" />'.$likelihood_question_other[$index].'</td>
				                                    <td>
				                                        <div class="mt-radio-list">
				                                            <label class="mt-radio mt-radio-outline"> Yes
				                                                <input type="radio" value="1" name="likelihood_answer_other_'.$index.'" onclick="questionaireAnswerOther(2, 1, '.$index.', 1, this)" required '; echo $likelihood_answer_other[$index] == 1 ? 'checked':''; echo ' />
				                                                <span></span>
				                                            </label>
				                                            <label class="mt-radio mt-radio-outline"> No
				                                                <input type="radio" value="0" name="likelihood_answer_other_'.$index.'" onclick="questionaireAnswerOther(2, 1, '.$index.', 0, this)" required '; echo $likelihood_answer_other[$index] == 0 ? 'checked':''; echo ' />
				                                                <span></span>
				                                            </label>
				                                        </div>
				                                        <input type="hidden" class="likelihood_answer" name="likelihood_answer_other[]" value="'.$likelihood_answer_other[$index].'" />
				                                    </td>
				                                    <td>
				                                    	<textarea class="form-control" name="likelihood_comment_other[]" placeholder="Enter comment here">'.$likelihood_comment_other[$index].'</textarea>';

				                                    	if (!empty($likelihood_file_other[$index])) {
									                    	$fileExtension = fileExtension($likelihood_file_other[$index]);
															$src = $fileExtension['src'];
															$embed = $fileExtension['embed'];
															$type = $fileExtension['type'];
															$file_extension = $fileExtension['file_extension'];
									                        $url = $base_url.'uploads/ffva/';

                                                            $files = $src.$url.rawurlencode($likelihood_file_other[$index]).$embed;

									                        echo '<input type="hidden" name="likelihood_file_temporary_other[]" value="'.$likelihood_file_other[$index].'" />
									                        <input type="file" class="form-control '; echo !empty($likelihood_file_other[$index]) ? 'hide':''; echo '" name="likelihood_file_other[]" />
								                    		<p class="'; echo !empty($likelihood_file_other[$index]) ? '':'hide'; echo '" style="margin: 0;"><a href="'.$files.'" data-src="'.$files.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a> | <button type="button" class="btn btn-link uploadNew" onclick="uploadNew(this)">Upload</button></p>';
									                    } else {
									                    	echo '<input type="hidden" name="likelihood_file_temporary_other[]" value="" />
									                    	<input type="file" class="form-control margin-top-15 hide" name="likelihood_file_other[]" />
				                                    		<p style="margin: 0;"><button type="button" class="btn btn-link uploadNew" onclick="uploadNew(this)">Upload File</button></p>';
									                    }

				                                    echo '</td>
				                                    <td class="radioRate">
				                                        <div class="mt-radio-list">
				                                            <label class="mt-radio mt-radio-outline"> <b>1 - Very Unlikely</b>
				                                                <input type="radio" value="1" name="likelihood_rate_other_'.$index.'" onclick="questionaireRateOther(2, 1, '.$index.', 1)" required '; echo $likelihood_rate_other[$index] == 1 ? 'checked':''; echo ' />
				                                                <span></span>
				                                            </label>
				                                            <label class="mt-radio mt-radio-outline"> <b>2 - Unlikely</b>
				                                                <input type="radio" value="2" name="likelihood_rate_other_'.$index.'" onclick="questionaireRateOther(2, 1, '.$index.', 2)" required '; echo $likelihood_rate_other[$index] == 2 ? 'checked':''; echo ' />
				                                                <span></span>
				                                            </label>
				                                            <label class="mt-radio mt-radio-outline"> <b>3 - Fairly Likely</b>
				                                                <input type="radio" value="3" name="likelihood_rate_other_'.$index.'" onclick="questionaireRateOther(2, 1, '.$index.', 3)" required '; echo $likelihood_rate_other[$index] == 3 ? 'checked':''; echo ' />
				                                                <span></span>
				                                            </label>
				                                            <label class="mt-radio mt-radio-outline"> <b>4 - Likely</b>
				                                                <input type="radio" value="4" name="likelihood_rate_other_'.$index.'" onclick="questionaireRateOther(2, 1, '.$index.', 4)" required '; echo $likelihood_rate_other[$index] == 4 ? 'checked':''; echo ' />
				                                                <span></span>
				                                            </label>
				                                            <label class="mt-radio mt-radio-outline"> <b>5 - Very Likely or Certain</b>
				                                                <input type="radio" value="5" name="likelihood_rate_other_'.$index.'" onclick="questionaireRateOther(2, 1, '.$index.', 5)" required '; echo $likelihood_rate_other[$index] == 5 ? 'checked':''; echo ' />
				                                                <span></span>
				                                            </label>
				                                        </div>
				                                        <input type="hidden" class="likelihood_rate" name="likelihood_rate_other[]" value="'.$likelihood_rate_other[$index].'" />
				                                    </td>
				                                    <td class="text-center"><a href="javascript:;" class="btn btn-danger btn-circle" onclick="btnRemoveOther(2, 1, '.$index.')">Remove</a></td>
				                                </tr>';

				                                $index++;
							            	}
		                                }
		                                
		                            echo '</tbody>
		                            <tfoot>
		                            	<tr">
		                                    <td><textarea class="form-control likelihood_element" placeholder="Enter element here"></textarea></td>
		                                    <td><textarea class="form-control likelihood_question" placeholder="Enter question here"></textarea></td>
		                                    <td></td>
		                                    <td></td>
		                                    <td></td>
		                                    <td class="text-center"><a href="javascript:;" class="btn btn-success btn-circle" onclick="btnNew_Questionaire(2, 1)">Add</a></td>
		                                </tr>
		                                <tr>
		                                    <td>Likelihood</td>
		                                    <td colspan="2">Likelihood of this material being affected by food fraud.</td>
		                                    <td><textarea class="form-control" name="likelihood_comment_summary" placeholder="Enter comment here">'.$row["likelihood_comment_summary"].'</textarea></td>
		                                    <td colspan="2"><span class="likelihood_result">Undefine</span></td>
		                                </tr>
		                                <tr>
		                                    <td>Additional Notes:</td>
		                                    <td colspan="5"><textarea class="form-control" name="likelihood_note" placeholder="Enter comment here">'.$row["likelihood_note"].'</textarea></td>
		                                </tr>
		                            </tfoot>
		                        </table>
		                    </div>

		                    <hr>

		                    <h4><strong>Consequence Questionnaire</strong></h4>
		                    <h5>Assessment of the Consequences of Food Fraud</h5>

		                    <div class="table-scrollable">
		                        <table class="table table-bordered">
		                            <tr class="bg-default">
		                                <th class="text-center" colspan="5">Legend</th>
		                            </tr>
		                            <tr>
		                                <td style="width: 20%; background: #80d3a8;">1 - Negligible</td>
		                                <td style="width: 20%; background: #c7e39f;">2 - Minor</td>
		                                <td style="width: 20%; background: #fff980;">3 - Moderate</td>
		                                <td style="width: 20%; background: #fcc98e;">4 - Significant</td>
		                                <td style="width: 20%; background: #f68d92;">5 - Severe</td>
		                            </tr>
		                        </table>
		                    </div>

		                    <div class="table-scrollable">
		                        <table class="table table-bordered tableQuestionaire_2">
		                            <thead>
		                                <tr class="bg-default">
		                                    <th class="text-center">Element</th>
		                                    <th class="text-center">Question</th>
		                                    <th class="text-center">Answer</th>
		                                    <th class="text-center" style="width: 300px;">Comment</th>
		                                    <th class="text-center" style="width: 210px;">Determination</th>
		                                    <th class="text-center" style="width: 110px;">Action</th>
		                                </tr>
		                            </thead>
		                            <tbody>';

		                            	$index = 0;
		                            	$selectConsequence = mysqli_query( $conn,"SELECT * FROM tbl_ffva_consequence" );
		                                if ( mysqli_num_rows($selectConsequence) > 0 ) {
		                                    while($rowConsequence = mysqli_fetch_array($selectConsequence)) {
		                                    	$consequence_ID = $rowConsequence["ID"];
		                                    	$consequence_element = $rowConsequence["element"];
		                                    	$consequence_question = $rowConsequence["question"];
		                                    	$consequence_negligible = $rowConsequence["negligible"];
		                                    	$consequence_minor = $rowConsequence["minor"];
		                                    	$consequence_moderate = $rowConsequence["moderate"];
		                                    	$consequence_significant = $rowConsequence["significant"];
		                                    	$consequence_severe = $rowConsequence["severe"];

												$ref_content = '';
												$resultRef = mysqli_query( $conn,"SELECT * FROM tbl_ffva_reference WHERE type = 2 AND element = $consequence_ID" );
										        if ( mysqli_num_rows($resultRef) > 0 ) {
										        	$rowRef = mysqli_fetch_array($resultRef);
										        	$ref_content = $rowRef["content"];
										        }

		                                        echo '<tr class="tr_'.$consequence_ID.'">
				                                    <td>'.$consequence_element.'</td>
				                                    <td>'.$consequence_question;

				                                    	if (!empty($ref_content)) {
				                                    		echo '<br><br><b>References:</b><br>'. $ref_content;
				                                    	}

				                                    echo '</td>
				                                    <td>
				                                        <div class="mt-radio-list">
				                                            <label class="mt-radio mt-radio-outline"> Yes
				                                                <input type="radio" value="1" name="consequence_answer_'.$consequence_ID.'" onclick="questionaireAnswer(2, 2, '.$consequence_ID.', 1, this)" required '; echo $consequence_answer_arr[$index] == 1 ? 'checked':''; echo ' />
				                                                <span></span>
				                                            </label>
				                                            <label class="mt-radio mt-radio-outline"> No
				                                                <input type="radio" value="0" name="consequence_answer_'.$consequence_ID.'" onclick="questionaireAnswer(2, 2, '.$consequence_ID.', 0, this)" required '; echo $consequence_answer_arr[$index] == 0 ? 'checked':''; echo ' />
				                                                <span></span>
				                                            </label>
				                                        </div>
		                                        		<input type="hidden" class="consequence_answer" name="consequence_answer[]" value="'.$consequence_answer_arr[$index].'" />
				                                    </td>
				                                    <td>
				                                    	<textarea class="form-control" name="consequence_comment[]" placeholder="Enter comment here">'.$consequence_comment_arr[$index].'</textarea>';

				                                    	if (!empty($consequence_file_arr[$index])) {
									                    	$fileExtension = fileExtension($consequence_file_arr[$index]);
															$src = $fileExtension['src'];
															$embed = $fileExtension['embed'];
															$type = $fileExtension['type'];
															$file_extension = $fileExtension['file_extension'];
									                        $url = $base_url.'uploads/ffva/';

                                                            $files = $src.$url.rawurlencode($consequence_file_arr[$index]).$embed;

									                        echo '<input type="hidden" name="consequence_file_temporary[]" value="'.$consequence_file_arr[$index].'" />
									                        <input type="file" class="form-control '; echo !empty($consequence_file_arr[$index]) ? 'hide':''; echo '" name="consequence_file[]" />
								                    		<p class="'; echo !empty($consequence_file_arr[$index]) ? '':'hide'; echo '" style="margin: 0;"><a href="'.$files.'" data-src="'.$files.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a> | <button type="button" class="btn btn-link uploadNew" onclick="uploadNew(this)">Upload</button></p>';
									                    } else {
									                    	echo '<input type="hidden" name="consequence_file_temporary[]" value="" />
									                    	<input type="file" class="form-control margin-top-15 hide" name="consequence_file[]" />
				                                    		<p style="margin: 0;"><button type="button" class="btn btn-link uploadNew" onclick="uploadNew(this)">Upload File</button></p>';
									                    }
				                                    
				                                    echo '</td>
				                                    <td class="radioRate">
				                                        <div class="mt-radio-list">
				                                            <label class="mt-radio mt-radio-outline"> <b>1 - Negligible</b><br><i>'.$consequence_negligible.'</i>
				                                                <input type="radio" value="1" name="consequence_rate_'.$consequence_ID.'" onclick="questionaireRate(2, 2, '.$consequence_ID.', 1)" required '; echo $consequence_rate_arr[$index] == 1 ? 'checked':''; echo ' />
				                                                <span></span>
				                                            </label>
				                                            <label class="mt-radio mt-radio-outline"> <b>2 - Minor</b><br><i>'.$consequence_minor.'</i>
				                                                <input type="radio" value="2" name="consequence_rate_'.$consequence_ID.'" onclick="questionaireRate(2, 2, '.$consequence_ID.', 2)" required '; echo $consequence_rate_arr[$index] == 2 ? 'checked':''; echo ' />
				                                                <span></span>
				                                            </label>
				                                            <label class="mt-radio mt-radio-outline"> <b>3 - Moderate</b><br><i>'.$consequence_moderate.'</i>
				                                                <input type="radio" value="3" name="consequence_rate_'.$consequence_ID.'" onclick="questionaireRate(2, 2, '.$consequence_ID.', 3)" required '; echo $consequence_rate_arr[$index] == 3 ? 'checked':''; echo ' />
				                                                <span></span>
				                                            </label>
				                                            <label class="mt-radio mt-radio-outline"> <b>4 - Significant</b><br><i>'.$consequence_significant.'</i>
				                                                <input type="radio" value="4" name="consequence_rate_'.$consequence_ID.'" onclick="questionaireRate(2, 2, '.$consequence_ID.', 4)" required '; echo $consequence_rate_arr[$index] == 4 ? 'checked':''; echo ' />
				                                                <span></span>
				                                            </label>
				                                            <label class="mt-radio mt-radio-outline"> <b>5 - Severe</b><br><i>'.$consequence_severe.'</i>
				                                                <input type="radio" value="5" name="consequence_rate_'.$consequence_ID.'" onclick="questionaireRate(2, 2, '.$consequence_ID.', 5)" required '; echo $consequence_rate_arr[$index] == 5 ? 'checked':''; echo ' />
				                                                <span></span>
				                                            </label>
				                                        </div>
		                                        		<input type="hidden" class="consequence_rate" name="consequence_rate[]" value="'.$consequence_rate_arr[$index].'" />
				                                    </td>
				                                    <td class="text-center hidden"><a href="javascript:;" class="btn btn-danger btn-circle" onclick="btnRemove(2, 2, '.$consequence_ID.')">Remove</a></td>
				                                </tr>';

				                                $index++;
		                                    }
		                                }

		                                if (!empty($row["consequence_element_other"])) {
							            	$consequence_element_other = explode(' | ', $row["consequence_element_other"]);
							            	$consequence_question_other = explode(' | ', $row["consequence_question_other"]);
							            	$consequence_answer_other = explode(', ', $row["consequence_answer_other"]);
							            	$consequence_comment_other = explode(' | ', $row["consequence_comment_other"]);
							            	$consequence_file_other = explode(' | ', $row["consequence_file_other"]);
							            	$consequence_rate_other = explode(', ', $row["consequence_rate_other"]);

											$index = 0;
							            	foreach ($consequence_element_other as $value) {

		                                        echo '<tr class="tr_other_'.$index.'">
				                                    <td><input type="hidden" name="consequence_element_other[]" value="'.$value.'" />'.$value.'</td>
				                                    <td><input type="hidden" name="consequence_question_other[]" value="'.$consequence_question_other[$index].'" />'.$consequence_question_other[$index].'</td>
				                                    <td>
				                                        <div class="mt-radio-list">
				                                            <label class="mt-radio mt-radio-outline"> Yes
				                                                <input type="radio" value="1" name="consequence_answer_other_'.$index.'" onclick="questionaireAnswerOther(2, 2, '.$index.', 1, this)" required '; echo $consequence_answer_other[$index] == 1 ? 'checked':''; echo ' />
				                                                <span></span>
				                                            </label>
				                                            <label class="mt-radio mt-radio-outline"> No
				                                                <input type="radio" value="0" name="consequence_answer_other_'.$index.'" onclick="questionaireAnswerOther(2, 2, '.$index.', 0, this)" required '; echo $consequence_answer_other[$index] == 0 ? 'checked':''; echo ' />
				                                                <span></span>
				                                            </label>
				                                        </div>
				                                        <input type="hidden" class="consequence_answer" name="consequence_answer_other[]" value="'.$consequence_answer_other[$index].'" />
				                                    </td>
				                                    <td>
				                                    	<textarea class="form-control" name="consequence_comment_other[]" placeholder="Enter comment here">'.$consequence_comment_other[$index].'</textarea>';

				                                    	if (!empty($consequence_file_other[$index])) {
									                    	$fileExtension = fileExtension($consequence_file_other[$index]);
															$src = $fileExtension['src'];
															$embed = $fileExtension['embed'];
															$type = $fileExtension['type'];
															$file_extension = $fileExtension['file_extension'];
									                        $url = $base_url.'uploads/ffva/';

                                                            $files = $src.$url.rawurlencode($consequence_file_other[$index]).$embed;

									                        echo '<input type="hidden" name="consequence_file_temporary_other[]" value="'.$consequence_file_other[$index].'" />
									                        <input type="file" class="form-control '; echo !empty($consequence_file_other[$index]) ? 'hide':''; echo '" name="consequence_file_other[]" />
								                    		<p class="'; echo !empty($consequence_file_other[$index]) ? '':'hide'; echo '" style="margin: 0;"><a href="'.$files.'" data-src="'.$files.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a> | <button type="button" class="btn btn-link uploadNew" onclick="uploadNew(this)">Upload</button></p>';
									                    } else {
									                    	echo '<input type="hidden" name="consequence_file_temporary_other[]" value="" />
									                    	<input type="file" class="form-control margin-top-15 hide" name="consequence_file_other[]" />
				                                    		<p style="margin: 0;"><button type="button" class="btn btn-link uploadNew" onclick="uploadNew(this)">Upload File</button></p>';
									                    }
				                                    
				                                    echo '</td>
				                                    <td class="radioRate">
				                                        <div class="mt-radio-list">
				                                            <label class="mt-radio mt-radio-outline"> <b>1 - Negligible</b>
				                                                <input type="radio" value="1" name="consequence_rate_other_'.$index.'" onclick="questionaireRateOther(2, 2, '.$index.', 1)" required '; echo $consequence_rate_other[$index] == 1 ? 'checked':''; echo ' />
				                                                <span></span>
				                                            </label>
				                                            <label class="mt-radio mt-radio-outline"> <b>2 - Minor</b>
				                                                <input type="radio" value="2" name="consequence_rate_other_'.$index.'" onclick="questionaireRateOther(2, 2, '.$index.', 2)" required '; echo $consequence_rate_other[$index] == 2 ? 'checked':''; echo ' />
				                                                <span></span>
				                                            </label>
				                                            <label class="mt-radio mt-radio-outline"> <b>3 - Moderate</b>
				                                                <input type="radio" value="3" name="consequence_rate_other_'.$index.'" onclick="questionaireRateOther(2, 2, '.$index.', 3)" required '; echo $consequence_rate_other[$index] == 3 ? 'checked':''; echo ' />
				                                                <span></span>
				                                            </label>
				                                            <label class="mt-radio mt-radio-outline"> <b>4 - Significant</b>
				                                                <input type="radio" value="4" name="consequence_rate_other_'.$index.'" onclick="questionaireRateOther(2, 2, '.$index.', 4)" required '; echo $consequence_rate_other[$index] == 4 ? 'checked':''; echo ' />
				                                                <span></span>
				                                            </label>
				                                            <label class="mt-radio mt-radio-outline"> <b>5 - Severe</b>
				                                                <input type="radio" value="5" name="consequence_rate_other_'.$index.'" onclick="questionaireRateOther(2, 2, '.$index.', 5)" required '; echo $consequence_rate_other[$index] == 5 ? 'checked':''; echo ' />
				                                                <span></span>
				                                            </label>
				                                        </div>
				                                        <input type="hidden" class="consequence_rate" name="consequence_rate_other[]" value="'.$consequence_rate_other[$index].'" />
				                                    </td>
				                                    <td class="text-center"><a href="javascript:;" class="btn btn-danger btn-circle" onclick="btnRemoveOther(2, 2, '.$index.')">Remove</a></td>
				                                </tr>';

				                                $index++;
							            	}
		                                }

		                            echo '</tbody>
		                            <tfoot>
		                            	<tr">
		                                    <td><textarea class="form-control consequence_element" placeholder="Enter element here"></textarea></td>
		                                    <td><textarea class="form-control consequence_question" placeholder="Enter question here"></textarea></td>
		                                    <td></td>
		                                    <td></td>
		                                    <td></td>
		                                    <td class="text-center"><a href="javascript:;" class="btn btn-success btn-circle" onclick="btnNew_Questionaire(2, 2)">Add</a></td>
		                                </tr>
		                                <tr>
		                                    <td>Consequence</td>
		                                    <td colspan="2">Consequences of food fraud on this material.</td>
		                                    <td><textarea class="form-control" name="consequence_comment_summary" placeholder="Enter comment here">'.$row["consequence_comment_summary"].'</textarea></td>
		                                    <td colspan="2"><span class="consequence_result">Undefine</span></td>
		                                </tr>
		                                <tr>
		                                    <td>Additional Notes:</td>
		                                    <td colspan="5"><textarea class="form-control" name="consequence_note" placeholder="Enter comment here">'.$row["consequence_note"].'</textarea></td>
		                                </tr>
		                            </tfoot>
		                        </table>
		                    </div>

		                    <hr>

		                    <h4><strong>Risk Matrix</strong></h4>

		                    <div class="row" style="display: flex; align-items: center;">
		                        <div class="col-md-5" style="display: flex; justify-content: center;">
		                            <table id="tableMatrix">
		                                <tr>
		                                    <td></td>
		                                    <td class="text-center" style="font-weight: bold; vertical-align: bottom;">Very<br>Unlikely</td>
		                                    <td class="text-center" style="font-weight: bold; vertical-align: bottom;">Unlikely</td>
		                                    <td class="text-center" style="font-weight: bold; vertical-align: bottom;">Fairly<br>Likely</td>
		                                    <td class="text-center" style="font-weight: bold; vertical-align: bottom;">Likely</td>
		                                    <td class="text-center" style="font-weight: bold; vertical-align: bottom;">Very<br>Likely/<br>Certain</td>
		                                </tr>
		                                <tr>
		                                    <td class="text-right" style="font-weight: bold; padding: 5px;">Negligible</td>
		                                    <td class="text-center matrix-1-1" style="background: #28a745; border: 1px solid; width: 70px; height: 70px;"><i class="fa fa-circle hidden"></i></td>
		                                    <td class="text-center matrix-1-2" style="background: #28a745; border: 1px solid; width: 70px; height: 70px;"><i class="fa fa-circle hidden"></i></td>
		                                    <td class="text-center matrix-1-3" style="background: #ffc107; border: 1px solid; width: 70px; height: 70px;"><i class="fa fa-circle hidden"></i></td>
		                                    <td class="text-center matrix-1-4" style="background: #ffc107; border: 1px solid; width: 70px; height: 70px;"><i class="fa fa-circle hidden"></i></td>
		                                    <td class="text-center matrix-1-5" style="background: #dc3545; border: 1px solid; width: 70px; height: 70px;"><i class="fa fa-circle hidden"></i></td>
		                                </tr>
		                                <tr>
		                                    <td class="text-right" style="font-weight: bold; padding: 5px;">Minor</td>
		                                    <td class="text-center matrix-2-1" style="background: #28a745; border: 1px solid; width: 70px; height: 70px;"><i class="fa fa-circle hidden"></i></td>
		                                    <td class="text-center matrix-2-2" style="background: #28a745; border: 1px solid; width: 70px; height: 70px;"><i class="fa fa-circle hidden"></i></td>
		                                    <td class="text-center matrix-2-3" style="background: #ffc107; border: 1px solid; width: 70px; height: 70px;"><i class="fa fa-circle hidden"></i></td>
		                                    <td class="text-center matrix-2-4" style="background: #ffc107; border: 1px solid; width: 70px; height: 70px;"><i class="fa fa-circle hidden"></i></td>
		                                    <td class="text-center matrix-2-5" style="background: #dc3545; border: 1px solid; width: 70px; height: 70px;"><i class="fa fa-circle hidden"></i></td>
		                                </tr>
		                                <tr>
		                                    <td class="text-right" style="font-weight: bold; padding: 5px;">Moderate</td>
		                                    <td class="text-center matrix-3-1" style="background: #28a745; border: 1px solid; width: 70px; height: 70px;"><i class="fa fa-circle hidden"></i></td>
		                                    <td class="text-center matrix-3-2" style="background: #ffc107; border: 1px solid; width: 70px; height: 70px;"><i class="fa fa-circle hidden"></i></td>
		                                    <td class="text-center matrix-3-3" style="background: #ffc107; border: 1px solid; width: 70px; height: 70px;"><i class="fa fa-circle hidden"></i></td>
		                                    <td class="text-center matrix-3-4" style="background: #dc3545; border: 1px solid; width: 70px; height: 70px;"><i class="fa fa-circle hidden"></i></td>
		                                    <td class="text-center matrix-3-5" style="background: #dc3545; border: 1px solid; width: 70px; height: 70px;"><i class="fa fa-circle hidden"></i></td>
		                                </tr>
		                                <tr>
		                                    <td class="text-right" style="font-weight: bold; padding: 5px;">Significant</td>
		                                    <td class="text-center matrix-4-1" style="background: #ffc107; border: 1px solid; width: 70px; height: 70px;"><i class="fa fa-circle hidden"></i></td>
		                                    <td class="text-center matrix-4-2" style="background: #ffc107; border: 1px solid; width: 70px; height: 70px;"><i class="fa fa-circle hidden"></i></td>
		                                    <td class="text-center matrix-4-3" style="background: #dc3545; border: 1px solid; width: 70px; height: 70px;"><i class="fa fa-circle hidden"></i></td>
		                                    <td class="text-center matrix-4-4" style="background: #dc3545; border: 1px solid; width: 70px; height: 70px;"><i class="fa fa-circle hidden"></i></td>
		                                    <td class="text-center matrix-4-5" style="background: #dc3545; border: 1px solid; width: 70px; height: 70px;"><i class="fa fa-circle hidden"></i></td>
		                                </tr>
		                                <tr>
		                                    <td class="text-right" style="font-weight: bold; padding: 5px;">Severe</td>
		                                    <td class="text-center matrix-5-1" style="background: #ffc107; border: 1px solid; width: 70px; height: 70px;"><i class="fa fa-circle hidden"></i></td>
		                                    <td class="text-center matrix-5-2" style="background: #dc3545; border: 1px solid; width: 70px; height: 70px;"><i class="fa fa-circle hidden"></i></td>
		                                    <td class="text-center matrix-5-3" style="background: #dc3545; border: 1px solid; width: 70px; height: 70px;"><i class="fa fa-circle hidden"></i></td>
		                                    <td class="text-center matrix-5-4" style="background: #dc3545; border: 1px solid; width: 70px; height: 70px;"><i class="fa fa-circle hidden"></i></td>
		                                    <td class="text-center matrix-5-5" style="background: #dc3545; border: 1px solid; width: 70px; height: 70px;"><i class="fa fa-circle hidden"></i></td>
		                                </tr>
		                            </table>
		                        </div>
		                        <div class="col-md-7">
		                            <table id="tableMatrixData">
		                                <tr>
		                                    <td style="padding: 10px;" class="text-right"><strong>Likelihood</strong></td>
		                                    <td style="padding: 10px;"><span class="likelihood_result">Undefine</span></td>
		                                </tr>
		                                <tr>
		                                    <td style="padding: 10px;" class="text-right"><strong>Consequence</strong></td>
		                                    <td style="padding: 10px;"><span class="consequence_result">Undefine</span></td>
		                                </tr>
		                                <tr>
		                                    <td style="padding: 10px;" class="text-right"><strong>Vulnerability Risk Estimate</strong></td>
		                                    <td style="padding: 10px;"><span class="vulnerability_result">Undefine</span></td>
		                                </tr>
		                            </table>
		                        </div>
		                    </div>
		                </div>
		                <div class="tab-pane" id="tabActivities_2">
		                    <h4><strong>Prevention and Deterrence</strong></h4>
		                    <div class="mt-checkbox-list" id="list_activity_1">';

		                    	$selectPrevention = mysqli_query( $conn,"SELECT * FROM tbl_ffva_prevention" );
		                        if ( mysqli_num_rows($selectPrevention) > 0 ) {
		                            while($rowPrevention = mysqli_fetch_array($selectPrevention)) {
		                            	$prevention_ID = $rowPrevention["ID"];
		                            	$prevention_name = $rowPrevention["name"];

		                            	$prevention_arr = array();
		                            	if (!empty($row["prevention"])) { $prevention_arr = explode(', ', $row["prevention"]); }
		                            	echo '<label class="mt-checkbox mt-checkbox-outline"> '.$prevention_name.'
				                            <input type="checkbox" value="'.$prevention_ID.'" name="prevention[]" '; echo in_array($prevention_ID, $prevention_arr) ? 'checked':''; echo '/>
				                            <span></span>
				                        </label>';
		                            }
		                        }

		                        if (!empty($row["prevention_other"])) {
		                           	$prevention_other_arr = explode(', ', $row["prevention_other"]);
		                           	foreach ($prevention_other_arr as $value) {
		                            	echo '<label class="mt-checkbox mt-checkbox-outline"> '.$value.'
				                            <input type="checkbox" value="'.$value.'" name="prevention_other[]" checked />
				                            <span></span>
				                        </label>';
		                           	}
		                        }

		                    echo '</div>
		                    <div class="form-group">
		                        <label class="control-label">Other</label>
		                        <div class="input-group">
		                            <input type="text" class="form-control" id="txtActivity_1" placeholder="Specify">
		                            <span class="input-group-btn">
		                                <button class="btn btn-success" type="button" onclick="btnNew_Activity(1)">Add</button>
		                            </span>
		                        </div>
		                    </div>

		                    <hr>

		                    <h4><strong>Detection</strong></h4>
		                    <div class="mt-checkbox-list" id="list_activity_2">';

		                    	$selectDetection = mysqli_query( $conn,"SELECT * FROM tbl_ffva_detection" );
		                        if ( mysqli_num_rows($selectDetection) > 0 ) {
		                            while($rowDetection = mysqli_fetch_array($selectDetection)) {
		                            	$detection_ID = $rowDetection["ID"];
		                            	$detection_name = $rowDetection["name"];

		                            	$detection_arr = array();
		                            	if (!empty($row["detection"])) { $detection_arr = explode(', ', $row["detection"]); }
		                            	echo '<label class="mt-checkbox mt-checkbox-outline"> '.$detection_name.'
				                            <input type="checkbox" value="'.$detection_ID.'" name="detection[]" '; echo in_array($detection_ID, $detection_arr) ? 'checked':''; echo '/>
				                            <span></span>
				                        </label>';
		                            }
		                        }

		                        if (!empty($row["detection_other"])) {
		                           	$detection_other_arr = explode(', ', $row["detection_other"]);
		                           	foreach ($detection_other_arr as $value) {
		                            	echo '<label class="mt-checkbox mt-checkbox-outline"> '.$value.'
				                            <input type="checkbox" value="'.$value.'" name="detection_other[]" checked />
				                            <span></span>
				                        </label>';
		                           	}
		                        }
		                        
		                    echo '</div>
		                    <div class="form-group">
		                        <label class="control-label">Other</label>
		                        <div class="input-group">
		                            <input type="text" class="form-control" id="txtActivity_2" placeholder="Specify">
		                            <span class="input-group-btn">
		                                <button class="btn btn-success" type="button" onclick="btnNew_Activity(2)">Add</button>
		                            </span>
		                        </div>
		                    </div>

		                    <hr>
		                    
		                    <h4><strong>Mitigation</strong></h4>
		                    <div class="mt-checkbox-list" id="list_activity_3">';

		                    	$selectMitigation = mysqli_query( $conn,"SELECT * FROM tbl_ffva_mitigation" );
		                        if ( mysqli_num_rows($selectMitigation) > 0 ) {
		                            while($rowMitigation = mysqli_fetch_array($selectMitigation)) {
		                            	$mitigation_ID = $rowMitigation["ID"];
		                            	$mitigation_name = $rowMitigation["name"];

		                            	$mitigation_arr = array();
		                            	if (!empty($row["mitigation"])) { $mitigation_arr = explode(', ', $row["mitigation"]); }
		                            	echo '<label class="mt-checkbox mt-checkbox-outline"> '.$mitigation_name.'
				                            <input type="checkbox" value="'.$mitigation_ID.'" name="mitigation[]" '; echo in_array($mitigation_ID, $mitigation_arr) ? 'checked':''; echo '/>
				                            <span></span>
				                        </label>';
		                            }
		                        }

		                        if (!empty($row["mitigation_other"])) {
		                           	$mitigation_other_arr = explode(', ', $row["mitigation_other"]);
		                           	foreach ($mitigation_other_arr as $value) {
		                            	echo '<label class="mt-checkbox mt-checkbox-outline"> '.$value.'
				                            <input type="checkbox" value="'.$value.'" name="mitigation_other[]" checked />
				                            <span></span>
				                        </label>';
		                           	}
		                        }
		                        
		                    echo '</div>
		                    <div class="form-group">
		                        <label class="control-label">Other</label>
		                        <div class="input-group">
		                            <input type="text" class="form-control" id="txtActivity_3" placeholder="Specify">
		                            <span class="input-group-btn">
		                                <button class="btn btn-success" type="button" onclick="btnNew_Activity(3)">Add</button>
		                            </span>
		                        </div>
		                    </div>
		                </div>
		                <div class="tab-pane" id="tabAssigned_2">
	                        <table class="table table-bordered text-center">
	                            <tr>
	                                <td rowspan="2"><strong>Prepared By</strong></td>
	                                <td>
						        		<div class="signatureContainer hide">
						        			<div class="form-group">
									            <label class="col-md-3 control-label">Signature</label>
									            <div class="col-md-5">
									            	<select class="form-control margin-bottom-15" onchange="selectType(this)" name="prepared_type">
									            		<option value="">Select</option>
									            		<option value="1">Sign</option>
									            		<option value="2">Upload</option>
									            	</select>
									            </div>
									        </div>
							                <input type="hidden" name="prepared_signature_default_temp" value="'.$arnel_signature.'" />
							                <img class="img img-fluid sign signature_default" src="'.$arnel_signature.'" />
							                <input type="file" class="form-control hide sign signature_upload" name="prepared_file" />
							                <div class="hide sign signature_sign">
							                	<input type="button" class="btn btn-danger btnClear" onclick="btnClear(this)" value="Clear" />
							                	<div class="signature prepared_signature"></div>
							                </div>
						                </div>
						                <div class="signatureResult">
						                	<button type="button" class="btn btn-link btn-sm" onclick="editSignature(this)"><i class="fa fa-pencil"></i> [edit signature]</button>
						                	<img src="'.$prepared_signature.'" class="signature_img" style="display: block; border: 0; border-bottom: 1px solid; object-fit: contain;"/>
						                	<input type="hidden" name="prepared_signature_temp" value="'.$prepared_signature.'" />
						                </div>
						                <input type="hidden" name="prepared_by" value="'.$prepared_by.'" />
	                                	'.$current_userFName.' '.$current_userLName.'
	                                </td>
	                                <td>Date:</td>
	                                <td><input type="date" class="form-control text-center" name="prepared_date" value="'.$prepared_date.'" required /></td>
	                            </tr>
	                            <tr>
	                                <td><input type="text" class="form-control text-center" name="prepared_position" placeholder="Position Title" value="'.$prepared_position.'" required /></td>
	                                <td colspan="2">'.$enterp_name.'</td>
	                            </tr>
	                        </table><br><br>

	                        <table class="table table-bordered text-center">
	                            <tr>
	                                <td rowspan="2"><strong>Reviewed By</strong></td>
	                                <td>
						        		<div class="signatureContainer hide">
						        			<div class="form-group">
									            <label class="col-md-3 control-label">Signature</label>
									            <div class="col-md-5">
									            	<select class="form-control margin-bottom-15" onchange="selectType(this)" name="reviewed_type">
									            		<option value="">Select</option>
									            		<option value="1">Sign</option>
									            		<option value="2">Upload</option>
									            	</select>
									            </div>
									        </div>
							                <input type="hidden" name="reviewed_signature_default_temp" value="'.$empty_signature.'" />
							                <img class="img img-fluid sign signature_default" src="'.$empty_signature.'" />
							                <input type="file" class="form-control hide sign signature_upload" name="reviewed_file" />
							                <div class="hide sign signature_sign">
							                	<input type="button" class="btn btn-danger btnClear" onclick="btnClear(this)" value="Clear" />
							                	<div class="signature reviewed_signature"></div>
							                </div>
						                </div>
						                <div class="signatureResult">
						                	<button type="button" class="btn btn-link btn-sm" onclick="editSignature(this)"><i class="fa fa-pencil"></i> [edit signature]</button>
						                	<img src="'.$reviewed_signature.'" class="signature_img" style="display: block; border: 0; border-bottom: 1px solid; object-fit: contain;"/>
						                	<input type="hidden" name="reviewed_signature_temp" value="'.$reviewed_signature.'" />
						                </div>';
	                                	echo '<select class="form-control mt-multiselect" name="reviewed_by">
	                                		<option value="">Select Reviewer</option>';

											$selectEmployee = mysqli_query( $conn,"SELECT * from tbl_hr_employee WHERE user_id = $user_id AND suspended = 0 AND status = 1" );
											if ( mysqli_num_rows($selectEmployee) > 0 ) {
												while($rowEmployee = mysqli_fetch_array($selectEmployee)) {
											        $employee_id = $rowEmployee['ID'];

											        $selectUserEnterprise = mysqli_query( $conn,"SELECT * from tbl_user WHERE employee_id = $employee_id AND is_verified = 1 AND is_active = 1" );
											        if ( mysqli_num_rows($selectUserEnterprise) > 0 ) {
											        	$rowUserEnt = mysqli_fetch_array($selectUserEnterprise);
											            $currentEnt_userID = $rowUserEnt['ID'];
											            $currentEnt_userFName = $rowUserEnt['first_name'];
											            $currentEnt_userLName = $rowUserEnt['last_name'];

											        	echo '<option value="'.$currentEnt_userID.'" '; echo $reviewed_by == $currentEnt_userID ? 'SELECTED':''; echo '>'.$currentEnt_userFName.' '.$currentEnt_userLName.'</option>';
											        }
											    }
											}
	                                	echo '</select>
	                                </td>
	                                <td>Date:</td>
	                                <td><input type="date" class="form-control text-center" name="reviewed_date" value="'.$reviewed_date.'" /></td>
	                            </tr>
	                            <tr>
	                                <td><input type="text" class="form-control text-center" name="reviewed_position" placeholder="Position Title" value="'.$reviewed_position.'" /></td>
	                                <td colspan="2">'.$reviewed_enterp_name.'</td>
	                            </tr>
	                        </table><br><br>

	                        <table class="table table-bordered text-center">
	                            <tr>
	                                <td rowspan="2"><strong>Approved By</strong></td>
	                                <td>
						        		<div class="signatureContainer hide">
						        			<div class="form-group">
									            <label class="col-md-3 control-label">Signature</label>
									            <div class="col-md-5">
									            	<select class="form-control margin-bottom-15" onchange="selectType(this)" name="approved_type">
									            		<option value="">Select</option>
									            		<option value="1">Sign</option>
									            		<option value="2">Upload</option>
									            	</select>
									            </div>
									        </div>
							                <input type="hidden" name="approved_signature_default_temp" value="'.$empty_signature.'" />
							                <img class="img img-fluid sign signature_default" src="'.$empty_signature.'" />
							                <input type="file" class="form-control hide sign signature_upload" name="approved_file" />
							                <div class="hide sign signature_sign">
							                	<input type="button" class="btn btn-danger btnClear" onclick="btnClear(this)" value="Clear" />
							                	<div class="signature approved_signature"></div>
							                </div>
						                </div>
						                <div class="signatureResult">
						                	<button type="button" class="btn btn-link btn-sm" onclick="editSignature(this)"><i class="fa fa-pencil"></i> [edit signature]</button>
						                	<img src="'.$approved_signature.'" class="signature_img" style="display: block; border: 0; border-bottom: 1px solid; object-fit: contain;"/>
						                	<input type="hidden" name="approved_signature_temp" value="'.$approved_signature.'" />
						                </div>';
	                                	echo '<select class="form-control mt-multiselect" name="approved_by">
	                                		<option value="">Select Approver</option>';

											$selectEmployee = mysqli_query( $conn,"SELECT * from tbl_hr_employee WHERE user_id = $user_id AND suspended = 0 AND status = 1" );
											if ( mysqli_num_rows($selectEmployee) > 0 ) {
												while($rowEmployee = mysqli_fetch_array($selectEmployee)) {
											        $employee_id = $rowEmployee['ID'];

											        $selectUserEnterprise = mysqli_query( $conn,"SELECT * from tbl_user WHERE employee_id = $employee_id AND is_verified = 1 AND is_active = 1" );
											        if ( mysqli_num_rows($selectUserEnterprise) > 0 ) {
											        	$rowUserEnt = mysqli_fetch_array($selectUserEnterprise);
											            $currentEnt_userID = $rowUserEnt['ID'];
											            $currentEnt_userFName = $rowUserEnt['first_name'];
											            $currentEnt_userLName = $rowUserEnt['last_name'];

											        	echo '<option value="'.$currentEnt_userID.'" '; echo $approved_by == $currentEnt_userID ? 'SELECTED':''; echo '>'.$currentEnt_userFName.' '.$currentEnt_userLName.'</option>';
											        }
											    }
											}
	                                	echo '</select>
	                                </td>
	                                <td>Date:</td>
	                                <td><input type="date" class="form-control text-center" name="approved_date" value="'.$approved_date.'" /></td>
	                            </tr>
	                            <tr>
	                                <td><input type="text" class="form-control text-center" name="approved_position" placeholder="Position Title" value="'.$approved_position.'" /></td>
	                                <td colspan="2">'.$approved_enterp_name.'</td>
	                            </tr>
	                        </table>
		                </div>
		            </div>
		        </div>';

		        $index++;
            }
        }
	}
	if( isset($_GET['modalView_FFVA']) ) {
		$id = $_GET['modalView_FFVA'];

		$result = mysqli_query( $conn,"SELECT * FROM tbl_ffva WHERE ID = $id" );
        if ( mysqli_num_rows($result) > 0 ) {
            while($row = mysqli_fetch_array($result)) {
            	$likelihood_answer = $row["likelihood_answer"];
            	$likelihood_answer_arr = explode(', ', $likelihood_answer);

            	$likelihood_comment = $row["likelihood_comment"];
            	$likelihood_comment_arr = explode(' | ', $likelihood_comment);

            	$likelihood_rate = $row["likelihood_rate"];
            	$likelihood_rate_arr = explode(', ', $likelihood_rate);

            	$likelihood_file = $row["likelihood_file"];
            	$likelihood_file_arr = explode(' | ', $likelihood_file);

            	$consequence_answer = $row["consequence_answer"];
            	$consequence_answer_arr = explode(', ', $consequence_answer);

            	$consequence_comment = $row["consequence_comment"];
            	$consequence_comment_arr = explode(' | ', $consequence_comment);

            	$consequence_file = $row["consequence_file"];
            	$consequence_file_arr = explode(' | ', $consequence_file);

            	$consequence_rate = $row["consequence_rate"];
            	$consequence_rate_arr = explode(', ', $consequence_rate);

				echo '<input type="hidden" value="'.$row["type"].'" name="tab" />
				<input type="hidden" value="'.$row["ID"].'" name="ID" />
				<div class="tabbable tabbable-tabdrop" id="tabdrop_3">
		            <ul class="nav nav-tabs">
		                <li class="active">
		                    <a href="#tabProfile_3" data-toggle="tab">Profile</a>
		                </li>
		                <li>
		                    <a href="#tabQuestionaire_3" data-toggle="tab">Questionaire</a>
		                </li>
		                <li>
		                    <a href="#tabActivities_3" data-toggle="tab">Activities</a>
		                </li>
		            </ul>
		            <div class="tab-content margin-top-20">
		                <div class="tab-pane active" id="tabProfile_3">
		                    <div class="row">
		                        <div class="col-md-4">
		                            <div class="form-group">
		                                <label class="control-label">Company Name</label>
		                                <input class="form-control" type="text" name="company" value="'.$row["company"].'" readonly />
		                            </div>
		                        </div>
		                        <div class="col-md-4">
		                            <div class="form-group">
		                                <label class="control-label">Website</label>
		                                <input class="form-control" type="text" name="website" value="'.$row["website"].'" readonly />
		                            </div>
		                        </div>
		                        <div class="col-md-4">
		                            <div class="form-group">
		                                <label class="control-label">Headquarters</label>
		                                <input class="form-control" type="text" name="headquarters" value="'.$row["headquarters"].'" readonly />
		                            </div>
		                        </div>
		                    </div>
		                    <div class="row">
		                        <div class="col-md-4">
		                            <div class="form-group">
		                                <label class="control-label">Telephone Number</label>
		                                <input class="form-control" type="text" name="telephone" value="'.$row["telephone"].'" readonly />
		                            </div>
		                        </div>
		                        <div class="col-md-4">
		                            <div class="form-group">
		                                <label class="control-label">Email</label>
		                                <input class="form-control" type="email" name="email" value="'.$row["email"].'" readonly />
		                            </div>
		                        </div>
		                        <div class="col-md-4">
		                            <div class="form-group">
		                                <label class="control-label">Contact Person</label>
		                                <input class="form-control" type="text" name="person" value="'.$row["person"].'"  readonly />
		                            </div>
		                        </div>
		                    </div>
		                    <div class="row">
		                        <div class="col-md-12">
		                            <div class="form-group">
		                                <label class="control-label">Product or ingredient or raw material</label>
		                                <textarea class="form-control" name="product" readonly >'.$row["product"].'</textarea>
		                            </div>
		                        </div>
		                        <div class="col-md-12">
		                            <div class="form-group">
		                                <label class="control-label">Materials names and/or codes included in this assessment</label>
		                                <textarea class="form-control" name="assessment" readonly >'.$row["assessment"].'</textarea>
		                            </div>
		                        </div>
		                    </div>
		                    <div class="row">
		                        <div class="col-md-6">
		                            <div class="form-group">
		                                <label class="control-label">Category</label>
		                                <select class="form-control" name="category" readonly disabled>';

		                                    $selectCategory = mysqli_query( $conn,"SELECT * FROM tbl_ffva_category" );
		                                    if ( mysqli_num_rows($selectCategory) > 0 ) {
		                                        while($rowCategory = mysqli_fetch_array($selectCategory)) {
		                                            echo '<option value="'.$rowCategory["ID"].'"'; echo $row["category_id"] == $rowCategory["ID"] ? 'SELECTED':'';  echo '>'.$rowCategory["name"].'</option>';
		                                        }
		                                    }

		                                echo '</select>
		                                <input class="form-control margin-top-15" type="text" name="category_other" placeholder="Specify if other" value="'.$row["category_other"].'" readonly />
		                            </div>
		                        </div>
		                        <div class="col-md-6">
		                            <div class="form-group">
		                                <label class="control-label">Industry</label>
		                                <select class="form-control" name="industry" readonly disabled>';

		                                    $selectIndustry = mysqli_query( $conn,"SELECT * FROM tbl_ffva_industry" );
		                                    if ( mysqli_num_rows($selectIndustry) > 0 ) {
		                                        while($rowIndustry = mysqli_fetch_array($selectIndustry)) {
		                                            echo '<option value="'.$rowIndustry["ID"].'"'; echo $row["industry_id"] == $rowIndustry["ID"] ? 'SELECTED':'';  echo '>'.$rowIndustry["name"].'</option>';
		                                        }
		                                    }

		                                echo '</select>
		                                <input class="form-control margin-top-15" type="text" name="industry_other" placeholder="Specify if other" value="'.$row["industry_other"].'" readonly />
		                            </div>
		                        </div>
		                    </div>
		                </div>
		                <div class="tab-pane" id="tabQuestionaire_3">
		                    <h4><strong>Likelihood Questionnaire</strong></h4>
		                    <h5>Assessment of Likelihood That Food Fraud Will Affect This Material</h5>

		                    <div class="table-scrollable">
		                        <table class="table table-bordered">
		                            <tr class="bg-default">
		                                <th class="text-center" colspan="5">Legend</th>
		                            </tr>
		                            <tr>
		                                <td style="width: 20%; background: #80d3a8;">1 - Very Unlikely</td>
		                                <td style="width: 20%; background: #c7e39f;">2 - Unlikely</td>
		                                <td style="width: 20%; background: #fff980;">3 - Fairly Likely</td>
		                                <td style="width: 20%; background: #fcc98e;">4 - Likely</td>
		                                <td style="width: 20%; background: #f68d92;">5 - Very Likely or Certain</td>
		                            </tr>
		                        </table>
		                    </div>

		                    <div class="table-scrollable">
		                        <table class="table table-bordered tableQuestionaire_1">
		                            <thead>
		                                <tr class="bg-default">
		                                    <th class="text-center">Element</th>
		                                    <th class="text-center">Question</th>
		                                    <th class="text-center">Answer</th>
		                                    <th class="text-center" style="width: 300px;">Comment</th>
		                                    <th class="text-center" style="width: 210px;">Rate</th>
		                                </tr>
		                            </thead>
		                            <tbody>';

										$index = 0;
		                            	$selectLikelihood = mysqli_query( $conn,"SELECT * FROM tbl_ffva_likelihood" );
		                                if ( mysqli_num_rows($selectLikelihood) > 0 ) {
		                                    while($rowLikelihood = mysqli_fetch_array($selectLikelihood)) {
		                                    	$likelihood_ID = $rowLikelihood["ID"];
		                                    	$likelihood_element = $rowLikelihood["element"];
		                                    	$likelihood_question = $rowLikelihood["question"];

		                                        echo '<tr class="tr_'.$likelihood_ID.'">
				                                    <td>'.$likelihood_element.'</td>
				                                    <td>'.$likelihood_question.'</td>
				                                    <td class="text-center">'; echo $likelihood_answer_arr[$index] == 1 ? 'Yes':'No'; echo '</td>
				                                    <td>
				                                    	<p>'.$likelihood_comment_arr[$index].'</p>';

				                                    	if (!empty($likelihood_file_arr[$index])) {
									                    	$fileExtension = fileExtension($likelihood_file_arr[$index]);
															$src = $fileExtension['src'];
															$embed = $fileExtension['embed'];
															$type = $fileExtension['type'];
															$file_extension = $fileExtension['file_extension'];
									                        $url = $base_url.'uploads/ffva/';

									                        echo '<p class="'; echo !empty($likelihood_file_arr[$index]) ? '':'hide'; echo '" style="margin: 0;"><a data-src="'.$src.$url.rawurlencode($likelihood_file_arr[$index]).$embed.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a> </p>';
									                    }
				                                    
				                                    echo '</td>
				                                    <td class="text-center">';

				                                    	if ($likelihood_rate_arr[$index] == 1) {
				                                    		echo '1 - Very Unlikely';
				                                    	} else if ($likelihood_rate_arr[$index] == 2) {
				                                    		echo '2 - Unlikely';
				                                    	} else if ($likelihood_rate_arr[$index] == 3) {
				                                    		echo '3 - Fairly Likely';
				                                    	} else if ($likelihood_rate_arr[$index] == 4) {
				                                    		echo '4 - Likely';
				                                    	} else if ($likelihood_rate_arr[$index] == 5) {
				                                    		echo '5 - Very Likely or Certain';
				                                    	}

				                                    	echo '<input type="hidden" class="likelihood_rate" name="likelihood_rate[]" value="'.$likelihood_rate_arr[$index].'" />
				                                    </td>
				                                </tr>';

				                                $index++;
		                                    }
		                                }

		                                if (!empty($row["likelihood_element_other"])) {
							            	$likelihood_element_other = explode(' | ', $row["likelihood_element_other"]);
							            	$likelihood_question_other = explode(' | ', $row["likelihood_question_other"]);
							            	$likelihood_answer_other = explode(', ', $row["likelihood_answer_other"]);
							            	$likelihood_comment_other = explode(' | ', $row["likelihood_comment_other"]);
							            	$likelihood_file_other = explode(' | ', $row["likelihood_file_other"]);
							            	$likelihood_rate_other = explode(', ', $row["likelihood_rate_other"]);

											$index = 0;
							            	foreach ($likelihood_element_other as $value) {

		                                        echo '<tr class="tr_other_'.$index.'">
				                                    <td>'.$value.'</td>
				                                    <td>'.$likelihood_question_other[$index].'</td>
				                                    <td class="text-center">'; echo $likelihood_answer_other[$index] == 1 ? 'Yes':'No'; echo '</td></td>
				                                    <td>
				                                    	<p>'.$likelihood_comment_other[$index].'</p>';

				                                    	if (!empty($likelihood_file_other[$index])) {
									                    	$fileExtension = fileExtension($likelihood_file_other[$index]);
															$src = $fileExtension['src'];
															$embed = $fileExtension['embed'];
															$type = $fileExtension['type'];
															$file_extension = $fileExtension['file_extension'];
									                        $url = $base_url.'uploads/ffva/';

									                        echo '<p class="'; echo !empty($likelihood_file_other[$index]) ? '':'hide'; echo '" style="margin: 0;"><a data-src="'.$src.$url.rawurlencode($likelihood_file_other[$index]).$embed.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a></p>';
									                    }

				                                    echo '</td>
				                                    <td class="text-center">';

				                                    	if ($likelihood_rate_other_[$index] == 1) {
				                                    		echo '1 - Very Unlikely';
				                                    	} else if ($likelihood_rate_other_[$index] == 2) {
				                                    		echo '2 - Unlikely';
				                                    	} else if ($likelihood_rate_other_[$index] == 3) {
				                                    		echo '3 - Fairly Likely';
				                                    	} else if ($likelihood_rate_other_[$index] == 4) {
				                                    		echo '4 - Likely';
				                                    	} else if ($likelihood_rate_other_[$index] == 5) {
				                                    		echo '5 - Very Likely or Certain';
				                                    	}

				                                    	echo '<input type="hidden" class="consequence_rate" name="consequence_rate_other[]" value="'.$consequence_rate_other[$index].'" />
				                                    </td>
				                                </tr>';

				                                $index++;
							            	}
		                                }
		                                
		                            echo '</tbody>
		                            <tfoot>
		                                <tr>
		                                    <td>Likelihood</td>
		                                    <td colspan="2">Likelihood of this material being affected by food fraud.</td>
		                                    <td><p>'.$row["likelihood_comment_summary"].'</p></td>
		                                    <td class="text-center"><span class="likelihood_result">Undefine</span></td>
		                                </tr>
		                                <tr>
		                                    <td>Additional Notes:</td>
		                                    <td colspan="5"><p>'.$row["likelihood_note"].'</p></td>
		                                </tr>
		                            </tfoot>
		                        </table>
		                    </div>

		                    <hr>

		                    <h4><strong>Consequence Questionnaire</strong></h4>
		                    <h5>Assessment of the Consequences of Food Fraud</h5>

		                    <div class="table-scrollable">
		                        <table class="table table-bordered">
		                            <tr class="bg-default">
		                                <th class="text-center" colspan="5">Legend</th>
		                            </tr>
		                            <tr>
		                                <td style="width: 20%; background: #80d3a8;">1 - Negligible</td>
		                                <td style="width: 20%; background: #c7e39f;">2 - Minor</td>
		                                <td style="width: 20%; background: #fff980;">3 - Moderate</td>
		                                <td style="width: 20%; background: #fcc98e;">4 - Significant</td>
		                                <td style="width: 20%; background: #f68d92;">5 - Severe</td>
		                            </tr>
		                        </table>
		                    </div>

		                    <div class="table-scrollable">
		                        <table class="table table-bordered tableQuestionaire_2">
		                            <thead>
		                                <tr class="bg-default">
		                                    <th class="text-center">Element</th>
		                                    <th class="text-center">Question</th>
		                                    <th class="text-center">Answer</th>
		                                    <th class="text-center" style="width: 300px;">Comment</th>
		                                    <th class="text-center" style="width: 210px;">Rate</th>
		                                </tr>
		                            </thead>
		                            <tbody>';

		                            	$index = 0;
		                            	$selectConsequence = mysqli_query( $conn,"SELECT * FROM tbl_ffva_consequence" );
		                                if ( mysqli_num_rows($selectConsequence) > 0 ) {
		                                    while($rowConsequence = mysqli_fetch_array($selectConsequence)) {
		                                    	$consequence_ID = $rowConsequence["ID"];
		                                    	$consequence_element = $rowConsequence["element"];
		                                    	$consequence_question = $rowConsequence["question"];

		                                        echo '<tr class="tr_'.$consequence_ID.'">
				                                    <td>'.$consequence_element.'</td>
				                                    <td>'.$consequence_question.'</td>
				                                    <td class="text-center">'; echo $consequence_answer_arr[$index] == 1 ? 'Yes':'No'; echo '</td></td>
				                                    <td>
				                                    	<p>'.$consequence_comment[$index].'</p>';

				                                    	if (!empty($consequence_file_arr[$index])) {
									                    	$fileExtension = fileExtension($consequence_file_arr[$index]);
															$src = $fileExtension['src'];
															$embed = $fileExtension['embed'];
															$type = $fileExtension['type'];
															$file_extension = $fileExtension['file_extension'];
									                        $url = $base_url.'uploads/ffva/';

									                        echo '<p class="'; echo !empty($consequence_file_arr[$index]) ? '':'hide'; echo '" style="margin: 0;"><a data-src="'.$src.$url.rawurlencode($consequence_file_arr[$index]).$embed.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a></p>';
									                    }
				                                    
				                                    echo '</td>
				                                    <td class="text-center">';

				                                    	if ($consequence_rate_arr[$index] == 1) {
				                                    		echo '1 - Negligible';
				                                    	} else if ($consequence_rate_arr[$index] == 2) {
				                                    		echo '2 - Minor';
				                                    	} else if ($consequence_rate_arr[$index] == 3) {
				                                    		echo '3 - Moderate';
				                                    	} else if ($consequence_rate_arr[$index] == 4) {
				                                    		echo '4 - Significant';
				                                    	} else if ($consequence_rate_arr[$index] == 5) {
				                                    		echo '5 - Severe';
				                                    	}

				                                    	echo '<input type="hidden" class="consequence_rate" name="consequence_rate[]" value="'.$consequence_rate_arr[$index].'" />
				                                    </td>
				                                </tr>';

				                                $index++;
		                                    }
		                                }

		                                if (!empty($row["consequence_element_other"])) {
							            	$consequence_element_other = explode(' | ', $row["consequence_element_other"]);
							            	$consequence_question_other = explode(' | ', $row["consequence_question_other"]);
							            	$consequence_answer_other = explode(', ', $row["consequence_answer_other"]);
							            	$consequence_comment_other = explode(' | ', $row["consequence_comment_other"]);
							            	$consequence_file_other = explode(' | ', $row["consequence_file_other"]);
							            	$consequence_rate_other = explode(', ', $row["consequence_rate_other"]);

											$index = 0;
							            	foreach ($consequence_element_other as $value) {

		                                        echo '<tr class="tr_other_'.$index.'">
				                                    <td>'.$value.'</td>
				                                    <td>'.$consequence_question_other[$index].'</td>
				                                    <td class="text-center">'; echo $consequence_answer_other[$index] == 1 ? 'Yes':'No'; echo '</td></td>
				                                    <td>
				                                    	<p>'.$consequence_comment_other[$index].'</p>';

				                                    	if (!empty($consequence_file_other[$index])) {
									                    	$fileExtension = fileExtension($consequence_file_other[$index]);
															$src = $fileExtension['src'];
															$embed = $fileExtension['embed'];
															$type = $fileExtension['type'];
															$file_extension = $fileExtension['file_extension'];
									                        $url = $base_url.'uploads/ffva/';

									                        echo '<p class="'; echo !empty($consequence_file_other[$index]) ? '':'hide'; echo '" style="margin: 0;"><a data-src="'.$src.$url.rawurlencode($consequence_file_other[$index]).$embed.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a></p>';
									                    }
				                                    
				                                    echo '</td>
				                                    <td class="text-center">';

				                                    	if ($consequence_rate_other[$index] == 1) {
				                                    		echo '1 - Negligible';
				                                    	} else if ($consequence_rate_other[$index] == 2) {
				                                    		echo '2 - Minor';
				                                    	} else if ($consequence_rate_other[$index] == 3) {
				                                    		echo '3 - Moderate';
				                                    	} else if ($consequence_rate_other[$index] == 4) {
				                                    		echo '4 - Significant';
				                                    	} else if ($consequence_rate_other[$index] == 5) {
				                                    		echo '5 - Severe';
				                                    	}

				                                    	echo '<input type="hidden" class="consequence_rate" name="consequence_rate_other[]" value="'.$consequence_rate_other[$index].'" />
				                                    </td>
				                                </tr>';

				                                $index++;
							            	}
		                                }

		                            echo '</tbody>
		                            <tfoot>
		                                <tr>
		                                    <td>Consequence</td>
		                                    <td colspan="2">Consequences of food fraud on this material.</td>
		                                    <td><p>'.$row["consequence_comment_summary"].'</p></td>
		                                    <td class="text-center"><span class="consequence_result">Undefine</span></td>
		                                </tr>
		                                <tr>
		                                    <td>Additional Notes:</td>
		                                    <td colspan="4"><p>'.$row["consequence_note"].'</p></td>
		                                </tr>
		                            </tfoot>
		                        </table>
		                    </div>

		                    <hr>

		                    <h4><strong>Risk Matrix</strong></h4>

		                    <div class="row" style="display: flex; align-items: center;">
		                        <div class="col-md-5" style="display: flex; justify-content: center;">
		                            <table id="tableMatrix">
		                                <tr>
		                                    <td></td>
		                                    <td class="text-center" style="font-weight: bold; vertical-align: bottom;">Very<br>Unlikely</td>
		                                    <td class="text-center" style="font-weight: bold; vertical-align: bottom;">Unlikely</td>
		                                    <td class="text-center" style="font-weight: bold; vertical-align: bottom;">Fairly<br>Likely</td>
		                                    <td class="text-center" style="font-weight: bold; vertical-align: bottom;">Likely</td>
		                                    <td class="text-center" style="font-weight: bold; vertical-align: bottom;">Very<br>Likely/<br>Certain</td>
		                                </tr>
		                                <tr>
		                                    <td class="text-right" style="font-weight: bold; padding: 5px;">Negligible</td>
		                                    <td class="text-center matrix-1-1" style="background: #28a745; border: 1px solid; width: 70px; height: 70px;"><i class="fa fa-circle hidden"></i></td>
		                                    <td class="text-center matrix-1-2" style="background: #28a745; border: 1px solid; width: 70px; height: 70px;"><i class="fa fa-circle hidden"></i></td>
		                                    <td class="text-center matrix-1-3" style="background: #ffc107; border: 1px solid; width: 70px; height: 70px;"><i class="fa fa-circle hidden"></i></td>
		                                    <td class="text-center matrix-1-4" style="background: #ffc107; border: 1px solid; width: 70px; height: 70px;"><i class="fa fa-circle hidden"></i></td>
		                                    <td class="text-center matrix-1-5" style="background: #dc3545; border: 1px solid; width: 70px; height: 70px;"><i class="fa fa-circle hidden"></i></td>
		                                </tr>
		                                <tr>
		                                    <td class="text-right" style="font-weight: bold; padding: 5px;">Minor</td>
		                                    <td class="text-center matrix-2-1" style="background: #28a745; border: 1px solid; width: 70px; height: 70px;"><i class="fa fa-circle hidden"></i></td>
		                                    <td class="text-center matrix-2-2" style="background: #28a745; border: 1px solid; width: 70px; height: 70px;"><i class="fa fa-circle hidden"></i></td>
		                                    <td class="text-center matrix-2-3" style="background: #ffc107; border: 1px solid; width: 70px; height: 70px;"><i class="fa fa-circle hidden"></i></td>
		                                    <td class="text-center matrix-2-4" style="background: #ffc107; border: 1px solid; width: 70px; height: 70px;"><i class="fa fa-circle hidden"></i></td>
		                                    <td class="text-center matrix-2-5" style="background: #dc3545; border: 1px solid; width: 70px; height: 70px;"><i class="fa fa-circle hidden"></i></td>
		                                </tr>
		                                <tr>
		                                    <td class="text-right" style="font-weight: bold; padding: 5px;">Moderate</td>
		                                    <td class="text-center matrix-3-1" style="background: #28a745; border: 1px solid; width: 70px; height: 70px;"><i class="fa fa-circle hidden"></i></td>
		                                    <td class="text-center matrix-3-2" style="background: #ffc107; border: 1px solid; width: 70px; height: 70px;"><i class="fa fa-circle hidden"></i></td>
		                                    <td class="text-center matrix-3-3" style="background: #ffc107; border: 1px solid; width: 70px; height: 70px;"><i class="fa fa-circle hidden"></i></td>
		                                    <td class="text-center matrix-3-4" style="background: #dc3545; border: 1px solid; width: 70px; height: 70px;"><i class="fa fa-circle hidden"></i></td>
		                                    <td class="text-center matrix-3-5" style="background: #dc3545; border: 1px solid; width: 70px; height: 70px;"><i class="fa fa-circle hidden"></i></td>
		                                </tr>
		                                <tr>
		                                    <td class="text-right" style="font-weight: bold; padding: 5px;">Significant</td>
		                                    <td class="text-center matrix-4-1" style="background: #ffc107; border: 1px solid; width: 70px; height: 70px;"><i class="fa fa-circle hidden"></i></td>
		                                    <td class="text-center matrix-4-2" style="background: #ffc107; border: 1px solid; width: 70px; height: 70px;"><i class="fa fa-circle hidden"></i></td>
		                                    <td class="text-center matrix-4-3" style="background: #dc3545; border: 1px solid; width: 70px; height: 70px;"><i class="fa fa-circle hidden"></i></td>
		                                    <td class="text-center matrix-4-4" style="background: #dc3545; border: 1px solid; width: 70px; height: 70px;"><i class="fa fa-circle hidden"></i></td>
		                                    <td class="text-center matrix-4-5" style="background: #dc3545; border: 1px solid; width: 70px; height: 70px;"><i class="fa fa-circle hidden"></i></td>
		                                </tr>
		                                <tr>
		                                    <td class="text-right" style="font-weight: bold; padding: 5px;">Severe</td>
		                                    <td class="text-center matrix-5-1" style="background: #ffc107; border: 1px solid; width: 70px; height: 70px;"><i class="fa fa-circle hidden"></i></td>
		                                    <td class="text-center matrix-5-2" style="background: #dc3545; border: 1px solid; width: 70px; height: 70px;"><i class="fa fa-circle hidden"></i></td>
		                                    <td class="text-center matrix-5-3" style="background: #dc3545; border: 1px solid; width: 70px; height: 70px;"><i class="fa fa-circle hidden"></i></td>
		                                    <td class="text-center matrix-5-4" style="background: #dc3545; border: 1px solid; width: 70px; height: 70px;"><i class="fa fa-circle hidden"></i></td>
		                                    <td class="text-center matrix-5-5" style="background: #dc3545; border: 1px solid; width: 70px; height: 70px;"><i class="fa fa-circle hidden"></i></td>
		                                </tr>
		                            </table>
		                        </div>
		                        <div class="col-md-7">
		                            <table id="tableMatrixData">
		                                <tr>
		                                    <td style="padding: 10px;" class="text-right"><strong>Likelihood</strong></td>
		                                    <td style="padding: 10px;"><span class="likelihood_result">Undefine</span></td>
		                                </tr>
		                                <tr>
		                                    <td style="padding: 10px;" class="text-right"><strong>Consequence</strong></td>
		                                    <td style="padding: 10px;"><span class="consequence_result">Undefine</span></td>
		                                </tr>
		                                <tr>
		                                    <td style="padding: 10px;" class="text-right"><strong>Vulnerability Risk Estimate</strong></td>
		                                    <td style="padding: 10px;"><span class="vulnerability_result">Undefine</span></td>
		                                </tr>
		                            </table>
		                        </div>
		                    </div>
		                </div>
		                <div class="tab-pane" id="tabActivities_3">
		                    <h4><strong>Prevention and Deterrence</strong></h4>
		                    <div class="mt-checkbox-list" id="list_activity_1">';

		                    	$selectPrevention = mysqli_query( $conn,"SELECT * FROM tbl_ffva_prevention" );
		                        if ( mysqli_num_rows($selectPrevention) > 0 ) {
		                            while($rowPrevention = mysqli_fetch_array($selectPrevention)) {
		                            	$prevention_ID = $rowPrevention["ID"];
		                            	$prevention_name = $rowPrevention["name"];

		                            	if (!empty($row["prevention"])) {
		                            		$prevention_arr = explode(', ', $row["prevention"]);

			                            	echo '<label class="mt-checkbox mt-checkbox-outline"> '.$prevention_name.'
					                            <input type="checkbox" value="'.$prevention_ID.'" name="prevention[]" '; echo in_array($prevention_ID, $prevention_arr) ? 'checked':''; echo '/>
					                            <span></span>
					                        </label>';
		                            	} else {
			                            	echo '<label class="mt-checkbox mt-checkbox-outline"> '.$prevention_name.'
					                            <input type="checkbox" value="'.$prevention_ID.'" name="prevention[]" />
					                            <span></span>
					                        </label>';
		                            	}
		                            }
		                        }

		                        if (!empty($row["prevention_other"])) {
		                           	$prevention_other_arr = explode(', ', $row["prevention_other"]);
		                           	foreach ($prevention_other_arr as $value) {
		                            	echo '<label class="mt-checkbox mt-checkbox-outline"> '.$value.'
				                            <input type="checkbox" value="'.$value.'" name="prevention_other[]" checked />
				                            <span></span>
				                        </label>';
		                           	}
		                        }

		                    echo '</div>
		                    <div class="form-group">
		                        <label class="control-label">Other</label>
		                        <div class="input-group">
		                            <input type="text" class="form-control" id="txtActivity_1" placeholder="Specify">
		                            <span class="input-group-btn">
		                                <button class="btn btn-success" type="button" onclick="btnNew_Activity(1)">Add</button>
		                            </span>
		                        </div>
		                    </div>

		                    <hr>

		                    <h4><strong>Detection</strong></h4>
		                    <div class="mt-checkbox-list" id="list_activity_2">';

		                    	$selectDetection = mysqli_query( $conn,"SELECT * FROM tbl_ffva_detection" );
		                        if ( mysqli_num_rows($selectDetection) > 0 ) {
		                            while($rowDetection = mysqli_fetch_array($selectDetection)) {
		                            	$detection_ID = $rowDetection["ID"];
		                            	$detection_name = $rowDetection["name"];

		                            	if (!empty($row["detection"])) {
		                            		$detection_arr = explode(', ', $row["detection"]);

			                            	echo '<label class="mt-checkbox mt-checkbox-outline"> '.$detection_name.'
					                            <input type="checkbox" value="'.$detection_ID.'" name="detection[]" '; echo in_array($detection_ID, $detection_arr) ? 'checked':''; echo '/>
					                            <span></span>
					                        </label>';
		                            	} else {
			                            	echo '<label class="mt-checkbox mt-checkbox-outline"> '.$detection_name.'
					                            <input type="checkbox" value="'.$detection_ID.'" name="detection[]" />
					                            <span></span>
					                        </label>';
		                            	}
		                            }
		                        }

		                        if (!empty($row["detection_other"])) {
		                           	$detection_other_arr = explode(', ', $row["detection_other"]);
		                           	foreach ($detection_other_arr as $value) {
		                            	echo '<label class="mt-checkbox mt-checkbox-outline"> '.$value.'
				                            <input type="checkbox" value="'.$value.'" name="detection_other[]" checked />
				                            <span></span>
				                        </label>';
		                           	}
		                        }
		                        
		                    echo '</div>
		                    <div class="form-group">
		                        <label class="control-label">Other</label>
		                        <div class="input-group">
		                            <input type="text" class="form-control" id="txtActivity_2" placeholder="Specify">
		                            <span class="input-group-btn">
		                                <button class="btn btn-success" type="button" onclick="btnNew_Activity(2)">Add</button>
		                            </span>
		                        </div>
		                    </div>

		                    <hr>
		                    
		                    <h4><strong>Mitigation</strong></h4>
		                    <div class="mt-checkbox-list" id="list_activity_3">';

		                    	$selectMitigation = mysqli_query( $conn,"SELECT * FROM tbl_ffva_mitigation" );
		                        if ( mysqli_num_rows($selectMitigation) > 0 ) {
		                            while($rowMitigation = mysqli_fetch_array($selectMitigation)) {
		                            	$mitigation_ID = $rowMitigation["ID"];
		                            	$mitigation_name = $rowMitigation["name"];

		                            	if (!empty($row["mitigation"])) {
		                            		$mitigation_arr = explode(', ', $row["mitigation"]);

			                            	echo '<label class="mt-checkbox mt-checkbox-outline"> '.$mitigation_name.'
					                            <input type="checkbox" value="'.$mitigation_ID.'" name="mitigation[]" '; echo in_array($mitigation_ID, $mitigation_arr) ? 'checked':''; echo '/>
					                            <span></span>
					                        </label>';
		                            	} else {
			                            	echo '<label class="mt-checkbox mt-checkbox-outline"> '.$detection_name.'
					                            <input type="checkbox" value="'.$mitigation_ID.'" name="mitigation[]" />
					                            <span></span>
					                        </label>';
		                            	}
		                            }
		                        }

		                        if (!empty($row["mitigation_other"])) {
		                           	$mitigation_other_arr = explode(', ', $row["mitigation_other"]);
		                           	foreach ($mitigation_other_arr as $value) {
		                            	echo '<label class="mt-checkbox mt-checkbox-outline"> '.$value.'
				                            <input type="checkbox" value="'.$value.'" name="mitigation_other[]" checked />
				                            <span></span>
				                        </label>';
		                           	}
		                        }
		                        
		                    echo '</div>
		                    <div class="form-group">
		                        <label class="control-label">Other</label>
		                        <div class="input-group">
		                            <input type="text" class="form-control" id="txtActivity_3" placeholder="Specify">
		                            <span class="input-group-btn">
		                                <button class="btn btn-success" type="button" onclick="btnNew_Activity(3)">Add</button>
		                            </span>
		                        </div>
		                    </div>
		                </div>
		            </div>
		        </div>';

		        $index++;
            }
        }
	}
	if( isset($_GET['modalHistory_FFVA']) ) {
		$id = $_GET['modalHistory_FFVA'];

		if (!empty($_COOKIE['switchAccount'])) {
			$portal_user = $_COOKIE['ID'];
			$user_id = $_COOKIE['switchAccount'];
		}
		else {
			$portal_user = $_COOKIE['ID'];
			$user_id = employerID($portal_user);
		}

		echo '<div class="table-scrollable">
            <table class="table table-bordered table-hover" id="tableData_1">
                <thead>
                    <tr>
                        <th style="width: 80px;">ID#</th>
                        <th>'; echo $id == 1 ? 'Supplier':'Ingredient'; echo ' Name</th>
                        <th style="width: 135px;" class="text-center">Date Performed</th>
                        <th style="width: 135px;" class="text-center">Due Date</th>
                        <th style="width: 90px;" class="text-center">Status</th>
                        <th style="width: 80px;"></th>
                    </tr>
                </thead>
                <tbody>';

                        $resultSupplier = mysqli_query( $conn,"SELECT * FROM tbl_ffva WHERE type = $id AND updated = 1" );
                        if ( mysqli_num_rows($resultSupplier) > 0 ) {
                            while($rowSupplier = mysqli_fetch_array($resultSupplier)) {
                                $supplier_user_id = $rowSupplier["user_id"];
                                $supplier_reviewed_by = $rowSupplier["reviewed_by"];
                                $supplier_approved_by = $rowSupplier["approved_by"];

                                $supplier_id = $rowSupplier["ID"];
                                $supplier_company = $rowSupplier["company"];
                                $supplier_product = $rowSupplier["product"];

                                $data_status = $rowSupplier['status'];
                                $status = "Drafted";
                                // if (empty($int_review_assigned)) { $status = 'Drafted'; }
                                if (!empty($rowSupplier['int_review_assigned']) AND $rowSupplier['int_review_status'] == 1) { $status = 'Reviewed'; }
                                if (!empty($rowSupplier['int_review_assigned']) AND $rowSupplier['int_review_status'] == 1 AND !empty($rowSupplier['int_verify_assigned']) AND $rowSupplier['int_verify_status'] == 1) { $status = 'Approved by CIG'; }
                                if (!empty($rowSupplier['int_review_assigned']) AND $rowSupplier['int_review_status'] == 1 AND !empty($rowSupplier['int_verify_assigned']) AND $rowSupplier['int_verify_status'] == 1 AND !empty($rowSupplier['approved_date'])) { $status = "Approved by Client"; }

                                $data_last_modified = $rowSupplier['last_modified'];
                                $data_last_modified = new DateTime($data_last_modified);
                                $data_last_modified = $data_last_modified->format('M d, Y');
                                                                        
                                $due_date = date('Y-m-d', strtotime('+1 year', strtotime($data_last_modified)) );
                                $due_date = new DateTime($due_date);
                                $due_date = $due_date->format('M d, Y');

                                if ($supplier_user_id == $user_id) {
                                    echo '<tr id="tr_'.$supplier_id.'">
                                        <td>'.$supplier_id.'</td>
                                        <td>'; echo $id == 1 ? htmlentities($supplier_company):htmlentities($supplier_product); echo '</td>
                                        <td class="text-center">'.$data_last_modified.'</td>
                                        <td class="text-center">'.$due_date.'</td>
                                        <td class="text-center">'.$status.'</td>
                                        <td class="text-center">
                                            <a href="pdf_ffva?id='.$supplier_id.'" class="btn btn-outline btn-circle dark btn-sm" target="_blank">PDF</a>
                                        </td>
                                    </tr>';
                                } else {
                                    if ($supplier_reviewed_by == $user_id || $supplier_approved_by == $user_id) {
                                        echo '<tr id="tr_'.$supplier_id.'">
                                            <td>'.$supplier_id.'</td>
                                            <td>'; echo $id == 1 ? htmlentities($supplier_company):htmlentities($supplier_product); echo '</td>
                                            <td class="text-center">'.$data_last_modified.'</td>
                                            <td class="text-center">'.$due_date.'</td>
                                            <td class="text-center">'.$status.'</td>
                                            <td class="text-center">
                                                <a href="pdf_ffva?id='.$supplier_id.'" class="btn btn-outline btn-circle dark btn-sm" target="_blank">PDF</a>
                                            </td>
                                        </tr>';
                                    }
                                }
                            }
                        }

                echo '</tbody>
            </table>
        </div>';
	}
	if( isset($_GET['modalArchived_FFVA']) ) {
		$id = $_GET['modalArchived_FFVA'];

		if (!empty($_COOKIE['switchAccount'])) {
			$portal_user = $_COOKIE['ID'];
			$user_id = $_COOKIE['switchAccount'];
		}
		else {
			$portal_user = $_COOKIE['ID'];
			$user_id = employerID($portal_user);
		}

        $resultSupplier = mysqli_query( $conn,"SELECT * FROM tbl_ffva WHERE archived = 1 AND deleted = 0 AND type = $id AND updated = 0 AND user_id = $user_id" );
        if ( mysqli_num_rows($resultSupplier) > 0 ) {
            while($rowSupplier = mysqli_fetch_array($resultSupplier)) {
                $supplier_user_id = $rowSupplier["user_id"];
                $supplier_reviewed_by = $rowSupplier["reviewed_by"];
                $supplier_approved_by = $rowSupplier["approved_by"];

                $int_review_assigned_name = '';
                $int_review_assigned = $rowSupplier["int_review_assigned"];
                $int_review_status = $rowSupplier["int_review_status"];
                $int_review_comment = $rowSupplier["int_review_comment"];

                if (!empty($int_review_assigned)) {
                    $selectUser = mysqli_query( $conn,"SELECT * FROM tbl_hr_employee WHERE ID = $int_review_assigned" );
                    if ( mysqli_num_rows($selectUser) > 0 ) {
                        $rowUser = mysqli_fetch_array($selectUser);
                        $int_review_assigned_name = $rowUser["first_name"] .' '. $rowUser["last_name"];
                    }
                }

                $int_verify_assigned_name = '';
                $int_verify_assigned = $rowSupplier["int_verify_assigned"];
                $int_verify_status = $rowSupplier["int_verify_status"];
                $int_verify_comment = $rowSupplier["int_verify_comment"];

                if (!empty($int_verify_assigned)) {
                    $selectUser = mysqli_query( $conn,"SELECT * FROM tbl_hr_employee WHERE ID = $int_verify_assigned" );
                    if ( mysqli_num_rows($selectUser) > 0 ) {
                        $rowUser = mysqli_fetch_array($selectUser);
                        $int_verify_assigned_name = $rowUser["first_name"] .' '. $rowUser["last_name"];
                    }
                }

                $supplier_id = $rowSupplier["ID"];
                $supplier_company = $rowSupplier["company"];
                if ($id == 2) {
                	$supplier_company = $rowSupplier["product"];
                }
                
                $status = "Drafted";
                // if (empty($int_review_assigned)) { $status = 'Drafted'; }
                if (!empty($int_review_assigned) AND $int_review_status == 1) { $status = 'Reviewed'; }
                if (!empty($int_review_assigned) AND $int_review_status == 1 AND !empty($int_verify_assigned) AND $int_verify_status == 1) { $status = 'Approved by CIG'; }
                if (!empty($int_review_assigned) AND $int_review_status == 1 AND !empty($int_verify_assigned) AND $int_verify_status == 1 AND !empty($rowSupplier['approved_date'])) { $status = "Approved by Client"; }

                $data_last_modified = $rowSupplier['last_modified'];
                $data_last_modified = new DateTime($data_last_modified);
                $data_last_modified = $data_last_modified->format('M d, Y');
                                                        
                $due_date = date('Y-m-d', strtotime('+1 year', strtotime($data_last_modified)) );
                $due_date = new DateTime($due_date);
                $due_date = $due_date->format('M d, Y');


                $likelihood_rate = $rowSupplier["likelihood_rate"];
                $likelihood_rate_arr = explode(', ', $likelihood_rate);

                $consequence_rate = $rowSupplier["consequence_rate"];
                $consequence_rate_arr = explode(', ', $consequence_rate);


                // Likelihood
                $index = 0;
                $count = 0;
                $sum = 0;
                $total_likelihood = 0;
                $selectLikelihood = mysqli_query( $conn,"SELECT * FROM tbl_ffva_likelihood" );
                if ( mysqli_num_rows($selectLikelihood) > 0 ) {
                    while($rowLikelihood = mysqli_fetch_array($selectLikelihood)) {
                        $likelihood_type_arr = explode(', ', $rowLikelihood["type"]);
                        if (in_array($rowSupplier["type"], $likelihood_type_arr)) {
                            if (empty($likelihood_rate_arr[$index])) { $sum += 1; }
                            else { $sum += $likelihood_rate_arr[$index]; }
                            
                            $index++;
                            $count++;
                        }
                    }
                }

                if (!empty($rowSupplier["likelihood_element_other"])) {
                    $likelihood_element_other = explode(' | ', $rowSupplier["likelihood_element_other"]);
                    $likelihood_rate_other = explode(', ', $rowSupplier["likelihood_rate_other"]);

                    $index = 0;
                    foreach ($likelihood_element_other as $value) {
                        $sum += $likelihood_rate_other[$index];
                        $index++;
                        $count++;
                    }
                }

                $total_likelihood = $sum / $count;


                // Consequence
                $index = 0;
                $count = 0;
                $sum = 0;
                $total_consequence = 0;
                $selectConsequence = mysqli_query( $conn,"SELECT * FROM tbl_ffva_consequence" );
                if ( mysqli_num_rows($selectConsequence) > 0 ) {
                    while($rowConsequence = mysqli_fetch_array($selectConsequence)) {
                        $sum += $consequence_rate_arr[$index];
                        $index++;
                        $count++;
                    }
                }

                if (!empty($rowSupplier["consequence_element_other"])) {
                    $consequence_element_other = explode(' | ', $rowSupplier["consequence_element_other"]);
                    $consequence_rate_other = explode(', ', $rowSupplier["consequence_rate_other"]);

                    $index = 0;
                    foreach ($consequence_element_other as $value) {
                        $sum += $consequence_rate_other[$index];
                        $index++;
                        $count++;
                    }
                }

                $total_consequence = $sum / $count;


                // Matrix
                $plot_x = 1;
                $plot_y = 1;

                if (round($total_likelihood) > 0) { $plot_x = round($total_likelihood); }
                if (round($total_consequence) > 0) { $plot_y = round($total_consequence); }

                if ($plot_x == 1 && $plot_y == 1) { $vulnerability = 1; }
                else if ($plot_x == 1 && $plot_y == 2) { $vulnerability = 1; }
                else if ($plot_x == 1 && $plot_y == 3) { $vulnerability = 1; }
                else if ($plot_x == 1 && $plot_y == 4) { $vulnerability = 2; }
                else if ($plot_x == 1 && $plot_y == 5) { $vulnerability = 2; }
                else if ($plot_x == 2 && $plot_y == 1) { $vulnerability = 1; }
                else if ($plot_x == 2 && $plot_y == 2) { $vulnerability = 1; }
                else if ($plot_x == 2 && $plot_y == 3) { $vulnerability = 2; }
                else if ($plot_x == 2 && $plot_y == 4) { $vulnerability = 2; }
                else if ($plot_x == 2 && $plot_y == 5) { $vulnerability = 3; }
                else if ($plot_x == 3 && $plot_y == 1) { $vulnerability = 2; }
                else if ($plot_x == 3 && $plot_y == 2) { $vulnerability = 2; }
                else if ($plot_x == 3 && $plot_y == 3) { $vulnerability = 2; }
                else if ($plot_x == 3 && $plot_y == 4) { $vulnerability = 3; }
                else if ($plot_x == 3 && $plot_y == 5) { $vulnerability = 3; }
                else if ($plot_x == 4 && $plot_y == 1) { $vulnerability = 2; }
                else if ($plot_x == 4 && $plot_y == 2) { $vulnerability = 2; }
                else if ($plot_x == 4 && $plot_y == 3) { $vulnerability = 3; }
                else if ($plot_x == 4 && $plot_y == 4) { $vulnerability = 3; }
                else if ($plot_x == 4 && $plot_y == 5) { $vulnerability = 3; }
                else if ($plot_x == 5 && $plot_y == 1) { $vulnerability = 3; }
                else if ($plot_x == 5 && $plot_y == 2) { $vulnerability = 3; }
                else if ($plot_x == 5 && $plot_y == 3) { $vulnerability = 3; }
                else if ($plot_x == 5 && $plot_y == 4) { $vulnerability = 3; }
                else if ($plot_x == 5 && $plot_y == 5) { $vulnerability = 3; }
                else { $vulnerability = 0; }

                if ($vulnerability == 1) { $vulnerability_result = '<span class="font-green-jungle bold">Low Risk</span>'; }
                else if ($vulnerability == 2) { $vulnerability_result = '<span class="font-yellow-gold bold">Medium Risk</span>'; }
                else if ($vulnerability == 3) { $vulnerability_result = '<span class="font-red-thunderbird bold">High Risk</span>'; }
                else { $vulnerability_result = ""; }
                
                $file_files = $rowSupplier["files"];
                if(!empty($file_files)) {
                    $fileExtension = fileExtension($file_files);
                    $src = $fileExtension['src'];
                    $embed = $fileExtension['embed'];
                    $type = $fileExtension['type'];
                    $file_extension = $fileExtension['file_extension'];
                    $url = $base_url.'uploads/ffva/';
                }

                echo '<tr id="tr_'.$supplier_id.'">
                    <td>'.$supplier_id.'</td>
                    <td>'.$supplier_company.'</td>
                    <td class="text-center">'.$vulnerability_result.'</td>
                    <td class="text-center">'.$data_last_modified.'</td>
                    <td class="text-center">'.$due_date.'</td>
                    <td class="text-center">'.$status.'</td>
                    <td class="text-center">
                        <div class="btn-group btn-group-circle">
                            <a href="pdf_ffva?id='.$supplier_id.'&signed=0" class="btn btn-outline dark btn-sm" target="_blank">PDF</a>
                            <a href="javascript:;" class="btn btn-success btn-sm" data-toggle="modal" onclick="btnTemplate('.$supplier_id.')">Use Template</a>
                            <a href="javascript:;" class="btn btn-danger btn-sm" data-toggle="modal" onclick="btnRevert('.$supplier_id.', 1)">Revert</a>
                        </div>
                    </td>
                </tr>';
            }
        }
	}
	if( isset($_GET['modalRef_FFVA']) ) {
		$id = $_GET['modalRef_FFVA'];
		$type = $_GET['type'];

		$ref_id = '';
		$ref_content = '';
		$result = mysqli_query( $conn,"SELECT * FROM tbl_ffva_reference WHERE type = $type AND element = $id" );
        if ( mysqli_num_rows($result) > 0 ) {
        	$row = mysqli_fetch_array($result);
        	$ref_id = $row["ID"];
        	$ref_content = $row["content"];
        }
		echo '<input type="hidden" value="'.$id.'" name="ID" />
		<input type="hidden" value="'.$type.'" name="type" />
		<textarea class="form-control" name="content">'.$ref_content.'</textarea>';
	}
	if( isset($_GET['modalSign_FFVA']) ) {
		$id = $_GET['modalSign_FFVA'];
		$area = $_GET['area'];

        $result = mysqli_query( $conn,"SELECT * FROM tbl_ffva WHERE ID = $id" );
        if ( mysqli_num_rows($result) > 0 ) {
        	$row = mysqli_fetch_array($result);

        	$reviewed_by = employerID($row["reviewed_by"]);
        	$reviewed_signature = $row["reviewed_signature"];
        	$reviewed_position = $row["reviewed_position"];
	        $selectEnterprise = mysqli_query( $conn,"SELECT * from tblEnterpiseDetails WHERE users_entities = $reviewed_by" );
	        if ( mysqli_num_rows($selectEnterprise) > 0 ) {
	            $rowEnterprise = mysqli_fetch_array($selectEnterprise);
	            $reviewed_enterp_name = $rowEnterprise['businessname'];
	        } else {
	        	$reviewed_enterp_name = "Company Name";
	        }

        	$approved_by = employerID($row["approved_by"]);
        	$approved_position = $row["approved_position"];
        	$approved_signature = $row["approved_signature"];
	        $selectEnterprise = mysqli_query( $conn,"SELECT * from tblEnterpiseDetails WHERE users_entities = $approved_by" );
	        if ( mysqli_num_rows($selectEnterprise) > 0 ) {
	            $rowEnterprise = mysqli_fetch_array($selectEnterprise);
	            $approved_enterp_name = $rowEnterprise['businessname'];
	        } else {
	        	$approved_enterp_name = "Company Name";
	        }

	        if ($area == 1) {
				$selectUser = mysqli_query( $conn,"SELECT * from tbl_user WHERE ID = '".$row["reviewed_by"]."'" );
		        if ( mysqli_num_rows($selectUser) > 0 ) {
		            $rowUser = mysqli_fetch_array($selectUser);
		            $current_userFName = $rowUser['first_name'];
		            $current_userLName = $rowUser['last_name'];
		        }
	        } else {
				$selectUser = mysqli_query( $conn,"SELECT * from tbl_user WHERE ID = '".$row["approved_by"]."'" );
		        if ( mysqli_num_rows($selectUser) > 0 ) {
		            $rowUser = mysqli_fetch_array($selectUser);
		            $current_userFName = $rowUser['first_name'];
		            $current_userLName = $rowUser['last_name'];
		        }
	        }
        }

		echo '<input type="hidden" value="'.$id.'" name="ID" />
		<input type="hidden" value="'.$area.'" name="area" />';

        if ($area == 1) {
        	echo '<table class="table table-bordered text-center">
	            <tr>
	                <td rowspan="2"><strong>Reviewed By</strong></td>
                    <td style="width: 350px;">
		        		<div class="signatureContainer hide">
		        			<div class="form-group">
					            <label class="col-md-3 control-label">Signature</label>
					            <div class="col-md-5">
					            	<select class="form-control margin-bottom-15" onchange="selectType(this)" name="reviewed_type">
					            		<option value="">Select</option>
					            		<option value="1">Sign</option>
					            		<option value="2">Upload</option>
					            	</select>
					            </div>
					        </div>
			                <input type="hidden" name="reviewed_signature_default_temp" value="'.$empty_signature.'" />
			                <img class="img img-fluid sign signature_default" src="'.$empty_signature.'" />
			                <input type="file" class="form-control hide sign signature_upload" name="reviewed_file" />
			                <div class="hide sign signature_sign">
			                	<input type="button" class="btn btn-danger btnClear" onclick="btnClear(this)" value="Clear" />
			                	<div class="signature reviewed_signature"></div>
			                </div>
		                </div>
		                <div class="signatureResult">
		                	<button type="button" class="btn btn-link btn-sm" onclick="editSignature(this)"><i class="fa fa-pencil"></i> [edit signature]</button>
		                	<img src="'.$reviewed_signature.'" class="signature_img" style="display: block; border: 0; border-bottom: 1px solid;"/>
		                	<input type="hidden" name="reviewed_signature_temp" value="'.$reviewed_signature.'" />
		                </div>
		                <input type="hidden" name="signed_by" value="'.$reviewed_by.'" />
                    	'.$current_userFName.' '.$current_userLName.'
                    </td>
	                <td>Date:</td>
	                <td><input type="date" class="form-control text-center" name="signed_date" value="'.date('Y-m-d').'" required /></td>
	            </tr>
	            <tr>
	                <td><input type="text" class="form-control text-center" name="signed_position" placeholder="Position Title" value="'.$reviewed_position.'" required /></td>
	                <td colspan="2">'.$reviewed_enterp_name.'</td>
	            </tr>
	        </table>';
        } else {
        	echo '<table class="table table-bordered text-center">
	            <tr>
	                <td rowspan="2"><strong>Approved By</strong></td>
	                <td style="width: 350px;">
		        		<div class="signatureContainer hide">
		        			<div class="form-group">
					            <label class="col-md-3 control-label">Signature</label>
					            <div class="col-md-5">
					            	<select class="form-control margin-bottom-15" onchange="selectType(this)" name="reviewed_type">
					            		<option value="">Select</option>
					            		<option value="1">Sign</option>
					            		<option value="2">Upload</option>
					            	</select>
					            </div>
					        </div>
			                <input type="hidden" name="approved_signature_default_temp" value="'.$empty_signature.'" />
			                <img class="img img-fluid sign signature_default" src="'.$empty_signature.'" />
			                <input type="file" class="form-control hide sign signature_upload" name="approved_file" />
			                <div class="hide sign signature_sign">
			                	<input type="button" class="btn btn-danger btnClear" onclick="btnClear(this)" value="Clear" />
			                	<div class="signature approved_signature"></div>
			                </div>
		                </div>
		                <div class="signatureResult">
		                	<button type="button" class="btn btn-link btn-sm" onclick="editSignature(this)"><i class="fa fa-pencil"></i> [edit signature]</button>
		                	<img src="'.$approved_signature.'" class="signature_img" style="display: block; border: 0; border-bottom: 1px solid;"/>
		                	<input type="hidden" name="approved_signature_temp" value="'.$approved_signature.'" />
		                </div>
		                <input type="hidden" name="signed_by" value="'.$approved_by.'" />
                    	'.$current_userFName.' '.$current_userLName.'
                    </td>
	                <td>Date:</td>
	                <td><input type="date" class="form-control text-center" name="signed_date" value="'.date('Y-m-d').'" required /></td>
	            </tr>
	            <tr>
	                <td><input type="text" class="form-control text-center" name="signed_position" placeholder="Position Title" value="'.$approved_position.'" required /></td>
	                <td colspan="2">'.$approved_enterp_name.'</td>
	            </tr>
	        </table>';
        }
	}
	if( isset($_GET['modalFile_FFVA']) ) {
		$id = $_GET['modalFile_FFVA'];
		$area = $_GET['area'];

        $result = mysqli_query( $conn,"SELECT * FROM tbl_ffva WHERE ID = $id" );
        if ( mysqli_num_rows($result) > 0 ) {
        	$row = mysqli_fetch_array($result);
        	$reviewed_position = $row["reviewed_position"];
        	$reviewed_date = $row["reviewed_date"];
        	$approved_position = $row["approved_position"];
        	$approved_date = $row["approved_date"];
        }

		echo '<input type="hidden" value="'.$id.'" name="ID" />
		<input type="hidden" value="'.$area.'" name="area" />
		<div class="form-group">
            <label class="col-md-3 control-label">Select File</label>
            <div class="col-md-8">
                <input class="form-control" type="file" name="file" required /">
            </div>
        </div>
		<div class="form-group">
            <label class="col-md-3 control-label">Position Title</label>
            <div class="col-md-8">';
            	if ($area == 1) { echo '<input class="form-control" type="text" name="signed_position" value="'.$reviewed_position.'" required /">'; }
            	else if ($area == 2) { echo '<input class="form-control" type="text" name="signed_position" value="'.$approved_position.'" required /">'; }
            	else { echo '<input class="form-control" type="text" name="signed_position" value="" required /">'; }
            echo '</div>
        </div>
		<div class="form-group">
            <label class="col-md-3 control-label">Date</label>
            <div class="col-md-8">';
            	if ($area == 1) { echo '<input class="form-control" type="date" name="signed_date" value="'.$reviewed_date.'" required /">'; }
            	else if ($area == 2) { echo '<input class="form-control" type="date" name="signed_date" value="'.$approved_date.'" required /">'; }
            	else { echo '<input class="form-control" type="date" name="signed_date" value="'.date('Y-m-d').'" required /">'; }
            echo '</div>
        </div>';
	}
	if( isset($_GET['modalInt_FFVA']) ) {
		$id = $_GET['modalInt_FFVA'];
		$type = $_GET['type'];
		$tab = $_GET['tab'];

		if (!empty($_COOKIE['switchAccount'])) {
			$portal_user = $_COOKIE['ID'];
			$user_id = $_COOKIE['switchAccount'];
		}
		else {
			$portal_user = $_COOKIE['ID'];
			$user_id = employerID($portal_user);
		}
		$employeeID = employeeID($portal_user);

		$result = mysqli_query( $conn,"SELECT * FROM tbl_ffva WHERE ID = $id" );
        if ( mysqli_num_rows($result) > 0 ) {
        	$row = mysqli_fetch_array($result);
        	if ($type == 1) {
	        	$int_assigned = $row['int_review_assigned'];
	        	$int_status = $row['int_review_status'];
	        	$int_comment = $row['int_review_comment'];
	        	$int_assigned2 = $row['int_verify_assigned'];
        	} else {
	        	$int_assigned = $row['int_verify_assigned'];
	        	$int_status = $row['int_verify_status'];
	        	$int_comment = $row['int_verify_comment'];
        	}

			echo '<input type="hidden" value="'.$id.'" name="ID" />
			<input type="hidden" value="'.$type.'" name="type" />
			<input type="hidden" value="'.$tab.'" name="tab" />
			<div class="form-group">
	            <label class="col-md-3 control-label">Assigned User</label>
	            <div class="col-md-8">
	                <select class="form-control mt-multiselect btn btn-default" name="assigned_to_id">
	                    <option value="">Select</option>';

	                    $selectEmployee = mysqli_query( $conn,"SELECT * from tbl_hr_employee WHERE user_id = 34 AND suspended = 0 AND status = 1 ORDER BY first_name" );
						if ( mysqli_num_rows($selectEmployee) > 0 ) {
							while($rowEmployee = mysqli_fetch_array($selectEmployee)) {
						        $employee_id = $rowEmployee['ID'];
					            $employee_userFName = $rowEmployee['first_name'];
					            $employee_userLName = $rowEmployee['last_name'];

						        echo '<option value="'.$employee_id.'" '; echo $int_assigned == $employee_id ? 'SELECTED':''; echo '>'.$employee_userFName.' '.$employee_userLName.'</option>';
						    }
						}

	                echo '</select>
	            </div>
	        </div>
	        <div class="form-group">
	            <label class="col-md-3 control-label">Status</label>
	            <div class="col-md-8">
	                <select class="form-control" name="status" onchange="selStatus(this.value)">
	                    <option value="">Select</option>
	                    <option value="1" '; echo $int_status == 1 ? 'SELECTED':''; echo '>Accept</option>
	                    <option value="2" '; echo $int_status == 2 ? 'SELECTED':''; echo '>Reject</option>
	                </select>
	            </div>
	        </div>
	        <div class="form-group intComment '; echo $int_status == 2 ? '':'hide'; echo '">
	            <label class="col-md-3 control-label">Comment</label>
	            <div class="col-md-8">
	                <textarea class="form-control" name="comment">'.$int_comment.'</textarea>
	            </div>
	        </div>';

	        if ($type == 1) {
				echo '<div class="form-group intVerify '; echo $int_status == 1 ? '':'hide'; echo '">
		            <label class="col-md-3 control-label">Assigned Internal Verifier</label>
		            <div class="col-md-8">
		                <select class="form-control mt-multiselect btn btn-default" name="assigned_to_id2" >
		                    <option value="">Select</option>';

		                    $selectEmployee = mysqli_query( $conn,"SELECT * from tbl_hr_employee WHERE user_id = 34 AND suspended = 0 AND status = 1 ORDER BY first_name" );
							if ( mysqli_num_rows($selectEmployee) > 0 ) {
								while($rowEmployee = mysqli_fetch_array($selectEmployee)) {
							        $employee_id = $rowEmployee['ID'];
						            $employee_userFName = $rowEmployee['first_name'];
						            $employee_userLName = $rowEmployee['last_name'];

							        echo '<option value="'.$employee_id.'" '; echo $int_assigned2 == $employee_id ? 'SELECTED':''; echo '>'.$employee_userFName.' '.$employee_userLName.'</option>';
							    }
							}

		                echo '</select>
		            </div>
		        </div>';
		    }
	    }
	}
	if( isset($_GET['modalNewKatva_FFVA']) ) {
		$modal = $_GET['modalNewKatva_FFVA'];

		if (!empty($_COOKIE['switchAccount'])) {
			$portal_user = $_COOKIE['ID'];
			$user_id = $_COOKIE['switchAccount'];
		}
		else {
			$portal_user = $_COOKIE['ID'];
			$user_id = employerID($portal_user);
		}

		// Override arnel signature into SPI if match
		if ($user_id == 250) {
			$arnel_signature = $arnel_signature_spi;
		}

		echo '<input type="hidden" value="'.$modal.'" name="modal" />
		<div class="form-group">
            <label class="col-md-1 control-label">Product</label>
            <div class="col-md-5">
            	<input type="text" class="form-control" name="product" required />
            </div>
        </div>
		<div class="form-group">
            <label class="col-md-1 control-label">Facility Name</label>
            <div class="col-md-5">
            	<input type="text" class="form-control" name="facility" required />
            </div>
        </div>
		<div class="form-group">
            <label class="col-md-1 control-label">Address</label>
            <div class="col-md-5">
            	<input type="text" class="form-control" name="address" required />
            </div>
        </div>

        <div class="table-scrollable">
            <table class="table table-bordered table-hover" id="tableDataKatva_1">
                <thead>
                    <tr>
                        <th>Process Step</th>
                        <th>Process Description</th>
                        <th>Vulnerability Assessment Method</th>
                        <th>Explanation</th>
                        <th>Actionable Process Step</th>
                        <th>Mitigation Strategies</th>
                        <th class="text-center">Action</th>
                    </tr>
                </thead>
                <tbody></tbody>
                <tfoot>
					<tr>
						<td><textarea class="form-control katva_step" placeholder="Enter process step here"></textarea></td>
						<td><textarea class="form-control katva_description" placeholder="Enter description here"></textarea></td>
						<td>
							<select class="form-control katva_vulnerability" onchange="selectVulnerability(1, this)">
								<option value="0">Key Activity Types</option>
								<option value="1">Other</option>
							</select>
							<textarea class="form-control margin-top-15 hide katva_vulnerability_other" placeholder="Enter vulnerability assessment here"></textarea>
						</td>
						<td>
							<select class="form-control katva_explanation" onchange="selectExplanation(1, this)">
								<option value="0">No</option>
								<option value="1">Yes</option>
							</select>
							<select class="form-control margin-top-15 hide katva_explanation_option">
								<option value="">Select</option>
								<option value="1">Bulk Liquid Receiving and Loading</option>
								<option value="2">Liquid Storage and Handling</option>
								<option value="3">Secondary Ingredient Handling</option>
								<option value="4">Mixing and Similar Activities</option>
							</select>
							<textarea class="form-control margin-top-15 hide katva_explanation_comment" placeholder="Enter explanation here"></textarea>
						</td>
						<td><textarea class="form-control katva_actionable" placeholder="Enter actionable process step here"></textarea></td>
						<td><textarea class="form-control katva_mitigation" placeholder="Enter mitigation strategies here"></textarea></td>
						<td class="text-center"><a href="javascript:;" class="btn btn-success btn-circle" onclick="btnAddKatva(1)">Add</a></td>
					</tr>
                </tfoot>
            </table>
        </div>

        <div class="row text-center margin-top-40" style="display: flex; align-items: end;">
        	<div class="col-md-4">
        		<div class="signatureContainer">
        			<div class="form-group">
			            <label class="col-md-3 control-label">Signature</label>
			            <div class="col-md-5">
			            	<select class="form-control margin-bottom-15" onchange="selectType(this)" name="prepared_type">
			            		<option value="">Select</option>
			            		<option value="1">Sign</option>
			            		<option value="2">Upload</option>
			            	</select>
			            </div>
			        </div>
	                <input type="hidden" name="prepared_signature_default_temp" value="'.$arnel_signature.'" />
	                <img class="img img-fluid sign signature_default" src="'.$arnel_signature.'" />
	                <input type="file" class="form-control hide sign signature_upload" name="prepared_file" />
	                <div class="hide sign signature_sign">
	                	<input type="button" class="btn btn-danger btnClear" onclick="btnClear(this)" value="Clear" />
	                	<div class="signature prepared_signature"></div>
	                </div>
                </div>
        		<div class="row">
        			<div class="col-md-offset-2 col-md-4">
		                <input type="hidden" name="prepared_by" value="35" />
		                <label class="control-label">Arnel Ryan</label>
        			</div>
        			<div class="col-md-4">
		                <input type="date" class="form-control" name="prepared_date" value="'.date('Y-m-d').'" />
        			</div>
        		</div>
        		<hr class="margin-top-10" style="border: 1px solid; width: 80%; margin: auto;">
        		Prepared By
        	</div>
        	<div class="col-md-4">
        		<div class="signatureContainer">
        			<div class="form-group">
			            <label class="col-md-3 control-label">Signature</label>
			            <div class="col-md-5">
			            	<select class="form-control margin-bottom-15" onchange="selectType(this)" name="reviewed_type">
			            		<option value="">Select</option>
			            		<option value="1">Sign</option>
			            		<option value="2">Upload</option>
			            	</select>
			            </div>
			        </div>
	                <input type="hidden" name="reviewed_signature_default_temp" value="'.$empty_signature.'" />
	                <img class="img img-fluid sign signature_default" src="'.$empty_signature.'" />
	                <input type="file" class="form-control margin-bottom-15 hide sign signature_upload" name="reviewed_file" />
	                <div class="hide sign signature_sign">
	                	<input type="button" class="btn btn-danger btnClear" onclick="btnClear(this)" value="Clear" />
	                	<div class="signature reviewed_signature"></div>
	                </div>
                </div>
        		<div class="row">
        			<div class="col-md-offset-2 col-md-4">
		            	<select class="form-control mt-multiselect" name="reviewed_by">
		            		<option value="">Select Reviewer</option>';

							$selectEmployee = mysqli_query( $conn,"SELECT * from tbl_hr_employee WHERE user_id = $user_id AND suspended = 0 AND status = 1" );
							if ( mysqli_num_rows($selectEmployee) > 0 ) {
								while($rowEmployee = mysqli_fetch_array($selectEmployee)) {
							        $employee_id = $rowEmployee['ID'];
						            $employee_name = $rowEmployee['first_name'] .' '. $rowEmployee['last_name'];
							        
							        echo '<option value="'.$employee_id.'">'.$employee_name.'</option>';
							    }
							}
		            	echo '</select>
        			</div>
        			<div class="col-md-4">
                		<input type="date" class="form-control" name="reviewed_date" min="'.date('Y-m-d').'" />
        			</div>
        		</div>
        		<hr class="margin-top-10" style="border: 1px solid; width: 80%; margin: auto;">
        		Reviewed By
        	</div>
        	<div class="col-md-4">
        		<div class="signatureContainer">
        			<div class="form-group">
			            <label class="col-md-3 control-label">Signature</label>
			            <div class="col-md-5">
			            	<select class="form-control margin-bottom-15" onchange="selectType(this)" name="approved_type">
			            		<option value="">Select</option>
			            		<option value="1">Sign</option>
			            		<option value="2">Upload</option>
			            	</select>
			            </div>
			        </div>
	                <input type="hidden" name="approved_signature_default_temp" value="'.$empty_signature.'" />
	                <img class="img img-fluid sign signature_default" src="'.$empty_signature.'" />
	                <input type="file" class="form-control margin-bottom-15 hide sign signature_upload" name="approved_file" />
	                <div class="hide sign signature_sign">
	                	<input type="button" class="btn btn-danger btnClear" onclick="btnClear(this)" value="Clear" />
	                	<div class="signature approved_signature"></div>
	                </div>
                </div>
        		<div class="row">
        			<div class="col-md-offset-2 col-md-4">
		            	<select class="form-control mt-multiselect" name="approved_by">
		            		<option value="">Select Reviewer</option>';

							$selectEmployee = mysqli_query( $conn,"SELECT * from tbl_hr_employee WHERE user_id = $user_id AND suspended = 0 AND status = 1" );
							if ( mysqli_num_rows($selectEmployee) > 0 ) {
								while($rowEmployee = mysqli_fetch_array($selectEmployee)) {
							        $employee_id = $rowEmployee['ID'];
						            $employee_name = $rowEmployee['first_name'] .' '. $rowEmployee['last_name'];
							        
							        echo '<option value="'.$employee_id.'">'.$employee_name.'</option>';
							    }
							}
		            	echo '</select>
        			</div>
        			<div class=" col-md-4">
		                <input type="date" class="form-control" name="approved_date" min="'.date('Y-m-d').'" />
        			</div>
        		</div>
        		<hr class="margin-top-10" style="border: 1px solid; width: 80%; margin: auto;">
        		Approved By
        	</div>
        </div>';
	}
	if( isset($_GET['modalViewKatva_FFVA']) ) {
		$id = $_GET['modalViewKatva_FFVA'];

		if (!empty($_COOKIE['switchAccount'])) {
			$portal_user = $_COOKIE['ID'];
			$user_id = $_COOKIE['switchAccount'];
		}
		else {
			$portal_user = $_COOKIE['ID'];
			$user_id = employerID($portal_user);
		}

		// Override arnel signature into SPI if match
		if ($user_id == 250) {
			$arnel_signature = $arnel_signature_spi;
		}

		$result = mysqli_query( $conn,"SELECT * FROM tbl_ffva_katva WHERE ID = $id" );
        if ( mysqli_num_rows($result) > 0 ) {
        	$row = mysqli_fetch_array($result);
        	$product = $row["product"];
        	$facility = $row["facility"];
        	$address = $row["address"];

        	$prepared_by = $row["prepared_by"];
        	$prepared_signature = $row["prepared_signature"];
        	$prepared_date = $row["prepared_date"];

        	$reviewed_by = $row["reviewed_by"];
        	$reviewed_signature = $row["reviewed_signature"];
        	$reviewed_date = $row["reviewed_date"];

        	$approved_by = $row["approved_by"];
        	$approved_signature = $row["approved_signature"];
        	$approved_date = $row["approved_date"];
        }

		echo '<input type="hidden" value="'.$id.'" name="ID" />
		<div class="form-group">
            <label class="col-md-1 control-label">Product</label>
            <div class="col-md-5">
            	<input type="text" class="form-control" name="product" value="'.$product.'" required />
            </div>
        </div>
		<div class="form-group">
            <label class="col-md-1 control-label">Facility Name</label>
            <div class="col-md-5">
            	<input type="text" class="form-control" name="facility" value="'.$facility.'" required />
            </div>
        </div>
		<div class="form-group">
            <label class="col-md-1 control-label">Address</label>
            <div class="col-md-5">
            	<input type="text" class="form-control" name="address" value="'.$address.'" required />
            </div>
        </div>

        <div class="table-scrollable">
            <table class="table table-bordered table-hover" id="tableDataKatva_2">
                <thead>
                    <tr>
                        <th>Process Step</th>
                        <th>Process Description</th>
                        <th>Vulnerability Assessment Method</th>
                        <th>Explanation</th>
                        <th>Actionable Process Step</th>
                        <th>Mitigation Strategies</th>
                        <th class="text-center">Action</th>
                    </tr>
                </thead>
                <tbody>';

                	if (!empty($row["step"])) {
		            	$step = explode(' | ', $row["step"]);
		            	$description = explode(' | ', $row["description"]);
		            	$vulnerability_id = explode(' | ', $row["vulnerability_id"]);
		            	$vulnerability_text = explode(' | ', $row["vulnerability_text"]);
		            	$explanation_id = explode(' | ', $row["explanation_id"]);
		            	$explanation_option = explode(' | ', $row["explanation_option"]);
		            	$explanation_comment = explode(' | ', $row["explanation_comment"]);
		            	$actionable = explode(' | ', $row["actionable"]);
		            	$mitigation = explode(' | ', $row["mitigation"]);

						$index = 0;
		            	foreach ($step as $value) {

		                    echo '<tr class="tr_'.$index.'">
		                    	<td><textarea class="form-control" placeholder="Enter process step here" name="katva_step_2[]" required>'.$value.'</textarea></td>
		                        <td><textarea class="form-control" placeholder="Enter description here" name="katva_description_2[]" require>'.$description[$index].'</textarea></td>

		                        <td>
		                            <select class="form-control" onchange="selectVulnerability(2, this)" name="katva_vulnerability_2[]">
		                                <option value="0" '; echo $vulnerability_id[$index] == 0 ? 'SELECTED':''; echo '>Key Activity Types</option>
		                                <option value="1" '; echo $vulnerability_id[$index] == 1 ? 'SELECTED':''; echo '>Other</option>
		                            </select>
		                            <textarea class="form-control margin-top-15 '; echo $vulnerability_id[$index] == 0 ? 'hide':''; echo '" placeholder="Enter vulnerability assessment here" name="katva_vulnerability_text_2[]">'.$vulnerability_text[$index].'</textarea>
		                        </td>
		                        <td>
		                            <select class="form-control" onchange="selectExplanation(2, this)" name="katva_explanation_2[]">
		                                <option value="0" '; echo $explanation_id[$index] == 0 ? 'SELECTED':''; echo '>No</option>
		                                <option value="1" '; echo $explanation_id[$index] == 1 ? 'SELECTED':''; echo '>Yes</option>
		                            </select>
		                            <select class="form-control margin-top-15 '; echo $explanation_id[$index] == 0 ? 'hide':''; echo '" name="katva_explanation_option_2[]">
		                                <option value="">Select</option>
		                                <option value="1" '; echo $explanation_option[$index] == 1 ? 'SELECTED':''; echo '>Bulk Liquid Receiving and Loading</option>
		                                <option value="2" '; echo $explanation_option[$index] == 2 ? 'SELECTED':''; echo '>Liquid Storage and Handling</option>
		                                <option value="3" '; echo $explanation_option[$index] == 3 ? 'SELECTED':''; echo '>Secondary Ingredient Handling</option>
		                                <option value="4" '; echo $explanation_option[$index] == 4 ? 'SELECTED':''; echo '>Mixing and Similar Activities</option>
		                            </select>
		                            <textarea class="form-control margin-top-15 '; echo $explanation_id[$index] == 0 ? 'hide':''; echo '" placeholder="Enter explanation here" name="katva_explanation_comment_2[]">'.$explanation_comment[$index].'</textarea>
		                        </td>

		                        <td><textarea class="form-control" placeholder="Enter actionable process step here" name="katva_actionable_2[]" required>'.$actionable[$index].'</textarea></td>
		                        <td><textarea class="form-control" placeholder="Enter mitigation strategies here" name="katva_mitigation_2[]" required>'.$mitigation[$index].'</textarea></td>
		                        <td class="text-center"><a href="javascript:;" class="btn btn-danger btn-circle" onclick="btnRemoveKatva(2, '.$index.')">Remove</a></td>
		                    </tr>';
		            		$index++;
		            	}
                	}

                echo '</tbody>
                <tfoot>
					<tr>
						<td><textarea class="form-control katva_step" placeholder="Enter process step here"></textarea></td>
						<td><textarea class="form-control katva_description" placeholder="Enter description here"></textarea></td>
						<td>
							<select class="form-control katva_vulnerability" onchange="selectVulnerability(2, this)">
								<option value="0">Key Activity Types</option>
								<option value="1">Other</option>
							</select>
							<textarea class="form-control margin-top-15 hide katva_vulnerability_other" placeholder="Enter vulnerability assessment here"></textarea>
						</td>
						<td>
							<select class="form-control katva_explanation" onchange="selectExplanation(2, this)">
								<option value="0">No</option>
								<option value="1">Yes</option>
							</select>
							<select class="form-control margin-top-15 hide katva_explanation_option">
								<option value="">Select</option>
								<option value="1">Bulk Liquid Receiving and Loading</option>
								<option value="2">Liquid Storage and Handling</option>
								<option value="3">Secondary Ingredient Handling</option>
								<option value="4">Mixing and Similar Activities</option>
							</select>
							<textarea class="form-control margin-top-15 hide katva_explanation_comment" placeholder="Enter explanation here"></textarea>
						</td>
						<td><textarea class="form-control katva_actionable" placeholder="Enter actionable process step here"></textarea></td>
						<td><textarea class="form-control katva_mitigation" placeholder="Enter mitigation strategies here"></textarea></td>
						<td class="text-center"><a href="javascript:;" class="btn btn-success btn-circle" onclick="btnAddKatva(2)">Add</a></td>
					</tr>
                </tfoot>
            </table>
        </div>

        <div class="row text-center margin-top-40" style="display: flex; align-items: end;">
        	<div class="col-md-4">
        		<div class="signatureContainer hide">
        			<div class="form-group">
			            <label class="col-md-3 control-label">Signature</label>
			            <div class="col-md-5">
			            	<select class="form-control margin-bottom-15" onchange="selectType(this)" name="prepared_type">
			            		<option value="">Select</option>
			            		<option value="1">Sign</option>
			            		<option value="2">Upload</option>
			            	</select>
			            </div>
			        </div>
	                <input type="hidden" name="prepared_signature_default_temp" value="'.$arnel_signature.'" />
	                <img class="img img-fluid sign signature_default" src="'.$arnel_signature.'" />
	                <input type="file" class="form-control hide sign signature_upload" name="prepared_file" />
	                <div class="hide sign signature_sign">
	                	<input type="button" class="btn btn-danger btnClear" onclick="btnClear(this)" value="Clear" />
	                	<div class="signature prepared_signature"></div>
	                </div>
                </div>
                <div class="signatureResult">
                	<button type="button" class="btn btn-link btn-sm" onclick="editSignature(this)"><i class="fa fa-pencil"></i> [edit signature]</button>
                	<img src="'.$prepared_signature.'" class="signature_img" style="display: block; border: 0;"/>
                	<input type="hidden" name="prepared_signature_temp" value="'.$prepared_signature.'" />
                </div>
        		<div class="row">
        			<div class="col-md-offset-2 col-md-4">
		                <input type="hidden" name="prepared_by" value="'.$prepared_by.'" />
		                <label class="control-label">Arnel Ryan</label>
        			</div>
        			<div class="col-md-4">
		                <input type="date" class="form-control" name="prepared_date" value="'.$prepared_date.'" />
        			</div>
        		</div>
        		<hr class="margin-top-10" style="border: 1px solid; width: 80%; margin: auto;">
        		Prepared By
        	</div>
        	<div class="col-md-4">
        		<div class="signatureContainer hide">
        			<div class="form-group">
			            <label class="col-md-3 control-label">Signature</label>
			            <div class="col-md-5">
			            	<select class="form-control margin-bottom-15" onchange="selectType(this)" name="reviewed_type">
			            		<option value="">Select</option>
			            		<option value="1">Sign</option>
			            		<option value="2">Upload</option>
			            	</select>
			            </div>
			        </div>
	                <input type="hidden" name="reviewed_signature_default_temp" value="'.$reviewed_signature.'" />
	                <img class="img img-fluid sign signature_default" src="'.$reviewed_signature.'" />
	                <input type="file" class="form-control hide sign signature_upload" name="reviewed_file" />
	                <div class="hide sign signature_sign">
	                	<input type="button" class="btn btn-danger btnClear" onclick="btnClear(this)" value="Clear" />
	                	<div class="signature reviewed_signature"></div>
	                </div>
                </div>
                <div class="signatureResult">
                	<button type="button" class="btn btn-link btn-sm" onclick="editSignature(this)"><i class="fa fa-pencil"></i> [edit signature]</button>
                	<img src="'.$reviewed_signature.'" class="signature_img" style="display: block; border: 0; border-bottom: 1px solid; object-fit: contain;"/>
                	<input type="hidden" name="reviewed_signature_temp" value="'.$reviewed_signature.'" />
                </div>
        		<div class="row">
        			<div class="col-md-offset-2 col-md-4">
		            	<select class="form-control mt-multiselect" name="reviewed_by">
		            		<option value="">Select Reviewer</option>';

							$selectEmployee = mysqli_query( $conn,"SELECT * from tbl_hr_employee WHERE user_id = $user_id AND suspended = 0 AND status = 1" );
							if ( mysqli_num_rows($selectEmployee) > 0 ) {
								while($rowEmployee = mysqli_fetch_array($selectEmployee)) {
							        $employee_id = $rowEmployee['ID'];
						            $employee_name = $rowEmployee['first_name'] .' '. $rowEmployee['last_name'];
							        
							        echo '<option value="'.$employee_id.'" '; echo $reviewed_by == $employee_id ? 'SELECTED':''; echo '>'.$employee_name.'</option>';
							    }
							}
		            	echo '</select>
        			</div>
        			<div class="col-md-4">
                		<input type="date" class="form-control" name="reviewed_date" min="'.date('Y-m-d').'" value="'.$reviewed_date.'" />
        			</div>
        		</div>
        		<hr class="margin-top-10" style="border: 1px solid; width: 80%; margin: auto;">
        		Reviewed By
        	</div>
        	<div class="col-md-4">
        		<div class="signatureContainer hide">
        			<div class="form-group">
			            <label class="col-md-3 control-label">Signature</label>
			            <div class="col-md-5">
			            	<select class="form-control margin-bottom-15" onchange="selectType(this)" name="approved_type">
			            		<option value="">Select</option>
			            		<option value="1">Sign</option>
			            		<option value="2">Upload</option>
			            	</select>
			            </div>
			        </div>
	                <input type="hidden" name="approved_signature_default_temp" value="'.$approved_signature.'" />
	                <img class="img img-fluid sign signature_default" src="'.$approved_signature.'" />
	                <input type="file" class="form-control hide sign signature_upload" name="approved_file" />
	                <div class="hide sign signature_sign">
	                	<input type="button" class="btn btn-danger btnClear" onclick="btnClear(this)" value="Clear" />
	                	<div class="signature approved_signature"></div>
	                </div>
                </div>
                <div class="signatureResult">
                	<button type="button" class="btn btn-link btn-sm" onclick="editSignature(this)"><i class="fa fa-pencil"></i> [edit signature]</button>
                	<img src="'.$approved_signature.'" class="signature_img" style="display: block; border: 0; border-bottom: 1px solid; object-fit: contain;"/>
                	<input type="hidden" name="approved_signature_temp" value="'.$approved_signature.'" />
                </div>
        		<div class="row">
        			<div class="col-md-offset-2 col-md-4">
		            	<select class="form-control mt-multiselect" name="approved_by">
		            		<option value="">Select Reviewer</option>';

							$selectEmployee = mysqli_query( $conn,"SELECT * from tbl_hr_employee WHERE user_id = $user_id AND suspended = 0 AND status = 1" );
							if ( mysqli_num_rows($selectEmployee) > 0 ) {
								while($rowEmployee = mysqli_fetch_array($selectEmployee)) {
							        $employee_id = $rowEmployee['ID'];
						            $employee_name = $rowEmployee['first_name'] .' '. $rowEmployee['last_name'];
							        
							        echo '<option value="'.$employee_id.'" '; echo $approved_by == $employee_id ? 'SELECTED':''; echo '>'.$employee_name.'</option>';
							    }
							}
		            	echo '</select>
        			</div>
        			<div class=" col-md-4">
		                <input type="date" class="form-control" name="approved_date" min="'.date('Y-m-d').'" value="'.$approved_date.'" />
        			</div>
        		</div>
        		<hr class="margin-top-10" style="border: 1px solid; width: 80%; margin: auto;">
        		Approved By
        	</div>
        </div>';
	}
	if( isset($_GET['btnDelete_FFVA']) ) {
		$id = $_GET['btnDelete_FFVA'];
		$reason = addslashes($_GET['reason']);
    	$current_userID = $_COOKIE['ID'];

        $message = array();
		array_push($message, $current_userID);
		array_push($message, $reason);
		$message = implode(" | ",$message);

		mysqli_query( $conn,"UPDATE tbl_ffva SET deleted = 1, reason = '". $message ."' WHERE ID='". $id ."'" );
	}
	if( isset($_GET['btnArchive_FFVA']) ) {
		$id = $_GET['btnArchive_FFVA'];

		mysqli_query( $conn,"UPDATE tbl_ffva SET archived = 1 WHERE ID = $id" );
	}
	if( isset($_GET['btnRevert_FFVA']) ) {
		$id = $_GET['btnRevert_FFVA'];

		mysqli_query( $conn,"UPDATE tbl_ffva SET archived = 0 WHERE ID = $id" );
	}
	if( isset($_GET['btnTemplate_FFVA']) ) {
		$ID = $_GET['btnTemplate_FFVA'];
		$tab = $_GET['tab'];
		$last_modified = date('Y-m-d');

		if (!empty($_COOKIE['switchAccount'])) {
			$portal_user = $_COOKIE['ID'];
			$user_id = $_COOKIE['switchAccount'];
		}
		else {
			$portal_user = $_COOKIE['ID'];
			$user_id = employerID($portal_user);
		}

		$selectData = mysqli_query( $conn,"SELECT * FROM tbl_ffva WHERE archived = 1 AND deleted = 0 AND ID = $ID");
        if ( mysqli_num_rows($selectData) > 0 ) {
            $row = mysqli_fetch_array($selectData);
        	$new_ID = $row["ID"];
        	$new_company = $row["company"] .' Draft';
        	$new_product = $row["product"] .' Draft';

        	// CLONING
        	$sql = "INSERT INTO tbl_ffva (user_id, portal_user, type, files, company, website, headquarters, telephone, email, person, product, assessment, category_id, category_other, industry_id, industry_other, code, likelihood_answer, likelihood_comment, likelihood_file, likelihood_rate, likelihood_element_other, likelihood_question_other, likelihood_answer_other, likelihood_comment_other, likelihood_file_other, likelihood_rate_other, likelihood_comment_summary, likelihood_note, consequence_answer, consequence_comment, consequence_file, consequence_rate, consequence_element_other, consequence_question_other, consequence_answer_other, consequence_comment_other, consequence_file_other, consequence_rate_other, consequence_comment_summary, consequence_note, prevention, prevention_other, detection, detection_other, mitigation, mitigation_other, prepared_by, prepared_signature, prepared_position, prepared_date, last_modified)
			SELECT user_id, portal_user, type, files, company, website, headquarters, telephone, email, person, product, assessment, category_id, category_other, industry_id, industry_other, code, likelihood_answer, likelihood_comment, likelihood_file, likelihood_rate, likelihood_element_other, likelihood_question_other, likelihood_answer_other, likelihood_comment_other, likelihood_file_other, likelihood_rate_other, likelihood_comment_summary, likelihood_note, consequence_answer, consequence_comment, consequence_file, consequence_rate, consequence_element_other, consequence_question_other, consequence_answer_other, consequence_comment_other, consequence_file_other, consequence_rate_other, consequence_comment_summary, consequence_note, prevention, prevention_other, detection, detection_other, mitigation, mitigation_other, prepared_by, prepared_signature, prepared_position, prepared_date, '$last_modified'
			FROM tbl_ffva
			WHERE ID = $new_ID";

			if (mysqli_query($conn, $sql)) {
				$new_last_id = mysqli_insert_id($conn);

				$selectData = mysqli_query( $conn,"SELECT * FROM tbl_ffva WHERE ID = $new_last_id" );
				if ( mysqli_num_rows($selectData) > 0 ) {
					$rowData = mysqli_fetch_array($selectData);
					$data_ID = $rowData['ID'];
					$data_company = $rowData['company'];
					if ($tab == 2) { $data_company = $rowData['product']; }

					$data_status = $rowData['status'];
                    $status = "Drafted";
                    // if (empty($int_review_assigned)) { $status = 'Drafted'; }
                    if (!empty($rowData['int_review_assigned']) AND $rowData['int_review_status'] == 1) { $status = 'Reviewed'; }
                    if (!empty($rowData['int_review_assigned']) AND $rowData['int_review_status'] == 1 AND !empty($rowData['int_verify_assigned']) AND $rowData['int_verify_status'] == 1) { $status = 'Approved by CIG'; }
                    if (!empty($rowData['int_review_assigned']) AND $rowData['int_review_status'] == 1 AND !empty($rowData['int_verify_assigned']) AND $rowData['int_verify_status'] == 1 AND !empty($rowData['approved_date'])) { $status = "Approved by Client"; }

					$data_last_modified = $rowData['last_modified'];
	                $data_last_modified = new DateTime($data_last_modified);
	                $data_last_modified = $data_last_modified->format('M d, Y');
	                                                        
	                $due_date = date('Y-m-d', strtotime('+1 year', strtotime($data_last_modified)) );
	                $due_date = new DateTime($due_date);
	                $due_date = $due_date->format('M d, Y');

	                $likelihood_rate = $rowData["likelihood_rate"];
	                $likelihood_rate_arr = explode(', ', $likelihood_rate);

	                $consequence_rate = $rowData["consequence_rate"];
	                $consequence_rate_arr = explode(', ', $consequence_rate);

	                // Likelihood
	                $index = 0;
	                $count = 0;
	                $sum = 0;
	                $total_likelihood = 0;
	                $selectLikelihood = mysqli_query( $conn,"SELECT * FROM tbl_ffva_likelihood" );
	                if ( mysqli_num_rows($selectLikelihood) > 0 ) {
	                    while($rowLikelihood = mysqli_fetch_array($selectLikelihood)) {
	                        $likelihood_type_arr = explode(', ', $rowLikelihood["type"]);
	                        if (in_array($rowData["type"], $likelihood_type_arr)) {
	                            $sum += $likelihood_rate_arr[$index];
	                            $index++;
	                            $count++;
	                        }
	                    }
	                }

	                if (!empty($rowData["likelihood_element_other"])) {
	                    $likelihood_element_other = explode(' | ', $rowData["likelihood_element_other"]);
	                    $likelihood_rate_other = explode(', ', $rowData["likelihood_rate_other"]);

	                    $index = 0;
	                    foreach ($likelihood_element_other as $value) {
	                        $sum += $likelihood_rate_other[$index];
	                        $index++;
	                        $count++;
	                    }
	                }

	                $total_likelihood = $sum / $count;


	                // Consequence
	                $index = 0;
	                $count = 0;
	                $sum = 0;
	                $total_consequence = 0;
	                $selectConsequence = mysqli_query( $conn,"SELECT * FROM tbl_ffva_consequence" );
	                if ( mysqli_num_rows($selectConsequence) > 0 ) {
	                    while($rowConsequence = mysqli_fetch_array($selectConsequence)) {
	                        $sum += $consequence_rate_arr[$index];
	                        $index++;
	                        $count++;
	                    }
	                }

	                if (!empty($rowData["consequence_element_other"])) {
	                    $consequence_element_other = explode(' | ', $rowData["consequence_element_other"]);
	                    $consequence_rate_other = explode(', ', $rowData["consequence_rate_other"]);

	                    $index = 0;
	                    foreach ($consequence_element_other as $value) {
	                        $sum += $consequence_rate_other[$index];
	                        $index++;
	                        $count++;
	                    }
	                }

	                $total_consequence = $sum / $count;


	                // Matrix
	                $plot_x = 1;
	                $plot_y = 1;

		            if (round($total_likelihood) > 0) { $plot_x = round($total_likelihood); }
		            if (round($total_consequence) > 0) { $plot_y = round($total_consequence); }

	                if ($plot_x == 1 && $plot_y == 1) { $vulnerability = 1; }
	                else if ($plot_x == 1 && $plot_y == 2) { $vulnerability = 1; }
	                else if ($plot_x == 1 && $plot_y == 3) { $vulnerability = 1; }
	                else if ($plot_x == 1 && $plot_y == 4) { $vulnerability = 2; }
	                else if ($plot_x == 1 && $plot_y == 5) { $vulnerability = 2; }
	                else if ($plot_x == 2 && $plot_y == 1) { $vulnerability = 1; }
	                else if ($plot_x == 2 && $plot_y == 2) { $vulnerability = 1; }
	                else if ($plot_x == 2 && $plot_y == 3) { $vulnerability = 2; }
	                else if ($plot_x == 2 && $plot_y == 4) { $vulnerability = 2; }
	                else if ($plot_x == 2 && $plot_y == 5) { $vulnerability = 3; }
	                else if ($plot_x == 3 && $plot_y == 1) { $vulnerability = 2; }
	                else if ($plot_x == 3 && $plot_y == 2) { $vulnerability = 2; }
	                else if ($plot_x == 3 && $plot_y == 3) { $vulnerability = 2; }
	                else if ($plot_x == 3 && $plot_y == 4) { $vulnerability = 3; }
	                else if ($plot_x == 3 && $plot_y == 5) { $vulnerability = 3; }
	                else if ($plot_x == 4 && $plot_y == 1) { $vulnerability = 2; }
	                else if ($plot_x == 4 && $plot_y == 2) { $vulnerability = 2; }
	                else if ($plot_x == 4 && $plot_y == 3) { $vulnerability = 3; }
	                else if ($plot_x == 4 && $plot_y == 4) { $vulnerability = 3; }
	                else if ($plot_x == 4 && $plot_y == 5) { $vulnerability = 3; }
	                else if ($plot_x == 5 && $plot_y == 1) { $vulnerability = 3; }
	                else if ($plot_x == 5 && $plot_y == 2) { $vulnerability = 3; }
	                else if ($plot_x == 5 && $plot_y == 3) { $vulnerability = 3; }
	                else if ($plot_x == 5 && $plot_y == 4) { $vulnerability = 3; }
	                else if ($plot_x == 5 && $plot_y == 5) { $vulnerability = 3; }
	                else { $vulnerability = 0; }

                    if ($vulnerability == 1) { $vulnerability_result = '<span class="font-green-jungle bold">Low Risk</span>'; }
                    else if ($vulnerability == 2) { $vulnerability_result = '<span class="font-yellow-gold bold">Medium Risk</span>'; }
                    else if ($vulnerability == 3) { $vulnerability_result = '<span class="font-red-thunderbird bold">High Risk</span>'; }
	                else { $vulnerability_result = ""; }

					$output = array(
						"ID" => $data_ID,
						"company" => htmlentities($data_company),
						"status" => $status,
						"last_modified" => $data_last_modified,
						"vulnerability_result" => $vulnerability_result,
						"due_date" => $due_date,
						"tab" => $tab,
						"user_id" => $user_id
					);

					echo json_encode($output);
				}
			}
        }
	}
	if( isset($_POST['btnSave_FFVA']) ) {
		if (!empty($_COOKIE['switchAccount'])) {
			$portal_user = $_COOKIE['ID'];
			$user_id = $_COOKIE['switchAccount'];
		}
		else {
			$portal_user = $_COOKIE['ID'];
			$user_id = employerID($portal_user);
		}
		$path = 'uploads/ffva/';
		$random = rand(1000,1000000);

		$tab = $_POST['tab'];
		$last_modified = date('Y-m-d');
        $process = true;

		// Profile
		$company = addslashes($_POST['company']);
		$website = addslashes($_POST['website']);
		$headquarters = addslashes($_POST['headquarters']);
		$telephone = addslashes($_POST['telephone']);
		$email = addslashes($_POST['email']);
		$person = addslashes($_POST['person']);
		$product = addslashes($_POST['product']);
		$assessment = addslashes($_POST['assessment']);
		$category = $_POST['category'];
		$category_other = addslashes($_POST['category_other']);
		$industry = $_POST['industry'];
		$industry_other = addslashes($_POST['industry_other']);
		$code = addslashes($_POST['code']);
		$notification = $_POST['notification'];

		// Questionaire
		$likelihood_answer = "";
		$likelihood_answer_other = "";
		if (!empty($_POST['likelihood_answer'])) { 
			$likelihood_answer = $_POST['likelihood_answer'];
			$likelihood_answer = implode(', ', $likelihood_answer);
		}
		if (!empty($_POST['likelihood_answer_other'])) { 
			$likelihood_answer_other = $_POST['likelihood_answer_other'];
			$likelihood_answer_other = implode(', ', $likelihood_answer_other);
		}

		$likelihood_comment = "";
		$likelihood_comment_other = "";
		$likelihood_file_arr = array();
		$likelihood_file_other_arr = array();
		if (!empty($_POST['likelihood_comment'])) { 
            $likelihood_comment = $_POST['likelihood_comment'];
            $likelihood_comment = implode(' | ', $likelihood_comment);

            for ($i=0; $i < count($_POST["likelihood_comment"]); $i++) {
                $likelihood_file = addslashes($_FILES['likelihood_file']['name'][$i]);
                $file_docs_template = "";
                if (!empty($likelihood_file)) {
                    $filesize = $_FILES['likelihood_file']['size'][$i];
                    $tmp_docs = $_FILES['likelihood_file']['tmp_name'][$i];
                    $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                    $ext = strtolower(pathinfo($likelihood_file, PATHINFO_EXTENSION));
                    $file_docs_template = $random.' - '.$likelihood_file;
                    $path_docs = $path.stripcslashes($file_docs_template);

                    if(!in_array($ext, $invalid_extensions)) {
                        move_uploaded_file($tmp_docs,$path_docs);

                        $output = array (
                            'type'  =>  0,
                            'name' =>  $file_docs_template,
                            'size' =>  $filesize,
                            'date' =>  $local_date
                        );
                        array_push($arr_item, $output);
                    } else {
                        $process = false;
                    }
                }
                array_push($likelihood_file_arr, $file_docs_template);
            }
        }
        if (!empty($_POST['likelihood_comment_other'])) { 
            $likelihood_comment_other = $_POST['likelihood_comment_other'];
            $likelihood_comment_other = implode(' | ', $likelihood_comment_other);

            for ($i=0; $i < count($_POST["likelihood_comment_other"]); $i++) {
                $likelihood_file_other = addslashes($_FILES['likelihood_file_other']['name'][$i]);
                $file_docs_template = "";
                if (!empty($likelihood_file_other)) {
                    $filesize = $_FILES['likelihood_file_other']['size'][$i];
                    $tmp_docs = $_FILES['likelihood_file_other']['tmp_name'][$i];
                    $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                    $ext = strtolower(pathinfo($likelihood_file_other, PATHINFO_EXTENSION));
                    $file_docs_template = $random.' - '.$likelihood_file_other;
                    $path_docs = $path.stripcslashes($file_docs_template);

                    if(!in_array($ext, $invalid_extensions)) {
                        move_uploaded_file($tmp_docs,$path_docs);

                        $output = array (
                            'type'  =>  0,
                            'name' =>  $file_docs_template,
                            'size' =>  $filesize,
                            'date' =>  $local_date
                        );
                        array_push($arr_item, $output);
                    } else {
                        $process = false;
                    }
                }
                array_push($likelihood_file_other_arr, $file_docs_template);
            }
        }
		$likelihood_file_arr = implode(' | ', $likelihood_file_arr);
		$likelihood_file_other_arr = implode(' | ', $likelihood_file_other_arr);

		$likelihood_rate = "";
		$likelihood_rate_other = "";
		if (!empty($_POST['likelihood_rate'])) { 
			$likelihood_rate = $_POST['likelihood_rate'];
			$likelihood_rate = implode(', ', $likelihood_rate);
		}
		if (!empty($_POST['likelihood_rate_other'])) { 
			$likelihood_rate_other = $_POST['likelihood_rate_other'];
			$likelihood_rate_other = implode(', ', $likelihood_rate_other);
		}

		$likelihood_element_other = "";
		if (!empty($_POST['likelihood_element_other'])) { 
			$likelihood_element_other = $_POST['likelihood_element_other'];
			$likelihood_element_other = implode(' | ', $likelihood_element_other);
		}
		$likelihood_question_other = "";
		if (!empty($_POST['likelihood_question_other'])) { 
			$likelihood_question_other = $_POST['likelihood_question_other'];
			$likelihood_question_other = implode(' | ', $likelihood_question_other);
		}

		$likelihood_comment_summary = $_POST['likelihood_comment_summary'];
		$likelihood_note = $_POST['likelihood_note'];

		$consequence_answer = "";
		$consequence_answer_other = "";
		if (!empty($_POST['consequence_answer'])) { 
			$consequence_answer = $_POST['consequence_answer'];
			$consequence_answer = implode(', ', $consequence_answer);
		}
		if (!empty($_POST['consequence_answer_other'])) { 
			$consequence_answer_other = $_POST['consequence_answer_other'];
			$consequence_answer_other = implode(', ', $consequence_answer_other);
		}

		$consequence_comment = "";
		$consequence_comment_other = "";
		$consequence_file_arr = array();
		$consequence_file_other_arr = array();
		if (!empty($_POST['consequence_comment'])) { 
            $consequence_comment = $_POST['consequence_comment'];
            $consequence_comment = implode(' | ', $consequence_comment);

            for ($i=0; $i < count($_POST["consequence_comment"]); $i++) {
                $consequence_file = addslashes($_FILES['consequence_file']['name'][$i]);
                $file_docs_template = "";
                if (!empty($consequence_file)) {
                    $filesize = $_FILES['consequence_file']['size'][$i];
                    $tmp_docs = $_FILES['consequence_file']['tmp_name'][$i];
                    $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                    $ext = strtolower(pathinfo($consequence_file, PATHINFO_EXTENSION));
                    $file_docs_template = $random.' - '.$consequence_file;
                    $path_docs = $path.stripcslashes($file_docs_template);

                    if(!in_array($ext, $invalid_extensions)) {
                        move_uploaded_file($tmp_docs,$path_docs);

                        $output = array (
                            'type'  =>  0,
                            'name' =>  $file_docs_template,
                            'size' =>  $filesize,
                            'date' =>  $local_date
                        );
                        array_push($arr_item, $output);
                    } else {
                        $process = false;
                    }
                }
                array_push($consequence_file_arr, $file_docs_template);
            }
        }
        if (!empty($_POST['consequence_comment_other'])) { 
            $consequence_comment_other = $_POST['consequence_comment_other'];
            $consequence_comment_other = implode(' | ', $consequence_comment_other);

            for ($i=0; $i < count($_POST["consequence_comment_other"]); $i++) {
                $consequence_file_other = addslashes($_FILES['consequence_file_other']['name'][$i]);
                $file_docs_template = "";
                if (!empty($consequence_file_other)) {
                    $filesize = $_FILES['consequence_file_other']['size'][$i];
                    $tmp_docs = $_FILES['consequence_file_other']['tmp_name'][$i];
                    $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                    $ext = strtolower(pathinfo($consequence_file_other, PATHINFO_EXTENSION));
                    $file_docs_template = $random.' - '.$consequence_file_other;
                    $path_docs = $path.stripcslashes($file_docs_template);

                    if(!in_array($ext, $invalid_extensions)) {
                        move_uploaded_file($tmp_docs,$path_docs);

                        $output = array (
                            'type'  =>  0,
                            'name' =>  $file_docs_template,
                            'size' =>  $filesize,
                            'date' =>  $local_date
                        );
                        array_push($arr_item, $output);
                    } else {
                        $process = false;
                    }
                }
                array_push($consequence_file_other_arr, $file_docs_template);
            }
        }
		$consequence_file_arr = implode(' | ', $consequence_file_arr);
		$consequence_file_other_arr = implode(' | ', $consequence_file_other_arr);

		$consequence_rate = "";
		$consequence_rate_other = "";

        if ($process == true) {
    		if (!empty($_POST['consequence_rate'])) { 
    			$consequence_rate = $_POST['consequence_rate'];
    			$consequence_rate = implode(', ', $consequence_rate);
    		}
    		if (!empty($_POST['consequence_rate_other'])) { 
    			$consequence_rate_other = $_POST['consequence_rate_other'];
    			$consequence_rate_other = implode(', ', $consequence_rate_other);
    		}

    		$consequence_element_other = "";
    		if (!empty($_POST['consequence_element_other'])) { 
    			$consequence_element_other = $_POST['consequence_element_other'];
    			$consequence_element_other = implode(' | ', $consequence_element_other);
    		}
    		$consequence_question_other = "";
    		if (!empty($_POST['consequence_question_other'])) { 
    			$consequence_question_other = $_POST['consequence_question_other'];
    			$consequence_question_other = implode(' | ', $consequence_question_other);
    		}

    		$consequence_comment_summary = $_POST['consequence_comment_summary'];
    		$consequence_note = $_POST['consequence_note'];


    		// Activities
    		$prevention = "";
    		$prevention_other = "";
    		if (!empty($_POST['prevention'])) { 
    			$prevention = $_POST['prevention'];
    			$prevention = implode(', ', $prevention);
    		}
    		if (!empty($_POST['prevention_other'])) { 
    			$prevention_other = $_POST['prevention_other'];
    			$prevention_other = implode(', ', $prevention_other);
    		}

    		$detection = "";
    		$detection_other = "";
    		if (!empty($_POST['detection'])) { 
    			$detection = $_POST['detection'];
    			$detection = implode(', ', $detection);
    		}
    		if (!empty($_POST['detection_other'])) { 
    			$detection_other = $_POST['detection_other'];
    			$detection_other = implode(', ', $detection_other);
    		}
    		
    		$mitigation = "";
    		$mitigation_other = "";
    		if (!empty($_POST['mitigation'])) { 
    			$mitigation = $_POST['mitigation'];
    			$mitigation = implode(', ', $mitigation);
    		}
    		if (!empty($_POST['mitigation_other'])) { 
    			$mitigation_other = $_POST['mitigation_other'];
    			$mitigation_other = implode(', ', $mitigation_other);
    		}


    		// Assigned
    		$prepared_by = $_POST['prepared_by'];
    		$prepared_position = $_POST['prepared_position'];
    		$prepared_date = $_POST['prepared_date'];
    		$prepared_type = $_POST['prepared_type'];
    		$prepared_signature = $_POST['prepared_signature_default_temp'];
    		if ($prepared_type == 1) {
    			$prepared_signature = $_POST['prepared_sigData'];
    		} else if ($prepared_type == 2) {
    			$prepared_file = $_FILES['prepared_file']['name'];
    			if (!empty($prepared_file)) {
    				$base_tmp = $_FILES['prepared_file']['tmp_name'];
    				$base_type = pathinfo($base_tmp, PATHINFO_EXTENSION);
    				$base_data = file_get_contents($base_tmp);
    				$prepared_signature = 'data:image/png;base64,' . base64_encode($base_data);
    			}
    		}

    		$reviewed_by = $_POST['reviewed_by'];
    		$reviewed_position = $_POST['reviewed_position'];
    		$reviewed_date = $_POST['reviewed_date'];
    		$reviewed_type = $_POST['reviewed_type'];
    		$reviewed_signature = $_POST['reviewed_signature_default_temp'];
    		if ($reviewed_type == 1) {
    			$reviewed_signature = $_POST['reviewed_sigData'];
    		} else if ($reviewed_type == 2) {
    			$reviewed_file = $_FILES['reviewed_file']['name'];
    			if (!empty($reviewed_file)) {
    				$base_tmp = $_FILES['reviewed_file']['tmp_name'];
    				$base_type = pathinfo($base_tmp, PATHINFO_EXTENSION);
    				$base_data = file_get_contents($base_tmp);
    				$reviewed_signature = 'data:image/png;base64,' . base64_encode($base_data);
    			}
    		}

    		$approved_by = $_POST['approved_by'];
    		$approved_position = $_POST['approved_position'];
    		$approved_date = $_POST['approved_date'];
    		$approved_type = $_POST['approved_type'];
    		$approved_signature = $_POST['approved_signature_default_temp'];
    		if ($approved_type == 1) {
    			$approved_signature = $_POST['approved_sigData'];
    		} else if ($approved_type == 2) {
    			$approved_file = $_FILES['approved_file']['name'];
    			if (!empty($approved_file)) {
    				$base_tmp = $_FILES['approved_file']['tmp_name'];
    				$base_type = pathinfo($base_tmp, PATHINFO_EXTENSION);
    				$base_data = file_get_contents($base_tmp);
    				$approved_signature = 'data:image/png;base64,' . base64_encode($base_data);
    			}
    		}

    		$sql = "INSERT INTO tbl_ffva (user_id, portal_user, type, company, website, headquarters, telephone, email, person, product, assessment, category_id, category_other, industry_id, industry_other, code, notification, likelihood_answer, likelihood_comment, likelihood_file, likelihood_rate, likelihood_element_other, likelihood_question_other, likelihood_answer_other, likelihood_comment_other, likelihood_file_other, likelihood_rate_other, likelihood_comment_summary, likelihood_note, consequence_answer, consequence_comment, consequence_file, consequence_rate, consequence_element_other, consequence_question_other, consequence_answer_other, consequence_comment_other, consequence_file_other, consequence_rate_other, consequence_comment_summary, consequence_note, prevention, prevention_other, detection, detection_other, mitigation, mitigation_other, prepared_by, prepared_signature, prepared_position, prepared_date, reviewed_by, reviewed_signature, reviewed_position, reviewed_date, approved_by, approved_signature, approved_position, approved_date, last_modified, file_history)
            VALUES ('$user_id', '$portal_user', '$tab', '$company', '$website', '$headquarters', '$telephone', '$email', '$person', '$product', '$assessment', '$category', '$category_other', '$industry', '$industry_other', '$code', '$notification', '$likelihood_answer', '$likelihood_comment', '$likelihood_file_arr', '$likelihood_rate', '$likelihood_element_other', '$likelihood_question_other', '$likelihood_answer_other', '$likelihood_comment_other', '$likelihood_file_other_arr', '$likelihood_rate_other', '$likelihood_comment_summary', '$likelihood_note', '$consequence_answer', '$consequence_comment', '$consequence_file_arr', '$consequence_rate','$consequence_element_other', '$consequence_question_other', '$consequence_answer_other', '$consequence_comment_other', '$consequence_file_other_arr', '$consequence_rate_other', '$consequence_comment_summary', '$consequence_note', '$prevention', '$prevention_other', '$detection', '$detection_other', '$mitigation', '$mitigation_other', '$prepared_by', '$prepared_signature', '$prepared_position', '$prepared_date', '$reviewed_by', '$reviewed_signature', '$reviewed_position', '$reviewed_date', '$approved_by', '$approved_signature', '$approved_position', '$approved_date', '$last_modified', '$file_history')";
            if (mysqli_query($conn, $sql)) {
    			$last_id = mysqli_insert_id($conn);

    			$selectData = mysqli_query( $conn,'SELECT * FROM tbl_ffva WHERE user_id="'. $user_id .'" AND ID="'. $last_id .'" ORDER BY ID LIMIT 1' );
    			if ( mysqli_num_rows($selectData) > 0 ) {
    				$rowData = mysqli_fetch_array($selectData);
    				$data_ID = $rowData['ID'];
    				$data_int_review_status = $rowData['int_review_status'];
    				$data_int_verify_status = $rowData['int_verify_status'];
    				$data_company = $rowData['company'];
    				if ($tab == 2) { $data_company = $rowData['product']; }

    				$data_status = $rowData['status'];
                    $status = "Drafted";
                    // if (empty($int_review_assigned)) { $status = 'Drafted'; }
                    if (!empty($rowData['int_review_assigned']) AND $rowData['int_review_status'] == 1) { $status = 'Reviewed'; }
                    if (!empty($rowData['int_review_assigned']) AND $rowData['int_review_status'] == 1 AND !empty($rowData['int_verify_assigned']) AND $rowData['int_verify_status'] == 1) { $status = 'Approved by CIG'; }
                    if (!empty($rowData['int_review_assigned']) AND $rowData['int_review_status'] == 1 AND !empty($rowData['int_verify_assigned']) AND $rowData['int_verify_status'] == 1 AND !empty($rowData['approved_date'])) { $status = "Approved by Client"; }

    				$data_last_modified = $rowData['last_modified'];
                    $data_last_modified = new DateTime($data_last_modified);
                    $data_last_modified = $data_last_modified->format('M d, Y');
                                                            
                    $due_date = date('Y-m-d', strtotime('+1 year', strtotime($data_last_modified)) );
                    $due_date = new DateTime($due_date);
                    $due_date = $due_date->format('M d, Y');

                    $likelihood_rate = $rowData["likelihood_rate"];
                    $likelihood_rate_arr = explode(', ', $likelihood_rate);

                    $consequence_rate = $rowData["consequence_rate"];
                    $consequence_rate_arr = explode(', ', $consequence_rate);


                    // Likelihood
                    $index = 0;
                    $count = 0;
                    $sum = 0;
                    $total_likelihood = 0;
                    $selectLikelihood = mysqli_query( $conn,"SELECT * FROM tbl_ffva_likelihood" );
                    if ( mysqli_num_rows($selectLikelihood) > 0 ) {
                        while($rowLikelihood = mysqli_fetch_array($selectLikelihood)) {
                            $likelihood_type_arr = explode(', ', $rowLikelihood["type"]);
                            if (in_array($rowData["type"], $likelihood_type_arr)) {
                                $sum += $likelihood_rate_arr[$index];
                                $index++;
                                $count++;
                            }
                        }
                    }

                    if (!empty($rowData["likelihood_element_other"])) {
                        $likelihood_element_other = explode(' | ', $rowData["likelihood_element_other"]);
                        $likelihood_rate_other = explode(', ', $rowData["likelihood_rate_other"]);

                        $index = 0;
                        foreach ($likelihood_element_other as $value) {
                            $sum += $likelihood_rate_other[$index];
                            $index++;
                            $count++;
                        }
                    }

                    $total_likelihood = $sum / $count;


                    // Consequence
                    $index = 0;
                    $count = 0;
                    $sum = 0;
                    $total_consequence = 0;
                    $selectConsequence = mysqli_query( $conn,"SELECT * FROM tbl_ffva_consequence" );
                    if ( mysqli_num_rows($selectConsequence) > 0 ) {
                        while($rowConsequence = mysqli_fetch_array($selectConsequence)) {
                            $sum += $consequence_rate_arr[$index];
                            $index++;
                            $count++;
                        }
                    }

                    if (!empty($rowData["consequence_element_other"])) {
                        $consequence_element_other = explode(' | ', $rowData["consequence_element_other"]);
                        $consequence_rate_other = explode(', ', $rowData["consequence_rate_other"]);

                        $index = 0;
                        foreach ($consequence_element_other as $value) {
                            $sum += $consequence_rate_other[$index];
                            $index++;
                            $count++;
                        }
                    }

                    $total_consequence = $sum / $count;


                    // Matrix
                    $plot_x = 1;
                    $plot_y = 1;

    	            if (round($total_likelihood) > 0) { $plot_x = round($total_likelihood); }
    	            if (round($total_consequence) > 0) { $plot_y = round($total_consequence); }

                    if ($plot_x == 1 && $plot_y == 1) { $vulnerability = 1; }
                    else if ($plot_x == 1 && $plot_y == 2) { $vulnerability = 1; }
                    else if ($plot_x == 1 && $plot_y == 3) { $vulnerability = 1; }
                    else if ($plot_x == 1 && $plot_y == 4) { $vulnerability = 2; }
                    else if ($plot_x == 1 && $plot_y == 5) { $vulnerability = 2; }
                    else if ($plot_x == 2 && $plot_y == 1) { $vulnerability = 1; }
                    else if ($plot_x == 2 && $plot_y == 2) { $vulnerability = 1; }
                    else if ($plot_x == 2 && $plot_y == 3) { $vulnerability = 2; }
                    else if ($plot_x == 2 && $plot_y == 4) { $vulnerability = 2; }
                    else if ($plot_x == 2 && $plot_y == 5) { $vulnerability = 3; }
                    else if ($plot_x == 3 && $plot_y == 1) { $vulnerability = 2; }
                    else if ($plot_x == 3 && $plot_y == 2) { $vulnerability = 2; }
                    else if ($plot_x == 3 && $plot_y == 3) { $vulnerability = 2; }
                    else if ($plot_x == 3 && $plot_y == 4) { $vulnerability = 3; }
                    else if ($plot_x == 3 && $plot_y == 5) { $vulnerability = 3; }
                    else if ($plot_x == 4 && $plot_y == 1) { $vulnerability = 2; }
                    else if ($plot_x == 4 && $plot_y == 2) { $vulnerability = 2; }
                    else if ($plot_x == 4 && $plot_y == 3) { $vulnerability = 3; }
                    else if ($plot_x == 4 && $plot_y == 4) { $vulnerability = 3; }
                    else if ($plot_x == 4 && $plot_y == 5) { $vulnerability = 3; }
                    else if ($plot_x == 5 && $plot_y == 1) { $vulnerability = 3; }
                    else if ($plot_x == 5 && $plot_y == 2) { $vulnerability = 3; }
                    else if ($plot_x == 5 && $plot_y == 3) { $vulnerability = 3; }
                    else if ($plot_x == 5 && $plot_y == 4) { $vulnerability = 3; }
                    else if ($plot_x == 5 && $plot_y == 5) { $vulnerability = 3; }
                    else { $vulnerability = 0; }

                    if ($vulnerability == 1) { $vulnerability_result = '<span class="font-green-jungle bold">Low Risk</span>'; }
                    else if ($vulnerability == 2) { $vulnerability_result = '<span class="font-yellow-gold bold">Medium Risk</span>'; }
                    else if ($vulnerability == 3) { $vulnerability_result = '<span class="font-red-thunderbird bold">High Risk</span>'; }
                    else { $vulnerability_result = ""; }

    				$output = array(
    					"ID" => $data_ID,
    					"company" => htmlentities($data_company),
    					"status" => $status,
    					"last_modified" => $data_last_modified,
    					"vulnerability_result" => $vulnerability_result,
    					"due_date" => $due_date,
    					"tab" => $tab,
    					"user_id" => $user_id
    				);

                    $resultUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $prepared_by" );
                    $rowUser = mysqli_fetch_array($resultUser);
                	$prepared_name = $rowUser["first_name"] .' '. $rowUser["last_name"];
                	$prepared_email = $rowUser["email"];

                	// if ($data_int_verify_status == 1 AND $notification == 1) {
                    if ($notification == 1) {
    	            	// Reviewer
                		if (!empty($reviewed_by) AND (empty($reviewed_signature) OR $reviewed_signature == $empty_signature)) {
    						$selectDataUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $reviewed_by" );
    						if ( mysqli_num_rows($selectDataUser) > 0 ) {
    							$rowDataUser = mysqli_fetch_array($selectDataUser);
    							$datauser_fullname = $rowDataUser["first_name"] .' '. $rowDataUser["last_name"];
    							$datauser_email = $rowDataUser["email"];

    							$from = $prepared_email;
    							$sender = $prepared_name;
    							$to = $datauser_email;
    							$user = $datauser_fullname;
    							$subject = 'Food Fraud Vulnerability Assessment';
    							$body = 'Hi '.$user.',<br><br>

    							<b>Task</b><br>
    							Interlink FFVA Module for Review<br><br>

    							<b>Description</b><br>
    							'.htmlentities($data_company).'<br><br>

    							<b>Assigned by</b><br>
    							Arnel Ryan<br><br>

    							<a href="'. $base_url .'ffva" target="_blank" style="font-weight: 600; padding: 10px 20px!important; text-decoration: none; color: #fff; background-color: #27a4b0; border-color: #208992; display: inline-block;">View Here</a>';
    			    
    			    			php_mailer_1($to, $user, $subject, $body, $from, $sender);
    			    			$countSend++;
    						}
    	            	}

    					// Approver
    	            	if (!empty($approved_by) AND (empty($approved_signature) OR $approved_signature == $empty_signature)) {
    						$selectDataUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $approved_by" );
    						if ( mysqli_num_rows($selectDataUser) > 0 ) {
    							$rowDataUser = mysqli_fetch_array($selectDataUser);
    							$datauser_fullname = $rowDataUser["first_name"] .' '. $rowDataUser["last_name"];
    							$datauser_email = $rowDataUser["email"];

    							$from = $prepared_email;
    							$sender = $prepared_name;
    							$to = $datauser_email;
    							$user = $datauser_fullname;
    							$subject = 'Food Fraud Vulnerability Assessment';
    							$body = 'Hi '.$user.',<br><br>

    							<b>Task</b><br>
    							Interlink FFVA Module for Approval<br><br>

    							<b>Description</b><br>
    							'.htmlentities($data_company).'<br><br>

    							<b>Assigned by</b><br>
    							Arnel Ryan<br><br>

    							<a href="'. $base_url .'ffva" target="_blank" style="font-weight: 600; padding: 10px 20px!important; text-decoration: none; color: #fff; background-color: #27a4b0; border-color: #208992; display: inline-block;">View Here</a>';
    			    
    			    			if ($countSend > 0) {
    			    				php_mailer_2($to, $user, $subject, $body, $from, $sender);
    			    			} else {
    			    				php_mailer_1($to, $user, $subject, $body, $from, $sender);
    			    			}
    						}
    	            	}
                	}

    				echo json_encode($output);
    			}
    		}
        }
	}
	if( isset($_POST['btnUpdate_FFVA']) ) {
		if (!empty($_COOKIE['switchAccount'])) {
			$portal_user = $_COOKIE['ID'];
			$user_id = $_COOKIE['switchAccount'];
		}
		else {
			$portal_user = $_COOKIE['ID'];
			$user_id = employerID($portal_user);
		}
		$path = 'uploads/ffva/';
		$random = rand(1000,1000000);
		$ffva_ID = addslashes($_POST['ID']);

		$tab = $_POST['tab'];
		$last_modified = date('Y-m-d');
        $process = true;

		// Profile
		$company = addslashes($_POST['company']);
		$website = addslashes($_POST['website']);
		$headquarters = addslashes($_POST['headquarters']);
		$telephone = addslashes($_POST['telephone']);
		$email = addslashes($_POST['email']);
		$person = addslashes($_POST['person']);
		$product = addslashes($_POST['product']);
		$assessment = addslashes($_POST['assessment']);
		$category = $_POST['category'];
		$category_other = addslashes($_POST['category_other']);
		$industry = $_POST['industry'];
		$industry_other = addslashes($_POST['industry_other']);
		$code = addslashes($_POST['code']);
		$notification = $_POST['notification'];

		// Questionaire
		$likelihood_answer = "";
		$likelihood_answer_other = "";
		if (!empty($_POST['likelihood_answer'])) { 
			$likelihood_answer = $_POST['likelihood_answer'];
			$likelihood_answer = implode(', ', $likelihood_answer);
		}
		if (!empty($_POST['likelihood_answer_other'])) { 
			$likelihood_answer_other = $_POST['likelihood_answer_other'];
			$likelihood_answer_other = implode(', ', $likelihood_answer_other);
		}

        $arr_item = array();
		$likelihood_comment = "";
		$likelihood_comment_other = "";
		$likelihood_file_arr = array();
		$likelihood_file_other_arr = array();
		if (!empty($_POST['likelihood_comment'])) { 
            $likelihood_comment = $_POST['likelihood_comment'];
            $likelihood_comment = implode(' | ', $likelihood_comment);

            for ($i=0; $i < count($_POST["likelihood_comment"]); $i++) {
                if (!empty($_FILES['likelihood_file']['name'][$i])) {
                    $likelihood_file = addslashes($_FILES['likelihood_file']['name'][$i]);
                    $file_docs_template = "";
                    if (!empty($likelihood_file)) {
                        $filesize = $_FILES['likelihood_file']['size'][$i];
                        $tmp_docs = $_FILES['likelihood_file']['tmp_name'][$i];
                        $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                        $ext = strtolower(pathinfo($likelihood_file, PATHINFO_EXTENSION));
                        $file_docs_template = $random.' - '.$likelihood_file;
                        $path_docs = $path.stripcslashes($file_docs_template);

                        if(!in_array($ext, $invalid_extensions)) {
                            move_uploaded_file($tmp_docs,$path_docs);

                            $output = array (
                                'type'  =>  0,
                                'name' =>  $file_docs_template,
                                'size' =>  $filesize,
                                'date' =>  $local_date
                            );
                            array_push($arr_item, $output);
                        } else {
                            $process = false;
                        }
                    }
                } else {
                    $likelihood_file = addslashes($_POST['likelihood_file_temporary'][$i]);
                    $file_docs_template = $likelihood_file;
                }
                array_push($likelihood_file_arr, $file_docs_template);
            }
        }
        if (!empty($_POST['likelihood_comment_other'])) { 
            $likelihood_comment_other = $_POST['likelihood_comment_other'];
            $likelihood_comment_other = implode(' | ', $likelihood_comment_other);

            for ($i=0; $i < count($_POST["likelihood_comment_other"]); $i++) {
                if (!empty($_FILES['likelihood_file_other']['name'][$i])) {
                    $likelihood_file_other = addslashes($_FILES['likelihood_file_other']['name'][$i]);
                    $file_docs_template = "";
                    if (!empty($likelihood_file_other)) {
                        $filesize = $_FILES['likelihood_file_other']['size'][$i];
                        $tmp_docs = $_FILES['likelihood_file_other']['tmp_name'][$i];
                        $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                        $ext = strtolower(pathinfo($likelihood_file_other, PATHINFO_EXTENSION));
                        $file_docs_template = $random.' - '.$likelihood_file_other;
                        $path_docs = $path.stripcslashes($file_docs_template);

                        if(!in_array($ext, $invalid_extensions)) {
                            move_uploaded_file($tmp_docs,$path_docs);

                            $output = array (
                                'type'  =>  0,
                                'name' =>  $file_docs_template,
                                'size' =>  $filesize,
                                'date' =>  $local_date
                            );
                            array_push($arr_item, $output);
                        } else {
                            $process = false;
                        }
                    }
                } else {
                    $likelihood_file_other = addslashes($_POST['likelihood_file_temporary_other'][$i]);
                    $file_docs_template = $likelihood_file_other;
                }
                array_push($likelihood_file_other_arr, $file_docs_template);
            }
        }
		$likelihood_file_arr = implode(' | ', $likelihood_file_arr);
		$likelihood_file_other_arr = implode(' | ', $likelihood_file_other_arr);

		$likelihood_rate = "";
		$likelihood_rate_other = "";
		if (!empty($_POST['likelihood_rate'])) { 
			$likelihood_rate = $_POST['likelihood_rate'];
			$likelihood_rate = implode(', ', $likelihood_rate);
		}
		if (!empty($_POST['likelihood_rate_other'])) { 
			$likelihood_rate_other = $_POST['likelihood_rate_other'];
			$likelihood_rate_other = implode(', ', $likelihood_rate_other);
		}

		$likelihood_element_other = "";
		if (!empty($_POST['likelihood_element_other'])) { 
			$likelihood_element_other = $_POST['likelihood_element_other'];
			$likelihood_element_other = implode(' | ', $likelihood_element_other);
		}
		$likelihood_question_other = "";
		if (!empty($_POST['likelihood_question_other'])) { 
			$likelihood_question_other = $_POST['likelihood_question_other'];
			$likelihood_question_other = implode(' | ', $likelihood_question_other);
		}

		$likelihood_comment_summary = $_POST['likelihood_comment_summary'];
		$likelihood_note = $_POST['likelihood_note'];

		$consequence_answer = "";
		$consequence_answer_other = "";
		if (!empty($_POST['consequence_answer'])) { 
			$consequence_answer = $_POST['consequence_answer'];
			$consequence_answer = implode(', ', $consequence_answer);
		}
		if (!empty($_POST['consequence_answer_other'])) { 
			$consequence_answer_other = $_POST['consequence_answer_other'];
			$consequence_answer_other = implode(', ', $consequence_answer_other);
		}

		$consequence_comment = "";
		$consequence_comment_other = "";
		$consequence_file_arr = array();
		$consequence_file_other_arr = array();
		if (!empty($_POST['consequence_comment'])) { 
            $consequence_comment = $_POST['consequence_comment'];
            $consequence_comment = implode(' | ', $consequence_comment);

            for ($i=0; $i < count($_POST["consequence_comment"]); $i++) {
                if (!empty($_FILES['consequence_file']['name'][$i])) {
                    $consequence_file = addslashes($_FILES['consequence_file']['name'][$i]);
                    $file_docs_template = "";
                    if (!empty($consequence_file)) {
                        $filesize = $_FILES['consequence_file']['size'][$i];
                        $tmp_docs = $_FILES['consequence_file']['tmp_name'][$i];
                        $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                        $ext = strtolower(pathinfo($consequence_file, PATHINFO_EXTENSION));
                        $file_docs_template = $random.' - '.$consequence_file;
                        $path_docs = $path.stripcslashes($file_docs_template);

                        if(!in_array($ext, $invalid_extensions)) {
                            move_uploaded_file($tmp_docs,$path_docs);

                            $output = array (
                                'type'  =>  0,
                                'name' =>  $file_docs_template,
                                'size' =>  $filesize,
                                'date' =>  $local_date
                            );
                            array_push($arr_item, $output);
                        } else {
                            $process = false;
                        }
                    }
                } else {
                    $consequence_file = addslashes($_POST['consequence_file_temporary'][$i]);
                    $file_docs_template = $consequence_file;
                }
                array_push($consequence_file_arr, $file_docs_template);
            }
        }
        if (!empty($_POST['consequence_comment_other'])) { 
            $consequence_comment_other = $_POST['consequence_comment_other'];
            $consequence_comment_other = implode(' | ', $consequence_comment_other);

            for ($i=0; $i < count($_POST["consequence_comment_other"]); $i++) {
                if (!empty($_FILES['consequence_file_other']['name'][$i])) {
                    $consequence_file_other = addslashes($_FILES['consequence_file_other']['name'][$i]);
                    $file_docs_template = "";
                    if (!empty($consequence_file_other)) {
                        $filesize = $_FILES['consequence_file_other']['size'][$i];
                        $tmp_docs = $_FILES['consequence_file_other']['tmp_name'][$i];
                        $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                        $ext = strtolower(pathinfo($consequence_file_other, PATHINFO_EXTENSION));
                        $file_docs_template = $random.' - '.$consequence_file_other;
                        $path_docs = $path.stripcslashes($file_docs_template);

                        if(!in_array($ext, $invalid_extensions)) {
                            move_uploaded_file($tmp_docs,$path_docs);

                            $output = array (
                                'type'  =>  0,
                                'name' =>  $file_docs_template,
                                'size' =>  $filesize,
                                'date' =>  $local_date
                            );
                            array_push($arr_item, $output);
                        } else {
                            $process = false;
                        }
                    }
                } else {
                    $consequence_file_other = addslashes($_POST['consequence_file_temporary_other'][$i]);
                    $file_docs_template = $consequence_file_other;
                }
                array_push($consequence_file_other_arr, $file_docs_template);
            }
        }
		$consequence_file_arr = implode(' | ', $consequence_file_arr);
		$consequence_file_other_arr = implode(' | ', $consequence_file_other_arr);

        if ($process == true) {
    		$consequence_rate = "";
    		$consequence_rate_other = "";
    		if (!empty($_POST['consequence_rate'])) { 
    			$consequence_rate = $_POST['consequence_rate'];
    			$consequence_rate = implode(', ', $consequence_rate);
    		}
    		if (!empty($_POST['consequence_rate_other'])) { 
    			$consequence_rate_other = $_POST['consequence_rate_other'];
    			$consequence_rate_other = implode(', ', $consequence_rate_other);
    		}

    		$consequence_element_other = "";
    		if (!empty($_POST['consequence_element_other'])) { 
    			$consequence_element_other = $_POST['consequence_element_other'];
    			$consequence_element_other = implode(' | ', $consequence_element_other);
    		}
    		$consequence_question_other = "";
    		if (!empty($_POST['consequence_question_other'])) { 
    			$consequence_question_other = $_POST['consequence_question_other'];
    			$consequence_question_other = implode(' | ', $consequence_question_other);
    		}

    		$consequence_comment_summary = $_POST['consequence_comment_summary'];
    		$consequence_note = $_POST['consequence_note'];


    		// Activities
    		$prevention = "";
    		$prevention_other = "";
    		if (!empty($_POST['prevention'])) { 
    			$prevention = $_POST['prevention'];
    			$prevention = implode(', ', $prevention);
    		}
    		if (!empty($_POST['prevention_other'])) { 
    			$prevention_other = $_POST['prevention_other'];
    			$prevention_other = implode(', ', $prevention_other);
    		}

    		$detection = "";
    		$detection_other = "";
    		if (!empty($_POST['detection'])) { 
    			$detection = $_POST['detection'];
    			$detection = implode(', ', $detection);
    		}
    		if (!empty($_POST['detection_other'])) { 
    			$detection_other = $_POST['detection_other'];
    			$detection_other = implode(', ', $detection_other);
    		}
    		
    		$mitigation = "";
    		$mitigation_other = "";
    		if (!empty($_POST['mitigation'])) { 
    			$mitigation = $_POST['mitigation'];
    			$mitigation = implode(', ', $mitigation);
    		}
    		if (!empty($_POST['mitigation_other'])) { 
    			$mitigation_other = $_POST['mitigation_other'];
    			$mitigation_other = implode(', ', $mitigation_other);
    		}


    		// Assigned
    		$prepared_by = $_POST['prepared_by'];
    		$prepared_position = $_POST['prepared_position'];
    		$prepared_date = $_POST['prepared_date'];
    		$prepared_type = $_POST['prepared_type'];
    		$prepared_signature = $_POST['prepared_signature_default_temp'];
    		if ($prepared_type == 1) {
    			$prepared_signature = $_POST['prepared_sigData'];
    		} else if ($prepared_type == 2) {
    			$prepared_file = $_FILES['prepared_file']['name'];
    			if (!empty($prepared_file)) {
    				$base_tmp = $_FILES['prepared_file']['tmp_name'];
    				$base_type = pathinfo($base_tmp, PATHINFO_EXTENSION);
    				$base_data = file_get_contents($base_tmp);
    				$prepared_signature = 'data:image/png;base64,' . base64_encode($base_data);
    			}
    		}

    		$reviewed_by = $_POST['reviewed_by'];
    		$reviewed_position = $_POST['reviewed_position'];
    		$reviewed_date = $_POST['reviewed_date'];
    		$reviewed_type = $_POST['reviewed_type'];
    		$reviewed_signature = $_POST['reviewed_signature_default_temp'];
    		if ($reviewed_type == 1) {
    			$reviewed_signature = $_POST['reviewed_sigData'];
    		} else if ($reviewed_type == 2) {
    			$reviewed_file = $_FILES['reviewed_file']['name'];
    			if (!empty($reviewed_file)) {
    				$base_tmp = $_FILES['reviewed_file']['tmp_name'];
    				$base_type = pathinfo($base_tmp, PATHINFO_EXTENSION);
    				$base_data = file_get_contents($base_tmp);
    				$reviewed_signature = 'data:image/png;base64,' . base64_encode($base_data);
    			}
    		}

    		$approved_by = $_POST['approved_by'];
    		$approved_position = $_POST['approved_position'];
    		$approved_date = $_POST['approved_date'];
    		$approved_type = $_POST['approved_type'];
    		$approved_signature = $_POST['approved_signature_default_temp'];
    		if ($approved_type == 1) {
    			$approved_signature = $_POST['approved_sigData'];
    		} else if ($approved_type == 2) {
    			$approved_file = $_FILES['approved_file']['name'];
    			if (!empty($approved_file)) {
    				$base_tmp = $_FILES['approved_file']['tmp_name'];
    				$base_type = pathinfo($base_tmp, PATHINFO_EXTENSION);
    				$base_data = file_get_contents($base_tmp);
    				$approved_signature = 'data:image/png;base64,' . base64_encode($base_data);
    			}
    		}

    		$sql = "INSERT INTO tbl_ffva (user_id, portal_user, type, company, website, headquarters, telephone, email, person, product, assessment, category_id, category_other, industry_id, industry_other, code, notification, likelihood_answer, likelihood_comment, likelihood_file, likelihood_rate, likelihood_element_other, likelihood_question_other, likelihood_answer_other, likelihood_comment_other, likelihood_file_other, likelihood_rate_other, likelihood_comment_summary, likelihood_note, consequence_answer, consequence_comment, consequence_file, consequence_rate, consequence_element_other, consequence_question_other, consequence_answer_other, consequence_comment_other, consequence_file_other, consequence_rate_other, consequence_comment_summary, consequence_note, prevention, prevention_other, detection, detection_other, mitigation, mitigation_other, prepared_by, prepared_signature, prepared_position, prepared_date, reviewed_by, reviewed_signature, reviewed_position, reviewed_date, approved_by, approved_signature, approved_position, approved_date, last_modified)
    		VALUES ('$user_id', '$portal_user', '$tab', '$company', '$website', '$headquarters', '$telephone', '$email', '$person', '$product', '$assessment', '$category', '$category_other', '$industry', '$industry_other', '$code', '$notification', '$likelihood_answer', '$likelihood_comment', '$likelihood_file_arr', '$likelihood_rate', '$likelihood_element_other', '$likelihood_question_other', '$likelihood_answer_other', '$likelihood_comment_other', '$likelihood_file_other_arr', '$likelihood_rate_other', '$likelihood_comment_summary', '$likelihood_note', '$consequence_answer', '$consequence_comment', '$consequence_file_arr', '$consequence_rate','$consequence_element_other', '$consequence_question_other', '$consequence_answer_other', '$consequence_comment_other', '$consequence_file_other_arr', '$consequence_rate_other', '$consequence_comment_summary', '$consequence_note', '$prevention', '$prevention_other', '$detection', '$detection_other', '$mitigation', '$mitigation_other', '$prepared_by', '$prepared_signature', '$prepared_position', '$prepared_date', '$reviewed_by', '$reviewed_signature', '$reviewed_position', '$reviewed_date', '$approved_by', '$approved_signature', '$approved_position', '$approved_date', '$last_modified')";
    		if (mysqli_query($conn, $sql)) {
    			$last_id = mysqli_insert_id($conn);

    			mysqli_query( $conn,"UPDATE tbl_ffva set updated = 1 WHERE ID = $ffva_ID" );

    			$selectData = mysqli_query( $conn,'SELECT * FROM tbl_ffva WHERE user_id="'. $user_id .'" AND ID="'. $last_id .'" ORDER BY ID LIMIT 1' );
    			if ( mysqli_num_rows($selectData) > 0 ) {
    				$rowData = mysqli_fetch_array($selectData);
    				$data_ID = $rowData['ID'];
    				$data_int_review_status = $rowData['int_review_status'];
    				$data_int_verify_status = $rowData['int_verify_status'];
    				$data_company = $rowData['company'];
    				if ($tab == 2) { $data_company = $rowData['product']; }

    				$data_status = $rowData['status'];
                    $status = "Drafted";
                    // if (empty($int_review_assigned)) { $status = 'Drafted'; }
                    if (!empty($rowData['int_review_assigned']) AND $rowData['int_review_status'] == 1) { $status = 'Reviewed'; }
                    if (!empty($rowData['int_review_assigned']) AND $rowData['int_review_status'] == 1 AND !empty($rowData['int_verify_assigned']) AND $rowData['int_verify_status'] == 1) { $status = 'Approved by CIG'; }
                    if (!empty($rowData['int_review_assigned']) AND $rowData['int_review_status'] == 1 AND !empty($rowData['int_verify_assigned']) AND $rowData['int_verify_status'] == 1 AND !empty($rowData['approved_date'])) { $status = "Approved by Client"; }

    				$data_last_modified = $rowData['last_modified'];
                    $data_last_modified = new DateTime($data_last_modified);
                    $data_last_modified = $data_last_modified->format('M d, Y');
                                                            
                    $due_date = date('Y-m-d', strtotime('+1 year', strtotime($data_last_modified)) );
                    $due_date = new DateTime($due_date);
                    $due_date = $due_date->format('M d, Y');

                    $likelihood_rate = $rowData["likelihood_rate"];
                    $likelihood_rate_arr = explode(', ', $likelihood_rate);

                    $consequence_rate = $rowData["consequence_rate"];
                    $consequence_rate_arr = explode(', ', $consequence_rate);


                    // Likelihood
                    $index = 0;
                    $count = 0;
                    $sum = 0;
                    $total_likelihood = 0;
                    $selectLikelihood = mysqli_query( $conn,"SELECT * FROM tbl_ffva_likelihood" );
                    if ( mysqli_num_rows($selectLikelihood) > 0 ) {
                        while($rowLikelihood = mysqli_fetch_array($selectLikelihood)) {
                            $likelihood_type_arr = explode(', ', $rowLikelihood["type"]);
                            if (in_array($rowData["type"], $likelihood_type_arr)) {
                                $sum += $likelihood_rate_arr[$index];
                                $index++;
                                $count++;
                            }
                        }
                    }

                    if (!empty($rowData["likelihood_element_other"])) {
                        $likelihood_element_other = explode(' | ', $rowData["likelihood_element_other"]);
                        $likelihood_rate_other = explode(', ', $rowData["likelihood_rate_other"]);

                        $index = 0;
                        foreach ($likelihood_element_other as $value) {
                            $sum += $likelihood_rate_other[$index];
                            $index++;
                            $count++;
                        }
                    }

                    $total_likelihood = $sum / $count;


                    // Consequence
                    $index = 0;
                    $count = 0;
                    $sum = 0;
                    $total_consequence = 0;
                    $selectConsequence = mysqli_query( $conn,"SELECT * FROM tbl_ffva_consequence" );
                    if ( mysqli_num_rows($selectConsequence) > 0 ) {
                        while($rowConsequence = mysqli_fetch_array($selectConsequence)) {
                            $sum += $consequence_rate_arr[$index];
                            $index++;
                            $count++;
                        }
                    }

                    if (!empty($rowData["consequence_element_other"])) {
                        $consequence_element_other = explode(' | ', $rowData["consequence_element_other"]);
                        $consequence_rate_other = explode(', ', $rowData["consequence_rate_other"]);

                        $index = 0;
                        foreach ($consequence_element_other as $value) {
                            $sum += $consequence_rate_other[$index];
                            $index++;
                            $count++;
                        }
                    }

                    $total_consequence = $sum / $count;


                    // Matrix
                    $plot_x = 1;
                    $plot_y = 1;

    	            if (round($total_likelihood) > 0) { $plot_x = round($total_likelihood); }
    	            if (round($total_consequence) > 0) { $plot_y = round($total_consequence); }

                    if ($plot_x == 1 && $plot_y == 1) { $vulnerability = 1; }
                    else if ($plot_x == 1 && $plot_y == 2) { $vulnerability = 1; }
                    else if ($plot_x == 1 && $plot_y == 3) { $vulnerability = 1; }
                    else if ($plot_x == 1 && $plot_y == 4) { $vulnerability = 2; }
                    else if ($plot_x == 1 && $plot_y == 5) { $vulnerability = 2; }
                    else if ($plot_x == 2 && $plot_y == 1) { $vulnerability = 1; }
                    else if ($plot_x == 2 && $plot_y == 2) { $vulnerability = 1; }
                    else if ($plot_x == 2 && $plot_y == 3) { $vulnerability = 2; }
                    else if ($plot_x == 2 && $plot_y == 4) { $vulnerability = 2; }
                    else if ($plot_x == 2 && $plot_y == 5) { $vulnerability = 3; }
                    else if ($plot_x == 3 && $plot_y == 1) { $vulnerability = 2; }
                    else if ($plot_x == 3 && $plot_y == 2) { $vulnerability = 2; }
                    else if ($plot_x == 3 && $plot_y == 3) { $vulnerability = 2; }
                    else if ($plot_x == 3 && $plot_y == 4) { $vulnerability = 3; }
                    else if ($plot_x == 3 && $plot_y == 5) { $vulnerability = 3; }
                    else if ($plot_x == 4 && $plot_y == 1) { $vulnerability = 2; }
                    else if ($plot_x == 4 && $plot_y == 2) { $vulnerability = 2; }
                    else if ($plot_x == 4 && $plot_y == 3) { $vulnerability = 3; }
                    else if ($plot_x == 4 && $plot_y == 4) { $vulnerability = 3; }
                    else if ($plot_x == 4 && $plot_y == 5) { $vulnerability = 3; }
                    else if ($plot_x == 5 && $plot_y == 1) { $vulnerability = 3; }
                    else if ($plot_x == 5 && $plot_y == 2) { $vulnerability = 3; }
                    else if ($plot_x == 5 && $plot_y == 3) { $vulnerability = 3; }
                    else if ($plot_x == 5 && $plot_y == 4) { $vulnerability = 3; }
                    else if ($plot_x == 5 && $plot_y == 5) { $vulnerability = 3; }
                    else { $vulnerability = 0; }

                    if ($vulnerability == 1) { $vulnerability_result = '<span class="font-green-jungle bold">Low Risk</span>'; }
                    else if ($vulnerability == 2) { $vulnerability_result = '<span class="font-yellow-gold bold">Medium Risk</span>'; }
                    else if ($vulnerability == 3) { $vulnerability_result = '<span class="font-red-thunderbird bold">High Risk</span>'; }
                    else { $vulnerability_result = ""; }

                    // $selectDataPrev = mysqli_query( $conn,"SELECT * FROM tbl_ffva WHERE ID = $ffva_ID" );
    				// if ( mysqli_num_rows($selectDataPrev) > 0 ) {
    				// 	$rowDataPrev = mysqli_fetch_array($selectDataPrev);
    				// 	$dataPrev_int_review_assigned = $rowDataPrev['int_review_assigned'];
    				// 	$dataPrev_int_review_status = $rowDataPrev['int_review_status'];
    				// 	$dataPrev_int_review_comment = $rowDataPrev['int_review_comment'];
    				// 	$dataPrev_int_verify_assigned = $rowDataPrev['int_verify_assigned'];
    				// 	$dataPrev_int_verify_status = $rowDataPrev['int_verify_status'];
    				// 	$dataPrev_int_verify_comment = $rowDataPrev['int_verify_comment'];

    				// 	mysqli_query( $conn,"UPDATE tbl_ffva set int_review_assigned = '".$dataPrev_int_review_assigned."', int_review_status = '".$dataPrev_int_review_status."', int_review_comment = '".$dataPrev_int_review_comment."', int_verify_assigned = '".$dataPrev_int_verify_assigned."', int_verify_status = '".$dataPrev_int_verify_status."', int_verify_comment = '".$dataPrev_int_verify_comment."' WHERE ID = $data_ID" );
    				// }

    				$output = array(
    					"ID" => $data_ID,
    					"company" => htmlentities($data_company),
    					"status" => $status,
    					"last_modified" => $data_last_modified,
    					"vulnerability_result" => $vulnerability_result,
    					"due_date" => $due_date,
    					"tab" => $tab,
    					"ffva_ID" => $ffva_ID,
    					"user_id" => $user_id
    				);

                    $resultUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $prepared_by" );
                    $rowUser = mysqli_fetch_array($resultUser);
                	$prepared_name = $rowUser["first_name"] .' '. $rowUser["last_name"];
                	$prepared_email = $rowUser["email"];
                	$countSend = 0;

                	// if ($data_int_verify_status == 1 AND $notification == 1) {
                    if ($notification == 1) {
    	            	// Reviewer
                		if (!empty($reviewed_by)) {
    						$selectDataUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $reviewed_by" );
    						if ( mysqli_num_rows($selectDataUser) > 0 ) {
    							$rowDataUser = mysqli_fetch_array($selectDataUser);
    							$datauser_fullname = $rowDataUser["first_name"] .' '. $rowDataUser["last_name"];
    							$datauser_email = $rowDataUser["email"];

    							$from = $prepared_email;
    							$sender = $prepared_name;
    							$to = $datauser_email;
    							$user = $datauser_fullname;
    							$subject = 'Food Fraud Vulnerability Assessment';
    							$body = 'Hi '.$user.',<br><br>

    							<b>Task</b><br>
    							Interlink FFVA Module for Review<br><br>

    							<b>Description</b><br>
    							'.htmlentities($data_company).'<br><br>

    							<b>Assigned by</b><br>
    							Arnel Ryan<br><br>

    							<a href="'. $base_url .'ffva" target="_blank" style="font-weight: 600; padding: 10px 20px!important; text-decoration: none; color: #fff; background-color: #27a4b0; border-color: #208992; display: inline-block;">View Here</a>';
    			    
    			    			php_mailer_1($to, $user, $subject, $body, $from, $sender);
    			    			$countSend++;
    						}
    	            	}

    					// Approver
    	            	if (!empty($approved_by)) {
    						$selectDataUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $approved_by" );
    						if ( mysqli_num_rows($selectDataUser) > 0 ) {
    							$rowDataUser = mysqli_fetch_array($selectDataUser);
    							$datauser_fullname = $rowDataUser["first_name"] .' '. $rowDataUser["last_name"];
    							$datauser_email = $rowDataUser["email"];

    							$from = $prepared_email;
    							$sender = $prepared_name;
    							$to = $datauser_email;
    							$user = $datauser_fullname;
    							$subject = 'Food Fraud Vulnerability Assessment';
    							$body = 'Hi '.$user.',<br><br>

    							<b>Task</b><br>
    							Interlink FFVA Module for Approval<br><br>

    							<b>Description</b><br>
    							'.htmlentities($data_company).'<br><br>

    							<b>Assigned by</b><br>
    							Arnel Ryan<br><br>

    							<a href="'. $base_url .'ffva" target="_blank" style="font-weight: 600; padding: 10px 20px!important; text-decoration: none; color: #fff; background-color: #27a4b0; border-color: #208992; display: inline-block;">View Here</a>';
    			    
    			    			if ($countSend > 0) {
    			    				php_mailer_2($to, $user, $subject, $body, $from, $sender);
    			    			} else {
    			    				php_mailer_1($to, $user, $subject, $body, $from, $sender);
    			    			}
    						}
    	            	}
                	}

    				echo json_encode($output);
    			}
    		}
        }
	}
	if( isset($_POST['btnRef_FFVA']) ) {
		if (!empty($_COOKIE['switchAccount'])) {
			$portal_user = $_COOKIE['ID'];
			$user_id = $_COOKIE['switchAccount'];
		}
		else {
			$portal_user = $_COOKIE['ID'];
			$user_id = employerID($portal_user);
		}

		$ID = $_POST['ID'];
		$type = $_POST['type'];
		$content = addslashes($_POST['content']);

		$result = mysqli_query( $conn,"SELECT * FROM tbl_ffva_reference WHERE user_id = $user_id AND type = $type AND element = $ID" );
        if ( mysqli_num_rows($result) > 0 ) {
            mysqli_query( $conn,"UPDATE tbl_ffva_reference set portal_user = $portal_user, content = '".$content."' WHERE element = $ID AND type = $type" );
        } else {
        	$sql = "INSERT INTO tbl_ffva_reference (user_id, portal_user, type, element, content)
			VALUES ('$user_id', '$portal_user', '$type', '$ID', '$content')";
			mysqli_query($conn, $sql);
        }

		$output = array(
			"ID" => $ID,
			"type" => $type,
			"content" => $content
		);

		echo json_encode($output);
	}
	if( isset($_POST['btnSign_FFVA']) ) {
		if (!empty($_COOKIE['switchAccount'])) {
			$portal_user = $_COOKIE['ID'];
			$user_id = $_COOKIE['switchAccount'];
		}
		else {
			$portal_user = $_COOKIE['ID'];
			$user_id = employerID($portal_user);
		}

		$ID = $_POST['ID'];
		$area = $_POST['area'];

		$position = $_POST['signed_position'];
		$date = $_POST['signed_date'];

		if ($_POST['sigData'] == $empty_signature) {
			$signature = $_POST['prepared_signature_temp'];
		} else {
			$signature = $_POST['sigData'];
		}

		if ($area == 1) {
			mysqli_query( $conn,"UPDATE tbl_ffva set reviewed_signature = '".$signature."', reviewed_position = '".$position."', reviewed_date = '".$date."' WHERE ID = $ID" );
		} else if ($area == 2) {
			mysqli_query( $conn,"UPDATE tbl_ffva set approved_signature = '".$signature."', approved_position = '".$position."', approved_date = '".$date."' WHERE ID = $ID" );
		}

		$output = array(
			"ID" => $ID,
			"area" => $area
		);

		echo json_encode($output);
	}
	if( isset($_POST['btnFile_FFVA']) ) {
		$ID = $_POST['ID'];
		$area = $_POST['area'];
		$position = $_POST['signed_position'];
		$date = $_POST['signed_date'];
        $process = true;

		$files = $_FILES['file']['name'];
		if (!empty($files)) {
			$path = 'uploads/ffva/';
			$tmp = $_FILES['file']['tmp_name'];
            $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
            $ext = strtolower(pathinfo($files, PATHINFO_EXTENSION));
			$files = rand(1000,1000000) . ' - ' . $files;
			$path = $path.$files;

            if(!in_array($ext, $invalid_extensions)) {
                move_uploaded_file($tmp,$path);
            } else {
                $process = false;
            }
		}

        if ($process == true) {
    		if ($area == 1) {
    			mysqli_query( $conn,"UPDATE tbl_ffva set files = '".$files."', reviewed_signature = '".$empty_signature."', reviewed_position = '".$position."', reviewed_date = '".$date."' WHERE ID = $ID" );
    		} else if ($area == 2) {
    			mysqli_query( $conn,"UPDATE tbl_ffva set files = '".$files."', approved_signature = '".$empty_signature."', approved_position = '".$position."', approved_date = '".$date."' WHERE ID = $ID" );
    		}

            $fileExtension = fileExtension($files);
    		$src = $fileExtension['src'];
    		$embed = $fileExtension['embed'];
    		$type = $fileExtension['type'];
    		$file_extension = $fileExtension['file_extension'];
            $url = $base_url.'uploads/ffva/';
            $file_url = '<a href="'.$src.$url.rawurlencode($files).$embed.'" data-src="'.$src.$url.rawurlencode($files).$embed.'" data-fancybox data-type="'.$type.'" class="btn btn-link btn-sm">View</a><a href="#modalFile" class="btn btn-link btn-sm" data-toggle="modal" onclick="btnFile('.$ID.', '.$area.')">Upload</a>';

    		$output = array(
    			"ID" => $ID,
    			"attached" => $file_url
    		);

    		echo json_encode($output);
        }
	}
	if( isset($_POST['btnSaveInt_FFVA']) ) {
		$ID = $_POST['ID'];
		$type = $_POST['type'];
		$tab = $_POST['tab'];
		if ($type == 1) { $type_field = "review"; $type_field_email = "Reviewer"; }
		else if ($type == 2) { $type_field = "verify"; $type_field_email = "Verifier"; }
		$int_column = '';

		if (!empty($_COOKIE['switchAccount'])) {
			$portal_user = $_COOKIE['ID'];
			$user_id = $_COOKIE['switchAccount'];
		}
		else {
			$portal_user = $_COOKIE['ID'];
			$user_id = employerID($portal_user);
		}

		$employeeID = employeeID($portal_user);
		$assigned_to_id = $_POST['assigned_to_id'];
		$status = $_POST['status'];
		$comment = addslashes($_POST['comment']);
		$mail_sent = 0;

		$selectDataTemp = mysqli_query( $conn,"SELECT * FROM tbl_ffva WHERE ID = $ID" );
		if ( mysqli_num_rows($selectDataTemp) > 0 ) {
			$rowDataTemp = mysqli_fetch_array($selectDataTemp);
			$rowDataTemp_int_review_assigned = $rowDataTemp["int_review_assigned"];
			$rowDataTemp_int_verify_assigned = $rowDataTemp["int_verify_assigned"];

			$data_company = $rowDataTemp['company'];
			if ($tab == 2) { $data_company = $rowDataTemp['product']; }
		}

		mysqli_query( $conn,"UPDATE tbl_ffva set int_".$type_field."_assigned = '".$assigned_to_id."', int_".$type_field."_status = '".$status."', int_".$type_field."_comment = '".$comment."' WHERE ID = $ID" );

		if (empty($rowDataTemp_int_review_assigned) || $rowDataTemp_int_review_assigned != $assigned_to_id) {
			// Send Email Notif that they were assigned for this
			$row_email = '';
			$row_name = '';
			$selectEmployee = mysqli_query( $conn,"SELECT * FROM tbl_hr_employee WHERE ID = '".$assigned_to_id."'" );
            if ( mysqli_num_rows($selectEmployee) > 0 ) {
                $rowEmployee = mysqli_fetch_array($selectEmployee);
                $row_name = $rowEmployee["first_name"] .' '. $rowEmployee["last_name"];
                $row_email = $rowEmployee["email"];
                $int_column .= $row_name.'<br>';
            }

			$selectFFVA = mysqli_query( $conn,"SELECT * FROM tbl_ffva WHERE ID = $ID" );
	        if ( mysqli_num_rows($selectFFVA) > 0 ) {
	            $rowFFVA = mysqli_fetch_array($selectFFVA);
	            $rowFFVA_user_id = $rowFFVA["user_id"];

				$selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $rowFFVA_user_id" );
	            if ( mysqli_num_rows($selectUser) > 0 ) {
	                $rowUser = mysqli_fetch_array($selectUser);
	                $name = $rowUser["first_name"] .' '. $rowUser["last_name"];
	                $from = $rowUser["email"];
	            }
	        }

			$to = $row_email;
			$user = $row_name;
			$subject = 'FFVA Module - Internal '. $type_field_email;
			$body = 'Hi '.$user.',<br><br>

			<b>Task</b><br>
			Interlink FFVA Module for Internal '. $type_field_email .'<br><br>

			<b>Description</b><br>
			'.$data_company.'<br><br>

			<b>Assigned by</b><br>
			Arnel Ryan<br><br>

			<a href="'. $base_url .'ffva" target="_blank" style="font-weight: 600; padding: 10px 20px!important; text-decoration: none; color: #fff; background-color: #27a4b0; border-color: #208992; display: inline-block;">View</a>';
            
            php_mailer_1($to, $user, $subject, $body, $from, $name);
		}


		if ($type == 1) {
			$assigned_to_id2 = $_POST['assigned_to_id2'];
			mysqli_query( $conn,"UPDATE tbl_ffva set int_verify_assigned = '".$assigned_to_id2."' WHERE ID = $ID" );
		}

		$selectFFVA = mysqli_query( $conn,"SELECT * FROM tbl_ffva WHERE ID = $ID" );
        if ( mysqli_num_rows($selectFFVA) > 0 ) {
            $rowFFVA = mysqli_fetch_array($selectFFVA);
            $row_user_id = $rowFFVA["user_id"];
            $row_int_review_assigned = $rowFFVA["int_review_assigned"];
            $row_int_review_comment = $rowFFVA["int_review_comment"];
            $row_int_verify_assigned = $rowFFVA["int_verify_assigned"];

            $selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $row_user_id" );
            if ( mysqli_num_rows($selectUser) > 0 ) {
                $rowUser = mysqli_fetch_array($selectUser);
                $row_name = $rowUser["first_name"] .' '. $rowUser["last_name"];
                $row_email = $rowUser["email"];
            }

			$selectEmployee = mysqli_query( $conn,"SELECT * FROM tbl_hr_employee WHERE ID = '".$row_int_review_assigned."'" );
            if ( mysqli_num_rows($selectEmployee) > 0 ) {
                $rowEmployee = mysqli_fetch_array($selectEmployee);
                $name = $rowEmployee["first_name"] .' '. $rowEmployee["last_name"];
                $from = $rowEmployee["email"];
            }
        }

		$int_column .= '<a href="#modalViewInt" class="btn btn-link btn-sm" data-toggle="modal" onClick="btnInt('.$ID.', '.$type.', '.$tab.')">View</a>';
		$to = $row_email;
		$user = $row_name;
		$subject = 'FFVA Module';
		if($status == 1) {
			$int_column .= '<span class="label label-sm label-success">Accepted</span>';

			$body = 'Hi '. $user .',<br><br>

			<b>Task</b><br>
			Interlink FFVA Module for Internal '.$type_field_email.'<br><br>

			<b>Description</b><br>
			'.$data_company.' was accepted!<br><br>

			<b>Assigned to</b><br>
			'.$name.'<br><br>

			<a href="'. $base_url .'ffva" target="_blank" style="font-weight: 600; padding: 10px 20px!important; text-decoration: none; color: #fff; background-color: #27a4b0; border-color: #208992; display: inline-block;">View Here</a>';

			if ($mail_sent == 0) {
				php_mailer_1($to, $user, $subject, $body, $from, $name); 
				$mail_sent++;
			}
			else { php_mailer_2($to, $user, $subject, $body, $from, $name); }


			if (!empty($row_int_verify_assigned)) {
				$selectEmployee2 = mysqli_query( $conn,"SELECT * FROM tbl_hr_employee WHERE ID = $row_int_verify_assigned" );
	            if ( mysqli_num_rows($selectEmployee2) > 0 ) {
	                $rowEmployee2 = mysqli_fetch_array($selectEmployee2);
	                $user2 = $rowEmployee2["first_name"] .' '. $rowEmployee2["last_name"];
	                $to2 = $rowEmployee2["email"];
	            }

				$subject2 = 'FFVA Module - Internal Verifier';
				$body2 = 'Hi '.$user2.',<br><br>

				<b>Task</b><br>
				Interlink FFVA Module for Internal Verifier<br><br>

				<b>Description</b><br>
				'.$data_company.'<br><br>

				<b>Assigned by</b><br>
				'.$user.'<br><br>

				<a href="'. $base_url .'ffva" target="_blank" style="font-weight: 600; padding: 10px 20px!important; text-decoration: none; color: #fff; background-color: #27a4b0; border-color: #208992; display: inline-block;">View</a>';

				if ($mail_sent == 0) {
					php_mailer_1($to2, $user2, $subject2, $body2, $to, $user);
					$mail_sent++;
				}
				else { php_mailer_2($to2, $user2, $subject2, $body2, $to, $user); }
			}
		}
		else if ($status == 2) {
			$int_column .= '<span class="label label-sm label-danger">Rejected</span>';

			$body = 'Hi '. $user .',<br><br>

			<b>Task</b><br>
			Interlink FFVA Module for Internal '.$type_field_email.'<br><br>

			<b>Description</b><br>
			'.$data_company.' was rejected due to '.$row_int_review_comment.'<br><br>

			<b>Assigned to</b><br>
			'.$name.'<br><br>

			<a href="'. $base_url .'ffva" target="_blank" style="font-weight: 600; padding: 10px 20px!important; text-decoration: none; color: #fff; background-color: #27a4b0; border-color: #208992; display: inline-block;">View</a>';

			if ($mail_sent == 0) {
				php_mailer_1($to, $user, $subject, $body, $from, $name);
				$mail_sent++;
			}
			else { php_mailer_2($to, $user, $subject, $body, $from, $name); }
		}

		$selectFFVA = mysqli_query( $conn,"SELECT * FROM tbl_ffva WHERE ID = $ID" );
        if ( mysqli_num_rows($selectFFVA) > 0 ) {
            $rowFFVA = mysqli_fetch_array($selectFFVA);
			$row_user_id = $rowFFVA['user_id'];
			$row_prepared_by = $rowFFVA['prepared_by'];
			$row_notification = $rowFFVA['notification'];
			$row_int_verify_status = $rowFFVA['int_verify_status'];
			$row_reviewed_by = $rowFFVA['reviewed_by'];
			$row_reviewed_signature = $rowFFVA['reviewed_signature'];
			$row_approved_by = $rowFFVA['approved_by'];
			$row_approved_signature = $rowFFVA['approved_signature'];

        	if ($row_int_verify_status == 1 AND $row_notification == 1) {
            	// Reviewer
            	if (!empty($row_reviewed_by) AND (empty($row_reviewed_signature) OR $row_reviewed_signature == $empty_signature)) {
					$selectDataUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $row_reviewed_by" );
					if ( mysqli_num_rows($selectDataUser) > 0 ) {
						$rowDataUser = mysqli_fetch_array($selectDataUser);
						$datauser_fullname = $rowDataUser["first_name"] .' '. $rowDataUser["last_name"];
						$datauser_email = $rowDataUser["email"];

						$selectDataUser2 = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $row_prepared_by" );
						if ( mysqli_num_rows($selectDataUser2) > 0 ) {
							$rowDataUser2 = mysqli_fetch_array($selectDataUser2);
							$prepared_name = $rowDataUser2["first_name"] .' '. $rowDataUser2["last_name"];
							$prepared_email = $rowDataUser2["email"];
						}

						$from = $prepared_email;
						$sender = $prepared_name;
						$to = $datauser_email;
						$user = $datauser_fullname;
						$subject = 'Food Fraud Vulnerability Assessment';
						$body = 'Hi '.$user.',<br><br>

						<b>Task</b><br>
						Interlink FFVA Module for Review<br><br>

						<b>Description</b><br>
						'.$data_company.'<br><br>

						<b>Assigned by</b><br>
						Arnel Ryan<br><br>

						<a href="'. $base_url .'ffva" target="_blank" style="font-weight: 600; padding: 10px 20px!important; text-decoration: none; color: #fff; background-color: #27a4b0; border-color: #208992; display: inline-block;">View Here</a>';
		    
						if ($mail_sent == 0) {
							php_mailer_1($to, $user, $subject, $body, $from, $sender);
							$mail_sent++;
						}
						else { php_mailer_2($to, $user, $subject, $body, $from, $sender); }
					}
            	}

				// Approver
            	if (!empty($row_approved_by) AND (empty($row_approved_signature) OR $row_reviewed_signature == $empty_signature)) {
					$selectDataUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $row_approved_by" );
					if ( mysqli_num_rows($selectDataUser) > 0 ) {
						$rowDataUser = mysqli_fetch_array($selectDataUser);
						$datauser_fullname = $rowDataUser["first_name"] .' '. $rowDataUser["last_name"];
						$datauser_email = $rowDataUser["email"];

						$selectDataUser2 = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $row_prepared_by" );
						if ( mysqli_num_rows($selectDataUser2) > 0 ) {
							$rowDataUser2 = mysqli_fetch_array($selectDataUser2);
							$prepared_name = $rowDataUser2["first_name"] .' '. $rowDataUser2["last_name"];
							$prepared_email = $rowDataUser2["email"];
						}

						$from = $prepared_email;
						$sender = $prepared_name;
						$to = $datauser_email;
						$user = $datauser_fullname;
						$subject = 'Food Fraud Vulnerability Assessment';
						$body = 'Hi '.$user.',<br><br>

						<b>Task</b><br>
						Interlink FFVA Module for Approval<br><br>

						<b>Description</b><br>
						'.$data_company.'<br><br>

						<b>Assigned by</b><br>
						Arnel Ryan<br><br>

						<a href="'. $base_url .'ffva" target="_blank" style="font-weight: 600; padding: 10px 20px!important; text-decoration: none; color: #fff; background-color: #27a4b0; border-color: #208992; display: inline-block;">View Here</a>';
		    
						if ($mail_sent == 0) {
							php_mailer_1($to, $user, $subject, $body, $from, $sender);
							$mail_sent++;
						}
						else { php_mailer_2($to, $user, $subject, $body, $from, $sender); }
					}
            	}
        	}
        }

		$output = array(
			"ID" => $ID,
			"type" => $type,
			"tab" => $tab,
			"int_column" => $int_column
		);
		echo json_encode($output);
	}
	if( isset($_GET['btnDeleteKatva_FFVA']) ) {
		$id = $_GET['btnDeleteKatva_FFVA'];
		$reason = addslashes($_GET['reason']);
    	$current_userID = $_COOKIE['ID'];

        $message = array();
		array_push($message, $current_userID);
		array_push($message, $reason);
		$message = implode(" | ",$message);

		mysqli_query( $conn,"UPDATE tbl_ffva_katva SET deleted = 1, reason = '". $message ."' WHERE ID='". $id ."'" );
	}
	if( isset($_POST['btnSaveKatva_FFVA']) ) {
		if (!empty($_COOKIE['switchAccount'])) {
			$portal_user = $_COOKIE['ID'];
			$user_id = $_COOKIE['switchAccount'];
		}
		else {
			$portal_user = $_COOKIE['ID'];
			$user_id = employerID($portal_user);
		}
		$path = 'uploads/ffva/';
		$random = rand(1000,1000000);

		$modal = $_POST['modal'];
		$last_modified = date('Y-m-d');

		$product = addslashes($_POST['product']);
		$facility = addslashes($_POST['facility']);
		$address = addslashes($_POST['address']);

		$katva_step = "";
		if (!empty($_POST['katva_step_1'])) { 
			$katva_step = $_POST['katva_step_1'];
			$katva_step = implode(' | ', $katva_step);
		}

		$katva_description = "";
		if (!empty($_POST['katva_description_1'])) { 
			$katva_description = $_POST['katva_description_1'];
			$katva_description = implode(' | ', $katva_description);
		}


		$katva_vulnerability = "";
		if (!empty($_POST['katva_vulnerability_1'])) { 
			$katva_vulnerability = $_POST['katva_vulnerability_1'];
			$katva_vulnerability = implode(' | ', $katva_vulnerability);
		}
		$katva_vulnerability_text = "";
		if (!empty($_POST['katva_vulnerability_text_1'])) { 
			$katva_vulnerability_text = $_POST['katva_vulnerability_text_1'];
			$katva_vulnerability_text = implode(' | ', $katva_vulnerability_text);
		}


		$katva_explanation = "";
		if (!empty($_POST['katva_explanation_1'])) { 
			$katva_explanation = $_POST['katva_explanation_1'];
			$katva_explanation = implode(' | ', $katva_explanation);
		}
		$katva_explanation_option = "";
		if (!empty($_POST['katva_explanation_option_1'])) { 
			$katva_explanation_option = $_POST['katva_explanation_option_1'];
			$katva_explanation_option = implode(' | ', $katva_explanation_option);
		}
		$katva_explanation_comment = "";
		if (!empty($_POST['katva_explanation_comment_1'])) { 
			$katva_explanation_comment = $_POST['katva_explanation_comment_1'];
			$katva_explanation_comment = implode(' | ', $katva_explanation_comment);
		}


		$katva_actionable = "";
		if (!empty($_POST['katva_actionable_1'])) { 
			$katva_actionable = $_POST['katva_actionable_1'];
			$katva_actionable = implode(' | ', $katva_actionable);
		}

		$katva_mitigation = "";
		if (!empty($_POST['katva_mitigation_1'])) { 
			$katva_mitigation = $_POST['katva_mitigation_1'];
			$katva_mitigation = implode(' | ', $katva_mitigation);
		}

		$prepared_by = $_POST['prepared_by'];
		$prepared_date = $_POST['prepared_date'];
		$prepared_type = $_POST['prepared_type'];
		$prepared_signature = $_POST['prepared_signature_default_temp'];
		if ($prepared_type == 1) {
			$prepared_signature = $_POST['prepared_sigData'];
		} else if ($prepared_type == 2) {
			$prepared_file = $_FILES['prepared_file']['name'];
			if (!empty($prepared_file)) {
				$base_tmp = $_FILES['prepared_file']['tmp_name'];
				$base_type = pathinfo($base_tmp, PATHINFO_EXTENSION);
				$base_data = file_get_contents($base_tmp);
				$prepared_signature = 'data:image/' . $base_type . ';base64,' . base64_encode($base_data);
			}
		}

		$reviewed_by = $_POST['reviewed_by'];
		$reviewed_date = $_POST['reviewed_date'];
		$reviewed_type = $_POST['reviewed_type'];
		$reviewed_signature = $_POST['reviewed_signature_default_temp'];
		if ($reviewed_type == 1) {
			$reviewed_signature = $_POST['reviewed_sigData'];
		} else if ($reviewed_type == 2) {
			$reviewed_file = $_FILES['reviewed_file']['name'];
			if (!empty($reviewed_file)) {
				$base_tmp = $_FILES['reviewed_file']['tmp_name'];
				$base_type = pathinfo($base_tmp, PATHINFO_EXTENSION);
				$base_data = file_get_contents($base_tmp);
				$reviewed_signature = 'data:image/' . $base_type . ';base64,' . base64_encode($base_data);
			}
		}

		$approved_by = $_POST['approved_by'];
		$approved_date = $_POST['approved_date'];
		$approved_type = $_POST['approved_type'];
		$approved_signature = $_POST['approved_signature_default_temp'];
		if ($approved_type == 1) {
			$approved_signature = $_POST['approved_sigData'];
		} else if ($approved_type == 2) {
			$approved_file = $_FILES['approved_file']['name'];
			if (!empty($approved_file)) {
				$base_tmp = $_FILES['approved_file']['tmp_name'];
				$base_type = pathinfo($base_tmp, PATHINFO_EXTENSION);
				$base_data = file_get_contents($base_tmp);
				$approved_signature = 'data:image/' . $base_type . ';base64,' . base64_encode($base_data);
			}
		}

		$sql = "INSERT INTO tbl_ffva_katva (user_id, portal_user, product, facility, address, step, description, vulnerability_id, vulnerability_text, explanation_id, explanation_option, explanation_comment, actionable, mitigation, prepared_by, prepared_signature, prepared_date, reviewed_by, reviewed_signature, reviewed_date, approved_by, approved_signature, approved_date, last_modified)
		VALUES ('$user_id', '$portal_user', '$product', '$facility', '$address', '$katva_step', '$katva_description', '$katva_vulnerability', '$katva_vulnerability_text', '$katva_explanation', '$katva_explanation_option', '$katva_explanation_comment', '$katva_actionable', '$katva_mitigation', '$prepared_by', '$prepared_signature', '$prepared_date', '$reviewed_by', '$reviewed_signature', '$reviewed_date', '$approved_by', '$approved_signature', '$approved_date', '$last_modified')";
		if (mysqli_query($conn, $sql)) {
			$last_id = mysqli_insert_id($conn);

			$selectData = mysqli_query( $conn,'SELECT * FROM tbl_ffva_katva WHERE user_id="'. $user_id .'" AND ID="'. $last_id .'" ORDER BY ID LIMIT 1' );
			if ( mysqli_num_rows($selectData) > 0 ) {
				$rowData = mysqli_fetch_array($selectData);
				$data_ID = $rowData['ID'];
				$data_product = $rowData['product'];
				$data_facility = $rowData['facility'];
				$data_address = $rowData['address'];

				$output = array(
					"ID" => $data_ID,
					"product" => $data_product,
					"facility" => $data_facility,
					"address" => $data_address,
					"status" => 'Pending'
				);

				echo json_encode($output);
			}
		}
	}
	if( isset($_POST['btnUpdateKatva_FFVA']) ) {
		$ID = $_POST['ID'];

		$product = addslashes($_POST['product']);
		$facility = addslashes($_POST['facility']);
		$address = addslashes($_POST['address']);
		$path = 'uploads/ffva/';
		$random = rand(1000,1000000);

		$katva_step = "";
		if (!empty($_POST['katva_step_2'])) { 
			$katva_step = $_POST['katva_step_2'];
			$katva_step = implode(' | ', $katva_step);
		}

		$katva_description = "";
		if (!empty($_POST['katva_description_2'])) { 
			$katva_description = $_POST['katva_description_2'];
			$katva_description = implode(' | ', $katva_description);
		}


		$katva_vulnerability = "";
		if (!empty($_POST['katva_vulnerability_2'])) { 
			$katva_vulnerability = $_POST['katva_vulnerability_2'];
			$katva_vulnerability = implode(' | ', $katva_vulnerability);
		}
		$katva_vulnerability_text = "";
		if (!empty($_POST['katva_vulnerability_text_2'])) { 
			$katva_vulnerability_text = $_POST['katva_vulnerability_text_2'];
			$katva_vulnerability_text = implode(' | ', $katva_vulnerability_text);
		}


		$katva_explanation = "";
		if (!empty($_POST['katva_explanation_2'])) { 
			$katva_explanation = $_POST['katva_explanation_2'];
			$katva_explanation = implode(' | ', $katva_explanation);
		}
		$katva_explanation_option = "";
		if (!empty($_POST['katva_explanation_option_2'])) { 
			$katva_explanation_option = $_POST['katva_explanation_option_2'];
			$katva_explanation_option = implode(' | ', $katva_explanation_option);
		}
		$katva_explanation_comment = "";
		if (!empty($_POST['katva_explanation_comment_2'])) { 
			$katva_explanation_comment = $_POST['katva_explanation_comment_2'];
			$katva_explanation_comment = implode(' | ', $katva_explanation_comment);
		}


		$katva_actionable = "";
		if (!empty($_POST['katva_actionable_2'])) { 
			$katva_actionable = $_POST['katva_actionable_2'];
			$katva_actionable = implode(' | ', $katva_actionable);
		}

		$katva_mitigation = "";
		if (!empty($_POST['katva_mitigation_2'])) { 
			$katva_mitigation = $_POST['katva_mitigation_2'];
			$katva_mitigation = implode(' | ', $katva_mitigation);
		}


		$prepared_by = $_POST['prepared_by'];
		$prepared_date = $_POST['prepared_date'];
		$prepared_type = $_POST['prepared_type'];
		$prepared_signature = $_POST['prepared_signature_temp'];
		if ($prepared_type == 1) {
			$prepared_signature = $_POST['prepared_sigData'];
		} else if ($prepared_type == 2) {
			$prepared_file = $_FILES['prepared_file']['name'];
			if (!empty($prepared_file)) {
				$base_tmp = $_FILES['prepared_file']['tmp_name'];
				$base_type = pathinfo($base_tmp, PATHINFO_EXTENSION);
				$base_data = file_get_contents($base_tmp);
				$prepared_signature = 'data:image/' . $base_type . ';base64,' . base64_encode($base_data);
			}
		}

		$reviewed_by = $_POST['reviewed_by'];
		$reviewed_date = $_POST['reviewed_date'];
		$reviewed_type = $_POST['reviewed_type'];
		$reviewed_signature = $_POST['reviewed_signature_temp'];
		if ($reviewed_type == 1) {
			$reviewed_signature = $_POST['reviewed_sigData'];
		} else if ($reviewed_type == 2) {
			$reviewed_file = $_FILES['reviewed_file']['name'];
			if (!empty($reviewed_file)) {
				$base_tmp = $_FILES['reviewed_file']['tmp_name'];
				$base_type = pathinfo($base_tmp, PATHINFO_EXTENSION);
				$base_data = file_get_contents($base_tmp);
				$reviewed_signature = 'data:image/' . $base_type . ';base64,' . base64_encode($base_data);
			}
		}

		$approved_by = $_POST['approved_by'];
		$approved_date = $_POST['approved_date'];
		$approved_type = $_POST['approved_type'];
		$approved_signature = $_POST['approved_signature_temp'];
		if ($approved_type == 1) {
			$approved_signature = $_POST['approved_sigData'];
		} else if ($approved_type == 2) {
			$approved_file = $_FILES['approved_file']['name'];
			if (!empty($approved_file)) {
				$base_tmp = $_FILES['approved_file']['tmp_name'];
				$base_type = pathinfo($base_tmp, PATHINFO_EXTENSION);
				$base_data = file_get_contents($base_tmp);
				$approved_signature = 'data:image/' . $base_type . ';base64,' . base64_encode($base_data);
			}
		}

		mysqli_query( $conn,"UPDATE tbl_ffva_katva set product='". $product ."', facility='". $facility ."', address='". $address ."', step='". $katva_step ."', description='". $katva_description ."', vulnerability_id='". $katva_vulnerability ."', vulnerability_text='". $katva_vulnerability_text ."', explanation_id='". $katva_explanation ."', explanation_option='". $katva_explanation_option ."', explanation_comment='". $katva_explanation_comment ."', actionable='". $katva_actionable ."', mitigation='". $katva_mitigation ."', prepared_by='". $prepared_by ."', prepared_signature='". $prepared_signature ."', prepared_date='". $prepared_date ."', reviewed_by='". $reviewed_by ."', reviewed_signature='". $reviewed_signature ."', reviewed_date='". $reviewed_date ."', approved_by='". $approved_by ."', approved_signature='". $approved_signature ."', approved_date='". $approved_date ."' WHERE ID='". $ID ."'" );
		
		if (!mysqli_error($conn)) {

			$selectData = mysqli_query( $conn,'SELECT * FROM tbl_ffva_katva WHERE ID="'. $ID .'" ORDER BY ID LIMIT 1' );
			if ( mysqli_num_rows($selectData) > 0 ) {
				$rowData = mysqli_fetch_array($selectData);
				$data_ID = $rowData['ID'];
				$data_product = $rowData['product'];
				$data_facility = $rowData['facility'];
				$data_address = $rowData['address'];

				$output = array(
					"ID" => $data_ID,
					"product" => $data_product,
					"facility" => $data_facility,
					"address" => $data_address,
					"status" => 'Pending'
				);

				echo json_encode($output);
			}
		}
	}
	
	
	// CUSTOMER PAGE
    function formatSizeUnits($bytes) {
        if ($bytes >= 1073741824) {
            $bytes = number_format($bytes / 1073741824, 2) . ' GB';
        } elseif ($bytes >= 1048576) {
            $bytes = number_format($bytes / 1048576, 2) . ' MB';
        } elseif ($bytes >= 1024) {
            $bytes = number_format($bytes / 1024, 2) . ' KB';
        } elseif ($bytes > 1) {
            $bytes = $bytes . ' bytes';
        } elseif ($bytes == 1) {
            $bytes = $bytes . ' byte';
        } else {
            $bytes = '0 bytes';
        }

        return $bytes;
    }
	if( isset($_GET['modalView_Customer']) ) {
		$id = $_GET['modalView_Customer'];
		$current_userID = $_COOKIE['ID'];
        $current_userEmployerID = employerID($current_userID);

        $current_client = 0;
        if (isset($_COOKIE['client'])) { $current_client = $_COOKIE['client']; }

		if (!empty($_COOKIE['switchAccount'])) {
			$portal_user = $_COOKIE['ID'];
			$user_id = $_COOKIE['switchAccount'];
		}
		else {
			$portal_user = $_COOKIE['ID'];
			$user_id = employerID($portal_user);
		}
		
    	$current_dateNow_o = date('Y/m/d');
        $current_dateNow = new DateTime($current_dateNow_o);
        $current_dateNow = $current_dateNow->format('M d, Y');

		$selectData = mysqli_query( $conn,"SELECT * FROM tbl_supplier WHERE ID = $id" );
		if ( mysqli_num_rows($selectData) > 0 ) {
            $row = mysqli_fetch_array($selectData);
            $user_account_id = $row["user_id"];
            $page = $row["page"];
            $category = $row["category"];
            $industry = $row["industry"];

            $address = $row["address"];
            $address_arr = explode(" | ", $address);
            if (COUNT($address_arr) < 5) {
                $address_arr = explode(", ", $address);
            }

            $document = $row["document"];
			$document_arr = explode(" | ", $document);
			if (count($document_arr) <= 1) {
				$document_arr = explode(", ", $document);
			}

            $document_other = $row["document_other"];
			$document_other_arr = explode(" | ", $document_other);
			if (count($document_other_arr) <= 1 ) {
				$document_other_arr = explode(", ", $document_other);
			}

			$contact = $row["contact"];
			$material = $row["material"];
			$service = $row["service"];

            $audit_report = $row["audit_report"];
			$audit_report_arr = explode(" | ", $audit_report);

            $audit_certificate = $row["audit_certificate"];
			$audit_certificate_arr = explode(" | ", $audit_certificate);

            $audit_action = $row["audit_action"];
			$audit_action_arr = explode(" | ", $audit_action);

            $audit = $row["audit"];
            $reviewed_by = $row["reviewed_by"];
            $reviewed_date = $row["reviewed_date"];
            $reviewed_due = $row["reviewed_due"];

            $frequency = $row["frequency"];
            $frequency_custom = $row["frequency_custom"];
			$frequency_custom_arr = explode(" | ", $frequency_custom);

            $department_id = $row["department_id"];
            if (!empty($department_id)) { $department_id_arr = explode(", ", $department_id); }
			
            $employee_id = $row["employee_id"];
            if (!empty($employee_id)) { $employee_id_arr = explode(", ", $employee_id); }
			
            if ($page == 1) {
            	$selectUser = mysqli_query( $conn,'SELECT * FROM tbl_user WHERE ID="'. $user_account_id .'" ORDER BY ID LIMIT 1' );
	            $rowUser = mysqli_fetch_array($selectUser);
	            $name = $rowUser['first_name'] .' '. $rowUser['last_name'];
	            $enterprise_name = "";

	            $selectCategory = mysqli_query( $conn,"SELECT * FROM tbl_supplier_category WHERE ID = $category" );
                $rowCategory = mysqli_fetch_array($selectCategory);
                $enterprise_category = $rowCategory["name"];

                $selectIndustry = mysqli_query( $conn,"SELECT * FROM tbl_supplier_industry WHERE ID = $industry" );
	            $rowIndustry = mysqli_fetch_array($selectIndustry);
                $enterprise_industry = $rowIndustry["name"];

	            $enterprise_bldg = "";
	            $enterprise_city = "";
	            $enterprise_state = "";
	            $enterprise_zip = "";
	            $enterprise_email = "";
	            $enterprise_phone = "";
	            $enterprise_fax = "";
	            $enterprise_website = "";
				$selectEnterprise = mysqli_query( $conn,"SELECT * FROM tblEnterpiseDetails WHERE users_entities = $user_account_id" );
				if ( mysqli_num_rows($selectEnterprise) > 0 ) {
				    $rowEnterprise = mysqli_fetch_array($selectEnterprise);
				    $enterprise_name = $rowEnterprise["businessname"];
				    $enterprise_bldg = $rowEnterprise["Bldg"];
				    $enterprise_city = $rowEnterprise["city"];
				    $enterprise_state = $rowEnterprise["States"];
				    $enterprise_zip = $rowEnterprise["ZipCode"];

				    $enterprise_country = $rowEnterprise["country"];
				    $selectCountry = mysqli_query( $conn,"SELECT * FROM countries WHERE id = $enterprise_country" );
				    $rowCountry =mysqli_fetch_array($selectCountry);
				    $enterprise_country = $rowCountry["name"];

				    $enterprise_email = $rowEnterprise["businessemailAddress"];
				    $enterprise_phone = $rowEnterprise["businesstelephone"];
				    $enterprise_fax = $rowEnterprise["businessfax"];
				    $enterprise_website = $rowEnterprise["businesswebsite"];
				}
            }
        }

        echo '<input class="form-control" type="hidden" name="ID" value="'.$id.'" />
        <div class="tabbable tabbable-tabdrop">
            <ul class="nav nav-tabs">';

            	if ($page == 1) {
            		echo '<li class="active">
	                    <a href="#tabDocuments_2" data-toggle="tab">Requirements</a>
	                </li>
	                <li>
	                    <a href="#tabBasic_2" data-toggle="tab">Details</a>
	                </li>
	                <li>
	                    <a href="#tabContact_2" data-toggle="tab">Contacts</a>
	                </li>
	                <li class="tabProducts '; echo $category == 3 ? 'hide':''; echo '">
	                    <a href="#tabProduct_2" data-toggle="tab">Products</a>
	                </li>
	                <li class="tabService '; echo $category == 3 ? '':'hide'; echo '">
	                    <a href="#tabService_2" data-toggle="tab">Services</a>
	                </li>
	                <li>
	                    <a href="#tabAuditReview_2" data-toggle="tab">Audit & Review</a>
	                </li>';
            	} else {
            		echo '<li class="active">
	                    <a href="#tabBasic_2" data-toggle="tab">Details</a>
	                </li>
	                <li>
	                    <a href="#tabContact_2" data-toggle="tab">Contacts</a>
	                </li>
	                <li>
	                    <a href="#tabDocuments_2" data-toggle="tab">Requirements</a>
	                </li>
	                <li class="tabProducts '; echo $category == 3 ? 'hide':''; echo '">
	                    <a href="#tabProduct_2" data-toggle="tab">Products</a>
	                </li>
	                <li class="tabService '; echo $category == 3 ? '':'hide'; echo '">
	                    <a href="#tabService_2" data-toggle="tab">Services</a>
	                </li>
	                <li>
	                    <a href="#tabAuditReview_2" data-toggle="tab">Audit & Review</a>
	                </li>';
            	}

                if ($user_id == 27 || $user_id == 34 || $user_id == 464 || $user_id == 504 || $user_id == 475 || $user_id == 683) {
                	echo '<li><a href="#tabPortal_2" data-toggle="tab">Portal</a></li>';
                    echo '<li><a href="#tabUsage_2" data-toggle="tab">Usage</a></li>';
                }
                
                echo '<li class="hide">
                    <a href="#tabFSVP_2" data-toggle="tab">FSVP</a>
                </li>
            </ul>
            <div class="tab-content margin-top-20">
                <div class="tab-pane '; echo $page == 1 ? '':'active'; echo '" id="tabBasic_2">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="control-label">Customer Name</label>
                                <input class="form-control '; echo $page == 1 ? 'hide':''; echo '" type="text" name="name" value="'.$row["name"].'" required />';

                                if ($page == 1) { echo '<input class="form-control" type="text" value="'.$enterprise_name.'" readonly disabled />'; }
                                
                            echo '</div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="control-label">Category</label>
                                <select class="form-control '; echo $page == 1 ? 'hide':''; echo '" name="category" onchange="changedCategory(this)" required>
                                    <option value="">Select</option>';
                                    
                                        $selectCategory = mysqli_query( $conn,"SELECT * FROM tbl_supplier_category WHERE deleted = 0 AND FIND_IN_SET($current_client, REPLACE(client, ' ', '')) ORDER BY name" );
                                        if ( mysqli_num_rows($selectCategory) > 0 ) {
                                            while($rowCategory = mysqli_fetch_array($selectCategory)) {
                                                echo '<option value="'.$rowCategory["ID"].'" '; echo $category == $rowCategory["ID"] ? 'SELECTED':''; echo'>'.$rowCategory["name"].'</option>';
                                            }
                                        }
                                   	
                                echo '</select>';

                                if ($page == 1) { echo '<input class="form-control" type="text" value="'.$enterprise_category.'" readonly />'; }
                                
                            echo '</div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="control-label">Industry</label>
                                <select class="form-control '; echo $page == 1 ? 'hide':''; echo '" name="industry" onchange="changeIndustry(this.value, 2)" required>
                                    <option value="">Select</option>';
                                    
                                        $selectIndustry = mysqli_query( $conn,"SELECT * FROM tbl_supplier_industry WHERE deleted = 0 AND FIND_IN_SET($current_client, REPLACE(client, ' ', '')) ORDER BY name" );
                                        if ( mysqli_num_rows($selectIndustry) > 0 ) {
                                            while($rowIndustry = mysqli_fetch_array($selectIndustry)) {
                                                echo '<option value="'.$rowIndustry["ID"].'" '; echo $industry == $rowIndustry["ID"] ? 'SELECTED':''; echo'>'.$rowIndustry["name"].'</option>';
                                            }
                                        }
                                    
                                echo '</select>';

                                if ($page == 1) { echo '<input class="form-control" type="text" value="'.$enterprise_industry.'" readonly />'; }
                                
                            echo '</div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="control-label">Country</label>
                                <select class="form-control '; echo $page == 1 ? 'hide':''; echo '" name="countries" onchange="changeCountry(2)" required>
                                    <option value="US" '; echo  $address_arr[0] == "US" ? 'SELECTED':''; echo '>United States of America</option>';

                                    $selectCountry = mysqli_query( $conn,"SELECT * FROM countries WHERE iso2 <> 'US'" );
		                            while($rowCountry = mysqli_fetch_array($selectCountry)) {
		                            	echo '<option value="'.$rowCountry["iso2"].'" '; echo  $address_arr[0] == $rowCountry["iso2"] ? 'SELECTED':''; echo '>'.$rowCountry["name"].'</option>';
		                            }

                                echo '</select>';

                                if ($page == 1) { echo '<input class="form-control" type="text" value="'.$enterprise_country.'" readonly />'; }
	                            
                            echo '</div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="control-label">Bldg No./Street</label>
                                <input class="form-control '; echo $page == 1 ? 'hide':''; echo '" type="text" name="address_street" value="'. $address_arr[1] .'" required />';

                                if ($page == 1) { echo '<input class="form-control" type="text" value="'.$enterprise_bldg.'" readonly disabled />'; }
                                
                            echo '</div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="control-label">City</label>
                                <input class="form-control '; echo $page == 1 ? 'hide':''; echo '" type="text" name="address_city" value="'. $address_arr[2] .'" required />';

                                if ($page == 1) { echo '<input class="form-control" type="text" value="'.$enterprise_city.'" readonly disabled />'; }
                                
                            echo '</div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="control-label">State</label>
                                <input class="form-control '; echo $page == 1 ? 'hide':''; echo '" type="text" name="address_state" value="'. $address_arr[3] .'" required />';

                                if ($page == 1) { echo '<input class="form-control" type="text" value="'.$enterprise_state.'" readonly disabled />'; }
                                
                            echo '</div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="control-label">Zip Code</label>
                                <input class="form-control '; echo $page == 1 ? 'hide':''; echo '" type="text" name="address_code" value="'. $address_arr[4] .'" required />';

                                if ($page == 1) { echo '<input class="form-control" type="text" value="'.$enterprise_zip.'" readonly disabled />'; }
                                
                            echo '</div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="control-label">Email</label>
                                <div class="input-group '; echo $page == 1 ? 'hide':''; echo '">
                                    <input class="form-control" type="email" name="email" value="'.$row["email"].'" required />
                                    <span class="input-group-btn">
                                        <button class="btn purple-seance" type="button" onclick="btnSendInvite('.$id.')">Send Invite</button>
                                    </span>
                                </div>';

                                if ($page == 1) { echo '<input class="form-control" type="text" value="'.$enterprise_email.'" readonly disabled />'; }
                                
                            echo '</div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="control-label">Phone</label>
                                <input class="form-control '; echo $page == 1 ? 'hide':''; echo '" type="text" name="phone" value="'.$row["phone"].'" />';

                                if ($page == 1) { echo '<input class="form-control" type="text" value="'.$enterprise_phone.'" readonly disabled />'; }
                                
                            echo '</div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="control-label">Fax</label>
                                <input class="form-control '; echo $page == 1 ? 'hide':''; echo '" type="text" name="fax" value="'.$row["fax"].'" />';

                                if ($page == 1) { echo '<input class="form-control" type="text" value="'.$enterprise_fax.'" readonly disabled />'; }
                                
                            echo '</div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="control-label">Website</label>
                                <input class="form-control '; echo $page == 1 ? 'hide':''; echo '" type="text" name="website" value="'.$row["website"].'" />';

                                if ($page == 1) { echo '<input class="form-control" type="text" value="'.$enterprise_website.'" readonly disabled />'; }
                                
                            echo '</div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="control-label">Status</label>
                                <select class="form-control" name="status" '; echo $page == 2 ? '':'readonly'; echo '>
                                    <option value="0" '; echo $row["status"] == 0 ? 'SELECTED':''; echo '>Pending</option>
                                    <option value="1" '; echo $row["status"] == 1 ? 'SELECTED':'';  echo '>Active</option>
                                    <option value="2" '; echo $row["status"] == 2 ? 'SELECTED':'';  echo '>Inactive</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="control-label">Receive Notification?</label>
                                <select class="form-control" name="notification" '; echo $page == 2 ? '':'readonly'; echo '>
                                    <option value="0" '; echo $row["notification"] == 0 ? 'SELECTED':''; echo '>No</option>
                                    <option value="1" '; echo $row["notification"] == 1 ? 'SELECTED':''; echo '>Yes</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3 '; echo $user_id == 1211 ? '':'hide'; echo '">
                            <div class="form-group">
                                <label class="control-label">With NDA?</label>
                                <select class="form-control" name="nda" '; echo $page == 1 ? '':''; echo '>
                                    <option value="0" '; echo $row["nda"] == 0 ? 'SELECTED':''; echo '>No</option>
                                    <option value="1" '; echo $row["nda"] == 1 ? 'SELECTED':''; echo '>Yes</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="control-label">Frequency</label>
                                <select class="form-control" name="supplier_frequency" onchange="changeFrequency(this.value)">
                                    <option value="1" '; echo $frequency == 1 ? 'SELECTED':''; echo '>Once Per Day</option>
                                    <option value="2" '; echo $frequency == 2 ? 'SELECTED':''; echo '>Once Per Week</option>
                                    <option value="3" '; echo $frequency == 3 ? 'SELECTED':''; echo '>On the 1st and 15th of the Month</option>
                                    <option value="4" '; echo $frequency == 4 ? 'SELECTED':''; echo '>Once Per Month</option>
                                    <option value="6" '; echo $frequency == 6 ? 'SELECTED':''; echo '>Once Per Two Months (Every Other Month)</option>
                                    <option value="7" '; echo $frequency == 7 ? 'SELECTED':''; echo '>Once Per Three Months (Quarterly)</option>
                                    <option value="8" '; echo $frequency == 8 ? 'SELECTED':''; echo '>Once Per Six Months (Bi-Annual)</option>
                                    <option value="5" '; echo $frequency == 5 ? 'SELECTED':''; echo '>Once Per Year</option>
                                </select>
                            </div>
                        </div>
                    </div>
					<div class="row">
						<div class="col-md-3 bg-default '; echo $frequency == 0 ? '':'hide'; echo '">
							<div class="form-group">
								<label class="control-label">Minute</label>
								<select class="form-control selectpicker" name="supplier_frequency_minute" data-live-search="true" data-size="8">
									<optgroup label="Common Settings">
										<option value="*" '; echo $frequency_custom_arr[0] == "*" ? 'SELECTED':''; echo '>Once Per Minute</option>
										<option value="*/2" '; echo $frequency_custom_arr[0] == "*/2" ? 'SELECTED':''; echo '>Once Per Two Minutes</option>
										<option value="*/5" '; echo $frequency_custom_arr[0] == "*/5" ? 'SELECTED':''; echo '>Once Per Five Minutes</option>
										<option value="*/10" '; echo $frequency_custom_arr[0] == "*/10" ? 'SELECTED':''; echo '>Once Per Ten Minutes</option>
										<option value="*/15" '; echo $frequency_custom_arr[0] == "*/15" ? 'SELECTED':''; echo '>Once Per Fifteen Minutes</option>
										<option value="0,30" '; echo $frequency_custom_arr[0] == "0,30" ? 'SELECTED':''; echo '>Once Per Thirty Minutes</option>
									</optgroup>
									<optgroup label="Minutes">
										<option value="0" '; echo $frequency_custom_arr[0] == 0 ? 'SELECTED':''; echo '>:00 (At the beginning of the hour)</option>';

											for ($i=1; $i < 60; $i++) { 
												echo '<option value="'.$i.'" '; echo $frequency_custom_arr[0] == $i ? 'SELECTED':''; echo '>:'.sprintf("%02d", $i).'</option>';
											}

									echo '</optgroup>
								</select>
							</div>
						</div>
						<div class="col-md-3 bg-default '; echo $frequency == 0 ? '':'hide'; echo '">
							<div class="form-group">
								<label class="control-label">Hour</label>
								<select class="form-control selectpicker" name="supplier_frequency_hour" data-live-search="true" data-size="8">
									<optgroup label="Common Settings">
										<option value="*" '; echo $frequency_custom_arr[1] == "*" ? 'SELECTED':''; echo '>Every Hour</option>
										<option value="*/2" '; echo $frequency_custom_arr[1] == "*/2" ? 'SELECTED':''; echo '>Every Other Hour</option>
										<option value="*/3" '; echo $frequency_custom_arr[1] == "*/3" ? 'SELECTED':''; echo '>Every Third Hour</option>
										<option value="*/4" '; echo $frequency_custom_arr[1] == "*/4" ? 'SELECTED':''; echo '>Every Fourth Hour</option>
										<option value="*/6" '; echo $frequency_custom_arr[1] == "*/6" ? 'SELECTED':''; echo '>Every Sixth Hour</option>
										<option value="0,12" '; echo $frequency_custom_arr[1] == "0,12" ? 'SELECTED':''; echo '>Every Twelve Hours</option>
									</optgroup>
									<optgroup label="Hours">';

											for ($i=1; $i < 12; $i++) { 
												echo '<option value="'.$i.'" '; echo $frequency_custom_arr[1] == $i ? 'SELECTED':''; echo '>'.date("h:i A", strtotime($i.":00")).'</option>';
											}
											echo '<option value="12" '; echo $frequency_custom_arr[1] == 12 ? 'SELECTED':''; echo '>12:00 PM Noon</option>';
											for ($i=13; $i < 24; $i++) { 
												echo '<option value="'.$i.'" '; echo $frequency_custom_arr[1] == $i ? 'SELECTED':''; echo '>'.date("h:i A", strtotime($i.":00")).'</option>';
											}

										echo '<option value="24">12:00 AM Midnight</option>
									</optgroup>
								</select>
							</div>
						</div>
                        <div class="col-md-3 bg-default '; echo $frequency == 0 ? '':'hide'; echo '">
                            <div class="form-group">
                                <label class="control-label">Day</label>
                                <select class="form-control selectpicker" name="supplier_frequency_day" data-live-search="true" data-size="8">
                                    <optgroup label="Common Settings">
                                        <option value="*" '; echo $frequency_custom_arr[2] == "*" ? 'SELECTED':''; echo '>Every Day</option>
                                        <option value="*/2" '; echo $frequency_custom_arr[2] == "*/2" ? 'SELECTED':''; echo '>Every Other Day</option>
                                        <option value="1,15" '; echo $frequency_custom_arr[2] == "1,15" ? 'SELECTED':''; echo '>On the 1st and 15th of the Month</option>
                                    </optgroup>
                                    <optgroup label="Days">';

                                            function addOrdinalNumberSuffix($num) {
                                                if (!in_array(($num % 100),array(11,12,13))){
                                                    switch ($num % 10) {
                                                        // Handle 1st, 2nd, 3rd
                                                        case 1:  return $num.'st';
                                                        case 2:  return $num.'nd';
                                                        case 3:  return $num.'rd';
                                                    }
                                                }
                                                return $num.'th';
                                            }
                                            for ($i = 1; $i <= 31; $i++){
                                                echo '<option value="'.$i.'" '; echo $frequency_custom_arr[2] == $i ? 'SELECTED':''; echo '>'.addOrdinalNumberSuffix($i).'</option>';
                                            }

                                    echo '</optgroup>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3 bg-default '; echo $frequency == 0 ? '':'hide'; echo '">
                            <div class="form-group">
                                <label class="control-label">Month</label>
                                <select class="form-control selectpicker" name="supplier_frequency_month" data-live-search="true" data-size="8">
                                    <optgroup label="Common Settings">
                                        <option value="*" '; echo $frequency_custom_arr[3] == "*" ? 'SELECTED':''; echo '>Every Month</option>
                                        <option value="*/2" '; echo $frequency_custom_arr[3] == "*/2" ? 'SELECTED':''; echo '>Every Other Month</option>
                                        <option value="*/4" '; echo $frequency_custom_arr[3] == "*/4" ? 'SELECTED':''; echo '>Every Third Month</option>
                                        <option value="1,7" '; echo $frequency_custom_arr[3] == "1,7" ? 'SELECTED':''; echo '>Every Six Months</option>
                                    </optgroup>
                                    <optgroup label="Months">';

                                            for ($i = 1; $i <= 12; $i++){
                                                echo '<option value="'.$i.'" '; echo $frequency_custom_arr[3] == $i ? 'SELECTED':''; echo '>'.date("F", mktime(0, 0, 0, $i, 10)).'</option>';
                                            }

                                    echo '</optgroup>
                                </select>
                            </div>
                        </div>
					</div>
					<div class="row">
						<div class="col-md-3 bg-default '; echo $frequency == 0 ? '':'hide'; echo '">
							<div class="form-group">
								<label class="control-label">Weekday</label>
								<select class="form-control selectpicker" name="supplier_frequency_weekday" data-live-search="true" data-size="8">
									<optgroup label="Common Settings">
										<option value="*" '; echo $frequency_custom_arr[4] == "*" ? 'SELECTED':''; echo '>Every Day</option>
										<option value="1-5" '; echo $frequency_custom_arr[4] == "1-5" ? 'SELECTED':''; echo '>Every Weekday</option>
										<option value="6,7" '; echo $frequency_custom_arr[4] == "6,7" ? 'SELECTED':''; echo '>Every Weekend Day</option>
										<option value="1,3,5" '; echo $frequency_custom_arr[4] == "1,3,5" ? 'SELECTED':''; echo '>Every Monday, Wednesday, and Friday</option>
										<option value="2,4" '; echo $frequency_custom_arr[4] == "2,4" ? 'SELECTED':''; echo '>Every Tuesday and Thursday</option>
									</optgroup>
									<optgroup label="Weekdays">';

											$days = [
												1 => 'Monday',
												2 => 'Tuesday',
												3 => 'Wednesday',
												4 => 'Thursday',
												5 => 'Friday',
												6 => 'Saturday',
												7 => 'Sunday'
											];
											for ($i = 1; $i <= 7; $i++){
												echo '<option value="'.$i.'" '; echo $frequency_custom_arr[4] == $i ? 'SELECTED':''; echo '>'.$days[$i].'</option>';
											}

									echo '</optgroup>
								</select>
							</div>
						</div>
					</div>
                </div>
                <div class="tab-pane" id="tabContact_2">
                    <a href="#modalNewContact" data-toggle="modal" class="btn green" onclick="btnNew_Contact('.$user_id.', 2, \'btnNew_Contact\')">Add New Contact</a>
                    <div class="table-scrollable">
                        <table class="table table-bordered table-hover" id="tableData_Contact_2">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Title</th>
                                    <th>Address</th>
                                    <th class="text-center" style="width: 145px;">Contact Details</th>
                                    <th class="text-center" style="width: 145px;">Receive Notification?</th>
                                    <th class="text-center hide" style="width: 145px;">Emergency Person</th>
                                    <th class="text-center" style="width: 140px;">Action</th>
                                </tr>
                            </thead>
                            <tbody>';

					            if (!empty($contact)) {
					                $contact_arr = explode(", ", $contact);
					                foreach ($contact_arr as $value) {
					                    $selectContact = mysqli_query( $conn,"SELECT * FROM tbl_supplier_contact WHERE ID=$value" );
					                    if ( mysqli_num_rows($selectContact) > 0 ) {
					                    	while($rowContact = mysqli_fetch_array($selectContact)) {
				                            	$contact_id = $rowContact["ID"];
                                                $contact_notification = $rowContact["notification"];
                                                $contact_name = htmlentities($rowContact["name"] ?? '');
                                                $contact_title = htmlentities($rowContact["title"] ?? '');
                                                $contact_address = htmlentities($rowContact["address"] ?? '');
                                                $contact_email = htmlentities($rowContact["email"] ?? '');
                                                $contact_phone = htmlentities($rowContact["phone"] ?? '');
                                                $contact_cell = htmlentities($rowContact["cell"] ?? '');
                                                $contact_fax = htmlentities($rowContact["fax"] ?? '');

				                                echo '<tr id="tr_'.$contact_id.'">
				                                    <td>'.$contact_name.'</td>
				                                    <td>'.$contact_title.'</td>
				                                    <td>'.$contact_address.'</td>
				                                    <td class="text-center">
				                                    	<ul class="list-inline">';
				                                    	if ($contact_email != "") { echo '<li><a href="mailto:'.$contact_email.'" target="_blank" title="Email"><i class="fa fa-envelope"></i></a></li>'; }
							                            if ($contact_phone != "") { echo '<li><a href="tel:'.$contact_phone.'" target="_blank" title="Phone"><i class="fa fa-phone-square"></i></a></li>'; }
							                            if ($contact_cell != "") { echo '<li><a href="tel:'.$contact_cell.'" target="_blank" title="Cell Number"><i class="fa fa-phone"></i></a></li>'; }
							                            if ($contact_fax != "") { echo '<li><a href="tel:'.$contact_fax.'" target="_blank" title="Fax"><i class="fa fa-print"></i></a></li>'; }
				                                    	echo '</ul>
				                                    </td>
                                                    <td class="text-center"><input type="checkbox" name="checkedContact" value="'.$contact_id.'" onclick="btnCheck_Contact('.$contact_id.', this)" '; echo $contact_notification == 1 ? 'checked':''; echo '/></td>
					                                <td class="text-center">
					                                    <input type="hidden" class="form-control" name="contact_id[]" value="'.$contact_id.'" readonly />
					                                    <div class="mt-action-buttons">
					                                        <div class="btn-group btn-group-circle">
					                                            <a href="#modalEditContact" data-toggle="modal" class="btn btn-outline dark btn-sm btnEdit_Contact" onclick="btnEdit_Contact('.$contact_id.', 2, \'modalEditContact\')">Edit</a>
					                                            <a href="javascript:;" class="btn btn-outlinex red btn-sm btnRemove_Contact" onclick="btnRemove_Contact('.$contact_id.', 2)">Delete</a>
					                                        </div>
					                                    </div>
					                                </td>
				                                </tr>';
					                    	}
					                    }
					                }
					            }

                            echo '</tbody>
                        </table>
                    </div>
                </div>
                <div class="tab-pane '; echo $page == 1 ? 'active':''; echo '" id="tabDocuments_2">';
                	if ($page == 2) {
	                    echo '<div class="mt-checkbox-list">';
	                        
	                        $selectRequirement2 = mysqli_query( $conn,"SELECT * FROM tbl_supplier_requirement ORDER BY name" );
	                        if ( mysqli_num_rows($selectRequirement2) > 0 ) {
	                            while($rowReq = mysqli_fetch_array($selectRequirement2)) {
	                                echo '<label class="mt-checkbox mt-checkbox-outline '; echo $current_client == 0 ? '':'hide'; echo '"> '.$rowReq["name"].'
	                                    <input type="checkbox" value="'.$rowReq["ID"].'" name="document[]"  onchange="checked_Requirement(this, 2, '.$id.', '; echo in_array($rowReq["ID"], $document_arr) ? '1' : '0'; echo ')" '; echo in_array($rowReq["ID"], $document_arr) ? 'checked' : ''; echo ' />
	                                    <span></span>
	                                </label>';
	                            }
	                        }
	                        if (!empty($document_other)) {
	                        	$count_other = 0;
	                        	foreach ($document_other_arr as $value) {
                                    $selectDocument = mysqli_query( $conn,"SELECT * FROM tbl_supplier_document WHERE user_id = $user_id AND supplier_id = $id AND type = 1 AND name = '".$value."'" );
                                    if ( mysqli_num_rows($selectDocument) > 0 ) {
                                        $rowDocument = mysqli_fetch_array($selectDocument);
                                        $doc_id = $rowDocument["ID"];

    	                        		echo '<label class="mt-checkbox mt-checkbox-outline"> '.$value.'
    	                                    <input type="checkbox" value="'.$value.'" name="document_other[]" data-id="o'.$doc_id.'" onchange="checked_RequirementOther(this, 2)" '; echo in_array($value, $document_other_arr) ? 'checked' : ''; echo ' />
    	                                    <span></span>
    	                                </label>';
    	                        	}
                                }
	                        }
	                        
	                    echo '</div>
	                    <div class="form-group">
	                        <label class="control-label">'; echo $current_client == 0 ? 'Other':'Add Requirement'; echo '</label>
	                        <div class="input-group">
	                            <input type="text" class="form-control" name="inputRequirementOther" id="inputRequirementOther_2" placeholder="Specify">
	                            <span class="input-group-btn">
	                                <button class="btn btn-success" type="button" onclick="btnNew_Requirement(2)">Add</button>
	                            </span>
	                        </div>
	                    </div>';
	                }

                    echo '<div class="table-scrollable">
                        <table class="table table-bordered table-hover" id="tableData_Requirement_2">
                            <thead class="bg-blue-ebonyclay bg-font-blue-ebonyclay">
                                <tr>
                                    <th style="width: 300px;">Requirements</th>
                                    <th style="width: 165px;" class="text-center">Document</th>
                                    <th>File Name</th>
                                    <th style="width: 250px;" class="text-center">Document Validity Period</th>
                                    <th style="width: 165px;" class="text-center '; echo $current_client == 0 ? '':'hide'; echo '">Template</th>
                                    <th style="width: 165px;" class="text-center">Compliance</th>
                                </tr>
                            </thead>
                            <tbody>';
                            	$compliance = 0;
                            	$compliance_counter = 0;
                            	$compliance_approved = 0;

                            	if (!empty($document)) {
                            		$selectRequirement = mysqli_query( $conn,"SELECT * FROM tbl_supplier_requirement ORDER BY name" );
				                    while($rowRequirement = mysqli_fetch_array($selectRequirement)) {
				                    	$req_id = $rowRequirement["ID"];
				                    	$req_name = $rowRequirement["name"];

				                        foreach ($document_arr as $value) {
				                            if ( $value == $req_id ) {
				                            	$selectDocument = mysqli_query( $conn,"SELECT * FROM tbl_supplier_document WHERE user_id='".$user_id."' AND supplier_id='".$id."' AND name='".$req_id."'" );
				                            	if ( mysqli_num_rows($selectDocument) > 0 ) {
				                            		$rowDocument = mysqli_fetch_array($selectDocument);
				                            		$doc_id = $rowDocument["ID"];
				                            		$doc_file = $rowDocument["file"];
				                            		$doc_filetype = $rowDocument["filetype"];
				                            		$doc_filename = $rowDocument["filename"];
				                            		$doc_file_template = $rowDocument["template"];
				                            		$doc_file_comment = $rowDocument["comment"];
				                            		$doc_file_reviewed = $rowDocument["reviewed_by"];
				                            		$doc_file_approved = $rowDocument["approved_by"];

				                            		$doc_file_date = $rowDocument["file_date"];
				                            		if (!empty($doc_file_date)) {
						                                $doc_file_date = new DateTime($doc_file_date);
						                                $doc_file_date_o = $doc_file_date->format('Y/m/d');
						                                $doc_file_date = $doc_file_date->format('m/d/Y');
				                            		}

				                            		$doc_file_due = $rowDocument["file_due"];
				                            		if (!empty($doc_file_due)) {
						                                $doc_file_due = new DateTime($doc_file_due);
						                                $doc_file_due_o = $doc_file_due->format('Y/m/d');
        												$doc_file_due_o_nearly = date('Y/m/d', strtotime($doc_file_due_o. ' - 30 days'));
						                                $doc_file_due = $doc_file_due->format('m/d/Y');
				                            		};

				                            		$compliance_counter++;

									            	echo '<tr class="tr_'.$req_id.'">
									                    <td rowspan="2">
                                                            <input type="hidden" class="form-control" name="document_name[]" value="'.$req_id.'" required />';

                                                            $doc_stat = '';
                                                            if (!empty($doc_file_date) AND !empty($doc_file_due)) {
                                                                if ($doc_file_date_o < $current_dateNow_o && $doc_file_due_o < $current_dateNow_o) {
                                                                    $doc_stat = 'text-danger';
                                                                } else {
                                                                    if ($doc_file_date_o <= $current_dateNow_o && $doc_file_due_o_nearly <= $current_dateNow_o) {
                                                                        $doc_stat = 'text-warning';
                                                                    }
                                                                }
                                                            }

                                                            echo '<b class="'.$doc_stat.'">'.$req_name.'</b>
                                                        </td>
                                                        <td class="text-center">';
                                                            if (!empty($doc_file)) {
                                                                $type = 'iframe';
                                                                if ($doc_filetype == 1) {
                                                                    $fileExtension = fileExtension($doc_file);
                                                                    $src = $fileExtension['src'];
                                                                    $embed = $fileExtension['embed'];
                                                                    $type = $fileExtension['type'];
                                                                    $file_extension = $fileExtension['file_extension'];
                                                                    $url = $base_url.'uploads/supplier/';

                                                                    $doc_file = $src.$url.rawurlencode($doc_file).$embed;
                                                                } else {
                                                                    $doc_file = preg_replace('#[^/]*$#', '', $doc_file).'preview';
                                                                }

                                                                echo '<select class="form-control '; echo !empty($doc_file) ? 'hide':''; echo '" name="document_filetype[]" onchange="changeType(this)" required>
                                                                    <option value="0">Select option</option>
                                                                    <option value="1">Manual Upload</option>
                                                                    <option value="2">Youtube URL</option>
                                                                    <option value="3">Google Drive URL</option>
                                                                </select>
                                                                <input class="form-control margin-top-15 fileUpload" type="file" name="document_file[]" onchange="changeFile(this, this.value)" style="display: none;" />
                                                                <input class="form-control margin-top-15 fileURL" type="url" name="document_fileurl[]" style="display: none;" placeholder="https://" />
                                                                <p class="'; echo !empty($doc_file) ? '':'hide'; echo '" style="margin: 0;"><a href="'.$doc_file.'" data-src="'.$doc_file.'" data-fancybox data-type="'.$type.'" class="btn btn-sm btn-info">View</a> | <button type="button" class="btn btn-sm red-haze uploadNew" onclick="uploadNew(this)">Upload</button></p>';
                                                            } else {
                                                                echo '<select class="form-control hide" name="document_filetype[]" onchange="changeType(this)" required>
                                                                    <option value="0">Select option</option>
                                                                    <option value="1">Manual Upload</option>
                                                                    <option value="2">Youtube URL</option>
                                                                    <option value="3">Google Drive URL</option>
                                                                </select>
                                                                <input class="form-control margin-top-15 fileUpload" type="file" name="document_file[]" onchange="changeFile(this, this.value)" style="display: none;" />
                                                                <input class="form-control margin-top-15 fileURL" type="url" name="document_fileurl[]" style="display: none;" placeholder="https://" />
                                                                <p style="margin: 0;"><button type="button" class="btn btn-sm red-haze uploadNew" onclick="uploadNew(this)">Upload</button></p>';
                                                            }
                                                        echo '</td>
                                                        <td>';

                                                            if (!empty($doc_filename)) {
                                                                echo '<input type="text" class="form-control document_filename" name="document_filename[]" value="'.$doc_filename.'" placeholder="Document Name" />
                                                                <p class="hide" style="margin: 0;">'.$doc_filename.'</p>';
                                                            } else {
                                                                echo '<input type="text" class="form-control document_filename" name="document_filename[]" placeholder="Document Name" />';
                                                            }
                                                            
                                                        echo '</td>
                                                        <td class="text-center">
                                                            <div class="input-group">
                                                                <input type="text" class="form-control daterange '; if (empty($doc_file_date) || empty($doc_file_due)) { echo 'daterange_empty'; } echo '" name="document_daterange[]" value="'; if (!empty($doc_file_date) && !empty($doc_file_due)) { echo $doc_file_date .' - '. $doc_file_due; } echo '" />
                                                                <span class="input-group-btn">
                                                                    <button class="btn default date-range-toggle" type="button" onclick="widget_date_clears(this)">
                                                                        <i class="fa fa-close"></i>
                                                                    </button>
                                                                </span>
                                                            </div>
                                                            <input type="date" class="form-control hide" name="document_date[]" value="'.$doc_file_date.'" />
                                                            <input type="date" class="form-control hide" name="document_due[]" value="'.$doc_file_due.'" />
                                                        </td>
                                                        <td rowspan="2" class="text-center '; echo $current_client == 0 ? '':'hide'; echo '">
                                                            <input type="file" class="form-control hide" name="document_template[]" />';

                                                            $selectTemplate = mysqli_query( $conn,"SELECT * FROM tbl_supplier_template WHERE user_id = $user_id AND requirement_id = $req_id" );
                                                            if ( mysqli_num_rows($selectTemplate) > 0 ) {
                                                                $rowTemplate = mysqli_fetch_array($selectTemplate);
                                                                $temp_ID = $rowTemplate["ID"];
                                                                $temp_file = $rowTemplate["file"];

                                                                $type = 'iframe';
                                                                $filetype = $rowTemplate["filetype"];
                                                                if ($filetype == 1) {
                                                                    $fileExtension = fileExtension($temp_file);
                                                                    $src = $fileExtension['src'];
                                                                    $embed = $fileExtension['embed'];
                                                                    $type = $fileExtension['type'];
                                                                    $file_extension = $fileExtension['file_extension'];
                                                                    $url = $base_url.'uploads/supplier/';

                                                                    $temp_file = $src.$url.rawurlencode($temp_file).$embed;
                                                                } else if ($filetype == 3) {
                                                                    $temp_file = preg_replace('#[^/]*$#', '', $temp_file).'preview';
                                                                }

                                                                echo '<p style="margin: 0;">
                                                                    <a href="'.$temp_file.'" data-src="'.$temp_file.'" data-fancybox data-type="'.$type.'" class="btn btn-sm btn-info">View</a> |
                                                                    <a href="#modalTemplate2" class="btn btn-sm red-haze" data-toggle="modal" onclick="btnTemplate2('.$req_id.', '.$temp_ID.', 2)">Upload</a>
                                                                </p>';
                                                            } else {
                                                                echo '<a href="#modalTemplate2" class="btn btn-sm red-haze" data-toggle="modal" onclick="btnTemplate2('.$req_id.', 0, 2)">Upload</a>';
                                                            }

                                                        echo '</td>
                                                        <td rowspan="2" class="text-center">';

                                                            $doc_com = 0;
                                                            if (!empty($doc_file_due)) {
                                                                if ($doc_file_due_o >= $current_dateNow_o && $doc_file_approved > 0) { $compliance_approved++; $doc_com = 100; }
                                                            }
                                                            echo $doc_com.'%'; 

                                                        echo '</td>
									                </tr>
									                <tr class="tr_'.$req_id.'">
									                	<td colspan="3">';

															$selectComment = mysqli_query( $conn,"SELECT * FROM tbl_supplier_comment WHERE supplier_document_id = '".$doc_id."'" );
															if ( mysqli_num_rows($selectComment) > 0 ) {
																echo '<ul>';
																	while($rowComment = mysqli_fetch_array($selectComment)) {
																		$comment_text = $rowComment["comment"];

																		$comment_user = $rowComment["portal_user"];
																		$selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $comment_user" );
																		$rowUser = mysqli_fetch_array($selectUser);
																		$comment_user_name = $rowUser["first_name"] .' '. $rowUser["last_name"];
                                                                        if (employerID($comment_user) == 34 AND $user_id != 34) {
                                                                            $comment_user_name = 'Compliance';
                                                                        }
																		
																		$comment_last_modified = $rowComment["last_modified"];
																		$comment_last_modified = new DateTime($comment_last_modified);
																		$comment_last_modified = $comment_last_modified->format('M d, Y');

																		echo '<li>
																			<b>'.$comment_user_name.'</b> | <i>'.$comment_last_modified.'</i><br>
																			'.$comment_text.'
																		</li>';
																	}
																echo '</ul>';
															}

													    	echo '<input type="text" class="form-control" name="document_comment[]" placeholder="Comment" />';
													    	if ($page == 2) {
														    	echo '<div class="row margin-top-10 '; echo $current_userEmployerID == 34 OR $current_userEmployerID == 464 OR $current_userEmployerID == 1106 ? '':'hide'; echo '">
														            <div class="col-md-6">
														                <div class="form-group">
														                    <label class="control-label">Reviewed By</label>';

														                    if ($doc_file_reviewed  > 0) {
														                    	$selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $doc_file_reviewed" );
														                        if ( mysqli_num_rows($selectUser) > 0 ) {
														                        	$rowUser = mysqli_fetch_array($selectUser);
														                        	$rowUserName = $rowUser["first_name"] .' '. $rowUser["last_name"];
                                                                                    if (employerID($doc_file_reviewed) == 34 AND $user_id != 34) {
                                                                                        $rowUserName = 'Compliance';
                                                                                    }

														                        	echo '<input type="hidden" class="form-control" name="document_reviewed[]" value="'.$doc_file_reviewed.'"/>
														                        	<p style="margin: 0; font-weight: 700;">'.$rowUserName.'</p>';
														                        }
														                    } else {
														                    	$selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $current_userID" );
														                        if ( mysqli_num_rows($selectUser) > 0 ) {

														                        	$rowUser = mysqli_fetch_array($selectUser);
														                        	$rowUserID = $rowUser["ID"];
														                        	$rowUserName = $rowUser["first_name"] .' '. $rowUser["last_name"];
                                                                                    if (employerID($current_userID) == 34 AND $user_id != 34) {
                                                                                        $rowUserName = 'Compliance';
                                                                                    }

														                        	echo '<select class="form-control " name="document_reviewed[]">
														                    			<option value="0">Select</option>
														                    			<option value="'.$rowUserID.'">'.$rowUserName.'</option>
														                    		</select>';
														                        }
														                    }

														                echo '</div>
														            </div>
														            <div class="col-md-6">
														                <div class="form-group">
														                    <label class="control-label">Approved By</label>';

														                    if ($doc_file_approved  > 0) {
														                    	$selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $doc_file_approved" );
														                        if ( mysqli_num_rows($selectUser) > 0 ) {
														                        	$rowUser = mysqli_fetch_array($selectUser);
														                        	$rowUserName = $rowUser["first_name"] .' '. $rowUser["last_name"];
                                                                                    if (employerID($doc_file_approved) == 34 AND $user_id != 34) {
                                                                                        $rowUserName = 'Compliance';
                                                                                    }

														                        	echo '<input type="hidden" class="form-control" name="document_approved[]" value="'.$doc_file_approved.'"/>
														                        	<p style="margin: 0; font-weight: 700;">'.$rowUserName.'</p>';
														                        }
														                    } else {
														                    	$selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $current_userID" );
														                        if ( mysqli_num_rows($selectUser) > 0 ) {

														                        	$rowUser = mysqli_fetch_array($selectUser);
														                        	$rowUserID = $rowUser["ID"];
														                        	$rowUserName = $rowUser["first_name"] .' '. $rowUser["last_name"];
                                                                                    if (employerID($current_userID) == 34 AND $user_id != 34) {
                                                                                        $rowUserName = 'Compliance';
                                                                                    }

														                        	echo '<select class="form-control " name="document_approved[]">
														                    			<option value="0">Select</option>
														                    			<option value="'.$rowUserID.'">'.$rowUserName.'</option>
														                    		</select>';
														                        }
														                    }

														                echo '</div>
														            </div>
														        </div>';
														    }

														echo '</td>
													</tr>';
				                            	}
				                            }
				                        }
				                    }
                            	}

								if (!empty($document_other)) {
									$count_other = 0;
									foreach ($document_other_arr as $value) {
                                        $selectDocument = mysqli_query( $conn,"SELECT * FROM tbl_supplier_document WHERE user_id = $user_id AND supplier_id = $id AND type = 1 AND name = '".$value."'" );
								    	if ( mysqli_num_rows($selectDocument) > 0 ) {
								    		$rowDocument = mysqli_fetch_array($selectDocument);
								    		$doc_id = $rowDocument["ID"];
								    		$doc_file = $rowDocument["file"];
				                            $doc_filetype = $rowDocument["filetype"];
				                            $doc_filename = $rowDocument["filename"];
								    		$doc_file_template = $rowDocument["template"];
								    		$doc_file_comment = $rowDocument["comment"];
		                            		$doc_file_reviewed = $rowDocument["reviewed_by"];
		                            		$doc_file_approved = $rowDocument["approved_by"];

		                            		$doc_file_date = $rowDocument["file_date"];
		                            		if (!empty($doc_file_date)) {
				                                $doc_file_date = new DateTime($doc_file_date);
				                                $doc_file_date_o = $doc_file_date->format('Y/m/d');
				                                $doc_file_date = $doc_file_date->format('m/d/Y');
		                            		}

		                            		$doc_file_due = $rowDocument["file_due"];
		                            		if (!empty($doc_file_due)) {
				                                $doc_file_due = new DateTime($doc_file_due);
				                                $doc_file_due_o = $doc_file_due->format('Y/m/d');
        										$doc_file_due_o_nearly = date('Y/m/d', strtotime($doc_file_due_o. ' - 30 days'));
				                                $doc_file_due = $doc_file_due->format('m/d/Y');
		                            		};

											$compliance_counter++;

									    	echo '<tr class="tr_other_o'.$doc_id.'">
									            <td rowspan="2">
                                                    <input type="hidden" class="form-control" name="document_other_name[]" value="'.$value.'"" />';

                                                    $doc_stat = '';
                                                    if (!empty($doc_file_date) AND !empty($doc_file_due)) {
                                                        if ($doc_file_date_o < $current_dateNow_o && $doc_file_due_o < $current_dateNow_o) {
                                                            $doc_stat = 'text-danger';
                                                        } else {
                                                            if ($doc_file_date_o <= $current_dateNow_o && $doc_file_due_o_nearly <= $current_dateNow_o) {
                                                                $doc_stat = 'text-warning';
                                                            }
                                                        }
                                                    }

                                                    echo '<b class="'.$doc_stat.'">'.$value.'</b>
                                                </td>
                                                <td class="text-center">';
                                                    if (!empty($doc_file)) {
                                                        $type = 'iframe';
                                                        if ($doc_filetype == 1) {
                                                            $fileExtension = fileExtension($doc_file);
                                                            $src = $fileExtension['src'];
                                                            $embed = $fileExtension['embed'];
                                                            $type = $fileExtension['type'];
                                                            $file_extension = $fileExtension['file_extension'];
                                                            $url = $base_url.'uploads/supplier/';

                                                            $doc_file = $src.$url.rawurlencode($doc_file).$embed;
                                                        } else {
                                                            $doc_file = preg_replace('#[^/]*$#', '', $doc_file).'preview';
                                                        }

                                                        echo '<select class="form-control '; echo !empty($doc_file) ? 'hide':''; echo '" name="document_other_filetype[]" onchange="changeType(this)" required>
                                                            <option value="0">Select option</option>
                                                            <option value="1">Manual Upload</option>
                                                            <option value="2">Youtube URL</option>
                                                            <option value="3">Google Drive URL</option>
                                                        </select>
                                                        <input class="form-control margin-top-15 fileUpload" type="file" name="document_other_file[]" onchange="changeFile(this, this.value)" style="display: none;" />
                                                        <input class="form-control margin-top-15 fileURL" type="url" name="document_other_fileurl[]" style="display: none;" placeholder="https://" />
                                                        <p class="'; echo !empty($doc_file) ? '':'hide'; echo '" style="margin: 0;"><a href="'.$doc_file.'" data-src="'.$doc_file.'" data-fancybox data-type="'.$type.'" class="btn btn-sm btn-info">View</a> | <button type="button" class="btn btn-sm red-haze uploadNew" onclick="uploadNew(this)">Upload</button></p>';
                                                    } else {
                                                        echo '<select class="form-control hide" name="document_other_filetype[]" onchange="changeType(this)" required>
                                                            <option value="0">Select option</option>
                                                            <option value="1">Manual Upload</option>
                                                            <option value="2">Youtube URL</option>
                                                            <option value="3">Google Drive URL</option>
                                                        </select>
                                                        <input class="form-control margin-top-15 fileUpload" type="file" name="document_other_file[]" onchange="changeFile(this, this.value)" style="display: none;" />
                                                        <input class="form-control margin-top-15 fileURL" type="url" name="document_other_fileurl[]" style="display: none;" placeholder="https://" />
                                                        <p style="margin: 0;"><button type="button" class="btn btn-sm red-haze uploadNew" onclick="uploadNew(this)">Upload</button></p>';
                                                    }
                                                echo '</td>
                                                <td>';

                                                    if (!empty($doc_filename)) {
                                                        echo '<input type="text" class="form-control document_filename" name="document_other_filename[]" value="'.$doc_filename.'" placeholder="Document Name" />
                                                        <p class="hide" style="margin: 0;">'.$doc_filename.'</p>';
                                                    } else {
                                                        echo '<input type="text" class="form-control document_filename" name="document_other_filename[]" placeholder="Document Name" />';
                                                    }
                                                    
                                                echo '</td>
                                                <td class="text-center">
                                                    <div class="input-group">
                                                        <input type="text" class="form-control daterange '; if (empty($doc_file_date) || empty($doc_file_due)) { echo 'daterange_empty'; } echo '" name="document_other_daterange[]" value="'; if (!empty($doc_file_date) && !empty($doc_file_due)) { echo $doc_file_date .' - '. $doc_file_due; } echo '" />
                                                        <span class="input-group-btn">
                                                            <button class="btn default date-range-toggle" type="button" onclick="widget_date_clears(this)">
                                                                <i class="fa fa-close"></i>
                                                            </button>
                                                        </span>
                                                    </div>
                                                    <input type="date" class="form-control hide" name="document_other_date[]" value="'.$doc_file_date.'" />
                                                    <input type="date" class="form-control hide" name="document_other_due[]" value="'.$doc_file_due.'" />
                                                </td>
                                                <td rowspan="2" class="text-center '; echo $current_client == 0 ? '':'hide'; echo '">
                                                    <input type="file" class="form-control hide" name="document_other_template[]" />';

                                                    // if (!empty($doc_file_template)) {
                                                    //     $type = 'iframe';
                                                    //     $filetype = $rowTemplate["filetype"];
                                                    //     if ($filetype == 1) {
                                                    //         $fileExtension = fileExtension($doc_file_template);
                                                    //         $src = $fileExtension['src'];
                                                    //         $embed = $fileExtension['embed'];
                                                    //         $type = $fileExtension['type'];
                                                    //         $file_extension = $fileExtension['file_extension'];
                                                    //         $url = $base_url.'uploads/supplier/';

                                                    //         $doc_file_template = $src.$url.rawurlencode($doc_file_template).$embed;
                                                    //     } else if ($filetype == 3) {
                                                    //         $doc_file_template = preg_replace('#[^/]*$#', '', $doc_file_template).'preview';
                                                    //     }

                                                    //     echo '<p style="margin: 0;">
                                                    //         <a href="'.$doc_file_template.'" data-src="'.$doc_file_template.'" data-fancybox data-type="'.$type.'" class="btn btn-sm btn-info">View</a> |
                                                    //         <a href="#modalTemplate2" class="btn btn-sm red-haze" data-toggle="modal" onclick="btnTemplate2('.$id.', '.$doc_id.', 2)">Upload</a>
                                                    //     </p>';
                                                    // } else {
                                                    //     echo '<a href="#modalTemplate2" class="btn btn-sm red-haze" data-toggle="modal" onclick="btnTemplate2('.$id.', 0, 2)">Upload</a>';
                                                    // }

                                                    $selectTemplate = mysqli_query( $conn,"SELECT * FROM tbl_supplier_template WHERE user_id = $user_id AND requirement_id = $doc_id" );
                                                    if ( mysqli_num_rows($selectTemplate) > 0 ) {
                                                        $rowTemplate = mysqli_fetch_array($selectTemplate);
                                                        $temp_ID = $rowTemplate["ID"];
                                                        $temp_file = $rowTemplate["file"];

                                                        $type = 'iframe';
                                                        $filetype = $rowTemplate["filetype"];
                                                        if ($filetype == 1) {
                                                            $fileExtension = fileExtension($temp_file);
                                                            $src = $fileExtension['src'];
                                                            $embed = $fileExtension['embed'];
                                                            $type = $fileExtension['type'];
                                                            $file_extension = $fileExtension['file_extension'];
                                                            $url = $base_url.'uploads/supplier/';

                                                            $temp_file = $src.$url.rawurlencode($temp_file).$embed;
                                                        } else if ($filetype == 3) {
                                                            $temp_file = preg_replace('#[^/]*$#', '', $temp_file).'preview';
                                                        }

                                                        echo '<p style="margin: 0;">
                                                            <a href="'.$temp_file.'" data-src="'.$temp_file.'" data-fancybox data-type="'.$type.'" class="btn btn-sm btn-info">View</a> |
                                                            <a href="#modalTemplate2" class="btn btn-sm red-haze" data-toggle="modal" onclick="btnTemplate2('.$doc_id.', '.$temp_ID.', 2)">Upload</a>
                                                        </p>';
                                                    } else {
                                                        echo '<a href="#modalTemplate2" class="btn btn-sm red-haze" data-toggle="modal" onclick="btnTemplate2('.$doc_id.', 0, 2)">Upload</a>';
                                                    }

                                                echo '</td>
                                                <td rowspan="2" class="text-center">';

                                                    $doc_com = 0;
                                                    if (!empty($doc_file_due)) {
                                                        if ($doc_file_due_o >= $current_dateNow_o && $doc_file_approved > 0) { $compliance_approved++; $doc_com = 100; }
                                                    }
                                                    echo $doc_com.'%'; 

                                                echo '</td>
									        </tr>
									        <tr class="tr_other_o'.$doc_id.'">
									        	<td colspan="3">';

													$selectComment = mysqli_query( $conn,"SELECT * FROM tbl_supplier_comment WHERE supplier_document_id = '".$doc_id."'" );
													if ( mysqli_num_rows($selectComment) > 0 ) {
														echo '<ul>';
															while($rowComment = mysqli_fetch_array($selectComment)) {
																$comment_text = $rowComment["comment"];

																$comment_user = $rowComment["portal_user"];
																$selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $comment_user" );
																$rowUser = mysqli_fetch_array($selectUser);
																$comment_user_name = $rowUser["first_name"] .' '. $rowUser["last_name"];
                                                                if (employerID($comment_user) == 34 AND $user_id != 34) {
                                                                    $comment_user_name = 'Compliance';
                                                                }
																
																$comment_last_modified = $rowComment["last_modified"];
																$comment_last_modified = new DateTime($comment_last_modified);
																$comment_last_modified = $comment_last_modified->format('M d, Y');

																echo '<li>
																	<b>'.$comment_user_name.'</b> | <i>'.$comment_last_modified.'</i><br>
																	'.$comment_text.'
																</li>';
															}
														echo '</ul>';
													}
									            	
									            	echo '<input type="text" class="form-control" name="document_other_comment[]" placeholder="Comment" />';
									            	if ($page == 2) {
										            	echo '<div class="row margin-top-10 '; echo $current_userEmployerID == 34 OR $current_userEmployerID == 464 OR $current_userEmployerID == 1106 ? '':'hide'; echo '">
										                    <div class="col-md-6">
										                        <div class="form-group">
										                            <label class="control-label">Reviewed By</label>';

										                            if ($doc_file_reviewed  > 0) {
										                            	$selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $doc_file_reviewed" );
										                                if ( mysqli_num_rows($selectUser) > 0 ) {
										                                	$rowUser = mysqli_fetch_array($selectUser);
										                                	$rowUserName = $rowUser["first_name"] .' '. $rowUser["last_name"];
                                                                            if (employerID($doc_file_reviewed) == 34 AND $user_id != 34) {
                                                                                $rowUserName = 'Compliance';
                                                                            }

										                                	echo '<input type="hidden" class="form-control" name="document_other_reviewed[]" value="'.$doc_file_reviewed.'"/>
										                                	<p style="margin: 0; font-weight: 700;">'.$rowUserName.'</p>';
										                                }
										                            } else {
										                            	$selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $current_userID" );
										                                if ( mysqli_num_rows($selectUser) > 0 ) {

										                                	$rowUser = mysqli_fetch_array($selectUser);
										                                	$rowUserID = $rowUser["ID"];
										                                	$rowUserName = $rowUser["first_name"] .' '. $rowUser["last_name"];
                                                                            if (employerID($current_userID) == 34 AND $user_id != 34) {
                                                                                $rowUserName = 'Compliance';
                                                                            }

										                                	echo '<select class="form-control " name="document_other_reviewed[]">
										                            			<option value="0">Select</option>
										                            			<option value="'.$rowUserID.'">'.$rowUserName.'</option>
										                            		</select>';
										                                }
										                            }

										                        echo '</div>
										                    </div>
										                    <div class="col-md-6">
										                        <div class="form-group">
										                            <label class="control-label">Approved By</label>';

										                            if ($doc_file_approved  > 0) {
										                            	$selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $doc_file_approved" );
										                                if ( mysqli_num_rows($selectUser) > 0 ) {
										                                	$rowUser = mysqli_fetch_array($selectUser);
										                                	$rowUserName = $rowUser["first_name"] .' '. $rowUser["last_name"];
                                                                            if (employerID($doc_file_approved) == 34 AND $user_id != 34) {
                                                                                $rowUserName = 'Compliance';
                                                                            }

										                                	echo '<input type="hidden" class="form-control" name="document_other_approved[]" value="'.$doc_file_approved.'"/>
										                                	<p style="margin: 0; font-weight: 700;">'.$rowUserName.'</p>';
										                                }
										                            } else {
										                            	$selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $current_userID" );
										                                if ( mysqli_num_rows($selectUser) > 0 ) {

										                                	$rowUser = mysqli_fetch_array($selectUser);
										                                	$rowUserID = $rowUser["ID"];
										                                	$rowUserName = $rowUser["first_name"] .' '. $rowUser["last_name"];
                                                                            if (employerID($current_userID) == 34 AND $user_id != 34) {
                                                                                $rowUserName = 'Compliance';
                                                                            }

										                                	echo '<select class="form-control " name="document_other_approved[]">
										                            			<option value="0">Select</option>
										                            			<option value="'.$rowUserID.'">'.$rowUserName.'</option>
										                            		</select>';
										                                }
										                            }

										                        echo '</div>
										                    </div>
										                </div>';
										            }
									        	echo '</td>
									        </tr>';
									        $count_other++;
								    	}
								    }
								}

								if ($compliance_counter > 0) { $compliance = ($compliance_approved / $compliance_counter) * 100; }
								else { $compliance = 0; }

                            echo '</tbody>
                            <tfoot class="bg-blue-ebonyclay bg-font-blue-ebonyclay">
			                    <tr>
			                        <th class="text-right" colspan="'; echo $current_client == 0 ? '5':'4'; echo '">Compliance:</th>
			                        <th class="text-center">'.intval($compliance).'%</th>
			                    </tr>
			                </tfoot>
                        </table>
                    </div>
                </div>
                <div class="tab-pane" id="tabProduct_2">';

                    if ($page == 2) { echo '<a href="#modalNewProduct" data-toggle="modal" class="btn green" onclick="btnNew_Product('.$user_id.', 2, \'modalNewProduct\')">Add New Product</a>'; }
                    
                    echo '<div class="table-scrollable">
                        <table class="table table-bordered table-hover" id="tableData_Product_2">
                            <thead>
                                <tr>
                                    <th>Product Name</th>
                                    <th>Product ID</th>
                                    <th>Description</th>';

                                    if ($page == 2) { echo '<th class="text-center" style="width: 135px;">Action</th>'; }
                                
                                echo '</tr>
                            </thead>
                            <tbody>';

					            if (!empty($material)) {
					                $material_arr = explode(", ", $material);
					                foreach ($material_arr as $value) {
					                    $selectMaterial = mysqli_query( $conn,"SELECT * FROM tbl_supplier_material WHERE ID=$value" );
					                    if ( mysqli_num_rows($selectMaterial) > 0 ) {
					                    	while($rowMaterial = mysqli_fetch_array($selectMaterial)) {
					                    		$material_mid = $rowMaterial["ID"];
				                            	$material_name = $rowMaterial["material_name"];
				                            	$material_id = $rowMaterial["material_id"];
				                            	$material_description = $rowMaterial["description"];

				                            	if ($page == 2) {
						                            $selectProduct = mysqli_query( $conn,"SELECT * FROM tbl_products WHERE ID=$material_name" );
						                            $rowProduct = mysqli_fetch_array($selectProduct);
						                            $material_name = $rowProduct["name"];
						                            $material_id = $rowProduct["code"];
						                            $material_description = $rowProduct["description"];
				                            	}

				                                echo '<tr id="tr_'.$material_mid.'">
				                                	<input type="hidden" class="form-control" name="material_id[]" value="'.$material_mid.'" readonly />
				                                    <td>'.$material_name.'</td>
				                                    <td>'.$material_id.'</td>
				                                    <td>'.$material_description.'</td>';

					                                if ($page == 2) { 
						                                echo '<td class="text-center">
						                                    <div class="mt-action-buttons">
						                                        <div class="btn-group btn-group-circle">
						                                            <a href="#modalEditProduct" data-toggle="modal" class="btn btn-outline dark btn-sm btnEdit_Product" onclick="btnEdit_Product('.$material_mid.', 2, \'modalEditProduct\')">Edit</a>
						                                            <a href="javascript:;" class="btn btn-outlinex red btn-sm btnRemove_Product" onclick="btnRemove_Product('.$material_mid.', 2)">Delete</a>
						                                        </div>
						                                    </div>
						                                </td>';
						                            }

				                                echo '</tr>';
					                    	}
					                    }
					                }
					            }

					       	echo '</tbody>
                        </table>
                    </div>
                </div>
                <div class="tab-pane" id="tabService_2">';

                    if ($page == 2) { echo '<a href="#modalNewService" data-toggle="modal" class="btn green" onclick="btnNew_Service('.$user_id.', 2, \'modalNewService\')">Add New Service</a>'; }
                    
                    echo '<div class="table-scrollable">
                        <table class="table table-bordered table-hover" id="tableData_Service_2">
                            <thead>
                                <tr>
                                    <th>Service Name</th>
                                    <th>Service ID</th>
                                    <th>Description</th>';

                                    if ($page == 2) { echo '<th class="text-center" style="width: 135px;">Action</th>'; }
                                
                                echo '</tr>
                            </thead>
                            <tbody>';

					            if (!empty($service)) {
					                $service_arr = explode(", ", $service);
					                foreach ($service_arr as $value) {
					                    $selectService = mysqli_query( $conn,"SELECT * FROM tbl_supplier_service WHERE ID=$value" );
					                    if ( mysqli_num_rows($selectService) > 0 ) {
					                    	while($rowService = mysqli_fetch_array($selectService)) {
				                            	$service_mid = $rowService["ID"];
				                            	$service_name = $rowService["service_name"];
				                            	$service_id = $rowService["service_id"];
				                            	$service_description = $rowService["description"];

				                            	if ($page == 2) {
					                            	$selectDataCategory = mysqli_query( $conn,"SELECT * FROM tbl_service_category WHERE id=$service_name" );
						                            $rowDataCategory = mysqli_fetch_array($selectDataCategory);
						                            $service_name = $rowDataCategory["service_category"];

					                            	$selectDataArea = mysqli_query( $conn,"SELECT * FROM tbl_service_area WHERE id=$service_id" );
						                            $rowDataArea = mysqli_fetch_array($selectDataArea);
						                            $service_id = $rowDataArea["area_category"];
						                        }

				                                echo '<tr id="tr_'.$service_mid.'">
						                           	<input type="hidden" class="form-control" name="service_id[]" value="'.$service_mid.'" readonly />
				                                    <td>'.$service_name.'</td>
				                                    <td>'.$service_id.'</td>
				                                    <td>'.$service_description.'</td>';

					                                if ($page == 2) { 
						                                echo '<td class="text-center">
						                                    <div class="mt-action-buttons">
						                                        <div class="btn-group btn-group-circle">
						                                            <a href="#modalEditService" data-toggle="modal" class="btn btn-outline dark btn-sm btnEdit_Service" onclick="btnEdit_Service('.$service_mid.', 2, \'modalEditService\')">Edit</a>
						                                            <a href="javascript:;" class="btn btn-outlinex red btn-sm btnRemove_Service" onclick="btnRemove_Service('.$service_mid.', 2)">Delete</a>
						                                        </div>
						                                    </div>
						                                </td>';
						                            }

				                                echo '</tr>';
					                    	}
					                    }
					                }
					            }

                            echo '</tbody>
                        </table>
                    </div>
                </div>
                <div class="tab-pane" id="tabAuditReview_2">
                    <h4><strong>Audit</strong></h4>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="control-label">Audit Report</label>';

                                if (!empty($audit_report_arr[0])) {
                                    $fileExtension = fileExtension($audit_report_arr[0]);
                                    $src = $fileExtension['src'];
                                    $embed = $fileExtension['embed'];
                                    $type = $fileExtension['type'];
                                    $file_extension = $fileExtension['file_extension'];
                                    $url = $base_url.'uploads/supplier/';

                                    echo '<input type="hidden" name="audit_report_file_tmp" value="'.$audit_report_arr[0].'" />
                                    <input class="form-control '; echo !empty($audit_report_arr[0]) ? 'hide':''; echo '" type="file" name="audit_report_file" />
                                    <p class="'; echo !empty($audit_report_arr[0]) ? '':'hide'; echo '" style="margin: 0;"><a href="'.$src.$url.rawurlencode($audit_report_arr[0]).$embed.'" data-src="'.$src.$url.rawurlencode($audit_report_arr[0]).$embed.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a> | <button type="button" class="btn btn-link uploadNew" onclick="uploadNewOld(this)">Upload</button></p>';
                                } else {
                                    echo '<input type="hidden" name="audit_report_file_tmp" value="" />
                                    <input class="form-control" type="file" name="audit_report_file" />';
                                }

                            echo '</div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="control-label">Document Validity</label>
                                <div class="input-group">
                                    <input type="text" class="form-control daterange_audit '; if (empty($audit_report_arr[1]) || empty($audit_report_arr[2])) { echo 'daterange_audit_empty'; } echo '" name="audit_report_validity" value="'; if (!empty($audit_report_arr[1]) && !empty($audit_report_arr[2])) { echo $audit_report_arr[1] .' - '. $audit_report_arr[2]; } echo '" />
                                    <span class="input-group-btn">
                                        <button class="btn default date-range-toggle" type="button" onclick="widget_date_audit_clears(this)">
                                            <i class="fa fa-close"></i>
                                        </button>
                                    </span>
                                </div>
                            </div>

                            <input class="form-control hide" type="date" name="audit_report_date" value="'.$audit_report_arr[1].'" />
                            <input class="form-control hide" type="date" name="audit_report_due" value="'.$audit_report_arr[2].'" />
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="control-label">Comments / Notes</label>
                                <input class="form-control" type="text" name="audit_report_note" value="'.$audit_report_arr[3].'" />
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="control-label">Audit Certificate</label>';

                                if (!empty($audit_certificate_arr[0])) {
                                    $extension = pathinfo($audit_certificate_arr[0], PATHINFO_EXTENSION);
                                    $src = 'https://view.officeapps.live.com/op/embed.aspx?src=';
                                    $embed = '&embedded=true';
                                    $type = 'iframe';
                                    if ($extension == "pdf") { $src = ''; $embed = ''; $type = ''; $file_extension = "fa-file-pdf-o"; }
                                    else if (strtolower($extension) == "doc" OR strtolower($extension) == "docx") { $file_extension = "fa-file-word-o"; }
                                    else if (strtolower($extension) == "ppt" OR strtolower($extension) == "pptx") { $file_extension = "fa-file-powerpoint-o"; }
                                    else if (strtolower($extension) == "xls" OR strtolower($extension) == "xlsb" OR strtolower($extension) == "xlsm" OR strtolower($extension) == "xlsx" OR strtolower($extension) == "csv" OR strtolower($extension) == "xlsx") { $file_extension = "fa-file-excel-o"; }
                                    else if (strtolower($extension) == "gif" OR strtolower($extension) == "jpg"  OR strtolower($extension) == "jpeg" OR strtolower($extension) == "png" OR strtolower($extension) == "ico") { $src = ''; $embed = ''; $type = ''; $file_extension = "fa-file-image-o"; }
                                    else if (strtolower($extension) == "mp4" OR strtolower($extension) == "mov"  OR strtolower($extension) == "wmv" OR strtolower($extension) == "flv" OR strtolower($extension) == "avi" OR strtolower($extension) == "avchd" OR strtolower($extension) == "webm" OR strtolower($extension) == "mkv") { $src = ''; $embed = ''; $type = ''; $file_extension = "fa-file-video-o"; }
                                    else { $src = ''; $embed = ''; $type = ''; $file_extension = "fa-file-code-o"; }

                                    $url = $base_url.'uploads/supplier/';

                                    echo '<input type="hidden" name="audit_certificate_file_tmp" value="'.$audit_certificate_arr[0].'" />
                                    <input class="form-control '; echo !empty($audit_certificate_arr[0]) ? 'hide':''; echo '" type="file" name="audit_certificate_file" />
                                    <p class="'; echo !empty($audit_certificate_arr[0]) ? '':'hide'; echo '" style="margin: 0;"><a href="'.$src.$url.rawurlencode($audit_certificate_arr[0]).$embed.'" data-src="'.$src.$url.rawurlencode($audit_certificate_arr[0]).$embed.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a> | <button type="button" class="btn btn-link uploadNew" onclick="uploadNewOld(this)">Upload</button></p>';
                                } else {
                                    echo '<input type="hidden" name="audit_certificate_file_tmp" value="" />
                                    <input class="form-control" type="file" name="audit_certificate_file" />';
                                }

                            echo '</div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="control-label">Document Validity</label>
                                <div class="input-group">
                                    <input type="text" class="form-control daterange_audit '; if (empty($audit_certificate_arr[1]) || empty($audit_certificate_arr[2])) { echo 'daterange_audit_empty'; } echo '" name="audit_certificate_validity" value="'; if (!empty($audit_certificate_arr[1]) && !empty($audit_certificate_arr[2])) { echo $audit_certificate_arr[1] .' - '. $audit_certificate_arr[2]; } echo '" />
                                    <span class="input-group-btn">
                                        <button class="btn default date-range-toggle" type="button" onclick="widget_date_audit_clears(this)">
                                            <i class="fa fa-close"></i>
                                        </button>
                                    </span>
                                </div>
                            </div>

                            <input class="form-control hide" type="date" name="audit_certificate_date" value="'.$audit_certificate_arr[1].'" />
                            <input class="form-control hide" type="date" name="audit_certificate_due" value="'.$audit_certificate_arr[2].'" />
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="control-label">Comments / Notes</label>
                                <input class="form-control" type="text" name="audit_certificate_note" value="'.$audit_certificate_arr[3].'" />
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="control-label">Audit Corrective Action</label>';

                                if (!empty($audit_action_arr[0])) {
                                    $extension = pathinfo($audit_action_arr[0], PATHINFO_EXTENSION);
                                    $src = 'https://view.officeapps.live.com/op/embed.aspx?src=';
                                    $embed = '&embedded=true';
                                    $type = 'iframe';
                                    if ($extension == "pdf") { $src = ''; $embed = ''; $type = ''; $file_extension = "fa-file-pdf-o"; }
                                    else if (strtolower($extension) == "doc" OR strtolower($extension) == "docx") { $file_extension = "fa-file-word-o"; }
                                    else if (strtolower($extension) == "ppt" OR strtolower($extension) == "pptx") { $file_extension = "fa-file-powerpoint-o"; }
                                    else if (strtolower($extension) == "xls" OR strtolower($extension) == "xlsb" OR strtolower($extension) == "xlsm" OR strtolower($extension) == "xlsx" OR strtolower($extension) == "csv" OR strtolower($extension) == "xlsx") { $file_extension = "fa-file-excel-o"; }
                                    else if (strtolower($extension) == "gif" OR strtolower($extension) == "jpg"  OR strtolower($extension) == "jpeg" OR strtolower($extension) == "png" OR strtolower($extension) == "ico") { $src = ''; $embed = ''; $type = ''; $file_extension = "fa-file-image-o"; }
                                    else if (strtolower($extension) == "mp4" OR strtolower($extension) == "mov"  OR strtolower($extension) == "wmv" OR strtolower($extension) == "flv" OR strtolower($extension) == "avi" OR strtolower($extension) == "avchd" OR strtolower($extension) == "webm" OR strtolower($extension) == "mkv") { $src = ''; $embed = ''; $type = ''; $file_extension = "fa-file-video-o"; }
                                    else { $src = ''; $embed = ''; $type = ''; $file_extension = "fa-file-code-o"; }

                                    $url = $base_url.'uploads/supplier/';

                                    echo '<input type="hidden" name="audit_action_file_tmp" value="'.$audit_action_arr[0].'" />
                                    <input class="form-control '; echo !empty($audit_action_arr[0]) ? 'hide':''; echo '" type="file" name="audit_action_file" />
                                    <p class="'; echo !empty($audit_action_arr[0]) ? '':'hide'; echo '" style="margin: 0;"><a href="'.$src.$url.rawurlencode($audit_action_arr[0]).$embed.'" data-src="'.$src.$url.rawurlencode($audit_action_arr[0]).$embed.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a> | <button type="button" class="btn btn-link uploadNew" onclick="uploadNewOld(this)">Upload</button></p>';
                                } else {
                                    echo '<input type="hidden" name="audit_action_file_tmp" value="" />
                                    <input class="form-control" type="file" name="audit_action_file" />';
                                }

                            echo '</div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="control-label">Document Validity</label>
                                <div class="input-group">
                                    <input type="text" class="form-control daterange_audit '; if (empty($audit_action_arr[1]) || empty($audit_action_arr[2])) { echo 'daterange_audit_empty'; } echo '" name="audit_action_validity" value="'; if (!empty($audit_action_arr[1]) && !empty($audit_action_arr[2])) { echo $audit_action_arr[1] .' - '. $audit_action_arr[2]; } echo '" />
                                    <span class="input-group-btn">
                                        <button class="btn default date-range-toggle" type="button" onclick="widget_date_audit_clears(this)">
                                            <i class="fa fa-close"></i>
                                        </button>
                                    </span>
                                </div>
                            </div>

                            <input class="form-control hide" type="date" name="audit_action_date" value="'.$audit_action_arr[1].'" />
                            <input class="form-control hide" type="date" name="audit_action_due" value="'.$audit_action_arr[2].'" />
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="control-label">Comments / Notes</label>
                                <input class="form-control" type="text" name="audit_action_note" value="'.$audit_action_arr[3].'" />
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12 hide">
                            <h4><strong>Auditing Body</strong></h4>
                            <div class="form-group">
                                <label class="control-label">Add Auditing</label>
                                <input type="text" class="form-control tagsinput" name="audit" data-role="tagsinput" placeholder="Specify" value="'.$audit.'" />
                                <span class="form-text text-muted">Hit enter button to add more</span>
                            </div>
                        </div>
                        <div class="col-md-12">
                            <h4><strong>Annual Review</strong></h4>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="control-label">Reviewed by</label>
                                        <input class="form-control" type="text" name="reviewed_by" value="'.$reviewed_by.'" />
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="control-label">Duration of Review</label>
                                        <div class="input-group">
                                            <input type="text" class="form-control daterange_audit '; if (empty($reviewed_date) || empty($reviewed_due)) { echo 'daterange_audit_empty'; } echo '" name="reviewed_validity" value="'; if (!empty($reviewed_date) && !empty($reviewed_due)) { echo $reviewed_date .' - '. $reviewed_due; } echo '" />
                                            <span class="input-group-btn">
                                                <button class="btn default date-range-toggle" type="button" onclick="widget_date_audit_clears(this)">
                                                    <i class="fa fa-close"></i>
                                                </button>
                                            </span>
                                        </div>
                                    </div>

                                    <input class="form-control hide" type="date" name="reviewed_date" value="'.$reviewed_date.'" />
                                    <input class="form-control hide" type="date" name="reviewed_due" value="'.$reviewed_due.'" />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="tab-pane" id="tabPortal_2">
                    <h4><strong>Portal</strong></h4>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="control-label">Department</label>
                                <select class="form-control mt-multiselect department_id" name="department_id[]" onchange="changeDepartment(this, 2)" multiple="multiple">';
                                    
                                    $selectDepartment = mysqli_query( $conn,"SELECT * FROM tbl_hr_department WHERE status = 1 AND user_id = $current_userEmployerID ORDER BY title");
                                    if ( mysqli_num_rows($selectDepartment) > 0 ) {
                                        while($rowDepartment = mysqli_fetch_array($selectDepartment)) {
                                            $dept_ID = $rowDepartment["ID"];
                                            $dept_title = $rowDepartment["title"];

                                            if (!empty($department_id)) {
                                            	echo '<option value="'.$dept_ID.'" '; echo in_array($dept_ID, $department_id_arr) ? 'SELECTED' : ''; echo '>'.$dept_title.'</option>';
                                            } else {
                                            	echo '<option value="'.$dept_ID.'">'.$dept_title.'</option>';
                                            }
                                        }
                                    }
                                    
                                echo '</select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="control-label">Employee</label>
                                <select class="form-control mt-multiselect employee_id" name="employee_id[]" multiple="multiple">';
                                    
                                	if (!empty($department_id)) {
                                		foreach ($department_id_arr as $value) {
	                                        $selectEmployee = mysqli_query( $conn,"SELECT * FROM tbl_hr_employee WHERE suspended = 0 AND status = 1 AND department_id = $value AND user_id = $current_userEmployerID ORDER BY first_name");
	                                        if ( mysqli_num_rows($selectEmployee) > 0 ) {
	                                            while($rowEmployee = mysqli_fetch_array($selectEmployee)) {
	                                                $emp_ID = $rowEmployee["ID"];
	                                                $emp_name = $rowEmployee["first_name"] .' '. $rowEmployee["last_name"];
                                                    $emp_email = $rowEmployee["email"];

                                                    $selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE is_verified = 1 AND is_active = 1 AND email = '".$emp_email."' ORDER BY first_name");
                                                    if ( mysqli_num_rows($selectUser) > 0 ) {
		                                                if (!empty($employee_id)) {
		                                                	echo '<option value="'.$emp_ID.'" '; echo in_array($emp_ID, $employee_id_arr) ? 'SELECTED' : ''; echo '>'.$emp_name.'</option>';
		                                                } else {
		                                                	echo '<option value="'.$emp_ID.'">'.$emp_name.'</option>';
		                                                }
                                                    }

	                                            }
	                                        }
                                		}
                                	} else {
                                        $selectEmployee = mysqli_query( $conn,"SELECT * FROM tbl_hr_employee WHERE suspended = 0 AND status = 1 AND user_id = $current_userEmployerID ORDER BY first_name");
                                        if ( mysqli_num_rows($selectEmployee) > 0 ) {
                                            while($rowEmployee = mysqli_fetch_array($selectEmployee)) {
                                                $emp_ID = $rowEmployee["ID"];
                                                $emp_name = $rowEmployee["first_name"] .' '. $rowEmployee["last_name"];
                                                $emp_email = $rowEmployee["email"];

                                                $selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE is_verified = 1 AND is_active = 1 AND email = '".$emp_email."' ORDER BY first_name");
                                                if ( mysqli_num_rows($selectUser) > 0 ) {
	                                                if (!empty($employee_id)) {
	                                                	echo '<option value="'.$emp_ID.'" '; echo in_array($emp_ID, $employee_id_arr) ? 'SELECTED' : ''; echo '>'.$emp_name.'</option>';
	                                                } else {
	                                                	echo '<option value="'.$emp_ID.'">'.$emp_name.'</option>';
	                                                }
                                                }
                                            }
                                        }
                                	}
                                    
                                echo '</select>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="tab-pane" id="tabUsage_2">';

                    $selectUser = mysqli_query( $conn,"SELECT
                        s.ID AS s_ID,
                        s.email AS s_email,
                        s.name AS s_name,
                        u.ID AS u_ID,
                        u.first_name AS u_first_name,
                        u.last_name AS u_last_name
                        FROM tbl_supplier AS s

                        LEFT JOIN (
                            SELECT
                            *
                            FROM tbl_user
                            WHERE is_verified = 1
                            AND is_active = 1
                        ) AS u
                        ON s.email = u.email

                        WHERE s.ID = $id" );
                    if ( mysqli_num_rows($selectUser) > 0 ) {
                        $rowUser = mysqli_fetch_array($selectUser);
                        $account_id = $rowUser["u_ID"];
                        $total_usage = 0;
                        $compliance_dashboard = 0;
                        $hr_module = 0;
                        $product_module = 0;
                        $service_module = 0;
                        $customer_module = 0;
                        $supplier_module = 0;
                        $archive_module = 0;
                        $library_module = 0;
                        $rvm_module = 0;
                        $ffva_module = 0;

                        if (!empty($account_id)) {

                            // Compliance Dashboard (File, Reference, Review, Template, Video)
                            $selectComplianceDashboard = mysqli_query( $conn,"SELECT
                                SUM(total) AS bytes
                                FROM (
                                    SELECT
                                    SUM(f_filesize) AS total
                                    FROM (
                                        SELECT
                                        f.filesize AS f_filesize,
                                        CASE WHEN u.employee_id > 0 THEN e.user_id ELSE u.ID END AS f_user
                                        FROM tbl_library_file AS f

                                        LEFT JOIN (
                                            SELECT
                                            *
                                            FROM tbl_user
                                        ) AS u
                                        ON f.user_id = u.ID

                                        LEFT JOIN (
                                            SELECT
                                            *
                                            FROM tbl_hr_employee
                                        ) AS e
                                        ON u.employee_id = e.ID

                                        WHERE f.filesize > 0
                                        AND LENGTH(f.file_history) IS NULL
                                    ) o
                                    WHERE o.f_user = $account_id

                                    UNION ALL

                                    SELECT
                                    SUM(total_quantity) AS total
                                    FROM (
                                        SELECT
                                        f.filesize AS f_filesize,
                                        CASE WHEN u.employee_id > 0 THEN e.user_id ELSE u.ID END AS f_user,
                                        f.file_history, 
                                        SUM(j.size) total_quantity
                                        FROM tbl_library_file AS f

                                        LEFT JOIN (
                                            SELECT
                                            *
                                            FROM tbl_user
                                        ) AS u
                                        ON f.user_id = u.ID

                                        LEFT JOIN (
                                            SELECT
                                            *
                                            FROM tbl_hr_employee
                                        ) AS e
                                        ON u.employee_id = e.ID

                                        , JSON_TABLE(file_history, '$[*]' COLUMNS (size INTEGER PATH '$.size')) j

                                        WHERE f.filesize > 0
                                        AND LENGTH(f.file_history) > 0
                                        GROUP BY f.file_history
                                    ) o
                                    WHERE o.f_user = $account_id

                                    UNION ALL

                                    SELECT
                                    SUM(f_filesize) AS total
                                    FROM (
                                        SELECT
                                        f.filesize AS f_filesize,
                                        CASE WHEN u.employee_id > 0 THEN e.user_id ELSE u.ID END AS f_user
                                        FROM tbl_library_references AS f

                                        LEFT JOIN (
                                            SELECT
                                            *
                                            FROM tbl_user
                                        ) AS u
                                        ON f.user_id = u.ID

                                        LEFT JOIN (
                                            SELECT
                                            *
                                            FROM tbl_hr_employee
                                        ) AS e
                                        ON u.employee_id = e.ID

                                        WHERE f.filesize > 0
                                        AND LENGTH(f.file_history) IS NULL
                                    ) o
                                    WHERE o.f_user = $account_id

                                    UNION ALL

                                    SELECT
                                    SUM(total_quantity) AS total
                                    FROM (
                                        SELECT
                                        f.filesize AS f_filesize,
                                        CASE WHEN u.employee_id > 0 THEN e.user_id ELSE u.ID END AS f_user,
                                        f.file_history, 
                                        SUM(j.size) total_quantity
                                        FROM tbl_library_references AS f

                                        LEFT JOIN (
                                            SELECT
                                            *
                                            FROM tbl_user
                                        ) AS u
                                        ON f.user_id = u.ID

                                        LEFT JOIN (
                                            SELECT
                                            *
                                            FROM tbl_hr_employee
                                        ) AS e
                                        ON u.employee_id = e.ID

                                        , JSON_TABLE(file_history, '$[*]' COLUMNS (size INTEGER PATH '$.size')) j

                                        WHERE f.filesize > 0
                                        AND LENGTH(f.file_history) > 0
                                        GROUP BY f.file_history
                                    ) o
                                    WHERE o.f_user = $account_id

                                    UNION ALL

                                    SELECT
                                    SUM(f_filesize) AS total
                                    FROM (
                                        SELECT
                                        f.filesize AS f_filesize,
                                        CASE WHEN u.employee_id > 0 THEN e.user_id ELSE u.ID END AS f_user
                                        FROM tbl_library_compliance AS f

                                        LEFT JOIN (
                                            SELECT
                                            *
                                            FROM tbl_user
                                        ) AS u
                                        ON f.user_id = u.ID

                                        LEFT JOIN (
                                            SELECT
                                            *
                                            FROM tbl_hr_employee
                                        ) AS e
                                        ON u.employee_id = e.ID

                                        WHERE f.filesize > 0
                                        AND LENGTH(f.file_history) IS NULL
                                    ) o
                                    WHERE o.f_user = $account_id

                                    UNION ALL

                                    SELECT
                                    SUM(total_quantity) AS total
                                    FROM (
                                        SELECT
                                        f.filesize AS f_filesize,
                                        CASE WHEN u.employee_id > 0 THEN e.user_id ELSE u.ID END AS f_user,
                                        f.file_history, 
                                        SUM(j.size) total_quantity
                                        FROM tbl_library_compliance AS f

                                        LEFT JOIN (
                                            SELECT
                                            *
                                            FROM tbl_user
                                        ) AS u
                                        ON f.user_id = u.ID

                                        LEFT JOIN (
                                            SELECT
                                            *
                                            FROM tbl_hr_employee
                                        ) AS e
                                        ON u.employee_id = e.ID

                                        , JSON_TABLE(file_history, '$[*]' COLUMNS (size INTEGER PATH '$.size')) j

                                        WHERE f.filesize > 0
                                        AND LENGTH(f.file_history) > 0
                                        GROUP BY f.file_history
                                    ) o
                                    WHERE o.f_user = $account_id

                                    UNION ALL

                                    SELECT
                                    SUM(f_filesize) AS total
                                    FROM (
                                        SELECT
                                        f.filesize AS f_filesize,
                                        CASE WHEN u.employee_id > 0 THEN e.user_id ELSE u.ID END AS f_user
                                        FROM tbl_library_review AS f

                                        LEFT JOIN (
                                            SELECT
                                            *
                                            FROM tbl_user
                                        ) AS u
                                        ON f.user_id = u.ID

                                        LEFT JOIN (
                                            SELECT
                                            *
                                            FROM tbl_hr_employee
                                        ) AS e
                                        ON u.employee_id = e.ID

                                        WHERE f.filesize > 0
                                        AND LENGTH(f.file_history) IS NULL
                                    ) o
                                    WHERE o.f_user = $account_id

                                    UNION ALL

                                    SELECT
                                    SUM(total_quantity) AS total
                                    FROM (
                                        SELECT
                                        f.filesize AS f_filesize,
                                        CASE WHEN u.employee_id > 0 THEN e.user_id ELSE u.ID END AS f_user,
                                        f.file_history, 
                                        SUM(j.size) total_quantity
                                        FROM tbl_library_review AS f

                                        LEFT JOIN (
                                            SELECT
                                            *
                                            FROM tbl_user
                                        ) AS u
                                        ON f.user_id = u.ID

                                        LEFT JOIN (
                                            SELECT
                                            *
                                            FROM tbl_hr_employee
                                        ) AS e
                                        ON u.employee_id = e.ID

                                        , JSON_TABLE(file_history, '$[*]' COLUMNS (size INTEGER PATH '$.size')) j

                                        WHERE f.filesize > 0
                                        AND LENGTH(f.file_history) > 0
                                        GROUP BY f.file_history
                                    ) o
                                    WHERE o.f_user = $account_id

                                    UNION ALL

                                    SELECT
                                    SUM(f_filesize) AS total
                                    FROM (
                                        SELECT
                                        f.filesize AS f_filesize,
                                        CASE WHEN u.employee_id > 0 THEN e.user_id ELSE u.ID END AS f_user
                                        FROM tbl_library_template AS f

                                        LEFT JOIN (
                                            SELECT
                                            *
                                            FROM tbl_user
                                        ) AS u
                                        ON f.user_id = u.ID

                                        LEFT JOIN (
                                            SELECT
                                            *
                                            FROM tbl_hr_employee
                                        ) AS e
                                        ON u.employee_id = e.ID

                                        WHERE f.filesize > 0
                                        AND LENGTH(f.file_history) IS NULL
                                    ) o
                                    WHERE o.f_user = $account_id

                                    UNION ALL

                                    SELECT
                                    SUM(total_quantity) AS total
                                    FROM (
                                        SELECT
                                        f.filesize AS f_filesize,
                                        CASE WHEN u.employee_id > 0 THEN e.user_id ELSE u.ID END AS f_user,
                                        f.file_history, 
                                        SUM(j.size) total_quantity
                                        FROM tbl_library_template AS f

                                        LEFT JOIN (
                                            SELECT
                                            *
                                            FROM tbl_user
                                        ) AS u
                                        ON f.user_id = u.ID

                                        LEFT JOIN (
                                            SELECT
                                            *
                                            FROM tbl_hr_employee
                                        ) AS e
                                        ON u.employee_id = e.ID

                                        , JSON_TABLE(file_history, '$[*]' COLUMNS (size INTEGER PATH '$.size')) j

                                        WHERE f.filesize > 0
                                        AND LENGTH(f.file_history) > 0
                                        GROUP BY f.file_history
                                    ) o
                                    WHERE o.f_user = $account_id

                                    UNION ALL

                                    SELECT
                                    SUM(f_filesize) AS total
                                    FROM (
                                        SELECT
                                        f.filesize AS f_filesize,
                                        CASE WHEN u.employee_id > 0 THEN e.user_id ELSE u.ID END AS f_user
                                        FROM tbl_library_video AS f

                                        LEFT JOIN (
                                            SELECT
                                            *
                                            FROM tbl_user
                                        ) AS u
                                        ON f.user_id = u.ID

                                        LEFT JOIN (
                                            SELECT
                                            *
                                            FROM tbl_hr_employee
                                        ) AS e
                                        ON u.employee_id = e.ID

                                        WHERE f.filesize > 0
                                        AND LENGTH(f.file_history) IS NULL
                                    ) o
                                    WHERE o.f_user = $account_id

                                    UNION ALL

                                    SELECT
                                    SUM(total_quantity) AS total
                                    FROM (
                                        SELECT
                                        f.filesize AS f_filesize,
                                        CASE WHEN u.employee_id > 0 THEN e.user_id ELSE u.ID END AS f_user,
                                        f.file_history, 
                                        SUM(j.size) total_quantity
                                        FROM tbl_library_video AS f

                                        LEFT JOIN (
                                            SELECT
                                            *
                                            FROM tbl_user
                                        ) AS u
                                        ON f.user_id = u.ID

                                        LEFT JOIN (
                                            SELECT
                                            *
                                            FROM tbl_hr_employee
                                        ) AS e
                                        ON u.employee_id = e.ID

                                        , JSON_TABLE(file_history, '$[*]' COLUMNS (size INTEGER PATH '$.size')) j

                                        WHERE f.filesize > 0
                                        AND LENGTH(f.file_history) > 0
                                        GROUP BY f.file_history
                                    ) o
                                    WHERE o.f_user = $account_id
                                ) o" );
                            if ( mysqli_num_rows($selectComplianceDashboard) > 0 ) {
                                $rowSQL = mysqli_fetch_array($selectComplianceDashboard);
                                $compliance_dashboard = $rowSQL["bytes"];
                                $total_usage += $compliance_dashboard;
                            }

                            // HR (Departmetn, File, Job Description, Trainings)
                            $selectHRModule = mysqli_query( $conn,"SELECT
                                SUM(total) AS bytes
                                FROM (
                                    SELECT
                                    SUM(filesize) AS total
                                    FROM tbl_hr_department 
                                    WHERE user_id = $account_id
                                    AND filesize > 0
                                    AND LENGTH(file_history) IS NULL

                                    UNION ALL

                                    SELECT
                                    SUM(j.size) AS total
                                    FROM tbl_hr_department 
                                    , JSON_TABLE(file_history, '$[*]' COLUMNS (size INTEGER PATH '$.size')) j
                                    WHERE user_id = $account_id
                                    AND LENGTH(file_history) > 0

                                    UNION ALL

                                    SELECT
                                    SUM(filesize) AS total
                                    FROM tbl_hr_file 
                                    WHERE user_id = $account_id
                                    AND filesize > 0
                                    AND LENGTH(file_history) IS NULL

                                    UNION ALL
                                    
                                    SELECT
                                    SUM(j.size) AS total
                                    FROM tbl_hr_file 
                                    , JSON_TABLE(file_history, '$[*]' COLUMNS (size INTEGER PATH '$.size')) j
                                    WHERE user_id = $account_id
                                    AND LENGTH(file_history) > 0

                                    UNION ALL
                                    
                                    SELECT
                                    SUM(filesize) AS total
                                    FROM tbl_hr_job_description 
                                    WHERE user_id = $account_id
                                    AND filesize > 0
                                    AND LENGTH(file_history) IS NULL

                                    UNION ALL
                                    
                                    SELECT
                                    SUM(j.size) AS total
                                    FROM tbl_hr_job_description 
                                    , JSON_TABLE(file_history, '$[*]' COLUMNS (size INTEGER PATH '$.size')) j
                                    WHERE user_id = $account_id
                                    AND LENGTH(file_history) > 0

                                    UNION ALL
                                    
                                    SELECT
                                    SUM(filesize) AS total
                                    FROM tbl_hr_trainings 
                                    WHERE user_id = $account_id
                                    AND filesize > 0
                                    AND LENGTH(file_history) IS NULL

                                    UNION ALL
                                    
                                    SELECT
                                    SUM(j.size) AS total
                                    FROM tbl_hr_trainings 
                                    , JSON_TABLE(file_history, '$[*]' COLUMNS (size INTEGER PATH '$.size')) j
                                    WHERE user_id = $account_id
                                    AND LENGTH(file_history) > 0
                                ) o" );
                            if ( mysqli_num_rows($selectHRModule) > 0 ) {
                                $rowSQL = mysqli_fetch_array($selectHRModule);
                                $hr_module = $rowSQL["bytes"];
                                $total_usage += $hr_module;
                            }

                            // Product
                            $selectProductModule = mysqli_query( $conn,"SELECT
                                SUM(total) AS bytes
                                FROM (
                                    SELECT
                                    SUM(files) AS total
                                    FROM tbl_products 
                                    WHERE user_id = $account_id
                                    AND files > 0
                                    AND LENGTH(file_history) IS NULL

                                    UNION ALL

                                    SELECT
                                    SUM(j.size) AS total
                                    FROM tbl_products 
                                    , JSON_TABLE(file_history, '$[*]' COLUMNS (size INTEGER PATH '$.size')) j
                                    WHERE user_id = $account_id
                                    AND LENGTH(file_history) > 0
                                ) o" );
                            if ( mysqli_num_rows($selectProductModule) > 0 ) {
                                $rowSQL = mysqli_fetch_array($selectProductModule);
                                $product_module = $rowSQL["bytes"];
                                $total_usage += $product_module;
                            }

                            // Service
                            $selectServiceModule = mysqli_query( $conn,"SELECT
                                SUM(total) AS bytes
                                FROM (
                                    SELECT
                                    SUM(filesize) AS total
                                    FROM tbl_service 
                                    WHERE user_id = $account_id
                                    AND filesize > 0
                                    AND LENGTH(file_history) IS NULL

                                    UNION ALL

                                    SELECT
                                    SUM(j.size) AS total
                                    FROM tbl_service 
                                    , JSON_TABLE(file_history, '$[*]' COLUMNS (size INTEGER PATH '$.size')) j
                                    WHERE user_id = $account_id
                                    AND LENGTH(file_history) > 0
                                ) o" );
                            if ( mysqli_num_rows($selectServiceModule) > 0 ) {
                                $rowSQL = mysqli_fetch_array($selectServiceModule);
                                $service_module = $rowSQL["bytes"];
                                $total_usage += $service_module;
                            }

                            // Customer (Document, Regulatory, Services, Template)
                            $selectCustomerModule = mysqli_query( $conn,"SELECT
                                SUM(bytes) AS sum_bytes,
                                SUM(bytes_other) AS sum_bytes_other
                                FROM (
                                    SELECT
                                    SUM(d.filesize) AS bytes,
                                    0 AS bytes_other
                                    FROM tbl_supplier AS s

                                    LEFT JOIN (
                                        SELECT
                                        *
                                        FROM tbl_supplier_document
                                        WHERE filetype = 1
                                        AND LENGTH(file) > 0
                                        AND filesize > 0
                                        AND LENGTH(file_history) IS NULL
                                    ) AS d
                                    ON s.ID = d.supplier_id
                                    WHERE s.page = 2
                                    AND s.user_id = $account_id

                                    UNION ALL

                                    SELECT
                                    SUM(d.total_quantity) AS bytes,
                                    0 AS bytes_other
                                    FROM tbl_supplier AS s

                                    LEFT JOIN (
                                        SELECT
                                        *,
                                        SUM(j.size) total_quantity
                                        FROM tbl_supplier_document
                                        , JSON_TABLE(file_history, '$[*]' COLUMNS (size INTEGER PATH '$.size')) j
                                        WHERE LENGTH(file_history) > 0
                                    ) AS d
                                    ON s.ID = d.supplier_id
                                    WHERE s.page = 2
                                    AND s.user_id = $account_id

                                    UNION ALL

                                    SELECT
                                    SUM(filesize) AS bytes,
                                    0 AS bytes_other
                                    FROM tbl_supplier_regulatory
                                    WHERE filetype = 1
                                    AND LENGTH(files) > 0
                                    AND LENGTH(file_history) IS NULL
                                    AND user_id = $account_id

                                    UNION ALL

                                    SELECT
                                    SUM(j.size) AS bytes,
                                    0 AS bytes_other
                                    FROM tbl_supplier_regulatory
                                    , JSON_TABLE(file_history, '$[*]' COLUMNS (size INTEGER PATH '$.size')) j
                                    WHERE LENGTH(file_history) > 0
                                    AND user_id = $account_id

                                    UNION ALL

                                    SELECT 
                                    SUM(ser.spec_filesize) AS bytes,
                                    SUM(ser.other_filesize) AS bytes_other
                                    FROM tbl_supplier AS s

                                    LEFT JOIN (
                                        SELECT
                                        *
                                        FROM tbl_supplier_service
                                        WHERE LENGTH(file_history) IS NULL
                                    ) AS ser
                                    ON FIND_IN_SET(ser.ID, REPLACE(s.service, ' ', '')  ) > 0
                                    WHERE s.page = 2
                                    AND s.user_id = $account_id

                                    UNION ALL

                                    SELECT 
                                    SUM(ser.total_quantity) AS bytes,
                                    SUM(ser.total_quantity2) AS bytes_other
                                    FROM tbl_supplier AS s

                                    LEFT JOIN (
                                        SELECT
                                        *,
                                        SUM(j.size) AS total_quantity,
                                        SUM(j2.size2) AS total_quantity2
                                        FROM tbl_supplier_service
                                        , JSON_TABLE(file_history, '$[*]' COLUMNS (size INTEGER PATH '$.size')) j
                                        , JSON_TABLE(other, '$[*]' COLUMNS (size2 INTEGER PATH '$.size')) j2
                                        WHERE LENGTH(file_history) > 0
                                    ) AS ser
                                    ON FIND_IN_SET(ser.ID, REPLACE(s.service, ' ', '')  ) > 0
                                    WHERE s.page = 2
                                    AND s.user_id = $account_id

                                    UNION ALL

                                    SELECT
                                    SUM(filesize) AS bytes,
                                    0 AS bytes_other
                                    FROM tbl_supplier_template
                                    WHERE filetype = 1
                                    AND LENGTH(file) > 0
                                    AND LENGTH(file_history) IS NULL
                                    AND user_id = $account_id

                                    UNION ALL

                                    SELECT
                                    SUM(j.size) AS bytes,
                                    0 AS bytes_other
                                    FROM tbl_supplier_template
                                    , JSON_TABLE(file_history, '$[*]' COLUMNS (size INTEGER PATH '$.size')) j
                                    WHERE LENGTH(file_history) > 0
                                    AND user_id = $account_id
                                ) o" );
                            if ( mysqli_num_rows($selectCustomerModule) > 0 ) {
                                $rowSQL = mysqli_fetch_array($selectCustomerModule);
                                $customer_module = $rowSQL["sum_bytes"] + $rowSQL["sum_bytes_other"];
                                $total_usage += $customer_module;
                            }

                            // Supplier (Document, Regulatory, Material, Services, Template)
                            $selectSupplierModule = mysqli_query( $conn,"SELECT
                                SUM(bytes) AS sum_bytes,
                                SUM(bytes_other) AS sum_bytes_other
                                FROM (
                                    SELECT
                                    SUM(d.filesize) AS bytes,
                                    0 AS bytes_other
                                    FROM tbl_supplier AS s

                                    LEFT JOIN (
                                        SELECT
                                        *
                                        FROM tbl_supplier_document
                                        WHERE filetype = 1
                                        AND LENGTH(file) > 0
                                        AND filesize > 0
                                        AND LENGTH(file_history) IS NULL
                                    ) AS d
                                    ON s.ID = d.supplier_id
                                    WHERE s.page = 1
                                    AND s.user_id = $account_id

                                    UNION ALL

                                    SELECT
                                    SUM(d.total_quantity) AS bytes,
                                    0 AS bytes_other
                                    FROM tbl_supplier AS s

                                    LEFT JOIN (
                                        SELECT
                                        *,
                                        SUM(j.size) total_quantity
                                        FROM tbl_supplier_document
                                        , JSON_TABLE(file_history, '$[*]' COLUMNS (size INTEGER PATH '$.size')) j
                                        WHERE LENGTH(file_history) > 0
                                    ) AS d
                                    ON s.ID = d.supplier_id
                                    WHERE s.page = 1
                                    AND s.user_id = $account_id

                                    UNION ALL

                                    SELECT
                                    SUM(filesize) AS bytes,
                                    0 AS bytes_other
                                    FROM tbl_supplier_regulatory
                                    WHERE filetype = 1
                                    AND LENGTH(files) > 0
                                    AND LENGTH(file_history) IS NULL
                                    AND user_id = $account_id

                                    UNION ALL

                                    SELECT
                                    SUM(j.size) AS bytes,
                                    0 AS bytes_other
                                    FROM tbl_supplier_regulatory
                                    , JSON_TABLE(file_history, '$[*]' COLUMNS (size INTEGER PATH '$.size')) j
                                    WHERE LENGTH(file_history) > 0
                                    AND user_id = $account_id

                                    UNION ALL

                                    SELECT 
                                    SUM(m.spec_filesize) AS bytes,
                                    SUM(m.other_filesize) AS bytes_other
                                    FROM tbl_supplier AS s

                                    LEFT JOIN (
                                        SELECT
                                        *
                                        FROM tbl_supplier_material
                                        WHERE LENGTH(file_history) IS NULL
                                    ) AS m
                                    ON FIND_IN_SET(m.ID, REPLACE(s.material, ' ', '')  ) > 0
                                    WHERE s.page = 1
                                    AND s.user_id = $account_id

                                    UNION ALL

                                    SELECT 
                                    SUM(m.total_quantity) AS bytes,
                                    SUM(m.total_quantity2) AS bytes_other
                                    FROM tbl_supplier AS s

                                    LEFT JOIN (
                                        SELECT
                                        *,
                                        SUM(j.size) AS total_quantity,
                                        SUM(j2.size2) AS total_quantity2
                                        FROM tbl_supplier_material
                                        , JSON_TABLE(file_history, '$[*]' COLUMNS (size INTEGER PATH '$.size')) j
                                        , JSON_TABLE(other, '$[*]' COLUMNS (size2 INTEGER PATH '$.size')) j2
                                        WHERE LENGTH(file_history) > 0
                                    ) AS m
                                    ON FIND_IN_SET(m.ID, REPLACE(s.material, ' ', '')  ) > 0
                                    WHERE s.page = 1
                                    AND s.user_id = $account_id

                                    UNION ALL

                                    SELECT 
                                    SUM(ser.spec_filesize) AS bytes,
                                    SUM(ser.other_filesize) AS bytes_other
                                    FROM tbl_supplier AS s

                                    LEFT JOIN (
                                        SELECT
                                        *
                                        FROM tbl_supplier_service
                                        WHERE LENGTH(file_history) IS NULL
                                    ) AS ser
                                    ON FIND_IN_SET(ser.ID, REPLACE(s.service, ' ', '')  ) > 0
                                    WHERE s.page = 1
                                    AND s.user_id = $account_id

                                    UNION ALL

                                    SELECT 
                                    SUM(ser.total_quantity) AS bytes,
                                    SUM(ser.total_quantity2) AS bytes_other
                                    FROM tbl_supplier AS s

                                    LEFT JOIN (
                                        SELECT
                                        *,
                                        SUM(j.size) AS total_quantity,
                                        SUM(j2.size2) AS total_quantity2
                                        FROM tbl_supplier_service
                                        , JSON_TABLE(file_history, '$[*]' COLUMNS (size INTEGER PATH '$.size')) j
                                        , JSON_TABLE(other, '$[*]' COLUMNS (size2 INTEGER PATH '$.size')) j2
                                        WHERE LENGTH(file_history) > 0
                                    ) AS ser
                                    ON FIND_IN_SET(ser.ID, REPLACE(s.service, ' ', '')  ) > 0
                                    WHERE s.page = 1
                                    AND s.user_id = $account_id

                                    UNION ALL

                                    SELECT
                                    SUM(filesize) AS bytes,
                                    0 AS bytes_other
                                    FROM tbl_supplier_template
                                    WHERE filetype = 1
                                    AND LENGTH(file) > 0
                                    AND LENGTH(file_history) IS NULL
                                    AND user_id = $account_id

                                    UNION ALL

                                    SELECT
                                    SUM(j.size) AS bytes,
                                    0 AS bytes_other
                                    FROM tbl_supplier_template
                                    , JSON_TABLE(file_history, '$[*]' COLUMNS (size INTEGER PATH '$.size')) j
                                    WHERE LENGTH(file_history) > 0
                                    AND user_id = $account_id
                                ) o" );
                            if ( mysqli_num_rows($selectSupplierModule) > 0 ) {
                                $rowSQL = mysqli_fetch_array($selectSupplierModule);
                                $supplier_module = $rowSQL["sum_bytes"] + $rowSQL["sum_bytes_other"];
                                $total_usage += $supplier_module;
                            }

                            // Archive
                            $selectArchiveModule = mysqli_query( $conn,"SELECT
                                SUM(total) AS bytes
                                FROM (
                                    SELECT
                                    SUM(filesize) AS total
                                    FROM tbl_archiving 
                                    WHERE user_id = $account_id
                                    AND filesize > 0
                                    AND LENGTH(file_history) IS NULL

                                    UNION ALL

                                    SELECT
                                    SUM(j.size) AS total
                                    FROM tbl_archiving 
                                    , JSON_TABLE(file_history, '$[*]' COLUMNS (size INTEGER PATH '$.size')) j
                                    WHERE user_id = $account_id
                                    AND LENGTH(file_history) > 0
                                ) o" );
                            if ( mysqli_num_rows($selectArchiveModule) > 0 ) {
                                $rowSQL = mysqli_fetch_array($selectArchiveModule);
                                $archive_module = $rowSQL["bytes"];
                                $total_usage += $archive_module;
                            }

                            // Library
                            $selectLibraryModule = mysqli_query( $conn,"SELECT
                                SUM(total) AS bytes
                                FROM (
                                    SELECT
                                    SUM(filesize) AS total
                                    FROM tbl_lib 
                                    WHERE user_id = $account_id
                                    AND filesize > 0
                                    AND LENGTH(file_history) IS NULL

                                    UNION ALL

                                    SELECT
                                    SUM(j.size) AS total
                                    FROM tbl_lib 
                                    , JSON_TABLE(file_history, '$[*]' COLUMNS (size INTEGER PATH '$.size')) j
                                    WHERE user_id = $account_id
                                    AND LENGTH(file_history) > 0
                                ) o" );
                            if ( mysqli_num_rows($selectLibraryModule) > 0 ) {
                                $rowSQL = mysqli_fetch_array($selectLibraryModule);
                                $library_module = $rowSQL["bytes"];
                                $total_usage += $library_module;
                            }

                            // RVM
                            $selectRVMModule = mysqli_query( $conn,"SELECT
                                SUM(total) AS bytes
                                FROM (
                                    SELECT
                                    SUM(filesize) AS total
                                    FROM tbl_eforms 
                                    WHERE user_id = $account_id
                                    AND filesize > 0
                                    AND LENGTH(file_history) IS NULL

                                    UNION ALL

                                    SELECT
                                    SUM(j.size) AS total
                                    FROM tbl_eforms 
                                    , JSON_TABLE(file_history, '$[*]' COLUMNS (size INTEGER PATH '$.size')) j
                                    WHERE user_id = $account_id
                                    AND LENGTH(file_history) > 0
                                ) o" );
                            if ( mysqli_num_rows($selectRVMModule) > 0 ) {
                                $rowSQL = mysqli_fetch_array($selectRVMModule);
                                $rvm_module = $rowSQL["bytes"];
                                $total_usage += $rvm_module;
                            }

                            // FFVA
                            $selectFFVAModule = mysqli_query( $conn,"SELECT
                                SUM(total) AS bytes
                                FROM (
                                    SELECT
                                    SUM(filesize) AS total
                                    FROM tbl_ffva 
                                    WHERE user_id = $account_id
                                    AND filesize > 0
                                    AND LENGTH(file_history) IS NULL

                                    UNION ALL

                                    SELECT
                                    SUM(j.size) AS total
                                    FROM tbl_ffva 
                                    , JSON_TABLE(file_history, '$[*]' COLUMNS (size INTEGER PATH '$.size')) j
                                    WHERE user_id = $account_id
                                    AND LENGTH(file_history) > 0
                                ) o" );
                            if ( mysqli_num_rows($selectFFVAModule) > 0 ) {
                                $rowSQL = mysqli_fetch_array($selectFFVAModule);
                                $ffva_module = $rowSQL["bytes"];
                                $total_usage += $ffva_module;
                            }

                            echo '<table class="table table-bordered table-hover">
                                <thead>
                                    <tr>';
                                        if (!empty($compliance_dashboard)) { echo '<th>Compliance Dashboard</th>'; }
                                        if (!empty($hr_module)) { echo '<th>HR Module</th>'; }
                                        if (!empty($product_module)) { echo '<th>Product Module</th>'; }
                                        if (!empty($service_module)) { echo '<th>Service Module</th>'; }
                                        if (!empty($customer_module)) { echo '<th>Customer Module</th>'; }
                                        if (!empty($supplier_module)) { echo '<th>Supplier Module</th>'; }
                                        if (!empty($archive_module)) { echo '<th>Archive Module</th>'; }
                                        if (!empty($library_module)) { echo '<th>Library Module</th>'; }
                                        if (!empty($rvm_module)) { echo '<th>RVM Module</th>'; }
                                        if (!empty($ffva_module)) { echo '<th>FFVA Module</th>'; }
                                        if (!empty($total_usage)) { echo '<th>Total Usage</th>'; }
                                    echo '</tr>
                                </thead>
                                <tbody>
                                    <tr>';
                                        if (!empty($compliance_dashboard)) { echo '<td>'.formatSizeUnits($compliance_dashboard).'</td>'; }
                                        if (!empty($hr_module)) { echo '<td>'.formatSizeUnits($hr_module).'</td>'; }
                                        if (!empty($product_module)) { echo '<td>'.formatSizeUnits($product_module).'</td>'; }
                                        if (!empty($service_module)) { echo '<td>'.formatSizeUnits($service_module).'</td>'; }
                                        if (!empty($customer_module)) { echo '<td>'.formatSizeUnits($customer_module).'</td>'; }
                                        if (!empty($supplier_module)) { echo '<td>'.formatSizeUnits($supplier_module).'</td>'; }
                                        if (!empty($archive_module)) { echo '<td>'.formatSizeUnits($archive_module).'</td>'; }
                                        if (!empty($library_module)) { echo '<td>'.formatSizeUnits($library_module).'</td>'; }
                                        if (!empty($rvm_module)) { echo '<td>'.formatSizeUnits($rvm_module).'</td>'; }
                                        if (!empty($ffva_module)) { echo '<td>'.formatSizeUnits($ffva_module).'</td>'; }
                                        if (!empty($total_usage)) { echo '<td>'.formatSizeUnits($total_usage).'</td>'; }
                                    echo '</tr>
                                </tbody>
                            </table>';
                        } else {
                            echo 'No Record Yet';
                        }
                    }
                    
                echo '</div>
            </div>
        </div>';

        mysqli_close($conn);
	}
	if( isset($_GET['modalView_Customer_Report']) ) {
        $id = $_GET['modalView_Customer_Report'];

        if (!empty($_COOKIE['switchAccount'])) {
            $portal_user = $_COOKIE['ID'];
            $user_id = $_COOKIE['switchAccount'];
        }
        else {
            $portal_user = $_COOKIE['ID'];
            $user_id = employerID($portal_user);
        }

        $selectData = mysqli_query( $conn,"WITH RECURSIVE cte (s_ID, s_name, s_employee_id, s_document, d_ID, d_type, d_name, d_file, d_file_due, d_status, d_count) AS
            (
                SELECT
                s1.ID AS s_ID,
                s1.name AS s_name,
                s1.employee_id AS s_employee_id,
                s1.document AS s_document,
                d1.ID AS d_ID,
                d1.type AS d_type,
                d1.name AS d_name,
                d1.file AS d_file,
                d1.file_due AS d_file_due,
                CASE 
                    WHEN 
                        LENGTH(d1.file) > 0 
                        AND (STR_TO_DATE(d1.file_due, '%m/%d/%Y') > CURDATE() OR DATE(d1.file_due) > CURDATE())
                        AND d1.reviewed_by > 0
                        AND d1.approved_by > 0
                    THEN 1 
                    ELSE 0 
                END AS d_status,
                CASE WHEN d1.ID > 0 THEN 1 ELSE 0 END AS d_count

                FROM tbl_supplier AS s1

                LEFT JOIN (
                    SELECT
                    * 
                    FROM tbl_supplier_document 
                    WHERE type = 0
                    AND ID IN (
                        SELECT
                        MAX(ID)
                        FROM tbl_supplier_document
                        WHERE type = 0
                        GROUP BY name, supplier_id
                    )
                ) AS d1
                ON s1.ID = d1.supplier_ID
                AND FIND_IN_SET(d1.name, REPLACE(REPLACE(s1.document, ' ', ''), '|',','  )  ) > 0
                WHERE s1.page = $id
                AND s1.is_deleted = 0 
                AND s1.user_id = $user_id
                
                UNION ALL
                
                SELECT
                s2.ID AS s_ID,
                s2.name AS s_name,
                s2.employee_id AS s_employee_id,
                s2.document_other AS s_document,
                d2.ID AS d_ID,
                d2.type AS d_type,
                d2.name AS d_name,
                d2.file AS d_file,
                d2.file_due AS d_file_due,
                CASE 
                    WHEN 
                        LENGTH(d2.file) > 0 
                        AND (STR_TO_DATE(d2.file_due, '%m/%d/%Y') > CURDATE() OR DATE(d2.file_due) > CURDATE())
                        AND d2.reviewed_by > 0
                        AND d2.approved_by > 0
                    THEN 1 
                    ELSE 0 
                END AS d_status,
                CASE WHEN d2.ID > 0 THEN 1 ELSE 0 END AS d_count

                FROM tbl_supplier AS s2

                LEFT JOIN (
                    SELECT
                    * 
                    FROM tbl_supplier_document 
                    WHERE type = 1
                    AND ID IN (
                        SELECT
                        MAX(ID)
                        FROM tbl_supplier_document
                        WHERE type = 1
                        GROUP BY name, supplier_id
                    )
                ) AS d2
                ON s2.ID = d2.supplier_ID
                AND FIND_IN_SET(d2.name, REPLACE(s2.document_other, ' | ', ',')  )   > 0
                WHERE s2.page = $id
                AND s2.is_deleted = 0 
                AND s2.user_id = $user_id
            )
            SELECT 
            s_ID, 
            s_name, 
            s_employee_id,
            SUM(d_status) AS d_compliance,
            SUM(d_count) AS d_counting
            FROM cte

            GROUP BY s_ID

            ORDER BY s_name" );
        if ( mysqli_num_rows($selectData) > 0 ) {
            while($row = mysqli_fetch_array($selectData)) {
                $ID = $row["s_ID"];
                $name = $row["s_name"];

                $compliance = 0;
                $d_compliance = $row["d_compliance"];
                $d_counting = $row["d_counting"];
                if ($d_counting > 0) { $compliance = ($d_compliance / $d_counting) * 100; }

                $employee_arr = array();
                $employee_id = $row["s_employee_id"];
                if (!empty($employee_id)) { $employee_id_arr = explode(", ", $employee_id); }

                $selectEmployee = mysqli_query( $conn,"SELECT
                    e.ID AS e_ID,
                    e.first_name AS e_first_name,
                    e.last_name AS e_last_name
                    FROM tbl_hr_employee AS e

                    LEFT JOIN (
                        SELECT
                        *
                        FROM tbl_user
                        WHERE is_verified = 1 
                        AND is_active = 1
                    ) AS u
                    ON e.ID = u.employee_id

                    WHERE e.suspended = 0 
                    AND e.status = 1 
                    AND e.user_id = $user_id
                    AND FIND_IN_SET(e.ID, REPLACE('".$employee_id."', ' ', '')  ) > 0

                    ORDER BY e.first_name");
                if ( mysqli_num_rows($selectEmployee) > 0 ) {
                    while($rowEmployee = mysqli_fetch_array($selectEmployee)) {
                        $emp_name = $rowEmployee["e_first_name"] .' '. $rowEmployee["e_last_name"];
                        array_push($employee_arr, $emp_name);
                    }
                }

                echo '<tr>
                    <td class="text-center">'.intval($compliance).'%</td>
                    <td>'.htmlentities($name ?? '').'</td>
                    <td>'.implode(', ', $employee_arr).'</td>
                </tr>';
            }
        }
    }
	if( isset($_GET['modalView_Customer_Industry']) ) {
		$id = $_GET['modalView_Customer_Industry'];
		$c = $_GET['c'];

		$selectRequirement = mysqli_query( $conn,"SELECT * FROM tbl_supplier_requirement WHERE country IS NULL ORDER BY name" );
		if ($c != "US") {
			$selectRequirement = mysqli_query( $conn,"SELECT * FROM tbl_supplier_requirement ORDER BY name" );
		}
        if ( mysqli_num_rows($selectRequirement) > 0 ) {
            while($row = mysqli_fetch_array($selectRequirement)) {
            	$industry = array();
            	$country = array();
            	if (!empty( $row["industry_id"])) { $industry = explode(", ", $row["industry_id"]); }
            	if (!empty( $row["country"])) { $country = explode(", ", $row["country"]); }

                if ($c != "US") {
                	if (in_array($id, $country)) {
		                echo '<label class="mt-checkbox mt-checkbox-outline"> '.$row["name"].'
		                    <input type="checkbox" value="'.$row["ID"].'" name="document[]" onchange="checked_Requirement(this, 1, 0, 0)" />
		                    <span></span>
		                </label>';
	                }
                }
                if (in_array($id, $industry)) {
	                echo '<label class="mt-checkbox mt-checkbox-outline"> '.$row["name"].'
	                    <input type="checkbox" value="'.$row["ID"].'" name="document[]" onchange="checked_Requirement(this, 1, 0, 0)" />
	                    <span></span>
	                </label>';
                } else if ($id == 0) {
	                echo '<label class="mt-checkbox mt-checkbox-outline"> '.$row["name"].'
	                    <input type="checkbox" value="'.$row["ID"].'" name="document[]" onchange="checked_Requirement(this, 1, 0, 0)" />
	                    <span></span>
	                </label>';
                }
            }
        }
	}
	if( isset($_GET['modalView_Customer_Requirement']) ) {
		$id = $_GET['modalView_Customer_Requirement'];
		$modal = $_GET['modal'];
        $main = $_GET['main'];

		if (!empty($_COOKIE['switchAccount'])) {
			$portal_user = $_COOKIE['ID'];
			$user_id = $_COOKIE['switchAccount'];
		}
		else {
			$portal_user = $_COOKIE['ID'];
			$user_id = employerID($portal_user);
		}

        $current_client = 0;
        if (isset($_COOKIE['client'])) { $current_client = $_COOKIE['client']; }

        $requirements = 0;
        $current_dateNow_o = date('Y/m/d');
        $current_dateNow = new DateTime($current_dateNow_o);
        $current_dateNow = $current_dateNow->format('M d, Y');

        $current_userID = $_COOKIE['ID'];
        $current_userEmployerID = employerID($current_userID);

        $selectData = mysqli_query( $conn,"SELECT * FROM tbl_supplier WHERE ID = $main" );
        if ( mysqli_num_rows($selectData) > 0 ) {
            $row = mysqli_fetch_array($selectData);
            $page = $row["page"];
            $document = $row["document"];
            $document_arr = explode(" | ", $document);
            if (count($document_arr) <= 1) {
                $document_arr = explode(", ", $document);
            }

            if (!empty($document)) {
                $selectRequirement = mysqli_query( $conn,"SELECT * FROM tbl_supplier_requirement WHERE ID = $id" );
                while($rowRequirement = mysqli_fetch_array($selectRequirement)) {
                    $req_id = $rowRequirement["ID"];
                    $req_name = $rowRequirement["name"];

                    foreach ($document_arr as $value) {
                        if ( $value == $req_id ) {
                            $selectDocument = mysqli_query( $conn,"SELECT * FROM tbl_supplier_document WHERE supplier_id = $main AND name = $req_id" );
                            if ( mysqli_num_rows($selectDocument) > 0 ) {
                                $rowDocument = mysqli_fetch_array($selectDocument);
                                $doc_id = $rowDocument["ID"];
                                $doc_file = $rowDocument["file"];
                                $doc_filetype = $rowDocument["filetype"];
                                $doc_filename = $rowDocument["filename"];
                                $doc_file_template = $rowDocument["template"];
                                $doc_file_comment = $rowDocument["comment"];
                                $doc_file_reviewed = $rowDocument["reviewed_by"];
                                $doc_file_approved = $rowDocument["approved_by"];

                                $doc_file_date = $rowDocument["file_date"];
                                if (!empty($doc_file_date)) {
                                    $doc_file_date = new DateTime($doc_file_date);
                                    $doc_file_date_o = $doc_file_date->format('Y/m/d');
                                    $doc_file_date = $doc_file_date->format('m/d/Y');
                                }

                                $doc_file_due = $rowDocument["file_due"];
                                if (!empty($doc_file_due)) {
                                    $doc_file_due = new DateTime($doc_file_due);
                                    $doc_file_due_o = $doc_file_due->format('Y/m/d');
                                    $doc_file_due_o_nearly = date('Y/m/d', strtotime($doc_file_due_o. ' - 30 days'));
                                    $doc_file_due = $doc_file_due->format('m/d/Y');
                                };

                                $requirements++;

                                echo '<tr class="tr_'.$req_id.'">
                                    <td rowspan="2">
                                        <input type="hidden" class="form-control" name="document_name[]" value="'.$req_id.'" required />';

                                        $doc_stat = '';
                                        if (!empty($doc_file_date) AND !empty($doc_file_due)) {
                                            if ($doc_file_date_o < $current_dateNow_o && $doc_file_due_o < $current_dateNow_o) {
                                                $doc_stat = 'text-danger';
                                            } else {
                                                if ($doc_file_date_o <= $current_dateNow_o && $doc_file_due_o_nearly <= $current_dateNow_o) {
                                                    $doc_stat = 'text-warning';
                                                }
                                            }
                                        }

                                        echo '<b class="'.$doc_stat.'">'.$req_name.'</b>
                                    </td>
                                    <td class="text-center">';
                                        if (!empty($doc_file)) {
                                            $type = 'iframe';
                                            if ($doc_filetype == 1) {
                                                $fileExtension = fileExtension($doc_file);
                                                $src = $fileExtension['src'];
                                                $embed = $fileExtension['embed'];
                                                $type = $fileExtension['type'];
                                                $file_extension = $fileExtension['file_extension'];
                                                $url = $base_url.'uploads/supplier/';

                                                $doc_file = $src.$url.rawurlencode($doc_file).$embed;
                                            } else {
                                                $doc_file = preg_replace('#[^/]*$#', '', $doc_file).'preview';
                                            }

                                            echo '<select class="form-control '; echo !empty($doc_file) ? 'hide':''; echo '" name="document_filetype[]" onchange="changeType(this)" required>
                                                <option value="0">Select option</option>
                                                <option value="1">Manual Upload</option>
                                                <option value="2">Youtube URL</option>
                                                <option value="3">Google Drive URL</option>
                                            </select>
                                            <input class="form-control margin-top-15 fileUpload" type="file" name="document_file[]" onchange="changeFile(this, this.value)" style="display: none;" />
                                            <input class="form-control margin-top-15 fileURL" type="url" name="document_fileurl[]" style="display: none;" placeholder="https://" />
                                            <p class="'; echo !empty($doc_file) ? '':'hide'; echo '" style="margin: 0;"><a href="'.$doc_file.'" data-src="'.$doc_file.'" data-fancybox data-type="'.$type.'" class="btn btn-sm btn-info">View</a> | <button type="button" class="btn btn-sm red-haze uploadNew" onclick="uploadNew(this)">Upload</button></p>';
                                        } else {
                                            echo '<select class="form-control hide" name="document_filetype[]" onchange="changeType(this)" required>
                                                <option value="0">Select option</option>
                                                <option value="1">Manual Upload</option>
                                                <option value="2">Youtube URL</option>
                                                <option value="3">Google Drive URL</option>
                                            </select>
                                            <input class="form-control margin-top-15 fileUpload" type="file" name="document_file[]" onchange="changeFile(this, this.value)" style="display: none;" />
                                            <input class="form-control margin-top-15 fileURL" type="url" name="document_fileurl[]" style="display: none;" placeholder="https://" />
                                            <p style="margin: 0;"><button type="button" class="btn btn-sm red-haze uploadNew" onclick="uploadNew(this)">Upload</button></p>';
                                        }
                                    echo '</td>
                                    <td>';

                                        if (!empty($doc_filename)) {
                                            echo '<input type="text" class="form-control document_filename hide" name="document_filename[]" value="'.$doc_filename.'" placeholder="Document Name" />
                                            <p style="margin: 0;">'.$doc_filename.'</p>';
                                        } else {
                                            echo '<input type="text" class="form-control document_filename" name="document_filename[]" placeholder="Document Name" />';
                                        }
                                        
                                    echo '</td>
                                    <td class="text-center">
                                        <div class="input-group">
                                            <input type="text" class="form-control daterange '; if (empty($doc_file_date) || empty($doc_file_due)) { echo 'daterange_empty'; } echo '" name="document_daterange[]" value="'; if (!empty($doc_file_date) && !empty($doc_file_due)) { echo $doc_file_date .' - '. $doc_file_due; } echo '" />
                                            <span class="input-group-btn">
                                                <button class="btn default date-range-toggle" type="button" onclick="widget_date_clears(this)">
                                                    <i class="fa fa-close"></i>
                                                </button>
                                            </span>
                                        </div>
                                        <input type="date" class="form-control hide" name="document_date[]" value="'.$doc_file_date.'" />
                                        <input type="date" class="form-control hide" name="document_due[]" value="'.$doc_file_due.'" />
                                    </td>
                                    <td rowspan="2" class="text-center '; echo $current_client == 0 ? '':'hide'; echo '">
                                        <input type="file" class="form-control hide" name="document_template[]" />';

                                        $selectTemplate = mysqli_query( $conn,"SELECT * FROM tbl_supplier_template WHERE user_id = $user_id AND requirement_id = $req_id" );
                                        if ( mysqli_num_rows($selectTemplate) > 0 ) {
                                            $rowTemplate = mysqli_fetch_array($selectTemplate);
                                            $temp_ID = $rowTemplate["ID"];
                                            $temp_file = $rowTemplate["file"];

                                            $type = 'iframe';
                                            $filetype = $rowTemplate["filetype"];
                                            if ($filetype == 1) {
                                                $fileExtension = fileExtension($temp_file);
                                                $src = $fileExtension['src'];
                                                $embed = $fileExtension['embed'];
                                                $type = $fileExtension['type'];
                                                $file_extension = $fileExtension['file_extension'];
                                                $url = $base_url.'uploads/supplier/';

                                                $temp_file = $src.$url.rawurlencode($temp_file).$embed;
                                            } else if ($filetype == 3) {
                                                $temp_file = preg_replace('#[^/]*$#', '', $temp_file).'preview';
                                            }

                                            echo '<p style="margin: 0;">
                                                <a href="'.$temp_file.'" data-src="'.$temp_file.'" data-fancybox data-type="'.$type.'" class="btn btn-sm btn-info">View</a> |
                                                <a href="#modalTemplate2" class="btn btn-sm red-haze" data-toggle="modal" onclick="btnTemplate2('.$req_id.', '.$temp_ID.', 2)">Upload</a>
                                            </p>';
                                        } else {
                                            echo '<a href="#modalTemplate2" class="btn btn-sm red-haze" data-toggle="modal" onclick="btnTemplate2('.$req_id.', 0, 2)">Upload</a>';
                                        }

                                    echo '</td>
                                    <td rowspan="2" class="text-center">';

                                        $doc_com = 0;
                                        if (!empty($doc_file_due)) {
                                            if ($doc_file_due_o >= $current_dateNow_o && $doc_file_approved > 0) { $doc_com = 100; }
                                        }
                                        echo $doc_com.'%'; 

                                    echo '</td>
                                </tr>
                                <tr class="tr_'.$req_id.'">
                                    <td colspan="3">';

                                        $selectComment = mysqli_query( $conn,"SELECT * FROM tbl_supplier_comment WHERE supplier_document_id = '".$doc_id."'" );
                                        if ( mysqli_num_rows($selectComment) > 0 ) {
                                            echo '<ul>';
                                                while($rowComment = mysqli_fetch_array($selectComment)) {
                                                    $comment_text = $rowComment["comment"];

                                                    $comment_user = $rowComment["portal_user"];
                                                    $selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $comment_user" );
                                                    $rowUser = mysqli_fetch_array($selectUser);
                                                    $comment_user_name = $rowUser["first_name"] .' '. $rowUser["last_name"];
                                                    
                                                    $comment_last_modified = $rowComment["last_modified"];
                                                    $comment_last_modified = new DateTime($comment_last_modified);
                                                    $comment_last_modified = $comment_last_modified->format('M d, Y');

                                                    echo '<li>
                                                        <b>'.$comment_user_name.'</b> | <i>'.$comment_last_modified.'</i><br>
                                                        '.$comment_text.'
                                                    </li>';
                                                }
                                            echo '</ul>';
                                        }

                                        echo '<input type="text" class="form-control" name="document_comment[]" placeholder="Comment" />';
                                        if ($page == 1) {
                                            if ($current_userEmployerID == 34 OR $current_userEmployerID == 27 OR $current_userEmployerID == 464 OR $current_userEmployerID == 1106) {
                                                echo '<div class="row margin-top-10">
                                                    <div class="col-md-6">
                                                        <div class="form-group">
                                                            <label class="control-label">Reviewed By</label>';

                                                            if ($doc_file_reviewed  > 0) {
                                                                $selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $doc_file_reviewed" );
                                                                if ( mysqli_num_rows($selectUser) > 0 ) {
                                                                    $rowUser = mysqli_fetch_array($selectUser);
                                                                    $rowUserName = $rowUser["first_name"] .' '. $rowUser["last_name"];

                                                                    echo '<input type="hidden" class="form-control" name="document_reviewed[]" value="'.$doc_file_reviewed.'"/>
                                                                    <p style="margin: 0; font-weight: 700;">'.$rowUserName.'</p>';
                                                                }
                                                            } else {
                                                                if ($page == 1 && $current_userEmployerID == $user_id) {
                                                                    $selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $current_userID" );
                                                                    if ( mysqli_num_rows($selectUser) > 0 ) {

                                                                        $rowUser = mysqli_fetch_array($selectUser);
                                                                        $rowUserID = $rowUser["ID"];
                                                                        $rowUserName = $rowUser["first_name"] .' '. $rowUser["last_name"];

                                                                        echo '<select class="form-control " name="document_reviewed[]">
                                                                            <option value="0">Select</option>
                                                                            <option value="'.$rowUserID.'">'.$rowUserName.'</option>
                                                                        </select>';
                                                                    }
                                                                } else {
                                                                    echo '<input type="hidden" class="form-control" name="document_reviewed[]" value="0"/>
                                                                    <p style="margin: 0; font-weight: 700;">Not Yet</p>';
                                                                }
                                                            }

                                                        echo '</div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <div class="form-group">
                                                            <label class="control-label">Approved By</label>';

                                                            if ($doc_file_approved  > 0) {
                                                                $selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $doc_file_approved" );
                                                                if ( mysqli_num_rows($selectUser) > 0 ) {
                                                                    $rowUser = mysqli_fetch_array($selectUser);
                                                                    $rowUserName = $rowUser["first_name"] .' '. $rowUser["last_name"];

                                                                    echo '<input type="hidden" class="form-control" name="document_approved[]" value="'.$doc_file_approved.'"/>
                                                                    <p style="margin: 0; font-weight: 700;">'.$rowUserName.'</p>';
                                                                }
                                                            } else {
                                                                if ($page == 1 && $current_userEmployerID == $user_id) {
                                                                    $selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $current_userID" );
                                                                    if ( mysqli_num_rows($selectUser) > 0 ) {

                                                                        $rowUser = mysqli_fetch_array($selectUser);
                                                                        $rowUserID = $rowUser["ID"];
                                                                        $rowUserName = $rowUser["first_name"] .' '. $rowUser["last_name"];

                                                                        echo '<select class="form-control " name="document_approved[]">
                                                                            <option value="0">Select</option>
                                                                            <option value="'.$rowUserID.'">'.$rowUserName.'</option>
                                                                        </select>';
                                                                    }
                                                                } else {
                                                                    echo '<input type="hidden" class="form-control" name="document_approved[]" value="0"/>
                                                                    <p style="margin: 0; font-weight: 700;">Not Yet</p>';
                                                                }
                                                            }

                                                        echo '</div>
                                                    </div>
                                                </div>';
                                            }
                                        } else if ($page == 2) {
                                            echo '<div class="row margin-top-10 '; echo $current_userEmployerID == 34 OR $current_userEmployerID == 27 OR $current_userEmployerID == 464 OR $current_userEmployerID == 1106 ? '':'hide'; echo '">
                                                <div class="col-md-6">
                                                    <div class="form-group">
                                                        <label class="control-label">Reviewed By</label>';

                                                        if ($doc_file_reviewed  > 0) {
                                                            $selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $doc_file_reviewed" );
                                                            if ( mysqli_num_rows($selectUser) > 0 ) {
                                                                $rowUser = mysqli_fetch_array($selectUser);
                                                                $rowUserName = $rowUser["first_name"] .' '. $rowUser["last_name"];

                                                                echo '<input type="hidden" class="form-control" name="document_reviewed[]" value="'.$doc_file_reviewed.'"/>
                                                                <p style="margin: 0; font-weight: 700;">'.$rowUserName.'</p>';
                                                            }
                                                        } else {
                                                            $selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $current_userID" );
                                                            if ( mysqli_num_rows($selectUser) > 0 ) {

                                                                $rowUser = mysqli_fetch_array($selectUser);
                                                                $rowUserID = $rowUser["ID"];
                                                                $rowUserName = $rowUser["first_name"] .' '. $rowUser["last_name"];

                                                                echo '<select class="form-control " name="document_reviewed[]">
                                                                    <option value="0">Select</option>
                                                                    <option value="'.$rowUserID.'">'.$rowUserName.'</option>
                                                                </select>';
                                                            }
                                                        }

                                                    echo '</div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="form-group">
                                                        <label class="control-label">Approved By</label>';

                                                        if ($doc_file_approved  > 0) {
                                                            $selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $doc_file_approved" );
                                                            if ( mysqli_num_rows($selectUser) > 0 ) {
                                                                $rowUser = mysqli_fetch_array($selectUser);
                                                                $rowUserName = $rowUser["first_name"] .' '. $rowUser["last_name"];

                                                                echo '<input type="hidden" class="form-control" name="document_approved[]" value="'.$doc_file_approved.'"/>
                                                                <p style="margin: 0; font-weight: 700;">'.$rowUserName.'</p>';
                                                            }
                                                        } else {
                                                            $selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $current_userID" );
                                                            if ( mysqli_num_rows($selectUser) > 0 ) {

                                                                $rowUser = mysqli_fetch_array($selectUser);
                                                                $rowUserID = $rowUser["ID"];
                                                                $rowUserName = $rowUser["first_name"] .' '. $rowUser["last_name"];

                                                                echo '<select class="form-control " name="document_approved[]">
                                                                    <option value="0">Select</option>
                                                                    <option value="'.$rowUserID.'">'.$rowUserName.'</option>
                                                                </select>';
                                                            }
                                                        }

                                                    echo '</div>
                                                </div>
                                            </div>';
                                        }

                                    echo '</td>
                                </tr>';
                            }
                        }
                    }
                }
            }
        }

        if ($requirements == 0) {
    		$selectRequirement = mysqli_query( $conn,"SELECT * FROM tbl_supplier_requirement WHERE ID = $id" );
            if ( mysqli_num_rows($selectRequirement) > 0 ) {
                while($row = mysqli_fetch_array($selectRequirement)) {
                	$data_ID = $row["ID"];
                	$data_name = $row["name"];
                	
                	echo '<tr class="tr_'.$data_ID.'">
                        <td rowspan="2">
                            <input type="hidden" class="form-control" name="document_name[]" value="'.$data_ID.'" required /><b>'.$data_name.'</b>
                        </td>
                        <td class="text-center">
                            <select class="form-control hide" name="document_filetype[]" onchange="changeType(this)" required>
                                <option value="0">Select option</option>
                                <option value="1">Manual Upload</option>
                                <option value="2">Youtube URL</option>
                                <option value="3">Google Drive URL</option>
                            </select>
                            <input class="form-control margin-top-15 fileUpload" type="file" name="document_file[]" onchange="changeFile(this, this.value)" style="display: none;" />
                            <input class="form-control margin-top-15 fileURL" type="url" name="document_fileurl[]" style="display: none;" placeholder="https://" />
                            <p style="margin: 0;"><button type="button" class="btn btn-sm red-haze uploadNew" onclick="uploadNew(this)">Upload</button></p>
                        </td>
                        <td><input type="text" class="form-control document_filename" name="document_filename[]" placeholder="Document Name" /></td>
                        <td class="text-center">
                            <div class="input-group">
                                <input type="text" class="form-control daterange" name="document_daterange[]" value="" />
                                <span class="input-group-btn">
                                    <button class="btn default date-range-toggle" type="button" onclick="widget_date_clears(this)">
                                        <i class="fa fa-close"></i>
                                    </button>
                                </span>
                            </div>
                            <input type="date" class="form-control hide" name="document_date[]" />
                            <input type="date" class="form-control hide" name="document_due[]" />
                        </td>
                        <td rowspan="2" class="text-center">
                            <input type="file" class="form-control hide" name="document_template[]" />';

                            $selectTemplate = mysqli_query( $conn,"SELECT * FROM tbl_supplier_template WHERE user_id = $user_id AND requirement_id = $data_ID" );
                            if ( mysqli_num_rows($selectTemplate) > 0 ) {
                                $rowTemplate = mysqli_fetch_array($selectTemplate);
                                $temp_ID = $rowTemplate["ID"];
                                $temp_file = $rowTemplate["file"];

                                $type = 'iframe';
                                $filetype = $rowTemplate["filetype"];
                                if ($filetype == 1) {
                                    $fileExtension = fileExtension($temp_file);
                                    $src = $fileExtension['src'];
                                    $embed = $fileExtension['embed'];
                                    $type = $fileExtension['type'];
                                    $file_extension = $fileExtension['file_extension'];
                                    $url = $base_url.'uploads/supplier/';

                                    $temp_file = $src.$url.rawurlencode($temp_file).$embed;
                                } else if ($filetype == 3) {
                                    $temp_file = preg_replace('#[^/]*$#', '', $temp_file).'preview';
                                }

                                echo '<p style="margin: 0;">
                                    <a href="'.$temp_file.'" data-src="'.$temp_file.'" data-fancybox data-type="'.$type.'" class="btn btn-sm btn-info">View</a> |
                                    <a href="#modalTemplate2" class="btn btn-sm red-haze" data-toggle="modal" onclick="btnTemplate2('.$data_ID.', '.$temp_ID.', '.$modal.')">Upload</a>
                                </p>';
                            } else {
                                echo '<a href="#modalTemplate2" class="btn btn-sm red-haze" data-toggle="modal" onclick="btnTemplate2('.$data_ID.', 0, '.$modal.')">Upload</a>';
                            }

                        echo '</td>
                        <td rowspan="2" class="text-center">0%</td>
                    </tr>
                    <tr class="tr_'.$data_ID.'">
                    	<td colspan="3">
                        	<input type="text" class="form-control" name="document_comment[]" placeholder="Comment" />';
                        	if ($user_id == 3444) {
    					    	echo '<div class="row margin-top-10">
    					            <div class="col-md-6">
    					                <div class="form-group">
    					                    <label class="control-label">Reviewed By</label>
    					                    <input type="hidden" class="form-control" name="document_reviewed[]" value="0"/>
    					                    <p style="margin: 0; font-weight: 700;">Not Yet</p>
    					                </div>
    					            </div>
    					            <div class="col-md-6">
    					                <div class="form-group">
    					                    <label class="control-label">Approved By</label>
    					                    <input type="hidden" class="form-control" name="document_approved[]" value="0"/>
    					                    <p style="margin: 0; font-weight: 700;">Not Yet</p>
    					                </div>
    					            </div>
    					        </div>';
    					    }
                    	echo '</td>
                    </tr>';
                }
            }
        }
	}
	if( isset($_GET['modalView_Customer_Employee']) ) {
		$modal = $_GET['modalView_Customer_Employee'];
		$user_id = $_COOKIE['ID'];
        $current_userEmployerID = employerID($user_id);
		$department_id = $_POST['department_id'];

		if (!empty($department_id)) {
			$department_id = implode(", ", $_POST['department_id']);
			$department_id_arr = explode(", ", $department_id);
	        foreach ($department_id_arr as $value) {
	            $selectEmployee = mysqli_query( $conn,"SELECT * FROM tbl_hr_employee WHERE suspended = 0 AND status = 1 AND department_id = $value AND user_id = $current_userEmployerID ORDER BY first_name" );
	            if ( mysqli_num_rows($selectEmployee) > 0 ) {
	            	while($rowEmployee = mysqli_fetch_array($selectEmployee)) {
		                $emp_ID = $rowEmployee["ID"];
		                $emp_name = $rowEmployee["first_name"] .' '. $rowEmployee["last_name"];
                        $emp_email = $rowEmployee["email"];

                        $selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE is_verified = 1 AND is_active = 1 AND email = '".$emp_email."' ORDER BY first_name");
                        if ( mysqli_num_rows($selectUser) > 0 ) {
                            echo '<option value="'.$emp_ID.'">'.$emp_name.'</option>';
                        }
	            	}
	            }
	        }
		} else {
			$selectEmployee = mysqli_query( $conn,"SELECT * FROM tbl_hr_employee WHERE suspended = 0 AND status = 1 AND user_id = $current_userEmployerID ORDER BY first_name" );
            if ( mysqli_num_rows($selectEmployee) > 0 ) {
            	while($rowEmployee = mysqli_fetch_array($selectEmployee)) {
	                $emp_ID = $rowEmployee["ID"];
	                $emp_name = $rowEmployee["first_name"] .' '. $rowEmployee["last_name"];
                    $emp_email = $rowEmployee["email"];

                    $selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE is_verified = 1 AND is_active = 1 AND email = '".$emp_email."' ORDER BY first_name");
                    if ( mysqli_num_rows($selectUser) > 0 ) {
                        echo '<option value="'.$emp_ID.'">'.$emp_name.'</option>';
                    }
            	}
            }
		}
	}
    if( isset($_GET['modalSend_Customer']) ) {
        $id = $_GET['modalSend_Customer'];

        $selectData = mysqli_query( $conn,"SELECT
            s.user_id AS s_user_id,
            s.notification AS s_notification,
            s.name AS s_name,
            s.email AS s_email,
            s.document AS s_document,
            s.document_other AS s_document_other,
            s.address AS s_address,
            s.contact AS s_contact,
            u.client AS u_client,
            u.first_name AS u_first_name,
            u.last_name AS u_last_name,
            u.email AS u_email,
            e.businessname AS e_name,
            e.businessemailAddress AS e_email
            FROM tbl_supplier AS s

            LEFT JOIN (
                SELECT
                *
                FROM tbl_user
            ) AS u
            ON s.user_id = u.ID

            LEFT JOIN (
                SELECT
                *
                FROM tblEnterpiseDetails
            ) AS e
            ON s.user_id = e.users_entities

            WHERE s.ID = $id" );
        if ( mysqli_num_rows($selectData) > 0 ) {
            $rowData = mysqli_fetch_array($selectData);
            $s_user_id = $rowData['s_user_id'];
            $s_notification = $rowData['s_notification'];

            $address_country = '';
            if (!empty($rowData['s_address'])) {
                $address_country = explode(', ', $rowData['s_address']);
                $address_country = $address_country[0];
            }

            // Requirement Section
            $s_document = $rowData['s_document'];
            $s_document_other = $rowData['s_document_other'];
            $requirement_email = "";
            $requirement = array();
            $selectRequirement = mysqli_query( $conn,"SELECT 
                r.name AS r_name
                FROM tbl_supplier_requirement AS r

                LEFT JOIN (
                    SELECT
                    *
                    FROM tbl_supplier_document
                    WHERE type = 0
                    AND user_id = $s_user_id
                    AND supplier_id = $id
                ) AS d
                ON r.ID = d.name

                WHERE FIND_IN_SET(r.ID, REPLACE(REPLACE('".$s_document."', ' ', ''), '|',','  )  ) > 0" );
            while($rowRequirement = mysqli_fetch_array($selectRequirement)) {
                array_push($requirement, $rowRequirement["r_name"]);
            }
            if (!empty($s_document_other)) {
                $document_other_arr = explode(" | ", $s_document_other);
                foreach ($document_other_arr as $value) {
                    $selectDocument = mysqli_query( $conn,"SELECT * FROM tbl_supplier_document WHERE type = 1 AND user_id = $s_user_id AND supplier_id = $id AND name = '".$value."'" );
                    if ( mysqli_num_rows($selectDocument) > 0 ) {
                        array_push($requirement, $value);
                    }
                }
            }
            if (!empty($requirement)) { $requirement_email = implode(' | ', $requirement); }


            // Email Compose
            $user = $rowData['s_name'];
            $to = $rowData['s_email'];

            $data_company = $rowData['u_first_name'].' '.$rowData['u_last_name'];
            if (!empty($rowData['e_name'])) { $data_company = $rowData['e_name']; }

            $data_email = $rowData['u_email'];
            if (!empty($rowData['e_email'])) { $data_email = $rowData['e_email']; }

            if ($rowData['u_client'] == 1) {
                $subject = 'Welcome to Cann OS!';
                $body_extra = 'Hi '.$user.',<br><br>';
                $body = 'Your supplier BeGreenLegal, invites you to <a href="'.$base_url.'CannOS-Login" target="_blank">Cann OS</a> to connect and manage your cannabis operation(s).<br><br>

                Should you need assistance, kindly email <a href="mailto:CannOS@begreenlegal.com.">CannOS@begreenlegal.com.</a><br><br>
    
                Cann OS Team<br>
                BeGreenLegal';
            } else {
                $subject = $data_company.' Supplier Invitation via InterlinkIQ.com';
                $body_extra = 'Hi '.$user.',<br><br>';
                $body = 'Your supplier, '.$data_company.', invites you to <a href="'. $base_url .'" target="_blank">InterlinkIQ.com</a> to connect and share documents to comply with Customers\' Supplier Approval Program Requirements.<br><br>
    
                Follow the video link for the instructional video Customer Requirements Management Module - <a href="https://youtu.be/9XklXwGBr7E" target="_blank">https://youtu.be/9XklXwGBr7E</a><br><br>

                Should you need assistance, kindly call 202-982-3002 or email '.$data_email.'<br><br>
    
                InterlinkIQ.com Team<br>
                Consultare Inc.';
            }
            php_mailer_1($to, $user, $subject, $body_extra.$body, $data_email, $data_company);

            if (!empty($requirement_email)) {
                $subject2 = 'Customers Supplier Approval Requirements!';
                $body2_extra = 'Hi '.$user.' Food Safety Team,<br><br>';

                if ($data_user_id == 254) {
                    $data_company = 'Jensen Meat Company (JMC)';
                    $body2 = 'We are working with '.$data_company.' as part of their Supplier Approval Program (SAP). The '.$user.' has been identified as a Supplier/Service Provider of Jensen Meat Company  Plant Based.<br><br>';
                } else {
                    $body2 = 'We are working with '.$data_company.' as part of their Supplier Approval Program (SAP). Your company has been identified as a Supplier/Service Provider of '.$data_company.'.<br><br>';
                }

                $body2 .= 'We are requesting certain documents from your firm to comply with the SAP 21 CFR 117 Subpart G - Supply-Chain Program';

                if ($address_country != 'US') { $body2 .= ' / FSVP 21 CFR Subpart L - Foreign Supplier Verification Programs for Food Importers requirement'; }

                $body2 .= '.<br><ol>';

                $requirement_arr = explode(" | ", $requirement_email);
                foreach ($requirement_arr as $value) {
                    $body2 .= '<li>'.$value.'</li>';
                }

                $body2 .= '</ol>

                Follow the instructions below:<br><br>

                To update Compliance:<br>
                <ol>
                    <li>Go to <a href="'.$base_url.'" target="_blank">https://interlinkiq.com/</a> and click Log in. Enter your Username and Password.</li>
                    <li>Once successfully logged in, click the Enterprise Module.</li>
                    <li>Click Customer Module to view the list of your Customer.</li>
                    <li>Click View and go to Requirements Tab; comply by uploading the documents required in the list.</li>
                </ol>

                Kindly see the link below for our Customer Management Tutorial Video<br><br>

                <table style="width: 100%; border-collapse: collapse;">
                    <tr>
                        <td style="border: 1px solid; padding: 5px; text-align: center;"><b>Tutorial Video</b></td>
                        <td style="border: 1px solid; padding: 5px; text-align: center;"><b>Video Link</b></td>
                    </tr>
                    <tr>
                        <td style="border: 1px solid; padding: 5px;">Free Access - Enterprise Management Module</td>
                        <td style="border: 1px solid; padding: 5px;">https://www.youtube.com/watch?v=pyhPjZKTlaE</td>
                    </tr>
                    <tr>
                        <td style="border: 1px solid; padding: 5px;">Free Access - Supplier Requirements Management Module</td>
                        <td style="border: 1px solid; padding: 5px;">https://youtu.be/nv2oM9hbN-Y</td>
                    </tr>
                </table><br><br>

                Should you need assistance, kindly call 202-982-3002 or email '.$data_email.'<br><br>

                InterlinkIQ.com Team<br><br>
                Consultare Inc.';
    
                php_mailer_2($to, $user, $subject2, $body2_extra.$body2, $data_email, $data_company);
            }

            // Email copy for contact
            if (!empty($rowData['s_contact'])) {
                $data_contact_arr = explode(", ", $rowData['s_contact']);
                foreach ($data_contact_arr as $value) {
                    $selectContact = mysqli_query( $conn,"SELECT * FROM tbl_supplier_contact WHERE ID=$value" );
                    if ( mysqli_num_rows($selectContact) > 0 ) {
                        while($rowContact = mysqli_fetch_array($selectContact)) {
                            $to = $rowContact["email"];
                            $user = $rowContact["name"];

                            $body2_extra = 'Hi '.$user.',<br><br>';
                            if ($rowData['u_client'] == 1) { $body2_extra = ''; }

                            php_mailer_1($to, $user, $subject, $body2_extra.$body, $data_email, $data_company);

                            if (!empty($requirement_email)) {
                                $body2_extra = 'Hi '.$user.' Food Safety Team,<br><br>';

                                php_mailer_2($to, $user, $subject2, $body2_extra.$body2, $data_email, $data_company);
                            }
                        }
                    }
                }
            }
        }
    }
	if( isset($_POST['btnSave_Customer']) ) {
		if (!empty($_COOKIE['switchAccount'])) {
			$portal_user = $_COOKIE['ID'];
			$user_id = $_COOKIE['switchAccount'];
		}
		else {
			$portal_user = $_COOKIE['ID'];
			$user_id = employerID($portal_user);
		}

        $current_dateNow_o = date('Y/m/d');
        $current_dateNow = new DateTime($current_dateNow_o);
        $current_dateNow = $current_dateNow->format('M d, Y');

		$name = addslashes($_POST['name']);
		$category = $_POST['category'];
		$industry = $_POST['industry'];
		$path = 'uploads/supplier/';
		$random = rand(1000,1000000);
        $audit_arr_item = array();
        $audit_filesize = 0;
        $process = true;

		$address = array();
		array_push($address, $_POST['countries']);
		array_push($address, $_POST['address_street']);
		array_push($address, $_POST['address_city']);
		array_push($address, $_POST['address_state']);
		array_push($address, $_POST['address_code']);
		$address = implode(" | ", $address);

		$email = addslashes($_POST['email']);
		$phone = addslashes($_POST['phone']);
		$fax = addslashes($_POST['fax']);
		$website = $_POST['website'];
		$status = $_POST['status'];
		// $notification = $_POST['notification'];
        $nda = $_POST['nda'];
		$notification = 0;
		$date = date('Y-m-d');

		$supplier_frequency = $_POST['supplier_frequency'];
		$supplier_frequency_custom = array();
		array_push($supplier_frequency_custom, $_POST['supplier_frequency_minute']);
		array_push($supplier_frequency_custom, $_POST['supplier_frequency_hour']);
		array_push($supplier_frequency_custom, $_POST['supplier_frequency_day']);
		array_push($supplier_frequency_custom, $_POST['supplier_frequency_month']);
		array_push($supplier_frequency_custom, $_POST['supplier_frequency_weekday']);
		$supplier_frequency_custom = implode(" | ", $supplier_frequency_custom);

		$document = "";
		if (!empty($_POST["document"])) { $document = implode(" | ", $_POST["document"]); }

		$document_other = "";
		if (!empty($_POST["document_other"])) { $document_other = implode(" | ", $_POST["document_other"]); }

		$document_name = "";
		if (!empty($_POST["document_name"])) { $document_name = implode(" | ", $_POST["document_name"]); }

		$document_other_name = "";
		if (!empty($_POST["document_other_name"])) { $document_other_name = implode(" | ", $_POST["document_other_name"]); }

		$contact = "";
		if (!empty($_POST["contact_id"])) { $contact = implode(", ", $_POST["contact_id"]); }

		$material = "";
		if (!empty($_POST["material_id"])) { $material = implode(", ", $_POST["material_id"]); }

		$service = "";
		if (!empty($_POST["service_id"])) { $service = implode(", ", $_POST["service_id"]); }

		$audit_report = array();
        $audit_report_validity = $_POST['audit_report_validity'];
        $audit_report_validity = explode(' - ', $audit_report_validity);
        $audit_report_validity_start = !empty($audit_report_validity[0]) ? $audit_report_validity[0] : '';
        $audit_report_validity_end = !empty($audit_report_validity[1]) ? $audit_report_validity[1] : '';
        $audit_report_file = $_FILES['audit_report_file']['name'];
        if (!empty($audit_report_file)) {
            $audit_filesize = $_FILES['audit_report_file']['size'];
            $audit_report_file_tmp = $_FILES['audit_report_file']['tmp_name'];
            $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
            $ext = strtolower(pathinfo($audit_report_file, PATHINFO_EXTENSION));
            $audit_report_file = $random.' - '.$audit_report_file;
            $audit_report_file_path = $path.$audit_report_file;

            if(!in_array($ext, $invalid_extensions)) {
                move_uploaded_file($audit_report_file_tmp, $audit_report_file_path);
                array_push($audit_report, $audit_report_file);

                $output = array (
                    'type'  =>  1,
                    'name' =>  $audit_report_file,
                    'size' =>  $audit_filesize,
                    'date' =>  $local_date
                );
                array_push($audit_arr_item, $output);
            } else {
                $process = false;
            }
        } else {
            array_push($audit_report, '');
        }
        array_push($audit_report, $audit_report_validity_start);
        array_push($audit_report, $audit_report_validity_end);
        array_push($audit_report, $_POST['audit_report_note']);
        $audit_report = implode(" | ", $audit_report);

        $audit_certificate = array();
        $audit_certificate_validity = $_POST['audit_certificate_validity'];
        $audit_certificate_validity = explode(' - ', $audit_certificate_validity);
        $audit_certificate_validity_start = !empty($audit_certificate_validity[0]) ? $audit_certificate_validity[0] : '';
        $audit_certificate_validity_end = !empty($audit_certificate_validity[1]) ? $audit_certificate_validity[1] : '';
        $audit_certificate_file = $_FILES['audit_certificate_file']['name'];
        if (!empty($audit_certificate_file)) {
            $audit_filesize = $_FILES['audit_certificate_file']['size'];
            $audit_certificate_file_tmp = $_FILES['audit_certificate_file']['tmp_name'];
            $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
            $ext = strtolower(pathinfo($audit_certificate_file, PATHINFO_EXTENSION));
            $audit_certificate_file = $random.' - '.$audit_certificate_file;
            $audit_certificate_file_path = $path.$audit_certificate_file;

            if(!in_array($ext, $invalid_extensions)) {
                move_uploaded_file($audit_certificate_file_tmp, $audit_certificate_file_path);
                array_push($audit_certificate, $audit_certificate_file);

                $output = array (
                    'type'  =>  2,
                    'name' =>  $audit_certificate_file,
                    'size' =>  $audit_filesize,
                    'date' =>  $local_date
                );
                array_push($audit_arr_item, $output);
            } else {
                $process = false;
            }
        } else {
            array_push($audit_certificate, '');
        }
        array_push($audit_certificate, $audit_certificate_validity_start);
        array_push($audit_certificate, $audit_certificate_validity_end);
        array_push($audit_certificate, $_POST['audit_certificate_note']);
        $audit_certificate = implode(" | ", $audit_certificate);

        $audit_action = array();
        $audit_action_validity = $_POST['audit_action_validity'];
        $audit_action_validity = explode(' - ', $audit_action_validity);
        $audit_action_validity_start = !empty($audit_action_validity[0]) ? $audit_action_validity[0] : '';
        $audit_action_validity_end = !empty($audit_action_validity[1]) ? $audit_action_validity[1] : '';
        $audit_action_file = $_FILES['audit_action_file']['name'];
        if (!empty($audit_action_file)) {
            $audit_filesize = $_FILES['audit_action_file']['size'];
            $audit_action_file_tmp = $_FILES['audit_action_file']['tmp_name'];
            $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
            $ext = strtolower(pathinfo($audit_action_file, PATHINFO_EXTENSION));
            $audit_action_file = $random.' - '.$audit_action_file;
            $audit_action_file_path = $path.$audit_action_file;

            if(!in_array($ext, $invalid_extensions)) {
                move_uploaded_file($audit_action_file_tmp, $audit_action_file_path);
                array_push($audit_action, $audit_action_file);

                $output = array (
                    'type'  =>  3,
                    'name' =>  $audit_action_file,
                    'size' =>  $audit_filesize,
                    'date' =>  $local_date
                );
                array_push($audit_arr_item, $output);
            } else {
                $process = false;
            }
        } else {
            array_push($audit_action, '');
        }
        array_push($audit_action, $audit_action_validity_start);
        array_push($audit_action, $audit_action_validity_end);
        array_push($audit_action, $_POST['audit_action_note']);
        $audit_action = implode(" | ", $audit_action);

        $audit = $_POST['audit'];
        $reviewed_by = $_POST['reviewed_by'];
        $reviewed_validity = $_POST['reviewed_validity'];
        $reviewed_validity = explode(' - ', $reviewed_validity);
        $reviewed_date = !empty($reviewed_validity[0]) ? $reviewed_validity[0] : '';
        $reviewed_due = !empty($reviewed_validity[1]) ? $reviewed_validity[1] : '';

		$department_id = '';
		if (!empty($_POST['department_id'])) { $department_id = implode(", ",$_POST['department_id']); }

		$employee_id = '';
		if (!empty($_POST['employee_id'])) { $employee_id = implode(", ",$_POST['employee_id']); }

        if ($process == true) {
    		$sql = "INSERT INTO tbl_supplier (user_id, portal_user, page, name, address, phone, fax, email, website, category, industry, contact, document, document_other, material, service, audit, audit_report, audit_certificate, audit_action, reviewed_by, reviewed_date, reviewed_due, department_id, employee_id, status, notification, nda, frequency, frequency_custom, last_modified)
    		VALUES ('$user_id', '$portal_user', '2', '$name', '$address', '$phone', '$fax', '$email', '$website', '$category', '$industry', '$contact', '$document_name', '$document_other_name', '$material', '$service', '$audit', '$audit_report', '$audit_certificate', '$audit_action', '$reviewed_by', '$reviewed_date', '$reviewed_due', '$department_id', '$employee_id', '$status', '$notification', '$nda', '$supplier_frequency', '$supplier_frequency_custom', '$date')";
    		if (mysqli_query($conn, $sql)) {
    			$last_id = mysqli_insert_id($conn);

    			$selectData = mysqli_query( $conn,'SELECT * FROM tbl_supplier WHERE user_id="'. $user_id .'" AND ID="'. $last_id .'" ORDER BY ID LIMIT 1' );
    			if ( mysqli_num_rows($selectData) > 0 ) {
    				$rowData = mysqli_fetch_array($selectData);
    				$data_ID = $rowData['ID'];
    				$data_page = $rowData['page'];
    				$data_user_id = $rowData["user_id"];
    				$data_name = $rowData['name'];
    				$data_document_other = $rowData['document_other'];
    				$data_reviewed_due = $rowData['reviewed_due'];
                    $data_status = $rowData["status"];
                    $data_notification = $rowData["notification"];
                    $data_status_type = array(
                        0 => 'Pending',
    	                1 => 'Active',
    	                2 => 'Inactive'
                    );

                    $contact_name = '';
                    $contact_address = '';
                    $contact_info = '';
                    $data_contact = $rowData["contact"];
                    if (!empty($data_contact)) {
                        $contact_arr = explode(", ", $data_contact);
                        foreach ($contact_arr as $value) {
                            $selectContact = mysqli_query( $conn,"SELECT * FROM tbl_supplier_contact WHERE ID=$value" );
                            if ( mysqli_num_rows($selectContact) > 0 ) {
                                $rowContact = mysqli_fetch_array($selectContact);
                                $contact_name = $rowContact["name"];
                                $contact_address = $rowContact["address"];
                                $contact_email = $rowContact["email"];
                                $contact_phone = $rowContact["phone"];
                                $contact_cell = $rowContact["cell"];
                                $contact_fax = $rowContact["fax"];

                                $contact_info = '<ul class="list-inline">';
    	                            if ($contact_email != "") { $contact_info .= '<li><a href="mailto:'.$contact_email.'" target="_blank" title="Email"><i class="fa fa-envelope"></i></a></li>'; }
    	                            if ($contact_phone != "") { $contact_info .= '<li><a href="tel:'.$contact_phone.'" target="_blank" title="Phone"><i class="fa fa-phone-square"></i></a></li>'; }
    	                            if ($contact_cell != "") { $contact_info .= '<li><a href="tel:'.$contact_cell.'" target="_blank" title="Cell Number"><i class="fa fa-phone"></i></a></li>'; }
    	                            if ($contact_fax != "") { $contact_info .= '<li><a href="tel:'.$contact_fax.'" target="_blank" title="Fax"><i class="fa fa-print"></i></a></li>'; }
                                $contact_info .= '</ul>';

                                break;
                            }
                        }
                    }

    	            // Document Section
    				$path = 'uploads/supplier/';
    				$random = rand(1000,1000000);
    				if (!empty($_POST["document_name"])) {
    					for ($i=0; $i < count($_POST["document_name"]); $i++) {
    						$document_names = addslashes($_POST["document_name"][$i]);
    						$document_filename = addslashes($_POST["document_filename"][$i]);
    						// $document_date = $_POST["document_date"][$i];
    						// $document_due = $_POST["document_due"][$i];
    						$document_comment = $_POST["document_comment"][$i];
                            $arr_item = array();
                            $filesize = 0;

    						$document_date = '';
    						$document_due = '';
    						$document_daterange = $_POST["document_daterange"][$i];
    						if (!empty($document_daterange)) {
    							$document_daterange = explode(' - ', $document_daterange);
    							$document_date = $document_daterange[0];
    							$document_due = $document_daterange[1];
    						}

    						$document_filetype = $_POST["document_filetype"][$i];
    						if ($document_filetype == 1) {
    							$files = $_FILES['document_file']['name'][$i];
    							$file_docs = "";
    							if (!empty($files)) {
                                    $filesize = $_FILES['document_file']['size'][$i];
    								$tmp_docs = $_FILES['document_file']['tmp_name'][$i];
                                    $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                                    $ext = strtolower(pathinfo($files, PATHINFO_EXTENSION));
    								$file_docs = $random.' - '.$files;
    								$path_docs = $path.$file_docs;

                                    if(!in_array($ext, $invalid_extensions)) {
                                        move_uploaded_file($tmp_docs,$path_docs);
                                    } else {
                                        $process = false;
                                    }
    							}
    						} else {
    							$file_docs = $_POST["document_fileurl"][$i];
    						}

                            $output = array (
                                'type' =>  $document_filetype,
                                'name' =>  $file_docs,
                                'size' =>  $filesize,
                                'date' =>  $local_date
                            );
                            array_push($arr_item, $output);
    						
    						$files_template = $_FILES['document_template']['name'][$i];
    						$file_docs_template = "";
    						if (!empty($files_template)) {
                                $filesize = $_FILES['document_template']['size'][$i];
    							$tmp_docs = $_FILES['document_template']['tmp_name'][$i];
                                $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                                $ext = strtolower(pathinfo($files_template, PATHINFO_EXTENSION));
    							$file_docs_template = $random.' - '.$files_template;
    							$path_docs = $path.$file_docs;

                                if(!in_array($ext, $invalid_extensions)) {
                                    move_uploaded_file($tmp_docs,$path_docs);

                                    $output = array (
                                        'type'  =>  0,
                                        'name' =>  $file_docs_template,
                                        'size' =>  $filesize,
                                        'date' =>  $local_date
                                    );
                                    array_push($arr_item, $output);
                                } else {
                                    $process = false;
                                }
    						}
                            $file_history = json_encode($arr_item, JSON_HEX_APOS | JSON_UNESCAPED_UNICODE);

                            if ($process == true) {
        						$sql = "INSERT INTO tbl_supplier_document (user_id, portal_user, supplier_id, name, file, filetype, filesize, file_history, filename, file_date, file_due, template)
                                VALUES ('$user_id', '$portal_user', '$data_ID', '$document_names', '$file_docs', '$document_filetype', '$filesize', '$file_history', '$document_filename', '$document_date', '$document_due', '$file_docs_template')";
                                if (mysqli_query($conn, $sql)) {
        							$supplier_document_last_id = mysqli_insert_id($conn);

        							if (!empty($document_comment)) {
        								$sql = "INSERT INTO tbl_supplier_comment (user_id, portal_user, supplier_document_id, comment, last_modified)
        								VALUES ('$user_id', '$portal_user', '$supplier_document_last_id', '$document_comment', '$date')";
        								mysqli_query($conn, $sql);
        							}
        						}
                            }
    					}
    				}
    				if (!empty($_POST["document_other_name"])) {
    					for ($i=0; $i < count($_POST["document_other_name"]); $i++) {
    						$document_names = addslashes($_POST["document_other_name"][$i]);
    						$document_filename = addslashes($_POST["document_other_filename"][$i]);
    						// $document_date = $_POST["document_other_date"][$i];
    						// $document_due = $_POST["document_other_due"][$i];
    						$document_comment = $_POST["document_other_comment"][$i];
                            $arr_item = array();
                            $filesize = 0;

    						$document_date = '';
    						$document_due = '';
    						$document_other_daterange = $_POST["document_other_daterange"][$i];
    						if (!empty($document_other_daterange)) {
    							$document_other_daterange = explode(' - ', $document_other_daterange);
    							$document_date = $document_other_daterange[0];
    							$document_due = $document_other_daterange[1];
    						}

    						$document_filetype = $_POST["document_other_filetype"][$i];
                            if ($document_filetype == 1) {
                                $files = $_FILES['document_other_file']['name'][$i];
                                $file_docs = "";
                                if (!empty($files)) {
                                    $filesize = $_FILES['document_other_file']['size'][$i];
                                    $tmp_docs = $_FILES['document_other_file']['tmp_name'][$i];
                                    $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                                    $ext = strtolower(pathinfo($files, PATHINFO_EXTENSION));
                                    $file_docs = $random.' - '.$files;
                                    $path_docs = $path.$file_docs;

                                    if(!in_array($ext, $invalid_extensions)) {
                                        move_uploaded_file($tmp_docs,$path_docs);
                                    } else {
                                        $process = false;
                                    }
                                }
                            } else {
                                $file_docs = $_POST["document_other_fileurl"][$i];
                            }

                            $output = array (
                                'type' =>  $document_filetype,
                                'name' =>  $file_docs,
                                'size' =>  $filesize,
                                'date' =>  $local_date
                            );
                            array_push($arr_item, $output);
    						
    						$files_template = $_FILES['document_other_template']['name'][$i];
    						$file_docs_template = "";
    						if (!empty($files_template)) {
                                $filesize = $_FILES['document_other_template']['size'][$i];
                                $tmp_docs = $_FILES['document_other_template']['tmp_name'][$i];
                                $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                                $ext = strtolower(pathinfo($files_template, PATHINFO_EXTENSION));
                                $file_docs_template = $random.' - '.$files_template;
                                $path_docs = $path.$file_docs_template;

                                if(!in_array($ext, $invalid_extensions)) {
                                    move_uploaded_file($tmp_docs,$path_docs);

                                    $output = array (
                                        'type' =>  0,
                                        'name' =>  $file_docs_template,
                                        'size' =>  $filesize,
                                        'date' =>  $local_date
                                    );
                                    array_push($arr_item, $output);
                                } else {
                                    $process = false;
                                }
                            }
                            $file_history = json_encode($arr_item, JSON_HEX_APOS | JSON_UNESCAPED_UNICODE);

                            if ($process == true) {
        						$sql = "INSERT INTO tbl_supplier_document (user_id, portal_user, supplier_id, type, name, file, filetype, filesize, file_history, filename, file_date, file_due, template)
                                VALUES ('$user_id', '$portal_user', '$data_ID', '1', '$document_names', '$file_docs', '$document_filetype', '$filesize', '$file_history', '$document_filename', '$document_date', '$document_due', '$file_docs_template')";
                                if (mysqli_query($conn, $sql)) {
        							$supplier_document_last_id = mysqli_insert_id($conn);

        							if (!empty($document_comment)) {
        								$sql = "INSERT INTO tbl_supplier_comment (user_id, portal_user, supplier_document_id, comment, last_modified)
        								VALUES ('$user_id', '$portal_user', '$supplier_document_last_id', '$document_comment', '$date')";
        								mysqli_query($conn, $sql);
        							}
        						}
                            }
    					}
    				}

    	            // Requirement Section
    				$requirement = array();
    				$requirement_email = "";
    				// $selectRequirement = mysqli_query( $conn,"SELECT * FROM tbl_supplier_requirement" );
                    $selectRequirement = mysqli_query( $conn,"SELECT
                        d_ID,
                        d_name,
                        d_file,
                        r_ID,
                        r_name,
                        s.ID AS s_ID,
                        s.name AS s_name
                        FROM (
                            SELECT
                            d.ID AS d_ID,
                            d.name AS d_name,
                            d.file AS d_file,
                            r.ID AS r_ID,
                            r.name AS r_name
                            FROM tbl_supplier_document AS d

                            INNER JOIN (
                                SELECT
                                *
                                FROM tbl_supplier_requirement
                            ) AS r
                            ON d.name = r.ID

                            WHERE d.type = 0
                            AND LENGTH(d.file) = 0
                            AND d.user_id = $data_user_id
                            AND d.supplier_id = $data_ID
                        ) AS o

                        LEFT JOIN (
                            SELECT
                            *
                            FROM tbl_supplier
                        ) AS s
                        ON FIND_IN_SET(o.r_ID, REPLACE(REPLACE(s.document, ' ', ''), '|',','  )  ) > 0

                        WHERE s.ID = $data_ID" );
    	            while($rowRequirement = mysqli_fetch_array($selectRequirement)) {
                        array_push($requirement, $rowRequirement["r_name"]);

    	                // $data_document_arr = explode(" | ", $rowData["document"]);
    	                // foreach ($data_document_arr as $value) {
    	                //     if ( $value == $rowRequirement["ID"] ) {
    	                //         array_push($requirement, $rowRequirement["name"]);
    	                //     }
    	                // }
    	            }
    	            // if (!empty($requirement)) { $requirement_email = implode(' | ', $requirement); }

    		        $compliance = 0;
    		        $compliance_counter = 0;
    		        $compliance_approved = 0;
                    if (!empty($_POST["document"])) {
                        $selectRequirement = mysqli_query( $conn,"SELECT * FROM tbl_supplier_requirement ORDER BY name" );
                        while($rowRequirement = mysqli_fetch_array($selectRequirement)) {
                            $req_id = $rowRequirement["ID"];
                            $req_name = $rowRequirement["name"];

                            $document_arr = implode(" | ", $_POST["document"]);
                            $document_arr = explode(" | ", $document_arr);
                            foreach ($document_arr as $value) {
                                if ( $value == $req_id ) {
                                    $selectDocument = mysqli_query( $conn,"SELECT * FROM tbl_supplier_document WHERE user_id='".$data_user_id."' AND supplier_id='".$data_ID."' AND name='".$req_id."'" );
                                    if ( mysqli_num_rows($selectDocument) > 0 ) {
                                        $rowDocument = mysqli_fetch_array($selectDocument);
                                        $doc_file_approved = $rowDocument["approved_by"];

                                        $compliance_counter++;
                                        // if ($doc_file_approved > 0) { $compliance_approved++; }

                                        $doc_file_due = $rowDocument["file_due"];
                                        if (!empty($doc_file_due)) {
                                            $doc_file_due = new DateTime($doc_file_due);
                                            $doc_file_due_o = $doc_file_due->format('Y/m/d');
                                            $doc_file_due_o_nearly = date('Y/m/d', strtotime($doc_file_due_o. ' - 30 days'));
                                            $doc_file_due = $doc_file_due->format('m/d/Y');

                                            if ($doc_file_due_o >= $current_dateNow_o && $doc_file_approved > 0) { $compliance_approved++; }
                                        };
                                    }
                                }
                            }
                        }
                    }

    	            // $requirement = implode(' | ', $requirement);
    	            if (!empty($data_document_other)) {
    	            	$requirement .= " | ". $data_document_other;

    	            	// $data_document_other_arr = array();
    	            	// $data_document_other_arr = explode(' | ', $data_document_other);
    	            	// $data_document_other_arr = implode(' | ', $data_document_other_arr);
    	            	// $requirement_email .= " | ". $data_document_other_arr;

    	                $document_other_arr = implode(" | ", $_POST["document_other"]);
    	                $document_other_arr = explode(" | ", $document_other_arr);
    	                foreach ($document_other_arr as $value) {
    	                    $selectDocument = mysqli_query( $conn,"SELECT * FROM tbl_supplier_document WHERE user_id='".$data_user_id."' AND supplier_id='".$data_ID."' AND name='".$value."'" );
    	                    if ( mysqli_num_rows($selectDocument) > 0 ) {
    	                        $rowDocument = mysqli_fetch_array($selectDocument);
    	                        $doc_file_approved = $rowDocument["approved_by"];

                                if (empty($rowDocument["file"])) {
                                    array_push($requirement, $value);
                                }

    	                        $compliance_counter++;
    	                        // if ($doc_file_approved > 0) { $compliance_approved++; }

                                $doc_file_due = $rowDocument["file_due"];
                                if (!empty($doc_file_due)) {
                                    $doc_file_due = new DateTime($doc_file_due);
                                    $doc_file_due_o = $doc_file_due->format('Y/m/d');
                                    $doc_file_due_o_nearly = date('Y/m/d', strtotime($doc_file_due_o. ' - 30 days'));
                                    $doc_file_due = $doc_file_due->format('m/d/Y');

                                    if ($doc_file_due_o >= $current_dateNow_o && $doc_file_approved > 0) { $compliance_approved++; }
                                };
    	                    }
    	                }
    	            }
                    if (!empty($requirement)) { $requirement_email = implode(' | ', $requirement); }

                    if ($compliance_counter > 0) { $compliance = intval(($compliance_approved / $compliance_counter) * 100); }
                    else { $compliance = 0; }
                    mysqli_query( $conn,"UPDATE tbl_supplier set compliance = $compliance WHERE ID = $data_ID" );

    				// Category Section
    				$data_category_id = $rowData['category'];
    				$selectCategory = mysqli_query( $conn,'SELECT * FROM tbl_supplier_category WHERE ID="'. $data_category_id .'" ORDER BY ID LIMIT 1' );
    				$rowCategory = mysqli_fetch_array($selectCategory);
    				$data_category = $rowCategory['name'];

    				if ($data_category_id == "3") {
    					
    					// Service Section
    					$data_material = $rowData['service'];
    					$material_arr = array();
    					if (!empty($data_material)) {
    		                $data_material_arr = explode(", ", $data_material);
    		                foreach ($data_material_arr as $value) {
    		                    $selectMaterial = mysqli_query( $conn,"SELECT * FROM tbl_supplier_service WHERE ID=$value" );
    		                    if ( mysqli_num_rows($selectMaterial) > 0 ) {
    		                    	while($rowMaterial = mysqli_fetch_array($selectMaterial)) {
    		                            $material_ID = $rowMaterial['service_name'];

    	                                $selectDataCategory = mysqli_query( $conn,"SELECT * FROM tbl_service_category WHERE id=$material_ID" );
    	                                $rowDataCategory = mysqli_fetch_array($selectDataCategory);
    	                                array_push($material_arr, $rowDataCategory['service_category']);
    		                    	}
    		                    }
    		                }
    		                $data_material = implode(', ', $material_arr);
    		            }
    				} else {

    					// Material Section
    					$data_material = $rowData['material'];
    					$material_arr = array();
    					if (!empty($data_material)) {
    		                $data_material_arr = explode(", ", $data_material);
    		                foreach ($data_material_arr as $value) {
    		                    $selectMaterial = mysqli_query( $conn,"SELECT * FROM tbl_supplier_material WHERE ID=$value" );
    		                    if ( mysqli_num_rows($selectMaterial) > 0 ) {
    		                    	while($rowMaterial = mysqli_fetch_array($selectMaterial)) {
    		                            $material_ID = $rowMaterial['material_name'];

    		                            $selectProduct = mysqli_query( $conn,"SELECT * FROM tbl_products WHERE ID=$material_ID" );
    		                            $rowProduct = mysqli_fetch_array($selectProduct);
    		                            array_push($material_arr, $rowProduct['name']);
    		                    	}
    		                    }
    		                }
    		                $data_material = implode(', ', $material_arr);
    		            }
    	            }
                    
                    $address_array = array();
                    $address = $rowData["address"];
                    $address_arr = explode(" | ", $address);
                    if (COUNT($address_arr) < 5) {
                        $address_arr = explode(", ", $address);
                    }
                    array_push($address_array, htmlentities($address_arr[1]));
                    array_push($address_array, htmlentities($address_arr[2]));
                    array_push($address_array, htmlentities($address_arr[3]));
                    array_push($address_array, $address_arr[0]);
                    array_push($address_array, $address_arr[4]);
                    $address_arr = implode(", ", $address_array);

    	        	$counterup_tbl = counterup_tbl('customer');
    				$output = array(
    					"ID" => $data_ID,
    					"page" => $data_page,
    					"name" => htmlentities($data_name ?? ''),
    					"category" =>htmlentities( $data_category ?? ''),
    					"material" => htmlentities($data_material ?? ''),
                        "address" => $address_arr,
    					"contact_name" => htmlentities($contact_name ?? ''),
    					"contact_address" => htmlentities($contact_address ?? ''),
    					"contact_info" => $contact_info,
    					"reviewed_due" => $data_reviewed_due,
    					"compliance" => $compliance,
    					"status" => $data_status_type[$data_status]
    				);
    				$result = array_merge($counterup_tbl, $output);
        
        			if ($data_notification == 1) {
    	    			$data_company = "";
    					$data_email = "";
    	    			$selectEnterprise = mysqli_query( $conn,"SELECT * FROM tblEnterpiseDetails WHERE users_entities = $user_id" );
    	    			if ( mysqli_num_rows($selectEnterprise) > 0 ) {
    	    			    $rowEnterprise = mysqli_fetch_array($selectEnterprise);
    	    			    $data_company = $rowEnterprise["businessname"];
    					    $data_email = $rowEnterprise["businessemailAddress"];
    	    			}

    	    			$to = $email;
    	    			$user = $name;

    	    			if ($_COOKIE['client'] == 1) {
    						$subject = 'Welcome to Cann OS!';
    						$body = 'Be Green Legal, invites you to join <a href="'.$base_url.'CannOS-Login" target="_blank">Cann OS</a> to connect and share documents. If you experience difficulties opening the website, kindly use this link instead <a href="'.$base_url.'CannOS-Login" target="_blank">https://interlinkiq.com/CannOS-Login</a>.<br><br>

    						Should you need assistance, kindly email <a href="mailto:nnelson@begreenlegal.com" target="_blank">nnelson@begreenlegal.com</a>.<br><br>

    						Cann OS Team<br>
    						BeGreen Legal';
    					} else if ($_COOKIE['client'] == 2) {
                            $subject = 'Welcome to Food Safety 360!';
                            $body = 'Food Safety 360, invites you to join <a href="'.$base_url.'CannOS-Login" target="_blank">FoodSafety360</a> to connect and share documents. If you experience difficulties opening the website, kindly use this link instead <a href="'.$base_url.'CannOS-Login" target="_blank">https://interlinkiq.com/FoodSafety360</a>.<br><br>

                            Should you need assistance, kindly email <a href="mailto:foodsafety360r@gmail.com" target="_blank">foodsafety360r@gmail.com.<br><br>

                            Food Safety 360<br>
                            BeGreen Legal';
                        } else if ($_COOKIE['client'] == 3) {
                            $subject = 'Welcome to Food Safety 360!';
                            $body = 'Food Safety 360, invites you to join <a href="'.$base_url.'CannOS-Login" target="_blank">SafeCannabis360</a> to connect and share documents. If you experience difficulties opening the website, kindly use this link instead <a href="'.$base_url.'CannOS-Login" target="_blank">https://interlinkiq.com/SafeCannabis360</a>.<br><br>

                            Should you need assistance, kindly email <a href="mailto:cannabis360r@gmail.com" target="_blank">cannabis360r@gmail.com.<br><br>

                            Food Safety 360<br>
                            BeGreen Legal';
                        } else if ($_COOKIE['client'] == 4) {
                            $subject = 'Welcome to Food Safety 360!';
                            $body = 'Food Safety 360, invites you to join <a href="'.$base_url.'CannOS-Login" target="_blank">Exim360</a> to connect and share documents. If you experience difficulties opening the website, kindly use this link instead <a href="'.$base_url.'CannOS-Login" target="_blank">https://interlinkiq.com/Exim360</a>.<br><br>

                            Should you need assistance, kindly email <a href="mailto:exim360r@gmail.com" target="_blank">exim360r@gmail.com.<br><br>

                            Food Safety 360<br>
                            BeGreen Legal';
                        } else {
    		    			$subject = 'You are invited!';
    		    			$body = 'Hi '.$user.',<br><br>
    		    
    		    			Your supplier '.$data_company.', invites you to <a href="'.$base_url.'" target="_blank">InterlinkIQ.com</a> to connect and share documents to comply with Customers\' Supplier Approval Program Requirements.<br><br>
    		    
    		    			Follow the video link for the instructional video Customer Requirements Management Module - <a href="https://youtu.be/9XklXwGBr7E" target="_blank">https://youtu.be/9XklXwGBr7E</a><br><br>

    						Should you need assistance, kindly call 202-982-3002 or email '.$data_email.'<br><br>
    		    
    		    			InterlinkIQ.com Team<br>
    		    			Consultare Inc.';
    					}
    	    
    	    			php_mailer_1($to, $user, $subject, $body, $data_email, $data_company);

    	    			// Adding SAP Requirements
    	    			if (!empty($requirement_email)) {
    						$to = $email;
    						$user = $name;
    						$subject = 'Customers Supplier Approval Requirements!';
    						$body = 'Hi '.$user.' Food Safety Team,<br><br>';

    						if ($user_id == 254) {
    							$body .= 'We are working with Jensen Meat Company (JMC) as part of their Supplier Approval Program (SAP). The '.$user.' has been identified as a Supplier/Service Provider of Jensen Meat Company  Plant Based.<br><br>';
    						} else {
    							$body .= 'We are working with '.$data_company.' as part of their Supplier Approval Program (SAP). Your company has been identified as a Supplier/Service Provider of '.$data_company.'.<br><br>';
    						}

    						$body .= 'We are requesting certain documents from your firm to comply with the SAP 21 CFR 117 Subpart G - Supply-Chain Program';

    						if ($_POST['supplier_countries'] != 'US') { $body .= ' / FSVP 21 CFR Subpart L - Foreign Supplier Verification Programs for Food Importers requirement'; }

    						$body .= '.<br><ol>';

    						$requirement_arr = explode(" | ", $requirement_email);
    	                	foreach ($requirement_arr as $value) {
    	                		$body .= '<li>'.$value.'</li>';
    	                	}

    						$body .= '</ol>

    						Follow the instructions below:<br><br>

    						To update Compliance:<br>
    						<ol>
    							<li>Go to <a href="'.$base_url.'" target="_blank">https://interlinkiq.com/</a> and click Log in. Enter your Username and Password.</li>
    							<li>Once successfully logged in, click the Enterprise Module.</li>
    							<li>Click Customer Module to view the list of your Customer.</li>
    							<li>Click View and go to Requirements Tab; comply by uploading the documents required in the list.</li>
    						</ol>

    						Kindly see the link below for our Customer Management Tutorial Video<br><br>

    						<table style="width: 100%; border-collapse: collapse;">
    							<tr>
    								<td style="border: 1px solid; padding: 5px; text-align: center;"><b>Tutorial Video</b></td>
    								<td style="border: 1px solid; padding: 5px; text-align: center;"><b>Video Link</b></td>
    							</tr>
    							<tr>
    								<td style="border: 1px solid; padding: 5px;">Free Access - Enterprise Management Module</td>
    								<td style="border: 1px solid; padding: 5px;">https://www.youtube.com/watch?v=pyhPjZKTlaE</td>
    							</tr>
    							<tr>
    								<td style="border: 1px solid; padding: 5px;">Free Access - Supplier Requirements Management Module</td>
    								<td style="border: 1px solid; padding: 5px;">https://youtu.be/nv2oM9hbN-Y</td>
    							</tr>
    						</table><br><br>

    						Should you need assistance, kindly call 202-982-3002 or email '.$data_email.'<br><br>

    						InterlinkIQ.com Team<br><br>
    						Consultare Inc.';
    		    
    	    				php_mailer_2($to, $user, $subject, $body, $data_email, $data_company);
    	    			}
    	    
    	                // Contact Section
    	                $data_contact = $rowData['contact'];
    	                if (!empty($data_contact)) {
    	                    $data_contact_arr = explode(", ", $data_contact);
    	                    foreach ($data_contact_arr as $value) {
    	                        $selectContact = mysqli_query( $conn,"SELECT * FROM tbl_supplier_contact WHERE notification = 1 AND ID = $value" );
    	                        if ( mysqli_num_rows($selectContact) > 0 ) {
    	                        	while($rowContact = mysqli_fetch_array($selectContact)) {
    	                                $contact_name = $rowContact["name"];
    	                                $contact_email = $rowContact["email"];
    	                	
    	                    			$to = $contact_email;
    	                    			$user = $contact_name;
    	                    			$subject = 'You are invited!';

    	                    			if ($_COOKIE['client'] == 1) {
    										$subject = 'Welcome to Cann OS!';
                                            $body = 'Hi '.$user.',<br><br>
                                
                                            Your supplier BeGreenLegal, invites you to <a href="'.$base_url.'CannOS-Login" target="_blank">Cann OS</a> to connect and manage your cannabis operation(s).<br><br>

                                            Should you need assistance, kindly email <a href="mailto:CannOS@begreenlegal.com.">CannOS@begreenlegal.com.</a><br><br>
                                
                                            Cann OS Team<br>
                                            BeGreenLegal';
    									} else if ($_COOKIE['client'] == 2) {
                                            $subject = 'Welcome to Cann OS!';
                                            $body = 'Hi '.$user.',<br><br>
                                
                                            Your supplier FoodSafety360, invites you to <a href="'.$base_url.'FoodSafety360" target="_blank">Food Safety 360</a> to connect and manage your Food Safety operation(s).<br><br>

                                            Should you need assistance, kindly email <a href="mailto:foodsafety360r@gmail.com">foodsafety360r@gmail.com.</a><br><br>
                                
                                            Cann OS Team<br>
                                            BeGreenLegal';
                                        } else if ($_COOKIE['client'] == 3) {
                                            $subject = 'Welcome to Cann OS!';
                                            $body = 'Hi '.$user.',<br><br>
                                
                                            Your supplier SafeCannabis360, invites you to <a href="'.$base_url.'SafeCannabis360" target="_blank">Food Safety 360</a> to connect and manage your Food Safety operation(s).<br><br>

                                            Should you need assistance, kindly email <a href="mailto:cannabis360r@gmail.com">cannabis360r@gmail.com.</a><br><br>
                                
                                            Cann OS Team<br>
                                            BeGreenLegal';
                                        } else if ($_COOKIE['client'] == 4) {
                                            $subject = 'Welcome to Cann OS!';
                                            $body = 'Hi '.$user.',<br><br>
                                
                                            Your supplier Exim360, invites you to <a href="'.$base_url.'Exim360" target="_blank">Food Safety 360</a> to connect and manage your Food Safety operation(s).<br><br>

                                            Should you need assistance, kindly email <a href="mailto:exim360r@gmail.com">exim360r@gmail.com.</a><br><br>
                                
                                            Cann OS Team<br>
                                            BeGreenLegal';
                                        } else {
    		                    			$body = 'Hi '.$user.',<br><br>
    		                    
    		                    			Your supplier, '.$data_company.', invites you to <a href="'. $base_url .'" target="_blank">InterlinkIQ.com</a> to connect and share documents to comply with Customers\' Supplier Approval Program Requirements.<br><br>
    		                    
    		                    			Follow the video link for the instructional video Customer Requirements Management Module - <a href="https://youtu.be/9XklXwGBr7E" target="_blank">https://youtu.be/9XklXwGBr7E</a><br><br>

    										Should you need assistance, kindly call 202-982-3002 or email '.$data_email.'<br><br>
    		                    
    		                    			InterlinkIQ.com Team<br>
    		                    			Consultare Inc.';
    									}
    	                    
    	    							php_mailer_2($to, $user, $subject, $body, $data_email, $data_company);


    					    			// Adding SAP Requirements
    					    			if (!empty($requirement_email)) {
    										$to = $contact_email;
    										$user = $contact_name;
    										$subject = 'Customers Supplier Approval Requirements!';
    										$body = 'Hi '.$user.' Food Safety Team,<br><br>';

    										if ($user_id == 254) {
    											$body .= 'We are working with Jensen Meat Company (JMC) as part of their Supplier Approval Program (SAP). The '.$user.' has been identified as a Supplier/Service Provider of Jensen Meat Company  Plant Based.<br><br>';
    										} else {
    											$body .= 'We are working with '.$data_company.' as part of their Supplier Approval Program (SAP). Your company has been identified as a Supplier/Service Provider of '.$data_company.'.<br><br>';
    										}

    										$body .= 'We are requesting certain documents from your firm to comply with the SAP 21 CFR 117 Subpart G - Supply-Chain Program';

    										if ($_POST['supplier_countries'] != 'US') { $body .= ' / FSVP 21 CFR Subpart L - Foreign Supplier Verification Programs for Food Importers requirement'; }

    										$body .= '.<br><ol>';

    										$requirement_arr = explode(" | ", $requirement_email);
    					                	foreach ($requirement_arr as $value) {
    					                		$body .= '<li>'.$value.'</li>';
    					                	}

    										$body .= '</ol>

    										Follow the instructions below:<br><br>

    										To update Compliance:<br>
    										<ol>
    											<li>Go to <a href="'.$base_url.'" target="_blank">https://interlinkiq.com/</a> and click Log in. Enter your Username and Password.</li>
    											<li>Once successfully logged in, click the Enterprise Module.</li>
    											<li>Click Customer Module to view the list of your Customer.</li>
    											<li>Click View and go to Requirements Tab; comply by uploading the documents required in the list.</li>
    										</ol>

    										Kindly see the link below for our Customer Management Tutorial Video<br><br>

    										<table style="width: 100%; border-collapse: collapse;">
    											<tr>
    												<td style="border: 1px solid; padding: 5px; text-align: center;"><b>Tutorial Video</b></td>
    												<td style="border: 1px solid; padding: 5px; text-align: center;"><b>Video Link</b></td>
    											</tr>
    											<tr>
    												<td style="border: 1px solid; padding: 5px;">Free Access - Enterprise Management Module</td>
    												<td style="border: 1px solid; padding: 5px;">https://www.youtube.com/watch?v=pyhPjZKTlaE</td>
    											</tr>
    											<tr>
    												<td style="border: 1px solid; padding: 5px;">Free Access - Supplier Requirements Management Module</td>
    												<td style="border: 1px solid; padding: 5px;">https://youtu.be/nv2oM9hbN-Y</td>
    											</tr>
    										</table><br><br>

    										Should you need assistance, kindly call 202-982-3002 or email '.$data_email.'<br><br>

    										InterlinkIQ.com Team<br><br>
    										Consultare Inc.';
    						    
    					    				php_mailer_2($to, $user, $subject, $body, $data_email, $data_company);
    					    			}
    	                        	}
    	                        }
    	                    }
    	                }
                    }
    				
    				echo json_encode($result);
    			}
    		}
    		mysqli_close($conn);
        }
	}
	if( isset($_POST['btnUpdate_Customer']) ) {
		$current_userID = $_COOKIE['ID'];
        $current_userEmployerID = employerID($current_userID);

		if (!empty($_COOKIE['switchAccount'])) {
			$portal_user = $_COOKIE['ID'];
			$user_id = $_COOKIE['switchAccount'];
		}
		else {
			$portal_user = $_COOKIE['ID'];
			$user_id = employerID($portal_user);
		}

        $current_dateNow_o = date('Y/m/d');
        $current_dateNow = new DateTime($current_dateNow_o);
        $current_dateNow = $current_dateNow->format('M d, Y');

		$ID = $_POST['ID'];
		$path = 'uploads/supplier/';
		$random = rand(1000,1000000);
        $audit_arr_item = array();
        $audit_filesize = 0;
        $process = true;

        $selectDataMain = mysqli_query( $conn,"SELECT * FROM tbl_supplier WHERE ID = $ID");
        if ( mysqli_num_rows($selectDataMain) > 0 ) {
            $rowDataMain = mysqli_fetch_array($selectDataMain);

            if (!empty($rowDataMain['audit_file_history'])) {
                $audit_arr_item = json_decode($rowDataMain["audit_file_history"],true);
            }
        }

		$name = addslashes($_POST['name']);
		$category = $_POST['category'];
		$industry = $_POST['industry'];

		$address = array();
		array_push($address, $_POST['countries']);
		array_push($address, $_POST['address_street']);
		array_push($address, $_POST['address_city']);
		array_push($address, $_POST['address_state']);
		array_push($address, $_POST['address_code']);
		$address = implode(" | ", $address);

		$email = addslashes($_POST['email']);
		$phone = addslashes($_POST['phone']);
		$fax = addslashes($_POST['fax']);
		$website = $_POST['website'];
		$status = $_POST['status'];
		$nda = $_POST['nda'];
        $notification = $_POST['notification'];
		$date = date('Y-m-d');

		$supplier_frequency = $_POST['supplier_frequency'];
		$supplier_frequency_custom = array();
		array_push($supplier_frequency_custom, $_POST['supplier_frequency_minute']);
		array_push($supplier_frequency_custom, $_POST['supplier_frequency_hour']);
		array_push($supplier_frequency_custom, $_POST['supplier_frequency_day']);
		array_push($supplier_frequency_custom, $_POST['supplier_frequency_month']);
		array_push($supplier_frequency_custom, $_POST['supplier_frequency_weekday']);
		$supplier_frequency_custom = implode(" | ", $supplier_frequency_custom);

		$document = "";
		if (!empty($_POST["document"])) { $document = implode(" | ", $_POST["document"]); }

		$document_other = "";
		if (!empty($_POST["document_other"])) { $document_other = implode(" | ", $_POST["document_other"]); }

		$document_name = "";
		if (!empty($_POST["document_name"])) { $document_name = implode(" | ", $_POST["document_name"]); }

		$document_other_name = "";
		if (!empty($_POST["document_other_name"])) { $document_other_name = implode(" | ", $_POST["document_other_name"]); }

		$contact = "";
		if (!empty($_POST["contact_id"])) { $contact = implode(", ", $_POST["contact_id"]); }

		$material = "";
		if (!empty($_POST["material_id"])) { $material = implode(", ", $_POST["material_id"]); }

		$service = "";
		if (!empty($_POST["service_id"])) { $service = implode(", ", $_POST["service_id"]); }

		$department_id = '';
		if (!empty($_POST['department_id'])) { $department_id = implode(", ",$_POST['department_id']); }

		$employee_id = '';
		if (!empty($_POST['employee_id'])) { $employee_id = implode(", ",$_POST['employee_id']); }

		$selectSupplier = mysqli_query( $conn,"SELECT * FROM tbl_supplier WHERE ID = $ID" );
		if ( mysqli_num_rows($selectSupplier) > 0 ) {
            $rowSupplier = mysqli_fetch_array($selectSupplier);

            $current_audit_report = $rowSupplier['audit_report'];
			$current_audit_report_arr = explode(" | ", $current_audit_report);

            $current_audit_certificate = $rowSupplier['audit_certificate'];
			$current_audit_certificate_arr = explode(" | ", $current_audit_certificate);

            $current_audit_action = $rowSupplier['audit_action'];
			$current_audit_action_arr = explode(" | ", $current_audit_action);
        }

		$audit_report = array();
        $audit_report_validity = $_POST['audit_report_validity'];
        $audit_report_validity = explode(' - ', $audit_report_validity);
        $audit_report_validity_start = !empty($audit_report_validity[0]) ? $audit_report_validity[0] : '';
        $audit_report_validity_end = !empty($audit_report_validity[1]) ? $audit_report_validity[1] : '';
        $audit_report_file = $_FILES['audit_report_file']['name'];
        if (!empty($audit_report_file)) {
            $audit_filesize = $_FILES['audit_report_file']['size'];
            $audit_report_file_tmp = $_FILES['audit_report_file']['tmp_name'];
            $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
            $ext = strtolower(pathinfo($audit_report_file, PATHINFO_EXTENSION));
            $audit_report_file = $random.' - '.$audit_report_file;
            $audit_report_file_path = $path.$audit_report_file;

            if(!in_array($ext, $invalid_extensions)) {
                move_uploaded_file($audit_report_file_tmp, $audit_report_file_path);
                array_push($audit_report, $audit_report_file);

                $output = array (
                    'type'  =>  1,
                    'name' =>  $audit_report_file,
                    'size' =>  $audit_filesize,
                    'date' =>  $local_date
                );
                array_push($audit_arr_item, $output);
            } else {
                $process = false;
            }
        } else {
            array_push($audit_report, $_POST['audit_report_file_tmp']);
        }
        array_push($audit_report, $audit_report_validity_start);
        array_push($audit_report, $audit_report_validity_end);
        array_push($audit_report, $_POST['audit_report_note']);
        $audit_report = implode(" | ", $audit_report);

        $audit_certificate = array();
        $audit_certificate_validity = $_POST['audit_certificate_validity'];
        $audit_certificate_validity = explode(' - ', $audit_certificate_validity);
        $audit_certificate_validity_start = !empty($audit_certificate_validity[0]) ? $audit_certificate_validity[0] : '';
        $audit_certificate_validity_end = !empty($audit_certificate_validity[1]) ? $audit_certificate_validity[1] : '';
        $audit_certificate_file = $_FILES['audit_certificate_file']['name'];
        if (!empty($audit_certificate_file)) {
            $audit_filesize = $_FILES['audit_certificate_file']['size'];
            $audit_certificate_file_tmp = $_FILES['audit_certificate_file']['tmp_name'];
            $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
            $ext = strtolower(pathinfo($audit_certificate_file, PATHINFO_EXTENSION));
            $audit_certificate_file = $random.' - '.$audit_certificate_file;
            $audit_certificate_file_path = $path.$audit_certificate_file;

            if(!in_array($ext, $invalid_extensions)) {
                move_uploaded_file($audit_certificate_file_tmp, $audit_certificate_file_path);
                array_push($audit_certificate, $audit_certificate_file);

                $output = array (
                    'type'  =>  2,
                    'name' =>  $audit_certificate_file,
                    'size' =>  $audit_filesize,
                    'date' =>  $local_date
                );
                array_push($audit_arr_item, $output);
            } else {
                $process = false;
            }
        } else {
            array_push($audit_certificate, $_POST['audit_certificate_file_tmp']);
        }
        array_push($audit_certificate, $audit_certificate_validity_start);
        array_push($audit_certificate, $audit_certificate_validity_end);
        array_push($audit_certificate, $_POST['audit_certificate_note']);
        $audit_certificate = implode(" | ", $audit_certificate);

        $audit_action = array();
        $audit_action_validity = $_POST['audit_action_validity'];
        $audit_action_validity = explode(' - ', $audit_action_validity);
        $audit_action_validity_start = !empty($audit_action_validity[0]) ? $audit_action_validity[0] : '';
        $audit_action_validity_end = !empty($audit_action_validity[1]) ? $audit_action_validity[1] : '';
        $audit_action_file = $_FILES['audit_action_file']['name'];
        if (!empty($audit_action_file)) {
            $audit_filesize = $_FILES['audit_action_file']['size'];
            $audit_action_file_tmp = $_FILES['audit_action_file']['tmp_name'];
            $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
            $ext = strtolower(pathinfo($audit_action_file, PATHINFO_EXTENSION));
            $audit_action_file = $random.' - '.$audit_action_file;
            $audit_action_file_path = $path.$audit_action_file;

            if(!in_array($ext, $invalid_extensions)) {
                move_uploaded_file($audit_action_file_tmp, $audit_action_file_path);
                array_push($audit_action, $audit_action_file);

                $output = array (
                    'type'  =>  3,
                    'name' =>  $audit_action_file,
                    'size' =>  $audit_filesize,
                    'date' =>  $local_date
                );
                array_push($audit_arr_item, $output);
            } else {
                $process = false;
            }
        } else {
            array_push($audit_action, $_POST['audit_action_file_tmp']);
        }
        array_push($audit_action, $audit_action_validity_start);
        array_push($audit_action, $audit_action_validity_end);
        array_push($audit_action, $_POST['audit_action_note']);
        $audit_action = implode(" | ", $audit_action);
        $audit_file_history = json_encode($audit_arr_item, JSON_HEX_APOS | JSON_UNESCAPED_UNICODE);

        $audit = $_POST['audit'];
        $reviewed_by = $_POST['reviewed_by'];
        $reviewed_validity = $_POST['reviewed_validity'];
        $reviewed_validity = explode(' - ', $reviewed_validity);
        $reviewed_date = !empty($reviewed_validity[0]) ? $reviewed_validity[0] : '';
        $reviewed_due = !empty($reviewed_validity[1]) ? $reviewed_validity[1] : '';

        if ($process == true) {
    		// Temporary Data
    		$temp_docs = array();
    		$selectDataTemp_Docs = mysqli_query( $conn,"SELECT * FROM tbl_supplier_document WHERE supplier_id = $ID" );
    		if ( mysqli_num_rows($selectDataTemp_Docs) > 0 ) {
    			while($rowDataTemp_Docs = mysqli_fetch_array($selectDataTemp_Docs)) {
    				$temp_doc_ID = $rowDataTemp_Docs['ID'];

    				$docs_data = array (
    					'doc_ID' 			=> 	$rowDataTemp_Docs['ID'],
    					'doc_type' 			=> 	$rowDataTemp_Docs['type'],
    					'doc_name' 			=> 	$rowDataTemp_Docs['name'],
    					'doc_file' 			=> 	$rowDataTemp_Docs['file'],
    					'doc_filename' 		=> 	$rowDataTemp_Docs['filename'],
    					'doc_filedate' 		=> 	$rowDataTemp_Docs['file_date'],
    					'doc_filedue' 		=> 	$rowDataTemp_Docs['file_due'],
    					'doc_reviewedby' 	=> 	$rowDataTemp_Docs['reviewed_by'],
    					'doc_approvedby' 	=> 	$rowDataTemp_Docs['approved_by']
    				);

    				array_push($temp_docs, $docs_data);
    			}
    		}
    		$temp_document = json_encode($temp_docs);

    		mysqli_query( $conn,"UPDATE tbl_supplier set name='". $name ."', address='". $address ."', phone='". $phone ."', fax='". $fax ."', email='". $email ."', website='". $website ."', category='". $category ."', industry='". $industry ."', contact='". $contact ."', document='". $document_name ."', document_other='". $document_other_name ."', material='". $material ."', service='". $service ."', audit='". $audit ."', audit_report='". $audit_report ."', audit_certificate='". $audit_certificate ."', audit_action='". $audit_action ."', audit_filesize='". $audit_filesize ."', audit_file_history='". $audit_file_history ."', reviewed_by='". $reviewed_by ."', reviewed_date='". $reviewed_date ."', reviewed_due='". $reviewed_due ."', department_id='". $department_id ."', employee_id='". $employee_id ."', status='". $status ."' , notification='". $notification ."', nda='". $nda ."', frequency='". $supplier_frequency ."', frequency_custom='". $supplier_frequency_custom ."' WHERE ID='". $ID ."'" );
            
    		if (!mysqli_error($conn)) {
    			$selectData = mysqli_query( $conn,'SELECT * FROM tbl_supplier WHERE ID="'. $ID .'" ORDER BY ID LIMIT 1' );
    			if ( mysqli_num_rows($selectData) > 0 ) {
    				$rowData = mysqli_fetch_array($selectData);
    				$data_ID = $rowData['ID'];
    				$data_page = $rowData['page'];
    				$data_user_id = $rowData["user_id"];
    				$data_name = $rowData['name'];
    				$data_document_other = $rowData['document_other'];
    				$data_reviewed_due = $rowData['reviewed_due'];
                    $data_status = $rowData["status"];
                    $data_notification = $rowData["notification"];
                    $data_status_type = array(
                        0 => 'Pending',
    	                1 => 'Active',
    	                2 => 'Inactive'
                    );

                    $contact_name = '';
                    $contact_address = '';
                    $contact_info = '';
                    $data_contact = $rowData["contact"];
                    if (!empty($data_contact)) {
                        $contact_arr = explode(", ", $data_contact);
                        foreach ($contact_arr as $value) {
                            $selectContact = mysqli_query( $conn,"SELECT * FROM tbl_supplier_contact WHERE ID=$value" );
                            if ( mysqli_num_rows($selectContact) > 0 ) {
                                $rowContact = mysqli_fetch_array($selectContact);
                                $contact_name = $rowContact["name"];
                                $contact_address = $rowContact["address"];
                                $contact_email = $rowContact["email"];
                                $contact_phone = $rowContact["phone"];
                                $contact_cell = $rowContact["cell"];
                                $contact_fax = $rowContact["fax"];

                                $contact_info = '<ul class="list-inline">';
    	                            if ($contact_email != "") { $contact_info .= '<li><a href="mailto:'.$contact_email.'" target="_blank" title="Email"><i class="fa fa-envelope"></i></a></li>'; }
    	                            if ($contact_phone != "") { $contact_info .= '<li><a href="tel:'.$contact_phone.'" target="_blank" title="Phone"><i class="fa fa-phone-square"></i></a></li>'; }
    	                            if ($contact_cell != "") { $contact_info .= '<li><a href="tel:'.$contact_cell.'" target="_blank" title="Cell Number"><i class="fa fa-phone"></i></a></li>'; }
    	                            if ($contact_fax != "") { $contact_info .= '<li><a href="tel:'.$contact_fax.'" target="_blank" title="Fax"><i class="fa fa-print"></i></a></li>'; }
                                $contact_info .= '</ul>';

                                break;
                            }
                        }
                    }

    	            // Document Section
    				$path = 'uploads/supplier/';
    				$random = rand(1000,1000000);
    				if (!empty($_POST["document_name"])) {
    					for ($i=0; $i < count($_POST["document_name"]); $i++) {
    						$document_names = addslashes($_POST["document_name"][$i]);
    						$document_filename = addslashes($_POST["document_filename"][$i]);
    						// $document_date = $_POST["document_date"][$i];
    						// $document_due = $_POST["document_due"][$i];
    						$document_comment = $_POST["document_comment"][$i];
                            $arr_item = array();
                            $filesize = 0;
                            $selectDataMainDoc = mysqli_query( $conn,'SELECT * FROM tbl_supplier_document WHERE supplier_id="'. $data_ID .'" AND type="0" AND name="'.$document_names.'" ORDER BY ID LIMIT 1' );
                            if ( mysqli_num_rows($selectDataMainDoc) > 0 ) {
                                $rowDataMainDoc = mysqli_fetch_array($selectDataMainDoc);

                                if (!empty($rowDataMainDoc['file_history'])) {
                                    $arr_item = json_decode($rowDataMainDoc["file_history"],true);
                                }
                            }

    						$document_date = '';
    						$document_due = '';
    						$document_daterange = $_POST["document_daterange"][$i];
    						if (!empty($document_daterange)) {
    							$document_daterange = explode(' - ', $document_daterange);
    							$document_date = $document_daterange[0];
    							$document_due = $document_daterange[1];
    						}

    						$document_filetype = $_POST["document_filetype"][$i];
    						if ($document_filetype == 1) {
                                $files = $_FILES['document_file']['name'][$i];
                                $file_docs = "";
                                if (!empty($files)) {
                                    $filesize = $_FILES['document_file']['size'][$i];
                                    $tmp_docs = $_FILES['document_file']['tmp_name'][$i];
                                    $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                                    $ext = strtolower(pathinfo($files, PATHINFO_EXTENSION));
                                    $file_docs = $random.' - '.$files;
                                    $path_docs = $path.$file_docs;

                                    if(!in_array($ext, $invalid_extensions)) {
                                        move_uploaded_file($tmp_docs,$path_docs);
                                    } else {
                                        $process = false;
                                    }
                                }
                            } else {
    							$file_docs = $_POST["document_fileurl"][$i];
    						}

                            $output = array (
                                'type' =>  $document_filetype,
                                'name' =>  $file_docs,
                                'size' =>  $filesize,
                                'date' =>  $local_date
                            );
                            array_push($arr_item, $output);
    					
    						$files_template = $_FILES['document_template']['name'][$i];
    						$file_docs_template = "";
    						if (!empty($files_template)) {
                                $filesize = $_FILES['document_template']['size'][$i];
    							$tmp_docs = $_FILES['document_template']['tmp_name'][$i];
                                $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                                $ext = strtolower(pathinfo($files_template, PATHINFO_EXTENSION));
    							$file_docs_template = $random.' - '.$files_template;
    							$path_docs = $path.$file_docs_template;

                                if(!in_array($ext, $invalid_extensions)) {
                                    move_uploaded_file($tmp_docs,$path_docs);

                                    $output = array (
                                        'type'  =>  0,
                                        'name' =>  $file_docs_template,
                                        'size' =>  $filesize,
                                        'date' =>  $local_date
                                    );
                                    array_push($arr_item, $output);
                                } else {
                                    $process = false;
                                }
    						}
                            $file_history = json_encode($arr_item, JSON_HEX_APOS | JSON_UNESCAPED_UNICODE);

                            if ($process == true) {
        						$selectDocuments = mysqli_query( $conn,'SELECT * FROM tbl_supplier_document WHERE supplier_id="'. $data_ID .'" AND type="0" AND name="'.$document_names.'" ORDER BY ID LIMIT 1' );
        						if ( mysqli_num_rows($selectDocuments) > 0 ) {
        							$rowDocuments = mysqli_fetch_array($selectDocuments);
        							$sup_doc_id = $rowDocuments["ID"];

        							mysqli_query( $conn,"UPDATE tbl_supplier_document set filename='". $document_filename ."', file_date='". $document_date ."', file_due='". $document_due ."' WHERE ID='". $sup_doc_id ."'" );
        							if ($current_userEmployerID == 34 OR $current_userEmployerID == 27 OR $current_userEmployerID == 464 OR $current_userEmployerID == 1106) {
        								$document_reviewed = $_POST["document_reviewed"][$i];
        								$document_approved = $_POST["document_approved"][$i];
        								mysqli_query( $conn,"UPDATE tbl_supplier_document set reviewed_by='". $document_reviewed ."', approved_by='". $document_approved ."' WHERE ID='". $sup_doc_id ."'" );
        							}

        							if (!empty($file_docs)) { mysqli_query( $conn,"UPDATE tbl_supplier_document set file='". $file_docs ."', filetype = '".$document_filetype."', filesize = '".$filesize."', file_history = '".$file_history."' WHERE ID='". $sup_doc_id ."'" ); }
                                    if (!empty($file_docs_template)) { mysqli_query( $conn,"UPDATE tbl_supplier_document set template='". $file_docs_template ."' WHERE ID='". $sup_doc_id ."'" ); }

        							if (!empty($document_comment)) {
        								$sql = "INSERT INTO tbl_supplier_comment (user_id, portal_user, supplier_document_id, comment, last_modified)
        								VALUES ('$user_id', '$portal_user', '$sup_doc_id', '$document_comment', '$date')";
        								mysqli_query($conn, $sql);
        							}
        						} else {
        							$sql = "INSERT INTO tbl_supplier_document (user_id, portal_user, supplier_id, name, file, filetype, filesize, file_history, filename, file_date, file_due, template)
                                    VALUES ('$user_id', '$portal_user', '$data_ID', '$document_names', '$file_docs', '$document_filetype', '$filesize', '$file_history', '$document_filename', '$document_date', '$document_due', '$file_docs_template')";
                                    if (mysqli_query($conn, $sql)) {
        								$supplier_document_last_id = mysqli_insert_id($conn);

        								if (!empty($document_comment)) {
        									$sql = "INSERT INTO tbl_supplier_comment (user_id, portal_user, supplier_document_id, comment, last_modified)
        									VALUES ('$user_id', '$portal_user', '$supplier_document_last_id', '$document_comment', '$date')";
        									mysqli_query($conn, $sql);
        								}
        							}
        						}
                            }
    					}
    				}
    				if (!empty($_POST["document_other_name"])) {
    					for ($i=0; $i < count($_POST["document_other_name"]); $i++) {
    						$document_names = addslashes($_POST["document_other_name"][$i]);
    						$document_filename = addslashes($_POST["document_other_filename"][$i]);
    						// $document_date = $_POST["document_other_date"][$i];
    						// $document_due = $_POST["document_other_due"][$i];
    						$document_comment = $_POST["document_other_comment"][$i];
                            $arr_item = array();
                            $filesize = 0;
                            $selectDataMainDoc = mysqli_query( $conn,'SELECT * FROM tbl_supplier_document WHERE supplier_id="'. $data_ID .'" AND type="1" AND name="'.$document_names.'" ORDER BY ID LIMIT 1' );
                            if ( mysqli_num_rows($selectDataMainDoc) > 0 ) {
                                $rowDataMainDoc = mysqli_fetch_array($selectDataMainDoc);

                                if (!empty($rowDataMainDoc['file_history'])) {
                                    $arr_item = json_decode($rowDataMainDoc["file_history"],true);
                                }
                            }

    						$document_date = '';
    						$document_due = '';
    						$document_other_daterange = $_POST["document_other_daterange"][$i];
    						if (!empty($document_other_daterange)) {
    							$document_other_daterange = explode(' - ', $document_other_daterange);
    							$document_date = $document_other_daterange[0];
    							$document_due = $document_other_daterange[1];
    						}

    						$document_filetype = $_POST["document_other_filetype"][$i];
                            if ($document_filetype == 1) {
                                $files = $_FILES['document_other_file']['name'][$i];
                                $file_docs = "";
                                if (!empty($files)) {
                                    $filesize = $_FILES['document_other_file']['size'][$i];
                                    $tmp_docs = $_FILES['document_other_file']['tmp_name'][$i];
                                    $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                                    $ext = strtolower(pathinfo($files, PATHINFO_EXTENSION));
                                    $file_docs = $random.' - '.$files;
                                    $path_docs = $path.$file_docs;

                                    if(!in_array($ext, $invalid_extensions)) {
                                        move_uploaded_file($tmp_docs,$path_docs);
                                    } else {
                                        $process = false;
                                    }
                                }
                            } else {
                                $file_docs = $_POST["document_other_fileurl"][$i];
                            }

                            $output = array (
                                'type' =>  $document_filetype,
                                'name' =>  $file_docs,
                                'size' =>  $filesize,
                                'date' =>  $local_date
                            );
                            array_push($arr_item, $output);
    					
    						$files_template = $_FILES['document_other_template']['name'][$i];
    						$file_docs_template = "";
    						if (!empty($files_template)) {
                                $filesize = $_FILES['document_template']['size'][$i];
                                $tmp_docs = $_FILES['document_other_template']['tmp_name'][$i];
                                $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                                $ext = strtolower(pathinfo($files, PATHINFO_EXTENSION));
                                $file_docs_template = $random.' - '.$files_template;
                                $path_docs = $path.$file_docs_template;

                                if(!in_array($ext, $invalid_extensions)) {
                                    move_uploaded_file($tmp_docs,$path_docs);

                                    $output = array (
                                        'type'  =>  0,
                                        'name' =>  $file_docs_template,
                                        'size' =>  $filesize,
                                        'date' =>  $local_date
                                    );
                                    array_push($arr_item, $output);
                                } else {
                                    $process = false;
                                }
                            }
                            $file_history = json_encode($arr_item, JSON_HEX_APOS | JSON_UNESCAPED_UNICODE);

                            if ($process == true) {
        						$selectDocuments = mysqli_query( $conn,'SELECT * FROM tbl_supplier_document WHERE supplier_id="'. $data_ID .'" AND type="1" AND name="'.$document_names.'" ORDER BY ID LIMIT 1' );
        						if ( mysqli_num_rows($selectDocuments) > 0 ) {
        							$rowDocuments = mysqli_fetch_array($selectDocuments);
        							$sup_doc_id = $rowDocuments["ID"];

        							mysqli_query( $conn,"UPDATE tbl_supplier_document set filename='". $document_filename ."', file_date='". $document_date ."', file_due='". $document_due ."' WHERE ID='". $sup_doc_id ."'" );
        							if ($current_userEmployerID == 34 OR $current_userEmployerID == 27 OR $current_userEmployerID == 464 OR $current_userEmployerID == 1106) {
        								$document_reviewed = $_POST["document_other_reviewed"][$i];
        								$document_approved = $_POST["document_other_approved"][$i];
        								mysqli_query( $conn,"UPDATE tbl_supplier_document set reviewed_by='". $document_reviewed ."', approved_by='". $document_approved ."' WHERE ID='". $sup_doc_id ."'" );
        							}
        						
        							if (!empty($file_docs)) { mysqli_query( $conn,"UPDATE tbl_supplier_document set file='". $file_docs ."', filetype = '".$document_filetype."', filesize = '".$filesize."', file_history = '".$file_history."' WHERE ID='". $sup_doc_id ."'" ); }
                                    if (!empty($file_docs_template)) { mysqli_query( $conn,"UPDATE tbl_supplier_document set template='". $file_docs_template ."' WHERE ID='". $sup_doc_id ."'" ); }

        							if (!empty($document_comment)) {
        								$sql = "INSERT INTO tbl_supplier_comment (user_id, portal_user, supplier_document_id, comment, last_modified)
        								VALUES ('$user_id', '$portal_user', '$sup_doc_id', '$document_comment', '$date')";
        								mysqli_query($conn, $sql);
        							}
        						} else {
        							$sql = "INSERT INTO tbl_supplier_document (user_id, portal_user, supplier_id, type, name, file, filetype, filesize, file_history, filename, file_date, file_due, template)
                                    VALUES ('$user_id', '$portal_user', '$data_ID', '1', '$document_names', '$file_docs', '$document_filetype', '$filesize', '$file_history', '$document_filename', '$document_date', '$document_due', '$file_docs_template')";
                                    if (mysqli_query($conn, $sql)) {
        								$supplier_document_last_id = mysqli_insert_id($conn);

        								if (!empty($document_comment)) {
        									$sql = "INSERT INTO tbl_supplier_comment (user_id, portal_user, supplier_document_id, comment, last_modified)
        									VALUES ('$user_id', '$portal_user', '$supplier_document_last_id', '$document_comment', '$date')";
        									mysqli_query($conn, $sql);
        								}
        							}
        						}
                            }
    					}
    				}

    	            // Requirement Section
    				// $requirement = array();
    				// $selectRequirement = mysqli_query( $conn,"SELECT * FROM tbl_supplier_requirement" );
    	            // while($rowRequirement = mysqli_fetch_array($selectRequirement)) {
    	            //     $data_document_arr = explode(", ", $rowData["document"]);
    	            //     foreach ($data_document_arr as $value) {
    	            //         if ( $value == $rowRequirement["ID"] ) {
    	            //             array_push($requirement, $rowRequirement["name"]);
    	            //         }
    	            //     }
    	            // }
    	            // $requirement = implode(', ', $requirement);
    	            // if (!empty($data_document_other)) { $requirement .= ", ". $data_document_other; }

    	            // Requirement Section
    				$requirement = array();
    				$requirement_email = "";
    				// $selectRequirement = mysqli_query( $conn,"SELECT * FROM tbl_supplier_requirement" );
                    $selectRequirement = mysqli_query( $conn,"SELECT
                        d_ID,
                        d_name,
                        d_file,
                        r_ID,
                        r_name,
                        s.ID AS s_ID,
                        s.name AS s_name
                        FROM (
                            SELECT
                            d.ID AS d_ID,
                            d.name AS d_name,
                            d.file AS d_file,
                            r.ID AS r_ID,
                            r.name AS r_name
                            FROM tbl_supplier_document AS d

                            INNER JOIN (
                                SELECT
                                *
                                FROM tbl_supplier_requirement
                            ) AS r
                            ON d.name = r.ID

                            WHERE d.type = 0
                            AND LENGTH(d.file) = 0
                            AND d.user_id = $data_user_id
                            AND d.supplier_id = $data_ID
                        ) AS o

                        LEFT JOIN (
                            SELECT
                            *
                            FROM tbl_supplier
                        ) AS s
                        ON FIND_IN_SET(o.r_ID, REPLACE(REPLACE(s.document, ' ', ''), '|',','  )  ) > 0

                        WHERE s.ID = $data_ID" );
    	            while($rowRequirement = mysqli_fetch_array($selectRequirement)) {
                        array_push($requirement, $rowRequirement["r_name"]);

    	                // $data_document_arr = explode(" | ", $rowData["document"]);
    	                // foreach ($data_document_arr as $value) {
    	                //     if ( $value == $rowRequirement["ID"] ) {
    	                //         array_push($requirement, $rowRequirement["name"]);
    	                //     }
    	                // }
    	            }
    	            // if (!empty($requirement)) { $requirement_email = implode(' | ', $requirement); }

    		        $compliance = 0;
    		        $compliance_counter = 0;
    		        $compliance_approved = 0;
                    if (!empty($_POST["document"])) {
                        $selectRequirement = mysqli_query( $conn,"SELECT * FROM tbl_supplier_requirement ORDER BY name" );
                        while($rowRequirement = mysqli_fetch_array($selectRequirement)) {
                            $req_id = $rowRequirement["ID"];
                            $req_name = $rowRequirement["name"];

                            $document_arr = implode(" | ", $_POST["document"]);
                            $document_arr = explode(" | ", $document_arr);
                            foreach ($document_arr as $value) {
                                if ( $value == $req_id ) {
                                    $selectDocument = mysqli_query( $conn,"SELECT * FROM tbl_supplier_document WHERE user_id='".$data_user_id."' AND supplier_id='".$ID."' AND name='".$req_id."'" );
                                    if ( mysqli_num_rows($selectDocument) > 0 ) {
                                        $rowDocument = mysqli_fetch_array($selectDocument);
                                        $doc_file_approved = $rowDocument["approved_by"];

                                        $compliance_counter++;
                                        // if ($doc_file_approved > 0) { $compliance_approved++; }

                                        $doc_file_due = $rowDocument["file_due"];
                                        if (!empty($doc_file_due)) {
                                            $doc_file_due = new DateTime($doc_file_due);
                                            $doc_file_due_o = $doc_file_due->format('Y/m/d');
                                            $doc_file_due_o_nearly = date('Y/m/d', strtotime($doc_file_due_o. ' - 30 days'));
                                            $doc_file_due = $doc_file_due->format('m/d/Y');

                                            if ($doc_file_due_o >= $current_dateNow_o && $doc_file_approved > 0) { $compliance_approved++; }
                                        };
                                    }
                                }
                            }
                        }
                    }

    	            // $requirement = implode(' | ', $requirement);
    	            if (!empty($data_document_other)) {
    	            	// $requirement .= " | ". $data_document_other;

    	            	// $data_document_other_arr = array();
    	            	// $data_document_other_arr = explode(' | ', $data_document_other);
    	            	// $data_document_other_arr = implode(' | ', $data_document_other_arr);
    	            	// $requirement_email .= " | ". $data_document_other_arr;

    	                $document_other_arr = implode(" | ", $_POST["document_other"]);
    	                $document_other_arr = explode(" | ", $document_other_arr);
    	                foreach ($document_other_arr as $value) {
    	                    $selectDocument = mysqli_query( $conn,"SELECT * FROM tbl_supplier_document WHERE user_id='".$data_user_id."' AND supplier_id='".$ID."' AND name='".$value."'" );
    	                    if ( mysqli_num_rows($selectDocument) > 0 ) {
    	                        $rowDocument = mysqli_fetch_array($selectDocument);
    	                        $doc_file_approved = $rowDocument["approved_by"];

                                if (empty($rowDocument["file"])) {
                                    array_push($requirement, $value);
                                }

    	                        $compliance_counter++;
    	                        // if ($doc_file_approved > 0) { $compliance_approved++; }

                                $doc_file_due = $rowDocument["file_due"];
                                if (!empty($doc_file_due)) {
                                    $doc_file_due = new DateTime($doc_file_due);
                                    $doc_file_due_o = $doc_file_due->format('Y/m/d');
                                    $doc_file_due_o_nearly = date('Y/m/d', strtotime($doc_file_due_o. ' - 30 days'));
                                    $doc_file_due = $doc_file_due->format('m/d/Y');

                                    if ($doc_file_due_o >= $current_dateNow_o && $doc_file_approved > 0) { $compliance_approved++; }
                                };
    	                    }
    	                }
    	            }
                    if (!empty($requirement)) { $requirement_email = implode(' | ', $requirement); }

                    if ($compliance_counter > 0) { $compliance = intval(($compliance_approved / $compliance_counter) * 100); }
                    else { $compliance = 0; }
                    mysqli_query( $conn,"UPDATE tbl_supplier set compliance = $compliance WHERE ID = $ID" );

    				// Category Section
    				$data_category_id = $rowData['category'];
    				$selectCategory = mysqli_query( $conn,'SELECT * FROM tbl_supplier_category WHERE ID="'. $data_category_id .'" ORDER BY ID LIMIT 1' );
    				$rowCategory = mysqli_fetch_array($selectCategory);
    				$data_category = $rowCategory['name'];

    				if ($data_page == 2) {
    					if ($data_category_id == "3") {
    						$data_material = $rowData['service'];
    						$material_arr = array();
    						if (!empty($data_material)) {
    			                $data_material_arr = explode(", ", $data_material);
    			                foreach ($data_material_arr as $value) {
    			                    $selectMaterial = mysqli_query( $conn,"SELECT * FROM tbl_supplier_service WHERE ID=$value" );
    			                    if ( mysqli_num_rows($selectMaterial) > 0 ) {
    			                    	while($rowMaterial = mysqli_fetch_array($selectMaterial)) {
    			                            $material_ID = $rowMaterial['service_name'];

    		                                $selectDataCategory = mysqli_query( $conn,"SELECT * FROM tbl_service_category WHERE id=$material_ID" );
    		                                $rowDataCategory = mysqli_fetch_array($selectDataCategory);
    		                                array_push($material_arr, $rowDataCategory['service_category']);
    			                    	}
    			                    }
    			                }
    			                $data_material = implode(', ', $material_arr);
    			            }
    					} else {
    						$data_material = $rowData['material'];
    						$material_arr = array();
    						if (!empty($data_material)) {
    			                $data_material_arr = explode(", ", $data_material);
    			                foreach ($data_material_arr as $value) {
    			                    $selectMaterial = mysqli_query( $conn,"SELECT * FROM tbl_supplier_material WHERE ID=$value" );
    			                    if ( mysqli_num_rows($selectMaterial) > 0 ) {
    			                    	while($rowMaterial = mysqli_fetch_array($selectMaterial)) {
    			                            $material_ID = $rowMaterial['material_name'];

    			                            $selectProduct = mysqli_query( $conn,"SELECT * FROM tbl_products WHERE ID=$material_ID" );
    			                            $rowProduct = mysqli_fetch_array($selectProduct);
    			                            array_push($material_arr, $rowProduct['name']);
    			                    	}
    			                    }
    			                }
    			                $data_material = implode(', ', $material_arr);
    			            }
    		            }
    				} else {
    					if ($data_category_id == "3") {
    						$data_material = $rowData['service'];
    						$material_arr = array();
    						if (!empty($data_material)) {
    			                $data_material_arr = explode(", ", $data_material);
    			                foreach ($data_material_arr as $value) {
    			                    $selectMaterial = mysqli_query( $conn,"SELECT * FROM tbl_supplier_service WHERE ID=$value" );
                                    $rowMaterial = mysqli_fetch_array($selectMaterial);
                                    array_push($material_arr, $rowMaterial['service_name']);
    			                }
    			                $data_material = implode(', ', $material_arr);
    			            }
                        } else {
    						$data_material = $rowData['material'];
    						$material_arr = array();
    						if (!empty($data_material)) {
    			                $data_material_arr = explode(", ", $data_material);
    			                foreach ($data_material_arr as $value) {
    			                    $selectMaterial = mysqli_query( $conn,"SELECT * FROM tbl_supplier_material WHERE ID=$value" );
                                    $rowMaterial = mysqli_fetch_array($selectMaterial);
                                    array_push($material_arr, $rowMaterial['material_name']);
    			                }
    			                $data_material = implode(', ', $material_arr);
    			            }
                        }
    				}
                    
                    $address_array = array();
                    $address = $rowData["address"];
                    $address_arr = explode(" | ", $address);
                    if (COUNT($address_arr) < 5) {
                        $address_arr = explode(", ", $address);
                    }
                    array_push($address_array, htmlentities($address_arr[1]));
                    array_push($address_array, htmlentities($address_arr[2]));
                    array_push($address_array, htmlentities($address_arr[3]));
                    array_push($address_array, $address_arr[0]);
                    array_push($address_array, $address_arr[4]);
                    $address_arr = implode(", ", $address_array);

    	        	$counterup_tbl = counterup_tbl('supplier');
    				$output = array(
    					"ID" => $data_ID,
    					"page" => $data_page,
                        "supplier_name" => htmlentities($data_name ?? ''),
                        "category" => htmlentities($data_category ?? ''),
                        "material" => htmlentities($data_material ?? ''),
                        "address" => $address_arr,
                        "contact_name" => htmlentities($contact_name ?? ''),
                        "contact_address" => htmlentities($contact_address ?? ''),
    					"contact_info" => $contact_info,
    					"reviewed_due" => $data_reviewed_due,
    					"compliance" => $compliance,
    					"status" => $data_status_type[$data_status]
    				);
    				$result = array_merge($counterup_tbl, $output);
        
        			if ($data_notification == 1) {
    	    			$data_company = "";
    	    			$data_email = "";
    	    			$selectEnterprise = mysqli_query( $conn,"SELECT * FROM tblEnterpiseDetails WHERE users_entities = $user_id" );
    	    			if ( mysqli_num_rows($selectEnterprise) > 0 ) {
    	    			    $rowEnterprise = mysqli_fetch_array($selectEnterprise);
    	    			    $data_company = $rowEnterprise["businessname"];
    	    			    $data_email = $rowEnterprise["businessemailAddress"];
    	    			}

    					$selectDataTemp_Docs_Portal_User = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $portal_user" );
    					if ( mysqli_num_rows($selectDataTemp_Docs_Portal_User) > 0 ) {
    						$rowDataTemp_Docs_Portal_User = mysqli_fetch_array($selectDataTemp_Docs_Portal_User);
    						$portal_user_name = $rowDataTemp_Docs_Portal_User['first_name'] .' '. $rowDataTemp_Docs_Portal_User['last_name'];
    					}

    					$to = $email;
    					$user = $name;
    					$subject = 'Supplier Approval Program Updated!';
    					$body = 'Hi '.$user.',<br><br>

    					Here are some updates on tasks you\'re a collaborator on:
    					<ul>';

    					$has_changes = 0;
    					$mail_sent = 0;
    					$temp_document_output = json_decode($temp_document, true);
    					foreach ($temp_document_output as $key => $key_value) {
    						$doc_ID = $key_value['doc_ID'];
    						$doc_file = $key_value['doc_file'];
    						$doc_reviewedby = $key_value['doc_reviewedby'];
    						$doc_approvedby = $key_value['doc_approvedby'];

    						$selectDataTemp_Docs = mysqli_query( $conn,"SELECT * FROM tbl_supplier_document WHERE ID = $doc_ID" );
    						if ( mysqli_num_rows($selectDataTemp_Docs) > 0 ) {
    							$rowDataTemp_Docs = mysqli_fetch_array($selectDataTemp_Docs);
    							$user_change_name = $rowDataTemp_Docs['name'];
    							if ($rowDataTemp_Docs['type'] == 0) {
    								$selectDataTemp_DocsReqName = mysqli_query( $conn,"SELECT * FROM tbl_supplier_requirement WHERE ID = $user_change_name" );
    								if ( mysqli_num_rows($selectDataTemp_DocsReqName) > 0 ) {
    									$rowDataTemp_DocsReqName = mysqli_fetch_array($selectDataTemp_DocsReqName);
    									$user_change_name = $rowDataTemp_DocsReqName['name'];
    								}
    							}

    							$user_change_file = $rowDataTemp_Docs['file'];
    							$user_change_filename = $rowDataTemp_Docs['filename'];
    							$user_change_reviewed_by = $rowDataTemp_Docs['reviewed_by'];
    							$user_change_approved_by = $rowDataTemp_Docs['approved_by'];

    							if (!empty($user_change_file) AND $user_change_file != $doc_file) {
    								$body .= '<li>'.$user_change_name.' was Complied by '.$portal_user_name.'</li>';
    								$has_changes++;
    							}
    							if ($user_change_reviewed_by > 0 AND $user_change_reviewed_by != $doc_reviewedby) {
    								$selectDataTemp_Docs_Reviewed = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $user_change_reviewed_by" );
    								if ( mysqli_num_rows($selectDataTemp_Docs_Reviewed) > 0 ) {
    									$rowDataTemp_Docs_Reviewed = mysqli_fetch_array($selectDataTemp_Docs_Reviewed);
    									$reviewed_user_name = $rowDataTemp_Docs_Reviewed['first_name'] .' '. $rowDataTemp_Docs_Reviewed['last_name'];

    									$body .= '<li>'.$user_change_name.' was Reviewed by '.$reviewed_user_name.'</li>';
    									$has_changes++;
    								}
    							}
    							if ($user_change_approved_by > 0 AND $user_change_approved_by != $doc_approvedby) {
    								$selectDataTemp_Docs_Approved = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $user_change_approved_by" );
    								if ( mysqli_num_rows($selectDataTemp_Docs_Approved) > 0 ) {
    									$rowDataTemp_Docs_Approved = mysqli_fetch_array($selectDataTemp_Docs_Approved);
    									$approved_user_name = $rowDataTemp_Docs_Approved['first_name'] .' '. $rowDataTemp_Docs_Approved['last_name'];

    									$body .= '<li>'.$user_change_name.' was Reviewed by '.$approved_user_name.'</li>';
    									$has_changes++;
    								}
    							}
    						}
    					}

    					$body .= '</ul>
    					Should you need assistance, kindly call 202-982-3002 or email '.$data_email.'<br><br>

    					InterlinkIQ.com Team<br>
    					Consultare Inc.';

    					if ($has_changes > 0) { php_mailer_1($to, $user, $subject, $body, $data_email, $data_company); $mail_sent++; }

    	    			// Adding SAP Requirements
    	    			if (!empty($requirement_email)) {
    						$to = $email;
    						$user = $name;
    						$subject = 'Supplier Approval Requirements!';
    						$body = 'Hi '.$user.' Food Safety Team,<br><br>';

    						if ($user_id == 254) {
    							$body .= 'We are working with Jensen Meat Company (JMC) as part of their Supplier Approval Program (SAP). The '.$user.' has been identified as a Supplier/Service Provider of Jensen Meat Company  Plant Based.<br><br>';
    						} else {
    							$body .= 'We are working with '.$data_company.' as part of their Supplier Approval Program (SAP). Your company has been identified as a Supplier/Service Provider of '.$data_company.'.<br><br>';
    						}

    						$body .= 'We are requesting certain documents from your firm to comply with the SAP 21 CFR 117 Subpart G - Supply-Chain Program';

    						if ($_POST['countries'] != 'US') { $body .= ' / FSVP 21 CFR Subpart L - Foreign Supplier Verification Programs for Food Importers requirement'; }

    						$body .= '.<br><ol>';

    						$requirement_arr = explode(" | ", $requirement_email);
    	                	foreach ($requirement_arr as $value) {
    	                		$body .= '<li>'.$value.'</li>';
    	                	}

    						$body .= '</ol>

    						Follow the instructions below:<br><br>

    						To update Compliance:<br>
    						<ol>
    							<li>Go to <a href="'.$base_url.'" target="_blank">https://interlinkiq.com/</a> and click Log in. Enter your Username and Password.</li>
    							<li>Once successfully logged in, click the Enterprise Module.</li>
    							<li>Click Customer Module to view the list of your Customer.</li>
    							<li>Click View and go to Requirements Tab; comply by uploading the documents required in the list.</li>
    						</ol>

    						Kindly see the link below for our Customer Management Tutorial Video<br><br>

    						<table style="width: 100%; border-collapse: collapse;">
    							<tr>
    								<td style="border: 1px solid; padding: 5px; text-align: center;"><b>Tutorial Video</b></td>
    								<td style="border: 1px solid; padding: 5px; text-align: center;"><b>Video Link</b></td>
    							</tr>
    							<tr>
    								<td style="border: 1px solid; padding: 5px;">Free Access - Enterprise Management Module</td>
    								<td style="border: 1px solid; padding: 5px;">https://www.youtube.com/watch?v=pyhPjZKTlaE</td>
    							</tr>
    							<tr>
    								<td style="border: 1px solid; padding: 5px;">Free Access - Customer Requirements Management Module</td>
    								<td style="border: 1px solid; padding: 5px;">https://youtu.be/9XklXwGBr7E</td>
    							</tr>
    						</table><br><br>

    						Should you need assistance, kindly call 202-982-3002 or email '.$data_email.'<br><br>

    						InterlinkIQ.com Team<br><br>
    						Consultare Inc.';

    						if ($mail_sent > 0) {
    							php_mailer_2($to, $user, $subject, $body, $data_email, $data_company);
    							$mail_sent++;
    						} else {
    							php_mailer_1($to, $user, $subject, $body, $data_email, $data_company);
    							$mail_sent++;
    						}
    	    			}
    	    
    	                // Contact Section
    	                $data_contact = $rowData['contact'];
    	                if (!empty($data_contact)) {
    	                	$data_contact_arr = explode(", ", $data_contact);
    	                	foreach ($data_contact_arr as $value) {
    	                	    $selectContact = mysqli_query( $conn,"SELECT * FROM tbl_supplier_contact WHERE notification = 1 AND ID = $value" );
    	                	    if ( mysqli_num_rows($selectContact) > 0 ) {
    	                	    	while($rowContact = mysqli_fetch_array($selectContact)) {
    	                	            $contact_name = $rowContact["name"];
    	                	            $contact_email = $rowContact["email"];

    					    			$to = $contact_email;
    									$user = $contact_name;
    									$subject = 'Supplier Approval Program Updated!';
    									$body = 'Hi '.$user.',<br><br>

    									Here are some updates on tasks you\'re a collaborator on:
    									<ul>';

    									$has_changes = 0;
    									$temp_document_output = json_decode($temp_document, true);
    									foreach ($temp_document_output as $key => $key_value) {
    										$doc_ID = $key_value['doc_ID'];
    										$doc_file = $key_value['doc_file'];
    										$doc_reviewedby = $key_value['doc_reviewedby'];
    										$doc_approvedby = $key_value['doc_approvedby'];

    										$selectDataTemp_Docs = mysqli_query( $conn,"SELECT * FROM tbl_supplier_document WHERE ID = $doc_ID" );
    										if ( mysqli_num_rows($selectDataTemp_Docs) > 0 ) {
    											$rowDataTemp_Docs = mysqli_fetch_array($selectDataTemp_Docs);
    											$user_change_name = $rowDataTemp_Docs['name'];
    											if ($rowDataTemp_Docs['type'] == 0) {
    												$selectDataTemp_DocsReqName = mysqli_query( $conn,"SELECT * FROM tbl_supplier_requirement WHERE ID = $user_change_name" );
    												if ( mysqli_num_rows($selectDataTemp_DocsReqName) > 0 ) {
    													$rowDataTemp_DocsReqName = mysqli_fetch_array($selectDataTemp_DocsReqName);
    													$user_change_name = $rowDataTemp_DocsReqName['name'];
    												}
    											}

    											$user_change_file = $rowDataTemp_Docs['file'];
    											$user_change_filename = $rowDataTemp_Docs['filename'];
    											$user_change_reviewed_by = $rowDataTemp_Docs['reviewed_by'];
    											$user_change_approved_by = $rowDataTemp_Docs['approved_by'];

    											if (!empty($user_change_file) AND $user_change_file != $doc_file) {
    												$body .= '<li>'.$user_change_name.' was Complied by '.$portal_user_name.'</li>';
    												$has_changes++;
    											}
    											if ($user_change_reviewed_by > 0 AND $user_change_reviewed_by != $doc_reviewedby) {
    												$selectDataTemp_Docs_Reviewed = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $user_change_reviewed_by" );
    												if ( mysqli_num_rows($selectDataTemp_Docs_Reviewed) > 0 ) {
    													$rowDataTemp_Docs_Reviewed = mysqli_fetch_array($selectDataTemp_Docs_Reviewed);
    													$reviewed_user_name = $rowDataTemp_Docs_Reviewed['first_name'] .' '. $rowDataTemp_Docs_Reviewed['last_name'];

    													$body .= '<li>'.$user_change_name.' was Reviewed by '.$reviewed_user_name.'</li>';
    													$has_changes++;
    												}
    											}
    											if ($user_change_approved_by > 0 AND $user_change_approved_by != $doc_approvedby) {
    												$selectDataTemp_Docs_Approved = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $user_change_approved_by" );
    												if ( mysqli_num_rows($selectDataTemp_Docs_Approved) > 0 ) {
    													$rowDataTemp_Docs_Approved = mysqli_fetch_array($selectDataTemp_Docs_Approved);
    													$approved_user_name = $rowDataTemp_Docs_Approved['first_name'] .' '. $rowDataTemp_Docs_Approved['last_name'];

    													$body .= '<li>'.$user_change_name.' was Reviewed by '.$approved_user_name.'</li>';
    													$has_changes++;
    												}
    											}
    										}
    									}

    									$body .= '</ul>
    									Should you need assistance, kindly call 202-982-3002 or email '.$data_email.'<br><br>

    									InterlinkIQ.com Team<br>
    									Consultare Inc.';

    									if ($has_changes > 0) {
    										if ($mail_sent > 0) {
    											php_mailer_2($to, $user, $subject, $body, $data_email, $data_company);
    											$mail_sent++;
    										} else {
    											php_mailer_1($to, $user, $subject, $body, $data_email, $data_company);
    											$mail_sent++;
    										}
    									}



    					    			// Adding SAP Requirements
    					    			if (!empty($requirement_email)) {
    										$to = $contact_email;
    										$user = $contact_name;
    										$subject = 'Supplier Approval Requirements!';
    										$body = 'Hi '.$user.' Food Safety Team,<br><br>';

    										if ($user_id == 254) {
    											$body .= 'We are working with Jensen Meat Company (JMC) as part of their Supplier Approval Program (SAP). The '.$user.' has been identified as a Supplier/Service Provider of Jensen Meat Company  Plant Based.<br><br>';
    										} else {
    											$body .= 'We are working with '.$data_company.' as part of their Supplier Approval Program (SAP). Your company has been identified as a Supplier/Service Provider of '.$data_company.'.<br><br>';
    										}

    										$body .= 'We are requesting certain documents from your firm to comply with the SAP 21 CFR 117 Subpart G - Supply-Chain Program';

    										if ($_POST['countries'] != 'US') { $body .= ' / FSVP 21 CFR Subpart L - Foreign Supplier Verification Programs for Food Importers requirement'; }

    										$body .= '.<br><ol>';

    										$requirement_arr = explode(" | ", $requirement_email);
    					                	foreach ($requirement_arr as $value) {
    					                		$body .= '<li>'.$value.'</li>';
    					                	}

    										$body .= '</ol>

    										Follow the instructions below:<br><br>

    										To update Compliance:<br>
    										<ol>
    											<li>Go to <a href="'.$base_url.'" target="_blank">https://interlinkiq.com/</a> and click Log in. Enter your Username and Password.</li>
    											<li>Once successfully logged in, click the Enterprise Module.</li>
    											<li>Click Customer Module to view the list of your Customer.</li>
    											<li>Click View and go to Requirements Tab; comply by uploading the documents required in the list.</li>
    										</ol>

    										Kindly see the link below for our Customer Management Tutorial Video<br><br>

    										<table style="width: 100%; border-collapse: collapse;">
    											<tr>
    												<td style="border: 1px solid; padding: 5px; text-align: center;"><b>Tutorial Video</b></td>
    												<td style="border: 1px solid; padding: 5px; text-align: center;"><b>Video Link</b></td>
    											</tr>
    											<tr>
    												<td style="border: 1px solid; padding: 5px;">Free Access - Enterprise Management Module</td>
    												<td style="border: 1px solid; padding: 5px;">https://www.youtube.com/watch?v=pyhPjZKTlaE</td>
    											</tr>
    											<tr>
    												<td style="border: 1px solid; padding: 5px;">Free Access - Customer Requirements Management Module</td>
    												<td style="border: 1px solid; padding: 5px;">https://youtu.be/9XklXwGBr7E</td>
    											</tr>
    										</table><br><br>

    										Should you need assistance, kindly call 202-982-3002 or email '.$data_email.'<br><br>

    										InterlinkIQ.com Team<br><br>
    										Consultare Inc.';

    										if ($mail_sent > 0) {
    											php_mailer_2($to, $user, $subject, $body, $data_email, $data_company);
    											$mail_sent++;
    										} else {
    											php_mailer_1($to, $user, $subject, $body, $data_email, $data_company);
    											$mail_sent++;
    										}
    					    			}
    	                	    	}
    	                	    }
    	                	}
    	                }
                    }
    				
    				echo json_encode($result);
    			}
    		}

    		mysqli_close($conn);
    	}
    }


	// Product Section
	if( isset($_GET['modalNew_Customer_Product']) ) {
		$id = $_GET['modalNew_Customer_Product'];
		$modal = $_GET['m'];

		echo '<input class="form-control" type="hidden" name="ID" value="'.$id.'" />
		<input class="form-control" type="hidden" name="modal" value="'.$modal.'" />
        <div class="row">
        	<div class="col-md-12">
                <div class="form-group">
                    <label class="control-label">Select Product</label>
                    <select class="form-control" name="product_id" required>';

						$selectProduct = mysqli_query( $conn,"SELECT * FROM tbl_products WHERE deleted = 0 AND user_id = $id" );
					    if ( mysqli_num_rows($selectProduct) > 0 ) {
	                    	while($rowProduct = mysqli_fetch_array($selectProduct)) {
					            $data_id = $rowProduct['ID'];
					            $data_name = $rowProduct['name'];

					            echo '<option value="'.$data_id.'">'.$data_name.'</option>';
					        }
		    			} else {
		    				echo '<option value="">No Available</option>';
		    			}

                    echo '</select>
                    <i class="text-muted">(Product not listed? Click here to <a href="'.$base_url.'products" target="_blank">add more</a>)</i>
                </div>
            </div>
            <div class="col-md-12">
                <div class="form-group">
                    <label class="control-label">Comments / Notes</label>
                    <textarea class="form-control" name="material_notes"></textarea>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label class="control-label">Specification</label>
                    <input class="form-control" type="file" name="material_spec_file" />
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label class="control-label">Documentation Dates</label>
                    <div class="input-group">
	                    <input type="text" class="form-control daterange daterange_empty" name="material_spec_daterange" value="" />
	                    <span class="input-group-btn">
	                        <button class="btn default date-range-toggle" type="button" onclick="widget_date_clears(this)">
	                            <i class="fa fa-close"></i>
	                        </button>
	                    </span>
	                </div>
                    <div class="input-group input-large date-picker input-daterange hide">
                        <input type="date" class="form-control" name="material_spec_date_from" />
                        <span class="input-group-addon"> to </span>
                        <input type="date" class="form-control" name="material_spec_date_to" />
                    </div>
                </div>
            </div>
        </div>
        <div class="mt-repeater">
            <div data-repeater-list="material_other">
                <div class="mt-repeater-item row" data-repeater-item>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label class="control-label">File Name</label>
                            <input class="form-control" type="text" name="material_file_name" />
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label class="control-label">File Document</label>
                            <input class="form-control" type="file" name="material_file_doc" />
                        </div>
                    </div>
                    <div class="col-md-5">
                        <div class="form-group">
                            <label class="control-label">Documentation Dates</label>
		                    <div class="input-group">
			                    <input type="text" class="form-control daterange daterange_empty" name="material_file_daterange" value="" />
			                    <span class="input-group-btn">
			                        <button class="btn default date-range-toggle" type="button" onclick="widget_date_clears(this)">
			                            <i class="fa fa-close"></i>
			                        </button>
			                    </span>
			                </div>
                            <div class="input-group input-large date-picker input-daterange hide">
                                <input type="date" class="form-control" name="material_file_from" />
                                <span class="input-group-addon"> to </span>
                                <input type="date" class="form-control" name="material_file_to" />
                            </div>
                        </div>
                    </div>
                    <div class="col-md-1">
                        <label style="visibility: hidden; display: block;">Remove</label>
                        <a href="javascript:;" data-repeater-delete class="btn btn-danger"><i class="fa fa-close"></i></a>
                    </div>
                </div>
            </div>
            <a href="javascript:;" data-repeater-create class="btn btn-success mt-repeater-add"><i class="fa fa-plus"></i> Add new file</a>
        </div>';
    }
	if( isset($_GET['modalView_Customer_Product']) ) {
		$id = $_GET['modalView_Customer_Product'];
		$modal = $_GET['m'];

		$selectData = mysqli_query( $conn,"SELECT * from tbl_supplier_material WHERE ID = $id" );
        $row = mysqli_fetch_array($selectData);
        $data_user_id = $row['user_id'];
        $data_material_name = $row['material_name'];

        $spec_file = $row['spec_file'];
	    $src = 'https://view.officeapps.live.com/op/embed.aspx?src=';
	    $embed = '&embedded=true';
	    $type = 'iframe';

        $spec_file = $row['spec_file'];
        $fileExtension = fileExtension($spec_file);
		$src = $fileExtension['src'];
		$embed = $fileExtension['embed'];
		$type = $fileExtension['type'];
		$file_extension = $fileExtension['file_extension'];
	    $url = $base_url.'uploads/supplier/';

        $spec_date_from = $row['spec_date_from'];
		if (!empty($spec_date_from)) {
	        $spec_date_from = new DateTime($spec_date_from);
	        $spec_date_from = $spec_date_from->format('m/d/Y');
		}

        $spec_date_to = $row['spec_date_to'];
		if (!empty($spec_date_to)) {
	        $spec_date_to = new DateTime($spec_date_to);
	        $spec_date_to = $spec_date_to->format('m/d/Y');
		}

	    if (!empty($spec_file)) {
        	$extension = pathinfo($spec_file, PATHINFO_EXTENSION);
		    if ($extension == "pdf") { $src = ''; $embed = ''; $type = ''; $file_extension = "fa-file-pdf-o"; }
		    else if (strtolower($extension) == "doc" OR strtolower($extension) == "docx") { $file_extension = "fa-file-word-o"; }
		    else if (strtolower($extension) == "ppt" OR strtolower($extension) == "pptx") { $file_extension = "fa-file-powerpoint-o"; }
		    else if (strtolower($extension) == "xls" OR strtolower($extension) == "xlsb" OR strtolower($extension) == "xlsm" OR strtolower($extension) == "xlsx" OR strtolower($extension) == "csv" OR strtolower($extension) == "xlsx") { $file_extension = "fa-file-excel-o"; }
		    else if (strtolower($extension) == "gif" OR strtolower($extension) == "jpg"  OR strtolower($extension) == "jpeg" OR strtolower($extension) == "png" OR strtolower($extension) == "ico") { $src = ''; $embed = ''; $type = ''; $file_extension = "fa-file-image-o"; }
		    else if (strtolower($extension) == "mp4" OR strtolower($extension) == "mov"  OR strtolower($extension) == "wmv" OR strtolower($extension) == "flv" OR strtolower($extension) == "avi" OR strtolower($extension) == "avchd" OR strtolower($extension) == "webm" OR strtolower($extension) == "mkv") { $src = ''; $embed = ''; $type = ''; $file_extension = "fa-file-video-o"; }
		    else { $src = ''; $embed = ''; $type = ''; $file_extension = "fa-file-code-o"; }
		}
	    $url = $base_url.'uploads/supplier/';
        
        echo '<input class="form-control" type="hidden" name="ID" value="'.$id.'" />
		<input class="form-control" type="hidden" name="modal" value="'.$modal.'" />
		<div class="row">
        	<div class="col-md-12">
                <div class="form-group">
                    <label class="control-label">Select Product</label>
                    <select class="form-control" name="product_id" required>';

						$selectProduct = mysqli_query( $conn,"SELECT * FROM tbl_products WHERE deleted = 0 AND user_id = $data_user_id" );
					    if ( mysqli_num_rows($selectProduct) > 0 ) {
	                    	while($rowProduct = mysqli_fetch_array($selectProduct)) {
					            $data_id = $rowProduct['ID'];
					            $data_name = $rowProduct['name'];

					            echo '<option value="'.$data_id.'" '; echo $data_material_name == $data_id ? 'SELECTED':''; echo '>'.$data_name.'</option>';
					        }
		    			} else {
		    				echo '<option value="">No Available</option>';
		    			}

                    echo '</select>
                    <i class="text-muted">(Product not listed? Click here to <a href="'.$base_url.'products" target="_blank">add more</a>)</i>
                </div>
            </div>
            <div class="col-md-12">
                <div class="form-group">
                    <label class="control-label">Comments / Notes</label>
                    <textarea class="form-control" name="material_notes">'.$row['notes'].'</textarea>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <input type="hidden" name="material_spec_file_temp" value="'.$spec_file.'" />
                    <label class="control-label">Specification</label>
                    <input class="form-control '; echo !empty($spec_file) ? 'hide':''; echo '" type="file" name="material_spec_file" />
                    <p class="'; echo !empty($spec_file) ? '':'hide'; echo '" style="margin: 0;"><a href="'.$src.$url.rawurlencode($spec_file).$embed.'" data-src="'.$src.$url.rawurlencode($spec_file).$embed.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a> | <button type="button" class="btn btn-link uploadNew" onclick="uploadNewOld(this)">Upload New</button></p>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label class="control-label">Documentation Dates</label>
                    <div class="input-group">
	                    <input type="text" class="form-control daterange '; if (empty($spec_date_from) || empty($spec_date_to)) { echo 'daterange_empty'; } echo '" name="material_spec_daterange" value="'; if (!empty($spec_date_from) && !empty($spec_date_to)) { echo $spec_date_from .' - '. $spec_date_to; } echo '" />
	                    <span class="input-group-btn">
	                        <button class="btn default date-range-toggle" type="button" onclick="widget_date_clears(this)">
	                            <i class="fa fa-close"></i>
	                        </button>
	                    </span>
	                </div>
                    <div class="input-group input-large date-picker input-daterange hide">
                        <input type="date" class="form-control" name="material_spec_date_from" value="'.$spec_date_from.'" />
                        <span class="input-group-addon"> to </span>
                        <input type="date" class="form-control" name="material_spec_date_to" value="'.$spec_date_to.'" />
                    </div>
                </div>
            </div>
        </div>
        <div class="mt-repeater">
            <div data-repeater-list="material_other">';

            	$other = $row['other'];
            	$other_arr = json_decode($other,true);
                $other_count = count($other_arr);
            	if (!empty($other)) {
            		foreach ($other_arr as $key => $value) {
                        $name = $value['name'];
                        $material_file_doc = $value['material_file_doc'];

                        $from = $value['from'];
						if (!empty($from)) {
					        $from = new DateTime($from);
					        $from = $from->format('m/d/Y');
						}
						
                        $to = $value['to'];
						if (!empty($to)) {
					        $to = new DateTime($to);
					        $to = $to->format('m/d/Y');
						}

                        $fileExtension = fileExtension($material_file_doc);
						$src = $fileExtension['src'];
						$embed = $fileExtension['embed'];
						$type = $fileExtension['type'];
						$file_extension = $fileExtension['file_extension'];
                        $url = $base_url.'uploads/supplier/';

                        echo '<div class="mt-repeater-item row" data-repeater-item>
		                    <div class="col-md-3">
		                        <div class="form-group">
		                            <label class="control-label">File Name</label>
		                            <input class="form-control" type="text" name="material_file_name" value="'.$name.'" />
		                        </div>
		                    </div>
		                    <div class="col-md-3">
                                <div class="form-group">
                                    <input type="hidden" name="material_file_doc_temp" value="'.$material_file_doc.'" />
                                    <label class="control-label">File Document</label>
                                    <input class="form-control '; echo !empty($material_file_doc) ? 'hide':''; echo '" type="file" name="material_file_doc" />
                                    <p class="'; echo !empty($material_file_doc) ? '':'hide'; echo '" style="margin: 0;"><a href="'.$src.$url.rawurlencode($material_file_doc).$embed.'" data-src="'.$src.$url.rawurlencode($material_file_doc).$embed.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a> | <button type="button" class="btn btn-link uploadNew" onclick="uploadNewOld(this)">Upload New</button></p>
                                </div>
                            </div>
		                    <div class="col-md-5">
		                        <div class="form-group">
		                            <label class="control-label">Documentation Dates</label>
				                    <div class="input-group">
					                    <input type="text" class="form-control daterange '; if (empty($from) || empty($to)) { echo 'daterange_empty'; } echo '" name="material_file_daterange" value="'; if (!empty($from) && !empty($to)) { echo $from .' - '. $to; } echo '" />
					                    <span class="input-group-btn">
					                        <button class="btn default date-range-toggle" type="button" onclick="widget_date_clears(this)">
					                            <i class="fa fa-close"></i>
					                        </button>
					                    </span>
					                </div>
		                            <div class="input-group input-large date-picker input-daterange hide">
		                                <input type="date" class="form-control" name="material_file_from" value="'.$from.'" />
		                                <span class="input-group-addon"> to </span>
		                                <input type="date" class="form-control" name="material_file_to" value="'.$to.'" />
		                            </div>
		                        </div>
		                    </div>
		                    <div class="col-md-1">
		                        <label style="visibility: hidden; display: block;">Remove</label>
		                        <a href="javascript:;" data-repeater-delete class="btn btn-danger"><i class="fa fa-close"></i></a>
		                    </div>
		                </div>';
                    }
            	}
            echo '</div>
            <a href="javascript:;" data-repeater-create class="btn btn-success mt-repeater-add"><i class="fa fa-plus"></i> Add new file</a>
        </div>';
    }
	if( isset($_POST['btnSave_Customer_Product']) ) { 
		$ID = $_POST['ID'];
		$modal = $_POST['modal'];
		$path = 'uploads/supplier/';
		$random = rand(1000,1000000);
        $arr_item = array();
        $filesize = 0;
        $spec_filesize = 0;
        $spec_filesize_other = 0;
        $process = true;

		$product_id = $_POST['product_id'];
		$selectProduct = mysqli_query( $conn,"SELECT * FROM tbl_products WHERE ID = $product_id" );
		$rowProduct = mysqli_fetch_array($selectProduct);
		$product_name = addslashes($rowProduct['name']);
		$product_code = addslashes($rowProduct['code']);
		$product_description = addslashes($rowProduct['description']);
		$product_notes = addslashes($_POST['material_notes']);

		$material_spec_file = $_FILES['material_spec_file']['name'];
		$material_spec_file_final = "";
		if (!empty($material_spec_file)) {
            $spec_filesize = $_FILES['material_spec_file']['size'];
			$material_spec_file_tmp = $_FILES['material_spec_file']['tmp_name'];
            $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
            $ext = strtolower(pathinfo($material_spec_file, PATHINFO_EXTENSION));
			$material_spec_file_final = $random.' - '.$material_spec_file;
			$material_spec_file_path = $path.$material_spec_file_final;

            if(!in_array($ext, $invalid_extensions)) {
                move_uploaded_file($material_spec_file_tmp, $material_spec_file_path);

                $output = array (
                    'type' =>  0,
                    'name' =>  $material_spec_file_final,
                    'size' =>  $spec_filesize,
                    'date' =>  $local_date
                );
                array_push($arr_item, $output);
            } else {
                $process = false;
            }
		}
		// $material_spec_date_from = $_POST['material_spec_date_from'];
		// $material_spec_date_to = $_POST['material_spec_date_to'];

		$material_spec_date_from = '';
		$material_spec_date_to = '';
		$material_spec_daterange = $_POST["material_spec_daterange"];
		if (!empty($material_spec_daterange)) {
			$material_spec_daterange = explode(' - ', $material_spec_daterange);
			$material_spec_date_from = $material_spec_daterange[0];
			$material_spec_date_to = $material_spec_daterange[1];
		}

		$material_other_arr = array();
		for ($i=0; $i < count($_POST['material_other']); $i++) {
			$material_file_name = $_POST['material_other'][$i]['material_file_name'];

			// $material_file_from = $_POST['material_other'][$i]['material_file_from'];
			// $material_file_to = $_POST['material_other'][$i]['material_file_to'];

			$material_file_from = '';
			$material_file_to = '';
			$material_file_daterange = $_POST['material_other'][$i]['material_file_daterange'];
			if (!empty($material_file_daterange)) {
				$material_file_daterange = explode(' - ', $material_file_daterange);
				$material_file_from = $material_file_daterange[0];
				$material_file_to = $material_file_daterange[1];
			}

			$material_file_doc = $_FILES['material_other']['name'][$i];
			$material_file_doc_final = implode('*', $material_file_doc);

			if (!empty($material_file_doc_final)) {
				$spec_filesize_other = implode('*', $_FILES['material_other']['size'][$i]);
                $material_file_doc_tmp = implode('*', $_FILES['material_other']['tmp_name'][$i]);
                $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                $ext = strtolower(pathinfo($material_file_doc, PATHINFO_EXTENSION));
				$material_file_doc_final = $random.' - '.$material_file_doc_final;
				$material_file_doc_path = $path.$material_file_doc_final;

                if(!in_array($ext, $invalid_extensions)) {
                    move_uploaded_file($material_file_doc_tmp, $material_file_doc_path);

                    $filesize += $spec_filesize_other;

                    $output = array (
                        'type'  =>  0,
                        'name' =>  $material_file_doc_final,
                        'size' =>  $spec_filesize_other,
                        'date' =>  $local_date
                    );
                    array_push($arr_item, $output);
                } else {
                    $process = false;
                }
			}

			$material_other_data = array (
				'name' => $material_file_name,
				'material_file_doc' =>$material_file_doc_final,
				'from' =>$material_file_from,
				'to' =>$material_file_to
			);
			array_push( $material_other_arr, $material_other_data );
		}
		$material_other = json_encode($material_other_arr);
        $file_history = json_encode($arr_item, JSON_HEX_APOS | JSON_UNESCAPED_UNICODE);

        if ($process == true) {
    		$sql = "INSERT INTO tbl_supplier_material (user_id, material_name, material_id, description, notes, spec_file, spec_filesize, spec_date_from, spec_date_to, other, other_filesize, file_history)
    		VALUES ('$ID', '$product_id', '$product_code', '$product_description', '$product_notes', '$material_spec_file_final', '$spec_filesize', '$material_spec_date_from', '$material_spec_date_to', '$material_other', '$filesize', '$file_history')";
    		if (mysqli_query($conn, $sql)) {
    			$last_id = mysqli_insert_id($conn);
    		}

    		$output = array(
    			"ID" => $last_id,
    			"modal" => $modal,
    			"material_name" => $product_name,
    			"material_id" => $product_code,
    			"material_description" => $product_description
    		);
    		echo json_encode($output);
        }
	}
	if( isset($_POST['btnUpdate_Customer_Product']) ) { 
		$ID = $_POST['ID'];
		$modal = $_POST['modal'];
		$path = 'uploads/supplier/';
		$random = rand(1000,1000000);
        $arr_item = array();
        $filesize = 0;
        $spec_filesize = 0;
        $spec_filesize_other = 0;
        $process = true;

        $selectData = mysqli_query( $conn,"SELECT * FROM tbl_supplier_material WHERE ID = $ID");
        if ( mysqli_num_rows($selectData) > 0 ) {
            $rowData = mysqli_fetch_array($selectData);

            if (!empty($rowData['file_history'])) {
                $arr_item = json_decode($rowData["file_history"],true);
            }
        }

		$product_id = $_POST['product_id'];
		$selectProduct = mysqli_query( $conn,"SELECT * FROM tbl_products WHERE ID = $product_id" );
		$rowProduct = mysqli_fetch_array($selectProduct);
		$product_name = addslashes($rowProduct['name']);
		$product_code = addslashes($rowProduct['code']);
		$product_description = addslashes($rowProduct['description']);
		$product_notes = addslashes($_POST['material_notes']);

		$material_spec_file_final = $_POST['material_spec_file_temp'];
		$material_spec_file = $_FILES['material_spec_file']['name'];
		if (!empty($material_spec_file)) {
            $spec_filesize = $_FILES['material_spec_file']['size'];
			$material_spec_file_tmp = $_FILES['material_spec_file']['tmp_name'];
            $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
            $ext = strtolower(pathinfo($material_spec_file, PATHINFO_EXTENSION));
			$material_spec_file_final = $random.' - '.$material_spec_file;
			$material_spec_file_path = $path.$material_spec_file_final;

            if(!in_array($ext, $invalid_extensions)) {
                move_uploaded_file($material_spec_file_tmp, $material_spec_file_path);

                $output = array (
                    'type'  =>  0,
                    'name' =>  $material_spec_file_final,
                    'size' =>  $spec_filesize,
                    'date' =>  $local_date
                );
                array_push($arr_item, $output);
            } else {
                $process = false;
            }
		}
		// $material_spec_date_from = $_POST['material_spec_date_from'];
		// $material_spec_date_to = $_POST['material_spec_date_to'];

		$material_spec_date_from = '';
		$material_spec_date_to = '';
		$material_spec_daterange = $_POST["material_spec_daterange"];
		if (!empty($material_spec_daterange)) {
			$material_spec_daterange = explode(' - ', $material_spec_daterange);
			$material_spec_date_from = $material_spec_daterange[0];
			$material_spec_date_to = $material_spec_daterange[1];
		}

		$material_other_arr = array();
		for ($i=0; $i < count($_POST['material_other']); $i++) {
			$material_file_name = $_POST['material_other'][$i]['material_file_name'];

			// $material_file_from = $_POST['material_other'][$i]['material_file_from'];
			// $material_file_to = $_POST['material_other'][$i]['material_file_to'];

			$material_file_from = '';
			$material_file_to = '';
			$material_file_daterange = $_POST['material_other'][$i]['material_file_daterange'];
			if (!empty($material_file_daterange)) {
				$material_file_daterange = explode(' - ', $material_file_daterange);
				$material_file_from = $material_file_daterange[0];
				$material_file_to = $material_file_daterange[1];
			}

			$material_file_doc_final = $_POST['material_other'][$i]['material_file_doc_temp'];
			$material_file_doc = $_FILES['material_other']['name'][$i];
			$material_file_doc = implode('*', $material_file_doc);
			if (!empty($material_file_doc)) {
				$spec_filesize_other = implode('*', $_FILES['material_other']['size'][$i]);
                $material_file_doc_tmp = implode('*', $_FILES['material_other']['tmp_name'][$i]);
                $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                $ext = strtolower(pathinfo($material_file_doc, PATHINFO_EXTENSION));
				$material_file_doc_final = $random.' - '.$material_file_doc;
				$material_file_doc_path = $path.$material_file_doc_final;

                if(!in_array($ext, $invalid_extensions)) {
                    move_uploaded_file($material_file_doc_tmp, $material_file_doc_path);

                    $filesize += $spec_filesize_other;

                    $output = array (
                        'type'  =>  0,
                        'name' =>  $material_file_doc_final,
                        'size' =>  $spec_filesize_other,
                        'date' =>  $local_date
                    );
                    array_push($arr_item, $output);
                } else {
                    $process = false;
                }
			}

			$material_other_data = array (
				'name' => $material_file_name,
				'material_file_doc' =>$material_file_doc_final,
				'from' =>$material_file_from,
				'to' =>$material_file_to
			);
			array_push( $material_other_arr, $material_other_data );
		}
		$material_other = json_encode($material_other_arr);
        $file_history = json_encode($arr_item, JSON_HEX_APOS | JSON_UNESCAPED_UNICODE);

        if ($process == true) {
            mysqli_query( $conn,"UPDATE tbl_supplier_material set material_name='". $product_id ."', material_id='". $product_code ."', description='". $product_description ."', notes='". $product_notes ."', spec_file='". $material_spec_file_final ."', spec_filesize='". $spec_filesize ."', spec_date_from='". $material_spec_date_from ."', spec_date_to='". $material_spec_date_to ."', other='". $material_other ."', other_filesize='". $filesize ."', file_history='". $file_history ."' WHERE ID='". $ID ."'" );

    		$output = array(
    			"ID" => $ID,
    			"modal" => $modal,
    			"material_name" => $product_name,
    			"material_id" => $product_code,
    			"material_description" => $product_description
    		);
    		echo json_encode($output);
    	}
    }


	// Service Section
	if( isset($_GET['modalNew_Customer_Service']) ) {
		$id = $_GET['modalNew_Customer_Service'];
		$modal = $_GET['m'];

		echo '<input class="form-control" type="hidden" name="ID" value="'.$id.'" />
		<input class="form-control" type="hidden" name="modal" value="'.$modal.'" />
        <div class="row">
        	<div class="col-md-12">
                <div class="form-group">
                    <label class="control-label">Select Service</label>
                    <select class="form-control" name="service_id" required>';

						$selectService = mysqli_query( $conn,"SELECT * FROM tbl_service WHERE is_deleted = 0 AND user_id = $id" );
					    if ( mysqli_num_rows($selectService) > 0 ) {
	                    	while($rowService = mysqli_fetch_array($selectService)) {
					            $data_id = $rowService['ID'];
					            $data_category_id = $rowService['category_id'];
					            if ($data_category_id == "others") {
					            	$category = $rowService['category_other'];
					            } else {
					            	$selectServiceCategory = mysqli_query( $conn,"SELECT * FROM tbl_service_category WHERE id = $data_category_id" );
					            	$rowServiceCategory = mysqli_fetch_array($selectServiceCategory);
					            	$category = $rowServiceCategory['service_category'];
					            }

					            echo '<option value="'.$data_id.'">'.$category.'</option>';
					        }
		    			} else {
		    				echo '<option value="">No Available</option>';
		    			}

                    echo '</select>
                    <i class="text-muted">(Service not listed? Click here to <a href="'.$base_url.'services" target="_blank">add more</a>)</i>
                </div>
            </div>
            <div class="col-md-12">
                <div class="form-group">
                    <label class="control-label">Comments / Notes</label>
                    <textarea class="form-control" name="service_notes"></textarea>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label class="control-label">Specification</label>
                    <input class="form-control" type="file" name="service_spec_file" />
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label class="control-label">Documentation Dates</label>
                    <div class="input-group input-large date-picker input-daterange">
                        <input type="date" class="form-control" name="service_spec_date_from" />
                        <span class="input-group-addon"> to </span>
                        <input type="date" class="form-control" name="service_spec_date_to" />
                    </div>
                </div>
            </div>
        </div>
        <div class="mt-repeater">
            <div data-repeater-list="service_other">
                <div class="mt-repeater-item row" data-repeater-item>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label class="control-label">File Name</label>
                            <input class="form-control" type="text" name="service_file_name" />
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label class="control-label">File Document</label>
                            <input class="form-control" type="file" name="service_file_doc" />
                        </div>
                    </div>
                    <div class="col-md-5">
                        <div class="form-group">
                            <label class="control-label">Documentation Dates</label>
                            <div class="input-group input-large date-picker input-daterange">
                                <input type="date" class="form-control" name="service_file_from" />
                                <span class="input-group-addon"> to </span>
                                <input type="date" class="form-control" name="service_file_to" />
                            </div>
                        </div>
                    </div>
                    <div class="col-md-1">
                        <label style="visibility: hidden; display: block;">Remove</label>
                        <a href="javascript:;" data-repeater-delete class="btn btn-danger"><i class="fa fa-close"></i></a>
                    </div>
                </div>
            </div>
            <a href="javascript:;" data-repeater-create class="btn btn-success mt-repeater-add"><i class="fa fa-plus"></i> Add new file</a>
        </div>';
	}
	if( isset($_GET['modalView_Customer_Service']) ) {
		$id = $_GET['modalView_Customer_Service'];
		$modal = $_GET['m'];

		$selectData = mysqli_query( $conn,"SELECT * from tbl_supplier_service WHERE ID = $id" );
        $row = mysqli_fetch_array($selectData);
        $data_user_id = $row['user_id'];
        $data_service_name = $row['service_name'];


        $spec_file = $row['spec_file'];
        $fileExtension = fileExtension($spec_file);
		$src = $fileExtension['src'];
		$embed = $fileExtension['embed'];
		$type = $fileExtension['type'];
		$file_extension = $fileExtension['file_extension'];
	    $url = $base_url.'uploads/supplier/';
        
        echo '<input class="form-control" type="hidden" name="ID" value="'.$id.'" />
		<input class="form-control" type="hidden" name="modal" value="'.$modal.'" />
        <div class="row">
        	<div class="col-md-12">
                <div class="form-group">
                    <label class="control-label">Select Service</label>
                    <select class="form-control" name="service_id" required>';

						$selectService = mysqli_query( $conn,"SELECT * FROM tbl_service WHERE is_deleted = 0 AND user_id = $data_user_id" );
					    if ( mysqli_num_rows($selectService) > 0 ) {
	                    	while($rowService = mysqli_fetch_array($selectService)) {
					            $data_id = $rowService['ID'];
					            $data_category_id = $rowService['category_id'];
					            if ($data_category_id == "others") {
					            	$category = $rowService['category_other'];
					            } else {
					            	$selectServiceCategory = mysqli_query( $conn,"SELECT * FROM tbl_service_category WHERE id = $data_category_id" );
					            	$rowServiceCategory = mysqli_fetch_array($selectServiceCategory);
					            	$category = $rowServiceCategory['service_category'];
					            }

					            echo '<option value="'.$data_id.'" '; echo $data_service_name == $data_id ? 'SELECTED':''; echo '>'.$category.'</option>';
					        }
		    			} else {
		    				echo '<option value="">No Available</option>';
		    			}

                    echo '</select>
                    <i class="text-muted">(Service not listed? Click here to <a href="'.$base_url.'services" target="_blank">add more</a>)</i>
                </div>
            </div>
            <div class="col-md-12">
                <div class="form-group">
                    <label class="control-label">Comments / Notes</label>
                    <textarea class="form-control" name="service_notes">'.$row['notes'].'</textarea>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <input type="hidden" name="service_spec_file_tmp" value="'.$spec_file.'" />
                    <label class="control-label">Specification</label>
                    <input class="form-control '; echo !empty($spec_file) ? 'hide':''; echo '" type="file" name="service_spec_file" />
                    <p class="'; echo !empty($spec_file) ? '':'hide'; echo '" style="margin: 0;"><a href="'.$src.$url.rawurlencode($spec_file).$embed.'" data-src="'.$src.$url.rawurlencode($spec_file).$embed.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a> | <button type="button" class="btn btn-link uploadNew" onclick="uploadNewOld(this)">Upload New</button></p>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label class="control-label">Documentation Dates</label>
                    <div class="input-group input-large date-picker input-daterange">
                        <input type="date" class="form-control" name="service_spec_date_from" value="'.$row['spec_date_from'].'" />
                        <span class="input-group-addon"> to </span>
                        <input type="date" class="form-control" name="service_spec_date_to" value="'.$row['spec_date_to'].'" />
                    </div>
                </div>
            </div>
        </div>
        <div class="mt-repeater">
            <div data-repeater-list="service_other">';

            	$other = $row['other'];
            	$other_arr = json_decode($other,true);
                $other_count = count($other_arr);
            	if (!empty($other)) {
            		foreach ($other_arr as $key => $value) {
                        $name = $value['name'];
                        $service_file_doc = $value['service_file_doc'];
                        $from = $value['from'];
                        $to = $value['to'];

                        $fileExtension = fileExtension($extension);
                		$src = $fileExtension['src'];
                		$embed = $fileExtension['embed'];
                		$type = $fileExtension['type'];
                		$file_extension = $fileExtension['file_extension'];
                        $url = $base_url.'uploads/supplier/';

                        echo '<div class="mt-repeater-item row" data-repeater-item>
		                    <div class="col-md-3">
		                        <div class="form-group">
		                            <label class="control-label">File Name</label>
		                            <input class="form-control" type="text" name="service_file_name" value="'.$name.'" />
		                        </div>
		                    </div>
		                    <div class="col-md-3">
		                        <div class="form-group">
                                    <input type="hidden" name="service_file_doc_tmp" value="'.$service_file_doc.'" />
		                            <label class="control-label">File Document</label>
		                            <input class="form-control '; echo !empty($service_file_doc) ? 'hide':''; echo '" type="file" name="service_file_doc" />
                                    <p class="'; echo !empty($service_file_doc) ? '':'hide'; echo '" style="margin: 0;"><a href="'.$src.$url.rawurlencode($service_file_doc).$embed.'" data-src="'.$src.$url.rawurlencode($service_file_doc).$embed.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a> | <button type="button" class="btn btn-link uploadNew" onclick="uploadNewOld(this)">Upload New</button></p>
		                        </div>
		                    </div>
		                    <div class="col-md-5">
		                        <div class="form-group">
		                            <label class="control-label">Documentation Dates</label>
		                            <div class="input-group input-large date-picker input-daterange">
		                                <input type="date" class="form-control" name="service_file_from" value="'.$from.'" />
		                                <span class="input-group-addon"> to </span>
		                                <input type="date" class="form-control" name="service_file_to" value="'.$to.'" />
		                            </div>
		                        </div>
		                    </div>
		                    <div class="col-md-1">
		                        <label style="visibility: hidden; display: block;">Remove</label>
		                        <a href="javascript:;" data-repeater-delete class="btn btn-danger"><i class="fa fa-close"></i></a>
		                    </div>
		                </div>';
                    }
            	}
            echo '</div>
            <a href="javascript:;" data-repeater-create class="btn btn-success mt-repeater-add"><i class="fa fa-plus"></i> Add new file</a>
        </div>';
    }
	if( isset($_POST['btnSave_Customer_Service']) ) { 
		$ID = $_POST['ID'];
		$modal = $_POST['modal'];
		$path = 'uploads/supplier/';
		$random = rand(1000,1000000);
        $arr_item = array();
        $filesize = 0;
        $spec_filesize = 0;
        $spec_filesize_other = 0;
        $process = true;
		$service_id = $_POST['service_id'];

		$selectService = mysqli_query( $conn,"SELECT * FROM tbl_service WHERE ID = $service_id" );
		$rowService = mysqli_fetch_array($selectService);
		$service_notes = addslashes($_POST['service_notes']);
		$service_description = addslashes($rowService['description']);
        $data_category_id = $rowService['category_id'];
        $data_area_id = $rowService['area_id'];

        if ($data_category_id == "others") { $service_name = $rowService['category_other']; }
        else {
        	$selectServiceCategory = mysqli_query( $conn,"SELECT * FROM tbl_service_category WHERE id = $data_category_id" );
        	$rowServiceCategory = mysqli_fetch_array($selectServiceCategory);
        	$service_name = $rowServiceCategory['service_category'];
        }

        if ($data_area_id == "others") { $service_area = $rowService['area_other']; }
        else {
        	$selectServiceArea = mysqli_query( $conn,"SELECT * FROM tbl_service_area WHERE id = $data_area_id" );
        	$rowServiceArea = mysqli_fetch_array($selectServiceArea);
        	$service_area = $rowServiceArea['area_category'];
        }

		$service_spec_file = $_FILES['service_spec_file']['name'];
		$service_spec_file_final = "";
		if (!empty($service_spec_file)) {
            $spec_filesize = $_FILES['service_spec_file']['size'];
			$service_spec_file_tmp = $_FILES['service_spec_file']['tmp_name'];
			$service_spec_file_final = $random.' - '.$service_spec_file;
			$service_spec_file_path = $path.$service_spec_file_final;
			move_uploaded_file($service_spec_file_tmp, $service_spec_file_path);

            $output = array (
                'type'  =>  0,
                'name' =>  $service_spec_file_final,
                'size' =>  $spec_filesize,
                'date' =>  $local_date
            );
            array_push($arr_item, $output);
		}
		$service_spec_date_from = $_POST['service_spec_date_from'];
		$service_spec_date_to = $_POST['service_spec_date_to'];

		$service_other_arr = array();
		for ($i=0; $i < count($_POST['service_other']); $i++) {
			$service_file_name = $_POST['service_other'][$i]['service_file_name'];
			$service_file_from = $_POST['service_other'][$i]['service_file_from'];
			$service_file_to = $_POST['service_other'][$i]['service_file_to'];

			$service_file_doc = $_FILES['service_other']['name'][$i];
			$service_file_doc_final = implode('*', $service_file_doc);

			if (!empty($service_file_doc_final)) {
				$spec_filesize_other = implode('*', $_FILES['service_other']['size'][$i]);
                $service_file_doc_tmp = implode('*', $_FILES['service_other']['tmp_name'][$i]);
                $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                $ext = strtolower(pathinfo($service_file_doc_final, PATHINFO_EXTENSION));
				$service_file_doc_final = $random.' - '.$service_file_doc_final;
				$service_file_doc_path = $path.$service_file_doc_final;

                if(!in_array($ext, $invalid_extensions)) {
                    move_uploaded_file($service_file_doc_tmp, $service_file_doc_path);

                    $filesize += $spec_filesize_other;

                    $output = array (
                        'type'  =>  0,
                        'name' =>  $service_file_doc_final,
                        'size' =>  $spec_filesize_other,
                        'date' =>  $local_date
                    );
                    array_push($arr_item, $output);
                } else {
                    $process = false;
                }
			}

			$service_other_data = array (
				'name' => $service_file_name,
				'service_file_doc' =>$service_file_doc_final,
				'from' =>$service_file_from,
				'to' =>$service_file_to
			);
			array_push( $service_other_arr, $service_other_data );
		}
		$service_other = json_encode($service_other_arr);
        $file_history = json_encode($arr_item, JSON_HEX_APOS | JSON_UNESCAPED_UNICODE);

        if ($process == true) {
    		$sql = "INSERT INTO tbl_supplier_service (user_id, service_name, service_id, description, notes, spec_file, spec_date_from, spec_date_to, other)
    		VALUES ('$ID', '$data_category_id', '$data_area_id', '$service_description', '$service_notes', '$service_spec_file_final', '$service_spec_date_from', '$service_spec_date_to', '$service_other')";
    		if (mysqli_query($conn, $sql)) {
    			$last_id = mysqli_insert_id($conn);
    		}

    		$output = array(
    			"ID" => $last_id,
    			"modal" => $modal,
    			"service_name" => $service_name,
    			"service_id" => $service_area,
    			"service_description" => $service_description
    		);
    		echo json_encode($output);
    	}
    }
	if( isset($_POST['btnUpdate_Customer_Service']) ) { 
		$ID = $_POST['ID'];
		$modal = $_POST['modal'];
		$path = 'uploads/supplier/';
		$random = rand(1000,1000000);
        $arr_item = array();
        $filesize = 0;
        $spec_filesize = 0;
        $spec_filesize_other = 0;
        $process = true;
		$service_id = $_POST['service_id'];

        $selectData = mysqli_query( $conn,"SELECT * FROM tbl_supplier_service WHERE ID = $ID");
        if ( mysqli_num_rows($selectData) > 0 ) {
            $rowData = mysqli_fetch_array($selectData);

            if (!empty($rowData['file_history'])) {
                $arr_item = json_decode($rowData["file_history"],true);
            }
        }

		$selectService = mysqli_query( $conn,"SELECT * FROM tbl_service WHERE ID = $service_id" );
		$rowService = mysqli_fetch_array($selectService);
		$service_notes = addslashes($_POST['service_notes']);
		$service_description = addslashes($rowService['description']);
        $data_category_id = $rowService['category_id'];
        $data_area_id = $rowService['area_id'];

        if ($data_category_id == "others") { $service_name = $rowService['category_other']; }
        else {
        	$selectServiceCategory = mysqli_query( $conn,"SELECT * FROM tbl_service_category WHERE id = $data_category_id" );
        	$rowServiceCategory = mysqli_fetch_array($selectServiceCategory);
        	$service_name = $rowServiceCategory['service_category'];
        }

        if ($data_area_id == "others") { $service_area = $rowService['area_other']; }
        else {
        	$selectServiceArea = mysqli_query( $conn,"SELECT * FROM tbl_service_area WHERE id = $data_area_id" );
        	$rowServiceArea = mysqli_fetch_array($selectServiceArea);
        	$service_area = $rowServiceArea['area_category'];
        }

        $service_spec_file_final = $_POST['service_spec_file_tmp'];
		$service_spec_file = $_FILES['service_spec_file']['name'];
		if (!empty($service_spec_file)) {
            $spec_filesize = $_FILES['service_spec_file']['size'];
			$service_spec_file_tmp = $_FILES['service_spec_file']['tmp_name'];
            $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
            $ext = strtolower(pathinfo($service_spec_file, PATHINFO_EXTENSION));
			$service_spec_file_final = $random.' - '.$service_spec_file;
			$service_spec_file_path = $path.$service_spec_file_final;

            if(!in_array($ext, $invalid_extensions)) {
                move_uploaded_file($service_spec_file_tmp, $service_spec_file_path);

                $output = array (
                    'type'  =>  0,
                    'name' =>  $service_spec_file_final,
                    'size' =>  $spec_filesize,
                    'date' =>  $local_date
                );
                array_push($arr_item, $output);
            } else {
                $process = false;
            }
		}
		$service_spec_date_from = $_POST['service_spec_date_from'];
		$service_spec_date_to = $_POST['service_spec_date_to'];

		$service_other_arr = array();
		for ($i=0; $i < count($_POST['service_other']); $i++) {
			$service_file_name = $_POST['service_other'][$i]['service_file_name'];
			$service_file_from = $_POST['service_other'][$i]['service_file_from'];
			$service_file_to = $_POST['service_other'][$i]['service_file_to'];

            $service_file_doc_final = $_POST['service_other'][$i]['service_file_doc_tmp'];
            $service_file_doc = $_FILES['service_other']['name'][$i];
            $service_file_doc = implode('*', $service_file_doc);
			if (!empty($service_file_doc)) {
				$spec_filesize_other = implode('*', $_FILES['service_other']['size'][$i]);
                $service_file_doc_tmp = implode('*', $_FILES['service_other']['tmp_name'][$i]);
                $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                $ext = strtolower(pathinfo($service_file_doc, PATHINFO_EXTENSION));
				$service_file_doc_final = $random.' - '.$service_file_doc_final;
				$service_file_doc_path = $path.$service_file_doc_final;

                if(!in_array($ext, $invalid_extensions)) {
                    move_uploaded_file($service_file_doc_tmp, $service_file_doc_path);

                    $filesize += $spec_filesize_other;

                    $output = array (
                        'type'  =>  0,
                        'name' =>  $service_file_doc_final,
                        'size' =>  $spec_filesize_other,
                        'date' =>  $local_date
                    );
                    array_push($arr_item, $output);
                } else {
                    $process = false;
                }
			}

			$service_other_data = array (
				'name' => $service_file_name,
				'service_file_doc' =>$service_file_doc_final,
				'from' =>$service_file_from,
				'to' =>$service_file_to
			);
			array_push( $service_other_arr, $service_other_data );
		}
		$service_other = json_encode($service_other_arr);
        $file_history = json_encode($arr_item, JSON_HEX_APOS | JSON_UNESCAPED_UNICODE);

        if ($process == true) {
    		mysqli_query( $conn,"UPDATE tbl_supplier_service set service_name='". $service_id ."', service_id='". $data_area_id ."', description='". $service_description ."', notes='". $service_notes ."', spec_file='". $service_spec_file_final ."', spec_filesize='". $spec_filesize ."', spec_date_from='". $service_spec_date_from ."', spec_date_to='". $service_spec_date_to ."', other='". $service_other ."', other_filesize='". $filesize ."', file_history='". $file_history ."' WHERE ID='". $ID ."'" );

    		$output = array(
    			"ID" => $ID,
    			"modal" => $modal,
    			"service_name" => $service_name,
    			"service_id" => $service_id,
    			"service_description" => $service_description
    		);
    		echo json_encode($output);
    	}
    }


	// SUPPLIER PAGE
	if( isset($_GET['modalView_Supplier']) ) {
		$id = $_GET['modalView_Supplier'];
		$current_userID = $_COOKIE['ID'];
        $current_userEmployerID = employerID($current_userID);

        $current_client = 0;
        if (isset($_COOKIE['client'])) { $current_client = $_COOKIE['client']; }

		if (!empty($_COOKIE['switchAccount'])) {
			$portal_user = $_COOKIE['ID'];
			$user_id = $_COOKIE['switchAccount'];
		}
		else {
			$portal_user = $_COOKIE['ID'];
			$user_id = employerID($portal_user);
		}
		
    	$current_dateNow_o = date('Y/m/d');
        $current_dateNow = new DateTime($current_dateNow_o);
        $current_dateNow = $current_dateNow->format('M d, Y');

		$selectData = mysqli_query( $conn,"SELECT * FROM tbl_supplier WHERE ID = $id" );
		if ( mysqli_num_rows($selectData) > 0 ) {
            $row = mysqli_fetch_array($selectData);
            $user_account_id = $row["user_id"];
            $page = $row["page"];
            $category = $row["category"];
            $industry = $row["industry"];

            $address = $row["address"];
            $address_arr = explode(" | ", $address);
            if (COUNT($address_arr) < 5) {
                $address_arr = explode(", ", $address);
            }

            $document = '';
            $document_arr = array();
            if (!empty($row["document"])) {
                $document = $row["document"];
                $document_arr = explode(" | ", $document);
                if (count($document_arr) <= 1) {
                    $document_arr = explode(", ", $document);
                }
            }

            $document_other = '';
            $document_other_arr = array();
            if (!empty($row["document_other"])) {
                $document_other = $row["document_other"];
                $document_other_arr = explode(" | ", $document_other);
                if (count($document_other_arr) <= 1 ) {
                    $document_other_arr = explode(", ", $document_other);
                }
            }

            $regulatory = $row["regulatory"];
			$contact = $row["contact"];
			$material = $row["material"];
			$service = $row["service"];

            $audit_report = '';
            if (!empty($row["audit_report"])) {
                $audit_report = $row["audit_report"];
                $audit_report_arr = explode(" | ", $audit_report);
            }

            $audit_certificate = '';
            if (!empty($row["audit_certificate"])) {
                $audit_certificate = $row["audit_certificate"];
                $audit_certificate_arr = explode(" | ", $audit_certificate);
            }

            $audit_action = '';
            if (!empty($row["audit_action"])) {
                $audit_action = $row["audit_action"];
                $audit_action_arr = explode(" | ", $audit_action);
            }

            $audit = $row["audit"];
            $audit_score = $row["audit_score"];
            $reviewed_by = $row["reviewed_by"];
            $reviewed_date = $row["reviewed_date"];
            $reviewed_due = $row["reviewed_due"];

            $frequency = $row["frequency"];
            $frequency_custom = $row["frequency_custom"];
			$frequency_custom_arr = explode(" | ", $frequency_custom);

            if ($page == 2) {
            	$selectUser = mysqli_query( $conn,'SELECT * FROM tbl_user WHERE ID="'. $user_account_id .'" ORDER BY ID LIMIT 1' );
	            $rowUser = mysqli_fetch_array($selectUser);
	            $name = $rowUser['first_name'] .' '. $rowUser['last_name'];

	            $selectCategory = mysqli_query( $conn,"SELECT * FROM tbl_supplier_category WHERE ID = $category" );
                $rowCategory = mysqli_fetch_array($selectCategory);
                $enterprise_category = $rowCategory["name"];

                $selectIndustry = mysqli_query( $conn,"SELECT * FROM tbl_supplier_industry WHERE ID = $industry" );
	            $rowIndustry = mysqli_fetch_array($selectIndustry);
                $enterprise_industry = $rowIndustry["name"];

	            $enterprise_name = "";
	            $enterprise_bldg = "";
	            $enterprise_city = "";
	            $enterprise_state = "";
	            $enterprise_zip = "";
	            $enterprise_email = "";
	            $enterprise_phone = "";
	            $enterprise_fax = "";
	            $enterprise_website = "";

	            $selectEnterprise = mysqli_query( $conn,"SELECT * FROM tblEnterpiseDetails WHERE users_entities = $user_account_id" );
                if ( mysqli_num_rows($selectEnterprise) > 0 ) {
                    $rowEnterprise = mysqli_fetch_array($selectEnterprise);
                    $enterprise_name = $rowEnterprise["businessname"];
		            $enterprise_bldg = $rowEnterprise["Bldg"];
		            $enterprise_city = $rowEnterprise["city"];
		            $enterprise_state = $rowEnterprise["States"];
		            $enterprise_zip = $rowEnterprise["ZipCode"];

		            $enterprise_country = $rowEnterprise["country"];
		            $selectCountry = mysqli_query( $conn,"SELECT * FROM countries WHERE id = $enterprise_country" );
		            $rowCountry = mysqli_fetch_array($selectCountry);
		            $enterprise_country = $rowCountry["name"];

		            $enterprise_email = $rowEnterprise["businessemailAddress"];
		            $enterprise_phone = $rowEnterprise["businesstelephone"];
		            $enterprise_fax = $rowEnterprise["businessfax"];
		            $enterprise_website = $rowEnterprise["businesswebsite"];
                }
            }
        }

        echo '<input class="form-control" type="hidden" name="ID" value="'.$id.'" />
        <div class="tabbable tabbable-tabdrop">
            <ul class="nav nav-tabs">';

            	if ($page == 2) {
            		echo '<li class="active">
	                    <a href="#tabDocuments_2" data-toggle="tab">Requirements</a>
	                </li>
	                <li>
	                    <a href="#tabBasic_2" data-toggle="tab">Details</a>
	                </li>
	                <li>
	                    <a href="#tabContact_2" data-toggle="tab">Contacts</a>
	                </li>
	                <li class="tabMaterials '; echo $category == 3 ? 'hide':''; echo '">
	                    <a href="#tabMaterials_2" data-toggle="tab">Materials</a>
	                </li>
	                <li class="tabService '; echo $category == 3 ? '':'hide'; echo '">
	                    <a href="#tabService_2" data-toggle="tab">Services</a>
	                </li>
	                <li>
	                    <a href="#tabAuditReview_2" data-toggle="tab">Audit & Review</a>
	                </li>
	                <li class="hide">
	                    <a href="#tabFSVP_2" data-toggle="tab">FSVP</a>
	                </li>';
            	} else {
            		echo '<li class="active">
	                    <a href="#tabBasic_2" data-toggle="tab">Details</a>
	                </li>
	                <li>
	                    <a href="#tabContact_2" data-toggle="tab">Contacts</a>
	                </li>
	                <li>
	                    <a href="#tabDocuments_2" data-toggle="tab">Requirements</a>
	                </li>
	                <li class="tabMaterials '; echo $category == 3 ? 'hide':''; echo '">
	                    <a href="#tabMaterials_2" data-toggle="tab">Materials</a>
	                </li>
	                <li class="tabService '; echo $category == 3 ? '':'hide'; echo '">
	                    <a href="#tabService_2" data-toggle="tab">Services</a>
	                </li>
	                <li>
	                    <a href="#tabAuditReview_2" data-toggle="tab">Audit & Review</a>
	                </li>
	                <li class="hide">
	                    <a href="#tabFSVP_2" data-toggle="tab">FSVP</a>
	                </li>';
            	}

            echo '</ul>
            <div class="tab-content margin-top-20">
                <div class="tab-pane '; echo $page == 2 ? '':'active'; echo '" id="tabBasic_2">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="control-label">Supplier/Vendor Name</label>
                                <input class="form-control '; echo $page == 2 ? 'hide':''; echo '" type="text" name="supplier_name" value="'.$row["name"].'" required />';

                                if ($page == 2) { echo '<input class="form-control" type="text" value="'.$enterprise_name.'" readonly disabled />'; }
                                
                            echo '</div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="control-label">Vendor Code</label>
                                <input class="form-control" type="text" name="vendor_code" value="'.$row["vendor_code"].'" />';
                                
                            echo '</div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="control-label">Category</label>
                                <select class="form-control '; echo $page == 2 ? 'hide':''; echo '" name="supplier_category" onchange="changedCategory(this)">
                                    <option value="">Select</option>';
                                    
                                        $selectCategory = mysqli_query( $conn,"SELECT * FROM tbl_supplier_category WHERE deleted = 0 AND FIND_IN_SET($current_client, REPLACE(client, ' ', '')) ORDER BY name" );
                                        if ( mysqli_num_rows($selectCategory) > 0 ) {
                                            while($rowCategory = mysqli_fetch_array($selectCategory)) {
                                                echo '<option value="'.$rowCategory["ID"].'" '; echo $category == $rowCategory["ID"] ? 'SELECTED':''; echo'>'.$rowCategory["name"].'</option>';
                                            }
                                        }
                                    
                                echo '</select>';

                                if ($page == 2) { echo '<input class="form-control" type="text" value="'.$enterprise_category.'" readonly />'; }
                                
                            echo '</div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="control-label">Country</label>
                                <select class="form-control '; echo $page == 2 ? 'hide':''; echo '" name="supplier_countries" onchange="changeCountry(2, '.$id.')" required>
                                    <option value="US" '; echo  $address_arr[0] == "US" ? 'SELECTED':''; echo '>United States of America</option>';
                                    
                                    $selectCountry = mysqli_query( $conn,"SELECT * FROM countries WHERE iso2 <> 'US'" );
                                    while($rowCountry = mysqli_fetch_array($selectCountry)) {
                                        echo '<option value="'.$rowCountry["iso2"].'" '; echo  $address_arr[0] == $rowCountry["iso2"] ? 'SELECTED':''; echo '>'.$rowCountry["name"].'</option>';
                                    }

                                echo '</select>';

                                if ($page == 2) { echo '<input class="form-control" type="text" value="'.$enterprise_country.'" readonly />'; }

                            echo '</div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="control-label">Industry</label>
                                <select class="form-control '; echo $page == 2 ? 'hide':''; echo '" name="supplier_industry" onchange="changeIndustry(this.value, 2, '.$id.')">
                                    <option value="">Select</option>';

                                    $selectIndustry = mysqli_query( $conn,"SELECT * FROM tbl_supplier_industry WHERE deleted = 0 AND FIND_IN_SET($current_client, REPLACE(client, ' ', '')) ORDER BY name" );
                                    if ( mysqli_num_rows($selectIndustry) > 0 ) {
                                        while($rowIndustry = mysqli_fetch_array($selectIndustry)) {
                                            echo '<option value="'.$rowIndustry["ID"].'" '; echo $industry == $rowIndustry["ID"] ? 'SELECTED':''; echo'>'.$rowIndustry["name"].'</option>';
                                        }
                                    }

                                echo '</select>';

                                if ($page == 2) { echo '<input class="form-control" type="text" value="'.$enterprise_industry.'" readonly />'; }

                            echo '</div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="control-label">Bldg No./Street</label>
                                <input class="form-control '; echo $page == 2 ? 'hide':''; echo '" type="text" name="supplier_address_street" value="'. $address_arr[1] .'" required />';

                                if ($page == 2) { echo '<input class="form-control" type="text" value="'.$enterprise_bldg.'" readonly disabled />'; }
                                
                            echo '</div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="control-label">City</label>
                                <input class="form-control '; echo $page == 2 ? 'hide':''; echo '" type="text" name="supplier_address_city" value="'. $address_arr[2] .'" required />';

                                if ($page == 2) { echo '<input class="form-control" type="text" value="'.$enterprise_city.'" readonly disabled />'; }
                                
                            echo '</div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="control-label">State</label>
                                <input class="form-control '; echo $page == 2 ? 'hide':''; echo '" type="text" name="supplier_address_state" value="'. $address_arr[3] .'" required />';

                                if ($page == 2) { echo '<input class="form-control" type="text" value="'.$enterprise_state.'" readonly disabled />'; }
                                
                            echo '</div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="control-label">Zip Code</label>
                                <input class="form-control '; echo $page == 2 ? 'hide':''; echo '" type="text" name="supplier_address_code" value="'. $address_arr[4] .'" required />';

                                if ($page == 2) { echo '<input class="form-control" type="text" value="'.$enterprise_zip.'" readonly disabled />'; }
                                
                            echo '</div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="control-label">Email</label>
                                <div class="input-group '; echo $page == 2 ? 'hide':''; echo '">
                                    <input class="form-control" type="email" name="supplier_email" value="'.$row["email"].'" required />
                                    <span class="input-group-btn">
                                        <button class="btn purple-seance" type="button" onclick="btnSendInvite('.$id.')">Send Invite</button>
                                    </span>
                                </div>';

                                if ($page == 2) { echo '<input class="form-control" type="text" value="'.$enterprise_email.'" readonly disabled />'; }
                                
                            echo '</div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="control-label">Phone</label>
                                <input class="form-control '; echo $page == 2 ? 'hide':''; echo '" type="text" name="supplier_phone" value="'.$row["phone"].'" />';

                                if ($page == 2) { echo '<input class="form-control" type="text" value="'.$enterprise_phone.'" readonly disabled />'; }
                                
                            echo '</div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="control-label">Fax</label>
                                <input class="form-control '; echo $page == 2 ? 'hide':''; echo '" type="text" name="supplier_fax" value="'.$row["fax"].'" />';

                                if ($page == 2) { echo '<input class="form-control" type="text" value="'.$enterprise_fax.'" readonly disabled />'; }
                                
                            echo '</div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="control-label">Website</label>
                                <input class="form-control '; echo $page == 2 ? 'hide':''; echo '" type="text" name="supplier_website" value="'.$row["website"].'" />';

                                if ($page == 2) { echo '<input class="form-control" type="text" value="'.$enterprise_website.'" readonly disabled />'; }
                                
                            echo '</div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="control-label">Status</label>
                                <select class="form-control" name="supplier_status" '; echo $page == 1 ? '':'readonly'; echo '>
                                    <option value="0" '; echo $row["status"] == 0 ? 'SELECTED':''; echo '>Pending</option>
                                    <option value="1" '; echo $row["status"] == 1 ? 'SELECTED':'';  echo '>Approved</option>
                                    <option value="2" '; echo $row["status"] == 2 ? 'SELECTED':'';  echo '>Non-Approved</option>
                                    <option value="3" '; echo $row["status"] == 3 ? 'SELECTED':'';  echo '>Emergency Used Only / Spot Purchasing</option>
                                    <option value="4" '; echo $row["status"] == 4 ? 'SELECTED':'';  echo '>Do Not Use</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="control-label">Receive Notification?</label>
                                <select class="form-control" name="supplier_notification" '; echo $page == 1 ? '':'readonly'; echo '>
                                    <option value="0" '; echo $row["notification"] == 0 ? 'SELECTED':''; echo '>No</option>
                                    <option value="1" '; echo $row["notification"] == 1 ? 'SELECTED':''; echo '>Yes</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="control-label">Frequency</label>
                                <select class="form-control" name="supplier_frequency" onchange="changeFrequency(this.value)">
                                    <option value="1" '; echo $frequency == 1 ? 'SELECTED':''; echo '>Once Per Day</option>
                                    <option value="2" '; echo $frequency == 2 ? 'SELECTED':''; echo '>Once Per Week</option>
                                    <option value="3" '; echo $frequency == 3 ? 'SELECTED':''; echo '>On the 1st and 15th of the Month</option>
                                    <option value="4" '; echo $frequency == 4 ? 'SELECTED':''; echo '>Once Per Month</option>
                                    <option value="6" '; echo $frequency == 6 ? 'SELECTED':''; echo '>Once Per Two Months (Every Other Month)</option>
                                    <option value="7" '; echo $frequency == 7 ? 'SELECTED':''; echo '>Once Per Three Months (Quarterly)</option>
                                    <option value="8" '; echo $frequency == 8 ? 'SELECTED':''; echo '>Once Per Six Months (Bi-Annual)</option>
                                    <option value="5" '; echo $frequency == 5 ? 'SELECTED':''; echo '>Once Per Year</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="control-label">Organic Supplier?</label>
                                <select class="form-control" name="organic" onchange="changeCountry(2, '.$id.')" '; echo $page == 1 ? '':'readonly'; echo '>
                                    <option value="0" '; echo $row["organic"] == 0 ? 'SELECTED':''; echo '>No</option>
                                    <option value="1" '; echo $row["organic"] == 1 ? 'SELECTED':''; echo '>Yes</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-3 '; echo $user_id == 1211 ? '':'hide'; echo '">
                            <div class="form-group">
                                <label class="control-label">With NDA?</label>
                                <select class="form-control" name="nda" '; echo $page == 1 ? '':''; echo '>
                                    <option value="0" '; echo $row["nda"] == 0 ? 'SELECTED':''; echo '>No</option>
                                    <option value="1" '; echo $row["nda"] == 1 ? 'SELECTED':''; echo '>Yes</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3 bg-default '; echo $frequency == 0 ? '':'hide'; echo '">
                            <div class="form-group">
                                <label class="control-label">Minute</label>
                                <select class="form-control selectpicker" name="supplier_frequency_minute" data-live-search="true" data-size="8">
                                    <optgroup label="Common Settings">
                                        <option value="*" '; echo $frequency_custom_arr[0] == "*" ? 'SELECTED':''; echo '>Once Per Minute</option>
                                        <option value="*/2" '; echo $frequency_custom_arr[0] == "*/2" ? 'SELECTED':''; echo '>Once Per Two Minutes</option>
                                        <option value="*/5" '; echo $frequency_custom_arr[0] == "*/5" ? 'SELECTED':''; echo '>Once Per Five Minutes</option>
                                        <option value="*/10" '; echo $frequency_custom_arr[0] == "*/10" ? 'SELECTED':''; echo '>Once Per Ten Minutes</option>
                                        <option value="*/15" '; echo $frequency_custom_arr[0] == "*/15" ? 'SELECTED':''; echo '>Once Per Fifteen Minutes</option>
                                        <option value="0,30" '; echo $frequency_custom_arr[0] == "0,30" ? 'SELECTED':''; echo '>Once Per Thirty Minutes</option>
                                    </optgroup>
                                    <optgroup label="Minutes">
                                        <option value="0" '; echo $frequency_custom_arr[0] == 0 ? 'SELECTED':''; echo '>:00 (At the beginning of the hour)</option>';

                                            for ($i=1; $i < 60; $i++) { 
                                                echo '<option value="'.$i.'" '; echo $frequency_custom_arr[0] == $i ? 'SELECTED':''; echo '>:'.sprintf("%02d", $i).'</option>';
                                            }

                                    echo '</optgroup>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3 bg-default '; echo $frequency == 0 ? '':'hide'; echo '">
                            <div class="form-group">
                                <label class="control-label">Hour</label>
                                <select class="form-control selectpicker" name="supplier_frequency_hour" data-live-search="true" data-size="8">
                                    <optgroup label="Common Settings">
                                        <option value="*" '; echo $frequency_custom_arr[1] == "*" ? 'SELECTED':''; echo '>Every Hour</option>
                                        <option value="*/2" '; echo $frequency_custom_arr[1] == "*/2" ? 'SELECTED':''; echo '>Every Other Hour</option>
                                        <option value="*/3" '; echo $frequency_custom_arr[1] == "*/3" ? 'SELECTED':''; echo '>Every Third Hour</option>
                                        <option value="*/4" '; echo $frequency_custom_arr[1] == "*/4" ? 'SELECTED':''; echo '>Every Fourth Hour</option>
                                        <option value="*/6" '; echo $frequency_custom_arr[1] == "*/6" ? 'SELECTED':''; echo '>Every Sixth Hour</option>
                                        <option value="0,12" '; echo $frequency_custom_arr[1] == "0,12" ? 'SELECTED':''; echo '>Every Twelve Hours</option>
                                    </optgroup>
                                    <optgroup label="Hours">';

                                            for ($i=1; $i < 12; $i++) { 
                                                echo '<option value="'.$i.'" '; echo $frequency_custom_arr[1] == $i ? 'SELECTED':''; echo '>'.date("h:i A", strtotime($i.":00")).'</option>';
                                            }
                                            echo '<option value="12" '; echo $frequency_custom_arr[1] == 12 ? 'SELECTED':''; echo '>12:00 PM Noon</option>';
                                            for ($i=13; $i < 24; $i++) { 
                                                echo '<option value="'.$i.'" '; echo $frequency_custom_arr[1] == $i ? 'SELECTED':''; echo '>'.date("h:i A", strtotime($i.":00")).'</option>';
                                            }

                                        echo '<option value="24">12:00 AM Midnight</option>
                                    </optgroup>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3 bg-default '; echo $frequency == 0 ? '':'hide'; echo '">
                            <div class="form-group">
                                <label class="control-label">Day</label>
                                <select class="form-control selectpicker" name="supplier_frequency_day" data-live-search="true" data-size="8">
                                    <optgroup label="Common Settings">
                                        <option value="*" '; echo $frequency_custom_arr[2] == "*" ? 'SELECTED':''; echo '>Every Day</option>
                                        <option value="*/2" '; echo $frequency_custom_arr[2] == "*/2" ? 'SELECTED':''; echo '>Every Other Day</option>
                                        <option value="1,15" '; echo $frequency_custom_arr[2] == "1,15" ? 'SELECTED':''; echo '>On the 1st and 15th of the Month</option>
                                    </optgroup>
                                    <optgroup label="Days">';

                                            function addOrdinalNumberSuffix($num) {
                                                if (!in_array(($num % 100),array(11,12,13))){
                                                    switch ($num % 10) {
                                                        // Handle 1st, 2nd, 3rd
                                                        case 1:  return $num.'st';
                                                        case 2:  return $num.'nd';
                                                        case 3:  return $num.'rd';
                                                    }
                                                }
                                                return $num.'th';
                                            }
                                            for ($i = 1; $i <= 31; $i++){
                                                echo '<option value="'.$i.'" '; echo $frequency_custom_arr[2] == $i ? 'SELECTED':''; echo '>'.addOrdinalNumberSuffix($i).'</option>';
                                            }

                                    echo '</optgroup>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-3 bg-default '; echo $frequency == 0 ? '':'hide'; echo '">
                            <div class="form-group">
                                <label class="control-label">Month</label>
                                <select class="form-control selectpicker" name="supplier_frequency_month" data-live-search="true" data-size="8">
                                    <optgroup label="Common Settings">
                                        <option value="*" '; echo $frequency_custom_arr[3] == "*" ? 'SELECTED':''; echo '>Every Month</option>
                                        <option value="*/2" '; echo $frequency_custom_arr[3] == "*/2" ? 'SELECTED':''; echo '>Every Other Month</option>
                                        <option value="*/4" '; echo $frequency_custom_arr[3] == "*/4" ? 'SELECTED':''; echo '>Every Third Month</option>
                                        <option value="1,7" '; echo $frequency_custom_arr[3] == "1,7" ? 'SELECTED':''; echo '>Every Six Months</option>
                                    </optgroup>
                                    <optgroup label="Months">';

                                            for ($i = 1; $i <= 12; $i++){
                                                echo '<option value="'.$i.'" '; echo $frequency_custom_arr[3] == $i ? 'SELECTED':''; echo '>'.date("F", mktime(0, 0, 0, $i, 10)).'</option>';
                                            }

                                    echo '</optgroup>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3 bg-default '; echo $frequency == 0 ? '':'hide'; echo '">
                            <div class="form-group">
                                <label class="control-label">Weekday</label>
                                <select class="form-control selectpicker" name="supplier_frequency_weekday" data-live-search="true" data-size="8">
                                    <optgroup label="Common Settings">
                                        <option value="*" '; echo $frequency_custom_arr[4] == "*" ? 'SELECTED':''; echo '>Every Day</option>
                                        <option value="1-5" '; echo $frequency_custom_arr[4] == "1-5" ? 'SELECTED':''; echo '>Every Weekday</option>
                                        <option value="6,7" '; echo $frequency_custom_arr[4] == "6,7" ? 'SELECTED':''; echo '>Every Weekend Day</option>
                                        <option value="1,3,5" '; echo $frequency_custom_arr[4] == "1,3,5" ? 'SELECTED':''; echo '>Every Monday, Wednesday, and Friday</option>
                                        <option value="2,4" '; echo $frequency_custom_arr[4] == "2,4" ? 'SELECTED':''; echo '>Every Tuesday and Thursday</option>
                                    </optgroup>
                                    <optgroup label="Weekdays">';

                                            $days = [
                                                1 => 'Monday',
                                                2 => 'Tuesday',
                                                3 => 'Wednesday',
                                                4 => 'Thursday',
                                                5 => 'Friday',
                                                6 => 'Saturday',
                                                7 => 'Sunday'
                                            ];
                                            for ($i = 1; $i <= 7; $i++){
                                                echo '<option value="'.$i.'" '; echo $frequency_custom_arr[4] == $i ? 'SELECTED':''; echo '>'.$days[$i].'</option>';
                                            }

                                    echo '</optgroup>
                                </select>
                            </div>
                        </div>
                    </div>

                    <p>
                        Regulatory License Number
                        <a href="#modalNewRegulatory" data-toggle="modal" class="btn btn-xs btn-primary" onclick="btnNew_Regulatory(1, 2)"><i class="fa fa-plus"></i> ADD</a>
                    </p>

                    <table class="table table-bordered table-hover" id="tableData_Regulatory_2">
                        <thead>
                            <tr>
                                <th>Regulatory</th>
                                <th>Regulatory Number</th>
                                <th class="text-center" style="width: 140px;">Supporting File</th>
                                <th class="text-center" style="width: 140px;">Registration Date</th>
                                <th class="text-center" style="width: 140px;">Expiration Date</th>
                                <th class="text-center" style="width: 140px;">Action</th>
                            </tr>
                        </thead>
                        <tbody>';

                            if (!empty($regulatory)) {
                                $regulatory_arr = explode(", ", $regulatory);
                                foreach ($regulatory_arr as $value) {

                                    $selectRegulatory = mysqli_query( $conn,"SELECT * FROM tbl_supplier_regulatory WHERE ID=$value" );
                                    if ( mysqli_num_rows($selectRegulatory) > 0 ) {
                                        while($rowRegulatory = mysqli_fetch_array($selectRegulatory)) {
                                            $regulatory_id = $rowRegulatory["ID"];
                                            $files = $rowRegulatory["files"];
                                            $filetype = $rowRegulatory["filetype"];
                                            $type = 'iframe';
                                            if (!empty($files)) {
                                                if ($filetype == 1) {
                                                    $fileExtension = fileExtension($files);
                                                    $src = $fileExtension['src'];
                                                    $embed = $fileExtension['embed'];
                                                    $type = $fileExtension['type'];
                                                    $file_extension = $fileExtension['file_extension'];
                                                    $url = $base_url.'uploads/supplier/';

                                                    $files = $src.$url.rawurlencode($files).$embed;
                                                } else if ($filetype == 3) {
                                                    $files = preg_replace('#[^/]*$#', '', $files).'preview';
                                                }
                                                $files = '<p style="margin: 0;"><a data-src="'.$files.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a></p>';
                                            }

                                            echo '<tr id="tr_'.$regulatory_id.'">
                                                <td>'.$rowRegulatory["name"].'</td>
                                                <td>'.$rowRegulatory["number"].'</td>
                                                <td class="text-center">'.$files.'</td>
                                                <td class="text-center">'.$rowRegulatory["registration_date"].'</td>
                                                <td class="text-center">'.$rowRegulatory["expiration_date"].'</td>
                                                <td class="text-center">
                                                    <input type="hidden" value="'.$regulatory_id.'" name="regulatory[]" />
                                                    <div class="btn-group btn-group-circle">
                                                        <a href="#modalEditRegulatory" data-toggle="modal" class="btn btn-outline dark btn-sm btnEdit_Regulatory" onclick="btnEdit_Regulatory('.$regulatory_id.', 2)">Edit</a>
                                                        <a href="javascript:;" class="btn btn-outlinex red btn-sm btnRemove_Regulatory" onclick="btnRemove_Regulatory('.$regulatory_id.', 2)">Delete</a>
                                                    </div>
                                                </td>
                                            </tr>';
                                        }
                                    }
                                }
                            }

                        echo '</tbody>
                    </table>
                </div>
                <div class="tab-pane" id="tabContact_2">
                    <a href="#modalNewContact" data-toggle="modal" class="btn green" onclick="btnNew_Contact('.$user_id.', 2, \'modalNewContact\')">Add New Contact</a>
                    <div class="table-scrollable">
                        <table class="table table-bordered table-hover" id="tableData_Contact_2">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Title</th>
                                    <th>Address</th>
                                    <th class="text-center" style="width: 145px;">Contact Details</th>
                                    <th class="text-center" style="width: 145px;">Receive Notification?</th>
                                    <th class="text-center hide" style="width: 145px;">Emergency Person</th>
                                    <th class="text-center" style="width: 140px;">Action</th>
                                </tr>
                            </thead>
                            <tbody>';

					            if (!empty($contact)) {
					                $contact_arr = explode(", ", $contact);
					                foreach ($contact_arr as $value) {
					                    $selectContact = mysqli_query( $conn,"SELECT * FROM tbl_supplier_contact WHERE ID=$value" );
					                    if ( mysqli_num_rows($selectContact) > 0 ) {
					                    	while($rowContact = mysqli_fetch_array($selectContact)) {
				                            	$contact_id = $rowContact["ID"];
                                                $contact_notification = $rowContact["notification"];
                                                $contact_name = htmlentities($rowContact["name"] ?? '');
                                                $contact_title = htmlentities($rowContact["title"] ?? '');
                                                $contact_address = htmlentities($rowContact["address"] ?? '');
                                                $contact_email = htmlentities($rowContact["email"] ?? '');
                                                $contact_phone = htmlentities($rowContact["phone"] ?? '');
                                                $contact_cell = htmlentities($rowContact["cell"] ?? '');
                                                $contact_fax = htmlentities($rowContact["fax"] ?? '');

				                                echo '<tr id="tr_'.$contact_id.'">
				                                    <td>'.$contact_name.'</td>
				                                    <td>'.$contact_title.'</td>
				                                    <td>'.$contact_address.'</td>
				                                    <td class="text-center">
				                                    	<ul class="list-inline">';
				                                    	if ($contact_email != "") { echo '<li><a href="mailto:'.$contact_email.'" target="_blank" title="Email"><i class="fa fa-envelope"></i></a></li>'; }
							                            if ($contact_phone != "") { echo '<li><a href="tel:'.$contact_phone.'" target="_blank" title="Phone"><i class="fa fa-phone-square"></i></a></li>'; }
							                            if ($contact_cell != "") { echo '<li><a href="tel:'.$contact_cell.'" target="_blank" title="Cell Number"><i class="fa fa-phone"></i></a></li>'; }
							                            if ($contact_fax != "") { echo '<li><a href="tel:'.$contact_fax.'" target="_blank" title="Fax"><i class="fa fa-print"></i></a></li>'; }
				                                    	echo '</ul>
				                                    </td>
                                                    <td class="text-center"><input type="checkbox" name="checkedContact" value="'.$contact_id.'" onclick="btnCheck_Contact('.$contact_id.', this)" '; echo $contact_notification == 1 ? 'checked':''; echo '/></td>
					                                <td class="text-center">
					                                    <input type="hidden" class="form-control" name="contact_id[]" value="'.$contact_id.'" readonly />
					                                    <div class="mt-action-buttons">
					                                        <div class="btn-group btn-group-circle">
					                                            <a href="#modalEditContact" data-toggle="modal" class="btn btn-outline dark btn-sm btnEdit_Contact" onclick="btnEdit_Contact('.$contact_id.', 2, \'modalEditContact\')">Edit</a>
					                                            <a href="javascript:;" class="btn btn-outlinex red btn-sm btnRemove_Contact" onclick="btnRemove_Contact('.$contact_id.', 2)">Delete</a>
					                                        </div>
					                                    </div>
					                                </td>
				                                </tr>';
					                    	}
					                    }
					                }
					            }

                            echo '</tbody>
                        </table>
                    </div>
                </div>
                <div class="tab-pane '; echo $page == 2 ? 'active':''; echo '" id="tabDocuments_2">
                    <div class="mt-checkbox-list">';
                        
                        $selectRequirement2 = mysqli_query( $conn,"SELECT * FROM tbl_supplier_requirement WHERE organic = 0 ORDER BY name" );
                        if ( mysqli_num_rows($selectRequirement2) > 0 ) {
                            while($rowReq = mysqli_fetch_array($selectRequirement2)) {
                                echo '<label class="mt-checkbox mt-checkbox-outline '; echo $current_client == 0 ? '':'hide'; echo '"> '.$rowReq["name"].'
                                    <input type="checkbox" value="'.$rowReq["ID"].'" name="document[]"  onchange="checked_Requirement(this, 2, '.$id.', '; echo in_array($rowReq["ID"], $document_arr) ? '1' : '0'; echo ')" '; echo in_array($rowReq["ID"], $document_arr) ? 'checked' : ''; echo ' />
                                    <span></span>
                                </label>';
                            }
                        }
                        if (!empty($document_other)) {
                        	$count_other = 0;
                        	foreach ($document_other_arr as $value) {
                                $selectDocument = mysqli_query( $conn,"SELECT * FROM tbl_supplier_document WHERE user_id = $user_id AND supplier_id = $id AND type = 1 AND name = '".$value."'" );
                                if ( mysqli_num_rows($selectDocument) > 0 ) {
                                    $rowDocument = mysqli_fetch_array($selectDocument);
                                    $doc_id = $rowDocument["ID"];

                                    echo '<label class="mt-checkbox mt-checkbox-outline"> '.$value.'
                                        <input type="checkbox" value="'.$value.'" name="document_other[]" data-id="o'.$doc_id.'" onchange="checked_RequirementOther(this, 2)" '; echo in_array($value, $document_other_arr) ? 'checked' : ''; echo ' />
                                        <span></span>
                                    </label>';
                                }
                            }
                        }
                        
                    echo '</div>
                    <div class="form-group">
                        <label class="control-label">'; echo $current_client == 0 ? 'Other':'Add Requirement'; echo '</label>
                        <div class="input-group">
                            <input type="text" class="form-control" name="inputRequirementOther" id="inputRequirementOther_2" placeholder="Specify">
                            <span class="input-group-btn">
                                <button class="btn btn-success" type="button" onclick="btnNew_Requirement(2)">Add</button>
                            </span>
                        </div>
                    </div>

                    <div class="table-scrollable">
                        <table class="table table-bordered table-hover" id="tableData_Requirement_2">
                            <thead class="bg-blue-ebonyclay bg-font-blue-ebonyclay">
                                <tr>
                                    <th style="width: 300px;">Requirements</th>
                                    <th style="width: 165px;" class="text-center">Document</th>
                                    <th>File Name</th>
                                    <th style="width: 250px;" class="text-center">Document Validity Period</th>
                                    <th style="width: 165px;" class="text-center '; echo $current_client == 0 ? '':'hide'; echo '">Template</th>
                                    <th style="width: 165px;" class="text-center">Compliance</th>
                                </tr>
                            </thead>
                            <tbody>';
                            	$compliance = 0;
                            	$compliance_counter = 0;
                            	$compliance_approved = 0;

                            	if (!empty($document)) {
                            		$selectRequirement = mysqli_query( $conn,"SELECT * FROM tbl_supplier_requirement ORDER BY name" );
				                    while($rowRequirement = mysqli_fetch_array($selectRequirement)) {
				                    	$req_id = $rowRequirement["ID"];
				                    	$req_name = $rowRequirement["name"];

				                        foreach ($document_arr as $value) {
				                            if ( $value == $req_id ) {
				                            	$selectDocument = mysqli_query( $conn,"SELECT * FROM tbl_supplier_document WHERE supplier_id='".$id."' AND type = 0 AND name='".$req_id."'" );
				                            	if ( mysqli_num_rows($selectDocument) > 0 ) {
				                            		$rowDocument = mysqli_fetch_array($selectDocument);
								    				$doc_id = $rowDocument["ID"];
				                            		$doc_file = $rowDocument["file"];
				                            		$doc_filetype = $rowDocument["filetype"];
				                            		$doc_filename = $rowDocument["filename"];
				                            		$doc_file_template = $rowDocument["template"];
				                            		$doc_file_comment = $rowDocument["comment"];
				                            		$doc_file_reviewed = $rowDocument["reviewed_by"];
				                            		$doc_file_approved = $rowDocument["approved_by"];

				                            		$doc_file_date = $rowDocument["file_date"];
				                            		if (!empty($doc_file_date)) {
						                                $doc_file_date = new DateTime($doc_file_date);
						                                $doc_file_date_o = $doc_file_date->format('Y/m/d');
						                                $doc_file_date = $doc_file_date->format('m/d/Y');
				                            		}

				                            		$doc_file_due = $rowDocument["file_due"];
				                            		if (!empty($doc_file_due)) {
						                                $doc_file_due = new DateTime($doc_file_due);
						                                $doc_file_due_o = $doc_file_due->format('Y/m/d');
        												$doc_file_due_o_nearly = date('Y/m/d', strtotime($doc_file_due_o. ' - 30 days'));
						                                $doc_file_due = $doc_file_due->format('m/d/Y');
				                            		};

				                            		$compliance_counter++;

									            	echo '<tr class="tr_'.$req_id.'">
									                    <td rowspan="2">
									                    	<input type="hidden" class="form-control" name="document_name[]" value="'.$req_id.'" required />';

									                    	$doc_stat = '';
									                    	if (!empty($doc_file_date) AND !empty($doc_file_due)) {
										                    	if ($doc_file_date_o < $current_dateNow_o && $doc_file_due_o < $current_dateNow_o) {
										                    		$doc_stat = 'text-danger';
										                    	} else {
										                    		if ($doc_file_date_o <= $current_dateNow_o && $doc_file_due_o_nearly <= $current_dateNow_o) {
										                    			$doc_stat = 'text-warning';
										                    		}
										                    	}
									                    	}

						                        			echo '<b class="'.$doc_stat.'">'.$req_name.'</b>
									                    </td>
					                                    <td class="text-center">';
					                                    	if (!empty($doc_file)) {
					                                    		$type = 'iframe';
					                                    		if ($doc_filetype == 1) {
											                    	$fileExtension = fileExtension($doc_file);
																	$src = $fileExtension['src'];
																	$embed = $fileExtension['embed'];
																	$type = $fileExtension['type'];
																	$file_extension = $fileExtension['file_extension'];
											                        $url = $base_url.'uploads/supplier/';

											                        $doc_file = $src.$url.rawurlencode($doc_file).$embed;
					                                    		} else {
					                                    			$doc_file = preg_replace('#[^/]*$#', '', $doc_file).'preview';
					                                    		}

					                                    		echo '<select class="form-control '; echo !empty($doc_file) ? 'hide':''; echo '" name="document_filetype[]" onchange="changeType(this)" required>
													            	<option value="0">Select option</option>
													            	<option value="1">Manual Upload</option>
													            	<option value="2">Youtube URL</option>
													            	<option value="3">Google Drive URL</option>
													            </select>
													            <input class="form-control margin-top-15 fileUpload" type="file" name="document_file[]" onchange="changeFile(this, this.value)" style="display: none;" />
													            <input class="form-control margin-top-15 fileURL" type="url" name="document_fileurl[]" style="display: none;" placeholder="https://" />
												                <p class="'; echo !empty($doc_file) ? '':'hide'; echo '" style="margin: 0;"><a href="'.$doc_file.'" data-src="'.$doc_file.'" data-fancybox data-type="'.$type.'" class="btn btn-sm btn-info">View</a> | <button type="button" class="btn btn-sm red-haze uploadNew" onclick="uploadNew(this)">Upload</button></p>';
										                    } else {
										                    	echo '<select class="form-control hide" name="document_filetype[]" onchange="changeType(this)" required>
			                                                        <option value="0">Select option</option>
			                                                        <option value="1">Manual Upload</option>
			                                                        <option value="2">Youtube URL</option>
			                                                        <option value="3">Google Drive URL</option>
			                                                    </select>
			                                                    <input class="form-control margin-top-15 fileUpload" type="file" name="document_file[]" onchange="changeFile(this, this.value)" style="display: none;" />
			                                                    <input class="form-control margin-top-15 fileURL" type="url" name="document_fileurl[]" style="display: none;" placeholder="https://" />
										                    	<p style="margin: 0;"><button type="button" class="btn btn-sm red-haze uploadNew" onclick="uploadNew(this)">Upload</button></p>';
										                    }
					                                    echo '</td>
									                    <td>';

									                    	if (!empty($doc_filename)) {
									                    		echo '<input type="text" class="form-control document_filename" name="document_filename[]" value="'.$doc_filename.'" placeholder="Document Name" />
									                    		<p class="hide" style="margin: 0;">'.$doc_filename.'</p>';
									                    	} else {
									                    		echo '<input type="text" class="form-control document_filename" name="document_filename[]" placeholder="Document Name" />';
									                    	}
									                    	
									                    echo '</td>
									                    <td class="text-center">
										                    <div class="input-group">
											                    <input type="text" class="form-control daterange '; if (empty($doc_file_date) || empty($doc_file_due)) { echo 'daterange_empty'; } echo '" name="document_daterange[]" value="'; if (!empty($doc_file_date) && !empty($doc_file_due)) { echo $doc_file_date .' - '. $doc_file_due; } echo '" />
											                    <span class="input-group-btn">
											                        <button class="btn default date-range-toggle" type="button" onclick="widget_date_clears(this)">
											                            <i class="fa fa-close"></i>
											                        </button>
											                    </span>
											                </div>
											                <input type="date" class="form-control hide" name="document_date[]" value="'.$doc_file_date.'" />
											                <input type="date" class="form-control hide" name="document_due[]" value="'.$doc_file_due.'" />
											            </td>
									                    <td rowspan="2" class="text-center '; echo $current_client == 0 ? '':'hide'; echo '">
									                    	<input type="file" class="form-control hide" name="document_template[]" />';

									                    	$selectTemplate = mysqli_query( $conn,"SELECT * FROM tbl_supplier_template WHERE user_id = $user_id AND requirement_id = $req_id" );
									                        if ( mysqli_num_rows($selectTemplate) > 0 ) {
									                            $rowTemplate = mysqli_fetch_array($selectTemplate);
									                            $temp_ID = $rowTemplate["ID"];
									                            $temp_file = $rowTemplate["file"];

									                            $type = 'iframe';
									                            $filetype = $rowTemplate["filetype"];
									                            if ($filetype == 1) {
										                            $fileExtension = fileExtension($temp_file);
										                            $src = $fileExtension['src'];
										                            $embed = $fileExtension['embed'];
										                            $type = $fileExtension['type'];
										                            $file_extension = $fileExtension['file_extension'];
										                            $url = $base_url.'uploads/supplier/';

										                            $temp_file = $src.$url.rawurlencode($temp_file).$embed;
									                            } else if ($filetype == 3) {
									                            	$temp_file = preg_replace('#[^/]*$#', '', $temp_file).'preview';
									                            }

									                            echo '<p style="margin: 0;">
									                                <a href="'.$temp_file.'" data-src="'.$temp_file.'" data-fancybox data-type="'.$type.'" class="btn btn-sm btn-info">View</a> |
									                                <a href="#modalTemplate2" class="btn btn-sm red-haze" data-toggle="modal" onclick="btnTemplate2('.$req_id.', '.$temp_ID.', 2)">Upload</a>
									                            </p>';
									                        } else {
									                            echo '<a href="#modalTemplate2" class="btn btn-sm red-haze" data-toggle="modal" onclick="btnTemplate2('.$req_id.', 0, 2)">Upload</a>';
									                        }

										                echo '</td>
                                                        <td rowspan="2" class="text-center">';

                                                            $doc_com = 0;
                                                            if (!empty($doc_file_due)) {
                                                                if ($doc_file_due_o >= $current_dateNow_o && $doc_file_approved > 0) { $compliance_approved++; $doc_com = 100; }
                                                            }
                                                            echo $doc_com.'%'; 

                                                        echo '</td>
									                </tr>
									                <tr class="tr_'.$req_id.'">
									                	<td colspan="3">';

															$selectComment = mysqli_query( $conn,"SELECT * FROM tbl_supplier_comment WHERE supplier_document_id = '".$doc_id."'" );
															if ( mysqli_num_rows($selectComment) > 0 ) {
																echo '<ul>';
																	while($rowComment = mysqli_fetch_array($selectComment)) {
																		$comment_text = $rowComment["comment"];

																		$comment_user = $rowComment["portal_user"];
																		$selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $comment_user" );
																		$rowUser = mysqli_fetch_array($selectUser);
																		$comment_user_name = $rowUser["first_name"] .' '. $rowUser["last_name"];
                                                                        if (employerID($comment_user) == 34 AND $user_id != 34) {
                                                                            $comment_user_name = 'Compliance';
                                                                        }
																		
																		$comment_last_modified = $rowComment["last_modified"];
																		$comment_last_modified = new DateTime($comment_last_modified);
																		$comment_last_modified = $comment_last_modified->format('M d, Y');

																		echo '<li>
																			<b>'.$comment_user_name.'</b> | <i>'.$comment_last_modified.'</i><br>
																			'.$comment_text.'
																		</li>';
																	}
																echo '</ul>';
															}

													    	echo '<input type="text" class="form-control" name="document_comment[]" placeholder="Comment" />';
													    	if ($page == 1) {
													    		if ($current_userEmployerID == 34 OR $current_userEmployerID == 27 OR $current_userEmployerID == 464 OR $current_userEmployerID == 1106) {
															    	echo '<div class="row margin-top-10">
															            <div class="col-md-6">
															                <div class="form-group">
															                    <label class="control-label">Reviewed By</label>';

															                    if ($doc_file_reviewed  > 0) {
															                    	$selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $doc_file_reviewed" );
															                        if ( mysqli_num_rows($selectUser) > 0 ) {
															                        	$rowUser = mysqli_fetch_array($selectUser);
															                        	$rowUserName = $rowUser["first_name"] .' '. $rowUser["last_name"];
                                                                                        if (employerID($doc_file_reviewed) == 34 AND $user_id != 34) {
                                                                                            $rowUserName = 'Compliance';
                                                                                        }

															                        	echo '<input type="hidden" class="form-control" name="document_reviewed[]" value="'.$doc_file_reviewed.'"/>
															                        	<p style="margin: 0; font-weight: 700;">'.$rowUserName.'</p>';
															                        }
															                    } else {
															                    	$selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $current_userID" );
															                        if ( mysqli_num_rows($selectUser) > 0 ) {

															                        	$rowUser = mysqli_fetch_array($selectUser);
															                        	$rowUserID = $rowUser["ID"];
															                        	$rowUserName = $rowUser["first_name"] .' '. $rowUser["last_name"];
                                                                                        if (employerID($current_userID) == 34 AND $user_id != 34) {
                                                                                            $rowUserName = 'Compliance';
                                                                                        }

															                        	echo '<select class="form-control " name="document_reviewed[]">
															                    			<option value="0">Select</option>
															                    			<option value="'.$rowUserID.'">'.$rowUserName.'</option>
															                    		</select>';
															                        }
															                    }

															                echo '</div>
															            </div>
															            <div class="col-md-6">
															                <div class="form-group">
															                    <label class="control-label">Approved By</label>';

															                    if ($doc_file_approved  > 0) {
															                    	$selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $doc_file_approved" );
															                        if ( mysqli_num_rows($selectUser) > 0 ) {
															                        	$rowUser = mysqli_fetch_array($selectUser);
															                        	$rowUserName = $rowUser["first_name"] .' '. $rowUser["last_name"];
                                                                                        if (employerID($doc_file_approved) == 34 AND $user_id != 34) {
                                                                                            $rowUserName = 'Compliance';
                                                                                        }

															                        	echo '<input type="hidden" class="form-control" name="document_approved[]" value="'.$doc_file_approved.'"/>
															                        	<p style="margin: 0; font-weight: 700;">'.$rowUserName.'</p>';
															                        }
															                    } else {
															                    	$selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $current_userID" );
															                        if ( mysqli_num_rows($selectUser) > 0 ) {

															                        	$rowUser = mysqli_fetch_array($selectUser);
															                        	$rowUserID = $rowUser["ID"];
															                        	$rowUserName = $rowUser["first_name"] .' '. $rowUser["last_name"];
                                                                                        if (employerID($current_userID) == 34 AND $user_id != 34) {
                                                                                            $rowUserName = 'Compliance';
                                                                                        }

															                        	echo '<select class="form-control " name="document_approved[]">
															                    			<option value="0">Select</option>
															                    			<option value="'.$rowUserID.'">'.$rowUserName.'</option>
															                    		</select>';
															                        }
															                    }

															                echo '</div>
															            </div>
															        </div>';
													    		}
														    }

														echo '</td>
													</tr>';
				                            	}
				                            }
				                        }
				                    }
                            	}

                            	if (!empty($document_other)) {
                        			$count_other = 0;
                            		foreach ($document_other_arr as $value) {
                                        $selectDocument = mysqli_query( $conn,"SELECT * FROM tbl_supplier_document WHERE user_id = $user_id AND supplier_id = $id AND type = 1 AND name = '".$value."'" );
		                            	if ( mysqli_num_rows($selectDocument) > 0 ) {
		                            		$rowDocument = mysqli_fetch_array($selectDocument);
								    		$doc_id = $rowDocument["ID"];
		                            		$doc_file = $rowDocument["file"];
				                            $doc_filetype = $rowDocument["filetype"];
		                            		$doc_filename = $rowDocument["filename"];
		                            		$doc_file_template = $rowDocument["template"];
		                            		$doc_file_comment = $rowDocument["comment"];
		                            		$doc_file_reviewed = $rowDocument["reviewed_by"];
		                            		$doc_file_approved = $rowDocument["approved_by"];

		                            		$doc_file_date = $rowDocument["file_date"];
		                            		if (!empty($doc_file_date)) {
				                                $doc_file_date = new DateTime($doc_file_date);
				                                $doc_file_date_o = $doc_file_date->format('Y/m/d');
				                                $doc_file_date = $doc_file_date->format('m/d/Y');
		                            		}

		                            		$doc_file_due = $rowDocument["file_due"];
		                            		if (!empty($doc_file_due)) {
				                                $doc_file_due = new DateTime($doc_file_due);
				                                $doc_file_due_o = $doc_file_due->format('Y/m/d');
        										$doc_file_due_o_nearly = date('Y/m/d', strtotime($doc_file_due_o. ' - 30 days'));
				                                $doc_file_due = $doc_file_due->format('m/d/Y');
		                            		};

		                            		$compliance_counter++;

							            	echo '<tr class="tr_other_o'.$doc_id.'">
							                    <td rowspan="2">
                                                    <input type="hidden" class="form-control" name="document_other_name[]" value="'.$value.'"" />';

                                                    $doc_stat = '';
                                                    if (!empty($doc_file_date) AND !empty($doc_file_due)) {
                                                        if ($doc_file_date_o < $current_dateNow_o && $doc_file_due_o < $current_dateNow_o) {
                                                            $doc_stat = 'text-danger';
                                                        } else {
                                                            if ($doc_file_date_o <= $current_dateNow_o && $doc_file_due_o_nearly <= $current_dateNow_o) {
                                                                $doc_stat = 'text-warning';
                                                            }
                                                        }
                                                    }

                                                    echo '<b class="'.$doc_stat.'">'.$value.'</b>
                                                </td>
                                                <td class="text-center">';
                                                    if (!empty($doc_file)) {
                                                        $type = 'iframe';
                                                        if ($doc_filetype == 1) {
                                                            $fileExtension = fileExtension($doc_file);
                                                            $src = $fileExtension['src'];
                                                            $embed = $fileExtension['embed'];
                                                            $type = $fileExtension['type'];
                                                            $file_extension = $fileExtension['file_extension'];
                                                            $url = $base_url.'uploads/supplier/';

                                                            $doc_file = $src.$url.rawurlencode($doc_file).$embed;
                                                        } else {
                                                            $doc_file = preg_replace('#[^/]*$#', '', $doc_file).'preview';
                                                        }

                                                        echo '<select class="form-control '; echo !empty($doc_file) ? 'hide':''; echo '" name="document_other_filetype[]" onchange="changeType(this)" required>
                                                            <option value="0">Select option</option>
                                                            <option value="1">Manual Upload</option>
                                                            <option value="2">Youtube URL</option>
                                                            <option value="3">Google Drive URL</option>
                                                        </select>
                                                        <input class="form-control margin-top-15 fileUpload" type="file" name="document_other_file[]" onchange="changeFile(this, this.value)" style="display: none;" />
                                                        <input class="form-control margin-top-15 fileURL" type="url" name="document_other_fileurl[]" style="display: none;" placeholder="https://" />
                                                        <p class="'; echo !empty($doc_file) ? '':'hide'; echo '" style="margin: 0;"><a href="'.$doc_file.'" data-src="'.$doc_file.'" data-fancybox data-type="'.$type.'" class="btn btn-sm btn-info">View</a> | <button type="button" class="btn btn-sm red-haze uploadNew" onclick="uploadNew(this)">Upload</button></p>';
                                                    } else {
                                                        echo '<select class="form-control hide" name="document_other_filetype[]" onchange="changeType(this)" required>
                                                            <option value="0">Select option</option>
                                                            <option value="1">Manual Upload</option>
                                                            <option value="2">Youtube URL</option>
                                                            <option value="3">Google Drive URL</option>
                                                        </select>
                                                        <input class="form-control margin-top-15 fileUpload" type="file" name="document_other_file[]" onchange="changeFile(this, this.value)" style="display: none;" />
                                                        <input class="form-control margin-top-15 fileURL" type="url" name="document_other_fileurl[]" style="display: none;" placeholder="https://" />
                                                        <p style="margin: 0;"><button type="button" class="btn btn-sm red-haze uploadNew" onclick="uploadNew(this)">Upload</button></p>';
                                                    }
                                                echo '</td>
                                                <td>';

                                                    if (!empty($doc_filename)) {
                                                        echo '<input type="text" class="form-control document_filename" name="document_other_filename[]" value="'.$doc_filename.'" placeholder="Document Name" />
                                                        <p class="hide" style="margin: 0;">'.$doc_filename.'</p>';
                                                    } else {
                                                        echo '<input type="text" class="form-control document_filename" name="document_other_filename[]" placeholder="Document Name" />';
                                                    }
                                                    
                                                echo '</td>
                                                <td class="text-center">
                                                    <div class="input-group">
                                                        <input type="text" class="form-control daterange '; if (empty($doc_file_date) || empty($doc_file_due)) { echo 'daterange_empty'; } echo '" name="document_other_daterange[]" value="'; if (!empty($doc_file_date) && !empty($doc_file_due)) { echo $doc_file_date .' - '. $doc_file_due; } echo '" />
                                                        <span class="input-group-btn">
                                                            <button class="btn default date-range-toggle" type="button" onclick="widget_date_clears(this)">
                                                                <i class="fa fa-close"></i>
                                                            </button>
                                                        </span>
                                                    </div>
                                                    <input type="date" class="form-control hide" name="document_other_date[]" value="'.$doc_file_date.'" />
                                                    <input type="date" class="form-control hide" name="document_other_due[]" value="'.$doc_file_due.'" />
                                                </td>
                                                <td rowspan="2" class="text-center '; echo $current_client == 0 ? '':'hide'; echo '">
                                                    <input type="file" class="form-control hide" name="document_other_template[]" />';

                                                    // if (!empty($doc_file_template)) {
                                                    //     $type = 'iframe';
                                                    //     $filetype = $rowTemplate["filetype"];
                                                    //     if ($filetype == 1) {
                                                    //         $fileExtension = fileExtension($doc_file_template);
                                                    //         $src = $fileExtension['src'];
                                                    //         $embed = $fileExtension['embed'];
                                                    //         $type = $fileExtension['type'];
                                                    //         $file_extension = $fileExtension['file_extension'];
                                                    //         $url = $base_url.'uploads/supplier/';

                                                    //         $doc_file_template = $src.$url.rawurlencode($doc_file_template).$embed;
                                                    //     } else if ($filetype == 3) {
                                                    //         $doc_file_template = preg_replace('#[^/]*$#', '', $doc_file_template).'preview';
                                                    //     }

                                                    //     echo '<p style="margin: 0;">
                                                    //         <a href="'.$doc_file_template.'" data-src="'.$doc_file_template.'" data-fancybox data-type="'.$type.'" class="btn btn-sm btn-info">View</a> |
                                                    //         <a href="#modalTemplate2" class="btn btn-sm red-haze" data-toggle="modal" onclick="btnTemplate2('.$id.$count_other.', '.$doc_id.', 2)">Upload</a>
                                                    //     </p>';
                                                    // } else {
                                                    //     echo '<a href="#modalTemplate2" class="btn btn-sm red-haze" data-toggle="modal" onclick="btnTemplate2('.$doc_id.', 0, 2)">Upload</a>';
                                                    // }

                                                    $selectTemplate = mysqli_query( $conn,"SELECT * FROM tbl_supplier_template WHERE user_id = $user_id AND requirement_id = $doc_id" );
                                                    if ( mysqli_num_rows($selectTemplate) > 0 ) {
                                                        $rowTemplate = mysqli_fetch_array($selectTemplate);
                                                        $temp_ID = $rowTemplate["ID"];
                                                        $temp_file = $rowTemplate["file"];

                                                        $type = 'iframe';
                                                        $filetype = $rowTemplate["filetype"];
                                                        if ($filetype == 1) {
                                                            $fileExtension = fileExtension($temp_file);
                                                            $src = $fileExtension['src'];
                                                            $embed = $fileExtension['embed'];
                                                            $type = $fileExtension['type'];
                                                            $file_extension = $fileExtension['file_extension'];
                                                            $url = $base_url.'uploads/supplier/';

                                                            $temp_file = $src.$url.rawurlencode($temp_file).$embed;
                                                        } else if ($filetype == 3) {
                                                            $temp_file = preg_replace('#[^/]*$#', '', $temp_file).'preview';
                                                        }

                                                        echo '<p style="margin: 0;">
                                                            <a href="'.$temp_file.'" data-src="'.$temp_file.'" data-fancybox data-type="'.$type.'" class="btn btn-sm btn-info">View</a> |
                                                            <a href="#modalTemplate2" class="btn btn-sm red-haze" data-toggle="modal" onclick="btnTemplate2('.$doc_id.', '.$temp_ID.', 2)">Upload</a>
                                                        </p>';
                                                    } else {
                                                        echo '<a href="#modalTemplate2" class="btn btn-sm red-haze" data-toggle="modal" onclick="btnTemplate2('.$doc_id.', 0, 2)">Upload</a>';
                                                    }

                                                echo '</td>
                                                <td rowspan="2" class="text-center">';

                                                    $doc_com = 0;
                                                    if (!empty($doc_file_due)) {
                                                        if ($doc_file_due_o >= $current_dateNow_o && $doc_file_approved > 0) { $compliance_approved++; $doc_com = 100; }
                                                    }
                                                    echo $doc_com.'%'; 

                                                echo '</td>
                                            </tr>
									        <tr class="tr_other_o'.$doc_id.'">
									        	<td colspan="3">';

													$selectComment = mysqli_query( $conn,"SELECT * FROM tbl_supplier_comment WHERE supplier_document_id = '".$doc_id."'" );
													if ( mysqli_num_rows($selectComment) > 0 ) {
														echo '<ul>';
															while($rowComment = mysqli_fetch_array($selectComment)) {
																$comment_text = $rowComment["comment"];

																$comment_user = $rowComment["portal_user"];
																$selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $comment_user" );
																$rowUser = mysqli_fetch_array($selectUser);
																$comment_user_name = $rowUser["first_name"] .' '. $rowUser["last_name"];
                                                                if (employerID($comment_user) == 34 AND $user_id != 34) {
                                                                    $comment_user_name = 'Compliance';
                                                                }
																
																$comment_last_modified = $rowComment["last_modified"];
																$comment_last_modified = new DateTime($comment_last_modified);
																$comment_last_modified = $comment_last_modified->format('M d, Y');

																echo '<li>
																	<b>'.$comment_user_name.'</b> | <i>'.$comment_last_modified.'</i><br>
																	'.$comment_text.'
																</li>';
															}
														echo '</ul>';
													}
									            	
									            	echo '<input type="text" class="form-control" name="document_other_comment[]" placeholder="Comment" />';
									            	if ($page == 1) {
													    if ($current_userEmployerID == 34 OR $current_userEmployerID == 27 OR $current_userEmployerID == 464 OR $current_userEmployerID == 1106) {
											            	echo '<div class="row margin-top-10">
											                    <div class="col-md-6">
											                        <div class="form-group">
											                            <label class="control-label">Reviewed By</label>';

											                            if ($doc_file_reviewed  > 0) {
											                            	$selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $doc_file_reviewed" );
											                                if ( mysqli_num_rows($selectUser) > 0 ) {
											                                	$rowUser = mysqli_fetch_array($selectUser);
											                                	$rowUserName = $rowUser["first_name"] .' '. $rowUser["last_name"];
                                                                                if (employerID($doc_file_reviewed) == 34 AND $user_id != 34) {
                                                                                    $rowUserName = 'Compliance';
                                                                                }

											                                	echo '<input type="hidden" class="form-control" name="document_other_reviewed[]" value="'.$doc_file_reviewed.'"/>
											                                	<p style="margin: 0; font-weight: 700;">'.$rowUserName.'</p>';
											                                }
											                            } else {
											                            	$selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $current_userID" );
											                                if ( mysqli_num_rows($selectUser) > 0 ) {

											                                	$rowUser = mysqli_fetch_array($selectUser);
											                                	$rowUserID = $rowUser["ID"];
											                                	$rowUserName = $rowUser["first_name"] .' '. $rowUser["last_name"];
                                                                                if (employerID($current_userID) == 34 AND $user_id != 34) {
                                                                                    $rowUserName = 'Compliance';
                                                                                }

											                                	echo '<select class="form-control " name="document_other_reviewed[]">
											                            			<option value="0">Select</option>
											                            			<option value="'.$rowUserID.'">'.$rowUserName.'</option>
											                            		</select>';
											                                }
											                            }

											                        echo '</div>
											                    </div>
											                    <div class="col-md-6">
											                        <div class="form-group">
											                            <label class="control-label">Approved By</label>';

											                            if ($doc_file_approved  > 0) {
											                            	$selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $doc_file_approved" );
											                                if ( mysqli_num_rows($selectUser) > 0 ) {
											                                	$rowUser = mysqli_fetch_array($selectUser);
											                                	$rowUserName = $rowUser["first_name"] .' '. $rowUser["last_name"];
                                                                                if (employerID($doc_file_approved) == 34 AND $user_id != 34) {
                                                                                    $rowUserName = 'Compliance';
                                                                                }

											                                	echo '<input type="hidden" class="form-control" name="document_other_approved[]" value="'.$doc_file_approved.'"/>
											                                	<p style="margin: 0; font-weight: 700;">'.$rowUserName.'</p>';
											                                }
											                            } else {
											                            	$selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $current_userID" );
											                                if ( mysqli_num_rows($selectUser) > 0 ) {

											                                	$rowUser = mysqli_fetch_array($selectUser);
											                                	$rowUserID = $rowUser["ID"];
											                                	$rowUserName = $rowUser["first_name"] .' '. $rowUser["last_name"];
                                                                                if (employerID($current_userID) == 34 AND $user_id != 34) {
                                                                                    $rowUserName = 'Compliance';
                                                                                }

											                                	echo '<select class="form-control " name="document_other_approved[]">
											                            			<option value="0">Select</option>
											                            			<option value="'.$rowUserID.'">'.$rowUserName.'</option>
											                            		</select>';
											                                }
											                            }

											                        echo '</div>
											                    </div>
											                </div>';
											            }
										            }
									        	echo '</td>
									        </tr>';
								        	$count_other++;
		                            	}
			                        }
                            	}

                            	if ($compliance_approved > 0) { $compliance = ($compliance_approved / $compliance_counter) * 100; }
                            	else { $compliance = 0; }

                            echo '</tbody>
                            <tfoot class="bg-blue-ebonyclay bg-font-blue-ebonyclay">
                                <tr>
                                    <th class="text-right" colspan="'; echo $current_client == 0 ? '5':'4'; echo '">Compliance:</th>
                                    <th class="text-center">'.intval($compliance).'%</th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
                <div class="tab-pane" id="tabMaterials_2">';
                    
                    if ($page == 1) { echo '<a href="#modalNewMaterial" data-toggle="modal" class="btn green margin-bottom-15" onclick="btnNew_Material('.$user_id.', 2, \'modalNewMaterial\')">Add New Material</a>'; }
                    
                    echo '<div class="table-scrollablex">
                        <table class="table table-bordered table-hover" id="tableData_Material_2">
                            <thead>
                                <tr>
                                    <th class="text-center">Active</th>
                                    <th>Material Name</th>
                                    <th>SKU</th>
                                    <th>Description</th>';

                                    if ($page == 1) { echo '<th class="text-center" style="width: 135px;">Action</th>'; }
                                
                                echo '</tr>
                            </thead>
                            <tbody>';

					            if (!empty($material)) {
					                $material_arr = explode(", ", $material);
					                foreach ($material_arr as $value) {
					                    $selectMaterial = mysqli_query( $conn,"SELECT * FROM tbl_supplier_material WHERE ID=$value" );
					                    if ( mysqli_num_rows($selectMaterial) > 0 ) {
					                    	while($rowMaterial = mysqli_fetch_array($selectMaterial)) {
					                    		$material_mid = $rowMaterial["ID"];
                                                $material_active = $rowMaterial["active"] == 1 ? 'Yes':'No';
				                            	$material_name = $rowMaterial["material_name"];
				                            	$material_id = $rowMaterial["material_id"];
				                            	$material_description = $rowMaterial["description"];

				                            	if ($page == 2) {
						                            $selectProduct = mysqli_query( $conn,"SELECT * FROM tbl_products WHERE ID=$material_name" );
						                            $rowProduct = mysqli_fetch_array($selectProduct);
						                            $material_name = $rowProduct["name"];
						                            $material_id = $rowProduct["code"];
						                            $material_description = $rowProduct["description"];
				                            	}

				                                echo '<tr id="tr_'.$material_mid.'">
                                                    <td class="text-center">'.$material_active.'</td>
				                                    <td><input type="hidden" class="form-control" name="material_id[]" value="'.$material_mid.'" readonly />'.$material_name.'</td>
				                                    <td>'.$material_id.'</td>
				                                    <td>'.$material_description.'</td>';

					                                if ($page == 1) { 
						                                echo '<td class="text-center">
						                                    <div class="mt-action-buttons">
						                                        <div class="btn-group btn-group-circle">
						                                            <a href="#modalEditMaterial" data-toggle="modal" class="btn btn-outline dark btn-sm btnEdit_Material" onclick="btnEdit_Material('.$material_mid.', 2, \'modalEditMaterial\')">Edit</a>
						                                            <a href="javascript:;" class="btn btn-outlinex red btn-sm btnRemove_Material" onclick="btnRemove_Material('.$material_mid.', 2)">Delete</a>
						                                        </div>
						                                    </div>
						                                </td>';
						                            }

				                                echo '</tr>';
					                    	}
					                    }
					                }
					            }

					       	echo '</tbody>
                        </table>
                    </div>
                </div>
                <div class="tab-pane" id="tabService_2">';

                    if ($page == 1) { echo '<a href="#modalNewService" data-toggle="modal" class="btn green" onclick="btnNew_Service('.$user_id.', 2, \'modalNewService\')">Add New Service</a>'; }
                    
                    echo '<div class="table-scrollable">
                        <table class="table table-bordered table-hover" id="tableData_Service_2">
                            <thead>
                                <tr>
                                    <th>Service Name</th>
                                    <th>Service ID</th>
                                    <th>Description</th>';

                                    if ($page == 1) { echo '<th class="text-center" style="width: 135px;">Action</th>'; }
                                
                                echo '</tr>
                            </thead>
                            <tbody>';

					            if (!empty($service)) {
					                $service_arr = explode(", ", $service);
					                foreach ($service_arr as $value) {
					                    $selectService = mysqli_query( $conn,"SELECT * FROM tbl_supplier_service WHERE ID=$value" );
					                    if ( mysqli_num_rows($selectService) > 0 ) {
					                    	while($rowService = mysqli_fetch_array($selectService)) {
				                            	$service_mid = $rowService["ID"];
				                            	$service_name = $rowService["service_name"];
				                            	$service_id = $rowService["service_id"];
				                            	$service_description = $rowService["description"];

				                            	if ($page == 2) {
					                            	$selectDataCategory = mysqli_query( $conn,"SELECT * FROM tbl_service_category WHERE id=$service_name" );
						                            $rowDataCategory = mysqli_fetch_array($selectDataCategory);
						                            $service_name = $rowDataCategory["service_category"];

					                            	$selectDataArea = mysqli_query( $conn,"SELECT * FROM tbl_service_area WHERE id=$service_id" );
						                            $rowDataArea = mysqli_fetch_array($selectDataArea);
						                            $service_id = $rowDataArea["area_category"];
				                            	}

				                                echo '<tr id="tr_'.$service_mid.'">
				                                    <td><input type="hidden" class="form-control" name="service_id[]" value="'.$service_mid.'" readonly />'.$service_name.'</td>
				                                    <td>'.$service_id.'</td>
				                                    <td>'.$service_description.'</td>';

					                                if ($page == 1) { 
						                                echo '<td class="text-center">
						                                    <div class="mt-action-buttons">
						                                        <div class="btn-group btn-group-circle">
						                                            <a href="#modalEditService" data-toggle="modal" class="btn btn-outline dark btn-sm btnEdit_Service" onclick="btnEdit_Service('.$service_mid.', 2, \'modalEditService\')">Edit</a>
						                                            <a href="javascript:;" class="btn btn-outlinex red btn-sm btnRemove_Service" onclick="btnRemove_Service('.$service_mid.', 2)">Delete</a>
						                                        </div>
						                                    </div>
						                                </td>';
						                            }

				                                echo '</tr>';
					                    	}
					                    }
					                }
					            }

                            echo '</tbody>
                        </table>
                    </div>
                </div>
                <div class="tab-pane" id="tabAuditReview_2">
                    <h4><strong>Audit</strong></h4>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="control-label">Audit Report</label>';

                                if (!empty($audit_report_arr[0])) {
			                    	$extension = pathinfo($audit_report_arr[0], PATHINFO_EXTENSION);
			                        $src = 'https://view.officeapps.live.com/op/embed.aspx?src=';
			                        $embed = '&embedded=true';
			                        $type = 'iframe';
			                        if ($extension == "pdf") { $src = ''; $embed = ''; $type = ''; $file_extension = "fa-file-pdf-o"; }
			                        else if (strtolower($extension) == "doc" OR strtolower($extension) == "docx") { $file_extension = "fa-file-word-o"; }
			                        else if (strtolower($extension) == "ppt" OR strtolower($extension) == "pptx") { $file_extension = "fa-file-powerpoint-o"; }
			                        else if (strtolower($extension) == "xls" OR strtolower($extension) == "xlsb" OR strtolower($extension) == "xlsm" OR strtolower($extension) == "xlsx" OR strtolower($extension) == "csv" OR strtolower($extension) == "xlsx") { $file_extension = "fa-file-excel-o"; }
			                        else if (strtolower($extension) == "gif" OR strtolower($extension) == "jpg"  OR strtolower($extension) == "jpeg" OR strtolower($extension) == "png" OR strtolower($extension) == "ico") { $src = ''; $embed = ''; $type = ''; $file_extension = "fa-file-image-o"; }
			                        else if (strtolower($extension) == "mp4" OR strtolower($extension) == "mov"  OR strtolower($extension) == "wmv" OR strtolower($extension) == "flv" OR strtolower($extension) == "avi" OR strtolower($extension) == "avchd" OR strtolower($extension) == "webm" OR strtolower($extension) == "mkv") { $src = ''; $embed = ''; $type = ''; $file_extension = "fa-file-video-o"; }
			                        else { $src = ''; $embed = ''; $type = ''; $file_extension = "fa-file-code-o"; }

			                        $url = $base_url.'uploads/supplier/';

			                        echo '<input type="hidden" name="audit_report_file_tmp" value="'.$audit_report_arr[0].'" />
                                    <input class="form-control '; echo !empty($audit_report_arr[0]) ? 'hide':''; echo '" type="file" name="audit_report_file" />
                                    <p class="'; echo !empty($audit_report_arr[0]) ? '':'hide'; echo '" style="margin: 0;"><a href="'.$src.$url.rawurlencode($audit_report_arr[0]).$embed.'" data-src="'.$src.$url.rawurlencode($audit_report_arr[0]).$embed.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a> | <button type="button" class="btn btn-link uploadNew" onclick="uploadNewOld(this)">Upload</button></p>';
                                } else {
                                    echo '<input type="hidden" name="audit_report_file_tmp" value="" />
                                    <input class="form-control" type="file" name="audit_report_file" />';
                                }

                            echo '</div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="control-label">Document Validity</label>
                                <div class="input-group">
                                    <input type="text" class="form-control daterange_audit '; if (empty($audit_report_arr[1]) || empty($audit_report_arr[2])) { echo 'daterange_audit_empty'; } echo '" name="audit_report_validity" value="'; if (!empty($audit_report_arr[1]) && !empty($audit_report_arr[2])) { echo $audit_report_arr[1] .' - '. $audit_report_arr[2]; } echo '" />
                                    <span class="input-group-btn">
                                        <button class="btn default date-range-toggle" type="button" onclick="widget_date_audit_clears(this)">
                                            <i class="fa fa-close"></i>
                                        </button>
                                    </span>
                                </div>
                            </div>

                            <input class="form-control hide" type="date" name="audit_report_date" value="'.$audit_report_arr[1].'" />
                            <input class="form-control hide" type="date" name="audit_report_due" value="'.$audit_report_arr[2].'" />
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="control-label">Comments / Notes</label>
                                <input class="form-control" type="text" name="audit_report_note" value="'.$audit_report_arr[3].'" />
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="control-label">Audit Certificate</label>';

                                if (!empty($audit_certificate_arr[0])) {
			                    	$extension = pathinfo($audit_certificate_arr[0], PATHINFO_EXTENSION);
			                        $src = 'https://view.officeapps.live.com/op/embed.aspx?src=';
			                        $embed = '&embedded=true';
			                        $type = 'iframe';
			                        if ($extension == "pdf") { $src = ''; $embed = ''; $type = ''; $file_extension = "fa-file-pdf-o"; }
			                        else if (strtolower($extension) == "doc" OR strtolower($extension) == "docx") { $file_extension = "fa-file-word-o"; }
			                        else if (strtolower($extension) == "ppt" OR strtolower($extension) == "pptx") { $file_extension = "fa-file-powerpoint-o"; }
			                        else if (strtolower($extension) == "xls" OR strtolower($extension) == "xlsb" OR strtolower($extension) == "xlsm" OR strtolower($extension) == "xlsx" OR strtolower($extension) == "csv" OR strtolower($extension) == "xlsx") { $file_extension = "fa-file-excel-o"; }
			                        else if (strtolower($extension) == "gif" OR strtolower($extension) == "jpg"  OR strtolower($extension) == "jpeg" OR strtolower($extension) == "png" OR strtolower($extension) == "ico") { $src = ''; $embed = ''; $type = ''; $file_extension = "fa-file-image-o"; }
			                        else if (strtolower($extension) == "mp4" OR strtolower($extension) == "mov"  OR strtolower($extension) == "wmv" OR strtolower($extension) == "flv" OR strtolower($extension) == "avi" OR strtolower($extension) == "avchd" OR strtolower($extension) == "webm" OR strtolower($extension) == "mkv") { $src = ''; $embed = ''; $type = ''; $file_extension = "fa-file-video-o"; }
			                        else { $src = ''; $embed = ''; $type = ''; $file_extension = "fa-file-code-o"; }

			                        $url = $base_url.'uploads/supplier/';

			                        echo '<input type="hidden" name="audit_certificate_file_tmp" value="'.$audit_certificate_arr[0].'" />
                                    <input class="form-control '; echo !empty($audit_certificate_arr[0]) ? 'hide':''; echo '" type="file" name="audit_certificate_file" />
                                    <p class="'; echo !empty($audit_certificate_arr[0]) ? '':'hide'; echo '" style="margin: 0;"><a href="'.$src.$url.rawurlencode($audit_certificate_arr[0]).$embed.'" data-src="'.$src.$url.rawurlencode($audit_certificate_arr[0]).$embed.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a> | <button type="button" class="btn btn-link uploadNew" onclick="uploadNewOld(this)">Upload</button></p>';
                                } else {
                                    echo '<input type="hidden" name="audit_certificate_file_tmp" value="" />
                                    <input class="form-control" type="file" name="audit_certificate_file" />';
                                }

                            echo '</div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="control-label">Document Validity</label>
                                <div class="input-group">
                                    <input type="text" class="form-control daterange_audit '; if (empty($audit_certificate_arr[1]) || empty($audit_certificate_arr[2])) { echo 'daterange_audit_empty'; } echo '" name="audit_certificate_validity" value="'; if (!empty($audit_certificate_arr[1]) && !empty($audit_certificate_arr[2])) { echo $audit_certificate_arr[1] .' - '. $audit_certificate_arr[2]; } echo '" />
                                    <span class="input-group-btn">
                                        <button class="btn default date-range-toggle" type="button" onclick="widget_date_audit_clears(this)">
                                            <i class="fa fa-close"></i>
                                        </button>
                                    </span>
                                </div>
                            </div>

                            <input class="form-control hide" type="date" name="audit_certificate_date" value="'.$audit_certificate_arr[1].'" />
                            <input class="form-control hide" type="date" name="audit_certificate_due" value="'.$audit_certificate_arr[2].'" />
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="control-label">Comments / Notes</label>
                                <input class="form-control" type="text" name="audit_certificate_note" value="'.$audit_certificate_arr[3].'" />
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="control-label">Audit Corrective Action</label>';

                                if (!empty($audit_action_arr[0])) {
			                    	$extension = pathinfo($audit_action_arr[0], PATHINFO_EXTENSION);
			                        $src = 'https://view.officeapps.live.com/op/embed.aspx?src=';
			                        $embed = '&embedded=true';
			                        $type = 'iframe';
			                        if ($extension == "pdf") { $src = ''; $embed = ''; $type = ''; $file_extension = "fa-file-pdf-o"; }
			                        else if (strtolower($extension) == "doc" OR strtolower($extension) == "docx") { $file_extension = "fa-file-word-o"; }
			                        else if (strtolower($extension) == "ppt" OR strtolower($extension) == "pptx") { $file_extension = "fa-file-powerpoint-o"; }
			                        else if (strtolower($extension) == "xls" OR strtolower($extension) == "xlsb" OR strtolower($extension) == "xlsm" OR strtolower($extension) == "xlsx" OR strtolower($extension) == "csv" OR strtolower($extension) == "xlsx") { $file_extension = "fa-file-excel-o"; }
			                        else if (strtolower($extension) == "gif" OR strtolower($extension) == "jpg"  OR strtolower($extension) == "jpeg" OR strtolower($extension) == "png" OR strtolower($extension) == "ico") { $src = ''; $embed = ''; $type = ''; $file_extension = "fa-file-image-o"; }
			                        else if (strtolower($extension) == "mp4" OR strtolower($extension) == "mov"  OR strtolower($extension) == "wmv" OR strtolower($extension) == "flv" OR strtolower($extension) == "avi" OR strtolower($extension) == "avchd" OR strtolower($extension) == "webm" OR strtolower($extension) == "mkv") { $src = ''; $embed = ''; $type = ''; $file_extension = "fa-file-video-o"; }
			                        else { $src = ''; $embed = ''; $type = ''; $file_extension = "fa-file-code-o"; }

			                        $url = $base_url.'uploads/supplier/';

			                        echo '<input type="hidden" name="audit_action_file_tmp" value="'.$audit_action_arr[0].'" />
                                    <input class="form-control '; echo !empty($audit_action_arr[0]) ? 'hide':''; echo '" type="file" name="audit_action_file" />
                                    <p class="'; echo !empty($audit_action_arr[0]) ? '':'hide'; echo '" style="margin: 0;"><a href="'.$src.$url.rawurlencode($audit_action_arr[0]).$embed.'" data-src="'.$src.$url.rawurlencode($audit_action_arr[0]).$embed.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a> | <button type="button" class="btn btn-link uploadNew" onclick="uploadNewOld(this)">Upload</button></p>';
                                } else {
                                    echo '<input type="hidden" name="audit_action_file_tmp" value="" />
                                    <input class="form-control" type="file" name="audit_action_file" />';
                                }

                            echo '</div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="control-label">Document Validity</label>
                                <div class="input-group">
                                    <input type="text" class="form-control daterange_audit '; if (empty($audit_action_arr[1]) || empty($audit_action_arr[2])) { echo 'daterange_audit_empty'; } echo '" name="audit_action_validity" value="'; if (!empty($audit_action_arr[1]) && !empty($audit_action_arr[2])) { echo $audit_action_arr[1] .' - '. $audit_action_arr[2]; } echo '" />
                                    <span class="input-group-btn">
                                        <button class="btn default date-range-toggle" type="button" onclick="widget_date_audit_clears(this)">
                                            <i class="fa fa-close"></i>
                                        </button>
                                    </span>
                                </div>
                            </div>

                            <input class="form-control hide" type="date" name="audit_action_date" value="'.$audit_action_arr[1].'" />
                            <input class="form-control hide" type="date" name="audit_action_due" value="'.$audit_action_arr[2].'" />
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="control-label">Comments / Notes</label>
                                <input class="form-control" type="text" name="audit_action_note" value="'.$audit_action_arr[3].'" />
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="control-label">Audit Score</label>
                                <input class="form-control" type="text" name="audit_score" value="'.$audit_score.'"/>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12 hide">
                            <h4><strong>Auditing Body</strong></h4>
                            <div class="form-group">
                                <label class="control-label">Add Auditing</label>
                                <input type="text" class="form-control tagsinput" name="audit" data-role="tagsinput" placeholder="Specify" value="'.$audit.'" />
                                <span class="form-text text-muted">Hit enter button to add more</span>
                            </div>
                        </div>
                        <div class="col-md-12">
                            <h4><strong>Annual Review</strong></h4>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="control-label">Reviewed by</label>
                                        <input class="form-control" type="text" name="reviewed_by" value="'.$reviewed_by.'" />
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="control-label">Duration of Review</label>
                                        <div class="input-group">
                                            <input type="text" class="form-control daterange_audit '; if (empty($reviewed_date) || empty($reviewed_due)) { echo 'daterange_audit_empty'; } echo '" name="reviewed_validity" value="'; if (!empty($reviewed_date) && !empty($reviewed_due)) { echo $reviewed_date .' - '. $reviewed_due; } echo '" />
                                            <span class="input-group-btn">
                                                <button class="btn default date-range-toggle" type="button" onclick="widget_date_audit_clears(this)">
                                                    <i class="fa fa-close"></i>
                                                </button>
                                            </span>
                                        </div>
                                    </div>

                                    <input class="form-control hide" type="date" name="reviewed_date" value="'.$reviewed_date.'" />
                                    <input class="form-control hide" type="date" name="reviewed_due" value="'.$reviewed_due.'" />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>';

        mysqli_close($conn);
	}
    if( isset($_GET['modalView_SupplierReq']) ) {
        $id = $_GET['modalView_SupplierReq'];
        $current_userID = $_COOKIE['ID'];
        $current_userEmployerID = employerID($current_userID);

        $current_client = 0;
        if (isset($_COOKIE['client'])) { $current_client = $_COOKIE['client']; }

        if (!empty($_COOKIE['switchAccount'])) {
            $portal_user = $_COOKIE['ID'];
            $user_id = $_COOKIE['switchAccount'];
        }
        else {
            $portal_user = $_COOKIE['ID'];
            $user_id = employerID($portal_user);
        }
        
        $current_dateNow_o = date('Y/m/d');
        $current_dateNow = new DateTime($current_dateNow_o);
        $current_dateNow = $current_dateNow->format('M d, Y');

        $selectData = mysqli_query( $conn,"SELECT * FROM tbl_supplier WHERE ID = $id" );
        if ( mysqli_num_rows($selectData) > 0 ) {
            $row = mysqli_fetch_array($selectData);
            $user_account_id = $row["user_id"];
            $page = $row["page"];
            $category = $row["category"];
            $industry = $row["industry"];

            $address = $row["address"];
            $address_arr = explode(" | ", $address);
            if (COUNT($address_arr) < 5) {
                $address_arr = explode(", ", $address);
            }

            $document = $row["document"];
            $document_arr = explode(" | ", $document);
            if (count($document_arr) <= 1) {
                $document_arr = explode(", ", $document);
            }

            $document_other = $row["document_other"];
            $document_other_arr = explode(" | ", $document_other);
            if (count($document_other_arr) <= 1 ) {
                $document_other_arr = explode(", ", $document_other);
            }

            $contact = $row["contact"];
            $material = $row["material"];
            $service = $row["service"];

            $audit_report = $row["audit_report"];
            $audit_report_arr = explode(" | ", $audit_report);

            $audit_certificate = $row["audit_certificate"];
            $audit_certificate_arr = explode(" | ", $audit_certificate);

            $audit_action = $row["audit_action"];
            $audit_action_arr = explode(" | ", $audit_action);

            $audit = $row["audit"];
            $reviewed_by = $row["reviewed_by"];
            $reviewed_date = $row["reviewed_date"];
            $reviewed_due = $row["reviewed_due"];

            $frequency = $row["frequency"];
            $frequency_custom = $row["frequency_custom"];
            $frequency_custom_arr = explode(" | ", $frequency_custom);

            if ($page == 2) {
                $selectUser = mysqli_query( $conn,'SELECT * FROM tbl_user WHERE ID="'. $user_account_id .'" ORDER BY ID LIMIT 1' );
                $rowUser = mysqli_fetch_array($selectUser);
                $name = $rowUser['first_name'] .' '. $rowUser['last_name'];

                $selectCategory = mysqli_query( $conn,"SELECT * FROM tbl_supplier_category WHERE ID = $category" );
                $rowCategory = mysqli_fetch_array($selectCategory);
                $enterprise_category = $rowCategory["name"];

                $selectIndustry = mysqli_query( $conn,"SELECT * FROM tbl_supplier_industry WHERE ID = $industry" );
                $rowIndustry = mysqli_fetch_array($selectIndustry);
                $enterprise_industry = $rowIndustry["name"];

                $enterprise_name = "";
                $enterprise_bldg = "";
                $enterprise_city = "";
                $enterprise_state = "";
                $enterprise_zip = "";
                $enterprise_country = "";
                $enterprise_email = "";
                $enterprise_phone = "";
                $enterprise_fax = "";
                $enterprise_website = "";

                // $selectEnterprise = mysqli_query( $conn,"SELECT * FROM tblEnterpiseDetails WHERE users_entities = $user_account_id" );
                // if ( mysqli_num_rows($selectEnterprise) > 0 ) {
                //     $rowEnterprise = mysqli_fetch_array($selectEnterprise);
                //     $enterprise_name = $rowEnterprise["businessname"];
                //     $enterprise_bldg = $rowEnterprise["Bldg"];
                //     $enterprise_city = $rowEnterprise["city"];
                //     $enterprise_state = $rowEnterprise["States"];
                //     $enterprise_zip = $rowEnterprise["ZipCode"];

                //     $enterprise_country = $rowEnterprise["country"];
                //     $selectCountry = mysqli_query( $conn,"SELECT * FROM countries WHERE id = $enterprise_country" );
                //     $rowCountry = mysqli_fetch_array($selectCountry);
                //     $enterprise_country = $rowCountry["name"];

                //     $enterprise_email = $rowEnterprise["businessemailAddress"];
                //     $enterprise_phone = $rowEnterprise["businesstelephone"];
                //     $enterprise_fax = $rowEnterprise["businessfax"];
                //     $enterprise_website = $rowEnterprise["businesswebsite"];
                // }
            }
        }

        echo '<input class="form-control" type="hidden" name="ID" value="'.$id.'" />
        <div class="mt-checkbox-list">';
            
            $selectRequirement2 = mysqli_query( $conn,"SELECT * FROM tbl_supplier_requirement ORDER BY name" );
            if ( mysqli_num_rows($selectRequirement2) > 0 ) {
                while($rowReq = mysqli_fetch_array($selectRequirement2)) {
                    echo '<label class="mt-checkbox mt-checkbox-outline '; echo $current_client == 0 ? '':'hide'; echo '"> '.$rowReq["name"].'
                        <input type="checkbox" value="'.$rowReq["ID"].'" name="document[]"  onchange="checked_Requirement(this, 2, '.$id.', '; echo in_array($rowReq["ID"], $document_arr) ? '1' : '0'; echo ')" '; echo in_array($rowReq["ID"], $document_arr) ? 'checked' : ''; echo ' />
                        <span></span>
                    </label>';
                }
            }
            if (!empty($document_other)) {
                $count_other = 0;
                foreach ($document_other_arr as $value) {
                    echo '<label class="mt-checkbox mt-checkbox-outline"> '.$value.'
                        <input type="checkbox" value="'.$value.'" name="document_other[]" data-id="o'.$id.$count_other++.'" onchange="checked_RequirementOther(this, 2)" '; echo in_array($value, $document_other_arr) ? 'checked' : ''; echo ' />
                        <span></span>
                    </label>';
                }
            }
            
        echo '</div>
        <div class="form-group">
            <label class="control-label">'; echo $current_client == 0 ? 'Other':'Add Requirement'; echo '</label>
            <div class="input-group">
                <input type="text" class="form-control" name="inputRequirementOther" id="inputRequirementOther_2" placeholder="Specify">
                <span class="input-group-btn">
                    <button class="btn btn-success" type="button" onclick="btnNew_Requirement(2)">Add</button>
                </span>
            </div>
        </div>

        <div class="table-scrollable">
            <table class="table table-bordered table-hover" id="tableData_Requirement_2">
                <thead class="bg-blue-ebonyclay bg-font-blue-ebonyclay">
                    <tr>
                        <th style="width: 300px;">Requirements</th>
                        <th style="width: 165px;" class="text-center">Document</th>
                        <th>File Name</th>
                        <th style="width: 250px;" class="text-center">Document Validity Period</th>
                        <th style="width: 165px;" class="text-center '; echo $current_client == 0 ? '':'hide'; echo '">Template</th>
                        <th style="width: 165px;" class="text-center">Compliance</th>
                    </tr>
                </thead>
                <tbody>';
                    $compliance = 0;
                    $compliance_counter = 0;
                    $compliance_approved = 0;

                    if (!empty($document)) {
                        $selectRequirement = mysqli_query( $conn,"SELECT * FROM tbl_supplier_requirement ORDER BY name" );
                        while($rowRequirement = mysqli_fetch_array($selectRequirement)) {
                            $req_id = $rowRequirement["ID"];
                            $req_name = $rowRequirement["name"];

                            foreach ($document_arr as $value) {
                                if ( $value == $req_id ) {
                                    $selectDocument = mysqli_query( $conn,"SELECT * FROM tbl_supplier_document WHERE supplier_id='".$id."' AND type = 0 AND name='".$req_id."'" );
                                    if ( mysqli_num_rows($selectDocument) > 0 ) {
                                        $rowDocument = mysqli_fetch_array($selectDocument);
                                        $doc_id = $rowDocument["ID"];
                                        $doc_file = $rowDocument["file"];
                                        $doc_filetype = $rowDocument["filetype"];
                                        $doc_filename = $rowDocument["filename"];
                                        $doc_file_template = $rowDocument["template"];
                                        $doc_file_comment = $rowDocument["comment"];
                                        $doc_file_reviewed = $rowDocument["reviewed_by"];
                                        $doc_file_approved = $rowDocument["approved_by"];

                                        $doc_file_date = $rowDocument["file_date"];
                                        if (!empty($doc_file_date)) {
                                            $doc_file_date = new DateTime($doc_file_date);
                                            $doc_file_date_o = $doc_file_date->format('Y/m/d');
                                            $doc_file_date = $doc_file_date->format('m/d/Y');
                                        }

                                        $doc_file_due = $rowDocument["file_due"];
                                        if (!empty($doc_file_due)) {
                                            $doc_file_due = new DateTime($doc_file_due);
                                            $doc_file_due_o = $doc_file_due->format('Y/m/d');
                                            $doc_file_due_o_nearly = date('Y/m/d', strtotime($doc_file_due_o. ' - 30 days'));
                                            $doc_file_due = $doc_file_due->format('m/d/Y');
                                        };

                                        $compliance_counter++;

                                        echo '<tr class="tr_'.$req_id.'">
                                            <td rowspan="2">
                                                <input type="hidden" class="form-control" name="document_name[]" value="'.$req_id.'" required />';

                                                $doc_stat = '';
                                                if (!empty($doc_file_date) AND !empty($doc_file_due)) {
                                                    if ($doc_file_date_o < $current_dateNow_o && $doc_file_due_o < $current_dateNow_o) {
                                                        $doc_stat = 'text-danger';
                                                    } else {
                                                        if ($doc_file_date_o <= $current_dateNow_o && $doc_file_due_o_nearly <= $current_dateNow_o) {
                                                            $doc_stat = 'text-warning';
                                                        }
                                                    }
                                                }

                                                echo '<b class="'.$doc_stat.'">'.$req_name.'</b>
                                            </td>
                                            <td class="text-center">';
                                                if (!empty($doc_file)) {
                                                    $type = 'iframe';
                                                    if ($doc_filetype == 1) {
                                                        $fileExtension = fileExtension($doc_file);
                                                        $src = $fileExtension['src'];
                                                        $embed = $fileExtension['embed'];
                                                        $type = $fileExtension['type'];
                                                        $file_extension = $fileExtension['file_extension'];
                                                        $url = $base_url.'uploads/supplier/';

                                                        $doc_file = $src.$url.rawurlencode($doc_file).$embed;
                                                    } else {
                                                        $doc_file = preg_replace('#[^/]*$#', '', $doc_file).'preview';
                                                    }

                                                    echo '<select class="form-control '; echo !empty($doc_file) ? 'hide':''; echo '" name="document_filetype[]" onchange="changeType(this)" required>
                                                        <option value="0">Select option</option>
                                                        <option value="1">Manual Upload</option>
                                                        <option value="2">Youtube URL</option>
                                                        <option value="3">Google Drive URL</option>
                                                    </select>
                                                    <input class="form-control margin-top-15 fileUpload" type="file" name="document_file[]" onchange="changeFile(this, this.value)" style="display: none;" />
                                                    <input class="form-control margin-top-15 fileURL" type="url" name="document_fileurl[]" style="display: none;" placeholder="https://" />
                                                    <p class="'; echo !empty($doc_file) ? '':'hide'; echo '" style="margin: 0;"><a href="'.$doc_file.'" data-src="'.$doc_file.'" data-fancybox data-type="'.$type.'" class="btn btn-sm btn-info">View</a> | <button type="button" class="btn btn-sm red-haze uploadNew" onclick="uploadNew(this)">Upload</button></p>';
                                                } else {
                                                    echo '<select class="form-control hide" name="document_filetype[]" onchange="changeType(this)" required>
                                                        <option value="0">Select option</option>
                                                        <option value="1">Manual Upload</option>
                                                        <option value="2">Youtube URL</option>
                                                        <option value="3">Google Drive URL</option>
                                                    </select>
                                                    <input class="form-control margin-top-15 fileUpload" type="file" name="document_file[]" onchange="changeFile(this, this.value)" style="display: none;" />
                                                    <input class="form-control margin-top-15 fileURL" type="url" name="document_fileurl[]" style="display: none;" placeholder="https://" />
                                                    <p style="margin: 0;"><button type="button" class="btn btn-sm red-haze uploadNew" onclick="uploadNew(this)">Upload</button></p>';
                                                }
                                            echo '</td>
                                            <td>';

                                                if (!empty($doc_filename)) {
                                                    echo '<input type="text" class="form-control document_filename" name="document_filename[]" value="'.$doc_filename.'" placeholder="Document Name" />
                                                    <p class="hide" style="margin: 0;">'.$doc_filename.'</p>';
                                                } else {
                                                    echo '<input type="text" class="form-control document_filename" name="document_filename[]" placeholder="Document Name" />';
                                                }
                                                
                                            echo '</td>
                                            <td class="text-center">
                                                <div class="input-group">
                                                    <input type="text" class="form-control daterange '; if (empty($doc_file_date) || empty($doc_file_due)) { echo 'daterange_empty'; } echo '" name="document_daterange[]" value="'; if (!empty($doc_file_date) && !empty($doc_file_due)) { echo $doc_file_date .' - '. $doc_file_due; } echo '" />
                                                    <span class="input-group-btn">
                                                        <button class="btn default date-range-toggle" type="button" onclick="widget_date_clears(this)">
                                                            <i class="fa fa-close"></i>
                                                        </button>
                                                    </span>
                                                </div>
                                                <input type="date" class="form-control hide" name="document_date[]" value="'.$doc_file_date.'" />
                                                <input type="date" class="form-control hide" name="document_due[]" value="'.$doc_file_due.'" />
                                            </td>
                                            <td rowspan="2" class="text-center '; echo $current_client == 0 ? '':'hide'; echo '">
                                                <input type="file" class="form-control hide" name="document_template[]" />';

                                                // if (!empty($doc_file_template)) {
                                                //  $fileExtension = fileExtension($doc_file_template);
                                                //  $src = $fileExtension['src'];
                                                //  $embed = $fileExtension['embed'];
                                                //  $type = $fileExtension['type'];
                                                //  $file_extension = $fileExtension['file_extension'];
                                                //     $url = $base_url.'uploads/supplier/';

                                                //     echo '<input type="file" class="form-control '; echo !empty($doc_file_template) ? 'hide':''; echo '" name="document_template[]" />
                                                //     <p class="'; echo !empty($doc_file_template) ? '':'hide'; echo '" style="margin: 0;"><a href="'.$src.$url.rawurlencode($doc_file_template).$embed.'" data-src="'.$src.$url.rawurlencode($doc_file_template).$embed.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a> | <button type="button" class="btn btn-link uploadNew" onclick="uploadNew(this)">Upload</button></p>';
                                                // } else {
                                                //  echo '<input type="file" class="form-control hide" name="document_template[]" />
                                                //  <p style="margin: 0;"><button type="button" class="btn btn-link uploadNew" onclick="uploadNew(this)">Upload</button></p>';
                                                // }

                                                $selectTemplate = mysqli_query( $conn,"SELECT * FROM tbl_supplier_template WHERE user_id = $user_id AND requirement_id = $req_id" );
                                                if ( mysqli_num_rows($selectTemplate) > 0 ) {
                                                    $rowTemplate = mysqli_fetch_array($selectTemplate);
                                                    $temp_ID = $rowTemplate["ID"];
                                                    $temp_file = $rowTemplate["file"];

                                                    $type = 'iframe';
                                                    $filetype = $rowTemplate["filetype"];
                                                    if ($filetype == 1) {
                                                        $fileExtension = fileExtension($temp_file);
                                                        $src = $fileExtension['src'];
                                                        $embed = $fileExtension['embed'];
                                                        $type = $fileExtension['type'];
                                                        $file_extension = $fileExtension['file_extension'];
                                                        $url = $base_url.'uploads/supplier/';

                                                        $temp_file = $src.$url.rawurlencode($temp_file).$embed;
                                                    } else if ($filetype == 3) {
                                                        $temp_file = preg_replace('#[^/]*$#', '', $temp_file).'preview';
                                                    }

                                                    echo '<p style="margin: 0;">
                                                        <a href="'.$temp_file.'" data-src="'.$temp_file.'" data-fancybox data-type="'.$type.'" class="btn btn-sm btn-info">View</a> |
                                                        <a href="#modalTemplate2" class="btn btn-sm red-haze" data-toggle="modal" onclick="btnTemplate2('.$req_id.', '.$temp_ID.', 2)">Upload</a>
                                                    </p>';
                                                } else {
                                                    echo '<a href="#modalTemplate2" class="btn btn-sm red-haze" data-toggle="modal" onclick="btnTemplate2('.$req_id.', 0, 2)">Upload</a>';
                                                }

                                            echo '</td>
                                            <td rowspan="2" class="text-center">';

                                                $doc_com = 0;
                                                if (!empty($doc_file_due)) {
                                                    if ($doc_file_due_o >= $current_dateNow_o && $doc_file_approved > 0) { $compliance_approved++; $doc_com = 100; }
                                                }
                                                echo $doc_com.'%'; 

                                            echo '</td>
                                        </tr>
                                        <tr class="tr_'.$req_id.'">
                                            <td colspan="3">';

                                                $selectComment = mysqli_query( $conn,"SELECT * FROM tbl_supplier_comment WHERE supplier_document_id = '".$doc_id."'" );
                                                if ( mysqli_num_rows($selectComment) > 0 ) {
                                                    echo '<ul>';
                                                        while($rowComment = mysqli_fetch_array($selectComment)) {
                                                            $comment_text = $rowComment["comment"];

                                                            $comment_user = $rowComment["portal_user"];
                                                            $selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $comment_user" );
                                                            $rowUser = mysqli_fetch_array($selectUser);
                                                            $comment_user_name = $rowUser["first_name"] .' '. $rowUser["last_name"];
                                                            
                                                            $comment_last_modified = $rowComment["last_modified"];
                                                            $comment_last_modified = new DateTime($comment_last_modified);
                                                            $comment_last_modified = $comment_last_modified->format('M d, Y');

                                                            echo '<li>
                                                                <b>'.$comment_user_name.'</b> | <i>'.$comment_last_modified.'</i><br>
                                                                '.$comment_text.'
                                                            </li>';
                                                        }
                                                    echo '</ul>';
                                                }

                                                echo '<input type="text" class="form-control" name="document_comment[]" placeholder="Comment" />';
                                                if ($page == 1) {
                                                    if ($current_userEmployerID == 34 OR $current_userEmployerID == 27 OR $current_userEmployerID == 464 OR $current_userEmployerID == 1106) {
                                                        echo '<div class="row margin-top-10">
                                                            <div class="col-md-6">
                                                                <div class="form-group">
                                                                    <label class="control-label">Reviewed By</label>';

                                                                    if ($doc_file_reviewed  > 0) {
                                                                        $selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $doc_file_reviewed" );
                                                                        if ( mysqli_num_rows($selectUser) > 0 ) {
                                                                            $rowUser = mysqli_fetch_array($selectUser);
                                                                            $rowUserName = $rowUser["first_name"] .' '. $rowUser["last_name"];

                                                                            echo '<input type="hidden" class="form-control" name="document_reviewed[]" value="'.$doc_file_reviewed.'"/>
                                                                            <p style="margin: 0; font-weight: 700;">'.$rowUserName.'</p>';
                                                                        }
                                                                    } else {
                                                                        $selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $current_userID" );
                                                                        if ( mysqli_num_rows($selectUser) > 0 ) {

                                                                            $rowUser = mysqli_fetch_array($selectUser);
                                                                            $rowUserID = $rowUser["ID"];
                                                                            $rowUserName = $rowUser["first_name"] .' '. $rowUser["last_name"];

                                                                            echo '<select class="form-control " name="document_reviewed[]">
                                                                                <option value="0">Select</option>
                                                                                <option value="'.$rowUserID.'">'.$rowUserName.'</option>
                                                                            </select>';
                                                                        }
                                                                    }

                                                                echo '</div>
                                                            </div>
                                                            <div class="col-md-6">
                                                                <div class="form-group">
                                                                    <label class="control-label">Approved By</label>';

                                                                    if ($doc_file_approved  > 0) {
                                                                        $selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $doc_file_approved" );
                                                                        if ( mysqli_num_rows($selectUser) > 0 ) {
                                                                            $rowUser = mysqli_fetch_array($selectUser);
                                                                            $rowUserName = $rowUser["first_name"] .' '. $rowUser["last_name"];

                                                                            echo '<input type="hidden" class="form-control" name="document_approved[]" value="'.$doc_file_approved.'"/>
                                                                            <p style="margin: 0; font-weight: 700;">'.$rowUserName.'</p>';
                                                                        }
                                                                    } else {
                                                                        $selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $current_userID" );
                                                                        if ( mysqli_num_rows($selectUser) > 0 ) {

                                                                            $rowUser = mysqli_fetch_array($selectUser);
                                                                            $rowUserID = $rowUser["ID"];
                                                                            $rowUserName = $rowUser["first_name"] .' '. $rowUser["last_name"];

                                                                            echo '<select class="form-control " name="document_approved[]">
                                                                                <option value="0">Select</option>
                                                                                <option value="'.$rowUserID.'">'.$rowUserName.'</option>
                                                                            </select>';
                                                                        }
                                                                    }

                                                                echo '</div>
                                                            </div>
                                                        </div>';
                                                    }
                                                }

                                            echo '</td>
                                        </tr>';
                                    }
                                }
                            }
                        }
                    }

                    if (!empty($document_other)) {
                        $count_other = 0;
                        foreach ($document_other_arr as $value) {
                            $selectDocument = mysqli_query( $conn,"SELECT * FROM tbl_supplier_document WHERE supplier_id='".$id."' AND type = 1 AND name='".$value."'" );
                            if ( mysqli_num_rows($selectDocument) > 0 ) {
                                $rowDocument = mysqli_fetch_array($selectDocument);
                                $doc_id = $rowDocument["ID"];
                                $doc_file = $rowDocument["file"];
                                $doc_filetype = $rowDocument["filetype"];
                                $doc_filename = $rowDocument["filename"];
                                $doc_file_template = $rowDocument["template"];
                                $doc_file_comment = $rowDocument["comment"];
                                $doc_file_reviewed = $rowDocument["reviewed_by"];
                                $doc_file_approved = $rowDocument["approved_by"];

                                $doc_file_date = $rowDocument["file_date"];
                                if (!empty($doc_file_date)) {
                                    $doc_file_date = new DateTime($doc_file_date);
                                    $doc_file_date_o = $doc_file_date->format('Y/m/d');
                                    $doc_file_date = $doc_file_date->format('m/d/Y');
                                }

                                $doc_file_due = $rowDocument["file_due"];
                                if (!empty($doc_file_due)) {
                                    $doc_file_due = new DateTime($doc_file_due);
                                    $doc_file_due_o = $doc_file_due->format('Y/m/d');
                                    $doc_file_due_o_nearly = date('Y/m/d', strtotime($doc_file_due_o. ' - 30 days'));
                                    $doc_file_due = $doc_file_due->format('m/d/Y');
                                };

                                $compliance_counter++;

                                echo '<tr class="tr_other_o'.$id.$count_other.'">
                                    <td rowspan="2">
                                        <input type="hidden" class="form-control" name="document_other_name[]" value="'.$value.'"" />';

                                        $doc_stat = '';
                                        if (!empty($doc_file_date) AND !empty($doc_file_due)) {
                                            if ($doc_file_date_o < $current_dateNow_o && $doc_file_due_o < $current_dateNow_o) {
                                                $doc_stat = 'text-danger';
                                            } else {
                                                if ($doc_file_date_o <= $current_dateNow_o && $doc_file_due_o_nearly <= $current_dateNow_o) {
                                                    $doc_stat = 'text-warning';
                                                }
                                            }
                                        }

                                        echo '<b class="'.$doc_stat.'">'.$value.'</b>
                                    </td>
                                    <td class="text-center">';
                                        if (!empty($doc_file)) {
                                            $type = 'iframe';
                                            if ($doc_filetype == 1) {
                                                $fileExtension = fileExtension($doc_file);
                                                $src = $fileExtension['src'];
                                                $embed = $fileExtension['embed'];
                                                $type = $fileExtension['type'];
                                                $file_extension = $fileExtension['file_extension'];
                                                $url = $base_url.'uploads/supplier/';

                                                $doc_file = $src.$url.rawurlencode($doc_file).$embed;
                                            } else {
                                                $doc_file = preg_replace('#[^/]*$#', '', $doc_file).'preview';
                                            }

                                            echo '<select class="form-control '; echo !empty($doc_file) ? 'hide':''; echo '" name="document_other_filetype[]" onchange="changeType(this)" required>
                                                <option value="0">Select option</option>
                                                <option value="1">Manual Upload</option>
                                                <option value="2">Youtube URL</option>
                                                <option value="3">Google Drive URL</option>
                                            </select>
                                            <input class="form-control margin-top-15 fileUpload" type="file" name="document_other_file[]" onchange="changeFile(this, this.value)" style="display: none;" />
                                            <input class="form-control margin-top-15 fileURL" type="url" name="document_other_fileurl[]" style="display: none;" placeholder="https://" />
                                            <p class="'; echo !empty($doc_file) ? '':'hide'; echo '" style="margin: 0;"><a href="'.$doc_file.'" data-src="'.$doc_file.'" data-fancybox data-type="'.$type.'" class="btn btn-sm btn-info">View</a> | <button type="button" class="btn btn-sm red-haze uploadNew" onclick="uploadNew(this)">Upload</button></p>';
                                        } else {
                                            echo '<select class="form-control hide" name="document_other_filetype[]" onchange="changeType(this)" required>
                                                <option value="0">Select option</option>
                                                <option value="1">Manual Upload</option>
                                                <option value="2">Youtube URL</option>
                                                <option value="3">Google Drive URL</option>
                                            </select>
                                            <input class="form-control margin-top-15 fileUpload" type="file" name="document_other_file[]" onchange="changeFile(this, this.value)" style="display: none;" />
                                            <input class="form-control margin-top-15 fileURL" type="url" name="document_other_fileurl[]" style="display: none;" placeholder="https://" />
                                            <p style="margin: 0;"><button type="button" class="btn btn-sm red-haze uploadNew" onclick="uploadNew(this)">Upload</button></p>';
                                        }
                                    echo '</td>
                                    <td>';

                                        if (!empty($doc_filename)) {
                                            echo '<input type="text" class="form-control document_filename" name="document_other_filename[]" value="'.$doc_filename.'" placeholder="Document Name" />
                                            <p class="hide" style="margin: 0;">'.$doc_filename.'</p>';
                                        } else {
                                            echo '<input type="text" class="form-control document_filename" name="document_other_filename[]" placeholder="Document Name" />';
                                        }
                                        
                                    echo '</td>
                                    <td class="text-center">
                                        <div class="input-group">
                                            <input type="text" class="form-control daterange '; if (empty($doc_file_date) || empty($doc_file_due)) { echo 'daterange_empty'; } echo '" name="document_other_daterange[]" value="'; if (!empty($doc_file_date) && !empty($doc_file_due)) { echo $doc_file_date .' - '. $doc_file_due; } echo '" />
                                            <span class="input-group-btn">
                                                <button class="btn default date-range-toggle" type="button" onclick="widget_date_clears(this)">
                                                    <i class="fa fa-close"></i>
                                                </button>
                                            </span>
                                        </div>
                                        <input type="date" class="form-control hide" name="document_other_date[]" value="'.$doc_file_date.'" />
                                        <input type="date" class="form-control hide" name="document_other_due[]" value="'.$doc_file_due.'" />
                                    </td>
                                    <td rowspan="2" class="text-center '; echo $current_client == 0 ? '':'hide'; echo '">
                                        <input type="file" class="form-control hide" name="document_other_template[]" />';

                                        if (!empty($doc_file_template)) {
                                            $type = 'iframe';
                                            $filetype = $rowTemplate["filetype"];
                                            if ($filetype == 1) {
                                                $fileExtension = fileExtension($doc_file_template);
                                                $src = $fileExtension['src'];
                                                $embed = $fileExtension['embed'];
                                                $type = $fileExtension['type'];
                                                $file_extension = $fileExtension['file_extension'];
                                                $url = $base_url.'uploads/supplier/';

                                                $doc_file_template = $src.$url.rawurlencode($doc_file_template).$embed;
                                            } else if ($filetype == 3) {
                                                $doc_file_template = preg_replace('#[^/]*$#', '', $doc_file_template).'preview';
                                            }

                                            echo '<p style="margin: 0;">
                                                <a href="'.$doc_file_template.'" data-src="'.$doc_file_template.'" data-fancybox data-type="'.$type.'" class="btn btn-sm btn-info">View</a> |
                                                <a href="#modalTemplate2" class="btn btn-sm red-haze" data-toggle="modal" onclick="btnTemplate2('.$id.', '.$doc_id.', 2)">Upload</a>
                                            </p>';
                                        } else {
                                            echo '<a href="#modalTemplate2" class="btn btn-sm red-haze" data-toggle="modal" onclick="btnTemplate2('.$id.', 0, 2)">Upload</a>';
                                        }

                                    echo '</td>
                                    <td rowspan="2" class="text-center">';

                                        $doc_com = 0;
                                        if (!empty($doc_file_due)) {
                                            if ($doc_file_due_o >= $current_dateNow_o && $doc_file_approved > 0) { $compliance_approved++; $doc_com = 100; }
                                        }
                                        echo $doc_com.'%'; 

                                    echo '</td>
                                </tr>
                                <tr class="tr_other_o'.$id.$count_other.'">
                                    <td colspan="3">';

                                        $selectComment = mysqli_query( $conn,"SELECT * FROM tbl_supplier_comment WHERE supplier_document_id = '".$doc_id."'" );
                                        if ( mysqli_num_rows($selectComment) > 0 ) {
                                            echo '<ul>';
                                                while($rowComment = mysqli_fetch_array($selectComment)) {
                                                    $comment_text = $rowComment["comment"];

                                                    $comment_user = $rowComment["portal_user"];
                                                    $selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $comment_user" );
                                                    $rowUser = mysqli_fetch_array($selectUser);
                                                    $comment_user_name = $rowUser["first_name"] .' '. $rowUser["last_name"];
                                                    
                                                    $comment_last_modified = $rowComment["last_modified"];
                                                    $comment_last_modified = new DateTime($comment_last_modified);
                                                    $comment_last_modified = $comment_last_modified->format('M d, Y');

                                                    echo '<li>
                                                        <b>'.$comment_user_name.'</b> | <i>'.$comment_last_modified.'</i><br>
                                                        '.$comment_text.'
                                                    </li>';
                                                }
                                            echo '</ul>';
                                        }
                                        
                                        echo '<input type="text" class="form-control" name="document_other_comment[]" placeholder="Comment" />';
                                        if ($page == 1) {
                                            if ($current_userEmployerID == 34 OR $current_userEmployerID == 27 OR $current_userEmployerID == 464) {
                                                echo '<div class="row margin-top-10">
                                                    <div class="col-md-6">
                                                        <div class="form-group">
                                                            <label class="control-label">Reviewed By</label>';

                                                            if ($doc_file_reviewed  > 0) {
                                                                $selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $doc_file_reviewed" );
                                                                if ( mysqli_num_rows($selectUser) > 0 ) {
                                                                    $rowUser = mysqli_fetch_array($selectUser);
                                                                    $rowUserName = $rowUser["first_name"] .' '. $rowUser["last_name"];

                                                                    echo '<input type="hidden" class="form-control" name="document_other_reviewed[]" value="'.$doc_file_reviewed.'"/>
                                                                    <p style="margin: 0; font-weight: 700;">'.$rowUserName.'</p>';
                                                                }
                                                            } else {
                                                                $selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $current_userID" );
                                                                if ( mysqli_num_rows($selectUser) > 0 ) {

                                                                    $rowUser = mysqli_fetch_array($selectUser);
                                                                    $rowUserID = $rowUser["ID"];
                                                                    $rowUserName = $rowUser["first_name"] .' '. $rowUser["last_name"];

                                                                    echo '<select class="form-control " name="document_other_reviewed[]">
                                                                        <option value="0">Select</option>
                                                                        <option value="'.$rowUserID.'">'.$rowUserName.'</option>
                                                                    </select>';
                                                                }
                                                            }

                                                        echo '</div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <div class="form-group">
                                                            <label class="control-label">Approved By</label>';

                                                            if ($doc_file_approved  > 0) {
                                                                $selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $doc_file_approved" );
                                                                if ( mysqli_num_rows($selectUser) > 0 ) {
                                                                    $rowUser = mysqli_fetch_array($selectUser);
                                                                    $rowUserName = $rowUser["first_name"] .' '. $rowUser["last_name"];

                                                                    echo '<input type="hidden" class="form-control" name="document_other_approved[]" value="'.$doc_file_approved.'"/>
                                                                    <p style="margin: 0; font-weight: 700;">'.$rowUserName.'</p>';
                                                                }
                                                            } else {
                                                                $selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $current_userID" );
                                                                if ( mysqli_num_rows($selectUser) > 0 ) {

                                                                    $rowUser = mysqli_fetch_array($selectUser);
                                                                    $rowUserID = $rowUser["ID"];
                                                                    $rowUserName = $rowUser["first_name"] .' '. $rowUser["last_name"];

                                                                    echo '<select class="form-control " name="document_other_approved[]">
                                                                        <option value="0">Select</option>
                                                                        <option value="'.$rowUserID.'">'.$rowUserName.'</option>
                                                                    </select>';
                                                                }
                                                            }

                                                        echo '</div>
                                                    </div>
                                                </div>';
                                            }
                                        }
                                    echo '</td>
                                </tr>';
                                $count_other++;
                            }
                        }
                    }

                    if ($compliance_approved > 0) { $compliance = ($compliance_approved / $compliance_counter) * 100; }
                    else { $compliance = 0; }

                echo '</tbody>
                <tfoot class="bg-blue-ebonyclay bg-font-blue-ebonyclay">
                    <tr>
                        <th class="text-right" colspan="'; echo $current_client == 0 ? '5':'4'; echo '">Compliance:</th>
                        <th class="text-center">'.intval($compliance).'%</th>
                    </tr>
                </tfoot>
            </table>
        </div>';

        mysqli_close($conn);
    }
    if( isset($_GET['modalView_SupplierReqReport']) ) {
        $id = $_GET['modalView_SupplierReqReport'];
        $current_userID = $_COOKIE['ID'];
        $current_userEmployerID = employerID($current_userID);

        $current_client = 0;
        if (isset($_COOKIE['client'])) { $current_client = $_COOKIE['client']; }

        if (!empty($_COOKIE['switchAccount'])) {
            $portal_user = $_COOKIE['ID'];
            $user_id = $_COOKIE['switchAccount'];
        }
        else {
            $portal_user = $_COOKIE['ID'];
            $user_id = employerID($portal_user);
        }
        
        $current_dateNow_o = date('Y/m/d');
        $current_dateNow = new DateTime($current_dateNow_o);
        $current_dateNow = $current_dateNow->format('M d, Y');

        $selectData = mysqli_query( $conn,"SELECT * FROM tbl_supplier WHERE ID = $id" );
        if ( mysqli_num_rows($selectData) > 0 ) {
            $row = mysqli_fetch_array($selectData);
            $user_account_id = $row["user_id"];
            $page = $row["page"];
            $category = $row["category"];
            $industry = $row["industry"];

            $address = $row["address"];
            $address_arr = explode(" | ", $address);
            if (COUNT($address_arr) < 5) {
                $address_arr = explode(", ", $address);
            }

            $document = $row["document"];
            $document_arr = explode(" | ", $document);
            if (count($document_arr) <= 1) {
                $document_arr = explode(", ", $document);
            }

            $document_other = $row["document_other"];
            $document_other_arr = explode(" | ", $document_other);
            if (count($document_other_arr) <= 1 ) {
                $document_other_arr = explode(", ", $document_other);
            }

            $contact = $row["contact"];
            $material = $row["material"];
            $service = $row["service"];

            $audit_report = $row["audit_report"];
            $audit_report_arr = explode(" | ", $audit_report);

            $audit_certificate = $row["audit_certificate"];
            $audit_certificate_arr = explode(" | ", $audit_certificate);

            $audit_action = $row["audit_action"];
            $audit_action_arr = explode(" | ", $audit_action);

            $audit = $row["audit"];
            $reviewed_by = $row["reviewed_by"];
            $reviewed_date = $row["reviewed_date"];
            $reviewed_due = $row["reviewed_due"];

            $frequency = $row["frequency"];
            $frequency_custom = $row["frequency_custom"];
            $frequency_custom_arr = explode(" | ", $frequency_custom);

            if ($page == 2) {
                $selectUser = mysqli_query( $conn,'SELECT * FROM tbl_user WHERE ID="'. $user_account_id .'" ORDER BY ID LIMIT 1' );
                $rowUser = mysqli_fetch_array($selectUser);
                $name = $rowUser['first_name'] .' '. $rowUser['last_name'];

                $selectCategory = mysqli_query( $conn,"SELECT * FROM tbl_supplier_category WHERE ID = $category" );
                $rowCategory = mysqli_fetch_array($selectCategory);
                $enterprise_category = $rowCategory["name"];

                $selectIndustry = mysqli_query( $conn,"SELECT * FROM tbl_supplier_industry WHERE ID = $industry" );
                $rowIndustry = mysqli_fetch_array($selectIndustry);
                $enterprise_industry = $rowIndustry["name"];

                $enterprise_name = "";
                $enterprise_bldg = "";
                $enterprise_city = "";
                $enterprise_state = "";
                $enterprise_zip = "";
                $enterprise_country = "";
                $enterprise_email = "";
                $enterprise_phone = "";
                $enterprise_fax = "";
                $enterprise_website = "";

                // $selectEnterprise = mysqli_query( $conn,"SELECT * FROM tblEnterpiseDetails WHERE users_entities = $user_account_id" );
                // if ( mysqli_num_rows($selectEnterprise) > 0 ) {
                //     $rowEnterprise = mysqli_fetch_array($selectEnterprise);
                //     $enterprise_name = $rowEnterprise["businessname"];
                //     $enterprise_bldg = $rowEnterprise["Bldg"];
                //     $enterprise_city = $rowEnterprise["city"];
                //     $enterprise_state = $rowEnterprise["States"];
                //     $enterprise_zip = $rowEnterprise["ZipCode"];

                //     $enterprise_country = $rowEnterprise["country"];
                //     $selectCountry = mysqli_query( $conn,"SELECT * FROM countries WHERE id = $enterprise_country" );
                //     $rowCountry = mysqli_fetch_array($selectCountry);
                //     $enterprise_country = $rowCountry["name"];

                //     $enterprise_email = $rowEnterprise["businessemailAddress"];
                //     $enterprise_phone = $rowEnterprise["businesstelephone"];
                //     $enterprise_fax = $rowEnterprise["businessfax"];
                //     $enterprise_website = $rowEnterprise["businesswebsite"];
                // }
            }
        }

        echo '<div class="table-scrollable">
            <table class="table table-bordered table-hover" id="table2excel">
                <thead class="bg-blue-ebonyclay bg-font-blue-ebonyclay">
                    <tr>
                        <th style="width: 300px;">Requirements</th>
                        <th>Document</th>
                        <th style="width: 250px;" class="text-center">Document Validity Period</th>
                    </tr>
                </thead>
                <tbody>';
                    $compliance = 0;
                    $compliance_counter = 0;
                    $compliance_approved = 0;

                    if (!empty($document)) {
                        $selectRequirement = mysqli_query( $conn,"SELECT * FROM tbl_supplier_requirement ORDER BY name" );
                        while($rowRequirement = mysqli_fetch_array($selectRequirement)) {
                            $req_id = $rowRequirement["ID"];
                            $req_name = $rowRequirement["name"];

                            foreach ($document_arr as $value) {
                                if ( $value == $req_id ) {
                                    $selectDocument = mysqli_query( $conn,"SELECT * FROM tbl_supplier_document WHERE supplier_id='".$id."' AND type = 0 AND name='".$req_id."'" );
                                    if ( mysqli_num_rows($selectDocument) > 0 ) {
                                        $rowDocument = mysqli_fetch_array($selectDocument);
                                        $doc_id = $rowDocument["ID"];
                                        $doc_file = $rowDocument["file"];
                                        $doc_filetype = $rowDocument["filetype"];
                                        $doc_filename = $rowDocument["filename"];
                                        $doc_file_template = $rowDocument["template"];
                                        $doc_file_comment = $rowDocument["comment"];
                                        $doc_file_reviewed = $rowDocument["reviewed_by"];
                                        $doc_file_approved = $rowDocument["approved_by"];

                                        $doc_file_date = $rowDocument["file_date"];
                                        if (!empty($doc_file_date)) {
                                            $doc_file_date = new DateTime($doc_file_date);
                                            $doc_file_date_o = $doc_file_date->format('Y/m/d');
                                            $doc_file_date = $doc_file_date->format('m/d/Y');
                                        }

                                        $doc_file_due = $rowDocument["file_due"];
                                        if (!empty($doc_file_due)) {
                                            $doc_file_due = new DateTime($doc_file_due);
                                            $doc_file_due_o = $doc_file_due->format('Y/m/d');
                                            $doc_file_due_o_nearly = date('Y/m/d', strtotime($doc_file_due_o. ' - 30 days'));
                                            $doc_file_due = $doc_file_due->format('m/d/Y');
                                        };

                                        echo '<tr class="tr_'.$req_id.'">
                                            <td>';

                                                $doc_stat = '';
                                                if (!empty($doc_file_date) AND !empty($doc_file_due)) {
                                                    if ($doc_file_date_o < $current_dateNow_o && $doc_file_due_o < $current_dateNow_o) {
                                                        $doc_stat = 'text-danger';
                                                    } else {
                                                        if ($doc_file_date_o <= $current_dateNow_o && $doc_file_due_o_nearly <= $current_dateNow_o) {
                                                            $doc_stat = 'text-warning';
                                                        }
                                                    }
                                                }

                                                echo '<b class="'.$doc_stat.'">'.htmlentities($req_name ?? '').'</b>
                                            </td>
                                            <td>';
                                                if (!empty($doc_file)) {
                                                    $type = 'iframe';
                                                    if ($doc_filetype == 1) {
                                                        $fileExtension = fileExtension($doc_file);
                                                        $src = $fileExtension['src'];
                                                        $embed = $fileExtension['embed'];
                                                        $type = $fileExtension['type'];
                                                        $file_extension = $fileExtension['file_extension'];
                                                        $url = $base_url.'uploads/supplier/';

                                                        $doc_file = $src.$url.rawurlencode($doc_file).$embed;
                                                    } else {
                                                        $doc_file = preg_replace('#[^/]*$#', '', $doc_file).'preview';
                                                    }

                                                    echo '<a href="'.$doc_file.'" data-src="'.$doc_file.'" data-fancybox data-type="'.$type.'">'.$doc_filename.'</a>';
                                                }
                                            echo '</td>
                                            <td class="text-center">'.$doc_file_date .' - '. $doc_file_due.'</td>
                                        </tr>';
                                    }
                                }
                            }
                        }
                    }

                    if (!empty($document_other)) {
                        $count_other = 0;
                        foreach ($document_other_arr as $value) {
                            $selectDocument = mysqli_query( $conn,"SELECT * FROM tbl_supplier_document WHERE supplier_id='".$id."' AND type = 1 AND name='".$value."'" );
                            if ( mysqli_num_rows($selectDocument) > 0 ) {
                                $rowDocument = mysqli_fetch_array($selectDocument);
                                $doc_id = $rowDocument["ID"];
                                $doc_file = $rowDocument["file"];
                                $doc_filetype = $rowDocument["filetype"];
                                $doc_filename = $rowDocument["filename"];
                                $doc_file_template = $rowDocument["template"];
                                $doc_file_comment = $rowDocument["comment"];
                                $doc_file_reviewed = $rowDocument["reviewed_by"];
                                $doc_file_approved = $rowDocument["approved_by"];

                                $doc_file_date = $rowDocument["file_date"];
                                if (!empty($doc_file_date)) {
                                    $doc_file_date = new DateTime($doc_file_date);
                                    $doc_file_date_o = $doc_file_date->format('Y/m/d');
                                    $doc_file_date = $doc_file_date->format('m/d/Y');
                                }

                                $doc_file_due = $rowDocument["file_due"];
                                if (!empty($doc_file_due)) {
                                    $doc_file_due = new DateTime($doc_file_due);
                                    $doc_file_due_o = $doc_file_due->format('Y/m/d');
                                    $doc_file_due_o_nearly = date('Y/m/d', strtotime($doc_file_due_o. ' - 30 days'));
                                    $doc_file_due = $doc_file_due->format('m/d/Y');
                                };

                                echo '<tr class="tr_other_o'.$id.$count_other.'">
                                    <td>';

                                        $doc_stat = '';
                                        if (!empty($doc_file_date) AND !empty($doc_file_due)) {
                                            if ($doc_file_date_o < $current_dateNow_o && $doc_file_due_o < $current_dateNow_o) {
                                                $doc_stat = 'text-danger';
                                            } else {
                                                if ($doc_file_date_o <= $current_dateNow_o && $doc_file_due_o_nearly <= $current_dateNow_o) {
                                                    $doc_stat = 'text-warning';
                                                }
                                            }
                                        }

                                        echo '<b class="'.$doc_stat.'">'.$value.'</b>
                                    </td>
                                    <td>';
                                        if (!empty($doc_file)) {
                                            $type = 'iframe';
                                            if ($doc_filetype == 1) {
                                                $fileExtension = fileExtension($doc_file);
                                                $src = $fileExtension['src'];
                                                $embed = $fileExtension['embed'];
                                                $type = $fileExtension['type'];
                                                $file_extension = $fileExtension['file_extension'];
                                                $url = $base_url.'uploads/supplier/';

                                                $doc_file = $src.$url.rawurlencode($doc_file).$embed;
                                            } else {
                                                $doc_file = preg_replace('#[^/]*$#', '', $doc_file).'preview';
                                            }

                                            echo '<a href="'.$doc_file.'" data-src="'.$doc_file.'" data-fancybox data-type="'.$type.'">'.$doc_filename.'</a>';
                                        }
                                    echo '</td>
                                    <td class="text-center">'.$doc_file_date .' - '. $doc_file_due.'</td>
                                </tr>';
                                $count_other++;
                            }
                        }
                    }

                echo '</tbody>
            </table>
        </div>';

        mysqli_close($conn);
    }
	if( isset($_GET['modalView_Supplier_Industry']) ) {
		$id = $_GET['modalView_Supplier_Industry'];
		$c = $_GET['c'];
        $o = $_GET['o'];
        $m = $_GET['m'];
        $s = $_GET['s'];

        $country = '';
        if ($c == "US") {  $country = ' AND country IS NULL '; }

        $organic = '';
        if ($o == 0) {  $organic = ' AND organic = 0 '; }

        if ($m == 1) { $s = 0; }

        $selectData = mysqli_query( $conn,"SELECT * FROM tbl_supplier_requirement WHERE LENGTH(name) > 0 $country $organic ORDER BY name" );
        
        // $selectRequirement = mysqli_query( $conn,"SELECT * FROM tbl_supplier_requirement WHERE country IS NULL AND organic = $o ORDER BY name" );
        // if ($c != "US") {
        //     $selectRequirement = mysqli_query( $conn,"SELECT * FROM tbl_supplier_requirement WHERE organic = $o ORDER BY name" );
        // }
        if ( mysqli_num_rows($selectData) > 0 ) {
            while($row = mysqli_fetch_array($selectData)) {
            	$industry = array();
            	$country = array();
            	if (!empty( $row["industry_id"])) { $industry = explode(", ", $row["industry_id"]); }
            	if (!empty( $row["country"])) { $country = explode(", ", $row["country"]); }

                if ($c != "US") {
                    if (in_array($id, $country)) {
                        echo '<label class="mt-checkbox mt-checkbox-outline"> '.$row["name"].'
                            <input type="checkbox" value="'.$row["ID"].'" name="document[]" name="document[]" onchange="checked_Requirement(this, '.$m.', '.$s.', 0)" />
                            <span></span>
                        </label>';
                    }
                }
                if (in_array($id, $industry)) {
                    echo '<label class="mt-checkbox mt-checkbox-outline"> '.$row["name"].'
                        <input type="checkbox" value="'.$row["ID"].'" name="document[]" name="document[]" onchange="checked_Requirement(this, '.$m.', '.$s.', 0)" />
                        <span></span>
                    </label>';
                } else if ($id == 0) {
                    echo '<label class="mt-checkbox mt-checkbox-outline"> '.$row["name"].'
                        <input type="checkbox" value="'.$row["ID"].'" name="document[]" name="document[]" onchange="checked_Requirement(this, '.$m.', '.$s.', 0)" />
                        <span></span>
                    </label>';
                }
            }
        }
	}
    if( isset($_GET['modalSend_Supplier']) ) {
        $id = $_GET['modalSend_Supplier'];

        $selectData = mysqli_query( $conn,"SELECT
            s.user_id AS s_user_id,
            s.notification AS s_notification,
            s.name AS s_name,
            s.email AS s_email,
            s.document AS s_document,
            s.document_other AS s_document_other,
            s.address AS s_address,
            s.contact AS s_contact,
            u.client AS u_client,
            u.first_name AS u_first_name,
            u.last_name AS u_last_name,
            u.email AS u_email,
            e.businessname AS e_name,
            e.businessemailAddress AS e_email
            FROM tbl_supplier AS s

            LEFT JOIN (
                SELECT
                *
                FROM tbl_user
            ) AS u
            ON s.user_id = u.ID

            LEFT JOIN (
                SELECT
                *
                FROM tblEnterpiseDetails
            ) AS e
            ON s.user_id = e.users_entities

            WHERE s.ID = $id" );
        if ( mysqli_num_rows($selectData) > 0 ) {
            $rowData = mysqli_fetch_array($selectData);
            $s_user_id = $rowData['s_user_id'];
            $s_notification = $rowData['s_notification'];

            $address_country = '';
            if (!empty($rowData['s_address'])) {
                $address_country = explode(', ', $rowData['s_address']);
                $address_country = $address_country[0];
            }

            // Requirement Section
            $s_document = $rowData['s_document'];
            $s_document_other = $rowData['s_document_other'];
            $requirement_email = "";
            $requirement = array();
            $selectRequirement = mysqli_query( $conn,"SELECT 
                r.name AS r_name
                FROM tbl_supplier_requirement AS r

                LEFT JOIN (
                    SELECT
                    *
                    FROM tbl_supplier_document
                    WHERE type = 0
                    AND user_id = $s_user_id
                    AND supplier_id = $id
                ) AS d
                ON r.ID = d.name

                WHERE FIND_IN_SET(r.ID, REPLACE(REPLACE('".$s_document."', ' ', ''), '|',','  )  ) > 0" );
            while($rowRequirement = mysqli_fetch_array($selectRequirement)) {
                array_push($requirement, $rowRequirement["r_name"]);
            }
            if (!empty($s_document_other)) {
                $document_other_arr = explode(" | ", $s_document_other);
                foreach ($document_other_arr as $value) {
                    $selectDocument = mysqli_query( $conn,"SELECT * FROM tbl_supplier_document WHERE type = 1 AND user_id = $s_user_id AND supplier_id = $id AND name = '".$value."'" );
                    if ( mysqli_num_rows($selectDocument) > 0 ) {
                        array_push($requirement, $value);
                    }
                }
            }
            if (!empty($requirement)) { $requirement_email = implode(' | ', $requirement); }


            // Email Compose
            $user = $rowData['s_name'];
            $to = $rowData['s_email'];

            $data_company = $rowData['u_first_name'].' '.$rowData['u_last_name'];
            if (!empty($rowData['e_name'])) { $data_company = $rowData['e_name']; }

            $data_email = $rowData['u_email'];
            if (!empty($rowData['e_email'])) { $data_email = $rowData['e_email']; }

            if ($rowData['u_client'] == 1) {
                $subject = 'Welcome to Cann OS!';
                $body_extra = '';
                $body = 'Be Green Legal, invites you to join <a href="'.$base_url.'CannOS-Login" target="_blank">Cann OS</a> to connect and share documents. If you experience difficulties opening the website, kindly use this link instead <a href="'.$base_url.'CannOS-Login" target="_blank">https://interlinkiq.com/CannOS-Login</a>.<br><br>

                Should you need assistance, kindly email <a href="mailto:nnelson@begreenlegal.com" target="_blank">nnelson@begreenlegal.com</a>.<br><br>

                Cann OS Team<br>
                BeGreen Legal';
            } else {
                $subject = $data_company.' Customer Invitation via InterlinkIQ.com';
                $body_extra = 'Hi '.$user.',<br><br>';

                $body = 'Your customer '.$data_company.', invites you to <a href="'.$base_url.'" target="_blank">InterlinkIQ.com</a> to connect and share documents to comply with Supplier Approval Program Requirements.<br><br>

                Follow the video link for the instructional video Customer Requirements Management Module - <a href="https://youtu.be/9XklXwGBr7E" target="_blank">https://youtu.be/9XklXwGBr7E</a><br><br>

                Should you need assistance, kindly call 202-982-3002 or email '.$data_email.'<br><br>

                InterlinkIQ.com Team<br>
                Consultare Inc.';
            }
            php_mailer_1($to, $user, $subject, $body_extra.$body, $data_email, $data_company);

            if (!empty($requirement_email)) {
                $subject2 = 'Supplier Approval Requirements!';
                $body2_extra = 'Hi '.$user.' Food Safety Team,<br><br>';

                if ($data_user_id == 254) {
                    $data_company = 'Jensen Meat Company (JMC)';
                    $body2 = 'We are working with '.$data_company.' as part of their Supplier Approval Program (SAP). The '.$user.' has been identified as a Supplier/Service Provider of Jensen Meat Company  Plant Based.<br><br>';
                } else {
                    $body2 = 'We are working with '.$data_company.' as part of their Supplier Approval Program (SAP). Your company has been identified as a Supplier/Service Provider of '.$data_company.'.<br><br>';
                }

                $body2 .= 'We are requesting certain documents from your firm to comply with the SAP 21 CFR 117 Subpart G - Supply-Chain Program';

                if ($address_country != 'US') { $body2 .= ' / FSVP 21 CFR Subpart L - Foreign Supplier Verification Programs for Food Importers requirement'; }

                $body2 .= '.<br><ol>';

                $requirement_arr = explode(" | ", $requirement_email);
                foreach ($requirement_arr as $value) {
                    $body2 .= '<li>'.$value.'</li>';
                }

                $body2 .= '</ol>

                Follow the instructions below:<br><br>

                To update Compliance:<br>
                <ol>
                    <li>Go to <a href="'.$base_url.'" target="_blank">https://interlinkiq.com/</a> and click Log in. Enter your Username and Password.</li>
                    <li>Once successfully logged in, click the Enterprise Module.</li>
                    <li>Click Customer Module to view the list of your Customer.</li>
                    <li>Click View and go to Requirements Tab; comply by uploading the documents required in the list.</li>
                </ol>

                Kindly see the link below for our Customer Management Tutorial Video<br><br>

                <table style="width: 100%; border-collapse: collapse;">
                    <tr>
                        <td style="border: 1px solid; padding: 5px; text-align: center;"><b>Tutorial Video</b></td>
                        <td style="border: 1px solid; padding: 5px; text-align: center;"><b>Video Link</b></td>
                    </tr>
                    <tr>
                        <td style="border: 1px solid; padding: 5px;">Free Access - Enterprise Management Module</td>
                        <td style="border: 1px solid; padding: 5px;">https://www.youtube.com/watch?v=pyhPjZKTlaE</td>
                    </tr>
                    <tr>
                        <td style="border: 1px solid; padding: 5px;">Free Access - Customer Requirements Management Module</td>
                        <td style="border: 1px solid; padding: 5px;">https://youtu.be/9XklXwGBr7E</td>
                    </tr>
                </table><br><br>

                Should you need assistance, kindly call 202-982-3002 or email '.$data_email.'<br><br>

                InterlinkIQ.com Team<br><br>
                Consultare Inc.';
    
                php_mailer_2($to, $user, $subject2, $body2_extra.$body2, $data_email, $data_company);
            }

            // Email copy for contact
            if (!empty($rowData['s_contact'])) {
                $data_contact_arr = explode(", ", $rowData['s_contact']);
                foreach ($data_contact_arr as $value) {
                    $selectContact = mysqli_query( $conn,"SELECT * FROM tbl_supplier_contact WHERE ID=$value" );
                    if ( mysqli_num_rows($selectContact) > 0 ) {
                        while($rowContact = mysqli_fetch_array($selectContact)) {
                            $to = $rowContact["email"];
                            $user = $rowContact["name"];

                            $body2_extra = 'Hi '.$user.',<br><br>';
                            if ($rowData['u_client'] == 1) { $body2_extra = ''; }

                            php_mailer_1($to, $user, $subject, $body2_extra.$body, $data_email, $data_company);

                            if (!empty($requirement_email)) {
                                $body2_extra = 'Hi '.$user.' Food Safety Team,<br><br>';

                                php_mailer_2($to, $user, $subject2, $body2_extra.$body2, $data_email, $data_company);
                            }
                        }
                    }
                }
            }
        }
    }
    if( isset($_GET['btnDelete_Supplier']) ) {
        $id = $_GET['btnDelete_Supplier'];
        mysqli_query( $conn,"UPDATE tbl_supplier set is_deleted = 1 WHERE ID = $id" );
    }
	if( isset($_POST['btnSave_Supplier']) ) {
        if (!empty($_COOKIE['switchAccount'])) {
            $portal_user = $_COOKIE['ID'];
            $user_id = $_COOKIE['switchAccount'];
        }
        else {
            $portal_user = $_COOKIE['ID'];
            $user_id = employerID($portal_user);
        }

        $current_dateNow_o = date('Y/m/d');
        $current_dateNow = new DateTime($current_dateNow_o);
        $current_dateNow = $current_dateNow->format('M d, Y');

        $supplier_name = addslashes($_POST['supplier_name']);
        $vendor_code = $_POST['vendor_code'];
        $supplier_category = $_POST['supplier_category'];
        $supplier_industry = $_POST['supplier_industry'];
        $path = 'uploads/supplier/';
        $random = rand(1000,1000000);
        $audit_arr_item = array();
        $audit_filesize = 0;
        $process = true;

        $supplier_address = array();
        array_push($supplier_address, $_POST['supplier_countries']);
        array_push($supplier_address, addslashes($_POST['supplier_address_street']));
        array_push($supplier_address,addslashes( $_POST['supplier_address_city']));
        array_push($supplier_address, addslashes($_POST['supplier_address_state']));
        array_push($supplier_address, addslashes($_POST['supplier_address_code']));
        $supplier_address = implode(" | ", $supplier_address);

        $supplier_email = addslashes($_POST['supplier_email']);
        $supplier_phone = addslashes($_POST['supplier_phone']);
        $supplier_fax = addslashes($_POST['supplier_fax']);
        $supplier_website = addslashes($_POST['supplier_website']);
        $supplier_status = $_POST['supplier_status'];
        // $supplier_notification = $_POST['supplier_notification'];
        $nda = $_POST['nda'];
        $organic = $_POST['organic'];
        $supplier_notification = 0;
        $supplier_date = date('Y-m-d');

        $supplier_frequency = $_POST['supplier_frequency'];
        $supplier_frequency_custom = array();
        array_push($supplier_frequency_custom, $_POST['supplier_frequency_minute']);
        array_push($supplier_frequency_custom, $_POST['supplier_frequency_hour']);
        array_push($supplier_frequency_custom, $_POST['supplier_frequency_day']);
        array_push($supplier_frequency_custom, $_POST['supplier_frequency_month']);
        array_push($supplier_frequency_custom, $_POST['supplier_frequency_weekday']);
        $supplier_frequency_custom = implode(" | ", $supplier_frequency_custom);

        $document = "";
        if (isset($_POST["document"])) { if (!empty($_POST["document"])) { $document = implode(" | ", $_POST["document"]); } }

        $document_other = "";
        if (isset($_POST["document_other"])) { if (!empty($_POST["document_other"])) { $document_other = implode(" | ", $_POST["document_other"]); } }

        $document_name = "";
        if (isset($_POST["document_name"])) { if (!empty($_POST["document_name"])) { $document_name = implode(" | ", $_POST["document_name"]); } }

        $document_other_name = "";
        if (isset($_POST["document_other_name"])) { if (!empty($_POST["document_other_name"])) { $document_other_name = implode(" | ", $_POST["document_other_name"]); } }

        $regulatory = "";
        if (!empty($_POST["regulatory"])) { $regulatory = implode(", ", $_POST["regulatory"]); }

        $contact = "";
        if (!empty($_POST["contact_id"])) { $contact = implode(", ", $_POST["contact_id"]); }

        $material = "";
        if (!empty($_POST["material_id"])) { $material = implode(", ", $_POST["material_id"]); }

        $service = "";
        if (!empty($_POST["service_id"])) { $service = implode(", ", $_POST["service_id"]); }

        $audit_report = array();
        $audit_report_validity = $_POST['audit_report_validity'];
        $audit_report_validity = explode(' - ', $audit_report_validity);
        $audit_report_validity_start = !empty($audit_report_validity[0]) ? $audit_report_validity[0] : '';
        $audit_report_validity_end = !empty($audit_report_validity[1]) ? $audit_report_validity[1] : '';
        $audit_report_file = $_FILES['audit_report_file']['name'];
        if (!empty($audit_report_file)) {
            $audit_filesize = $_FILES['audit_report_file']['size'];
            $audit_report_file_tmp = $_FILES['audit_report_file']['tmp_name'];
            $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
            $ext = strtolower(pathinfo($audit_report_file, PATHINFO_EXTENSION));
            $audit_report_file = $random.' - '.$audit_report_file;
            $audit_report_file_path = $path.$audit_report_file;

            if(!in_array($ext, $invalid_extensions)) {
                move_uploaded_file($audit_report_file_tmp, $audit_report_file_path);
                array_push($audit_report, $audit_report_file);

                $output = array (
                    'type'  =>  1,
                    'name' =>  $audit_report_file,
                    'size' =>  $audit_filesize,
                    'date' =>  $local_date
                );
                array_push($audit_arr_item, $output);
            } else {
                $process = false;
            }   
        } else {
            array_push($audit_report, '');
        }
        array_push($audit_report, $audit_report_validity_start);
        array_push($audit_report, $audit_report_validity_end);
        array_push($audit_report, addslashes($_POST['audit_report_note']));
        $audit_report = implode(" | ", $audit_report);

        $audit_certificate = array();
        $audit_certificate_validity = $_POST['audit_certificate_validity'];
        $audit_certificate_validity = explode(' - ', $audit_certificate_validity);
        $audit_certificate_validity_start = !empty($audit_certificate_validity[0]) ? $audit_certificate_validity[0] : '';
        $audit_certificate_validity_end = !empty($audit_certificate_validity[1]) ? $audit_certificate_validity[1] : '';
        $audit_certificate_file = $_FILES['audit_certificate_file']['name'];
        if (!empty($audit_certificate_file)) {
            $audit_filesize = $_FILES['audit_certificate_file']['size'];
            $audit_certificate_file_tmp = $_FILES['audit_certificate_file']['tmp_name'];
            $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
            $ext = strtolower(pathinfo($audit_certificate_file, PATHINFO_EXTENSION));
            $audit_certificate_file = $random.' - '.$audit_certificate_file;
            $audit_certificate_file_path = $path.$audit_certificate_file;

            if(!in_array($ext, $invalid_extensions)) {
                move_uploaded_file($audit_certificate_file_tmp, $audit_certificate_file_path);
                array_push($audit_certificate, $audit_certificate_file);

                $output = array (
                    'type'  =>  2,
                    'name' =>  $audit_certificate_file,
                    'size' =>  $audit_filesize,
                    'date' =>  $local_date
                );
                array_push($audit_arr_item, $output);
            } else {
                $process = false;
            }
        } else {
            array_push($audit_certificate, '');
        }
        array_push($audit_certificate, $audit_certificate_validity_start);
        array_push($audit_certificate, $audit_certificate_validity_end);
        array_push($audit_certificate, addslashes($_POST['audit_certificate_note']));
        $audit_certificate = implode(" | ", $audit_certificate);

        $audit_action = array();
        $audit_action_validity = $_POST['audit_action_validity'];
        $audit_action_validity = explode(' - ', $audit_action_validity);
        $audit_action_validity_start = !empty($audit_action_validity[0]) ? $audit_action_validity[0] : '';
        $audit_action_validity_end = !empty($audit_action_validity[1]) ? $audit_action_validity[1] : '';
        $audit_action_file = $_FILES['audit_action_file']['name'];
        if (!empty($audit_action_file)) {
            $audit_filesize = $_FILES['audit_action_file']['size'];
            $audit_action_file_tmp = $_FILES['audit_action_file']['tmp_name'];
            $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
            $ext = strtolower(pathinfo($audit_action_file, PATHINFO_EXTENSION));
            $audit_action_file = $random.' - '.$audit_action_file;
            $audit_action_file_path = $path.$audit_action_file;

            if(!in_array($ext, $invalid_extensions)) {
                move_uploaded_file($audit_action_file_tmp, $audit_action_file_path);
                array_push($audit_action, $audit_action_file);

                $output = array (
                    'type'  =>  3,
                    'name' =>  $audit_action_file,
                    'size' =>  $audit_filesize,
                    'date' =>  $local_date
                );
                array_push($audit_arr_item, $output);
            } else {
                $process = false;
            }
        } else {
            array_push($audit_action, '');
        }
        array_push($audit_action, $audit_action_validity_start);
        array_push($audit_action, $audit_action_validity_end);
        array_push($audit_action, addslashes($_POST['audit_action_note']));
        $audit_action = implode(" | ", $audit_action);
        $audit_file_history = json_encode($audit_arr_item, JSON_HEX_APOS | JSON_UNESCAPED_UNICODE);

        $audit = $_POST['audit'];
        $reviewed_by = addslashes($_POST['reviewed_by']);
        $reviewed_validity = $_POST['reviewed_validity'];
        $reviewed_validity = explode(' - ', $reviewed_validity);
        $reviewed_date = !empty($reviewed_validity[0]) ? $reviewed_validity[0] : '';
        $reviewed_due = !empty($reviewed_validity[1]) ? $reviewed_validity[1] : '';

        $audit_score = $_POST['audit_score'];

        if ($process == true) {
            $sql = "INSERT INTO tbl_supplier (user_id, portal_user, page, name, vendor_code, address, phone, fax, email, website, category, industry, regulatory, contact, document, document_other, material, service, audit, audit_report, audit_certificate, audit_action, audit_filesize, audit_file_history, audit_score, reviewed_by, reviewed_date, reviewed_due, status, notification, nda, organic, frequency, frequency_custom, last_modified)
            VALUES ('$user_id', '$portal_user', '1', '$supplier_name',  '$vendor_code','$supplier_address', '$supplier_phone', '$supplier_fax', '$supplier_email', '$supplier_website', '$supplier_category', '$supplier_industry', '$regulatory', '$contact', '$document_name', '$document_other_name', '$material', '$service', '$audit', '$audit_report', '$audit_certificate', '$audit_action', '$audit_filesize', '$audit_file_history', '$audit_score', '$reviewed_by', '$reviewed_date', '$reviewed_due', '$supplier_status', '$supplier_notification', '$nda', '$organic', '$supplier_frequency', '$supplier_frequency_custom', '$supplier_date')";
            if (mysqli_query($conn, $sql)) {
                $last_id = mysqli_insert_id($conn);

                $selectData = mysqli_query( $conn,'SELECT * FROM tbl_supplier WHERE user_id="'. $user_id .'" AND ID="'. $last_id .'" ORDER BY ID LIMIT 1' );
                if ( mysqli_num_rows($selectData) > 0 ) {
                    $rowData = mysqli_fetch_array($selectData);
                    $data_ID = $rowData['ID'];
                    $data_page = $rowData['page'];
                    $data_user_id = $rowData["user_id"];
                    $data_name = $rowData['name'];
                    $data_document_other = $rowData['document_other'];
                    $data_reviewed_due = $rowData['reviewed_due'];
                    $data_status = $rowData["status"];
                    $data_notification = $rowData["notification"];
                    $data_status_type = array(
                        0 => 'Pending',
                        1 => 'Approved',
                        2 => 'Non Approved',
                        3 => 'Emergency Use Only',
                        4 => 'Do Not Use'
                    );

                    $contact_name = '';
                    $contact_address = '';
                    $contact_info = '';
                    $data_contact = $rowData["contact"];
                    if (!empty($data_contact)) {
                        $contact_arr = explode(", ", $data_contact);
                        foreach ($contact_arr as $value) {
                            $selectContact = mysqli_query( $conn,"SELECT * FROM tbl_supplier_contact WHERE ID=$value" );
                            if ( mysqli_num_rows($selectContact) > 0 ) {
                                $rowContact = mysqli_fetch_array($selectContact);
                                $contact_name = $rowContact["name"];
                                $contact_address = $rowContact["address"];
                                $contact_email = $rowContact["email"];
                                $contact_phone = $rowContact["phone"];
                                $contact_cell = $rowContact["cell"];
                                $contact_fax = $rowContact["fax"];

                                $contact_info = '<ul class="list-inline">';
                                    if ($contact_email != "") { $contact_info .= '<li><a href="mailto:'.$contact_email.'" target="_blank" title="Email"><i class="fa fa-envelope"></i></a></li>'; }
                                    if ($contact_phone != "") { $contact_info .= '<li><a href="tel:'.$contact_phone.'" target="_blank" title="Phone"><i class="fa fa-phone-square"></i></a></li>'; }
                                    if ($contact_cell != "") { $contact_info .= '<li><a href="tel:'.$contact_cell.'" target="_blank" title="Cell Number"><i class="fa fa-phone"></i></a></li>'; }
                                    if ($contact_fax != "") { $contact_info .= '<li><a href="tel:'.$contact_fax.'" target="_blank" title="Fax"><i class="fa fa-print"></i></a></li>'; }
                                $contact_info .= '</ul>';

                                break;
                            }
                        }
                    }

                    // Document Section
                    $path = 'uploads/supplier/';
                    $random = rand(1000,1000000);
                    if (isset($_POST["document_name"])) {
                        if (!empty($_POST["document_name"])) {
                            for ($i=0; $i < count($_POST["document_name"]); $i++) {
                                $document_names = addslashes($_POST["document_name"][$i]);
                                $document_filename = addslashes($_POST["document_filename"][$i]);
                                // $document_date = $_POST["document_date"][$i];
                                // $document_due = $_POST["document_due"][$i];
                                $document_comment = addslashes($_POST["document_comment"][$i]);
                                $arr_item = array();
                                $filesize = 0;

                                $document_date = '';
                                $document_due = '';
                                $document_daterange = $_POST["document_daterange"][$i];
                                if (!empty($document_daterange)) {
                                    $document_daterange = explode(' - ', $document_daterange);
                                    $document_date = $document_daterange[0];
                                    $document_due = $document_daterange[1];
                                }

                                $document_filetype = $_POST["document_filetype"][$i];
                                if ($document_filetype == 1) {
                                    $files = $_FILES['document_file']['name'][$i];
                                    $file_docs = "";
                                    if (!empty($files)) {
                                        $filesize = $_FILES['document_file']['size'][$i];
                                        $tmp_docs = $_FILES['document_file']['tmp_name'][$i];
                                        $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                                        $ext = strtolower(pathinfo($files, PATHINFO_EXTENSION));
                                        $file_docs = $random.' - '.$files;
                                        $path_docs = $path.$file_docs;

                                        if(!in_array($ext, $invalid_extensions)) {
                                            move_uploaded_file($tmp_docs,$path_docs);
                                        } else {
                                            $process = false;
                                        }
                                    }
                                } else {
                                    $file_docs = $_POST["document_fileurl"][$i];
                                }

                                $output = array (
                                    'type' =>  $document_filetype,
                                    'name' =>  $file_docs,
                                    'size' =>  $filesize,
                                    'date' =>  $local_date
                                );
                                array_push($arr_item, $output);
                                
                                $files_template = $_FILES['document_template']['name'][$i];
                                $file_docs_template = "";
                                if (!empty($files_template)) {
                                    $filesize = $_FILES['document_template']['size'][$i];
                                    $tmp_docs = $_FILES['document_template']['tmp_name'][$i];
                                    $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                                    $ext = strtolower(pathinfo($files_template, PATHINFO_EXTENSION));
                                    $file_docs_template = $random.' - '.$files_template;
                                    $path_docs = $path.$file_docs;

                                    if(!in_array($ext, $invalid_extensions)) {
                                        move_uploaded_file($tmp_docs,$path_docs);

                                        $output = array (
                                            'type'  =>  0,
                                            'name' =>  $file_docs_template,
                                            'size' =>  $filesize,
                                            'date' =>  $local_date
                                        );
                                        array_push($arr_item, $output);
                                    } else {
                                        $process = false;
                                    }

                                }
                                $file_history = json_encode($arr_item, JSON_HEX_APOS | JSON_UNESCAPED_UNICODE);

                                if ($process == true) {
                                    $sql = "INSERT INTO tbl_supplier_document (user_id, portal_user, supplier_id, name, file, filetype, filesize, file_history, filename, file_date, file_due, template)
                                    VALUES ('$user_id', '$portal_user', '$data_ID', '$document_names', '$file_docs', '$document_filetype', '$filesize', '$file_history', '$document_filename', '$document_date', '$document_due', '$file_docs_template')";
                                    if (mysqli_query($conn, $sql)) {
                                        $supplier_document_last_id = mysqli_insert_id($conn);

                                        if (!empty($document_comment)) {
                                            $sql = "INSERT INTO tbl_supplier_comment (user_id, portal_user, supplier_document_id, comment, last_modified)
                                            VALUES ('$user_id', '$portal_user', '$supplier_document_last_id', '$document_comment', '$supplier_date')";
                                            mysqli_query($conn, $sql);
                                        }
                                    }
                                }
                            }
                        }
                    }
                    if (isset($_POST["document_other_name"])) {
                        if (!empty($_POST["document_other_name"])) {
                            for ($i=0; $i < count($_POST["document_other_name"]); $i++) {
                                $document_names = addslashes($_POST["document_other_name"][$i]);
                                $document_filename = addslashes($_POST["document_other_filename"][$i]);
                                // $document_date = $_POST["document_other_date"][$i];
                                // $document_due = $_POST["document_other_due"][$i];
                                $document_comment = addslashes($_POST["document_other_comment"][$i]);
                                $arr_item = array();
                                $filesize = 0;

                                $document_date = '';
                                $document_due = '';
                                $document_other_daterange = $_POST["document_other_daterange"][$i];
                                if (!empty($document_other_daterange)) {
                                    $document_other_daterange = explode(' - ', $document_other_daterange);
                                    $document_date = $document_other_daterange[0];
                                    $document_due = $document_other_daterange[1];
                                }

                                $document_filetype = $_POST["document_other_filetype"][$i];
                                if ($document_filetype == 1) {
                                    $files = $_FILES['document_other_file']['name'][$i];
                                    $file_docs = "";
                                    if (!empty($files)) {
                                        $filesize = $_FILES['document_other_file']['size'][$i];
                                        $tmp_docs = $_FILES['document_other_file']['tmp_name'][$i];
                                        $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                                        $ext = strtolower(pathinfo($files, PATHINFO_EXTENSION));
                                        $file_docs = $random.' - '.$files;
                                        $path_docs = $path.$file_docs;

                                        if(!in_array($ext, $invalid_extensions)) {
                                            move_uploaded_file($tmp_docs,$path_docs);
                                        } else {
                                            $process = false;
                                        }
                                    }
                                } else {
                                    $file_docs = $_POST["document_other_fileurl"][$i];
                                }

                                $output = array (
                                    'type' =>  $document_filetype,
                                    'name' =>  $file_docs,
                                    'size' =>  $filesize,
                                    'date' =>  $local_date
                                );
                                array_push($arr_item, $output);
                                
                                $files_template = $_FILES['document_other_template']['name'][$i];
                                $file_docs_template = "";
                                if (!empty($files_template)) {
                                    $filesize = $_FILES['document_other_template']['size'][$i];
                                    $tmp_docs = $_FILES['document_other_template']['tmp_name'][$i];
                                    $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                                    $ext = strtolower(pathinfo($files, PATHINFO_EXTENSION));
                                    $file_docs_template = $random.' - '.$files_template;
                                    $path_docs = $path.$file_docs_template;

                                    if(!in_array($ext, $invalid_extensions)) {
                                        move_uploaded_file($tmp_docs,$path_docs);

                                        $output = array (
                                            'type' =>  0,
                                            'name' =>  $file_docs_template,
                                            'size' =>  $filesize,
                                            'date' =>  $local_date
                                        );
                                        array_push($arr_item, $output);
                                    } else {
                                        $process = false;
                                    }
                                }
                                $file_history = json_encode($arr_item, JSON_HEX_APOS | JSON_UNESCAPED_UNICODE);

                                if ($process == true) {
                                    $sql = "INSERT INTO tbl_supplier_document (user_id, portal_user, supplier_id, type, name, file, filetype, filesize, file_history, filename, file_date, file_due, template)
                                    VALUES ('$user_id', '$portal_user', '$data_ID', '1', '$document_names', '$file_docs', '$document_filetype', '$filesize', '$file_history', '$document_filename', '$document_date', '$document_due', '$file_docs_template')";
                                    if (mysqli_query($conn, $sql)) {
                                        $supplier_document_last_id = mysqli_insert_id($conn);

                                        if (!empty($document_comment)) {
                                            $sql = "INSERT INTO tbl_supplier_comment (user_id, portal_user, supplier_document_id, comment, last_modified)
                                            VALUES ('$user_id', '$portal_user', '$supplier_document_last_id', '$document_comment', '$supplier_date')";
                                            mysqli_query($conn, $sql);
                                        }
                                    }
                                }
                            }
                        }
                    }

                    if ($process == true) {

                        // Requirement Section
                        // $requirement = array();
                        // $selectRequirement = mysqli_query( $conn,"SELECT * FROM tbl_supplier_requirement" );
                        // while($rowRequirement = mysqli_fetch_array($selectRequirement)) {
                        //     $data_document_arr = explode(", ", $rowData["document"]);
                        //     foreach ($data_document_arr as $value) {
                        //         if ( $value == $rowRequirement["ID"] ) {
                        //             array_push($requirement, $rowRequirement["name"]);
                        //         }
                        //     }
                        // }
                        // $requirement = implode(', ', $requirement);
                        // if (!empty($data_document_other)) { $requirement .= ", ". $data_document_other; }


                        // Requirement Section
                        $requirement = array();
                        $requirement_email = "";
                        // $selectRequirement = mysqli_query( $conn,"SELECT * FROM tbl_supplier_requirement" );
                        $selectRequirement = mysqli_query( $conn,"SELECT
                            d_ID,
                            d_name,
                            d_file,
                            r_ID,
                            r_name,
                            s.ID AS s_ID,
                            s.name AS s_name
                            FROM (
                                SELECT
                                d.ID AS d_ID,
                                d.name AS d_name,
                                d.file AS d_file,
                                r.ID AS r_ID,
                                r.name AS r_name
                                FROM tbl_supplier_document AS d

                                INNER JOIN (
                                    SELECT
                                    *
                                    FROM tbl_supplier_requirement
                                ) AS r
                                ON d.name = r.ID

                                WHERE d.type = 0
                                AND LENGTH(d.file) = 0
                                AND d.user_id = $data_user_id
                                AND d.supplier_id = $data_ID
                            ) AS o

                            LEFT JOIN (
                                SELECT
                                *
                                FROM tbl_supplier
                            ) AS s
                            ON FIND_IN_SET(o.r_ID, REPLACE(REPLACE(s.document, ' ', ''), '|',','  )  ) > 0

                            WHERE s.ID = $data_ID" );
                        while($rowRequirement = mysqli_fetch_array($selectRequirement)) {
                            array_push($requirement, $rowRequirement["r_name"]);

                            // $data_document_arr = explode(" | ", $rowData["document"]);
                            // foreach ($data_document_arr as $value) {
                            //     if ( $value == $rowRequirement["ID"] ) {
                            //         array_push($requirement, $rowRequirement["name"]);
                            //     }
                            // }
                        }
                        // if (!empty($requirement)) { $requirement_email = implode(' | ', $requirement); }

                        $compliance = 0;
                        $compliance_counter = 0;
                        $compliance_approved = 0;
                        if (!empty($_POST["document"])) {
                            $selectRequirement = mysqli_query( $conn,"SELECT * FROM tbl_supplier_requirement ORDER BY name" );
                            while($rowRequirement = mysqli_fetch_array($selectRequirement)) {
                                $req_id = $rowRequirement["ID"];
                                $req_name = $rowRequirement["name"];

                                $document_arr = implode(" | ", $_POST["document"]);
                                $document_arr = explode(" | ", $document_arr);
                                foreach ($document_arr as $value) {
                                    if ( $value == $req_id ) {
                                        $selectDocument = mysqli_query( $conn,"SELECT * FROM tbl_supplier_document WHERE user_id='".$data_user_id."' AND supplier_id='".$data_ID."' AND name='".$req_id."'" );
                                        if ( mysqli_num_rows($selectDocument) > 0 ) {
                                            $rowDocument = mysqli_fetch_array($selectDocument);
                                            $doc_file_approved = $rowDocument["approved_by"];

                                            $compliance_counter++;
                                            // if ($doc_file_approved > 0) { $compliance_approved++; }

                                            $doc_file_due = $rowDocument["file_due"];
                                            if (!empty($doc_file_due)) {
                                                $doc_file_due = new DateTime($doc_file_due);
                                                $doc_file_due_o = $doc_file_due->format('Y/m/d');
                                                $doc_file_due_o_nearly = date('Y/m/d', strtotime($doc_file_due_o. ' - 30 days'));
                                                $doc_file_due = $doc_file_due->format('m/d/Y');

                                                if ($doc_file_due_o >= $current_dateNow_o && $doc_file_approved > 0) { $compliance_approved++; }
                                            };
                                        }
                                    }
                                }
                            }
                        }

                        // $requirement = implode(' | ', $requirement);
                        if (!empty($data_document_other)) {
                            // $requirement .= " | ". $data_document_other;

                            // $data_document_other_arr = array();
                            // $data_document_other_arr = explode(' | ', $data_document_other);
                            // $data_document_other_arr = implode(' | ', $data_document_other_arr);
                            // $requirement_email .= " | ". $data_document_other_arr;

                            $document_other_arr = implode(" | ", $_POST["document_other"]);
                            $document_other_arr = explode(" | ", $document_other_arr);
                            foreach ($document_other_arr as $value) {
                                // $selectDocument = mysqli_query( $conn,"SELECT * FROM tbl_supplier_document WHERE user_id='".$data_user_id."' AND supplier_id='".$data_ID."' AND name='".$value."'" );
                                $selectDocument = mysqli_query( $conn,"SELECT * FROM tbl_supplier_document WHERE type = 1 AND user_id = $data_user_id AND supplier_id = $data_ID AND name = '".$value."'" );
                                if ( mysqli_num_rows($selectDocument) > 0 ) {
                                    $rowDocument = mysqli_fetch_array($selectDocument);
                                    $doc_file_approved = $rowDocument["approved_by"];

                                    if (empty($rowDocument["file"])) {
                                        array_push($requirement, $value);
                                    }

                                    $compliance_counter++;
                                    // if ($doc_file_approved > 0) { $compliance_approved++; }

                                    $doc_file_due = $rowDocument["file_due"];
                                    if (!empty($doc_file_due)) {
                                        $doc_file_due = new DateTime($doc_file_due);
                                        $doc_file_due_o = $doc_file_due->format('Y/m/d');
                                        $doc_file_due_o_nearly = date('Y/m/d', strtotime($doc_file_due_o. ' - 30 days'));
                                        $doc_file_due = $doc_file_due->format('m/d/Y');

                                        if ($doc_file_due_o >= $current_dateNow_o && $doc_file_approved > 0) { $compliance_approved++; }
                                    };
                                }
                            }
                        }
                        if (!empty($requirement)) { $requirement_email = implode(' | ', $requirement); }

                        if ($compliance_counter > 0) { $compliance = intval(($compliance_approved / $compliance_counter) * 100); }
                        else { $compliance = 0; }
                        mysqli_query( $conn,"UPDATE tbl_supplier set compliance = $compliance WHERE ID = $data_ID" );

                        // Category Section
                        $data_category_id = $rowData['category'];
                        $selectCategory = mysqli_query( $conn,'SELECT * FROM tbl_supplier_category WHERE ID="'. $data_category_id .'" ORDER BY ID LIMIT 1' );
                        $rowCategory = mysqli_fetch_array($selectCategory);
                        $data_category = $rowCategory['name'];

                        if ($data_category_id == "3") {

                            // Service Section
                            $data_material = $rowData['service'];
                            $material_arr = array();
                            if (!empty($data_material)) {
                                $data_material_arr = explode(", ", $data_material);
                                foreach ($data_material_arr as $value) {
                                    $selectMaterial = mysqli_query( $conn,"SELECT * FROM tbl_supplier_service WHERE ID=$value" );
                                    if ( mysqli_num_rows($selectMaterial) > 0 ) {
                                        while($rowMaterial = mysqli_fetch_array($selectMaterial)) {
                                            array_push($material_arr, $rowMaterial["service_name"]);
                                        }
                                    }
                                }
                                $data_material = implode(', ', $material_arr);
                            }
                        } else {

                            // Material Section
                            $data_material = $rowData['material'];
                            $material_arr = array();
                            if (!empty($data_material)) {
                                $data_material_arr = explode(", ", $data_material);
                                foreach ($data_material_arr as $value) {
                                    $selectMaterial = mysqli_query( $conn,"SELECT * FROM tbl_supplier_material WHERE ID=$value" );
                                    if ( mysqli_num_rows($selectMaterial) > 0 ) {
                                        while($rowMaterial = mysqli_fetch_array($selectMaterial)) {
                                            array_push($material_arr, $rowMaterial["material_name"]);
                                        }
                                    }
                                }
                                $data_material = implode(', ', $material_arr);
                            }
                        }
                        
                        $address_array = array();
                        $address = $rowData["address"];
                        $address_arr = explode(" | ", $address);
                        if (COUNT($address_arr) < 5) {
                            $address_arr = explode(", ", $address);
                        }
                        array_push($address_array, htmlentities($address_arr[1]));
                        array_push($address_array, htmlentities($address_arr[2]));
                        array_push($address_array, htmlentities($address_arr[3]));
                        array_push($address_array, $address_arr[0]);
                        array_push($address_array, $address_arr[4]);
                        $address_arr = implode(", ", $address_array);

                        $counterup_tbl = counterup_tbl('supplier');
                        $output = array(
                            "ID" => $data_ID,
                            "page" => $data_page,
                            "supplier_name" => htmlentities($data_name ?? ''),
                            "category" => htmlentities($data_category ?? ''),
                            "material" => htmlentities($data_material ?? ''),
                            "address" => $address_arr,
                            "contact_name" => htmlentities($contact_name ?? ''),
                            "contact_address" => htmlentities($contact_address ?? ''),
                            "contact_info" => $contact_info,
                            "reviewed_due" => $data_reviewed_due,
                            "compliance" => $compliance,
                            "status" => $data_status_type[$data_status]
                        );
                        $result = array_merge($counterup_tbl, $output);

                        if ($data_notification == 1) {
                            $data_company = "";
                            $data_email = "";
                            $selectEnterprise = mysqli_query( $conn,"SELECT * FROM tblEnterpiseDetails WHERE users_entities = $user_id" );
                            if ( mysqli_num_rows($selectEnterprise) > 0 ) {
                                $rowEnterprise = mysqli_fetch_array($selectEnterprise);
                                $data_company = $rowEnterprise["businessname"];
                                $data_email = $rowEnterprise["businessemailAddress"];
                            }

                            $to = $supplier_email;
                            $user = $supplier_name;

                            if ($_COOKIE['client'] == 1) {
                                $subject = 'Welcome to Cann OS!';
                                $body = 'Be Green Legal, invites you to join <a href="'.$base_url.'CannOS-Login" target="_blank">Cann OS</a> to connect and share documents. If you experience difficulties opening the website, kindly use this link instead <a href="'.$base_url.'CannOS-Login" target="_blank">https://interlinkiq.com/CannOS-Login</a>.<br><br>

                                Should you need assistance, kindly email <a href="mailto:nnelson@begreenlegal.com" target="_blank">nnelson@begreenlegal.com</a>.<br><br>

                                Cann OS Team<br>
                                BeGreen Legal';
                            } else if ($_COOKIE['client'] == 2) {
                                $subject = 'Welcome to Cann OS!';
                                $body = 'Food Safety 360, invites you to join <a href="'.$base_url.'FoodSafety360" target="_blank">Food Safe</a> to connect and share documents. If you experience difficulties opening the website, kindly use this link instead <a href="'.$base_url.'FoodSafety360" target="_blank">https://interlinkiq.com/FoodSafety360</a>.<br><br>

                                Should you need assistance, kindly email <a href="mailto:foodsafety360r@gmail.com" target="_blank">foodsafety360r@gmail.com</a>.<br><br>

                                FoodSafety360 Team';
                            } else if ($_COOKIE['client'] == 3) {
                                $subject = 'Welcome to Cann OS!';
                                $body = 'Food Safety 360, invites you to join <a href="'.$base_url.'SafeCannabis360" target="_blank">Food Safe</a> to connect and share documents. If you experience difficulties opening the website, kindly use this link instead <a href="'.$base_url.'SafeCannabis360" target="_blank">https://interlinkiq.com/SafeCannabis360</a>.<br><br>

                                Should you need assistance, kindly email <a href="mailto:cannabis360r@gmail.com" target="_blank">cannabis360r@gmail.com</a>.<br><br>

                                SafeCannabis360 Team';
                            } else if ($_COOKIE['client'] == 4) {
                                $subject = 'Welcome to Cann OS!';
                                $body = 'Food Safety 360, invites you to join <a href="'.$base_url.'Exim360" target="_blank">Food Safe</a> to connect and share documents. If you experience difficulties opening the website, kindly use this link instead <a href="'.$base_url.'Exim360" target="_blank">https://interlinkiq.com/Exim360</a>.<br><br>

                                Should you need assistance, kindly email <a href="mailto:exim360r@gmail.com" target="_blank">exim360r@gmail.com</a>.<br><br>

                                Exim360 Team';
                            } else {
                                $subject = $data_company.' Customer Invitation via InterlinkIQ.com';
                                $body = 'Hi '.$user.',<br><br>

                                Your customer '.$data_company.', invites you to <a href="'.$base_url.'" target="_blank">InterlinkIQ.com</a> to connect and share documents to comply with Supplier Approval Program Requirements.<br><br>

                                Follow the video link for the instructional video Customer Requirements Management Module - <a href="https://youtu.be/9XklXwGBr7E" target="_blank">https://youtu.be/9XklXwGBr7E</a><br><br>

                                Should you need assistance, kindly call 202-982-3002 or email '.$data_email.'<br><br>

                                InterlinkIQ.com Team<br>
                                Consultare Inc.';
                            }
                            php_mailer_1($to, $user, $subject, $body, $data_email, $data_company);

                            // Adding SAP Requirements
                            if (!empty($requirement_email)) {
                                $to = $supplier_email;
                                $user = $supplier_name;
                                $subject = 'Supplier Approval Requirements!';
                                $body = 'Hi '.$user.' Food Safety Team,<br><br>';

                                if ($user_id == 254) {
                                    $data_company = 'Jensen Meat Company (JMC)';
                                    $body .= 'We are working with '.$data_company.' as part of their Supplier Approval Program (SAP). The '.$user.' has been identified as a Supplier/Service Provider of Jensen Meat Company  Plant Based.<br><br>';
                                } else {
                                    $body .= 'We are working with '.$data_company.' as part of their Supplier Approval Program (SAP). Your company has been identified as a Supplier/Service Provider of '.$data_company.'.<br><br>';
                                }

                                $body .= 'We are requesting certain documents from your firm to comply with the SAP 21 CFR 117 Subpart G - Supply-Chain Program';

                                if ($_POST['supplier_countries'] != 'US') { $body .= ' / FSVP 21 CFR Subpart L - Foreign Supplier Verification Programs for Food Importers requirement'; }

                                $body .= '.<br><ol>';

                                $requirement_arr = explode(" | ", $requirement_email);
                                foreach ($requirement_arr as $value) {
                                    $body .= '<li>'.$value.'</li>';
                                }

                                $body .= '</ol>

                                Follow the instructions below:<br><br>

                                To update Compliance:<br>
                                <ol>
                                    <li>Go to <a href="'.$base_url.'" target="_blank">https://interlinkiq.com/</a> and click Log in. Enter your Username and Password.</li>
                                    <li>Once successfully logged in, click the Enterprise Module.</li>
                                    <li>Click Customer Module to view the list of your Customer.</li>
                                    <li>Click View and go to Requirements Tab; comply by uploading the documents required in the list.</li>
                                </ol>

                                Kindly see the link below for our Customer Management Tutorial Video<br><br>

                                <table style="width: 100%; border-collapse: collapse;">
                                    <tr>
                                        <td style="border: 1px solid; padding: 5px; text-align: center;"><b>Tutorial Video</b></td>
                                        <td style="border: 1px solid; padding: 5px; text-align: center;"><b>Video Link</b></td>
                                    </tr>
                                    <tr>
                                        <td style="border: 1px solid; padding: 5px;">Free Access - Enterprise Management Module</td>
                                        <td style="border: 1px solid; padding: 5px;">https://www.youtube.com/watch?v=pyhPjZKTlaE</td>
                                    </tr>
                                    <tr>
                                        <td style="border: 1px solid; padding: 5px;">Free Access - Customer Requirements Management Module</td>
                                        <td style="border: 1px solid; padding: 5px;">https://youtu.be/9XklXwGBr7E</td>
                                    </tr>
                                </table><br><br>

                                Should you need assistance, kindly call 202-982-3002 or email '.$data_email.'<br><br>

                                InterlinkIQ.com Team<br><br>
                                Consultare Inc.';
                    
                                php_mailer_2($to, $user, $subject, $body, $data_email, $data_company);
                            }
                
                            // Contact Section
                            $data_contact = $rowData['contact'];
                            if (!empty($data_contact)) {
                                $data_contact_arr = explode(", ", $data_contact);
                                foreach ($data_contact_arr as $value) {
                                    $selectContact = mysqli_query( $conn,"SELECT * FROM tbl_supplier_contact WHERE notification = 1 AND ID = $value" );
                                    if ( mysqli_num_rows($selectContact) > 0 ) {
                                        while($rowContact = mysqli_fetch_array($selectContact)) {
                                            $contact_name = $rowContact["name"];
                                            $contact_email = $rowContact["email"];
                            
                                            $to = $contact_email;
                                            $user = $contact_name;

                                            if ($_COOKIE['client'] == 1) {
                                                $subject = 'Welcome to Cann OS!';
                                                $body = 'Be Green Legal, invites you to join <a href="'.$base_url.'CannOS-Login" target="_blank">Cann OS</a> to connect and share documents. If you experience difficulties opening the website, kindly use this link instead <a href="'.$base_url.'CannOS-Login" target="_blank">https://interlinkiq.com/CannOS-Login</a>.<br><br>

                                                Should you need assistance, kindly email <a href="mailto:nnelson@begreenlegal.com" target="_blank">nnelson@begreenlegal.com</a>.<br><br>

                                                Cann OS Team<br>
                                                BeGreen Legal';
                                            } else if ($_COOKIE['client'] == 2) {
                                                $subject = 'Welcome to Cann OS!';
                                                $body = 'Food Safety, invites you to join <a href="'.$base_url.'FoodSafety360" target="_blank">Food Safe</a> to connect and share documents. If you experience difficulties opening the website, kindly use this link instead <a href="'.$base_url.'FoodSafety360" target="_blank">https://interlinkiq.com/FoodSafety360</a>.<br><br>

                                                Should you need assistance, kindly email <a href="mailto:foodsafety360r@gmail.com" target="_blank">foodsafety360r@gmail.com</a>.<br><br>

                                                FoodSafety360 Team';
                                            } else if ($_COOKIE['client'] == 3) {
                                                $subject = 'Welcome to Cann OS!';
                                                $body = 'Food Safety, invites you to join <a href="'.$base_url.'SafeCannabis360" target="_blank">Food Safe</a> to connect and share documents. If you experience difficulties opening the website, kindly use this link instead <a href="'.$base_url.'SafeCannabis360" target="_blank">https://interlinkiq.com/SafeCannabis360</a>.<br><br>

                                                Should you need assistance, kindly email <a href="mailto:cannabis360r@gmail.com" target="_blank">cannabis360r@gmail.com</a>.<br><br>

                                                SafeCannabis360 Team';
                                            } else if ($_COOKIE['client'] == 4) {
                                                $subject = 'Welcome to Cann OS!';
                                                $body = 'Food Safety, invites you to join <a href="'.$base_url.'Exim360" target="_blank">Food Safe</a> to connect and share documents. If you experience difficulties opening the website, kindly use this link instead <a href="'.$base_url.'Exim360" target="_blank">https://interlinkiq.com/Exim360</a>.<br><br>

                                                Should you need assistance, kindly email <a href="mailto:exim360r@gmail.com" target="_blank">exim360r@gmail.com</a>.<br><br>

                                                Exim360 Team';
                                            } else {
                                                $subject = $data_company.' Customer Invitation via InterlinkIQ.com';
                                                $body = 'Hi '.$user.',<br><br>

                                                Your customer '.$data_company.', invites you to <a href="'.$base_url.'" target="_blank">InterlinkIQ.com</a> to connect and share documents to comply with Supplier Approval Program Requirements.<br><br>

                                                Follow the video link for the instructional video Customer Requirements Management Module - <a href="https://youtu.be/9XklXwGBr7E" target="_blank">https://youtu.be/9XklXwGBr7E</a><br><br>

                                                Should you need assistance, kindly call 202-982-3002 or email '.$data_email.'<br><br>

                                                InterlinkIQ.com Team<br>
                                                Consultare Inc.';
                                            }
                                            php_mailer_2($to, $user, $subject, $body, $data_email, $data_company);


                                            // Adding SAP Requirements
                                            if (!empty($requirement_email)) {
                                                $to = $contact_email;
                                                $user = $contact_name;
                                                $subject = 'Supplier Approval Requirements!';
                                                $body = 'Hi '.$user.' Food Safety Team,<br><br>';

                                                if ($user_id == 254) {
                                                    $data_company = 'Jensen Meat Company (JMC)';
                                                    $body .= 'We are working with '.$data_company.' as part of their Supplier Approval Program (SAP). The '.$user.' has been identified as a Supplier/Service Provider of Jensen Meat Company  Plant Based.<br><br>';
                                                } else {
                                                    $body .= 'We are working with '.$data_company.' as part of their Supplier Approval Program (SAP). Your company has been identified as a Supplier/Service Provider of '.$data_company.'.<br><br>';
                                                }

                                                $body .= 'We are requesting certain documents from your firm to comply with the SAP 21 CFR 117 Subpart G - Supply-Chain Program';

                                                if ($_POST['supplier_countries'] != 'US') { $body .= ' / FSVP 21 CFR Subpart L - Foreign Supplier Verification Programs for Food Importers requirement'; }

                                                $body .= '.<br><ol>';

                                                $requirement_arr = explode(" | ", $requirement_email);
                                                foreach ($requirement_arr as $value) {
                                                    $body .= '<li>'.$value.'</li>';
                                                }

                                                $body .= '</ol>

                                                Follow the instructions below:<br><br>

                                                To update Compliance:<br>
                                                <ol>
                                                    <li>Go to <a href="'.$base_url.'" target="_blank">https://interlinkiq.com/</a> and click Log in. Enter your Username and Password.</li>
                                                    <li>Once successfully logged in, click the Enterprise Module.</li>
                                                    <li>Click Customer Module to view the list of your Customer.</li>
                                                    <li>Click View and go to Requirements Tab; comply by uploading the documents required in the list.</li>
                                                </ol>

                                                Kindly see the link below for our Customer Management Tutorial Video<br><br>

                                                <table style="width: 100%; border-collapse: collapse;">
                                                    <tr>
                                                        <td style="border: 1px solid; padding: 5px; text-align: center;"><b>Tutorial Video</b></td>
                                                        <td style="border: 1px solid; padding: 5px; text-align: center;"><b>Video Link</b></td>
                                                    </tr>
                                                    <tr>
                                                        <td style="border: 1px solid; padding: 5px;">Free Access - Enterprise Management Module</td>
                                                        <td style="border: 1px solid; padding: 5px;">https://www.youtube.com/watch?v=pyhPjZKTlaE</td>
                                                    </tr>
                                                    <tr>
                                                        <td style="border: 1px solid; padding: 5px;">Free Access - Customer Requirements Management Module</td>
                                                        <td style="border: 1px solid; padding: 5px;">https://youtu.be/9XklXwGBr7E</td>
                                                    </tr>
                                                </table><br><br>

                                                Should you need assistance, kindly call 202-982-3002 or email '.$data_email.'<br><br>

                                                InterlinkIQ.com Team<br><br>
                                                Consultare Inc.';
                                    
                                                php_mailer_2($to, $user, $subject, $body, $data_email, $data_company);
                                            }
                                        }
                                    }
                                }
                            }
                        }
                        
                        echo json_encode($result);

                        mysqli_close($conn);
                    }
                }
            }
        }
    }
	if( isset($_POST['btnUpdate_Supplier']) ) {
        $current_userID = $_COOKIE['ID'];
        $current_userEmployerID = employerID($current_userID);

        if (!empty($_COOKIE['switchAccount'])) {
            $portal_user = $_COOKIE['ID'];
            $user_id = $_COOKIE['switchAccount'];
        }
        else {
            $portal_user = $_COOKIE['ID'];
            $user_id = employerID($portal_user);
        }

        $current_dateNow_o = date('Y/m/d');
        $current_dateNow = new DateTime($current_dateNow_o);
        $current_dateNow = $current_dateNow->format('M d, Y');

        $ID = $_POST['ID'];
        $path = 'uploads/supplier/';
        $random = rand(1000,1000000);
        $audit_arr_item = array();
        $audit_filesize = 0;
        $process = true;

        $selectDataMain = mysqli_query( $conn,"SELECT * FROM tbl_supplier WHERE ID = $ID");
        if ( mysqli_num_rows($selectDataMain) > 0 ) {
            $rowDataMain = mysqli_fetch_array($selectDataMain);

            if (!empty($rowDataMain['audit_file_history'])) {
                $audit_arr_item = json_decode($rowDataMain["audit_file_history"],true);
            }
        }

        $supplier_name = addslashes($_POST['supplier_name']);
        $vendor_code = $_POST['vendor_code'];
        $supplier_category = $_POST['supplier_category'];
        $supplier_industry = $_POST['supplier_industry'];

        $supplier_address = array();
        array_push($supplier_address, $_POST['supplier_countries']);
        array_push($supplier_address, addslashes($_POST['supplier_address_street']));
        array_push($supplier_address,addslashes( $_POST['supplier_address_city']));
        array_push($supplier_address, addslashes($_POST['supplier_address_state']));
        array_push($supplier_address, addslashes($_POST['supplier_address_code']));
        $supplier_address = implode(" | ", $supplier_address);

        $supplier_email = addslashes($_POST['supplier_email']);
        $supplier_phone = addslashes($_POST['supplier_phone']);
        $supplier_fax = addslashes($_POST['supplier_fax']);
        $supplier_website = addslashes($_POST['supplier_website']);
        $supplier_status = $_POST['supplier_status'];
        $supplier_notification = $_POST['supplier_notification'];
        $nda = $_POST['nda'];
        $organic = $_POST['organic'];
        $date = date('Y-m-d');

        $supplier_frequency = $_POST['supplier_frequency'];
        $supplier_frequency_custom = array();
        array_push($supplier_frequency_custom, $_POST['supplier_frequency_minute']);
        array_push($supplier_frequency_custom, $_POST['supplier_frequency_hour']);
        array_push($supplier_frequency_custom, $_POST['supplier_frequency_day']);
        array_push($supplier_frequency_custom, $_POST['supplier_frequency_month']);
        array_push($supplier_frequency_custom, $_POST['supplier_frequency_weekday']);
        $supplier_frequency_custom = implode(" | ", $supplier_frequency_custom);

        $document = "";
        if (isset($_POST["document"])) { if (!empty($_POST["document"])) { $document = implode(" | ", $_POST["document"]); } }

        $document_other = "";
        if (isset($_POST["document_other"])) { if (!empty($_POST["document_other"])) { $document_other = implode(" | ", $_POST["document_other"]); } }

        $document_name = "";
        if (isset($_POST["document_name"])) { if (!empty($_POST["document_name"])) { $document_name = implode(" | ", $_POST["document_name"]); } }

        $document_other_name = "";
        if (isset($_POST["document_other_name"])) { if (!empty($_POST["document_other_name"])) { $document_other_name = implode(" | ", $_POST["document_other_name"]); } }

        $regulatory = "";
        if (!empty($_POST["regulatory"])) { $regulatory = implode(", ", $_POST["regulatory"]); }

        $contact = "";
        if (!empty($_POST["contact_id"])) { $contact = implode(", ", $_POST["contact_id"]); }

        $material = "";
        if (!empty($_POST["material_id"])) { $material = implode(", ", $_POST["material_id"]); }

        $service = "";
        if (!empty($_POST["service_id"])) { $service = implode(", ", $_POST["service_id"]); }

        // $selectSupplier = mysqli_query( $conn,"SELECT * FROM tbl_supplier WHERE ID = $ID" );
        // if ( mysqli_num_rows($selectSupplier) > 0 ) {
        //     $rowSupplier = mysqli_fetch_array($selectSupplier);

        //     $current_audit_report = $rowSupplier['audit_report'];
        //     $current_audit_report_arr = explode(" | ", $current_audit_report);

        //     $current_audit_certificate = $rowSupplier['audit_certificate'];
        //     $current_audit_certificate_arr = explode(" | ", $current_audit_certificate);

        //     $current_audit_action = $rowSupplier['audit_action'];
        //     $current_audit_action_arr = explode(" | ", $current_audit_action);
        // }

        $audit_report = array();
        $audit_report_validity = $_POST['audit_report_validity'];
        $audit_report_validity = explode(' - ', $audit_report_validity);
        $audit_report_validity_start = !empty($audit_report_validity[0]) ? $audit_report_validity[0] : '';
        $audit_report_validity_end = !empty($audit_report_validity[1]) ? $audit_report_validity[1] : '';
        $audit_report_file = $_FILES['audit_report_file']['name'];
        if (!empty($audit_report_file)) {
            $audit_filesize = $_FILES['audit_report_file']['size'];
            $audit_report_file_tmp = $_FILES['audit_report_file']['tmp_name'];
            $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
            $ext = strtolower(pathinfo($audit_report_file, PATHINFO_EXTENSION));
            $audit_report_file = $random.' - '.$audit_report_file;
            $audit_report_file_path = $path.$audit_report_file;

            if(!in_array($ext, $invalid_extensions)) {
                move_uploaded_file($audit_report_file_tmp, $audit_report_file_path);
                array_push($audit_report, $audit_report_file);

                $output = array (
                    'type'  =>  1,
                    'name' =>  $audit_report_file,
                    'size' =>  $audit_filesize,
                    'date' =>  $local_date
                );
                array_push($audit_arr_item, $output);
            } else {
                $process = false;
            }
        } else {
            array_push($audit_report, $_POST['audit_report_file_tmp']);
        }
        array_push($audit_report, $audit_report_validity_start);
        array_push($audit_report, $audit_report_validity_end);
        array_push($audit_report, addslashes($_POST['audit_report_note']));
        $audit_report = implode(" | ", $audit_report);

        $audit_certificate = array();
        $audit_certificate_validity = $_POST['audit_certificate_validity'];
        $audit_certificate_validity = explode(' - ', $audit_certificate_validity);
        $audit_certificate_validity_start = !empty($audit_certificate_validity[0]) ? $audit_certificate_validity[0] : '';
        $audit_certificate_validity_end = !empty($audit_certificate_validity[1]) ? $audit_certificate_validity[1] : '';
        $audit_certificate_file = $_FILES['audit_certificate_file']['name'];
        if (!empty($audit_certificate_file)) {
            $audit_filesize = $_FILES['audit_certificate_file']['size'];
            $audit_certificate_file_tmp = $_FILES['audit_certificate_file']['tmp_name'];
            $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
            $ext = strtolower(pathinfo($audit_certificate_file, PATHINFO_EXTENSION));
            $audit_certificate_file = $random.' - '.$audit_certificate_file;
            $audit_certificate_file_path = $path.$audit_certificate_file;

            if(!in_array($ext, $invalid_extensions)) {
                move_uploaded_file($audit_certificate_file_tmp, $audit_certificate_file_path);
                array_push($audit_certificate, $audit_certificate_file);

                $output = array (
                    'type'  =>  2,
                    'name' =>  $audit_certificate_file,
                    'size' =>  $audit_filesize,
                    'date' =>  $local_date
                );
                array_push($audit_arr_item, $output);
            } else {
                $process = false;
            }
        } else {
            array_push($audit_certificate, $_POST['audit_certificate_file_tmp']);
        }
        array_push($audit_certificate, $audit_certificate_validity_start);
        array_push($audit_certificate, $audit_certificate_validity_end);
        array_push($audit_certificate, addslashes($_POST['audit_certificate_note']));
        $audit_certificate = implode(" | ", $audit_certificate);

        $audit_action = array();
        $audit_action_validity = $_POST['audit_action_validity'];
        $audit_action_validity = explode(' - ', $audit_action_validity);
        $audit_action_validity_start = !empty($audit_action_validity[0]) ? $audit_action_validity[0] : '';
        $audit_action_validity_end = !empty($audit_action_validity[1]) ? $audit_action_validity[1] : '';
        $audit_action_file = $_FILES['audit_action_file']['name'];
        if (!empty($audit_action_file)) {
            $audit_filesize = $_FILES['audit_action_file']['size'];
            $audit_action_file_tmp = $_FILES['audit_action_file']['tmp_name'];
            $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
            $ext = strtolower(pathinfo($audit_action_file, PATHINFO_EXTENSION));
            $audit_action_file = $random.' - '.$audit_action_file;
            $audit_action_file_path = $path.$audit_action_file;

            if(!in_array($ext, $invalid_extensions)) {
                move_uploaded_file($audit_action_file_tmp, $audit_action_file_path);
                array_push($audit_action, $audit_action_file);

                $output = array (
                    'type'  =>  3,
                    'name' =>  $audit_action_file,
                    'size' =>  $audit_filesize,
                    'date' =>  $local_date
                );
                array_push($audit_arr_item, $output);
            } else {
                $process = false;
            }
        } else {
            array_push($audit_action, $_POST['audit_action_file_tmp']);
        }
        array_push($audit_action, $audit_action_validity_start);
        array_push($audit_action, $audit_action_validity_end);
        array_push($audit_action, addslashes($_POST['audit_action_note']));
        $audit_action = implode(" | ", $audit_action);
        $audit_file_history = json_encode($audit_arr_item, JSON_HEX_APOS | JSON_UNESCAPED_UNICODE);

        $audit = $_POST['audit'];
        $reviewed_by = addslashes($_POST['reviewed_by']);
        $reviewed_validity = $_POST['reviewed_validity'];
        $reviewed_validity = explode(' - ', $reviewed_validity);
        $reviewed_date = !empty($reviewed_validity[0]) ? $reviewed_validity[0] : '';
        $reviewed_due = !empty($reviewed_validity[1]) ? $reviewed_validity[1] : '';

        $audit_score = $_POST['audit_score'];

        // Temporary Data
        $temp_docs = array();
        $selectDataTemp_Docs = mysqli_query( $conn,"SELECT * FROM tbl_supplier_document WHERE supplier_id = $ID" );
        if ( mysqli_num_rows($selectDataTemp_Docs) > 0 ) {
            while($rowDataTemp_Docs = mysqli_fetch_array($selectDataTemp_Docs)) {
                $temp_doc_ID = $rowDataTemp_Docs['ID'];

                $docs_data = array (
                    'doc_ID'            =>  $rowDataTemp_Docs['ID'],
                    'doc_type'          =>  $rowDataTemp_Docs['type'],
                    'doc_name'          =>  $rowDataTemp_Docs['name'],
                    'doc_file'          =>  $rowDataTemp_Docs['file'],
                    'doc_filename'      =>  $rowDataTemp_Docs['filename'],
                    'doc_filedate'      =>  $rowDataTemp_Docs['file_date'],
                    'doc_filedue'       =>  $rowDataTemp_Docs['file_due'],
                    'doc_reviewedby'    =>  $rowDataTemp_Docs['reviewed_by'],
                    'doc_approvedby'    =>  $rowDataTemp_Docs['approved_by']
                );

                array_push($temp_docs, $docs_data);
            }
        }
        $temp_document = json_encode($temp_docs);

        mysqli_query( $conn,"UPDATE tbl_supplier set name='". $supplier_name ."', vendor_code='".$vendor_code."', address='". $supplier_address ."', phone='". $supplier_phone ."', fax='". $supplier_fax ."', email='". $supplier_email ."', website='". $supplier_website ."', category='". $supplier_category ."', industry='". $supplier_industry ."', regulatory='". $regulatory ."', contact='". $contact ."', document='". $document_name ."', document_other='". $document_other_name ."', material='". $material ."', service='". $service ."', audit='". $audit ."', audit_report='". $audit_report ."', audit_certificate='". $audit_certificate ."', audit_action='". $audit_action ."', audit_filesize='". $audit_filesize ."', audit_file_history='". $audit_file_history ."', audit_score='". $audit_score ."', reviewed_by='". $reviewed_by ."', reviewed_date='". $reviewed_date ."', reviewed_due='". $reviewed_due ."', status='". $supplier_status ."', notification='". $supplier_notification ."', nda='". $nda ."', organic='". $organic ."', frequency='". $supplier_frequency ."', frequency_custom='". $supplier_frequency_custom ."' WHERE ID='". $ID ."'" );
        
        if (!mysqli_error($conn)) {
            $selectData = mysqli_query( $conn,'SELECT * FROM tbl_supplier WHERE ID="'. $ID .'" ORDER BY ID LIMIT 1' );
            if ( mysqli_num_rows($selectData) > 0 ) {
                $rowData = mysqli_fetch_array($selectData);
                $data_ID = $rowData['ID'];
                $data_page = $rowData['page'];
                $data_user_id = $rowData["user_id"];
                $data_name = $rowData['name'];
                $data_document_other = $rowData['document_other'];
                $data_reviewed_due = $rowData['reviewed_due'];
                $data_status = $rowData["status"];
                $data_notification = $rowData["notification"];
                $data_status_type = array(
                    0 => 'Pending',
                    1 => 'Approved',
                    2 => 'Non Approved',
                    3 => 'Emergency Use Only',
                    4 => 'Do Not Use'
                );

                $contact_name = '';
                $contact_address = '';
                $contact_info = '';
                $data_contact = $rowData["contact"];
                if (!empty($data_contact)) {
                    $contact_arr = explode(", ", $data_contact);
                    foreach ($contact_arr as $value) {
                        $selectContact = mysqli_query( $conn,"SELECT * FROM tbl_supplier_contact WHERE ID=$value" );
                        if ( mysqli_num_rows($selectContact) > 0 ) {
                            $rowContact = mysqli_fetch_array($selectContact);
                            $contact_name = $rowContact["name"];
                            $contact_address = $rowContact["address"];
                            $contact_email = $rowContact["email"];
                            $contact_phone = $rowContact["phone"];
                            $contact_cell = $rowContact["cell"];
                            $contact_fax = $rowContact["fax"];

                            $contact_info = '<ul class="list-inline">';
                                if ($contact_email != "") { $contact_info .= '<li><a href="mailto:'.$contact_email.'" target="_blank" title="Email"><i class="fa fa-envelope"></i></a></li>'; }
                                if ($contact_phone != "") { $contact_info .= '<li><a href="tel:'.$contact_phone.'" target="_blank" title="Phone"><i class="fa fa-phone-square"></i></a></li>'; }
                                if ($contact_cell != "") { $contact_info .= '<li><a href="tel:'.$contact_cell.'" target="_blank" title="Cell Number"><i class="fa fa-phone"></i></a></li>'; }
                                if ($contact_fax != "") { $contact_info .= '<li><a href="tel:'.$contact_fax.'" target="_blank" title="Fax"><i class="fa fa-print"></i></a></li>'; }
                            $contact_info .= '</ul>';

                            break;
                        }
                    }
                }

                // Document Section
                $path = 'uploads/supplier/';
                $random = rand(1000,1000000);
                if (isset($_POST["document_name"])) {
                    if (!empty($_POST["document_name"])) {
                        for ($i=0; $i < count($_POST["document_name"]); $i++) {
                            $document_names = addslashes($_POST["document_name"][$i]);
                            $document_filename = addslashes($_POST["document_filename"][$i]);
                            // $document_date = $_POST["document_date"][$i];
                            // $document_due = $_POST["document_due"][$i];
                            $document_comment = addslashes($_POST["document_comment"][$i]);
                            $arr_item = array();
                            $filesize = 0;
                            $selectDataMainDoc = mysqli_query( $conn,'SELECT * FROM tbl_supplier_document WHERE supplier_id="'. $data_ID .'" AND type="0" AND name="'.$document_names.'" ORDER BY ID LIMIT 1' );
                            if ( mysqli_num_rows($selectDataMainDoc) > 0 ) {
                                $rowDataMainDoc = mysqli_fetch_array($selectDataMainDoc);

                                if (!empty($rowDataMainDoc['file_history'])) {
                                    $arr_item = json_decode($rowDataMainDoc["file_history"],true);
                                }
                            }

                            $document_date = '';
                            $document_due = '';
                            $document_daterange = $_POST["document_daterange"][$i];
                            if (!empty($document_daterange)) {
                                $document_daterange = explode(' - ', $document_daterange);
                                $document_date = $document_daterange[0];
                                $document_due = $document_daterange[1];
                            }

                            $document_filetype = $_POST["document_filetype"][$i];
                            if ($document_filetype == 1) {
                                $files = $_FILES['document_file']['name'][$i];
                                $file_docs = "";
                                if (!empty($files)) {
                                    $filesize = $_FILES['document_file']['size'][$i];
                                    $tmp_docs = $_FILES['document_file']['tmp_name'][$i];
                                    $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                                    $ext = strtolower(pathinfo($files, PATHINFO_EXTENSION));
                                    $file_docs = $random.' - '.$files;
                                    $path_docs = $path.$file_docs;

                                    if(!in_array($ext, $invalid_extensions)) {
                                        move_uploaded_file($tmp_docs,$path_docs);
                                    } else {
                                        $process = false;
                                    }
                                }
                            } else {
                                $file_docs = $_POST["document_fileurl"][$i];
                            }

                            $output = array (
                                'type' =>  $document_filetype,
                                'name' =>  $file_docs,
                                'size' =>  $filesize,
                                'date' =>  $local_date
                            );
                            array_push($arr_item, $output);
                        
                            $files_template = $_FILES['document_template']['name'][$i];
                            $file_docs_template = "";
                            if (!empty($files_template)) {
                                $filesize = $_FILES['document_template']['size'][$i];
                                $tmp_docs = $_FILES['document_template']['tmp_name'][$i];
                                $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                                $ext = strtolower(pathinfo($files_template, PATHINFO_EXTENSION));
                                $file_docs_template = $random.' - '.$files_template;
                                $path_docs = $path.$file_docs_template;

                                if(!in_array($ext, $invalid_extensions)) {
                                    move_uploaded_file($tmp_docs,$path_docs);

                                    $output = array (
                                        'type'  =>  0,
                                        'name' =>  $file_docs_template,
                                        'size' =>  $filesize,
                                        'date' =>  $local_date
                                    );
                                    array_push($arr_item, $output);
                                } else {
                                    $process = false;
                                }
                            }
                            $file_history = json_encode($arr_item, JSON_HEX_APOS | JSON_UNESCAPED_UNICODE);

                            $selectDocuments = mysqli_query( $conn,'SELECT * FROM tbl_supplier_document WHERE supplier_id="'. $data_ID .'" AND type="0" AND name="'.$document_names.'" ORDER BY ID LIMIT 1' );
                            if ( mysqli_num_rows($selectDocuments) > 0 ) {
                                $rowDocuments = mysqli_fetch_array($selectDocuments);
                                $sup_doc_id = $rowDocuments["ID"];

                                mysqli_query( $conn,"UPDATE tbl_supplier_document set filename='". $document_filename ."', file_date='". $document_date ."', file_due='". $document_due ."' WHERE ID='". $sup_doc_id ."'" );
                                if ($current_userEmployerID == 34 OR $current_userEmployerID == 27 OR $current_userEmployerID == 464 OR $current_userEmployerID == 1106) {
                                    $document_reviewed = $_POST["document_reviewed"][$i];
                                    $document_approved = $_POST["document_approved"][$i];
                                    mysqli_query( $conn,"UPDATE tbl_supplier_document set reviewed_by='". $document_reviewed ."', approved_by='". $document_approved ."' WHERE ID='". $sup_doc_id ."'" );
                                }

                                if (!empty($file_docs)) { mysqli_query( $conn,"UPDATE tbl_supplier_document set file='". $file_docs ."', filetype = '".$document_filetype."', filesize = '".$filesize."', file_history = '".$file_history."' WHERE ID='". $sup_doc_id ."'" ); }
                                if (!empty($file_docs_template)) { mysqli_query( $conn,"UPDATE tbl_supplier_document set template='". $file_docs_template ."' WHERE ID='". $sup_doc_id ."'" ); }

                                if (!empty($document_comment)) {
                                    $sql = "INSERT INTO tbl_supplier_comment (user_id, portal_user, supplier_document_id, comment, last_modified)
                                    VALUES ('$user_id', '$portal_user', '$sup_doc_id', '$document_comment', '$date')";
                                    mysqli_query($conn, $sql);
                                }
                            } else {
                                $sql = "INSERT INTO tbl_supplier_document (user_id, portal_user, supplier_id, name, file, filetype, filesize, file_history, filename, file_date, file_due, template)
                                VALUES ('$user_id', '$portal_user', '$data_ID', '$document_names', '$file_docs', '$document_filetype', '$filesize', '$file_history', '$document_filename', '$document_date', '$document_due', '$file_docs_template')";
                                if (mysqli_query($conn, $sql)) {
                                    $supplier_document_last_id = mysqli_insert_id($conn);

                                    if (!empty($document_comment)) {
                                        $sql = "INSERT INTO tbl_supplier_comment (user_id, portal_user, supplier_document_id, comment, last_modified)
                                        VALUES ('$user_id', '$portal_user', '$supplier_document_last_id', '$document_comment', '$date')";
                                        mysqli_query($conn, $sql);
                                    }
                                }
                            }
                        }
                    }
                }
                if (isset($_POST["document_other_name"])) {
                    if (!empty($_POST["document_other_name"])) {
                        for ($i=0; $i < count($_POST["document_other_name"]); $i++) {
                            $document_names = addslashes($_POST["document_other_name"][$i]);
                            $document_filename = addslashes($_POST["document_other_filename"][$i]);
                            // $document_date = $_POST["document_other_date"][$i];
                            // $document_due = $_POST["document_other_due"][$i];
                            $document_comment = addslashes($_POST["document_other_comment"][$i]);
                            $arr_item = array();
                            $filesize = 0;
                            $selectDataMainDoc = mysqli_query( $conn,'SELECT * FROM tbl_supplier_document WHERE supplier_id="'. $data_ID .'" AND type="1" AND name="'.$document_names.'" ORDER BY ID LIMIT 1' );
                            if ( mysqli_num_rows($selectDataMainDoc) > 0 ) {
                                $rowDataMainDoc = mysqli_fetch_array($selectDataMainDoc);

                                if (!empty($rowDataMainDoc['file_history'])) {
                                    $arr_item = json_decode($rowDataMainDoc["file_history"],true);
                                }
                            }

                            $document_date = '';
                            $document_due = '';
                            $document_other_daterange = $_POST["document_other_daterange"][$i];
                            if (!empty($document_other_daterange)) {
                                $document_other_daterange = explode(' - ', $document_other_daterange);
                                $document_date = $document_other_daterange[0];
                                $document_due = $document_other_daterange[1];
                            }

                            $document_filetype = $_POST["document_other_filetype"][$i];
                            if ($document_filetype == 1) {
                                $files = $_FILES['document_other_file']['name'][$i];
                                $file_docs = "";
                                if (!empty($files)) {
                                    $filesize = $_FILES['document_other_file']['size'][$i];
                                    $tmp_docs = $_FILES['document_other_file']['tmp_name'][$i];
                                    $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                                    $ext = strtolower(pathinfo($files, PATHINFO_EXTENSION));
                                    $file_docs = $random.' - '.$files;
                                    $path_docs = $path.$file_docs;

                                    if(!in_array($ext, $invalid_extensions)) {
                                        move_uploaded_file($tmp_docs,$path_docs);
                                    } else {
                                        $process = false;
                                    }
                                }
                            } else {
                                $file_docs = $_POST["document_other_fileurl"][$i];
                            }

                            $output = array (
                                'type' =>  $document_filetype,
                                'name' =>  $file_docs,
                                'size' =>  $filesize,
                                'date' =>  $local_date
                            );
                            array_push($arr_item, $output);
                        
                            $files_template = $_FILES['document_other_template']['name'][$i];
                            $file_docs_template = "";
                            if (!empty($files_template)) {
                                $filesize = $_FILES['document_template']['size'][$i];
                                $tmp_docs = $_FILES['document_template']['tmp_name'][$i];
                                $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                                $ext = strtolower(pathinfo($files_template, PATHINFO_EXTENSION));
                                $file_docs_template = $random.' - '.$files_template;
                                $path_docs = $path.$file_docs_template;

                                if(!in_array($ext, $invalid_extensions)) {
                                    move_uploaded_file($tmp_docs,$path_docs);

                                    $output = array (
                                        'type'  =>  0,
                                        'name' =>  $file_docs_template,
                                        'size' =>  $filesize,
                                        'date' =>  $local_date
                                    );
                                    array_push($arr_item, $output);
                                } else {
                                    $process = false;
                                }
                            }
                            $file_history = json_encode($arr_item, JSON_HEX_APOS | JSON_UNESCAPED_UNICODE);

                            $selectDocuments = mysqli_query( $conn,'SELECT * FROM tbl_supplier_document WHERE supplier_id="'. $data_ID .'" AND type="1" AND name="'.$document_names.'" ORDER BY ID LIMIT 1' );
                            if ( mysqli_num_rows($selectDocuments) > 0 ) {
                                $rowDocuments = mysqli_fetch_array($selectDocuments);
                                $sup_doc_id = $rowDocuments["ID"];

                                mysqli_query( $conn,"UPDATE tbl_supplier_document set filename='". $document_filename ."', file_date='". $document_date ."', file_due='". $document_due ."' WHERE ID='". $sup_doc_id ."'" );
                                if ($current_userEmployerID == 34 OR $current_userEmployerID == 27 OR $current_userEmployerID == 464 OR $current_userEmployerID == 1106) {
                                    $document_reviewed = $_POST["document_other_reviewed"][$i];
                                    $document_approved = $_POST["document_other_approved"][$i];
                                    mysqli_query( $conn,"UPDATE tbl_supplier_document set reviewed_by='". $document_reviewed ."', approved_by='". $document_approved ."' WHERE ID='". $sup_doc_id ."'" );
                                }
                            
                                if (!empty($file_docs)) { mysqli_query( $conn,"UPDATE tbl_supplier_document set file='". $file_docs ."', filetype = '".$document_filetype."', filesize = '".$filesize."', file_history = '".$file_history."' WHERE ID='". $sup_doc_id ."'" ); }
                                if (!empty($file_docs_template)) { mysqli_query( $conn,"UPDATE tbl_supplier_document set template='". $file_docs_template ."' WHERE ID='". $sup_doc_id ."'" ); }

                                if (!empty($document_comment)) {
                                    $sql = "INSERT INTO tbl_supplier_comment (user_id, portal_user, supplier_document_id, comment, last_modified)
                                    VALUES ('$user_id', '$portal_user', '$sup_doc_id', '$document_comment', '$date')";
                                    mysqli_query($conn, $sql);
                                }
                            } else {
                                $sql = "INSERT INTO tbl_supplier_document (user_id, portal_user, supplier_id, type, name, file, filetype, filesize, file_history, filename, file_date, file_due, template)
                                VALUES ('$user_id', '$portal_user', '$data_ID', '1', '$document_names', '$file_docs', '$document_filetype', '$filesize', '$file_history', '$document_filename', '$document_date', '$document_due', '$file_docs_template')";
                                if (mysqli_query($conn, $sql)) {
                                    $supplier_document_last_id = mysqli_insert_id($conn);

                                    if (!empty($document_comment)) {
                                        $sql = "INSERT INTO tbl_supplier_comment (user_id, portal_user, supplier_document_id, comment, last_modified)
                                        VALUES ('$user_id', '$portal_user', '$supplier_document_last_id', '$document_comment', '$date')";
                                        mysqli_query($conn, $sql);
                                    }
                                }
                            }
                        }
                    }
                }

                // Requirement Section
                // $requirement = array();
                // $selectRequirement = mysqli_query( $conn,"SELECT * FROM tbl_supplier_requirement" );
                // while($rowRequirement = mysqli_fetch_array($selectRequirement)) {
                //     $data_document_arr = explode(", ", $rowData["document"]);
                //     foreach ($data_document_arr as $value) {
                //         if ( $value == $rowRequirement["ID"] ) {
                //             array_push($requirement, $rowRequirement["name"]);
                //         }
                //     }
                // }
                // $requirement = implode(', ', $requirement);
                // if (!empty($data_document_other)) { $requirement .= ", ". $data_document_other; }

                // Requirement Section
                $requirement = array();
                $requirement_email = "";
                // $selectRequirement = mysqli_query( $conn,"SELECT * FROM tbl_supplier_requirement" );
                $selectRequirement = mysqli_query( $conn,"SELECT
                    d_ID,
                    d_name,
                    d_file,
                    r_ID,
                    r_name,
                    s.ID AS s_ID,
                    s.name AS s_name
                    FROM (
                        SELECT
                        d.ID AS d_ID,
                        d.name AS d_name,
                        d.file AS d_file,
                        r.ID AS r_ID,
                        r.name AS r_name
                        FROM tbl_supplier_document AS d

                        INNER JOIN (
                            SELECT
                            *
                            FROM tbl_supplier_requirement
                        ) AS r
                        ON d.name = r.ID

                        WHERE d.type = 0
                        AND LENGTH(d.file) = 0
                        AND d.user_id = $data_user_id
                        AND d.supplier_id = $data_ID
                    ) AS o

                    LEFT JOIN (
                        SELECT
                        *
                        FROM tbl_supplier
                    ) AS s
                    ON FIND_IN_SET(o.r_ID, REPLACE(REPLACE(s.document, ' ', ''), '|',','  )  ) > 0

                    WHERE s.ID = $data_ID" );
                while($rowRequirement = mysqli_fetch_array($selectRequirement)) {
                    array_push($requirement, $rowRequirement["r_name"]);

                    // $data_document_arr = explode(" | ", $rowData["document"]);
                    // foreach ($data_document_arr as $value) {
                    //     if ( $value == $rowRequirement["ID"] ) {
                    //         array_push($requirement, $rowRequirement["name"]);
                    //     }
                    // }
                }
                // if (!empty($requirement)) { $requirement_email = implode(' | ', $requirement); }

                $compliance = 0;
                $compliance_counter = 0;
                $compliance_approved = 0;
                if (!empty($_POST["document"])) {
                    $selectRequirement = mysqli_query( $conn,"SELECT * FROM tbl_supplier_requirement ORDER BY name" );
                    while($rowRequirement = mysqli_fetch_array($selectRequirement)) {
                        $req_id = $rowRequirement["ID"];
                        $req_name = $rowRequirement["name"];

                        $document_arr = implode(" | ", $_POST["document"]);
                        $document_arr = explode(" | ", $document_arr);
                        foreach ($document_arr as $value) {
                            if ( $value == $req_id ) {
                                $selectDocument = mysqli_query( $conn,"SELECT * FROM tbl_supplier_document WHERE user_id='".$data_user_id."' AND supplier_id='".$ID."' AND name='".$req_id."'" );
                                if ( mysqli_num_rows($selectDocument) > 0 ) {
                                    $rowDocument = mysqli_fetch_array($selectDocument);
                                    $doc_file_approved = $rowDocument["approved_by"];

                                    $compliance_counter++;
                                    // if ($doc_file_approved > 0) { $compliance_approved++; }

                                    $doc_file_due = $rowDocument["file_due"];
                                    if (!empty($doc_file_due)) {
                                        $doc_file_due = new DateTime($doc_file_due);
                                        $doc_file_due_o = $doc_file_due->format('Y/m/d');
                                        $doc_file_due_o_nearly = date('Y/m/d', strtotime($doc_file_due_o. ' - 30 days'));
                                        $doc_file_due = $doc_file_due->format('m/d/Y');

                                        if ($doc_file_due_o >= $current_dateNow_o && $doc_file_approved > 0) { $compliance_approved++; }
                                    };
                                }
                            }
                        }
                    }
                }

                // $requirement = implode(' | ', $requirement);
                if (!empty($data_document_other)) {
                    // $requirement .= " | ". $data_document_other;

                    // $data_document_other_arr = array();
                    // $data_document_other_arr = explode(' | ', $data_document_other);
                    // $data_document_other_arr = implode(' | ', $data_document_other_arr);
                    // $requirement_email .= " | ". $data_document_other_arr;

                    $document_other_arr = implode(" | ", $_POST["document_other"]);
                    $document_other_arr = explode(" | ", $document_other_arr);
                    foreach ($document_other_arr as $value) {
                        // $selectDocument = mysqli_query( $conn,"SELECT * FROM tbl_supplier_document WHERE user_id='".$data_user_id."' AND supplier_id='".$ID."' AND name='".$value."'" );
                        $selectDocument = mysqli_query( $conn,"SELECT * FROM tbl_supplier_document WHERE type = 1 AND user_id = $data_user_id AND supplier_id = $data_ID AND name = '".$value."'" );
                        if ( mysqli_num_rows($selectDocument) > 0 ) {
                            $rowDocument = mysqli_fetch_array($selectDocument);
                            $doc_file_approved = $rowDocument["approved_by"];

                            if (empty($rowDocument["file"])) {
                                array_push($requirement, $value);
                            }

                            $compliance_counter++;
                            // if ($doc_file_approved > 0) { $compliance_approved++; }

                            $doc_file_due = $rowDocument["file_due"];
                            if (!empty($doc_file_due)) {
                                $doc_file_due = new DateTime($doc_file_due);
                                $doc_file_due_o = $doc_file_due->format('Y/m/d');
                                $doc_file_due_o_nearly = date('Y/m/d', strtotime($doc_file_due_o. ' - 30 days'));
                                $doc_file_due = $doc_file_due->format('m/d/Y');

                                if ($doc_file_due_o >= $current_dateNow_o && $doc_file_approved > 0) { $compliance_approved++; }
                            };
                        }
                    }
                }
                if (!empty($requirement)) { $requirement_email = implode(' | ', $requirement); }

                if ($compliance_counter > 0) { $compliance = intval(($compliance_approved / $compliance_counter) * 100); }
                else { $compliance = 0; }
                mysqli_query( $conn,"UPDATE tbl_supplier set compliance = $compliance WHERE ID = $ID" );

                // Category Section
                $data_category_id = $rowData['category'];
                $selectCategory = mysqli_query( $conn,'SELECT * FROM tbl_supplier_category WHERE ID="'. $data_category_id .'" ORDER BY ID LIMIT 1' );
                $rowCategory = mysqli_fetch_array($selectCategory);
                $data_category = $rowCategory['name'];

                if ($data_page == 1) {
                    if ($data_category_id == "3") {
                        $data_material = $rowData['service'];
                        $material_arr = array();
                        if (!empty($data_material)) {
                            $data_material_arr = explode(", ", $data_material);
                            foreach ($data_material_arr as $value) {
                                $selectMaterial = mysqli_query( $conn,"SELECT * FROM tbl_supplier_service WHERE ID=$value" );
                                $rowMaterial = mysqli_fetch_array($selectMaterial);
                                array_push($material_arr, $rowMaterial['service_name']);
                            }
                            $data_material = implode(', ', $material_arr);
                        }
                    } else {
                        $data_material = $rowData['material'];
                        $material_arr = array();
                        if (!empty($data_material)) {
                            $data_material_arr = explode(", ", $data_material);
                            foreach ($data_material_arr as $value) {
                                $selectMaterial = mysqli_query( $conn,"SELECT * FROM tbl_supplier_material WHERE ID=$value" );
                                $rowMaterial = mysqli_fetch_array($selectMaterial);
                                array_push($material_arr, $rowMaterial['material_name']);
                            }
                            $data_material = implode(', ', $material_arr);
                        }
                    }
                } else {
                    if ($data_category_id == "3") {
                        $data_material = $rowData['service'];
                        $material_arr = array();
                        if (!empty($data_material)) {
                            $data_material_arr = explode(", ", $data_material);
                            foreach ($data_material_arr as $value) {
                                $selectMaterial = mysqli_query( $conn,"SELECT * FROM tbl_supplier_service WHERE ID=$value" );
                                $rowMaterial = mysqli_fetch_array($selectMaterial);
                                $service_id = $rowMaterial['service_name'];

                                $selectServiceCategory = mysqli_query( $conn,"SELECT * FROM tbl_service_category WHERE id=$service_id" );
                                $rowServiceCategory = mysqli_fetch_array($selectServiceCategory);
                                array_push($material_arr, $rowServiceCategory['service_category']);
                            }
                            $data_material = implode(', ', $material_arr);
                        }
                    } else {
                        $data_material = $rowData['material'];
                        $material_arr = array();
                        if (!empty($data_material)) {
                            $data_material_arr = explode(", ", $data_material);
                            foreach ($data_material_arr as $value) {
                                $selectMaterial = mysqli_query( $conn,"SELECT * FROM tbl_supplier_material WHERE ID=$value" );
                                $rowMaterial = mysqli_fetch_array($selectMaterial);
                                $material_id = $rowMaterial['material_name'];

                                $selectProduct = mysqli_query( $conn,"SELECT * FROM tbl_products WHERE ID=$material_id" );
                                $rowProduct = mysqli_fetch_array($selectProduct);
                                array_push($material_arr, $rowProduct['name']);
                            }
                            $data_material = implode(', ', $material_arr);
                        }
                    }

                    $selectUser = mysqli_query( $conn,'SELECT * FROM tbl_user WHERE ID="'. $data_user_id .'" ORDER BY ID LIMIT 1' );
                    $rowUser = mysqli_fetch_array($selectUser);
                    $data_name = $rowUser['first_name'] .' '. $rowUser['last_name'];
                    $data_name = "Enterprise Name";
                }
                
                $address_array = array();
                $address = $rowData["address"];
                $address_arr = explode(" | ", $address);
                if (COUNT($address_arr) < 5) {
                    $address_arr = explode(", ", $address);
                }
                array_push($address_array, htmlentities($address_arr[1]));
                array_push($address_array, htmlentities($address_arr[2]));
                array_push($address_array, htmlentities($address_arr[3]));
                array_push($address_array, $address_arr[0]);
                array_push($address_array, $address_arr[4]);
                $address_arr = implode(", ", $address_array);

                $counterup_tbl = counterup_tbl('supplier');
                $output = array(
                    "ID" => $data_ID,
                    "page" => $data_page,
                    "supplier_name" => htmlentities($data_name ?? ''),
                    "category" => htmlentities($data_category ?? ''),
                    "material" => htmlentities($data_material ?? ''),
                    "address" => $address_arr,
                    "contact_name" => htmlentities($contact_name ?? ''),
                    "contact_address" => htmlentities($contact_address ?? ''),
                    "contact_info" => $contact_info,
                    "reviewed_due" => $data_reviewed_due,
                    "compliance" => $compliance,
                    "status" => $data_status_type[$data_status]
                );
                $result = array_merge($counterup_tbl, $output);

                if ($data_notification == 1) {
                    $data_company = "";
                    $data_email = "";
                    $selectEnterprise = mysqli_query( $conn,"SELECT * FROM tblEnterpiseDetails WHERE users_entities = $user_id" );
                    if ( mysqli_num_rows($selectEnterprise) > 0 ) {
                        $rowEnterprise = mysqli_fetch_array($selectEnterprise);
                        $data_company = $rowEnterprise["businessname"];
                        $data_email = $rowEnterprise["businessemailAddress"];
                    }

                    $selectDataTemp_Docs_Portal_User = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $portal_user" );
                    if ( mysqli_num_rows($selectDataTemp_Docs_Portal_User) > 0 ) {
                        $rowDataTemp_Docs_Portal_User = mysqli_fetch_array($selectDataTemp_Docs_Portal_User);
                        $portal_user_name = $rowDataTemp_Docs_Portal_User['first_name'] .' '. $rowDataTemp_Docs_Portal_User['last_name'];
                    }

                    $to = $supplier_email;
                    $user = $supplier_name;
                    $subject = 'Supplier Approval Program Updated!';
                    $body = 'Hi '.$user.',<br><br>

                    Here are some updates on tasks you\'re a collaborator on:
                    <ul>';

                    $has_changes = 0;
                    $mail_sent = 0;
                    $temp_document_output = json_decode($temp_document, true);
                    foreach ($temp_document_output as $key => $key_value) {
                        $doc_ID = $key_value['doc_ID'];
                        $doc_file = $key_value['doc_file'];
                        $doc_reviewedby = $key_value['doc_reviewedby'];
                        $doc_approvedby = $key_value['doc_approvedby'];

                        $selectDataTemp_Docs = mysqli_query( $conn,"SELECT * FROM tbl_supplier_document WHERE ID = $doc_ID" );
                        if ( mysqli_num_rows($selectDataTemp_Docs) > 0 ) {
                            $rowDataTemp_Docs = mysqli_fetch_array($selectDataTemp_Docs);
                            $user_change_name = $rowDataTemp_Docs['name'];
                            if ($rowDataTemp_Docs['type'] == 0) {
                                $selectDataTemp_DocsReqName = mysqli_query( $conn,"SELECT * FROM tbl_supplier_requirement WHERE ID = $user_change_name" );
                                if ( mysqli_num_rows($selectDataTemp_DocsReqName) > 0 ) {
                                    $rowDataTemp_DocsReqName = mysqli_fetch_array($selectDataTemp_DocsReqName);
                                    $user_change_name = $rowDataTemp_DocsReqName['name'];
                                }
                            }

                            $user_change_file = $rowDataTemp_Docs['file'];
                            $user_change_filename = $rowDataTemp_Docs['filename'];
                            $user_change_reviewed_by = $rowDataTemp_Docs['reviewed_by'];
                            $user_change_approved_by = $rowDataTemp_Docs['approved_by'];

                            if (!empty($user_change_file) AND $user_change_file != $doc_file) {
                                $body .= '<li>'.$user_change_name.' was Complied by '.$portal_user_name.'</li>';
                                $has_changes++;
                            }
                            if ($user_change_reviewed_by > 0 AND $user_change_reviewed_by != $doc_reviewedby) {
                                $selectDataTemp_Docs_Reviewed = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $user_change_reviewed_by" );
                                if ( mysqli_num_rows($selectDataTemp_Docs_Reviewed) > 0 ) {
                                    $rowDataTemp_Docs_Reviewed = mysqli_fetch_array($selectDataTemp_Docs_Reviewed);
                                    $reviewed_user_name = $rowDataTemp_Docs_Reviewed['first_name'] .' '. $rowDataTemp_Docs_Reviewed['last_name'];

                                    $body .= '<li>'.$user_change_name.' was Reviewed by '.$reviewed_user_name.'</li>';
                                    $has_changes++;
                                }
                            }
                            if ($user_change_approved_by > 0 AND $user_change_approved_by != $doc_approvedby) {
                                $selectDataTemp_Docs_Approved = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $user_change_approved_by" );
                                if ( mysqli_num_rows($selectDataTemp_Docs_Approved) > 0 ) {
                                    $rowDataTemp_Docs_Approved = mysqli_fetch_array($selectDataTemp_Docs_Approved);
                                    $approved_user_name = $rowDataTemp_Docs_Approved['first_name'] .' '. $rowDataTemp_Docs_Approved['last_name'];

                                    $body .= '<li>'.$user_change_name.' was Reviewed by '.$approved_user_name.'</li>';
                                    $has_changes++;
                                }
                            }
                        }
                    }

                    $body .= '</ul>
                    Should you need assistance, kindly call 202-982-3002 or email '.$data_email.'<br><br>

                    InterlinkIQ.com Team<br>
                    Consultare Inc. Group';

                    if ($has_changes > 0) { php_mailer_1($to, $user, $subject, $body, $data_email, $data_company); $mail_sent++; }


                    // Adding SAP Requirements
                    if (!empty($requirement_email)) {
                        $to = $supplier_email;
                        $user = $supplier_name;
                        $subject = $data_company.' Supplier Invitation via ';
                        if ($_COOKIE['client'] == 1) { $data_company.'CannOS.'; } 
                        else if ($_COOKIE['client'] == 2) { $data_company.'Food Safety 360.'; } 
                        else { $data_company.'InterlinkIQ.com.'; }
                        $body = 'Hi '.$user.' Food Safety Team,<br><br>';

                        if ($user_id == 254) {
                            $body .= 'We are working with Jensen Meat Company (JMC) as part of their Supplier Approval Program (SAP). The '.$user.' has been identified as a Supplier/Service Provider of Jensen Meat Company  Plant Based.<br><br>';
                            $body .= 'We are requesting certain documents from your firm to comply with the SAP 21 CFR 117 Subpart G - Supply-Chain Program';
                        } else {
                            $body .= 'We are a compliance company and a third-party service provider working with '.$data_company.'
                                which manufactures some of the '.$user.'\'s products.
                                And, your company was identified as a supplier of the ingredients listed below.
                                 
                                With regards, we are requesting certain documents from your firm to comply with the SAP requirement.
                                Kindly refer to the table below for the list of requirements';
                        }
                        // else {
                        //  $body .= 'We are working with '.$data_company.' as part of their Supplier Approval Program (SAP). Your company has been identified as a Supplier/Service Provider of '.$data_company.'.<br><br>';
                        //     $body .= 'We are requesting certain documents from your firm to comply with the SAP 21 CFR 117 Subpart G - Supply-Chain Program';
                        // }

                        if ($_POST['supplier_countries'] != 'US') { $body .= ' / FSVP 21 CFR Subpart L - Foreign Supplier Verification Programs for Food Importers requirement'; }

                        $body .= '.<br><ol>';

                        $requirement_arr = explode(" | ", $requirement_email);
                        foreach ($requirement_arr as $value) {
                            $body .= '<li>'.$value.'</li>';
                        }

                        $body .= '</ol>

                        Follow the instructions below:<br><br>

                        To update Compliance:<br>
                        <ol>
                            <li>Go to <a href="'.$base_url.'" target="_blank">https://interlinkiq.com/</a> and click Log in. Enter your Username and Password.</li>
                            <li>Click Customer Module to view the list of your Customer.</li>
                            <li>Click View and go to Requirements Tab; comply by uploading the documents required in the list.</li>
                        </ol>

                        Kindly see the link below for our Customer Management Tutorial Video<br><br>

                        <table style="width: 100%; border-collapse: collapse;">
                            <tr>
                                <td style="border: 1px solid; padding: 5px; text-align: center;"><b>Tutorial Video</b></td>
                                <td style="border: 1px solid; padding: 5px; text-align: center;"><b>Video Link</b></td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid; padding: 5px;">Free Access - Enterprise Management Module</td>
                                <td style="border: 1px solid; padding: 5px;">https://www.youtube.com/watch?v=pyhPjZKTlaE</td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid; padding: 5px;">Free Access - Customer Requirements Management Module</td>
                                <td style="border: 1px solid; padding: 5px;">https://youtu.be/9XklXwGBr7E</td>
                            </tr>
                        </table><br><br>

                        Should you need assistance, kindly call 202-982-3002 or email '.$data_email.'<br><br>

                        InterlinkIQ.com Team<br><br>
                        Consultare Inc. Group';

                        if ($mail_sent > 0) {
                            php_mailer_2($to, $user, $subject, $body, $data_email, $data_company);
                            $mail_sent++;
                        } else {
                            php_mailer_1($to, $user, $subject, $body, $data_email, $data_company);
                            $mail_sent++;
                        }
                    }
        
                    // Contact Section
                    $data_contact = $rowData['contact'];
                    if (!empty($data_contact)) {
                        $data_contact_arr = explode(", ", $data_contact);
                        foreach ($data_contact_arr as $value) {
                            $selectContact = mysqli_query( $conn,"SELECT * FROM tbl_supplier_contact WHERE notification = 1 AND ID = $value" );
                            if ( mysqli_num_rows($selectContact) > 0 ) {
                                while($rowContact = mysqli_fetch_array($selectContact)) {
                                    $contact_name = $rowContact["name"];
                                    $contact_email = $rowContact["email"];

                                    $to = $contact_email;
                                    $user = $contact_name;
                                    $subject = 'Supplier Approval Program Updated!';
                                    $body = 'Hi '.$user.',<br><br>

                                    Here are some updates on tasks you\'re a collaborator on:
                                    <ul>';

                                    $has_changes = 0;
                                    $temp_document_output = json_decode($temp_document, true);
                                    foreach ($temp_document_output as $key => $key_value) {
                                        $doc_ID = $key_value['doc_ID'];
                                        $doc_file = $key_value['doc_file'];
                                        $doc_reviewedby = $key_value['doc_reviewedby'];
                                        $doc_approvedby = $key_value['doc_approvedby'];

                                        $selectDataTemp_Docs = mysqli_query( $conn,"SELECT * FROM tbl_supplier_document WHERE ID = $doc_ID" );
                                        if ( mysqli_num_rows($selectDataTemp_Docs) > 0 ) {
                                            $rowDataTemp_Docs = mysqli_fetch_array($selectDataTemp_Docs);
                                            $user_change_name = $rowDataTemp_Docs['name'];
                                            if ($rowDataTemp_Docs['type'] == 0) {
                                                $selectDataTemp_DocsReqName = mysqli_query( $conn,"SELECT * FROM tbl_supplier_requirement WHERE ID = $user_change_name" );
                                                if ( mysqli_num_rows($selectDataTemp_DocsReqName) > 0 ) {
                                                    $rowDataTemp_DocsReqName = mysqli_fetch_array($selectDataTemp_DocsReqName);
                                                    $user_change_name = $rowDataTemp_DocsReqName['name'];
                                                }
                                            }

                                            $user_change_file = $rowDataTemp_Docs['file'];
                                            $user_change_filename = $rowDataTemp_Docs['filename'];
                                            $user_change_reviewed_by = $rowDataTemp_Docs['reviewed_by'];
                                            $user_change_approved_by = $rowDataTemp_Docs['approved_by'];

                                            if (!empty($user_change_file) AND $user_change_file != $doc_file) {
                                                $body .= '<li>'.$user_change_name.' was Complied by '.$portal_user_name.'</li>';
                                                $has_changes++;
                                            }
                                            if ($user_change_reviewed_by > 0 AND $user_change_reviewed_by != $doc_reviewedby) {
                                                $selectDataTemp_Docs_Reviewed = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $user_change_reviewed_by" );
                                                if ( mysqli_num_rows($selectDataTemp_Docs_Reviewed) > 0 ) {
                                                    $rowDataTemp_Docs_Reviewed = mysqli_fetch_array($selectDataTemp_Docs_Reviewed);
                                                    $reviewed_user_name = $rowDataTemp_Docs_Reviewed['first_name'] .' '. $rowDataTemp_Docs_Reviewed['last_name'];

                                                    $body .= '<li>'.$user_change_name.' was Reviewed by '.$reviewed_user_name.'</li>';
                                                    $has_changes++;
                                                }
                                            }
                                            if ($user_change_approved_by > 0 AND $user_change_approved_by != $doc_approvedby) {
                                                $selectDataTemp_Docs_Approved = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $user_change_approved_by" );
                                                if ( mysqli_num_rows($selectDataTemp_Docs_Approved) > 0 ) {
                                                    $rowDataTemp_Docs_Approved = mysqli_fetch_array($selectDataTemp_Docs_Approved);
                                                    $approved_user_name = $rowDataTemp_Docs_Approved['first_name'] .' '. $rowDataTemp_Docs_Approved['last_name'];

                                                    $body .= '<li>'.$user_change_name.' was Reviewed by '.$approved_user_name.'</li>';
                                                    $has_changes++;
                                                }
                                            }
                                        }
                                    }

                                    $body .= '</ul>
                                    Should you need assistance, kindly call 202-982-3002 or email '.$data_email.'<br><br>

                                    InterlinkIQ.com Team<br>
                                    Consultare Inc. Group';

                                    if ($has_changes > 0) {
                                        if ($mail_sent > 0) {
                                            php_mailer_2($to, $user, $subject, $body, $data_email, $data_company);
                                            $mail_sent++;
                                        } else {
                                            php_mailer_1($to, $user, $subject, $body, $data_email, $data_company);
                                            $mail_sent++;
                                        }
                                    }



                                    // Adding SAP Requirements
                                    if (!empty($requirement_email)) {
                                        $to = $contact_email;
                                        $user = $contact_name;
                                        $subject = 'Supplier Approval Requirements!';
                                        $body = 'Hi '.$user.' Food Safety Team,<br><br>';

                                        if ($user_id == 254) {
                                            $body .= 'We are working with Jensen Meat Company (JMC) as part of their Supplier Approval Program (SAP). The '.$user.' has been identified as a Supplier/Service Provider of Jensen Meat Company  Plant Based.<br><br>';
                                        } else {
                                            $body .= 'We are working with '.$data_company.' as part of their Supplier Approval Program (SAP). Your company has been identified as a Supplier/Service Provider of '.$data_company.'.<br><br>';
                                        }

                                        $body .= 'We are requesting certain documents from your firm to comply with the SAP 21 CFR 117 Subpart G - Supply-Chain Program';

                                        if ($_POST['supplier_countries'] != 'US') { $body .= ' / FSVP 21 CFR Subpart L - Foreign Supplier Verification Programs for Food Importers requirement'; }

                                        $body .= '.<br><ol>';

                                        $requirement_arr = explode(" | ", $requirement_email);
                                        foreach ($requirement_arr as $value) {
                                            $body .= '<li>'.$value.'</li>';
                                        }

                                        $body .= '</ol>

                                        Follow the instructions below:<br><br>

                                        To update Compliance:<br>
                                        <ol>
                                            <li>Go to <a href="'.$base_url.'" target="_blank">https://interlinkiq.com/</a> and click Log in. Enter your Username and Password.</li>
                                            <li>Once successfully logged in, click the Enterprise Module.</li>
                                            <li>Click Customer Module to view the list of your Customer.</li>
                                            <li>Click View and go to Requirements Tab; comply by uploading the documents required in the list.</li>
                                        </ol>

                                        Kindly see the link below for our Customer Management Tutorial Video<br><br>

                                        <table style="width: 100%; border-collapse: collapse;">
                                            <tr>
                                                <td style="border: 1px solid; padding: 5px; text-align: center;"><b>Tutorial Video</b></td>
                                                <td style="border: 1px solid; padding: 5px; text-align: center;"><b>Video Link</b></td>
                                            </tr>
                                            <tr>
                                                <td style="border: 1px solid; padding: 5px;">Free Access - Enterprise Management Module</td>
                                                <td style="border: 1px solid; padding: 5px;">https://www.youtube.com/watch?v=pyhPjZKTlaE</td>
                                            </tr>
                                            <tr>
                                                <td style="border: 1px solid; padding: 5px;">Free Access - Customer Requirements Management Module</td>
                                                <td style="border: 1px solid; padding: 5px;">https://youtu.be/9XklXwGBr7E</td>
                                            </tr>
                                        </table><br><br>

                                        Should you need assistance, kindly call 202-982-3002 or email '.$data_email.'<br><br>

                                        InterlinkIQ.com Team<br><br>
                                        Consultare Inc. Group';

                                        if ($mail_sent > 0) {
                                            php_mailer_2($to, $user, $subject, $body, $data_email, $data_company);
                                            $mail_sent++;
                                        } else {
                                            php_mailer_1($to, $user, $subject, $body, $data_email, $data_company);
                                            $mail_sent++;
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
                
                echo json_encode($result);
            }
        }
        
        mysqli_close($conn);
    }
    if( isset($_POST['btnUpdate_SupplierReq']) ) {
        $current_userID = $_COOKIE['ID'];
        $current_userEmployerID = employerID($current_userID);

        if (!empty($_COOKIE['switchAccount'])) {
            $portal_user = $_COOKIE['ID'];
            $user_id = $_COOKIE['switchAccount'];
        }
        else {
            $portal_user = $_COOKIE['ID'];
            $user_id = employerID($portal_user);
        }

        $current_dateNow_o = date('Y/m/d');
        $current_dateNow = new DateTime($current_dateNow_o);
        $current_dateNow = $current_dateNow->format('M d, Y');
        $process = true;

        $ID = $_POST['ID'];
        $path = 'uploads/supplier/';
        $random = rand(1000,1000000);

        $document = "";
        if (isset($_POST["document"])) { if (!empty($_POST["document"])) { $document = implode(" | ", $_POST["document"]); } }

        $document_other = "";
        if (isset($_POST["document_other"])) { if (!empty($_POST["document_other"])) { $document_other = implode(" | ", $_POST["document_other"]); } }

        $document_name = "";
        if (isset($_POST["document_name"])) { if (!empty($_POST["document_name"])) { $document_name = implode(" | ", $_POST["document_name"]); } }

        $document_other_name = "";
        if (isset($_POST["document_other_name"])) { if (!empty($_POST["document_other_name"])) { $document_other_name = implode(" | ", $_POST["document_other_name"]); } }

        // Temporary Data
        $temp_docs = array();
        $selectDataTemp_Docs = mysqli_query( $conn,"SELECT * FROM tbl_supplier_document WHERE supplier_id = $ID" );
        if ( mysqli_num_rows($selectDataTemp_Docs) > 0 ) {
            while($rowDataTemp_Docs = mysqli_fetch_array($selectDataTemp_Docs)) {
                $temp_doc_ID = $rowDataTemp_Docs['ID'];

                $docs_data = array (
                    'doc_ID'            =>  $rowDataTemp_Docs['ID'],
                    'doc_type'          =>  $rowDataTemp_Docs['type'],
                    'doc_name'          =>  $rowDataTemp_Docs['name'],
                    'doc_file'          =>  $rowDataTemp_Docs['file'],
                    'doc_filename'      =>  $rowDataTemp_Docs['filename'],
                    'doc_filedate'      =>  $rowDataTemp_Docs['file_date'],
                    'doc_filedue'       =>  $rowDataTemp_Docs['file_due'],
                    'doc_reviewedby'    =>  $rowDataTemp_Docs['reviewed_by'],
                    'doc_approvedby'    =>  $rowDataTemp_Docs['approved_by']
                );

                array_push($temp_docs, $docs_data);
            }
        }
        $temp_document = json_encode($temp_docs);

        mysqli_query( $conn,"UPDATE tbl_supplier set document='". $document_name ."', document_other='". $document_other_name ."' WHERE ID='". $ID ."'" );
        
        if (!mysqli_error($conn)) {
            $selectData = mysqli_query( $conn,"SELECT * FROM tbl_supplier WHERE ID = $ID ORDER BY ID LIMIT 1");
            if ( mysqli_num_rows($selectData) > 0 ) {
                $rowData = mysqli_fetch_array($selectData);
                $data_ID = $rowData['ID'];
                $data_page = $rowData['page'];
                $data_user_id = $rowData["user_id"];
                $data_name = $rowData['name'];
                $data_document_other = $rowData['document_other'];
                $data_reviewed_due = $rowData['reviewed_due'];
                $data_status = $rowData["status"];
                $data_notification = $rowData["notification"];
                $data_status_type = array(
                    0 => 'Pending',
                    1 => 'Approved',
                    2 => 'Non Approved',
                    3 => 'Emergency Use Only',
                    4 => 'Do Not Use'
                );

                // Document Section
                if (isset($_POST["document_name"])) {
                    if (!empty($_POST["document_name"])) {
                        for ($i=0; $i < count($_POST["document_name"]); $i++) {
                            $document_names = addslashes($_POST["document_name"][$i]);
                            $document_filename = addslashes($_POST["document_filename"][$i]);
                            // $document_date = $_POST["document_date"][$i];
                            // $document_due = $_POST["document_due"][$i];
                            $document_comment = $_POST["document_comment"][$i];

                            $document_date = '';
                            $document_due = '';
                            $document_daterange = $_POST["document_daterange"][$i];
                            if (!empty($document_daterange)) {
                                $document_daterange = explode(' - ', $document_daterange);
                                $document_date = $document_daterange[0];
                                $document_due = $document_daterange[1];
                            }

                            $document_filetype = $_POST["document_filetype"][$i];
                            if ($document_filetype == 1) {
                                $files = $_FILES['document_file']['name'][$i];
                                $file_docs = "";
                                if (!empty($files)) {
                                    $tmp_docs = $_FILES['document_file']['tmp_name'][$i];
                                    $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                                    $ext = strtolower(pathinfo($files, PATHINFO_EXTENSION));
                                    $file_docs = $random.' - '.$files;
                                    $path_docs = $path.$file_docs;

                                    if(!in_array($ext, $invalid_extensions)) {
                                        move_uploaded_file($tmp_docs,$path_docs);
                                    } else {
                                        $process = false;
                                    }
                                }
                            } else {
                                $file_docs = $_POST["document_fileurl"][$i];
                            }
                        
                            $files_template = $_FILES['document_template']['name'][$i];
                            $file_docs_template = "";
                            if (!empty($files_template)) {
                                $tmp_docs = $_FILES['document_template']['tmp_name'][$i];
                                $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                                $ext = strtolower(pathinfo($files_template, PATHINFO_EXTENSION));
                                $file_docs_template = $random.' - '.$files_template;
                                $path_docs = $path.$file_docs_template;

                                if(!in_array($ext, $invalid_extensions)) {
                                    move_uploaded_file($tmp_docs,$path_docs);
                                } else {
                                    $process = false;
                                }
                            }

                            if ($process == true) {
                                $selectDocuments = mysqli_query( $conn,'SELECT * FROM tbl_supplier_document WHERE supplier_id="'. $data_ID .'" AND type="0" AND name="'.$document_names.'" ORDER BY ID LIMIT 1' );
                                if ( mysqli_num_rows($selectDocuments) > 0 ) {
                                    $rowDocuments = mysqli_fetch_array($selectDocuments);
                                    $sup_doc_id = $rowDocuments["ID"];

                                    mysqli_query( $conn,"UPDATE tbl_supplier_document set filename='". $document_filename ."', file_date='". $document_date ."', file_due='". $document_due ."' WHERE ID='". $sup_doc_id ."'" );
                                    if ($current_userEmployerID == 34 OR $current_userEmployerID == 27 OR $current_userEmployerID == 464 OR $current_userEmployerID == 1106) {
                                        $document_reviewed = $_POST["document_reviewed"][$i];
                                        $document_approved = $_POST["document_approved"][$i];
                                        mysqli_query( $conn,"UPDATE tbl_supplier_document set reviewed_by='". $document_reviewed ."', approved_by='". $document_approved ."' WHERE ID='". $sup_doc_id ."'" );
                                    }

                                    if (!empty($file_docs)) { mysqli_query( $conn,"UPDATE tbl_supplier_document set file='". $file_docs ."', filetype = '".$document_filetype."' WHERE ID='". $sup_doc_id ."'" ); }
                                    if (!empty($file_docs_template)) { mysqli_query( $conn,"UPDATE tbl_supplier_document set template='". $file_docs_template ."' WHERE ID='". $sup_doc_id ."'" ); }

                                    if (!empty($document_comment)) {
                                        $sql = "INSERT INTO tbl_supplier_comment (user_id, portal_user, supplier_document_id, comment, last_modified)
                                        VALUES ('$user_id', '$portal_user', '$sup_doc_id', '$document_comment', '$date')";
                                        mysqli_query($conn, $sql);
                                    }
                                } else {
                                    $sql = "INSERT INTO tbl_supplier_document (user_id, portal_user, supplier_id, name, file, filetype, filename, file_date, file_due, template)
                                    VALUES ('$user_id', '$portal_user', '$data_ID', '$document_names', '$file_docs', '$document_filetype', '$document_filename', '$document_date', '$document_due', '$file_docs_template')";
                                    if (mysqli_query($conn, $sql)) {
                                        $supplier_document_last_id = mysqli_insert_id($conn);

                                        if (!empty($document_comment)) {
                                            $sql = "INSERT INTO tbl_supplier_comment (user_id, portal_user, supplier_document_id, comment, last_modified)
                                            VALUES ('$user_id', '$portal_user', '$supplier_document_last_id', '$document_comment', '$date')";
                                            mysqli_query($conn, $sql);
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
                if (isset($_POST["document_other_name"])) {
                    if (!empty($_POST["document_other_name"])) {
                        for ($i=0; $i < count($_POST["document_other_name"]); $i++) {
                            $document_names = addslashes($_POST["document_other_name"][$i]);
                            $document_filename = addslashes($_POST["document_other_filename"][$i]);
                            // $document_date = $_POST["document_other_date"][$i];
                            // $document_due = $_POST["document_other_due"][$i];
                            $document_comment = $_POST["document_other_comment"][$i];

                            $document_date = '';
                            $document_due = '';
                            $document_other_daterange = $_POST["document_other_daterange"][$i];
                            if (!empty($document_other_daterange)) {
                                $document_other_daterange = explode(' - ', $document_other_daterange);
                                $document_date = $document_other_daterange[0];
                                $document_due = $document_other_daterange[1];
                            }

                            $document_filetype = $_POST["document_other_filetype"][$i];
                            if ($document_filetype == 1) {
                                $files = $_FILES['document_other_file']['name'][$i];
                                $file_docs = "";
                                if (!empty($files)) {
                                    $tmp_docs = $_FILES['document_other_file']['tmp_name'][$i];
                                    $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                                    $ext = strtolower(pathinfo($files, PATHINFO_EXTENSION));
                                    $file_docs = $random.' - '.$files;
                                    $path_docs = $path.$file_docs;

                                    if(!in_array($ext, $invalid_extensions)) {
                                        move_uploaded_file($tmp_docs,$path_docs);
                                    } else {
                                        $process = false;
                                    }

                                }
                            } else {
                                $file_docs = $_POST["document_other_fileurl"][$i];
                            }
                        
                            $files_template = $_FILES['document_other_template']['name'][$i];
                            $file_docs_template = "";
                            if (!empty($files_template)) {
                                $tmp_docs = $_FILES['document_other_template']['tmp_name'][$i];
                                $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                                $ext = strtolower(pathinfo($files_template, PATHINFO_EXTENSION));
                                $file_docs_template = $random.' - '.$files_template;
                                $path_docs = $path.$file_docs_template;

                                if(!in_array($ext, $invalid_extensions)) {
                                    move_uploaded_file($tmp_docs,$path_docs);
                                } else {
                                    $process = false;
                                }

                            }

                            if ($process == true) {
                                $selectDocuments = mysqli_query( $conn,'SELECT * FROM tbl_supplier_document WHERE supplier_id="'. $data_ID .'" AND type="1" AND name="'.$document_names.'" ORDER BY ID LIMIT 1' );
                                if ( mysqli_num_rows($selectDocuments) > 0 ) {
                                    $rowDocuments = mysqli_fetch_array($selectDocuments);
                                    $sup_doc_id = $rowDocuments["ID"];

                                    mysqli_query( $conn,"UPDATE tbl_supplier_document set filename='". $document_filename ."', file_date='". $document_date ."', file_due='". $document_due ."' WHERE ID='". $sup_doc_id ."'" );
                                    if ($current_userEmployerID == 34 OR $current_userEmployerID == 27 OR $current_userEmployerID == 464 OR $current_userEmployerID == 1106) {
                                        $document_reviewed = $_POST["document_other_reviewed"][$i];
                                        $document_approved = $_POST["document_other_approved"][$i];
                                        mysqli_query( $conn,"UPDATE tbl_supplier_document set reviewed_by='". $document_reviewed ."', approved_by='". $document_approved ."' WHERE ID='". $sup_doc_id ."'" );
                                    }
                                
                                    if (!empty($file_docs)) { mysqli_query( $conn,"UPDATE tbl_supplier_document set file='". $file_docs ."', filetype='". $document_filetype ."' WHERE ID='". $sup_doc_id ."'" ); }
                                    if (!empty($file_docs_template)) { mysqli_query( $conn,"UPDATE tbl_supplier_document set template='". $file_docs_template ."' WHERE ID='". $sup_doc_id ."'" ); }

                                    if (!empty($document_comment)) {
                                        $sql = "INSERT INTO tbl_supplier_comment (user_id, portal_user, supplier_document_id, comment, last_modified)
                                        VALUES ('$user_id', '$portal_user', '$sup_doc_id', '$document_comment', '$date')";
                                        mysqli_query($conn, $sql);
                                    }
                                } else {
                                    $sql = "INSERT INTO tbl_supplier_document (user_id, portal_user, supplier_id, type, name, file, filetype, filename, file_date, file_due, template)
                                    VALUES ('$user_id', '$portal_user', '$data_ID', '1', '$document_names', '$file_docs', '$document_filetype', '$document_filename', '$document_date', '$document_due', '$file_docs_template')";
                                    if (mysqli_query($conn, $sql)) {
                                        $supplier_document_last_id = mysqli_insert_id($conn);

                                        if (!empty($document_comment)) {
                                            $sql = "INSERT INTO tbl_supplier_comment (user_id, portal_user, supplier_document_id, comment, last_modified)
                                            VALUES ('$user_id', '$portal_user', '$supplier_document_last_id', '$document_comment', '$date')";
                                            mysqli_query($conn, $sql);
                                        }
                                    }
                                }
                            }
                        }
                    }
                }

                if ($process == true) {
                    // Requirement Section
                    $requirement = array();
                    $requirement_email = "";
                    $selectRequirement = mysqli_query( $conn,"SELECT * FROM tbl_supplier_requirement" );
                    while($rowRequirement = mysqli_fetch_array($selectRequirement)) {
                        $data_document_arr = explode(" | ", $rowData["document"]);
                        foreach ($data_document_arr as $value) {
                            if ( $value == $rowRequirement["ID"] ) {
                                array_push($requirement, $rowRequirement["name"]);
                            }
                        }
                    }
                    if (!empty($requirement)) { $requirement_email = implode(' | ', $requirement); }

                    $compliance = 0;
                    $compliance_counter = 0;
                    $compliance_approved = 0;
                    if (!empty($_POST["document"])) {
                        $selectRequirement = mysqli_query( $conn,"SELECT * FROM tbl_supplier_requirement ORDER BY name" );
                        while($rowRequirement = mysqli_fetch_array($selectRequirement)) {
                            $req_id = $rowRequirement["ID"];
                            $req_name = $rowRequirement["name"];

                            $document_arr = implode(", ", $_POST["document"]);
                            $document_arr = explode(", ", $document_arr);
                            foreach ($document_arr as $value) {
                                if ( $value == $req_id ) {
                                    $selectDocument = mysqli_query( $conn,"SELECT * FROM tbl_supplier_document WHERE user_id='".$data_user_id."' AND supplier_id='".$ID."' AND name='".$req_id."'" );
                                    if ( mysqli_num_rows($selectDocument) > 0 ) {
                                        $rowDocument = mysqli_fetch_array($selectDocument);
                                        $doc_file_approved = $rowDocument["approved_by"];

                                        $compliance_counter++;
                                        // if ($doc_file_approved > 0) { $compliance_approved++; }

                                        $doc_file_due = $rowDocument["file_due"];
                                        if (!empty($doc_file_due)) {
                                            $doc_file_due = new DateTime($doc_file_due);
                                            $doc_file_due_o = $doc_file_due->format('Y/m/d');
                                            $doc_file_due_o_nearly = date('Y/m/d', strtotime($doc_file_due_o. ' - 30 days'));
                                            $doc_file_due = $doc_file_due->format('m/d/Y');

                                            if ($doc_file_due_o >= $current_dateNow_o && $doc_file_approved > 0) { $compliance_approved++; }
                                        };
                                    }
                                }
                            }
                        }
                    }

                    $requirement = implode(' | ', $requirement);
                    if (!empty($data_document_other)) {
                        $requirement .= " | ". $data_document_other;

                        $data_document_other_arr = array();
                        $data_document_other_arr = explode(' | ', $data_document_other);
                        $data_document_other_arr = implode(' | ', $data_document_other_arr);
                        $requirement_email .= " | ". $data_document_other_arr;

                        $document_other_arr = implode(" | ", $_POST["document_other"]);
                        $document_other_arr = explode(" | ", $document_other_arr);
                        foreach ($document_other_arr as $value) {
                            $selectDocument = mysqli_query( $conn,"SELECT * FROM tbl_supplier_document WHERE user_id='".$data_user_id."' AND supplier_id='".$ID."' AND name='".$value."'" );
                            if ( mysqli_num_rows($selectDocument) > 0 ) {
                                $rowDocument = mysqli_fetch_array($selectDocument);
                                $doc_file_approved = $rowDocument["approved_by"];

                                $compliance_counter++;
                                // if ($doc_file_approved > 0) { $compliance_approved++; }

                                $doc_file_due = $rowDocument["file_due"];
                                if (!empty($doc_file_due)) {
                                    $doc_file_due = new DateTime($doc_file_due);
                                    $doc_file_due_o = $doc_file_due->format('Y/m/d');
                                    $doc_file_due_o_nearly = date('Y/m/d', strtotime($doc_file_due_o. ' - 30 days'));
                                    $doc_file_due = $doc_file_due->format('m/d/Y');

                                    if ($doc_file_due_o >= $current_dateNow_o && $doc_file_approved > 0) { $compliance_approved++; }
                                };
                            }
                        }
                    }

                    if ($compliance_counter > 0) { $compliance = intval(($compliance_approved / $compliance_counter) * 100); }
                    else { $compliance = 0; }
                    mysqli_query( $conn,"UPDATE tbl_supplier set compliance = $compliance WHERE ID = $ID" );

                    // Category Section
                    $data_category_id = $rowData['category'];
                    $selectCategory = mysqli_query( $conn,'SELECT * FROM tbl_supplier_category WHERE ID="'. $data_category_id .'" ORDER BY ID LIMIT 1' );
                    $rowCategory = mysqli_fetch_array($selectCategory);
                    $data_category = $rowCategory['name'];

                    if ($data_page == 1) {
                        if ($data_category_id == "3") {
                            $data_material = $rowData['service'];
                            $material_arr = array();
                            if (!empty($data_material)) {
                                $data_material_arr = explode(", ", $data_material);
                                foreach ($data_material_arr as $value) {
                                    $selectMaterial = mysqli_query( $conn,"SELECT * FROM tbl_supplier_service WHERE ID=$value" );
                                    $rowMaterial = mysqli_fetch_array($selectMaterial);
                                    array_push($material_arr, $rowMaterial['service_name']);
                                }
                                $data_material = implode(', ', $material_arr);
                            }
                        } else {
                            $data_material = $rowData['material'];
                            $material_arr = array();
                            if (!empty($data_material)) {
                                $data_material_arr = explode(", ", $data_material);
                                foreach ($data_material_arr as $value) {
                                    $selectMaterial = mysqli_query( $conn,"SELECT * FROM tbl_supplier_material WHERE ID=$value" );
                                    $rowMaterial = mysqli_fetch_array($selectMaterial);
                                    array_push($material_arr, $rowMaterial['material_name']);
                                }
                                $data_material = implode(', ', $material_arr);
                            }
                        }
                    } else {
                        if ($data_category_id == "3") {
                            $data_material = $rowData['service'];
                            $material_arr = array();
                            if (!empty($data_material)) {
                                $data_material_arr = explode(", ", $data_material);
                                foreach ($data_material_arr as $value) {
                                    $selectMaterial = mysqli_query( $conn,"SELECT * FROM tbl_supplier_service WHERE ID=$value" );
                                    $rowMaterial = mysqli_fetch_array($selectMaterial);
                                    $service_id = $rowMaterial['service_name'];

                                    $selectServiceCategory = mysqli_query( $conn,"SELECT * FROM tbl_service_category WHERE id=$service_id" );
                                    $rowServiceCategory = mysqli_fetch_array($selectServiceCategory);
                                    array_push($material_arr, $rowServiceCategory['service_category']);
                                }
                                $data_material = implode(', ', $material_arr);
                            }
                        } else {
                            $data_material = $rowData['material'];
                            $material_arr = array();
                            if (!empty($data_material)) {
                                $data_material_arr = explode(", ", $data_material);
                                foreach ($data_material_arr as $value) {
                                    $selectMaterial = mysqli_query( $conn,"SELECT * FROM tbl_supplier_material WHERE ID=$value" );
                                    $rowMaterial = mysqli_fetch_array($selectMaterial);
                                    $material_id = $rowMaterial['material_name'];

                                    $selectProduct = mysqli_query( $conn,"SELECT * FROM tbl_products WHERE ID=$material_id" );
                                    $rowProduct = mysqli_fetch_array($selectProduct);
                                    array_push($material_arr, $rowProduct['name']);
                                }
                                $data_material = implode(', ', $material_arr);
                            }
                        }

                        $selectUser = mysqli_query( $conn,'SELECT * FROM tbl_user WHERE ID="'. $data_user_id .'" ORDER BY ID LIMIT 1' );
                        $rowUser = mysqli_fetch_array($selectUser);
                        $data_name = $rowUser['first_name'] .' '. $rowUser['last_name'];
                        $data_name = "Enterprise Name";
                    }

                    $counterup_tbl = counterup_tbl('supplier');
                    $output = array(
                        "ID" => $data_ID,
                        "page" => $data_page,
                        "supplier_name" => $data_name,
                        "category" => $data_category,
                        "compliance" => $compliance
                    );
                    $result = array_merge($counterup_tbl, $output);

                    if ($data_notification == 1) {
                        $data_company = "";
                        $data_email = "";
                        $selectEnterprise = mysqli_query( $conn,"SELECT * FROM tblEnterpiseDetails WHERE users_entities = $user_id" );
                        if ( mysqli_num_rows($selectEnterprise) > 0 ) {
                            $rowEnterprise = mysqli_fetch_array($selectEnterprise);
                            $data_company = $rowEnterprise["businessname"];
                            $data_email = $rowEnterprise["businessemailAddress"];
                        }

                        $selectDataTemp_Docs_Portal_User = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $portal_user" );
                        if ( mysqli_num_rows($selectDataTemp_Docs_Portal_User) > 0 ) {
                            $rowDataTemp_Docs_Portal_User = mysqli_fetch_array($selectDataTemp_Docs_Portal_User);
                            $portal_user_name = $rowDataTemp_Docs_Portal_User['first_name'] .' '. $rowDataTemp_Docs_Portal_User['last_name'];
                        }

                        $to = $supplier_email;
                        $user = $supplier_name;
                        $subject = 'Supplier Approval Program Updated!';
                        $body = 'Hi '.$user.',<br><br>

                        Here are some updates on tasks you\'re a collaborator on:
                        <ul>';

                        $has_changes = 0;
                        $mail_sent = 0;
                        $temp_document_output = json_decode($temp_document, true);
                        foreach ($temp_document_output as $key => $key_value) {
                            $doc_ID = $key_value['doc_ID'];
                            $doc_file = $key_value['doc_file'];
                            $doc_reviewedby = $key_value['doc_reviewedby'];
                            $doc_approvedby = $key_value['doc_approvedby'];

                            $selectDataTemp_Docs = mysqli_query( $conn,"SELECT * FROM tbl_supplier_document WHERE ID = $doc_ID" );
                            if ( mysqli_num_rows($selectDataTemp_Docs) > 0 ) {
                                $rowDataTemp_Docs = mysqli_fetch_array($selectDataTemp_Docs);
                                $user_change_name = $rowDataTemp_Docs['name'];
                                if ($rowDataTemp_Docs['type'] == 0) {
                                    $selectDataTemp_DocsReqName = mysqli_query( $conn,"SELECT * FROM tbl_supplier_requirement WHERE ID = $user_change_name" );
                                    if ( mysqli_num_rows($selectDataTemp_DocsReqName) > 0 ) {
                                        $rowDataTemp_DocsReqName = mysqli_fetch_array($selectDataTemp_DocsReqName);
                                        $user_change_name = $rowDataTemp_DocsReqName['name'];
                                    }
                                }

                                $user_change_file = $rowDataTemp_Docs['file'];
                                $user_change_filename = $rowDataTemp_Docs['filename'];
                                $user_change_reviewed_by = $rowDataTemp_Docs['reviewed_by'];
                                $user_change_approved_by = $rowDataTemp_Docs['approved_by'];

                                if (!empty($user_change_file) AND $user_change_file != $doc_file) {
                                    $body .= '<li>'.$user_change_name.' was Complied by '.$portal_user_name.'</li>';
                                    $has_changes++;
                                }
                                if ($user_change_reviewed_by > 0 AND $user_change_reviewed_by != $doc_reviewedby) {
                                    $selectDataTemp_Docs_Reviewed = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $user_change_reviewed_by" );
                                    if ( mysqli_num_rows($selectDataTemp_Docs_Reviewed) > 0 ) {
                                        $rowDataTemp_Docs_Reviewed = mysqli_fetch_array($selectDataTemp_Docs_Reviewed);
                                        $reviewed_user_name = $rowDataTemp_Docs_Reviewed['first_name'] .' '. $rowDataTemp_Docs_Reviewed['last_name'];

                                        $body .= '<li>'.$user_change_name.' was Reviewed by '.$reviewed_user_name.'</li>';
                                        $has_changes++;
                                    }
                                }
                                if ($user_change_approved_by > 0 AND $user_change_approved_by != $doc_approvedby) {
                                    $selectDataTemp_Docs_Approved = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $user_change_approved_by" );
                                    if ( mysqli_num_rows($selectDataTemp_Docs_Approved) > 0 ) {
                                        $rowDataTemp_Docs_Approved = mysqli_fetch_array($selectDataTemp_Docs_Approved);
                                        $approved_user_name = $rowDataTemp_Docs_Approved['first_name'] .' '. $rowDataTemp_Docs_Approved['last_name'];

                                        $body .= '<li>'.$user_change_name.' was Reviewed by '.$approved_user_name.'</li>';
                                        $has_changes++;
                                    }
                                }
                            }
                        }

                        $body .= '</ul>
                        Should you need assistance, kindly call 202-982-3002 or email '.$data_email.'<br><br>

                        InterlinkIQ.com Team<br>
                        Consultare Inc.';

                        // if ($has_changes > 0) { php_mailer_1($to, $user, $subject, $body, $data_email, $data_company); $mail_sent++; }


                        // Adding SAP Requirements
                        if (!empty($requirement_email)) {
                            $to = $supplier_email;
                            $user = $supplier_name;
                            $subject = 'Supplier Approval Requirements!';
                            $body = 'Hi '.$user.' Food Safety Team,<br><br>';

                            if ($user_id == 254) {
                                $body .= 'We are working with Jensen Meat Company (JMC) as part of their Supplier Approval Program (SAP). The '.$user.' has been identified as a Supplier/Service Provider of Jensen Meat Company  Plant Based.<br><br>';
                            } else {
                                $body .= 'We are working with '.$data_company.' as part of their Supplier Approval Program (SAP). Your company has been identified as a Supplier/Service Provider of '.$data_company.'.<br><br>';
                            }

                            $body .= 'We are requesting certain documents from your firm to comply with the SAP 21 CFR 117 Subpart G - Supply-Chain Program';

                            if ($_POST['supplier_countries'] != 'US') { $body .= ' / FSVP 21 CFR Subpart L - Foreign Supplier Verification Programs for Food Importers requirement'; }

                            $body .= '.<br><ol>';

                            $requirement_arr = explode(" | ", $requirement_email);
                            foreach ($requirement_arr as $value) {
                                $body .= '<li>'.$value.'</li>';
                            }

                            $body .= '</ol>

                            Follow the instructions below:<br><br>

                            To update Compliance:<br>
                            <ol>
                                <li>Go to <a href="'.$base_url.'" target="_blank">https://interlinkiq.com/</a> and click Log in. Enter your Username and Password.</li>
                                <li>Once successfully logged in, click the Enterprise Module.</li>
                                <li>Click Customer Module to view the list of your Customer.</li>
                                <li>Click View and go to Requirements Tab; comply by uploading the documents required in the list.</li>
                            </ol>

                            Kindly see the link below for our Customer Management Tutorial Video<br><br>

                            <table style="width: 100%; border-collapse: collapse;">
                                <tr>
                                    <td style="border: 1px solid; padding: 5px; text-align: center;"><b>Tutorial Video</b></td>
                                    <td style="border: 1px solid; padding: 5px; text-align: center;"><b>Video Link</b></td>
                                </tr>
                                <tr>
                                    <td style="border: 1px solid; padding: 5px;">Free Access - Enterprise Management Module</td>
                                    <td style="border: 1px solid; padding: 5px;">https://www.youtube.com/watch?v=pyhPjZKTlaE</td>
                                </tr>
                                <tr>
                                    <td style="border: 1px solid; padding: 5px;">Free Access - Customer Requirements Management Module</td>
                                    <td style="border: 1px solid; padding: 5px;">https://youtu.be/9XklXwGBr7E</td>
                                </tr>
                            </table><br><br>

                            Should you need assistance, kindly call 202-982-3002 or email '.$data_email.'<br><br>

                            InterlinkIQ.com Team<br><br>
                            Consultare Inc.';

                            if ($mail_sent > 0) {
                                // php_mailer_2($to, $user, $subject, $body, $data_email, $data_company);
                                $mail_sent++;
                            } else {
                                // php_mailer_1($to, $user, $subject, $body, $data_email, $data_company);
                                $mail_sent++;
                            }
                        }
            
                        // Contact Section
                        $data_contact = $rowData['contact'];
                        if (!empty($data_contact)) {
                            $data_contact_arr = explode(", ", $data_contact);
                            foreach ($data_contact_arr as $value) {
                                $selectContact = mysqli_query( $conn,"SELECT * FROM tbl_supplier_contact WHERE ID=$value" );
                                if ( mysqli_num_rows($selectContact) > 0 ) {
                                    while($rowContact = mysqli_fetch_array($selectContact)) {
                                        $contact_name = $rowContact["name"];
                                        $contact_email = $rowContact["email"];

                                        $to = $contact_email;
                                        $user = $contact_name;
                                        $subject = 'Supplier Approval Program Updated!';
                                        $body = 'Hi '.$user.',<br><br>

                                        Here are some updates on tasks you\'re a collaborator on:
                                        <ul>';

                                        $has_changes = 0;
                                        $temp_document_output = json_decode($temp_document, true);
                                        foreach ($temp_document_output as $key => $key_value) {
                                            $doc_ID = $key_value['doc_ID'];
                                            $doc_file = $key_value['doc_file'];
                                            $doc_reviewedby = $key_value['doc_reviewedby'];
                                            $doc_approvedby = $key_value['doc_approvedby'];

                                            $selectDataTemp_Docs = mysqli_query( $conn,"SELECT * FROM tbl_supplier_document WHERE ID = $doc_ID" );
                                            if ( mysqli_num_rows($selectDataTemp_Docs) > 0 ) {
                                                $rowDataTemp_Docs = mysqli_fetch_array($selectDataTemp_Docs);
                                                $user_change_name = $rowDataTemp_Docs['name'];
                                                if ($rowDataTemp_Docs['type'] == 0) {
                                                    $selectDataTemp_DocsReqName = mysqli_query( $conn,"SELECT * FROM tbl_supplier_requirement WHERE ID = $user_change_name" );
                                                    if ( mysqli_num_rows($selectDataTemp_DocsReqName) > 0 ) {
                                                        $rowDataTemp_DocsReqName = mysqli_fetch_array($selectDataTemp_DocsReqName);
                                                        $user_change_name = $rowDataTemp_DocsReqName['name'];
                                                    }
                                                }

                                                $user_change_file = $rowDataTemp_Docs['file'];
                                                $user_change_filename = $rowDataTemp_Docs['filename'];
                                                $user_change_reviewed_by = $rowDataTemp_Docs['reviewed_by'];
                                                $user_change_approved_by = $rowDataTemp_Docs['approved_by'];

                                                if (!empty($user_change_file) AND $user_change_file != $doc_file) {
                                                    $body .= '<li>'.$user_change_name.' was Complied by '.$portal_user_name.'</li>';
                                                    $has_changes++;
                                                }
                                                if ($user_change_reviewed_by > 0 AND $user_change_reviewed_by != $doc_reviewedby) {
                                                    $selectDataTemp_Docs_Reviewed = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $user_change_reviewed_by" );
                                                    if ( mysqli_num_rows($selectDataTemp_Docs_Reviewed) > 0 ) {
                                                        $rowDataTemp_Docs_Reviewed = mysqli_fetch_array($selectDataTemp_Docs_Reviewed);
                                                        $reviewed_user_name = $rowDataTemp_Docs_Reviewed['first_name'] .' '. $rowDataTemp_Docs_Reviewed['last_name'];

                                                        $body .= '<li>'.$user_change_name.' was Reviewed by '.$reviewed_user_name.'</li>';
                                                        $has_changes++;
                                                    }
                                                }
                                                if ($user_change_approved_by > 0 AND $user_change_approved_by != $doc_approvedby) {
                                                    $selectDataTemp_Docs_Approved = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $user_change_approved_by" );
                                                    if ( mysqli_num_rows($selectDataTemp_Docs_Approved) > 0 ) {
                                                        $rowDataTemp_Docs_Approved = mysqli_fetch_array($selectDataTemp_Docs_Approved);
                                                        $approved_user_name = $rowDataTemp_Docs_Approved['first_name'] .' '. $rowDataTemp_Docs_Approved['last_name'];

                                                        $body .= '<li>'.$user_change_name.' was Reviewed by '.$approved_user_name.'</li>';
                                                        $has_changes++;
                                                    }
                                                }
                                            }
                                        }

                                        $body .= '</ul>
                                        Should you need assistance, kindly call 202-982-3002 or email '.$data_email.'<br><br>

                                        InterlinkIQ.com Team<br>
                                        Consultare Inc.';

                                        if ($has_changes > 0) {
                                            if ($mail_sent > 0) {
                                                // php_mailer_2($to, $user, $subject, $body, $data_email, $data_company);
                                                $mail_sent++;
                                            } else {
                                                // php_mailer_1($to, $user, $subject, $body, $data_email, $data_company);
                                                $mail_sent++;
                                            }
                                        }



                                        // Adding SAP Requirements
                                        if (!empty($requirement_email)) {
                                            $to = $contact_email;
                                            $user = $contact_name;
                                            $subject = 'Supplier Approval Requirements!';
                                            $body = 'Hi '.$user.' Food Safety Team,<br><br>';

                                            if ($user_id == 254) {
                                                $body .= 'We are working with Jensen Meat Company (JMC) as part of their Supplier Approval Program (SAP). The '.$user.' has been identified as a Supplier/Service Provider of Jensen Meat Company  Plant Based.<br><br>';
                                            } else {
                                                $body .= 'We are working with '.$data_company.' as part of their Supplier Approval Program (SAP). Your company has been identified as a Supplier/Service Provider of '.$data_company.'.<br><br>';
                                            }

                                            $body .= 'We are requesting certain documents from your firm to comply with the SAP 21 CFR 117 Subpart G - Supply-Chain Program';

                                            if ($_POST['supplier_countries'] != 'US') { $body .= ' / FSVP 21 CFR Subpart L - Foreign Supplier Verification Programs for Food Importers requirement'; }

                                            $body .= '.<br><ol>';

                                            $requirement_arr = explode(" | ", $requirement_email);
                                            foreach ($requirement_arr as $value) {
                                                $body .= '<li>'.$value.'</li>';
                                            }

                                            $body .= '</ol>

                                            Follow the instructions below:<br><br>

                                            To update Compliance:<br>
                                            <ol>
                                                <li>Go to <a href="'.$base_url.'" target="_blank">https://interlinkiq.com/</a> and click Log in. Enter your Username and Password.</li>
                                                <li>Once successfully logged in, click the Enterprise Module.</li>
                                                <li>Click Customer Module to view the list of your Customer.</li>
                                                <li>Click View and go to Requirements Tab; comply by uploading the documents required in the list.</li>
                                            </ol>

                                            Kindly see the link below for our Customer Management Tutorial Video<br><br>

                                            <table style="width: 100%; border-collapse: collapse;">
                                                <tr>
                                                    <td style="border: 1px solid; padding: 5px; text-align: center;"><b>Tutorial Video</b></td>
                                                    <td style="border: 1px solid; padding: 5px; text-align: center;"><b>Video Link</b></td>
                                                </tr>
                                                <tr>
                                                    <td style="border: 1px solid; padding: 5px;">Free Access - Enterprise Management Module</td>
                                                    <td style="border: 1px solid; padding: 5px;">https://www.youtube.com/watch?v=pyhPjZKTlaE</td>
                                                </tr>
                                                <tr>
                                                    <td style="border: 1px solid; padding: 5px;">Free Access - Customer Requirements Management Module</td>
                                                    <td style="border: 1px solid; padding: 5px;">https://youtu.be/9XklXwGBr7E</td>
                                                </tr>
                                            </table><br><br>

                                            Should you need assistance, kindly call 202-982-3002 or email '.$data_email.'<br><br>

                                            InterlinkIQ.com Team<br><br>
                                            Consultare Inc.';

                                            if ($mail_sent > 0) {
                                                // php_mailer_2($to, $user, $subject, $body, $data_email, $data_company);
                                                $mail_sent++;
                                            } else {
                                                // php_mailer_1($to, $user, $subject, $body, $data_email, $data_company);
                                                $mail_sent++;
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                    
                    echo json_encode($result);
                    mysqli_close($conn);
                }
            }
        }

    }
    if( isset($_POST['btnSave_ImportDL']) ) {
        if (!empty($_COOKIE['switchAccount'])) {
            $portal_user = $_COOKIE['ID'];
            $user_id = $_COOKIE['switchAccount'];
        }
        else {
            $portal_user = $_COOKIE['ID'];
            $user_id = employerID($portal_user);
        }

        $files=$_FILES["file"]["tmp_name"];
        if($files) {
            $file = fopen($files, "r");
            $row = 0;
            $data = '';
            while (($getData = fgetcsv($file, 10000, ",")) !== FALSE) {
                if ($row > 0) {

                    $data .= '<tr>';
                        for ($i=0; $i < 6; $i++) { 
                            // $data .= '<td contenteditable="true" name="import_'.$i.'[]" required >'.$getData[$i].'</td>';
                            // $data .= '<td contenteditable="true" onchange="changeInput(this)" >
                            //     <input type="hidden" value="'.$getData[$i].'" />
                            //     '.$getData[$i].
                            // '</td>';
                            $data .= '<td ><textarea class="txta" name="import_'.$i.'[]" style="min-height: 26px;" required>'.$getData[$i].'</textarea></td>';
                        }
                        $data .= '<td class="text-center">
                            <a href="javascript:;" class="btn btn-sm btn-danger m-0" onclick="btnRemove_Import(this)">Remove</a>
                        </td>';
                    $data .= '</tr>';

                    // $sql = "INSERT INTO tbl_supplier (name)
                    // VALUES ('$getData[0]')";
                    // if (mysqli_query($conn, $sql)) {
                    //     // echo 'success';
                    // }
                }
                $row++;
            }

            fclose($file);  
        }

        $output = array(
            "data" => $data
        );
        echo json_encode($output);
    }
    if( isset($_POST['btnSave_ImportPreview']) ) {
        if (!empty($_COOKIE['switchAccount'])) {
            $portal_user = $_COOKIE['ID'];
            $user_id = $_COOKIE['switchAccount'];
        }
        else {
            $portal_user = $_COOKIE['ID'];
            $user_id = employerID($portal_user);
        }

        $data = '';
        $import = $_POST["import_0"];
        if (!empty($import)) {
            for ($i=0; $i < count($import); $i++) { 

                $supplier_name = $_POST['import_0'][$i];
                $supplier_category = 0;
                $supplier_industry = 0;
                $supplier_email= $_POST['import_5'][$i];
                $supplier_date = date('Y-m-d');

                $supplier_address = array();
                array_push($supplier_address, 'US');
                array_push($supplier_address, $_POST['import_1'][$i]);
                array_push($supplier_address, $_POST['import_2'][$i]);
                array_push($supplier_address, $_POST['import_3'][$i]);
                array_push($supplier_address, $_POST['import_4'][$i]);
                $supplier_address = implode(", ", $supplier_address);

                $audit_report = ' |  |  | ';
                $audit_certificate = ' |  |  | ';
                $audit_action = ' |  |  | ';

                $sql = "INSERT INTO tbl_supplier (user_id, portal_user, page, name, address, email, category, industry, audit_report, audit_certificate, audit_action, last_modified)
                VALUES ('$user_id', '$portal_user', '1', '$supplier_name', '$supplier_address', '$supplier_email', '$supplier_category', '$supplier_industry', '$audit_report', '$audit_certificate', '$audit_action', '$supplier_date')";
                if(mysqli_query($conn, $sql)) {
                    $last_id = mysqli_insert_id($conn);

                    $data .= '<tr id="tr_'. $last_id .'">
                        <td class="hide">'. $last_id .'</td>
                        <td>'. $supplier_name .'</td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td class="text-center hide"></td>
                        <td class="text-center">0%</td>
                        <td class="text-center">Pending</td>
                        <td class="text-center">
                            <div class="btn-group btn-group-circle">
                                <a href="#modalView" class="btn btn-outline dark btn-sm btnView" data-toggle="modal" onclick="btnView('. $last_id .')">View</a>
                                <a href="javascript:;" class="btn btn-danger btn-sm btnDelete" onclick="btnDelete('. $last_id .')">Delete</a>
                            </div>
                        </td>
                    </tr>';
                }
            }
        }
        $counterup_tbl = counterup_tbl('supplier');

        $output = array(
            "data" => $data
        );
        echo json_encode($output);
    }

    //Regulatory Section
    if( isset($_GET['modalNew_Supplier_Regulatory']) ) {
        $id = $_GET['modalNew_Supplier_Regulatory'];
        $modal = $_GET['m'];

        echo '<input class="form-control" type="hidden" name="ID" value="'.$id.'" />
        <input class="form-control" type="hidden" name="modal" value="'.$modal.'" />
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label class="control-label">Regulatory Name</label>
                    <input class="form-control" type="text" name="name" required />
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label class="control-label">Regulatory Number</label>
                    <input class="form-control" type="text" name="number" required />
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label class="control-label">Supporting File</label>
                    <select class="form-control" name="filetype" onchange="changeType(this)" required="">
                        <option value="0">Select option</option>
                        <option value="1">Manual Upload</option>
                        <option value="2">Youtube URL</option>
                        <option value="3">Google Drive URL</option>
                    </select>
                    <input class="form-control margin-top-15 fileUpload" type="file" name="file" style="display: none;">
                    <input class="form-control margin-top-15 fileURL" type="url" name="fileurl" style="display: none;" placeholder="https://">
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label class="control-label">Validity Date</label>
                    <div class="input-group">
                        <input type="text" class="form-control daterange" name="daterange" value="" />
                        <span class="input-group-btn">
                            <button class="btn default date-range-toggle" type="button" onclick="widget_date_clears(this)">
                                <i class="fa fa-close"></i>
                            </button>
                        </span>
                    </div>
                </div>
            </div>
        </div>';
    }
    if( isset($_GET['modalView_Supplier_Regulatory']) ) {
        $id = $_GET['modalView_Supplier_Regulatory'];
        $modal = $_GET['m'];

        $selectData = mysqli_query( $conn,"SELECT * from tbl_supplier_regulatory WHERE ID = $id" );
        $row = mysqli_fetch_array($selectData);

        $filetype = $row['filetype'];
        $files = $row["files"];
        $type = 'iframe';
        if (!empty($files)) {
            if ($filetype == 1) {
                $fileExtension = fileExtension($files);
                $src = $fileExtension['src'];
                $embed = $fileExtension['embed'];
                $type = $fileExtension['type'];
                $file_extension = $fileExtension['file_extension'];
                $url = $base_url.'uploads/supplier';

                $files = $src.$url.rawurlencode($files).$embed;
            } else if ($filetype == 3) {
                $files = preg_replace('#[^/]*$#', '', $files).'preview';
            }
        }

        echo '<input class="form-control" type="hidden" name="ID" value="'.$id.'" />
        <input class="form-control" type="hidden" name="modal" value="'.$modal.'" />
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label class="control-label">Regulatory Name</label>
                    <input class="form-control" type="text" name="name" value="'.$row['name'].'" required />
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label class="control-label">Regulatory Number</label>
                    <input class="form-control" type="text" name="number" value="'.$row['number'].'" required />
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label class="control-label">Supporting File</label>
                    <select class="form-control '; echo !empty($files) ? 'hide':''; echo '" name="filetype" onchange="changeType(this)" required>
                        <option value="0">Select option</option>
                        <option value="1">Manual Upload</option>
                        <option value="2">Youtube URL</option>
                        <option value="3">Google Drive URL</option>
                    </select>
                    <input class="form-control margin-top-15 fileUpload" type="file" name="file" style="display: none;" />
                    <input class="form-control margin-top-15 fileURL" type="url" name="fileurl" style="display: none;" placeholder="https://" />
                    <p class="'; echo !empty($files) ? '':'hide'; echo '" style="margin: 0;"><a href="'.$files.'" data-src="'.$files.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a> | <button type="button" class="btn btn-link uploadNew" onclick="uploadNew(this)">Upload New</button></p>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label class="control-label">Validity Date</label>
                    <div class="input-group">
                        <input type="text" class="form-control daterange" name="daterange" value="'.$row['registration_date'].' - '.$row['expiration_date'].'" />
                        <span class="input-group-btn">
                            <button class="btn default date-range-toggle" type="button" onclick="widget_date_clears(this)">
                                <i class="fa fa-close"></i>
                            </button>
                        </span>
                    </div>
                </div>
            </div>
        </div>';
    }
    if( isset($_POST['btnSave_Supplier_Regulatory']) ) { 
        if (!empty($_COOKIE['switchAccount'])) {
            $portal_user = $_COOKIE['ID'];
            $user_id = $_COOKIE['switchAccount'];
        }
        else {
            $portal_user = $_COOKIE['ID'];
            $user_id = employerID($portal_user);
        }

        $ID = $_POST['ID'];
        $modal = $_POST['modal'];
        $name = addslashes($_POST['name']);
        $number = addslashes($_POST['number']);
        $last_modified = date('Y-m-d');
        $arr_item = array();
        $filesize = 0;
        $process = true;

        $filetype = $_POST['filetype'];
        if ($filetype == 1) {
            $files = $_FILES['file']['name'];
            if (!empty($files)) {
                $filesize = $_FILES['file']['size'];
                $path = 'uploads/supplier/';
                $tmp = $_FILES['file']['tmp_name'];
                $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                $ext = strtolower(pathinfo($files, PATHINFO_EXTENSION));
                $files = rand(1000,1000000) . ' - ' . $files;
                $path = $path.$files;

                if(!in_array($ext, $invalid_extensions)) {
                    move_uploaded_file($tmp,$path);
                } else {
                    $process = false;
                }
            }
        } else {
            $files = $_POST['fileurl'];
        }

        if ($process == true) {
            $output = array (
                'type' =>  $filetype,
                'name' =>  $files,
                'size' =>  $filesize,
                'date' =>  $local_date
            );
            array_push($arr_item, $output);
            $file_history = json_encode($arr_item, JSON_HEX_APOS | JSON_UNESCAPED_UNICODE);

            $registration_date = '';
            $expiration_date = '';
            $daterange = $_POST["daterange"];
            if (!empty($daterange)) {
                $daterange = explode(' - ', $daterange);
                $registration_date = $daterange[0];
                $expiration_date = $daterange[1];
            }

            $sql = "INSERT INTO tbl_supplier_regulatory (user_id, portal_user, name, number, files, filetype, filesize, file_history, registration_date, expiration_date, last_modified)
            VALUES ('$user_id', '$portal_user', '$name', '$number', '$files', '$filetype', '$filesize', '$file_history', '$registration_date', '$expiration_date', '$last_modified')";
            if (mysqli_query($conn, $sql)) {
                $last_id = mysqli_insert_id($conn);

                $type = 'iframe';
                if (!empty($files)) {
                    if ($filetype == 1) {
                        $fileExtension = fileExtension($files);
                        $src = $fileExtension['src'];
                        $embed = $fileExtension['embed'];
                        $type = $fileExtension['type'];
                        $file_extension = $fileExtension['file_extension'];
                        $url = $base_url.'uploads/supplier/';

                        $files = $src.$url.rawurlencode($files).$embed;
                    } else if ($filetype == 3) {
                        $files = preg_replace('#[^/]*$#', '', $files).'preview';
                    }
                    $files = '<p style="margin: 0;"><a data-src="'.$files.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a></p>';
                }

                $data = '<tr id="tr_'.$last_id.'">
                    <td>'.$name.'</td>
                    <td>'.$number.'</td>
                    <td class="text-center">'.$files.'</td>
                    <td class="text-center">'.$registration_date.'</td>
                    <td class="text-center">'.$expiration_date.'</td>
                    <td class="text-center">
                        <input type="hidden" value="'.$last_id.'" name="regulatory[]" />
                        <div class="btn-group btn-group-circle">
                            <a href="#modalEditRegulatory" data-toggle="modal" class="btn btn-outline dark btn-sm btnEdit_Regulatory" onclick="btnEdit_Regulatory('.$last_id.', 2)">Edit</a>
                            <a href="javascript:;" class="btn btn-outlinex red btn-sm btnRemove_Regulatory" onclick="btnRemove_Regulatory('.$last_id.', 2)">Delete</a>
                        </div>
                    </td>
                </tr>';

                $output = array(
                    "ID" => $last_id,
                    "modal" => $modal,
                    "data" => $data
                );
                echo json_encode($output);
            }
        }
    }
    if( isset($_POST['btnUpdate_Supplier_Regulatory']) ) { 
        if (!empty($_COOKIE['switchAccount'])) {
            $portal_user = $_COOKIE['ID'];
            $user_id = $_COOKIE['switchAccount'];
        }
        else {
            $portal_user = $_COOKIE['ID'];
            $user_id = employerID($portal_user);
        }

        $ID = $_POST['ID'];
        $modal = $_POST['modal'];
        $name = addslashes($_POST['name']);
        $number = addslashes($_POST['number']);
        $last_modified = date('Y-m-d');
        $arr_item = array();
        $filesize = 0;
        $process = true;

        $selectData = mysqli_query( $conn,"SELECT * FROM tbl_supplier_regulatory WHERE ID = $ID");
        if ( mysqli_num_rows($selectData) > 0 ) {
            $rowData = mysqli_fetch_array($selectData);

            if (!empty($rowData['file_history'])) {
                $arr_item = json_decode($rowData["file_history"],true);
            }
        }

        $filetype = $_POST['filetype'];
        if ($filetype == 1) {
            $files = $_FILES['file']['name'];
            if (!empty($files)) {
                $filesize = $_FILES['file']['size'];
                $path = 'uploads/supplier/';
                $tmp = $_FILES['file']['tmp_name'];
                $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                $ext = strtolower(pathinfo($files, PATHINFO_EXTENSION));
                $files = rand(1000,1000000) . ' - ' . $files;
                $path = $path.$files;

                if(!in_array($ext, $invalid_extensions)) {
                    move_uploaded_file($tmp,$path);

                    mysqli_query( $conn,"UPDATE tbl_supplier_regulatory set files='". $files ."', filetype='". $filetype ."' WHERE ID='". $ID ."'" );
                } else {
                    $process = false;
                }
            }
        } else {
            $files = $_POST['fileurl'];
            if (!empty($files)) {
                mysqli_query( $conn,"UPDATE tbl_supplier_regulatory set files='". $files ."', filetype='". $filetype ."' WHERE ID='". $ID ."'" );
            }
        }

        if ($process == true) {
            $output = array (
                'type' =>  $filetype,
                'name' =>  $files,
                'size' =>  $filesize,
                'date' =>  $local_date
            );
            array_push($arr_item, $output);
            $file_history = json_encode($arr_item, JSON_HEX_APOS | JSON_UNESCAPED_UNICODE);

            $registration_date = '';
            $expiration_date = '';
            $daterange = $_POST["daterange"];
            if (!empty($daterange)) {
                $daterange = explode(' - ', $daterange);
                $registration_date = $daterange[0];
                $expiration_date = $daterange[1];
            }

            mysqli_query( $conn,"UPDATE tbl_supplier_regulatory set name='". $name ."', number='". $number ."', filesize='". $filesize ."', file_history='". $file_history ."', registration_date='". $registration_date ."', expiration_date='". $expiration_date ."' WHERE ID='". $ID ."'" );

            $type = 'iframe';
            if (!empty($files)) {
                if ($filetype == 1) {
                    $fileExtension = fileExtension($files);
                    $src = $fileExtension['src'];
                    $embed = $fileExtension['embed'];
                    $type = $fileExtension['type'];
                    $file_extension = $fileExtension['file_extension'];
                    $url = $base_url.'uploads/supplier/';

                    $files = $src.$url.rawurlencode($files).$embed;
                } else if ($filetype == 3) {
                    $files = preg_replace('#[^/]*$#', '', $files).'preview';
                }
                $files = '<p style="margin: 0;"><a data-src="'.$files.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a></p>';
            }

            $data = '<td>'.$name.'</td>
            <td>'.$number.'</td>
            <td class="text-center">'.$files.'</td>
            <td class="text-center">'.$registration_date.'</td>
            <td class="text-center">'.$expiration_date.'</td>
            <td class="text-center">
                <input type="hidden" value="'.$ID.'" name="regulatory[]" />
                <div class="btn-group btn-group-circle">
                    <a href="#modalEditRegulatory" data-toggle="modal" class="btn btn-outline dark btn-sm btnEdit_Regulatory" onclick="btnEdit_Regulatory('.$ID.', 2)">Edit</a>
                    <a href="javascript:;" class="btn btn-outlinex red btn-sm btnRemove_Regulatory" onclick="btnRemove_Regulatory('.$ID.', 2)">Delete</a>
                </div>
            </td>';

            $output = array(
                "ID" => $ID,
                "modal" => $modal,
                "data" => $data
            );
            echo json_encode($output);
        }
    }


	//Contact Section
	if( isset($_GET['modalNew_Supplier_Contact']) ) {
		$id = $_GET['modalNew_Supplier_Contact'];
		$modal = $_GET['m'];

		echo '<input class="form-control" type="hidden" name="ID" value="'.$id.'" />
		<input class="form-control" type="hidden" name="modal" value="'.$modal.'" />
		<div class="row">
	        <div class="col-md-9">
	            <div class="form-group">
	                <label class="control-label">Contact Name</label>
	                <input class="form-control" type="text" name="contact_name" required />
	            </div>
	        </div>
	        <div class="col-md-3">
	            <div class="form-group">
	                <label class="control-label">Title</label>
	                <input class="form-control" type="text" name="contact_title" />
	            </div>
	        </div>
	    </div>
	    <div class="row">
	        <div class="col-md-12">
	            <div class="form-group">
	                <label class="control-label">Address</label>
	                <input class="form-control" type="text" name="contact_address" required />
	            </div>
	        </div>
	    </div>
	    <div class="row">
	        <div class="col-md-6">
	            <div class="form-group">
	                <label class="control-label">Email</label>
	                <input class="form-control" type="email" name="contact_email" required />
	            </div>
	       	</div>
	        <div class="col-md-6">
	            <div class="form-group">
	                <label class="control-label">Phone</label>
	                <input class="form-control" type="text" name="contact_phone" />
	            </div>
	        </div>
	    </div>
	    <div class="row">
	        <div class="col-md-6">
	            <div class="form-group">
	                <label class="control-label">Cell No.</label>
	                <input class="form-control" type="text" name="contact_cell" />
	            </div>
	       	</div>
	        <div class="col-md-6">
	            <div class="form-group">
	                <label class="control-label">Fax</label>
	                <input class="form-control" type="text" name="contact_fax" />
	            </div>
	        </div>
	    </div>';
	}
	if( isset($_GET['modalView_Supplier_Contact']) ) {
		$id = $_GET['modalView_Supplier_Contact'];
		$modal = $_GET['m'];

		$selectData = mysqli_query( $conn,"SELECT * from tbl_supplier_contact WHERE ID = $id" );
        $row = mysqli_fetch_array($selectData);

		echo '<input class="form-control" type="hidden" name="ID" value="'.$id.'" />
		<input class="form-control" type="hidden" name="modal" value="'.$modal.'" />
		<div class="row">
	        <div class="col-md-9">
	            <div class="form-group">
	                <label class="control-label">Contact Name</label>
	                <input class="form-control" type="text" name="contact_name" value="'.$row['name'].'" required />
	            </div>
	        </div>
	        <div class="col-md-3">
	            <div class="form-group">
	                <label class="control-label">Title</label>
	                <input class="form-control" type="text" name="contact_title" value="'.$row['title'].'" />
	            </div>
	        </div>
	    </div>
	    <div class="row">
	        <div class="col-md-12">
	            <div class="form-group">
	                <label class="control-label">Address</label>
	                <input class="form-control" type="text" name="contact_address" value="'.$row['address'].'" required />
	            </div>
	        </div>
	    </div>
	    <div class="row">
	        <div class="col-md-6">
	            <div class="form-group">
	                <label class="control-label">Email</label>
	                <input class="form-control" type="email" name="contact_email" value="'.$row['email'].'" required />
	            </div>
	       	</div>
	        <div class="col-md-6">
	            <div class="form-group">
	                <label class="control-label">Phone</label>
	                <input class="form-control" type="text" name="contact_phone" value="'.$row['phone'].'" />
	            </div>
	        </div>
	    </div>
	    <div class="row">
	        <div class="col-md-6">
	            <div class="form-group">
	                <label class="control-label">Cell No.</label>
	                <input class="form-control" type="text" name="contact_cell" value="'.$row['cell'].'" />
	            </div>
	       	</div>
	        <div class="col-md-6">
	            <div class="form-group">
	                <label class="control-label">Fax</label>
	                <input class="form-control" type="text" name="contact_fax" value="'.$row['fax'].'" />
	            </div>
	        </div>
	    </div>';
    }
    if( isset($_GET['btnCheck_Supplier_Contact']) ) {
        $ID = $_GET['btnCheck_Supplier_Contact'];
        $notification = $_GET['n'];

        mysqli_query( $conn,"UPDATE tbl_supplier_contact SET notification = $notification WHERE ID = $ID" );
    }
	if( isset($_POST['btnSave_Supplier_Contact']) ) { 
		$ID = $_POST['ID'];
		$modal = $_POST['modal'];
		$contact_name = addslashes($_POST['contact_name']);
		$contact_title = addslashes($_POST['contact_title']);
		$contact_address = addslashes($_POST['contact_address']);
		$contact_email = addslashes($_POST['contact_email']);
		$contact_phone = addslashes($_POST['contact_phone']);
		$contact_cell = addslashes($_POST['contact_cell']);
		$contact_fax = addslashes($_POST['contact_fax']);

		$sql = "INSERT INTO tbl_supplier_contact (user_id, name, title, address, email, phone, cell, fax)
		VALUES ('$ID', '$contact_name', '$contact_title', '$contact_address', '$contact_email', '$contact_phone', '$contact_cell', '$contact_fax')";
		if (mysqli_query($conn, $sql)) {
			$last_id = mysqli_insert_id($conn);
            
            $output = array(
                "ID" => $last_id,
                "modal" => $modal,
                "contact_name" => htmlentities($contact_name ?? ''),
                "contact_title" => htmlentities($contact_title ?? ''),
                "contact_address" => htmlentities($contact_address ?? ''),
                "contact_email" => htmlentities($contact_email ?? ''),
                "contact_phone" => htmlentities($contact_phone ?? ''),
                "contact_cell" => htmlentities($contact_cell ?? ''),
                "contact_fax" => htmlentities($contact_fax ?? '')
            );
            echo json_encode($output);
		}
	}
	if( isset($_POST['btnUpdate_Supplier_Contact']) ) { 
		$ID = $_POST['ID'];
		$modal = $_POST['modal'];
		$contact_name = addslashes($_POST['contact_name']);
		$contact_title = addslashes($_POST['contact_title']);
		$contact_address = addslashes($_POST['contact_address']);
		$contact_email = addslashes($_POST['contact_email']);
		$contact_phone = addslashes($_POST['contact_phone']);
		$contact_cell = addslashes($_POST['contact_cell']);
		$contact_fax = addslashes($_POST['contact_fax']);

		mysqli_query( $conn,"UPDATE tbl_supplier_contact set name='". $contact_name ."', title='". $contact_title ."', address='". $contact_address ."', email='". $contact_email ."', phone='". $contact_phone ."', cell='". $contact_cell ."', fax='". $contact_fax ."' WHERE ID='". $ID ."'" );

		$output = array(
			"ID" => $ID,
			"modal" => $modal,
            "contact_name" => htmlentities($contact_name ?? ''),
            "contact_title" => htmlentities($contact_title ?? ''),
            "contact_address" => htmlentities($contact_address ?? ''),
            "contact_email" => htmlentities($contact_email ?? ''),
            "contact_phone" => htmlentities($contact_phone ?? ''),
            "contact_cell" => htmlentities($contact_cell ?? ''),
            "contact_fax" => htmlentities($contact_fax ?? '')
		);
		echo json_encode($output);
	}

	// Material Section
	if( isset($_GET['modalNew_Supplier_Material']) ) {
		$id = $_GET['modalNew_Supplier_Material'];
		$modal = $_GET['m'];

		echo '<input class="form-control" type="hidden" name="ID" value="'.$id.'" />
		<input class="form-control" type="hidden" name="modal" value="'.$modal.'" />
        <div class="row">
            <div class="col-md-3">
                <div class="form-group">
                    <label class="control-label">Material Name</label>
                    <input class="form-control" type="text" name="material_name" required />
                </div>
            </div>
            <div class="col-md-3">
                <div class="form-group">
                    <label class="control-label">SKU</label>
                    <input class="form-control" type="text" name="material_id" />
                </div>
            </div>

            <div class="col-md-6">
                <div class="row">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label class="control-label">UoM</label>
                            <input class="form-control" type="text" name="material_uom" />
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label class="control-label">Count</label>
                            <input class="form-control" type="text" name="material_count" />
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label class="control-label">Price Per Unit</label>
                            <input class="form-control" type="text" name="material_ppu" />
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6 hide">
                <div class="form-group">
                    <label class="control-label">Cost ($)</label>
                    <div class="row">
	                    <div class="col-md-4">
		                    <div class="input-icon right">
			                    <i class="fax fa-microphonex">/kg</i>
			                    <input type="number" class="form-control cost_kg" placeholder="Amount" name="cost_kg" onkeyup="changeCost(this.value, 1)" />
			                </div>
		                </div>
	                    <div class="col-md-4">
		                    <div class="input-icon right">
			                    <i class="fax fa-microphonex">/lb</i>
			                    <input type="number" class="form-control cost_lb" placeholder="Amount" name="cost_lb" onkeyup="changeCost(this.value, 2)" />
			                </div>
		                </div>
	                    <div class="col-md-4">
		                    <div class="input-icon right">
			                    <i class="fax fa-microphonex">/oz</i>
			                    <input type="number" class="form-control cost_oz" placeholder="Amount" name="cost_oz" onkeyup="changeCost(this.value, 3)" />
			                </div>
		                </div>
	                </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <div class="form-group">
                    <label class="control-label">Description of Use</label>
                    <textarea class="form-control" name="material_description" required></textarea>
                </div>
            </div>
            <div class="col-md-12">
                <div class="form-group">
                    <label class="control-label">Comments / Notes</label>
                    <textarea class="form-control" name="material_notes"></textarea>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label class="control-label">Allergen</label>
                    <select class="form-control mt-multiselect btn btn-default" name="allergen[]" multiple="multiple" required>
                        <option value="1">Milk</option>
                        <option value="2">Egg</option>
                        <option value="3">Fish (e.g., bass, flounder, cod)</option>
                        <option value="4">Crustacean shellfish (e.g., crab, lobster, shrimp)</option>
                        <option value="5">Tree nuts (e.g., almonds, walnuts, pecans)</option>
                        <option value="6">Peanuts</option>
                        <option value="7">Wheat</option>
                        <option value="8">Soybeans</option>
                        <option value="9">Sesame</option>
                        <option value="10">None</option>
                    </select>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label class="control-label">Allergen Other</label>
                    <input type="text" class="form-control tagsinput" name="allergen_other" data-role="tagsinput" placeholder="Enter allergen" />
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label class="control-label">Specification</label>
                    <input class="form-control" type="file" name="material_spec_file" />
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label class="control-label">Documentation Dates</label>
                    <div class="input-group">
	                    <input type="text" class="form-control daterange daterange_empty" name="material_spec_daterange" value="" />
	                    <span class="input-group-btn">
	                        <button class="btn default date-range-toggle" type="button" onclick="widget_date_clears(this)">
	                            <i class="fa fa-close"></i>
	                        </button>
	                    </span>
	                </div>
                    <div class="input-group input-large date-picker input-daterange hide">
                        <input type="date" class="form-control" name="material_spec_date_from" />
                        <span class="input-group-addon"> to </span>
                        <input type="date" class="form-control" name="material_spec_date_to" />
                    </div>
                </div>
            </div>
        </div>
        <div class="mt-repeater">
            <div data-repeater-list="material_other">
                <div class="mt-repeater-item row" data-repeater-item>
                    <div class="col-md-12">
                        <div class="form-group">
                            <label class="control-label">File Name</label>
                            <input class="form-control" type="text" name="material_file_name" />
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="control-label">File Document</label>
                            <input class="form-control" type="file" name="material_file_doc" />
                        </div>
                    </div>
                    <div class="col-md-5">
                        <div class="form-group">
                            <label class="control-label">Documentation Dates</label>
		                    <div class="input-group">
			                    <input type="text" class="form-control daterange daterange_empty" name="material_file_daterange" value="" />
			                    <span class="input-group-btn">
			                        <button class="btn default date-range-toggle" type="button" onclick="widget_date_clears(this)">
			                            <i class="fa fa-close"></i>
			                        </button>
			                    </span>
			                </div>
                            <div class="input-group input-large date-picker input-daterange hide">
                                <input type="date" class="form-control" name="material_file_from" />
                                <span class="input-group-addon"> to </span>
                                <input type="date" class="form-control" name="material_file_to" />
                            </div>
                        </div>
                    </div>
                    <div class="col-md-1">
                        <label style="visibility: hidden; display: block;">Remove</label>
                        <a href="javascript:;" data-repeater-delete class="btn btn-danger"><i class="fa fa-close"></i></a>
                    </div>
                </div>
            </div>
            <a href="javascript:;" data-repeater-create class="btn btn-success mt-repeater-add"><i class="fa fa-plus"></i> Add new file</a>
        </div>';
    }
	if( isset($_GET['modalView_Supplier_Material']) ) {
		$id = $_GET['modalView_Supplier_Material'];
		$modal = $_GET['m'];

		$selectData = mysqli_query( $conn,"SELECT * from tbl_supplier_material WHERE ID = $id" );
        $row = mysqli_fetch_array($selectData);

        $allergen = explode(", ", $row["allergen"]);

        $spec_file = $row['spec_file'];
        $fileExtension = fileExtension($spec_file);
		$src = $fileExtension['src'];
		$embed = $fileExtension['embed'];
		$type = $fileExtension['type'];
		$file_extension = $fileExtension['file_extension'];
	    $url = $base_url.'uploads/supplier/';

        $spec_date_from = $row['spec_date_from'];
		if (!empty($spec_date_from)) {
	        $spec_date_from = new DateTime($spec_date_from);
	        $spec_date_from = $spec_date_from->format('m/d/Y');
		}

        $spec_date_to = $row['spec_date_to'];
		if (!empty($spec_date_to)) {
	        $spec_date_to = new DateTime($spec_date_to);
	        $spec_date_to = $spec_date_to->format('m/d/Y');
		}
        
        echo '<input class="form-control" type="hidden" name="ID" value="'.$id.'" />
		<input class="form-control" type="hidden" name="modal" value="'.$modal.'" />
        <div class="row">
            <div class="col-md-3">
                <div class="form-group">
                    <label class="control-label">Active?</label>
                    <select class="form-control" name="active">
                        <option value="0" '; echo $row['active'] == 0 ? 'SELECTED':''; echo '>No</option>
                        <option value="1" '; echo $row['active'] == 1 ? 'SELECTED':''; echo '>Yes</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-3">
                <div class="form-group">
                    <label class="control-label">Material Name</label>
                    <input class="form-control" type="text" name="material_name" value="'.$row['material_name'].'" required />
                </div>
            </div>
            <div class="col-md-3">
                <div class="form-group">
                    <label class="control-label">SKU</label>
                    <input class="form-control" type="text" name="material_id" value="'.$row['material_id'].'" />
                </div>
            </div>

            <div class="col-md-6">
                <div class="row">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label class="control-label">UoM</label>
                            <input class="form-control" type="text" name="material_uom" value="'.$row['material_uom'].'" />
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label class="control-label">Count</label>
                            <input class="form-control" type="text" name="material_count" value="'.$row['material_count'].'" />
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label class="control-label">Price Per Unit</label>
                            <input class="form-control" type="text" name="material_ppu" value="'.$row['material_ppu'].'" />
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6 hide">
                <div class="form-group">
                    <label class="control-label">Cost ($)</label>
                    <div class="row">
	                    <div class="col-md-4">
		                    <div class="input-icon right">
			                    <i class="fax fa-microphonex">/kg</i>
			                    <input type="number" class="form-control cost_kg" placeholder="Amount" name="cost_kg" onkeyup="changeCost(this.value, 1)" value="'.$row['cost_kg'].'" />
			                </div>
		                </div>
	                    <div class="col-md-4">
		                    <div class="input-icon right">
			                    <i class="fax fa-microphonex">/lb</i>
			                    <input type="number" class="form-control cost_lb" placeholder="Amount" name="cost_lb" onkeyup="changeCost(this.value, 2)" value="'.$row['cost_lb'].'" />
			                </div>
		                </div>
	                    <div class="col-md-4">
		                    <div class="input-icon right">
			                    <i class="fax fa-microphonex">/oz</i>
			                    <input type="number" class="form-control cost_oz" placeholder="Amount" name="cost_oz" onkeyup="changeCost(this.value, 3)" value="'.$row['cost_oz'].'" />
			                </div>
		                </div>
	                </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <div class="form-group">
                    <label class="control-label">Description of Use</label>
                    <textarea class="form-control" name="material_description" required>'.$row['description'].'</textarea>
                </div>
            </div>
            <div class="col-md-12">
                <div class="form-group">
                    <label class="control-label">Comments / Notes</label>
                    <textarea class="form-control" name="material_notes">'.$row['notes'].'</textarea>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label class="control-label">Allergen</label>
                    <select class="form-control mt-multiselect btn btn-default" name="allergen[]" multiple="multiple" required>
                        <option value="1" '; echo in_array(1, $allergen) ? 'SELECTED' : ''; echo '>Milk</option>
                        <option value="2" '; echo in_array(2, $allergen) ? 'SELECTED' : ''; echo '>Egg</option>
                        <option value="3" '; echo in_array(3, $allergen) ? 'SELECTED' : ''; echo '>Fish (e.g., bass, flounder, cod)</option>
                        <option value="4" '; echo in_array(4, $allergen) ? 'SELECTED' : ''; echo '>Crustacean shellfish (e.g., crab, lobster, shrimp)</option>
                        <option value="5" '; echo in_array(5, $allergen) ? 'SELECTED' : ''; echo '>Tree nuts (e.g., almonds, walnuts, pecans)</option>
                        <option value="6" '; echo in_array(6, $allergen) ? 'SELECTED' : ''; echo '>Peanuts</option>
                        <option value="7" '; echo in_array(7, $allergen) ? 'SELECTED' : ''; echo '>Wheat</option>
                        <option value="8" '; echo in_array(8, $allergen) ? 'SELECTED' : ''; echo '>Soybeans</option>
                        <option value="9" '; echo in_array(9, $allergen) ? 'SELECTED' : ''; echo '>Sesame</option>
                        <option value="10" '; echo in_array(10, $allergen) ? 'SELECTED' : ''; echo '>None</option>
                    </select>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label class="control-label">Allergen Other</label>
                    <input type="text" class="form-control tagsinput" name="allergen_other" data-role="tagsinput" value="'.$row['allergen_other'].'" placeholder="Enter allergen" />
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <input type="hidden" name="material_spec_file_temp" value="'.$spec_file.'" />
                    <label class="control-label">Specification</label>
                    <input class="form-control '; echo !empty($spec_file) ? 'hide':''; echo '" type="file" name="material_spec_file" />
                    <p class="'; echo !empty($spec_file) ? '':'hide'; echo '" style="margin: 0;"><a href="'.$src.$url.rawurlencode($spec_file).$embed.'" data-src="'.$src.$url.rawurlencode($spec_file).$embed.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a> | <button type="button" class="btn btn-link uploadNewOld" onclick="uploadNewOld(this)">Upload New</button></p>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label class="control-label">Documentation Dates</label>
                    <div class="input-group">
	                    <input type="text" class="form-control daterange '; if (empty($spec_date_from) || empty($spec_date_to)) { echo 'daterange_empty'; } echo '" name="material_spec_daterange" value="'; if (!empty($spec_date_from) && !empty($spec_date_to)) { echo $spec_date_from .' - '. $spec_date_to; } echo '" />
	                    <span class="input-group-btn">
	                        <button class="btn default date-range-toggle" type="button" onclick="widget_date_clears(this)">
	                            <i class="fa fa-close"></i>
	                        </button>
	                    </span>
	                </div>
                    <div class="input-group input-large date-picker input-daterange hide">
                        <input type="date" class="form-control" name="material_spec_date_from" value="'.$spec_date_from.'" />
                        <span class="input-group-addon"> to </span>
                        <input type="date" class="form-control" name="material_spec_date_to" value="'.$spec_date_to.'" />
                    </div>
                </div>
            </div>
        </div>
        <div class="mt-repeater">
            <div data-repeater-list="material_other">';

            	$other = $row['other'];
            	$other_arr = json_decode($other,true);
                $other_count = count($other_arr);
            	if (!empty($other)) {
            		foreach ($other_arr as $key => $value) {
                        $name = $value['name'];
                        $material_file_doc = $value['material_file_doc'];

                        $from = $value['from'];
						if (!empty($from)) {
					        $from = new DateTime($from);
					        $from = $from->format('m/d/Y');
						}
						
                        $to = $value['to'];
						if (!empty($to)) {
					        $to = new DateTime($to);
					        $to = $to->format('m/d/Y');
						}

                        $fileExtension = fileExtension($material_file_doc);
						$src = $fileExtension['src'];
						$embed = $fileExtension['embed'];
						$type = $fileExtension['type'];
						$file_extension = $fileExtension['file_extension'];
                        $url = $base_url.'uploads/supplier/';

                        echo '<div class="mt-repeater-item row" data-repeater-item>
		                    <div class="col-md-12">
		                        <div class="form-group">
		                            <label class="control-label">File Name</label>
		                            <input class="form-control" type="text" name="material_file_name" value="'.$name.'" />
		                        </div>
		                    </div>
		                    <div class="col-md-6">
		                        <div class="form-group">
                                    <input type="hidden" name="material_file_doc_temp" value="'.$material_file_doc.'" />
                                    <label class="control-label">File Document</label>
                                    <input class="form-control '; echo !empty($material_file_doc) ? 'hide':''; echo '" type="file" name="material_file_doc" />
                                    <p class="'; echo !empty($material_file_doc) ? '':'hide'; echo '" style="margin: 0;"><a href="'.$src.$url.rawurlencode($material_file_doc).$embed.'" data-src="'.$src.$url.rawurlencode($material_file_doc).$embed.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a> | <button type="button" class="btn btn-link uploadNewOld" onclick="uploadNewOld(this)">Upload New</button></p>
		                        </div>
		                    </div>
		                    <div class="col-md-5">
		                        <div class="form-group">
		                            <label class="control-label">Documentation Dates</label>
				                    <div class="input-group">
					                    <input type="text" class="form-control daterange '; if (empty($from) || empty($to)) { echo 'daterange_empty'; } echo '" name="material_file_daterange" value="'; if (!empty($from) && !empty($to)) { echo $from .' - '. $to; } echo '" />
					                    <span class="input-group-btn">
					                        <button class="btn default date-range-toggle" type="button" onclick="widget_date_clears(this)">
					                            <i class="fa fa-close"></i>
					                        </button>
					                    </span>
					                </div>
		                            <div class="input-group input-large date-picker input-daterange hide">
		                                <input type="date" class="form-control" name="material_file_from" value="'.$from.'" />
		                                <span class="input-group-addon"> to </span>
		                                <input type="date" class="form-control" name="material_file_to" value="'.$to.'" />
		                            </div>
		                        </div>
		                    </div>
		                    <div class="col-md-1">
		                        <label style="visibility: hidden; display: block;">Remove</label>
		                        <a href="javascript:;" data-repeater-delete class="btn btn-danger"><i class="fa fa-close"></i></a>
		                    </div>
		                </div>';
                    }
            	}
            echo '</div>
            <a href="javascript:;" data-repeater-create class="btn btn-success mt-repeater-add"><i class="fa fa-plus"></i> Add new file</a>
        </div>';
    }
	if( isset($_POST['btnSave_Supplier_Material']) ) { 
		$ID = $_POST['ID'];
		$modal = $_POST['modal'];
		$path = 'uploads/supplier/';
		$random = rand(1000,1000000);
        $arr_item = array();
        $filesize = 0;
        $spec_filesize = 0;
        $spec_filesize_other = 0;
        $process = true;

		$material_name = addslashes($_POST['material_name']);
		$material_id = $_POST['material_id'];
		$material_uom = $_POST['material_uom'];
        $material_count = $_POST['material_count'];
		$material_ppu = $_POST['material_ppu'];
		$cost_kg = $_POST['cost_kg'];
		$cost_lb = $_POST['cost_lb'];
		$cost_oz = $_POST['cost_oz'];
		$material_description = addslashes($_POST['material_description']);
		$material_notes = addslashes($_POST['material_notes']);

        $allergen = "";
        if (!empty($_POST["allergen"])) { $allergen = implode(", ", $_POST["allergen"]); }
        $allergen_other = addslashes($_POST['allergen_other']);

		$material_spec_file = $_FILES['material_spec_file']['name'];
		$material_spec_file_final = "";
		if (!empty($material_spec_file)) {
            $spec_filesize = $_FILES['material_spec_file']['size'];
            $material_spec_file_tmp = $_FILES['material_spec_file']['tmp_name'];
            $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
            $ext = strtolower(pathinfo($material_spec_file, PATHINFO_EXTENSION));
            $material_spec_file_final = $random.' - '.$material_spec_file;
            $material_spec_file_path = $path.$material_spec_file_final;

            if(!in_array($ext, $invalid_extensions)) {
                move_uploaded_file($material_spec_file_tmp, $material_spec_file_path);

                $output = array (
                    'type' =>  0,
                    'name' =>  $material_spec_file_final,
                    'size' =>  $spec_filesize,
                    'date' =>  $local_date
                );
                array_push($arr_item, $output);
            } else {
                $process = false;
            }
        }
		// $material_spec_date_from = $_POST['material_spec_date_from'];
		// $material_spec_date_to = $_POST['material_spec_date_to'];

		$material_spec_date_from = '';
		$material_spec_date_to = '';
		$material_spec_daterange = $_POST["material_spec_daterange"];
		if (!empty($material_spec_daterange)) {
			$material_spec_daterange = explode(' - ', $material_spec_daterange);
			$material_spec_date_from = $material_spec_daterange[0];
			$material_spec_date_to = $material_spec_daterange[1];
		}

		$material_other_arr = array();
		for ($i=0; $i < count($_POST['material_other']); $i++) {
			$material_file_name = $_POST['material_other'][$i]['material_file_name'];

			// $material_file_from = $_POST['material_other'][$i]['material_file_from'];
			// $material_file_to = $_POST['material_other'][$i]['material_file_to'];

			$material_file_from = '';
			$material_file_to = '';
			$material_file_daterange = $_POST['material_other'][$i]['material_file_daterange'];
			if (!empty($material_file_daterange)) {
				$material_file_daterange = explode(' - ', $material_file_daterange);
				$material_file_from = $material_file_daterange[0];
				$material_file_to = $material_file_daterange[1];
			}

			$material_file_doc = $_FILES['material_other']['name'][$i];
			$material_file_doc_final = implode('*', $material_file_doc);

			if (!empty($material_file_doc_final)) {
                $spec_filesize_other = implode('*', $_FILES['material_other']['size'][$i]);
                $material_file_doc_tmp = implode('*', $_FILES['material_other']['tmp_name'][$i]);
                $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                $ext = strtolower(pathinfo($material_file_doc, PATHINFO_EXTENSION));
                $material_file_doc_final = $random.' - '.$material_file_doc_final;
                $material_file_doc_path = $path.$material_file_doc_final;

                if(!in_array($ext, $invalid_extensions)) {
                    move_uploaded_file($material_file_doc_tmp, $material_file_doc_path);

                    $filesize += $spec_filesize_other;

                    $output = array (
                        'type'  =>  0,
                        'name' =>  $material_file_doc_final,
                        'size' =>  $spec_filesize_other,
                        'date' =>  $local_date
                    );
                    array_push($arr_item, $output);
                } else {
                    $process = false;
                }
            }

			$material_other_data = array (
				'name' => $material_file_name,
				'material_file_doc' =>$material_file_doc_final,
				'from' =>$material_file_from,
				'to' =>$material_file_to
			);
			array_push( $material_other_arr, $material_other_data );
		}
		$material_other = json_encode($material_other_arr);
        $file_history = json_encode($arr_item, JSON_HEX_APOS | JSON_UNESCAPED_UNICODE);

        if ($process == true) {
    		$sql = "INSERT INTO tbl_supplier_material (user_id, material_name, material_id, material_uom, material_count, material_ppu, cost_kg, cost_lb, cost_oz, description, notes, allergen, allergen_other, spec_file, spec_filesize, spec_date_from, spec_date_to, other, other_filesize, file_history)
            VALUES ('$ID', '$material_name', '$material_id', '$material_uom', '$material_count', '$material_ppu', '$cost_kg', '$cost_lb', '$cost_oz', '$material_description', '$material_notes', '$allergen', '$allergen_other', '$material_spec_file_final', '$spec_filesize', '$material_spec_date_from', '$material_spec_date_to', '$material_other', '$filesize', '$file_history')";
            if (mysqli_query($conn, $sql)) {
    			$last_id = mysqli_insert_id($conn);
    		}

    		$output = array(
    			"ID" => $last_id,
    			"modal" => $modal,
    			"material_name" => $material_name,
    			"material_id" => $material_id,
    			"material_description" => $material_description
    		);
    		echo json_encode($output);
    	}
    }
	if( isset($_POST['btnUpdate_Supplier_Material']) ) { 
		$ID = $_POST['ID'];
		$modal = $_POST['modal'];
		$path = 'uploads/supplier/';
		$random = rand(1000,1000000);
        $arr_item = array();
        $filesize = 0;
        $spec_filesize = 0;
        $spec_filesize_other = 0;
        $process = true;

        $selectData = mysqli_query( $conn,"SELECT * FROM tbl_supplier_material WHERE ID = $ID");
        if ( mysqli_num_rows($selectData) > 0 ) {
            $rowData = mysqli_fetch_array($selectData);

            if (!empty($rowData['file_history'])) {
                $arr_item = json_decode($rowData["file_history"],true);
            }
        }

		$material_name = addslashes($_POST['material_name']);
		$material_id = $_POST['material_id'];
        $material_active = $_POST['active'];
		$material_uom = $_POST['material_uom'];
        $material_count = $_POST['material_count'];
		$material_ppu = $_POST['material_ppu'];
		$cost_kg = $_POST['cost_kg'];
		$cost_lb = $_POST['cost_lb'];
		$cost_oz = $_POST['cost_oz'];
		$material_description = addslashes($_POST['material_description']);
		$material_notes = addslashes($_POST['material_notes']);

        $allergen = "";
        if (!empty($_POST["allergen"])) { $allergen = implode(", ", $_POST["allergen"]); }
        $allergen_other = addslashes($_POST['allergen_other']);

		$material_spec_file_final = $_POST['material_spec_file_temp'];
		$material_spec_file = $_FILES['material_spec_file']['name'];
		if (!empty($material_spec_file)) {
            $spec_filesize = $_FILES['material_spec_file']['size'];
			$material_spec_file_tmp = $_FILES['material_spec_file']['tmp_name'];
            $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
            $ext = strtolower(pathinfo($material_spec_file, PATHINFO_EXTENSION));
			$material_spec_file_final = $random.' - '.$material_spec_file;
			$material_spec_file_path = $path.$material_spec_file_final;

            if(!in_array($ext, $invalid_extensions)) {
                move_uploaded_file($material_spec_file_tmp, $material_spec_file_path);

                $output = array (
                    'type'  =>  0,
                    'name' =>  $material_spec_file_final,
                    'size' =>  $spec_filesize,
                    'date' =>  $local_date
                );
                array_push($arr_item, $output);
            } else {
                $process = false;
            }
		}
		// $material_spec_date_from = $_POST['material_spec_date_from'];
		// $material_spec_date_to = $_POST['material_spec_date_to'];

		$material_spec_date_from = '';
		$material_spec_date_to = '';
		$material_spec_daterange = $_POST["material_spec_daterange"];
		if (!empty($material_spec_daterange)) {
			$material_spec_daterange = explode(' - ', $material_spec_daterange);
			$material_spec_date_from = $material_spec_daterange[0];
			$material_spec_date_to = $material_spec_daterange[1];
		}

		$material_other_arr = array();
		for ($i=0; $i < count($_POST['material_other']); $i++) {
			$material_file_name = $_POST['material_other'][$i]['material_file_name'];
			// $material_file_from = $_POST['material_other'][$i]['material_file_from'];
			// $material_file_to = $_POST['material_other'][$i]['material_file_to'];

			$material_file_from = '';
			$material_file_to = '';
			$material_file_daterange = $_POST['material_other'][$i]['material_file_daterange'];
			if (!empty($material_file_daterange)) {
				$material_file_daterange = explode(' - ', $material_file_daterange);
				$material_file_from = $material_file_daterange[0];
				$material_file_to = $material_file_daterange[1];
			}

			$material_file_doc_final = $_POST['material_other'][$i]['material_file_doc_temp'];
			$material_file_doc = $_FILES['material_other']['name'][$i];
			$material_file_doc = implode('*', $material_file_doc);
			if (!empty($material_file_doc)) {
				$spec_filesize_other = implode('*', $_FILES['material_other']['size'][$i]);
                $material_file_doc_tmp = implode('*', $_FILES['material_other']['tmp_name'][$i]);
                $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                $ext = strtolower(pathinfo($material_file_doc, PATHINFO_EXTENSION));
				$material_file_doc_final = $random.' - '.$material_file_doc;
				$material_file_doc_path = $path.$material_file_doc_final;

                if(!in_array($ext, $invalid_extensions)) {
                    move_uploaded_file($material_file_doc_tmp, $material_file_doc_path);

                    $filesize += $spec_filesize_other;

                    $output = array (
                        'type'  =>  0,
                        'name' =>  $material_file_doc_final,
                        'size' =>  $spec_filesize_other,
                        'date' =>  $local_date
                    );
                    array_push($arr_item, $output);
                } else {
                    $process = false;
                }
			}

			$material_other_data = array (
				'name' => $material_file_name,
				'material_file_doc' =>$material_file_doc_final,
				'from' =>$material_file_from,
				'to' =>$material_file_to
			);
			array_push( $material_other_arr, $material_other_data );
		}
		$material_other = json_encode($material_other_arr);
        $file_history = json_encode($arr_item, JSON_HEX_APOS | JSON_UNESCAPED_UNICODE);

        if ($process == true) {
    		mysqli_query( $conn,"UPDATE tbl_supplier_material set active='". $material_active ."', material_name='". $material_name ."', material_id='". $material_id ."', material_uom='". $material_uom ."', material_count='". $material_count ."', material_ppu='". $material_ppu ."', cost_kg='". $cost_kg ."', cost_lb='". $cost_lb ."', cost_oz='". $cost_oz ."', description='". $material_description ."', notes='". $material_notes ."', allergen='". $allergen ."', allergen_other='". $allergen_other ."', spec_file='". $material_spec_file_final ."', spec_filesize='". $spec_filesize ."', spec_date_from='". $material_spec_date_from ."', spec_date_to='". $material_spec_date_to ."', other='". $material_other ."', other_filesize='". $filesize ."', file_history='". $file_history ."' WHERE ID='". $ID ."'" );

    		$output = array(
    			"ID" => $ID,
    			"modal" => $modal,
                "material_active" => $material_active == 1 ? 'Yes':'No',
    			"material_name" => $material_name,
    			"material_id" => $material_id,
    			"material_description" => $material_description
    		);
    		echo json_encode($output);
    	}
    }

	// Service Section
	if( isset($_GET['modalNew_Supplier_Service']) ) {
		$id = $_GET['modalNew_Supplier_Service'];
		$modal = $_GET['m'];

		echo '<input class="form-control" type="hidden" name="ID" value="'.$id.'" />
		<input class="form-control" type="hidden" name="modal" value="'.$modal.'" />
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label class="control-label">Service Name</label>
                    <input class="form-control" type="text" name="service_name" required />
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label class="control-label">Service ID</label>
                    <input class="form-control" type="text" name="service_id" required />
                </div>
            </div>
            <div class="col-md-12">
                <div class="form-group">
                    <label class="control-label">Description of Service</label>
                    <textarea class="form-control" name="service_description" required></textarea>
                </div>
            </div>
            <div class="col-md-12">
                <div class="form-group">
                    <label class="control-label">Comments / Notes</label>
                    <textarea class="form-control" name="service_notes"></textarea>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label class="control-label">Specification</label>
                    <input class="form-control" type="file" name="service_spec_file" />
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label class="control-label">Documentation Dates</label>
                    <div class="input-group input-large date-picker input-daterange">
                        <input type="date" class="form-control" name="service_spec_date_from" />
                        <span class="input-group-addon"> to </span>
                        <input type="date" class="form-control" name="service_spec_date_to" />
                    </div>
                </div>
            </div>
        </div>
        <div class="mt-repeater">
            <div data-repeater-list="service_other">
                <div class="mt-repeater-item row" data-repeater-item>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label class="control-label">File Name</label>
                            <input class="form-control" type="text" name="service_file_name" />
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label class="control-label">File Document</label>
                            <input class="form-control" type="file" name="service_file_doc" />
                        </div>
                    </div>
                    <div class="col-md-5">
                        <div class="form-group">
                            <label class="control-label">Documentation Dates</label>
                            <div class="input-group input-large date-picker input-daterange">
                                <input type="date" class="form-control" name="service_file_from" />
                                <span class="input-group-addon"> to </span>
                                <input type="date" class="form-control" name="service_file_to" />
                            </div>
                        </div>
                    </div>
                    <div class="col-md-1">
                        <label style="visibility: hidden; display: block;">Remove</label>
                        <a href="javascript:;" data-repeater-delete class="btn btn-danger"><i class="fa fa-close"></i></a>
                    </div>
                </div>
            </div>
            <a href="javascript:;" data-repeater-create class="btn btn-success mt-repeater-add"><i class="fa fa-plus"></i> Add new file</a>
        </div>';
	}
	if( isset($_GET['modalView_Supplier_Service']) ) {
		$id = $_GET['modalView_Supplier_Service'];
		$modal = $_GET['m'];

		$selectData = mysqli_query( $conn,"SELECT * from tbl_supplier_service WHERE ID = $id" );
        $row = mysqli_fetch_array($selectData);


        $spec_file = $row['spec_file'];
        $fileExtension = fileExtension($spec_file);
		$src = $fileExtension['src'];
		$embed = $fileExtension['embed'];
		$type = $fileExtension['type'];
		$file_extension = $fileExtension['file_extension'];
	    $url = $base_url.'uploads/supplier/';
        
        echo '<input class="form-control" type="hidden" name="ID" value="'.$id.'" />
		<input class="form-control" type="hidden" name="modal" value="'.$modal.'" />
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label class="control-label">Service Name</label>
                    <input class="form-control" type="text" name="service_name" value="'.$row['service_name'].'" required />
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label class="control-label">Service ID</label>
                    <input class="form-control" type="text" name="service_id" value="'.$row['service_id'].'" required />
                </div>
            </div>
            <div class="col-md-12">
                <div class="form-group">
                    <label class="control-label">Description of Service</label>
                    <textarea class="form-control" name="service_description" required>'.$row['description'].'</textarea>
                </div>
            </div>
            <div class="col-md-12">
                <div class="form-group">
                    <label class="control-label">Comments / Notes</label>
                    <textarea class="form-control" name="service_notes">'.$row['notes'].'</textarea>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <input type="hidden" name="service_spec_file_tmp" value="'.$spec_file.'" />
                    <label class="control-label">Specification</label>
                    <input class="form-control '; echo !empty($spec_file) ? 'hide':''; echo '" type="file" name="service_spec_file" />
                    <p class="'; echo !empty($spec_file) ? '':'hide'; echo '" style="margin: 0;"><a href="'.$src.$url.rawurlencode($spec_file).$embed.'" data-src="'.$src.$url.rawurlencode($spec_file).$embed.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a> | <button type="button" class="btn btn-link uploadNew" onclick="uploadNew(this)">Upload New</button></p>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label class="control-label">Documentation Dates</label>
                    <div class="input-group input-large date-picker input-daterange">
                        <input type="date" class="form-control" name="service_spec_date_from" value="'.$row['spec_date_from'].'" />
                        <span class="input-group-addon"> to </span>
                        <input type="date" class="form-control" name="service_spec_date_to" value="'.$row['spec_date_to'].'" />
                    </div>
                </div>
            </div>
        </div>
        <div class="mt-repeater">
            <div data-repeater-list="service_other">';

            	$other = $row['other'];
            	$other_arr = json_decode($other,true);
                $other_count = count($other_arr);
            	if (!empty($other)) {
            		foreach ($other_arr as $key => $value) {
                        $name = $value['name'];
                        $service_file_doc = $value['service_file_doc'];
                        $from = $value['from'];
                        $to = $value['to'];

                        $fileExtension = fileExtension($service_file_doc);
                		$src = $fileExtension['src'];
                		$embed = $fileExtension['embed'];
                		$type = $fileExtension['type'];
                		$file_extension = $fileExtension['file_extension'];
                        $url = $base_url.'uploads/supplier/';

                        echo '<div class="mt-repeater-item row" data-repeater-item>
		                    <div class="col-md-3">
		                        <div class="form-group">
		                            <label class="control-label">File Name</label>
		                            <input class="form-control" type="text" name="service_file_name" value="'.$name.'" />
		                        </div>
		                    </div>
		                    <div class="col-md-3">
		                        <div class="form-group">
                                    <input type="hidden" name="service_file_doc_tmp" value="'.$service_file_doc.'" />
		                            <label class="control-label">File Document</label>
		                            <input class="form-control '; echo !empty($service_file_doc) ? 'hide':''; echo '" type="file" name="service_file_doc" />
                                    <p class="'; echo !empty($service_file_doc) ? '':'hide'; echo '" style="margin: 0;"><a href="'.$src.$url.rawurlencode($service_file_doc).$embed.'" data-src="'.$src.$url.rawurlencode($service_file_doc).$embed.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a> | <button type="button" class="btn btn-link uploadNew" onclick="uploadNew(this)">Upload New</button></p>
		                        </div>
		                    </div>
		                    <div class="col-md-5">
		                        <div class="form-group">
		                            <label class="control-label">Documentation Dates</label>
		                            <div class="input-group input-large date-picker input-daterange">
		                                <input type="date" class="form-control" name="service_file_from" value="'.$from.'" />
		                                <span class="input-group-addon"> to </span>
		                                <input type="date" class="form-control" name="service_file_to" value="'.$to.'" />
		                            </div>
		                        </div>
		                    </div>
		                    <div class="col-md-1">
		                        <label style="visibility: hidden; display: block;">Remove</label>
		                        <a href="javascript:;" data-repeater-delete class="btn btn-danger"><i class="fa fa-close"></i></a>
		                    </div>
		                </div>';
                    }
            	}
            echo '</div>
            <a href="javascript:;" data-repeater-create class="btn btn-success mt-repeater-add"><i class="fa fa-plus"></i> Add new file</a>
        </div>';
    }
	if( isset($_POST['btnSave_Supplier_Service']) ) { 
		$ID = $_POST['ID'];
		$modal = $_POST['modal'];
		$path = 'uploads/supplier/';
		$random = rand(1000,1000000);
        $arr_item = array();
        $filesize = 0;
        $spec_filesize = 0;
        $spec_filesize_other = 0;
        $process = true;

		$service_name = addslashes($_POST['service_name']);
		$service_id = $_POST['service_id'];
		$service_description = addslashes($_POST['service_description']);
		$service_notes = addslashes($_POST['service_notes']);

		$service_spec_file = $_FILES['service_spec_file']['name'];
		$service_spec_file_final = "";
		if (!empty($service_spec_file)) {
            $spec_filesize = $_FILES['service_spec_file']['size'];
            $service_spec_file_tmp = $_FILES['service_spec_file']['tmp_name'];
            $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
            $ext = strtolower(pathinfo($service_spec_file, PATHINFO_EXTENSION));
            $service_spec_file_final = $random.' - '.$service_spec_file;
            $service_spec_file_path = $path.$service_spec_file_final;

            if(!in_array($ext, $invalid_extensions)) {
                move_uploaded_file($service_spec_file_tmp, $service_spec_file_path);

                $output = array (
                    'type' =>  0,
                    'name' =>  $service_spec_file_final,
                    'size' =>  $spec_filesize,
                    'date' =>  $local_date
                );
                array_push($arr_item, $output);
            } else {
                $process = false;
            }
        }
		$service_spec_date_from = $_POST['service_spec_date_from'];
		$service_spec_date_to = $_POST['service_spec_date_to'];

		$service_other_arr = array();
        for ($i=0; $i < count($_POST['service_other']); $i++) {
            $service_file_name = $_POST['service_other'][$i]['service_file_name'];
            $service_file_from = $_POST['service_other'][$i]['service_file_from'];
            $service_file_to = $_POST['service_other'][$i]['service_file_to'];

            $service_file_doc = $_FILES['service_other']['name'][$i];
            $service_file_doc_final = implode('*', $service_file_doc);

            if (!empty($service_file_doc_final)) {
                $spec_filesize_other = implode('*', $_FILES['service_other']['size'][$i]);
                $service_file_doc_tmp = implode('*', $_FILES['service_other']['tmp_name'][$i]);
                $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                $ext = strtolower(pathinfo($service_file_doc_final, PATHINFO_EXTENSION));
                $service_file_doc_final = $random.' - '.$service_file_doc_final;
                $service_file_doc_path = $path.$service_file_doc_final;

                if(!in_array($ext, $invalid_extensions)) {
                    move_uploaded_file($service_file_doc_tmp, $service_file_doc_path);

                    $filesize += $spec_filesize_other;

                    $output = array (
                        'type'  =>  0,
                        'name' =>  $service_file_doc_final,
                        'size' =>  $spec_filesize_other,
                        'date' =>  $local_date
                    );
                    array_push($arr_item, $output);
                } else {
                    $process = false;
                }
            }

            $service_other_data = array (
                'name' => $service_file_name,
                'service_file_doc' =>$service_file_doc_final,
                'from' =>$service_file_from,
                'to' =>$service_file_to
            );
            array_push( $service_other_arr, $service_other_data );
        }
		$service_other = json_encode($service_other_arr);
        $file_history = json_encode($arr_item, JSON_HEX_APOS | JSON_UNESCAPED_UNICODE);

        if ($process == true) {
    		$sql = "INSERT INTO tbl_supplier_service (user_id, service_name, service_id, description, notes, spec_file, spec_filesize, spec_date_from, spec_date_to, other, other_filesize, file_history)
            VALUES ('$ID', '$service_name', '$service_id', '$service_description', '$service_notes', '$service_spec_file_final', '$spec_filesize', '$service_spec_date_from', '$service_spec_date_to', '$service_other', '$filesize', '$file_history')";
            if (mysqli_query($conn, $sql)) {
    			$last_id = mysqli_insert_id($conn);
    		}

    		$output = array(
    			"ID" => $last_id,
    			"modal" => $modal,
    			"service_name" => $service_name,
    			"service_id" => $service_id,
    			"service_description" => $service_description
    		);
    		echo json_encode($output);
        }
	}
	if( isset($_POST['btnUpdate_Supplier_Service']) ) { 
		$ID = $_POST['ID'];
		$modal = $_POST['modal'];
		$path = 'uploads/supplier/';
		$random = rand(1000,1000000);
        $arr_item = array();
        $filesize = 0;
        $spec_filesize = 0;
        $spec_filesize_other = 0;
        $process = true;

        $selectData = mysqli_query( $conn,"SELECT * FROM tbl_supplier_service WHERE ID = $ID");
        if ( mysqli_num_rows($selectData) > 0 ) {
            $rowData = mysqli_fetch_array($selectData);

            if (!empty($rowData['file_history'])) {
                $arr_item = json_decode($rowData["file_history"],true);
            }
        }

		$service_name = addslashes($_POST['service_name']);
		$service_id = $_POST['service_id'];
		$service_description = addslashes($_POST['service_description']);
		$service_notes = addslashes($_POST['service_notes']);

        $service_spec_file_final = $_POST['service_spec_file_tmp'];
        $service_spec_file = $_FILES['service_spec_file']['name'];
		if (!empty($service_spec_file)) {
            $spec_filesize = $_FILES['service_spec_file']['size'];
            $service_spec_file_tmp = $_FILES['service_spec_file']['tmp_name'];
            $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
            $ext = strtolower(pathinfo($service_spec_file, PATHINFO_EXTENSION));
            $service_spec_file_final = $random.' - '.$service_spec_file;
            $service_spec_file_path = $path.$service_spec_file_final;

            if(!in_array($ext, $invalid_extensions)) {
                move_uploaded_file($service_spec_file_tmp, $service_spec_file_path);

                $output = array (
                    'type'  =>  0,
                    'name' =>  $service_spec_file_final,
                    'size' =>  $spec_filesize,
                    'date' =>  $local_date
                );
                array_push($arr_item, $output);
            } else {
                $process = false;
            }
        }
		$service_spec_date_from = $_POST['service_spec_date_from'];
		$service_spec_date_to = $_POST['service_spec_date_to'];

		$service_other_arr = array();
		for ($i=0; $i < count($_POST['service_other']); $i++) {
            $service_file_name = $_POST['service_other'][$i]['service_file_name'];
            $service_file_from = $_POST['service_other'][$i]['service_file_from'];
            $service_file_to = $_POST['service_other'][$i]['service_file_to'];

            $service_file_doc_final = $_POST['service_other'][$i]['service_file_doc_tmp'];
            $service_file_doc = $_FILES['service_other']['name'][$i];
            $service_file_doc = implode('*', $service_file_doc);
            if (!empty($service_file_doc)) {
                $spec_filesize_other = implode('*', $_FILES['service_other']['size'][$i]);
                $service_file_doc_tmp = implode('*', $_FILES['service_other']['tmp_name'][$i]);
                $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                $ext = strtolower(pathinfo($service_file_doc, PATHINFO_EXTENSION));
                $service_file_doc_final = $random.' - '.$service_file_doc_final;
                $service_file_doc_path = $path.$service_file_doc_final;

                if(!in_array($ext, $invalid_extensions)) {
                    move_uploaded_file($service_file_doc_tmp, $service_file_doc_path);

                    $filesize += $spec_filesize_other;

                    $output = array (
                        'type'  =>  0,
                        'name' =>  $service_file_doc_final,
                        'size' =>  $spec_filesize_other,
                        'date' =>  $local_date
                    );
                    array_push($arr_item, $output);
                } else {
                    $process = false;
                }
            }

            $service_other_data = array (
                'name' => $service_file_name,
                'service_file_doc' =>$service_file_doc_final,
                'from' =>$service_file_from,
                'to' =>$service_file_to
            );
            array_push( $service_other_arr, $service_other_data );
        }
		$service_other = json_encode($service_other_arr);
        $file_history = json_encode($arr_item, JSON_HEX_APOS | JSON_UNESCAPED_UNICODE);

        if ($process == true) {
    		mysqli_query( $conn,"UPDATE tbl_supplier_service set service_name='". $service_name ."', service_id='". $service_id ."', description='". $service_description ."', notes='". $service_notes ."', spec_file='". $service_spec_file_final ."', spec_filesize='". $spec_filesize ."', spec_date_from='". $service_spec_date_from ."', spec_date_to='". $service_spec_date_to ."', other='". $service_other ."', other_filesize='". $filesize ."', file_history='". $file_history ."' WHERE ID='". $ID ."'" );

    		$output = array(
    			"ID" => $ID,
    			"modal" => $modal,
    			"service_name" => $service_name,
    			"service_id" => $service_id,
    			"service_description" => $service_description
    		);
    		echo json_encode($output);
        }
	}

	// Template Section
	if( isset($_GET['modalNew_Supplier_Template']) ) {
		$id = $_GET['modalNew_Supplier_Template'];
		$temp = $_GET['temp'];

		echo '<input class="form-control" type="hidden" name="ID" value="'.$id.'" />
		<input class="form-control" type="hidden" name="temp" value="'.$temp.'" />
        <div class="row">
            <div class="col-md-12">
                <div class="form-group">
                    <select class="form-control" name="filetype" onchange="changeType(this)" required>
                        <option value="0">Select option</option>
                        <option value="1">Manual Upload</option>
                        <option value="2">Youtube URL</option>
                        <option value="3">Google Drive URL</option>
                    </select>
                    <input class="form-control margin-top-15 fileUpload" type="file" name="file" style="display: none;" />
                    <input class="form-control margin-top-15 fileURL" type="url" name="fileurl" style="display: none;" placeholder="https://" />
                </div>
            </div>
        </div>';
	}
    if( isset($_GET['btnDelete_Supplier_Template']) ) {
        $id = $_GET['btnDelete_Supplier_Template'];
        mysqli_query( $conn,"UPDATE tbl_supplier_template set file='' WHERE ID = $id" );
    }
	if( isset($_POST['btnSave_Supplier_Template']) ) { 
		if (!empty($_COOKIE['switchAccount'])) {
			$portal_user = $_COOKIE['ID'];
			$user_id = $_COOKIE['switchAccount'];
		}
		else {
			$portal_user = $_COOKIE['ID'];
			$user_id = employerID($portal_user);
		}

		$ID = $_POST['ID'];
		$temp = $_POST['temp'];
		$path = 'uploads/supplier/';
		$random = rand(1000,1000000);
        $arr_item = array();
        $filesize = 0;
        $process = true;

		$filetype = $_POST['filetype'];
		if ($filetype == 1) {
			$file = $_FILES['file']['name'];
			$file_final = "";
			if (!empty($file)) {
                $filesize = $_FILES['file']['size'];
				$file_tmp = $_FILES['file']['tmp_name'];
                $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                $ext = strtolower(pathinfo($file, PATHINFO_EXTENSION));
				$file_final = $random.' - '.$file;
				$file_path = $path.$file_final;

                if(!in_array($ext, $invalid_extensions)) {
                    move_uploaded_file($file_tmp, $file_path);
                } else {
                    $process = false;
                }
			}
		} else {
			$file_final = $_POST['fileurl'];
		}
        
        if ($process == true) {
            $output = array (
                'type'  =>  $filetype,
                'name' =>  $file_final,
                'size' =>  $filesize,
                'date' =>  $local_date
            );
            array_push($arr_item, $output);
            $file_history = json_encode($arr_item, JSON_HEX_APOS | JSON_UNESCAPED_UNICODE);

    		if ($temp == 0) {
                $sql = "INSERT INTO tbl_supplier_template (user_id, portal_user, requirement_id, file, filetype, filesize, file_history)
                VALUES ('$user_id', '$portal_user', '$ID', '$file_final', '$filetype', '$filesize', '$file_history')";
                if (mysqli_query($conn, $sql)) {
                    $temp = mysqli_insert_id($conn);
                }
            } else {
                mysqli_query( $conn,"UPDATE tbl_supplier_template set file='". $file_final ."', filetype='". $filetype ."', filesize='". $filesize ."', file_history='". $file_history ."' WHERE ID ='". $temp ."'" );
            }

    		$view = '<a href="#modalTemplate" class="btn btn-link" data-toggle="modal" onclick="btnTemplate('.$ID.', 0)">Upload</a>';
    		if (!empty($file_final)) {
                $type = 'iframe';
                if ($filetype == 1) {
                    $fileExtension = fileExtension($file_final);
                    $src = $fileExtension['src'];
                    $embed = $fileExtension['embed'];
                    $type = $fileExtension['type'];
                    $file_extension = $fileExtension['file_extension'];
                    $url = $base_url.'uploads/supplier/';

                    $file_final = $src.$url.rawurlencode($file_final).$embed;
                } else if ($filetype == 3) {
                    $file_final = preg_replace('#[^/]*$#', '', $file_final).'preview';
                }
                $view = '<p style="margin: 0;">
                    <a href="'.$file_final.'" data-src="'.$file_final.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a> |
                    <a href="#modalTemplate" class="btn btn-link" data-toggle="modal" onclick="btnTemplate('.$ID.', '.$temp.')">Upload</a>
                </p>';
            }

    		$output = array(
    			"ID" => $ID,
    			"temp" => $temp,
    			"view" => $view
    		);
    		echo json_encode($output);
        }
	}
	if( isset($_GET['modalNew_Supplier_Template2']) ) {
		$id = $_GET['modalNew_Supplier_Template2'];
		$temp = $_GET['temp'];
		$modal = $_GET['modal'];

		echo '<input class="form-control" type="hidden" name="ID" value="'.$id.'" />
		<input class="form-control" type="hidden" name="temp" value="'.$temp.'" />
		<input class="form-control" type="hidden" name="modal" value="'.$modal.'" />
        <div class="row">
            <div class="col-md-12">
                <div class="form-group">
                    <select class="form-control" name="filetype" onchange="changeType(this)" required>
                        <option value="0">Select option</option>
                        <option value="1">Manual Upload</option>
                        <option value="2">Youtube URL</option>
                        <option value="3">Google Drive URL</option>
                    </select>
                    <input class="form-control margin-top-15 fileUpload" type="file" name="file" style="display: none;" />
                    <input class="form-control margin-top-15 fileURL" type="url" name="fileurl" style="display: none;" placeholder="https://" />
                </div>
            </div>
        </div>';
	}
	if( isset($_POST['btnSave_Supplier_Template2']) ) { 
		if (!empty($_COOKIE['switchAccount'])) {
			$portal_user = $_COOKIE['ID'];
			$user_id = $_COOKIE['switchAccount'];
		}
		else {
			$portal_user = $_COOKIE['ID'];
			$user_id = employerID($portal_user);
		}

		$ID = $_POST['ID'];
		$temp = $_POST['temp'];
		$modal = $_POST['modal'];
		$path = 'uploads/supplier/';
		$random = rand(1000,1000000);
        $arr_item = array();
        $filesize = 0;
        $process = true;

		$filetype = $_POST['filetype'];
		if ($filetype == 1) {
			$file = $_FILES['file']['name'];
			$file_final = "";
			if (!empty($file)) {
                $filesize = $_FILES['file']['size'];
				$file_tmp = $_FILES['file']['tmp_name'];
                $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                $ext = strtolower(pathinfo($file, PATHINFO_EXTENSION));
				$file_final = $random.' - '.$file;
				$file_path = $path.$file_final;

                if(!in_array($ext, $invalid_extensions)) {
                    move_uploaded_file($file_tmp, $file_path);
                } else {
                    $process = false;
                }
			}
		} else {
			$file_final = $_POST['fileurl'];
		}
        
        if ($process == true) {
            $output = array (
                'type'  =>  $filetype,
                'name' =>  $file_final,
                'size' =>  $filesize,
                'date' =>  $local_date
            );
            array_push($arr_item, $output);
            $file_history = json_encode($arr_item, JSON_HEX_APOS | JSON_UNESCAPED_UNICODE);

    		if ($temp == 0) {
                $sql = "INSERT INTO tbl_supplier_template (user_id, portal_user, requirement_id, file, filetype, filesize, file_history)
                VALUES ('$user_id', '$portal_user', '$ID', '$file_final', '$filetype', '$filesize', '$file_history')";
                if (mysqli_query($conn, $sql)) {
                    $temp = mysqli_insert_id($conn);
                }
            } else {
                mysqli_query( $conn,"UPDATE tbl_supplier_template set file='". $file_final ."', filetype='". $filetype ."', filesize='". $filesize ."', file_history='". $file_history ."' WHERE ID ='". $temp ."'" );
            }

    		$view = '<a href="#modalTemplate" class="btn btn-link" data-toggle="modal" onclick="btnTemplate('.$ID.', 0)">Upload</a>';
    		$view2 = '<input type="file" class="form-control hide" name="document_template[]"><a href="#modalTemplate2" class="btn btn-sm red-haze" data-toggle="modal" onclick="btnTemplate2('.$ID.', 0, '.$modal.')">Upload</a>';
    		
    		if (!empty($file_final)) {
    			$type = 'iframe';
    			if ($filetype == 1) {
    	            $fileExtension = fileExtension($file_final);
    	            $src = $fileExtension['src'];
    	            $embed = $fileExtension['embed'];
    	            $type = $fileExtension['type'];
    	            $file_extension = $fileExtension['file_extension'];
    	            $url = $base_url.'uploads/supplier/';

    			    $file_final = $src.$url.rawurlencode($file_final).$embed;
    			} else if ($filetype == 3) {
    			    $file_final = preg_replace('#[^/]*$#', '', $file_final).'preview';
    			}

                $view = '<p style="margin: 0;">
                    <a href="'.$file_final.'" data-src="'.$file_final.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a> |
                    <a href="#modalTemplate" class="btn btn-link" data-toggle="modal" onclick="btnTemplate('.$ID.', '.$temp.')">Upload</a>
                </p>';
                $view2 = '<input type="file" class="form-control hide" name="document_template[]">
                <p style="margin: 0;">
                    <a href="'.$file_final.'" data-src="'.$file_final.'" data-fancybox data-type="'.$type.'" class="btn btn-sm btn-info">View</a> |
                    <a href="#modalTemplate2" class="btn btn-sm red-haze" data-toggle="modal" onclick="btnTemplate2('.$ID.', '.$temp.', '.$modal.')">Upload</a>
                </p>';
    		}

    		$output = array(
    			"ID" => $ID,
    			"temp" => $temp,
    			"modal" => $modal,
    			"view" => $view,
    			"view2" => $view2
    		);
    		echo json_encode($output);
    	}
    }



	if( isset($_POST['btnSave_RD']) ) { 
		$ID = $_POST['ID'];
		$name = $_POST['name'];
		$address = $_POST['address'];
		$phone = $_POST['phone'];
		$fax = $_POST['fax'];
		$email = $_POST['email'];
		$website = $_POST['website'];
		$type = $_POST['type'];

		$sql = "INSERT INTO tbl_supplier (user_id, name, address, phone, fax, email, website, type)
		VALUES ('$ID', '$name', '$address', '$phone', '$fax', '$email', '$website', '$type')";
		
		if (mysqli_query($conn, $sql)) {

			$last_id = mysqli_insert_id($conn);
			$selectData = mysqli_query( $conn,'SELECT * FROM tbl_supplier WHERE user_id="'. $ID .'" AND ID="'. $last_id .'" ORDER BY ID LIMIT 1' );
			if ( mysqli_num_rows($selectData) > 0 ) {
				$rowData = mysqli_fetch_array($selectData);
				$data_ID = $rowData['ID'];
				$data_name = $rowData['name'];
				$data_address = $rowData['address'];
				$data_phone = $rowData['phone'];
				$data_fax = $rowData['fax'];
				$data_email = $rowData['email'];
				$data_website = $rowData['website'];
				$data_type = $rowData['type'];

            	$counterup_tbl = counterup_tbl('supplier');
				$output = array(
					"ID" => $data_ID,
					"name" => $data_name,
					"address" => $data_address,
					"phone" => $data_phone,
					"fax" => $data_fax,
					"email" => $data_email,
					"website" => $data_website,
					"type" => $data_type
				);
				
				$result = array_merge($counterup_tbl, $output);
				echo json_encode($result);
			}
		}
		mysqli_close($conn);
	}

	if( isset($_POST['btnUpdate_RD']) ) {
		$ID = $_POST['ID'];
		$name = $_POST['name'];
		$address = $_POST['address'];
		$phone = $_POST['phone'];
		$fax = $_POST['fax'];
		$email = $_POST['email'];
		$website = $_POST['website'];
		$type = $_POST['type'];
		$status = isset($_POST['status']) ? 1 : 0;
		$status_last_modified = date('Y-m-d');

		mysqli_query( $conn,"UPDATE tbl_supplier set name='". $name ."', address='". $address ."', phone='". $phone ."', fax='". $fax ."', email='". $email ."', website='". $website ."', type='". $type ."', email='". $email ."', status='". $status ."', last_modified='". $status_last_modified ."' WHERE ID='". $ID ."'" );
		
		if (!mysqli_error($conn)) {

            $counterup_tbl = counterup_tbl('supplier');
			$output = array(
				'ID' => $ID,
				'name' => $name,
				'address' => $address,
				'phone' => $phone,
				'fax' => $fax,
				'email' => $email,
				'website' => $website,
				'type' => $type,
				'status' => $status
			);

			$result = array_merge($counterup_tbl, $output);
			echo json_encode($result);
		}

		mysqli_close($conn);
	}

	if( isset($_GET['modalView_RD']) ) {
		$id = $_GET['modalView_RD'];
		$selectData = mysqli_query( $conn,"SELECT * FROM tbl_supplier WHERE ID = $id" );
		if ( mysqli_num_rows($selectData) > 0 ) {
            $row = mysqli_fetch_array($selectData);
        }

		echo '<input class="form-control" type="hidden" name="ID" value="'. $row['ID'] .'" />
        <div class="form-group">
            <label class="col-md-3 control-label">Supplier Name</label>
            <div class="col-md-8">
                <input class="form-control" type="text" name="name" value="'. $row['name'] .'" required />
            </div>
        </div>
        <div class="form-group">
            <label class="col-md-3 control-label">Address</label>
            <div class="col-md-8">
                <input class="form-control" type="text" name="address" value="'. $row['address'] .'" required />
            </div>
        </div>
        <div class="form-group">
            <label class="col-md-3 control-label">Phone</label>
            <div class="col-md-8">
                <input class="form-control" type="text" name="phone" value="'. $row['phone'] .'" required />
            </div>
        </div>
        <div class="form-group">
            <label class="col-md-3 control-label">Fax</label>
            <div class="col-md-8">
                <input class="form-control" type="text" name="fax" value="'. $row['fax'] .'" required />
            </div>
        </div>
        <div class="form-group">
            <label class="col-md-3 control-label">Email</label>
            <div class="col-md-8">
                <input class="form-control" type="email" name="email" value="'. $row['email'] .'" required />
            </div>
        </div>
        <div class="form-group">
            <label class="col-md-3 control-label">Website</label>
            <div class="col-md-8">
                <input class="form-control" type="url" name="website" value="'. $row['website'] .'" required />
            </div>
        </div>
        <div class="form-group">
            <label class="col-md-3 control-label">Type</label>
            <div class="col-md-8">
                <input class="form-control" type="text" name="type" value="'. $row['type'] .'" required />
            </div>
        </div>

        <div class="form-group">
            <label class="control-label col-md-3">Status</label>
            <div class="col-md-8">
            	<input type="checkbox" class="make-switch" name="status" data-on-text="Active" data-off-text="Inactive" data-on-color="success" data-off-color="danger"'; echo $row['status'] === "1" ? "checked" : "";  echo '>
            </div>
        </div>';

        mysqli_close($conn);
	}


	// LISTING PAGE
	if( isset($_GET['job_cat']) ) {
		$id = $_GET['job_cat'];
		$selectData = mysqli_query( $conn,"SELECT * FROM tbl_job_category" );
        if ( mysqli_num_rows($selectData) > 0 ) {
	    	$json = array();
	        while($row = mysqli_fetch_array($selectData)) {
	            $json[] = $row["name"];
	        }
	        echo json_encode($json);
	    }

        mysqli_close($conn);
	}
	if( isset($_GET['job_status']) ) {
		$id = $_GET['job_status'];
		$val = $_GET['v'];

		mysqli_query( $conn,"UPDATE tbl_job_listing SET status=$val WHERE ID=$id" );

		$output = array(
			"ID" => $id,
			"val" => $val
		);
		echo json_encode($output);
	}
	if( isset($_GET['specialist_status']) ) {
		$id = $_GET['specialist_status'];
		$val = $_GET['v'];

		mysqli_query( $conn,"UPDATE tbl_user_job SET is_active = $val WHERE ID = $id" );

		$output = array(
			"ID" => $id,
			"val" => $val
		);
		echo json_encode($output);
	}
	if( isset($_GET['modalView_JobListing']) ) {
		$id = $_GET['modalView_JobListing'];
		$selectData = mysqli_query( $conn,"SELECT * FROM tbl_job_listing WHERE ID = $id" );
		if ( mysqli_num_rows($selectData) > 0 ) {
            $row = mysqli_fetch_array($selectData);
            $employment = $row['employment_type'];
            $workplace = $row['workplace_type'];
            $files = $row['files'];

            $src = 'https://view.officeapps.live.com/op/embed.aspx?src=';
            $embed = '&embedded=true';
            $type = 'iframe';
            $url = $base_url.'uploads/job/';

            if (!empty($files)) {
            	$extension = pathinfo($files, PATHINFO_EXTENSION);
	            if ($extension == "pdf") { $src = ''; $embed = ''; $file_extension = "fa-file-pdf-o"; }
	            else if (strtolower($extension) == "doc" OR strtolower($extension) == "docx") { $file_extension = "fa-file-word-o"; }
	            else if (strtolower($extension) == "ppt" OR strtolower($extension) == "pptx") { $file_extension = "fa-file-powerpoint-o"; }
	            else if (strtolower($extension) == "xls" OR strtolower($extension) == "xlsb" OR strtolower($extension) == "xlsm" OR strtolower($extension) == "xlsx" OR strtolower($extension) == "csv" OR strtolower($extension) == "xlsx") { $file_extension = "fa-file-excel-o"; }
	            else if (strtolower($extension) == "gif" OR strtolower($extension) == "jpg"  OR strtolower($extension) == "jpeg" OR strtolower($extension) == "png" OR strtolower($extension) == "ico") { $src = ''; $embed = ''; $type = ''; $file_extension = "fa-file-image-o"; }
	            else if (strtolower($extension) == "mp4" OR strtolower($extension) == "mov"  OR strtolower($extension) == "wmv" OR strtolower($extension) == "flv" OR strtolower($extension) == "avi" OR strtolower($extension) == "avchd" OR strtolower($extension) == "webm" OR strtolower($extension) == "mkv") { $src = ''; $embed = ''; $type = ''; $file_extension = "fa-file-video-o"; }
	            else { $src = ''; $embed = ''; $type = ''; $file_extension = "fa-file-code-o"; }
            }
        }
		
		echo '<input class="form-control" type="hidden" name="ID" value="'. $row['ID'] .'" />
        <div class="form-group">
            <label class="col-md-3 control-label">Job Title</label>
            <div class="col-md-8">
                <input class="form-control" type="text" name="title" value="'. $row['title'] .'" required />
            </div>
        </div>
        <div class="form-group">
            <label class="col-md-3 control-label">Short Description</label>
            <div class="col-md-8">
                <textarea class="form-control" name="short_description"required>'. $row['short_description'] .'</textarea>
            </div>
        </div>
        <div class="form-group">
            <label class="col-md-3 control-label">Category</label>
            <div class="col-md-8">
                <input class="form-control" type="text" name="category" id="typeahead_category" value="'. $row['category'] .'" required />
            </div>
        </div>
        <div class="form-group">
            <label class="col-md-3 control-label">Employment Type</label>
            <div class="col-md-8">
                <select class="form-control" name="employment" required>
                    <option value="">Select</option>';

                        $selectEmployment = mysqli_query( $conn,"SELECT * FROM tbl_job_employment" );
                        if ( mysqli_num_rows($selectEmployment) > 0 ) {
                            while($rowEmpoyment = mysqli_fetch_array($selectEmployment)) {
                                $ID = $rowEmpoyment['ID'];
                                $name = $rowEmpoyment['name'];

                                echo '<option value="'.$ID.'" '; echo $ID == $employment ? 'selected': ''; echo '>'.$name.'</option>';
                            }
                        }

                echo '</select>
            </div>
        </div>
        <div class="form-group">
            <label class="col-md-3 control-label">Workplace Type</label>
            <div class="col-md-8">
                <select class="form-control bs-select" name="workplace" required>';

                        $selectWorkplace = mysqli_query( $conn,"SELECT * FROM tbl_job_workplace" );
                        if ( mysqli_num_rows($selectWorkplace) > 0 ) {
                            while($rowWorkplace = mysqli_fetch_array($selectWorkplace)) {
                                $ID = $rowWorkplace['ID'];
                                $name = $rowWorkplace['name'];
                                $description = $rowWorkplace['description'];

                                echo '<option value="'.$ID.'" data-subtext="'.$description.'" '; echo $ID == $employment ? 'selected': ''; echo '>'.$name.'</option>';
                            }
                        }

                echo '</select>
            </div>
        </div>
        <div class="form-group">
            <label class="col-md-3 control-label">Location</label>
            <div class="col-md-8">
                <input class="form-control" type="text" name="location" value="'. $row['location'] .'" required />
            </div>
        </div>
        <div class="form-group">
            <label class="col-md-3 control-label">Full Job Description</label>
            <div class="col-md-8">
                <textarea class="summernote" name="long_description">'. $row['long_description'] .'</textarea>
                <span class="text-muted">
                    Add a job description to pick out your future applicants<br><br>
                    or you may upload your document here
                </span>
                <input class="form-control '; echo !empty($files) ? 'hide':''; echo '" type="file" name="file" />
			    <p class="'; echo !empty($files) ? '':'hide'; echo '" style="margin: 0;"><a data-src="'.$src.$url.$files.$embed.'" data-fancybox class="btn btn-link">View</a> | <button type="button" class="btn btn-link uploadNew" onclick="uploadNew(this)">Upload New</button></p>
            </div>
        </div>
        <div class="form-group">
            <label class="col-md-3 control-label">Add skills/tags</label>
            <div class="col-md-8">
                <input type="text" class="form-control tagsinput" name="skills" data-role="tagsinput" placeholder="Enter skill" value="'. $row['skills'] .'" required />
                <span class="text-muted">
                    Include skill keywords to make your job post more visible<br>
                    (Hit enter to add new entry)
                </span>
            </div>
        </div>';
	}
	if( isset($_GET['modalView_Specialist']) ) {
		$ID = $_GET['modalView_Specialist'];

		// Main Details
        $selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $ID" );
        if ( mysqli_num_rows($selectUser) > 0 ) {
            $rowUser = mysqli_fetch_array($selectUser);
            $user_fullname = $rowUser['first_name'] .' '. $rowUser['last_name'];
            $user_email = $rowUser['email'];
        }

        $user_mobile = '';
        $user_address = '';
        $user_avatar = '';
        $selectUserInfo = mysqli_query( $conn,"SELECT * FROM tbl_user_info WHERE user_id = $ID" );
        if ( mysqli_num_rows($selectUserInfo) > 0 ) {
            $rowUserInfo = mysqli_fetch_array($selectUserInfo);
            $user_mobile = $rowUserInfo['mobile'];
            $user_address = $rowUserInfo['address'];
            $user_avatar = $rowUserInfo['avatar'];
        }

        // Social Media
		$sm_website = '';
		$sm_linkedin = '';
		$sm_facebook = '';
		$sm_twitter = '';
		$selectSocial = mysqli_query( $conn,"SELECT * FROM tbl_user_social_media WHERE user_id=$ID");
		if ( mysqli_num_rows($selectSocial) > 0 ) {
			$rowUserSM = mysqli_fetch_array($selectSocial);
			$sm_website = $rowUserSM['website'];
			$sm_linkedin = $rowUserSM['linkedin'];
			$sm_facebook = $rowUserSM['facebook'];
			$sm_twitter = $rowUserSM['twitter'];
		}

		// Other Info
        $cv_src = '';
		$count_educ = 0;
		$count_ref = 0;
        $count_skill = 0;
		$selectJob = mysqli_query( $conn,"SELECT * FROM tbl_user_job WHERE user_id = $ID" );
        if ( mysqli_num_rows($selectJob) > 0 ) {
        	$rowJob = mysqli_fetch_array($selectJob);
        	$job_ID = $rowJob['ID'];
    		$job_status = $rowJob['status'];
            $job_is_active = $rowJob['is_active'];

    		$job_cv = $rowJob['cv'];
	        if (!empty($job_cv)) {
	            $fileExtension = fileExtension($job_cv);
	            $src = $fileExtension['src'];
	            $embed = $fileExtension['embed'];
	            $type = $fileExtension['type'];
	            $file_extension = $fileExtension['file_extension'];
	            $url = $base_url.'uploads/job/';
	            $cv_src = $src.$url.rawurlencode($job_cv).$embed;
	        }

            $education = $rowJob['education'];
            if (!empty($education)) {
                $output_educ = json_decode($education,true);
                $count_educ = count($output_educ);
            }

            $reference = $rowJob['reference'];
            if (!empty($reference)) {
                $output_ref = json_decode($reference,true);
                $count_ref = count($output_ref);
            }

            $skill = $rowJob['skill'];
            if (!empty($skill)) {
                $output_skill = json_decode($skill,true);
                $count_skill = count($output_skill);
            }
        }

		echo '<div class="row">
			<div class="col-md-5">
				<img class="img-responsive" src="'.$base_url.'uploads/avatar/'.$user_avatar.'" onerror="this.onerror=null;this.src=\'https://via.placeholder.com/230x150/EFEFEF/AAAAAA.png?text=no+image\';" style="width: 230px; height: 150px; object-fit: contain; margin: auto;">
				<div class="profile-usertitle">
                    <div class="profile-usertitle-name">'.$user_fullname.'</div>
                    <div class="profile-usertitle-job hide"> Developer </div>
                </div>
                <div class="profile-usermenu" style="margin-top: 0;">
                    <ul class="nav">';

                    	if (!empty($cv_src)) {
                    		echo '<li>
	                            <a style="padding-left: 3rem;" href="javascript:;" data-src="'.$cv_src.'" data-fancybox data-type="'.$type.'"><i class="icon-paper-clip" style="margin-left: -2.5rem; margin-right: 0;"></i> Resume</a>
	                        </li>';
                    	}
                    	if (!empty($user_mobile)) {
                    		echo '<li>
	                            <a style="padding-left: 3rem;" href="tel:'.$user_mobile.'" target="_blank"><i class="icon-screen-smartphone" style="margin-left: -2.5rem; margin-right: 0;"></i> '.$user_mobile.'</a>
	                        </li>';
                    	}
                        echo '<li>
                            <a style="padding-left: 3rem; word-break: break-all;" href="mailto:'.$user_email.'" target="_blank"><i class="icon-envelope-open" style="margin-left: -2.5rem; margin-right: 0;"></i> '.$user_email.'</a>
                        </li>';
                    	if (!empty($user_address)) {
                    		echo '<li>
	                            <a style="padding-left: 3rem;" href="javascript:;"><i class="icon-home" style="margin-left: -2.5rem; margin-right: 0;"></i> '.$user_address.'</a>
	                        </li>';
                    	}

                    	if (!empty($sm_facebook)) {
                    		echo '<li>
	                            <a style="padding-left: 3rem;" href="'.$sm_facebook.'" target="_blank"><i class="fa fa-facebook" style="margin-left: -2.5rem; margin-right: 0;"></i> Facebook</a>
	                        </li>';
                    	}
                    	if (!empty($sm_twitter)) {
                    		echo '<li>
	                            <a style="padding-left: 3rem;" href="'.$sm_twitter.'" target="_blank"><i class="fa fa-twitter" style="margin-left: -2.5rem; margin-right: 0;"></i> Twitter</a>
	                        </li>';
                    	}
                    	if (!empty($sm_linkedin)) {
                    		echo '<li>
	                            <a style="padding-left: 3rem;" href="'.$sm_linkedin.'" target="_blank"><i class="fa fa-linkedin" style="margin-left: -2.5rem; margin-right: 0;"></i> LinkedIn</a>
	                        </li>';
                    	}
                    	if (!empty($sm_website)) {
                    		echo '<li>
	                            <a style="padding-left: 3rem; word-break: break-all;" href="'.$sm_website.'" target="_blank"><i class="fa fa-globe" style="margin-left: -2.5rem; margin-right: 0;"></i> '.$sm_website.'</a>
	                        </li>';
                    	}

                    echo '</ul>
                </div>

                <input type="checkbox" class="make-switch" name="status" data-on-text="Approved" data-off-text="Unapproved" data-on-color="success" onchange="changedStat(this, '. $job_ID .')" data-off-color="default" '; echo $job_is_active === "1" ? "checked" : "";  echo '>
			</div>
			<div class="col-md-7">';

				if ($count_educ > 0) {
					echo '<div class="panel panel-primary">
	                    <div class="panel-heading">
	                        <h3 class="panel-title">Training / Certificate / Education</h3>
	                    </div>
	                    <table class="table">
	                        <tbody>';
								foreach ($output_educ as $key => $value) {
			                    	$file = '';
			                    	$file_src = '';
			                    	$type = '';
			                    	$file_extension = '';
			                        if (!empty($value['educ_diploma'])) {
			                            $file = $value['educ_diploma'];
			                            $fileExtension = fileExtension($file);
			                            $src = $fileExtension['src'];
			                            $embed = $fileExtension['embed'];
			                            $type = $fileExtension['type'];
			                            $file_extension = $fileExtension['file_extension'];
			                            $url = $base_url.'uploads/job/';
			                            $file_src = $src.$url.rawurlencode($file).$embed;
			                        }

			                    	echo '<tr>
		                                <td>
		                                	<a class="pull-right" href="'.$file_src.'" data-src="'.$file_src.'" data-fancybox data-type="'.$type.'" style="font-size: 25px;"><i class="fa '. $file_extension .'"></i></a>
		                                	<div class="media-body">';
				                            	if (!empty($value['educ_degree'])) {
					                    			echo '<div class="media-heading"><b>'.$value['educ_degree'].'</b></div>';
					                    		}
					                    		if (!empty($value['educ_school'])) {
					                    			echo '<div>'.$value['educ_school'].'</div>';
					                    		}
				                            echo '</div>
		                                </td>
		                            </tr>';
			                    }
		                    echo '
	                        </tbody>
	                    </table>
	                </div>';
                }

				if ($count_ref > 0) {
					echo '<div class="panel panel-primary">
	                    <div class="panel-heading">
	                        <h3 class="panel-title">References</h3>
	                    </div>
	                    <table class="table">
	                        <tbody>';
								foreach ($output_ref as $key => $value) {
			                    	echo '<tr>
		                                <td>
		                                	<div class="media-body">';
				                            	if (!empty($value['ref_name'])) {
					                    			echo '<div class="media-heading"><b>'.$value['ref_name'].'</b></div>';
					                    		}
					                    		if (!empty($value['ref_email'])) {
					                    			echo '<div><a href="mailto:'.$value['ref_email'].'" target="_blank">'.$value['ref_email'].'</a></div>';
					                    		}
					                    		if (!empty($value['ref_phone'])) {
					                    			echo '<div><a href="tel:'.$value['ref_phone'].'" target="_blank">'.$value['ref_phone'].'</a></div>';
					                    		}
				                            echo '</div>
		                                </td>
		                            </tr>';
			                    }
		                    echo '
	                        </tbody>
	                    </table>
	                </div>';
                }

				if ($count_skill > 0) {
					echo '<div class="panel panel-primary">
	                    <div class="panel-heading">
	                        <h3 class="panel-title">Skill Set / Specialty</h3>
	                    </div>
	                    <table class="table">
	                        <tbody>';
								foreach ($output_skill as $key => $value) {
			                    	echo '<tr>
		                                <td>
		                                	<div class="media-body">';
				                            	if (!empty($value['skill_name'])) {
					                    			echo '<div class="media-heading"><b>'.$value['skill_name'].'</b></div>';
					                    		}
				                            echo '</div>
		                                </td>
		                            </tr>';
			                    }
		                    echo '
	                        </tbody>
	                    </table>
	                </div>';
                }

			echo '</div>
		</div>';
	}
	if( isset($_GET['btnDelete_JobListing']) ) {
		$id = $_GET['btnDelete_JobListing'];
		mysqli_query( $conn,"UPDATE tbl_job_listing set is_deleted='1' WHERE ID='". $id ."'" );
	}
	if( isset($_POST['btnSave_JobListing']) ) { 
		$ID = $_POST['ID'];
		$title = $_POST['title'];
		$short_description = $_POST['short_description'];
		$long_description = $_POST['long_description'];
		$category = $_POST['category'];
		$employment = $_POST['employment'];
		$workplace = $_POST['workplace'];
		$location = $_POST['location'];
		$skills = $_POST['skills'];
		$date_posted = date('Y-m-d');
        $process = true;

		$final_file = "";
		$file = $_FILES['file']['name'];
		if (!empty($file)) {
			$path = 'uploads/job/';
			$random = rand(1000,1000000);
			$tmp_file = $_FILES['file']['tmp_name'];
            $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
            $ext = strtolower(pathinfo($file, PATHINFO_EXTENSION));
			$final_file = $random.' - '.$file;
			$path_file = $path.$final_file;

            if(!in_array($ext, $invalid_extensions)) {
                move_uploaded_file($tmp_file,$path_file);
            } else {
                $process = false;
            }
		}

        if ($process == true) {
    		$sql = "INSERT INTO tbl_job_listing (user_id, title, short_description, long_description, category, employment_type, workplace_type, location, files, skills, date_posted)
    		VALUES ('$ID', '$title', '$short_description', '$long_description', '$category', '$employment', '$workplace', '$location', '$final_file', '$skills', '$date_posted')";
    		
    		if (mysqli_query($conn, $sql)) {
    			$last_id = mysqli_insert_id($conn);
    			$selectData = mysqli_query( $conn,'SELECT * FROM tbl_job_listing WHERE user_id="'. $ID .'" AND ID="'. $last_id .'" ORDER BY ID LIMIT 1' );
    			if ( mysqli_num_rows($selectData) > 0 ) {
    				$rowData = mysqli_fetch_array($selectData);
    				$data_ID = $rowData['ID'];

    				$output = array(
    					"ID" => $data_ID,
    					"title" => $title,
    					"short_description" => $short_description,
    					"employment" => $employment,
    					"date_posted" => $date_posted
    				);
    				echo json_encode($output);
    			}
    		}
    		mysqli_close($conn);
        }
	}
	if( isset($_POST['btnUpdate_JobListing']) ) { 
		$ID = $_POST['ID'];
		$title = $_POST['title'];
		$short_description = $_POST['short_description'];
		$long_description = $_POST['long_description'];
		$category = $_POST['category'];
		$employment = $_POST['employment'];
		$workplace = $_POST['workplace'];
		$location = $_POST['location'];
		$skills = $_POST['skills'];
		// $date_posted = date('Y-m-d');
        $process = true;

		mysqli_query( $conn,"UPDATE tbl_job_listing set title='". $title ."', short_description='". $short_description ."', long_description='". $long_description ."', category='". $category ."', employment_type='". $employment ."', workplace_type='". $workplace ."', location='". $location ."', skills='". $skills ."' WHERE ID='". $ID ."'" );
		
		$final_file = "";
		$file = $_FILES['file']['name'];
		if (!empty($file)) {
			$path = 'uploads/job/';
			$random = rand(1000,1000000);
			$tmp_file = $_FILES['file']['tmp_name'];
            $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
            $ext = strtolower(pathinfo($file, PATHINFO_EXTENSION));
			$final_file = $random.' - '.$file;
			$path_file = $path.$final_file;

            if(!in_array($ext, $invalid_extensions)) {
                move_uploaded_file($tmp_file,$path_file);

                mysqli_query( $conn,"UPDATE tbl_job_listing set files='". $final_file ."' WHERE ID='". $ID ."'" );
            } else {
                $process = false;
            }
		}

		if (!mysqli_error($conn) AND $process == true) {
			$selectData = mysqli_query( $conn,'SELECT * FROM tbl_job_listing WHERE ID="'. $ID .'" ORDER BY ID LIMIT 1' );
			if ( mysqli_num_rows($selectData) > 0 ) {
				$rowData = mysqli_fetch_array($selectData);
				$data_ID = $rowData['ID'];
				$date_posted = $rowData['date_posted'];
				$status = $rowData['status'];

				$output = array(
					"ID" => $data_ID,
					"title" => $title,
					"short_description" => $short_description,
					"employment" => $employment,
					"date_posted" => $date_posted,
					"status" => $status
				);
				echo json_encode($output);
                mysqli_close($conn);
			}
		}
	}


	// INTERNAL AUDIT PAGE
	function ai_child($data_ID, $sheet_id, $type_arr, $label_arr, $modal) {
		global $conn;
		$data = '';

		$selectDataRowChild  = mysqli_query( $conn,"SELECT * FROM tbl_ia_data WHERE parent_id = $data_ID AND deleted = 0 AND LENGTH(data) > 0 AND sheet_id = $sheet_id ORDER BY order_id ASC, ID ASC" );
		if ( mysqli_num_rows($selectDataRowChild) > 0 ) {
			while($rowDataChild = mysqli_fetch_array($selectDataRowChild)) {
				$dataChild_ID = $rowDataChild['ID'];

				$includeChild_arr = array();
				if ($rowDataChild['include'] != NULL) { $includeChild_arr = explode(" | ", $rowDataChild['include']); }

				$dataChild_arr = json_decode($rowDataChild['data'],true);

				$data .= '<tr class="child_'.$data_ID.'" id="tr_'.$dataChild_ID.'">';

					$selectFormat = mysqli_query( $conn,"SELECT * FROM tbl_ia_format WHERE deleted = 0 AND sheet_id = $sheet_id ORDER BY order_id" );
					if ( mysqli_num_rows($selectFormat) > 0 ) {
						while($rowFormat = mysqli_fetch_array($selectFormat)) {
					        $formatID = $rowFormat['ID'];

					        $type = $rowFormat['type'];
							$type_arr = explode(" | ", $type);

					        $label = $rowFormat['label'];
							$label_arr = explode(" | ", $label);

							if ($type > 0) {
								if ($type == 1 OR $type == 3 OR $type == 4) {
									if (in_array($formatID, $includeChild_arr)) {
										foreach($dataChild_arr as $key => $value) {
											if ($formatID == $value['ID']) {
												$data .= '<td>'.$value['content'].'</td>';
											}
										}
									} else {
										$data .= '<td></td>';
									}
								} else if ($type == 2) {
									$radio_arr = explode(",", $label);

									if (in_array($formatID, $includeChild_arr)) {
										foreach ($radio_arr as $r) {
											$data .= '<td><input type="radio" class="m-0 radio_'.$dataChild_ID.'_'.$formatID.'" value="'.$r.'" name="radio_'.$dataChild_ID.'_'.$formatID.'" /></td>';
										}
									} else {
										$data .= '<td colspan="'.count($radio_arr).'"></td>';
									}
								}
							}
						}
					}

					$data .= '<td class="text-center">
						<a href="#modalEditRow" data-toggle="modal" class="btn btn-xs dark" onclick="btnEditRow('.$sheet_id.', '.$dataChild_ID.', '.$modal.')"><i class="fa fa-pencil"></i></a>
						<a href="#modalNewRow" data-toggle="modal" class="btn btn-xs btn-success" onclick="btnNewRow('.$sheet_id.', '.$dataChild_ID.', '.$modal.')"><i class="fa fa-plus"></i></a>
						<a href="javascript:;" class="btn btn-xs btn-danger m-0" onclick="btnDeleteRow(this, '.$dataChild_ID.')"><i class="fa fa-close"></i></a>
					</td>
				</tr>';

				$data .= ai_child($dataChild_ID, $sheet_id, $type_arr, $label_arr, $modal);
			}
		}

		return $data;
	}
	function ai_childView($ID, $data_ID, $sheet_id, $type_arr, $label_arr, $viewer, $generate, $form_data) {
		global $conn;
		$data = '';

		$selectDataRowChild  = mysqli_query( $conn,"SELECT * FROM tbl_ia_data WHERE parent_id = $data_ID AND deleted = 0 AND LENGTH(data) > 0 AND sheet_id = $sheet_id ORDER BY order_id ASC, ID ASC" );
		if ( mysqli_num_rows($selectDataRowChild) > 0 ) {
			while($rowDataChild = mysqli_fetch_array($selectDataRowChild)) {
				$dataChild_ID = $rowDataChild['ID'];

				$includeChild_arr = array();
				if ($rowDataChild['include'] != NULL) { $includeChild_arr = explode(" | ", $rowDataChild['include']); }

				$dataChild_arr = json_decode($rowDataChild['data'],true);

				$data .= '<tr class="child_'.$data_ID.'" id="tr_'.$dataChild_ID.'">';

					$selectFormat = mysqli_query( $conn,"SELECT * FROM tbl_ia_format WHERE deleted = 0 AND sheet_id = $sheet_id ORDER BY order_id" );
					if ( mysqli_num_rows($selectFormat) > 0 ) {
						while($rowFormat = mysqli_fetch_array($selectFormat)) {
					        $formatID = $rowFormat['ID'];

					        $type = $rowFormat['type'];
							$type_arr = explode(" | ", $type);

					        $label = $rowFormat['label'];
							$label_arr = explode(" | ", $label);

							if ($type > 0) {
								if ($type == 1 OR $type == 3 OR $type == 4) {
									if (in_array($formatID, $includeChild_arr)) {
										foreach($dataChild_arr as $key => $value) {
											if ($formatID == $value['ID']) {
												if (!empty($value['content'])) {
													$data .= '<td>'.$value['content'].'</td>';
												} else {
													$rowColumnData = '';
													if (!empty($form_data)) {
														$form_data_arr = json_decode($form_data,true);

														if (in_array($dataChild_ID, array_column($form_data_arr, 'row'))) {
															$rowColumnData = array_reduce($form_data_arr, function ($carry, $item) use ($dataChild_ID, $formatID) {
															    if ($item['row'] === $dataChild_ID && $item['content']['column'] === $formatID) {
															        return $item['content']['data'];
															    }
															    return $carry;
															});
														}
													}
													$data .= '<td>';

														if ($viewer == 1) { 
															$data .= '<a href="javascript:;" onClick="btnEdit_summernote(this, '.$dataChild_ID.', '.$formatID.')"><i class="fa fa-pencil"></i> [edit]</a>';

															if (!empty($rowColumnData)) { $data .= '<div class="textarea_value">'.$rowColumnData.'</div>'; }

															$data .= '<textarea class="hide" id="summernote_'.$dataChild_ID.'_'.$formatID.'" name="columnData_'.$dataChild_ID.'_'.$formatID.'">'.$rowColumnData.'</textarea>';

														}
														
													$data .= '</td>';
												}
											}
										}
									} else {
										$data .= '<td></td>';
									}
								} else if ($type == 2) {
									$radio_arr = explode(",", $label);

									if (in_array($formatID, $includeChild_arr)) {
										$rowColumnData = '';
										if (!empty($form_data)) {
											$form_data_arr = json_decode($form_data,true);

											if (in_array($dataChild_ID, array_column($form_data_arr, 'row'))) {
												$rowColumnData = array_reduce($form_data_arr, function ($carry, $item) use ($dataChild_ID, $formatID) {
												    if ($item['row'] === $dataChild_ID && $item['content']['column'] === $formatID) {
												        return $item['content']['data'];
												    }
												    return $carry;
												});
											}
										}

										foreach ($radio_arr as $r) {
											if ($generate == 1) {
												$data .= '<td><input type="radio" value="'.$r.'" name="radio_'.$dataChild_ID.'_'.$formatID.'" onclick="changeRadio(this.value, '.$dataChild_ID.', '.$formatID.', '.$ID.')" checked /></td>';
												$rowColumnData = $r;
											} else {
												if ($rowColumnData === $r) {
													$data .= '<td><input type="radio" value="'.$r.'" name="radio_'.$dataChild_ID.'_'.$formatID.'" onclick="changeRadio(this.value, '.$dataChild_ID.', '.$formatID.', '.$ID.')" checked/></td>';
												} else {
													$data .= '<td><input type="radio" value="'.$r.'" name="radio_'.$dataChild_ID.'_'.$formatID.'" onclick="changeRadio(this.value, '.$dataChild_ID.', '.$formatID.', '.$ID.')" /></td>';
												}
											}
										}
										$data .= '<td class="hide"><input type="hidden" class="radio_'.$dataChild_ID.'_'.$formatID.'" name="columnData_'.$formatID.'[]" value="'.$rowColumnData.'" /></td>';
									} else {
										$data .= '<td colspan="'.count($radio_arr).'"></td>';
										$data .= '<td class="hide"></td>';
									}
								}
							}
						}
					}

				$data .= '</tr>';

				$data .= ai_childView($ID, $dataChild_ID, $sheet_id, $type_arr, $label_arr, $viewer, $generate, $form_data);
			}
		}

		return $data;
	}
	function form_childView($data_ID, $sheet_id, $data_result) {
        global $conn;
        $data = '';

        $selectDataRowChild  = mysqli_query( $conn,"SELECT * FROM tbl_ia_data WHERE parent_id = $data_ID AND deleted = 0 AND LENGTH(data) > 0 AND sheet_id = $sheet_id ORDER BY order_id ASC, ID ASC" );
        if ( mysqli_num_rows($selectDataRowChild) > 0 ) {
            while($rowDataChild = mysqli_fetch_array($selectDataRowChild)) {
                $dataChild_ID = $rowDataChild['ID'];

                $selectFormat = mysqli_query( $conn,"SELECT * FROM tbl_ia_format WHERE deleted = 0 AND sheet_id = $sheet_id ORDER BY order_id" );
                if ( mysqli_num_rows($selectFormat) > 0 ) {
                    while($rowFormat = mysqli_fetch_array($selectFormat)) {
                        $formatID = $rowFormat['ID'];

                        if(!empty($_POST['radio_'.$dataChild_ID.'_'.$formatID])) {

                            $data_column = array (
                                'column' => $formatID,
                                'data' => addslashes($_POST['radio_'.$dataChild_ID.'_'.$formatID])
                            );

                            $data_output = array (
                                'row' => $dataChild_ID,
                                'content' => $data_column
                            );
                            array_push($data_result, $data_output);
                        } else if(!empty($_POST['columnData_'.$dataChild_ID.'_'.$formatID])) {

                            $data_column = array (
                                'column' => $formatID,
                                'data' => addslashes($_POST['columnData_'.$dataChild_ID.'_'.$formatID])
                            );

                            $data_output = array (
                                'row' => $dataChild_ID,
                                'content' => $data_column
                            );
                            array_push($data_result, $data_output);
                        }
                    }
                }

                $data_result = form_childView($dataChild_ID, $sheet_id, $data_result);
            }
        }
        
        return $data_result;
    }
	function cloneDataChild($value_sheet_id, $data_ID, $last_id_sheet, $last_id_data, $temp_data) {
        global $conn;

        $selectDataChild = mysqli_query( $conn,"SELECT * FROM tbl_ia_data WHERE sheet_id = $value_sheet_id AND parent_id = $data_ID");
        if ( mysqli_num_rows($selectDataChild) > 0 ) {
            while($rowDataChild = mysqli_fetch_array($selectDataChild)) {
                $datachild_ID = $rowDataChild['ID'];

                $sql_datachild = "INSERT INTO tbl_ia_data (order_id, sheet_id, parent_id, include, data)
                SELECT order_id, $last_id_sheet, $last_id_data, include, data
                FROM tbl_ia_data
                WHERE deleted = 0 AND ID = $datachild_ID";
                if (mysqli_query($conn, $sql_datachild)) {
                    $last_id_data = mysqli_insert_id($conn);

                    if ($temp_data <> NULL) {
                        $data_Y = array (
                            'old' => $datachild_ID,
                            'new' => $last_id_data
                        );
                        array_push($temp_data, $data_Y);
                    }

                    $temp_data = cloneDataChild($value_sheet_id, $datachild_ID, $last_id_sheet, $last_id_data, $temp_data);
                }
            }
        }

        return $temp_data;
    }
	if( isset($_GET['modalNew_Sheet']) ) {
        $modal = $_GET['modalNew_Sheet'];
        $timestamp_id = $_GET['t'];

        echo '<input type="hidden" name="modal" value="'.$modal.'" />
        <input type="hidden" name="timestamp_id" value="'.$timestamp_id.'" />
        <div class="form-group">
            <label class="col-md-2 control-label">Sheet Name</label>
            <div class="col-md-9">
                <input class="form-control" type="text" name="name" required />
            </div>
        </div>
        <div class="form-group">
            <label class="col-md-2 control-label">Format</label>
            <div class="col-md-9">
                <div class="mt-repeater mt-repeater-file">
                    <div data-repeater-list="format" class="format">';

                    if (!empty($timestamp_id)) {
                        $selectFormat = mysqli_query( $conn,"SELECT * FROM tbl_ia_format WHERE deleted = 0 AND timestamp_id = $timestamp_id ORDER BY order_id" );
                        if ( mysqli_num_rows($selectFormat) > 0 ) {
                            while($rowFormat = mysqli_fetch_array($selectFormat)) {
                                $format_ID = $rowFormat['ID'];
                                $format_type = $rowFormat['type'];
                                $format_label = $rowFormat['label'];

                                echo '<div class="mt-repeater-item row" data-repeater-item>
                                    <div class="col-md-3">
                                        <select class="form-control" disabled>
                                            <option value="0" '; echo $format_type == 0 ? 'SELECTED':''; echo '>Select Type</option>
                                            <option value="1" '; echo $format_type == 1 ? 'SELECTED':''; echo '>Text</option>
                                            <option value="2" '; echo $format_type == 2 ? 'SELECTED':''; echo '>Radio Button</option>
                                            <option value="3" '; echo $format_type == 3 ? 'SELECTED':''; echo '>Date</option>
                                        </select>
                                    </div>
                                    <div class="col-md-7">';

                                        if ($format_type == 1 OR $format_type == 3 OR $format_type == 4) {
                                            echo '<input type="hidden" name="type[]" value="'.$format_type.'" /><input type="hidden" name="formatID[]" value="'.$format_ID.'" /><input type="text" class="form-control" name="label[]" placeholder="Label" value="'.$format_label.'" required />';
                                        } else if ($format_type == 2) {
                                            echo '<input type="hidden" name="type[]" value="'.$format_type.'" /><input type="hidden" name="formatID[]" value="'.$format_ID.'" />
                                            <input type="text" class="form-control tagsinput" name="label[]" data-role="tagsinput" placeholder="Enter Options" value="'.$format_label.'" onkeydown="if (event.keyCode == 13) { this.nextElementSibling.focus(); return false; }" required />';
                                        }

                                    echo '</div>
                                    <div class="col-md-2 text-right">
                                        <a href="javascript:;" data-repeater-delete class="btn btn-danger" onclick="btnDeleteFormat(this, '.$format_ID.')"><i class="fa fa-close"></i></a>
                                    </div>
                                </div>';
                            }
                        }
                    } else {
                        echo '<div class="mt-repeater-item row" data-repeater-item>
                            <div class="col-md-3">
                                <select class="form-control" name="type[]" onchange="selectType(this)">
                                    <option value="0" SELECTED>Select Type</option>
                                    <option value="1">Text</option>
                                    <option value="2">Radio Button</option>
                                    <option value="3">Date</option>
                                </select>
                            </div>
                            <div class="col-md-7"></div>
                            <div class="col-md-2 text-right">
                                <a href="javascript:;" data-repeater-delete class="btn btn-danger" onclick="btnRepeaterRemove(this)"><i class="fa fa-close"></i></a>
                            </div>
                        </div>';
                    }
                    
                    echo '</div>
                    <a href="javascript:;" data-repeater-create class="btn btn-success mt-repeater-add" onclick="btnRepeaterAdd()"><i class="fa fa-plus"></i> Add more</a>
                </div>
            </div>
        </div>';
    }
	if( isset($_GET['modalView_Sheet']) ) {
        $ID = $_GET['modalView_Sheet'];
        $modal = $_GET['modal'];
        $timestamp_id = $_GET['t'];

        $selectData = mysqli_query( $conn,"SELECT * FROM tbl_ia_sheet WHERE ID = $ID" );
        if ( mysqli_num_rows($selectData) > 0 ) {
            $row = mysqli_fetch_array($selectData);
            $name = $row['name'];

            echo '<input type="hidden" name="ID" value="'.$ID.'" />
            <input type="hidden" name="modal" value="'.$modal.'" />
            <input type="hidden" name="timestamp_id" value="'.$timestamp_id.'" />
            <div class="form-group">
                <label class="col-md-2 control-label">Sheet Name</label>
                <div class="col-md-9">
                    <input class="form-control" type="text" name="name" value="'.$name.'" required />
                </div>
            </div>
            <div class="form-group">
                <label class="col-md-2 control-label">Format</label>
                <div class="col-md-9">
                    <div class="mt-repeater mt-repeater-file">
                        <div data-repeater-list="format" class="format">';

                            $selectFormat = mysqli_query( $conn,"SELECT * FROM tbl_ia_format WHERE deleted = 0 AND timestamp_id = $timestamp_id ORDER BY order_id" );
                            if ( mysqli_num_rows($selectFormat) > 0 ) {
                                while($rowFormat = mysqli_fetch_array($selectFormat)) {
                                    $format_ID = $rowFormat['ID'];
                                    $format_type = $rowFormat['type'];
                                    $format_label = $rowFormat['label'];

                                    echo '<div class="mt-repeater-item row" data-repeater-item>
                                        <div class="col-md-3">
                                            <select class="form-control" disabled>
                                                <option value="0" '; echo $format_type == 0 ? 'SELECTED':''; echo '>Select Type</option>
                                                <option value="1" '; echo $format_type == 1 ? 'SELECTED':''; echo '>Text</option>
                                                <option value="2" '; echo $format_type == 2 ? 'SELECTED':''; echo '>Radio Button</option>
                                                <option value="3" '; echo $format_type == 3 ? 'SELECTED':''; echo '>Date</option>
                                            </select>
                                        </div>
                                        <div class="col-md-7">';

                                            if ($format_type == 1 OR $format_type == 3 OR $format_type == 4) {
                                                echo '<input type="hidden" name="type[]" value="'.$format_type.'" /><input type="hidden" name="formatID[]" value="'.$format_ID.'" /><input type="text" class="form-control" name="label[]" placeholder="Label" value="'.$format_label.'" required />';
                                            } else if ($format_type == 2) {
                                                echo '<input type="hidden" name="type[]" value="'.$format_type.'" /><input type="hidden" name="formatID[]" value="'.$format_ID.'" />
                                                <input type="text" class="form-control tagsinput" name="label[]" data-role="tagsinput" placeholder="Enter Options" value="'.$format_label.'" onkeydown="if (event.keyCode == 13) { this.nextElementSibling.focus(); return false; }" required />';
                                            }

                                        echo '</div>
                                        <div class="col-md-2 text-right">
                                            <a href="javascript:;" data-repeater-delete class="btn btn-danger" onclick="btnDeleteFormat(this, '.$format_ID.')"><i class="fa fa-close"></i></a>
                                        </div>
                                    </div>';
                                }
                            }

                        echo '</div>
                        <a href="javascript:;" data-repeater-create class="btn btn-success mt-repeater-add" onclick="btnRepeaterAdd()"><i class="fa fa-plus"></i> Add more</a>
                    </div>
                </div>
            </div>';
        }
    }
    if( isset($_GET['modalTab_Sheet']) ) {
        $sheet_id = $_GET['modalTab_Sheet'];
        $timestamp_id = $_GET['t'];
        $modal = 2;

        $type_arr = array();
        $label_arr = array();
        $label_name_arr = array();

        $data_header = '';
        $data_header2 = '';
        $data_sub = '';
        $data_row = '';

        $selectTemplate = mysqli_query( $conn,"SELECT * FROM tbl_ia_format WHERE deleted = 0 AND timestamp_id = $timestamp_id ORDER BY order_id" );
        if ( mysqli_num_rows($selectTemplate) > 0 ) {
            while($rowTemplate = mysqli_fetch_array($selectTemplate)) {
                $format_ID = $rowTemplate['ID'];
                $format_type = $rowTemplate['type'];
                $format_label = $rowTemplate['label'];

                $data_sub .= '<th>Included? (Y/N)</th>';
                if ($format_type == 1 OR $format_type == 3 OR $format_type == 4) {
                    $data_header .= '<th colspan="2">'.$format_label.'</th>';
                    $data_sub .= '<th>Content</th>';
                    $data_row .= '<td>Y</td>';
                    $data_row .= '<td>Sample Text</td>';

                    $data_header2 .= '<th>'.$format_label.'</th>';
                } else if ($format_type == 2) {
                    $data_header .= '<th>Radio Button: '.$format_label.'</th>';
                    $data_row .= '<td>Y</td>';

                    $radio_arr = explode(",", $format_label);
                    foreach ($radio_arr as $r) {
                        $data_header2 .= '<th>'.$r.'</th>';
                    }
                }
                                        
                array_push($type_arr, $rowTemplate['type']);
                array_push($label_arr, $rowTemplate['ID']);
                array_push($label_name_arr, $rowTemplate['label']);
            }
        }
        $type = implode(' | ', $type_arr);
        $label = implode(' | ', $label_arr);
        $label_name = implode(' | ', $label_name_arr);

        echo '<table class="table table-bordered hide" id="tableTemplate_'.$sheet_id.'">
            <tr class="bg-default">'.$data_header.'</tr>
            <tr>'.$data_sub.'</tr>
            <tr>'.$data_row.'</tr>
        </table>

        <table class="table table-bordered">
            <thead>
                <tr class="bg-default">
                    <th class="text-center" style="width:135px;">Action</th>
                    '.$data_header2.'
                </tr>
            </thead>
            <tbody>';

                $selectDataRow = mysqli_query( $conn,"WITH RECURSIVE cte (rowID, rowOrder, rowParent, rowInclude, rowData) AS
                    (
                        SELECT
                        t1.ID AS rowID,
                        t1.order_id AS rowOrder,
                        t1.parent_id AS rowParent,
                        t1.include AS rowInclude,
                        t1.data AS rowData
                        FROM tbl_ia_data AS t1
                        WHERE t1.parent_id = 0 
                        AND t1.deleted = 0 
                        AND LENGTH(t1.data) > 0 
                        AND t1.sheet_id = $sheet_id

                        UNION ALL

                        SELECT
                        t2.ID AS rowID,
                        t2.order_id AS rowOrder,
                        t2.parent_id AS rowParent,
                        t2.include AS rowInclude,
                        t2.data AS rowData
                        FROM tbl_ia_data AS t2
                        JOIN cte ON cte.rowID = t2.parent_id
                        WHERE t2.deleted = 0 
                        AND LENGTH(t2.data) > 0 
                        AND t2.sheet_id = $sheet_id
                    )
                    SELECT 
                    rowID, rowOrder, rowParent, rowInclude, rowData
                    FROM cte
                    ORDER BY rowOrder ASC, rowID ASC" );
                if ( mysqli_num_rows($selectDataRow) > 0 ) {
                    while($rowData = mysqli_fetch_array($selectDataRow)) {
                        $data_ID = $rowData['rowID'];

                        $include_arr = array();
                        if ($rowData['rowInclude'] != NULL) { $include_arr = explode(" | ", $rowData['rowInclude']); }

                        $data_arr = json_decode($rowData['rowData'],true);

                        echo '<tr id="tr_'.$data_ID.'">
                            <td class="text-center">
                                <a href="#modalEditRow" data-toggle="modal" class="btn btn-xs dark" onclick="btnEditRow('.$sheet_id.', '.$data_ID.', '.$modal.', '.$timestamp_id.')"><i class="fa fa-pencil"></i></a>
                                <a href="#modalNewRow" data-toggle="modal" class="btn btn-xs btn-success" onclick="btnNewRow('.$sheet_id.', '.$data_ID.', '.$modal.', '.$timestamp_id.')"><i class="fa fa-plus"></i></a>
                                <a href="javascript:;" class="btn btn-xs btn-danger m-0" onclick="btnDeleteRow(this, '.$data_ID.')"><i class="fa fa-close"></i></a>
                            </td>';

                            $type_arr = explode(" | ", $type);
                            $label_arr = explode(" | ", $label);

                            $i = 0;
                            foreach ($type_arr as $value) {
                                if ($value > 0) {
                                    if ($value == 1 OR $value == 3 OR $value == 4) {
                                        if (in_array($label_arr[$i], $include_arr)) {
                                            echo '<td>';
                                                foreach($data_arr as $key => $val) {
                                                    if ($label_arr[$i] == $val['ID']) {
                                                        echo $val['content'];
                                                    }
                                                }
                                            echo '</td>';
                                        } else {
                                            echo '<td></td>';
                                        }
                                    } else if ($value == 2) {
                                        $radio_arr = explode(",", $label_name);

                                        if (in_array($label_arr[$i], $include_arr)) {
                                            $formatID = $label_arr[$i];
                                            if (in_array($formatID, array_column($data_arr, 'ID'))) {
                                                foreach ($radio_arr as $r) {
                                                    echo '<td><input type="radio" class="m-0 radio_'.$data_ID.'_'.$label_arr[$i].'" value="'.$r.'" name="radio_'.$data_ID.'_'.$label_arr[$i].'" /></td>';
                                                }
                                            } else {
                                                echo '<td colspan="'.count($radio_arr).'"></td>';
                                            }
                                        } else {
                                            echo '<td colspan="'.count($radio_arr).'"></td>';
                                        }
                                    }
                                    $i++;
                                }
                            }

                        echo '</tr>';
                    }
                }

            echo '</tbody>
        </table>
        <a href="#modalNewRow" data-toggle="modal" class="btn btn-success m-0" onclick="btnNewRow('.$sheet_id.', 0, '.$modal.', '.$timestamp_id.')"><i class="fa fa-plus"> Add Row</i></a>
        <a href="javascript:;" class="btn btn-info m-0" onclick="btnTemplate('.$sheet_id.')"><i class="fa fa-download"> Download Template</i></a>
        <a href="#modalImport" data-toggle="modal" class="btn btn-default m-0" onclick="btnImport('.$sheet_id.', '.$timestamp_id.')"><i class="fa fa-upload"> Import</i></a>';
    }
	if( isset($_GET['modalNew_Row']) ) {
        $ID = $_GET['modalNew_Row'];
        $r = $_GET['row'];
        $modal = $_GET['modal'];
        $timestamp_id = $_GET['t'];

        echo '<input type="hidden" name="sheet_id" value="'.$ID.'" />
        <input type="hidden" name="parent_id" value="'.$r.'" />
        <input type="hidden" name="modal" value="'.$modal.'" />
        <input type="hidden" name="timestamp_id" value="'.$timestamp_id.'" />';
        
        $selectData = mysqli_query( $conn,"SELECT * FROM tbl_ia_format WHERE deleted = 0 AND timestamp_id = $timestamp_id ORDER BY order_id" );
        if ( mysqli_num_rows($selectData) > 0 ) {
            while($row = mysqli_fetch_array($selectData)) {
                $formatID = $row['ID'];

                $type = $row['type'];
                $type_arr = explode(" | ", $type);

                $label = $row['label'];
                $label_arr = explode(" | ", $label);

                if ($type > 0) {
                    if ($type == 1) {
                        echo '<div class="form-group">
                            <label class="col-md-3 control-label">'.$label.'</label>
                            <div class="col-md-8">
                                <div class="mt-checkbox-list margin-top-10">
                                    <label class="mt-checkbox mt-checkbox-outline m-0"> Include?
                                        <input type="checkbox" value="'.$formatID.'" name="rowInclude[]" onchange="checkInclude(this, 1, '.$formatID.')" checked />
                                        <span></span>
                                    </label>
                                </div>
                                <textarea class="summernote hide summernoteOpen" id="summernote_1_'.$formatID.'" name="rowData[]"></textarea>
                            </div>
                        </div>';
                    } else if ($type == 2) {
                        echo '<div class="form-group">
                            <label class="col-md-3 control-label">'.$label.' Option(s)</label>
                            <div class="col-md-8">
                                <div class="mt-checkbox-list margin-top-10">
                                    <label class="mt-checkbox mt-checkbox-outline m-0"> Include?
                                        <input type="checkbox" value="'.$formatID.'" name="rowInclude[]" onchange="checkInclude(this, 1, '.$formatID.')" />
                                        <span></span>
                                    </label>
                                </div>
                                <select class="form-control hide" name="rowData[]">
                                    <option value="0">No</option>
                                    <option value="1">Yes</option>
                                </select>
                                <i class="help-block hide">(Include radio button for: '.$label.')</i>
                            </div>
                        </div>';
                    } else if ($type == 3) {
                        echo '<div class="form-group">
                            <label class="col-md-3 control-label">'.$label.'</label>
                            <div class="col-md-8">
                                <div class="mt-checkbox-list margin-top-10">
                                    <label class="mt-checkbox mt-checkbox-outline m-0"> Include?
                                        <input type="checkbox" value="'.$formatID.'" name="rowInclude[]" onchange="checkInclude(this, 1, '.$formatID.')" />
                                        <span></span>
                                    </label>
                                </div>
                                <input type="date" class="form-control" name="rowData[]" style="display: none;" />
                            </div>
                        </div>';
                    } else if ($type == 4) {
                        echo '<div class="form-group">
                            <label class="col-md-3 control-label">'.$label.'</label>
                            <div class="col-md-8">
                                <div class="mt-checkbox-list margin-top-10">
                                    <label class="mt-checkbox mt-checkbox-outline m-0"> Include?
                                        <input type="checkbox" value="'.$formatID.'" name="rowInclude[]" onchange="checkInclude(this, 1, '.$formatID.')" />
                                        <span></span>
                                    </label>
                                </div>
                                <input type="file" class="form-control" name="rowData[]" style="display: none;" />
                            </div>
                        </div>';
                    }
                }
            }
        }
    }
	if( isset($_GET['modalEdit_Row']) ) {
        $ID = $_GET['modalEdit_Row'];
        $r = $_GET['row'];
        $modal = $_GET['modal'];
        $timestamp_id = $_GET['t'];

        $selectData = mysqli_query( $conn,"SELECT * FROM tbl_ia_data WHERE deleted = 0 AND ID = $r" );
        if ( mysqli_num_rows($selectData) > 0 ) {
            $rowData = mysqli_fetch_array($selectData);
            $data_sheet_id = $rowData['sheet_id'];

            $include_arr = array();
            if ($rowData['include'] != NULL) { $include_arr = explode(" | ", $rowData['include']); }

            $data_arr = json_decode($rowData['data'],true);

            echo '<input type="hidden" name="sheet_id" value="'.$data_sheet_id.'" />
            <input type="hidden" name="parent_id" value="'.$r.'" />
            <input type="hidden" name="modal" value="'.$modal.'" />
            <input type="hidden" name="timestamp_id" value="'.$timestamp_id.'" />';

            $data_result = array();
            $selectDataFormat = mysqli_query( $conn,"SELECT * FROM tbl_ia_format WHERE deleted = 0 AND timestamp_id = $timestamp_id ORDER BY order_id" );
            if ( mysqli_num_rows($selectDataFormat) > 0 ) {
                while($row = mysqli_fetch_array($selectDataFormat)) {
                    $formatID = $row['ID'];
                    $type = $row['type'];
                    $label = $row['label'];

                    $data_content = '';
                    foreach($data_arr as $key => $value) {
                        if ($formatID == $value['ID']) {
                            $data_content = $value['content'];
                        }
                    }

                    if ($type > 0) {
                        if ($type == 1) {
                            echo '<div class="form-group">
                                <label class="col-md-3 control-label">'.$label.'</label>
                                <div class="col-md-8">
                                    <div class="mt-checkbox-list margin-top-10">
                                        <label class="mt-checkbox mt-checkbox-outline m-0"> Include?
                                            <input type="checkbox" value="'.$formatID.'" name="rowInclude[]" onchange="checkInclude(this, 2, '.$formatID.')" '; echo in_array($formatID, $include_arr) ? 'checked':''; echo ' />
                                            <span></span>
                                        </label>
                                    </div>
                                    <textarea class="summernote hide '; echo in_array($formatID, $include_arr) ? 'summernoteOpen':''; echo '" id="summernote_2_'.$formatID.'" name="rowData[]">'.$data_content.'</textarea>
                                </div>
                            </div>';
                        } else if ($type == 2) {
                            echo '<div class="form-group">
                                <label class="col-md-3 control-label">'.$label.' Option(s)</label>
                                <div class="col-md-8">
                                    <div class="mt-checkbox-list margin-top-10">
                                        <label class="mt-checkbox mt-checkbox-outline m-0"> Include?
                                            <input type="checkbox" value="'.$formatID.'" name="rowInclude[]" onchange="checkInclude(this, 2, '.$formatID.')" '; echo in_array($formatID, $include_arr) ? 'checked':''; echo ' />
                                            <span></span>
                                        </label>
                                    </div>
                                    <select class="form-control hide" name="rowData[]">
                                        <option value="0" '; echo $data_content == 0 ? 'SELECTED':''; echo '>No</option>
                                        <option value="1" '; echo $data_content == 1 ? 'SELECTED':''; echo '>Yes</option>
                                    </select>
                                    <i class="help-block hide">(Include radio button for: '.$label.')</i>
                                </div>
                            </div>';
                        } else if ($type == 3) {
                            echo '<div class="form-group">
                                <label class="col-md-3 control-label">'.$label.'</label>
                                <div class="col-md-8">
                                    <div class="mt-checkbox-list margin-top-10">
                                        <label class="mt-checkbox mt-checkbox-outline m-0"> Include?
                                            <input type="checkbox" value="'.$formatID.'" name="rowInclude[]" onchange="checkInclude(this, 2, '.$formatID.')" '; echo in_array($formatID, $include_arr) ? 'checked':''; echo ' />
                                            <span></span>
                                        </label>
                                    </div>
                                    <input type="date" class="form-control" name="rowData[]" '; echo in_array($formatID, $include_arr) ? '':'style="display: none;"'; echo ' value="'.$data_content.'" />
                                </div>
                            </div>';
                        } else if ($type == 4) {
                            echo '<div class="form-group">
                                <label class="col-md-3 control-label">'.$label.'</label>
                                <div class="col-md-8">
                                    <div class="mt-checkbox-list margin-top-10">
                                        <label class="mt-checkbox mt-checkbox-outline m-0"> Include?
                                            <input type="checkbox" value="'.$formatID.'" name="rowInclude[]" onchange="checkInclude(this, 2, '.$formatID.')" '; echo in_array($formatID, $include_arr) ? 'checked':''; echo ' />
                                            <span></span>
                                        </label>
                                    </div>
                                    <input type="file" class="form-control" name="rowData[]" '; echo in_array($formatID, $include_arr) ? '':'style="display: none;"'; echo ' value="'.$data_content.'" />
                                </div>
                            </div>';
                        }
                    }
                }
            }
        }
    }
	if( isset($_GET['modalSort_Row']) ) {
		$ID = $_GET['modalSort_Row'];
		$page_id_array = $_POST['page_id_array'];

		for ($i=0; $i < count($page_id_array); $i++) { 
			mysqli_query( $conn,"UPDATE tbl_ia_data set order_id = $i WHERE sheet_id = $ID AND ID = $page_id_array[$i]" );
		}
		echo 'done';
	}
	if( isset($_GET['modalNew_IA']) ) {
        $modal = $_GET['modalNew_IA'];

        $date = new DateTime(); //this returns the current date time
        $timestamp_id = $date->format('YmdHisu');

        echo '<input type="hidden" name="modal" value="'.$modal.'" />
        <input type="hidden" name="timestamp_id" value="'.$timestamp_id.'" />
        <div class="form-group">
            <label class="col-md-3 control-label">Audit Title</label>
            <div class="col-md-8">
                <input type="text" class="form-control" name="title" required />
            </div>
        </div>
        <div class="form-group">
            <label class="col-md-3 control-label">Description</label>
            <div class="col-md-8">
                <textarea class="form-control" name="description" required></textarea>
            </div>
        </div>
        <div class="form-group">
            <label class="col-md-3 control-label">Date</label>
            <div class="col-md-8">
                <input type="date" class="form-control" name="date" required />
            </div>
        </div>
        <div class="tabbable tabbable-tabdrop">
            <ul class="nav nav-tabs">
                <li class="">
                    <a data-toggle="modal" href="#modalNewSheet" onclick="btnNewSheet(1, \''.$timestamp_id.'\')"><i class="fa fa-plus"></i></a>
                </li>
            </ul>
            <div class="tab-content margin-top-20"></div>
        </div>';
    }
	if( isset($_GET['modalEdit_IA']) ) {
		$ID = $_GET['modalEdit_IA'];
		$modal = $_GET['modal'];

		$selectData = mysqli_query( $conn,"SELECT * FROM tbl_ia WHERE deleted = 0 AND ID = $ID" );
		if ( mysqli_num_rows($selectData) > 0 ) {
			$rowIA = mysqli_fetch_array($selectData);
			$ia_title = $rowIA['title'];
			$ia_description = $rowIA['description'];
			$ia_last_modified = $rowIA['last_modified'];
			$ia_sheet_id = $rowIA['sheet_id'];

			echo '<input type="hidden" name="ID" value="'.$ID.'" />
			<input type="hidden" name="modal" value="'.$modal.'" />
			<div class="form-group">
	            <label class="col-md-3 control-label">Audit Title</label>
	            <div class="col-md-8">
	                <input type="text" class="form-control" name="title" value="'.stripcslashes($ia_title).'" required />
	            </div>
	        </div>
	        <div class="form-group">
	            <label class="col-md-3 control-label">Description</label>
	            <div class="col-md-8">
	                <textarea class="form-control" name="description" required>'.stripcslashes($ia_description).'</textarea>
	            </div>
	        </div>
	        <div class="form-group">
	            <label class="col-md-3 control-label">Date</label>
	            <div class="col-md-8">
	                <input type="date" class="form-control" name="date" value="'.$ia_last_modified.'" required />
	            </div>
	        </div>
	        <div class="tabbable tabbable-tabdrop">
	            <ul class="nav nav-tabs">
	                <li class="">
	                    <a href="javascript:;"><i class="fa fa-plus" data-toggle="modal" href="#modalNewSheet" onclick="btnNewSheet('.$modal.')"></i></a>
	                </li>';

	                if (!empty($ia_sheet_id)) {
	                	$ia_sheet_id_arr = explode(' | ', $ia_sheet_id);
	                	foreach($ia_sheet_id_arr as $sheet_id) {
	                		$selectSheet = mysqli_query( $conn,"SELECT * FROM tbl_ia_sheet WHERE deleted = 0 AND ID = $sheet_id" );
	                		if ( mysqli_num_rows($selectSheet) > 0 ) {
	                			$rowSheet = mysqli_fetch_array($selectSheet);
								$sheet_name = $rowSheet['name'];

		                		echo '<li class="" id="li_'.$sheet_id.'">
		                			<input type="hidden" name="sheetID[]" value="'.$sheet_id.'">
				                	<a href="#tabSheet_'.$sheet_id.'" data-toggle="tab" aria-expanded="true">'.$sheet_name.' <i class="fa fa-pencil text-danger" data-toggle="modal" href="#modalViewSheet" onclick="btnViewSheet('.$sheet_id.', '.$modal.')"></i></a>
				                </li>';
	                		}
	                	}
	                }

	            echo '</ul>
	            <div class="tab-content margin-top-20">';

	                if (!empty($ia_sheet_id)) {
	                	$ia_sheet_id_arr = explode(' | ', $ia_sheet_id);
	                	foreach($ia_sheet_id_arr as $sheet_id) {

	                		echo '<div class="tab-pane" id="tabSheet_'.$sheet_id.'">

                                <table class="table table-bordered hide" id="tableTemplate_'.$sheet_id.'"><tr class="bg-default">';

                                $selectTemplate = mysqli_query( $conn,"SELECT * FROM tbl_ia_format WHERE deleted = 0 AND sheet_id = $sheet_id ORDER BY order_id" );
                                if ( mysqli_num_rows($selectTemplate) > 0 ) {
                                    while($rowTemplate = mysqli_fetch_array($selectTemplate)) {
                                        $format_ID = $rowTemplate['ID'];
                                        $format_type = $rowTemplate['type'];
                                        $format_label = $rowTemplate['label'];

                                        if ($format_type == 1 OR $format_type == 3 OR $format_type == 4) {
                                            echo '<th colspan="2">'.$format_label.'</th>';
                                        } else if ($format_type == 2) {
                                            echo '<th>Radio Button: '.$format_label.'</th>';
                                        }
                                    }
                                }

                                echo '</tr><tr>';

                                $selectTemplate2 = mysqli_query( $conn,"SELECT * FROM tbl_ia_format WHERE deleted = 0 AND sheet_id = $sheet_id ORDER BY order_id" );
                                if ( mysqli_num_rows($selectTemplate2) > 0 ) {
                                    while($rowTemplate2 = mysqli_fetch_array($selectTemplate2)) {
                                        $format_ID = $rowTemplate2['ID'];
                                        $format_type = $rowTemplate2['type'];
                                        $format_label = $rowTemplate2['label'];

                                        echo '<th>Included? (Y/N)</th>';
                                        if ($format_type == 1 OR $format_type == 3 OR $format_type == 4) {
                                            echo '<th>Content</th>';
                                        }
                                    }
                                }

                                echo '</tr><tr>';

                                $selectTemplate3 = mysqli_query( $conn,"SELECT * FROM tbl_ia_format WHERE deleted = 0 AND sheet_id = $sheet_id ORDER BY order_id" );
                                if ( mysqli_num_rows($selectTemplate3) > 0 ) {
                                    while($rowTemplate3 = mysqli_fetch_array($selectTemplate3)) {
                                        $format_ID = $rowTemplate3['ID'];
                                        $format_type = $rowTemplate3['type'];
                                        $format_label = $rowTemplate3['label'];

                                        if ($format_type == 1 OR $format_type == 3 OR $format_type == 4) {
                                            echo '<td>Y</td>';
                                            echo '<td>Sample Text</td>';
                                        } else if ($format_type == 2) {
                                            echo '<td>Y</td>';
                                        }
                                    }
                                }

                                echo '</tr></table>

	                			<table class="table table-bordered">
	                				<thead>
				                        <tr class="bg-default">';

					                		$selectFormat = mysqli_query( $conn,"SELECT * FROM tbl_ia_format WHERE deleted = 0 AND sheet_id = $sheet_id ORDER BY order_id" );
					                		if ( mysqli_num_rows($selectFormat) > 0 ) {
					                			while($rowFormat = mysqli_fetch_array($selectFormat)) {
						                        	if ($rowFormat['type'] > 0) {
						                        		if ($rowFormat['type'] == 1 OR $rowFormat['type'] == 3 OR $rowFormat['type'] == 4) {
						                        			echo '<th>'.$rowFormat['label'].'</th>';
						                        		} else if ($rowFormat['type'] == 2) {
					                        				$radio_arr = explode(",", $rowFormat['label']);
					                        				foreach ($radio_arr as $r) {
					                        					echo '<th>'.$r.'</th>';
					                        				}
						                        		}
						                        	}
					                			}
                							}

											echo '<th class="text-center" style="width:135px;">Action</th>
										</tr>
									</thead>
									<tbody>';

										$selectDataRow = mysqli_query( $conn,"SELECT * FROM tbl_ia_data WHERE parent_id = 0 AND deleted = 0 AND LENGTH(data) > 0 AND sheet_id = $sheet_id ORDER BY order_id ASC, ID ASC" );
										if ( mysqli_num_rows($selectDataRow) > 0 ) {
                							while($rowData = mysqli_fetch_array($selectDataRow)) {
                								$data_ID = $rowData['ID'];

                								$include_arr = array();
                								if ($rowData['include'] != NULL) { $include_arr = explode(" | ", $rowData['include']); }

                                                $data_arr = json_decode($rowData['data'],true);

                								echo '<tr id="tr_'.$data_ID.'">';

	                								$selectFormat = mysqli_query( $conn,"SELECT * FROM tbl_ia_format WHERE deleted = 0 AND sheet_id = $sheet_id ORDER BY order_id" );
						                			if ( mysqli_num_rows($selectFormat) > 0 ) {
						                				while($rowFormat = mysqli_fetch_array($selectFormat)) {
												            $formatID = $rowFormat['ID'];

												            $type = $rowFormat['type'];
															$type_arr = explode(" | ", $type);

												            $label = $rowFormat['label'];
															$label_arr = explode(" | ", $label);

															if ($type > 0) {
																if ($type == 1 OR $type == 3 OR $type == 4) {
																	if (in_array($formatID, $include_arr)) {
																		foreach($data_arr as $key => $value) {
																			if ($formatID == $value['ID']) {
																				echo '<td>'.$value['content'].'</td>';
																			}
																		}
																	} else {
																		echo '<td></td>';
																	}
																} else if ($type == 2) {
																	$radio_arr = explode(",", $label);

																	if (in_array($formatID, $include_arr)) {
																		foreach ($radio_arr as $r) {
																			echo '<td><input type="radio" class="m-0 radio_'.$data_ID.'_'.$formatID.'" value="'.$r.'" name="radio_'.$data_ID.'_'.$formatID.'" /></td>';
																		}
																	} else {
																		echo '<td colspan="'.count($radio_arr).'"></td>';
																	}
																}
															}
														}
						                			}

													echo '<td class="text-center">
														<a href="#modalEditRow" data-toggle="modal" class="btn btn-xs dark" onclick="btnEditRow('.$sheet_id.', '.$data_ID.', '.$modal.')"><i class="fa fa-pencil"></i></a>
														<a href="#modalNewRow" data-toggle="modal" class="btn btn-xs btn-success" onclick="btnNewRow('.$sheet_id.', '.$data_ID.', '.$modal.')"><i class="fa fa-plus"></i></a>
														<a href="javascript:;" class="btn btn-xs btn-danger m-0" onclick="btnDeleteRow(this, '.$data_ID.')"><i class="fa fa-close"></i></a>
													</td>
												</tr>';

                								echo ai_child($data_ID, $sheet_id, $type_arr, $label_arr, $modal);
                							}
                						}

									echo '</tbody>
	                			</table>
	                			<a href="#modalNewRow" data-toggle="modal" class="btn btn-success m-0" onclick="btnNewRow('.$sheet_id.', 0, '.$modal.')"><i class="fa fa-plus"> Add Row</i></a>
                                <a href="javascript:;" class="btn btn-info m-0" onclick="btnTemplate('.$sheet_id.')"><i class="fa fa-download"> Download Template</i></a>
                                <a href="#modalImport" data-toggle="modal" class="btn btn-default m-0" onclick="btnImport('.$sheet_id.')"><i class="fa fa-upload"> Import</i></a>
	                		</div>';
	                	}
	                }

	            echo '</div>
	        </div>';
		}
	}
	if( isset($_GET['modalView_IA']) ) {
		$ID = $_GET['modalView_IA'];

		$selectData = mysqli_query( $conn,"SELECT * FROM tbl_ia WHERE deleted = 0 AND ID = $ID" );
		if ( mysqli_num_rows($selectData) > 0 ) {
			$rowIA = mysqli_fetch_array($selectData);
			$ia_title = $rowIA['title'];
			$ia_description = $rowIA['description'];
			$ia_sheet_id = $rowIA['sheet_id'];

			$ia_last_modified = $rowIA['last_modified'];
			$ia_last_modified = new DateTime($ia_last_modified);
			$ia_last_modified = $ia_last_modified->format('M d, Y');

			echo '
			<span class="pull-right">'.$ia_last_modified.'</span>
			<h4 class="bold">'.stripcslashes($ia_title).'</h5>
			<h6>'.stripcslashes($ia_description).'</h6>
			<table class="table margin-top-20">';

		        if (!empty($ia_sheet_id)) {
		        	$ia_sheet_id_arr = explode(' | ', $ia_sheet_id);
		        	foreach($ia_sheet_id_arr as $sheet_id) {

		        		$selectSheet = mysqli_query( $conn,"SELECT * FROM tbl_ia_sheet WHERE deleted = 0 AND ID = $sheet_id" );
		        		if ( mysqli_num_rows($selectSheet) > 0 ) {
		        			$rowSheet = mysqli_fetch_array($selectSheet);
							$sheet_name = $rowSheet['name'];
		        		}

		        		echo '<tr class="bg-warning">
							<td colspan="100%" class="text-center bold">'.$sheet_name.'</td>
						</tr>
		                <tr class="bg-default">';

							$selectFormat = mysqli_query( $conn,"SELECT * FROM tbl_ia_format WHERE deleted = 0 AND sheet_id = $sheet_id ORDER BY order_id" );
							if ( mysqli_num_rows($selectFormat) > 0 ) {
								while($rowFormat = mysqli_fetch_array($selectFormat)) {
							    	if ($rowFormat['type'] > 0) {
							    		if ($rowFormat['type'] == 1 OR $rowFormat['type'] == 3 OR $rowFormat['type'] == 4) {
							    			echo '<td class="bold">'.$rowFormat['label'].'</td>';
							    		} else if ($rowFormat['type'] == 2) {
											$radio_arr = explode(",", $rowFormat['label']);
											foreach ($radio_arr as $r) {
												echo '<td class="bold">'.$r.'</td>';
											}
							    		}
							    	}
								}
							}

						echo '</tr>';

						$selectDataRow = mysqli_query( $conn,"SELECT * FROM tbl_ia_data WHERE parent_id = 0 AND deleted = 0 AND LENGTH(data) > 0 AND sheet_id = $sheet_id ORDER BY order_id ASC, ID ASC" );
						if ( mysqli_num_rows($selectDataRow) > 0 ) {
							while($rowData = mysqli_fetch_array($selectDataRow)) {
								$data_ID = $rowData['ID'];

								$include_arr = array();
								if ($rowData['include'] != NULL) { $include_arr = explode(" | ", $rowData['include']); }

		                        $data_arr = json_decode($rowData['data'],true);

								echo '<tr id="tr_'.$data_ID.'">';

									$selectFormat = mysqli_query( $conn,"SELECT * FROM tbl_ia_format WHERE deleted = 0 AND sheet_id = $sheet_id ORDER BY order_id" );
		                			if ( mysqli_num_rows($selectFormat) > 0 ) {
		                				while($rowFormat = mysqli_fetch_array($selectFormat)) {
								            $formatID = $rowFormat['ID'];

								            $type = $rowFormat['type'];
											$type_arr = explode(" | ", $type);

								            $label = $rowFormat['label'];
											$label_arr = explode(" | ", $label);

											if ($type > 0) {
												if ($type == 1 OR $type == 3 OR $type == 4) {
													if (in_array($formatID, $include_arr)) {
														foreach($data_arr as $key => $value) {
															if ($formatID == $value['ID']) {
																echo '<td>'.$value['content'].'</td>';
															}
														}
													} else {
														echo '<td></td>';
													}
												} else if ($type == 2) {
													$radio_arr = explode(",", $label);

													if (in_array($formatID, $include_arr)) {
														foreach ($radio_arr as $r) {
															echo '<td><input type="radio" class="m-0 radio_'.$data_ID.'_'.$formatID.'" value="'.$r.'" name="radio_'.$data_ID.'_'.$formatID.'" /></td>';
														}
													} else {
														echo '<td colspan="'.count($radio_arr).'"></td>';
													}
												}
											}
										}
		                			}

								echo '</tr>';

								echo ai_childView($ID, $data_ID, $sheet_id, $type_arr, $label_arr, 0, 0, NULL);
							}
						}
		        	}
		        }

			echo '</table>';
		}
	}
	if( isset($_GET['modalClone_IA']) ) {
		$ID = $_GET['modalClone_IA'];

		if (!empty($_COOKIE['switchAccount'])) {
			$portal_user = $_COOKIE['ID'];
			$user_id = $_COOKIE['switchAccount'];
		}
		else {
			$portal_user = $_COOKIE['ID'];
			$user_id = employerID($portal_user);
		}

		echo '<input class="form-control" type="hidden" name="ID" value = "'. $ID .'" />
		<div class="form-group">
            <label class="col-md-3 control-label">Select User</label>
            <div class="col-md-8">
                <select class="form-control mt-multiselect btn btn-default" name="user" required>
                	<option value="">Select</option>';

            		$selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE employee_id = 0 AND is_verified = 1 AND is_active = 1 AND ID != $portal_user ORDER BY first_name" );
                    if ( mysqli_num_rows($selectUser) > 0 ) {
                        while($rowUser = mysqli_fetch_array($selectUser)) {
                            $user_ID = $rowUser["ID"];
                            $user_name = $rowUser["first_name"] .' '.$rowUser["last_name"];

                            if ($user_ID == 464) {
                                $selectUser2 = mysqli_query( $conn,"SELECT
                                    e.ID AS e_ID,
                                    u.ID AS u_ID,
                                    u.first_name AS u_FName,
                                    u.last_name AS u_LName

                                    FROM tbl_hr_employee AS e

                                    INNER JOIN (
                                        SELECT
                                        *
                                        FROM tbl_user
                                        WHERE is_active = 1
                                    ) AS u
                                    ON u.employee_ID = e.ID

                                    WHERE e.suspended = 0
                                    AND e.status = 1
                                    AND e.user_id = $user_ID" );
                                if ( mysqli_num_rows($selectUser2) > 0 ) {
                                    while($rowUser2 = mysqli_fetch_array($selectUser2)) {
                                        $user_ID2 = $rowUser2["u_ID"];
                                        $user_name2 = $rowUser2["u_FName"] .' '.$rowUser2["u_LName"];

                                        echo '<option value="'.$user_ID2.'">'.$user_name2.'</option>';
                                    }
                                }
                            } else {
                                echo '<option value="'.$user_ID.'">'.$user_name.'</option>';
                            }
                        }
                    }

                echo '</select>
            </div>
        </div>';
	}
	if( isset($_GET['modalGenerate']) ) {
		$ID = $_GET['modalGenerate'];

		if (!empty($_COOKIE['switchAccount'])) {
			$portal_user = $_COOKIE['ID'];
			$user_id = $_COOKIE['switchAccount'];
		}
		else {
			$portal_user = $_COOKIE['ID'];
			$user_id = employerID($portal_user);
		}

		$selectData = mysqli_query( $conn,"SELECT * FROM tbl_ia WHERE deleted = 0 AND ID = $ID" );
		if ( mysqli_num_rows($selectData) > 0 ) {
			$rowIA = mysqli_fetch_array($selectData);
			$ia_title = $rowIA['title'];
			$ia_description = $rowIA['description'];
			$ia_sheet_id = $rowIA['sheet_id'];

			$ia_last_modified = $rowIA['last_modified'];
			$ia_last_modified = new DateTime($ia_last_modified);
			$ia_last_modified = $ia_last_modified->format('M d, Y');

			echo '<input class="form-control" type="hidden" name="ID" value = "'. $ID .'" />
			<h4 class="bold">'.stripcslashes($ia_title).'</h5>
			<div class="row">
                <div class="col-md-4">
                    <div class="form-group">
                        <label>Organization</label>
                        <input type="text" class="form-control" name="organization" />
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label>Audit Type</label>
                        <input type="text" class="form-control" name="audit_type" />
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label>Inspected By</label>
                        <input type="text" class="form-control" name="inspected_by" />
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label>Auditee</label>
                        <input type="text" class="form-control" name="auditee" />
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label>Verified By</label>
                        <input type="text" class="form-control" name="verified_by" />
                    </div>
                </div>
                <div class="col-md-4">
	                <div class="form-group">
	                    <label class="control-label">Date</label>
		                <div class="input-group">
		                    <input type="text" class="form-control daterange" name="daterange" />
		                    <span class="input-group-btn">
		                        <button class="btn default date-range-toggle" type="button">
		                            <i class="fa fa-calendar"></i>
		                        </button>
		                    </span>
		                </div>
	                </div>
                </div>

                <div class="col-md-4">
	                <div class="form-group">
	                    <label class="control-label">Operation</label>
		                <textarea class="form-control" name="operation"></textarea>
	                </div>
                </div>
                <div class="col-md-4">
	                <div class="form-group">
	                    <label class="control-label">Shipper</label>
		                <textarea class="form-control" name="shipper"></textarea>
	                </div>
                </div>
                <div class="col-md-4">
	                <div class="form-group">
	                    <label class="control-label">Operation Type</label>
		                <textarea class="form-control" name="operation_type"></textarea>
	                </div>
                </div>
                <div class="col-md-4">
	                <div class="form-group">
	                    <label class="control-label">Audit Executive Summary</label>
		                <textarea class="form-control" name="audit_ex"></textarea>
	                </div>
                </div>
                <div class="col-md-4">
	                <div class="form-group">
	                    <label class="control-label">Addendum(s) included in the audit</label>
		                <textarea class="form-control" name="addendum"></textarea>
	                </div>
                </div>
                <div class="col-md-4">
	                <div class="form-group">
	                    <label class="control-label">Product(s) observed during audit</label>
		                <textarea class="form-control" name="product_observed"></textarea>
	                </div>
                </div>
                <div class="col-md-4">
	                <div class="form-group">
	                    <label class="control-label">Similar product(s)/process(es) not observed</label>
		                <textarea class="form-control" name="similar_product"></textarea>
	                </div>
                </div>
                <div class="col-md-4">
	                <div class="form-group">
	                    <label class="control-label">Product(s) applied for but not observed</label>
		                <textarea class="form-control" name="product_applied"></textarea>
	                </div>
                </div>
                <div class="col-md-4">
	                <div class="form-group">
	                    <label class="control-label">Auditor</label>
		                <textarea class="form-control" name="auditor"></textarea>
	                </div>
                </div>
                <div class="col-md-4">
	                <div class="form-group">
	                    <label class="control-label">Preliminary Audit Score</label>
		                <input type="text" class="form-control" name="preliminary_audit" readonly />
	                </div>
                </div>
                <div class="col-md-4">
	                <div class="form-group">
	                    <label class="control-label">Final Audit Score</label>
		                <input type="text" class="form-control" name="final_audit" readonly />
	                </div>
                </div>
                <div class="col-md-4">
	                <div class="form-group">
	                    <label class="control-label">Certificate Valid From</label>
		                <div class="input-group">
		                    <input type="text" class="form-control daterange" name="cert_valid" />
		                    <span class="input-group-btn">
		                        <button class="btn default date-range-toggle" type="button">
		                            <i class="fa fa-calendar"></i>
		                        </button>
		                    </span>
		                </div>
	                </div>
                </div>

                <div class="col-md-4">
	                <div class="form-group">
	                    <label class="control-label">Date Documentation Review Started</label>
		                <input type="datetime-local" class="form-control" name="date_review_started" />
	                </div>
                </div>
                <div class="col-md-4">
	                <div class="form-group">
	                    <label class="control-label">Date Documentation Review Finished</label>
		                <input type="datetime-local" class="form-control" name="date_review_finished" />
	                </div>
                </div>
                <div class="col-md-4">
	                <div class="form-group">
	                    <label class="control-label">Total Amount of Time on the Documentation Review</label>
		                <input type="text" class="form-control" name="total_time_review" />
	                </div>
                </div>

                <div class="col-md-4">
	                <div class="form-group">
	                    <label class="control-label">Date Visual Inspection Started</label>
		                <input type="datetime-local" class="form-control" name="date_inspection_started" />
	                </div>
                </div>
                <div class="col-md-4">
	                <div class="form-group">
	                    <label class="control-label">Date Visual Inspection Finished</label>
		                <input type="datetime-local" class="form-control" name="date_inspection_finished" />
	                </div>
                </div>
                <div class="col-md-4">
	                <div class="form-group">
	                    <label class="control-label">Total Amount of Time on Visual Inspection</label>
		                <input type="text" class="form-control" name="total_time_inspection" />
	                </div>
                </div>

                <div class="col-md-4">
	                <div class="form-group">
	                    <label class="control-label">Company Logo <i>(Leave blank if not applicable)</i></label>
		                <input type="file" class="form-control" name="file" accept="image/*" />
	                </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label class="control-label">Set Scoring</label>
                        <select class="form-control" name="score_type" onchange="changeType(this, this.value)">
                            <option value="0">Default</option>
                            <option value="1">Custom</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-12 score_data hide">
                    <p>Custom Score Field(s) <a href="javascript:;" class="btn btn-success" onclick="btnRepeaterScoreAdd()"><i class="fa fa-plus"></i></a></p>
                    <div class="scoreCustom"></div>
                </div>

                <div class="col-md-12">
                    <div class="form-group">
                        <label>Audit Scope</label>
                        <textarea class="summernote" id="summernote_audit_scope" name="audit_scope"></textarea>
                    </div>
                </div>
            </div>

            <p>Custom Field(s) <a href="javascript:;" class="btn btn-success" onclick="btnRepeaterFormAdd()"><i class="fa fa-plus"></i></a></p>
            <div class="formCustom"></div>

            <div class="box">
                <div id="gauge_'.$ID.'" class="gauge"></div>
            </div>

			<table class="table margin-top-20" id="tableForm_'.$ID.'">';

		        if (!empty($ia_sheet_id)) {
		        	$ia_sheet_id_arr = explode(' | ', $ia_sheet_id);
		        	foreach($ia_sheet_id_arr as $sheet_id) {

		        		$selectSheet = mysqli_query( $conn,"SELECT * FROM tbl_ia_sheet WHERE deleted = 0 AND ID = $sheet_id" );
		        		if ( mysqli_num_rows($selectSheet) > 0 ) {
		        			$rowSheet = mysqli_fetch_array($selectSheet);
							$sheet_name = $rowSheet['name'];
		        		}

		        		echo '<tr class="bg-warning">
							<td colspan="100%" class="text-center bold">'.$sheet_name.'</td>
						</tr>
		                <tr class="bg-default">';

							$selectFormat = mysqli_query( $conn,"SELECT * FROM tbl_ia_format WHERE deleted = 0 AND sheet_id = $sheet_id ORDER BY order_id" );
							if ( mysqli_num_rows($selectFormat) > 0 ) {
								while($rowFormat = mysqli_fetch_array($selectFormat)) {
							    	if ($rowFormat['type'] > 0) {
							    		if ($rowFormat['type'] == 1 OR $rowFormat['type'] == 3 OR $rowFormat['type'] == 4) {
							    			echo '<td class="bold">'.$rowFormat['label'].'</td>';
							    		} else if ($rowFormat['type'] == 2) {
											$radio_arr = explode(",", $rowFormat['label']);
											foreach ($radio_arr as $r) {
												echo '<td class="bold">'.$r.'</td>';
											}
											echo '<td class="bold hide">Result</td>';
							    		}
							    	}
								}
							}

						echo '</tr>';

						$selectDataRow = mysqli_query( $conn,"SELECT * FROM tbl_ia_data WHERE parent_id = 0 AND deleted = 0 AND LENGTH(data) > 0 AND sheet_id = $sheet_id ORDER BY order_id ASC, ID ASC" );
						if ( mysqli_num_rows($selectDataRow) > 0 ) {
							while($rowData = mysqli_fetch_array($selectDataRow)) {
								$data_ID = $rowData['ID'];

								$include_arr = array();
								if ($rowData['include'] != NULL) { $include_arr = explode(" | ", $rowData['include']); }

		                        $data_arr = json_decode($rowData['data'],true);

								echo '<tr id="tr_'.$data_ID.'">';

									$selectFormat = mysqli_query( $conn,"SELECT * FROM tbl_ia_format WHERE deleted = 0 AND sheet_id = $sheet_id ORDER BY order_id" );
		                			if ( mysqli_num_rows($selectFormat) > 0 ) {
		                				while($rowFormat = mysqli_fetch_array($selectFormat)) {
								            $formatID = $rowFormat['ID'];

								            $type = $rowFormat['type'];
											$type_arr = explode(" | ", $type);

								            $label = $rowFormat['label'];
											$label_arr = explode(" | ", $label);

											if ($type > 0) {
												if ($type == 1 OR $type == 3 OR $type == 4) {
													if (in_array($formatID, $include_arr)) {
														foreach($data_arr as $key => $value) {
															if ($formatID == $value['ID']) {
																if (!empty($value['content'])) {
																	echo '<td>'.$value['content'].'</td>';
																} else {
																	$rowColumnData = '';
																	if (!empty($form_data)) {
																		$form_data_arr = json_decode($form_data,true);

																		if (in_array($data_ID, array_column($form_data_arr, 'row'))) {
																			$rowColumnData = array_reduce($form_data_arr, function ($carry, $item) use ($data_ID, $formatID) {
																			    if ($item['row'] === $data_ID && $item['content']['column'] === $formatID) {
																			        return $item['content']['data'];
																			    }
																			    return $carry;
																			});
																		}
																	}
																	echo '<td>
																		<a href="javascript:;" onClick="btnEdit_summernote(this, '.$data_ID.', '.$formatID.')"><i class="fa fa-pencil"></i> [edit]</a>';

																		if (!empty($rowColumnData)) { echo '<div class="textarea_value">'.$rowColumnData.'</div>'; }

																		echo '<textarea class="hide" id="summernote_'.$data_ID.'_'.$formatID.'" name="columnData_'.$data_ID.'_'.$formatID.'">'.$rowColumnData.'</textarea>
																	</td>';
																}
															}
														}
													} else {
														echo '<td></td>';
													}
												} else if ($type == 2) {
													$radio_arr = explode(",", $label);

													if (in_array($formatID, $include_arr)) {
														$rowColumnData = '';
														if (!empty($form_data)) {
															$form_data_arr = json_decode($form_data,true);

															if (in_array($data_ID, array_column($form_data_arr, 'row'))) {
																$rowColumnData = array_reduce($form_data_arr, function ($carry, $item) use ($data_ID, $formatID) {
																    if ($item['row'] === $data_ID && $item['content']['column'] === $formatID) {
																        return $item['content']['data'];
																    }
																    return $carry;
																});
															}
														}

														foreach ($radio_arr as $r) {
															if ("n/a" === strtolower($r)) {
																echo '<td><input type="radio" value="'.$r.'" name="radio_'.$data_ID.'_'.$formatID.'" onclick="changeRadio(this.value, '.$data_ID.', '.$formatID.', '.$ID.')" checked/></td>';
																$rowColumnData = $r;
															} else {
																echo '<td><input type="radio" value="'.$r.'" name="radio_'.$data_ID.'_'.$formatID.'" onclick="changeRadio(this.value, '.$data_ID.', '.$formatID.', '.$ID.')" /></td>';
															}
														}
														echo '<td class="hide"><input type="hidden" class="radio_'.$data_ID.'_'.$formatID.'" name="columnData_'.$formatID.'[]" value="'.$rowColumnData.'" /></td>';
													} else {
														echo '<td colspan="'.count($radio_arr).'"></td>
														<td class="hide"></td>';
													}
												}
											}
										}
		                			}

								echo '</tr>';

								echo ai_childView($ID, $data_ID, $sheet_id, $type_arr, $label_arr, 1, 1, NULL);
							}
						}
		        	}
		        }

			echo '</table>';
		}
	}
	if( isset($_GET['modalEdit_Form']) ) {
		$ID = $_GET['modalEdit_Form'];

		if (!empty($_COOKIE['switchAccount'])) {
			$portal_user = $_COOKIE['ID'];
			$user_id = $_COOKIE['switchAccount'];
		}
		else {
			$portal_user = $_COOKIE['ID'];
			$user_id = employerID($portal_user);
		}

		$selectData = mysqli_query( $conn,"SELECT * FROM tbl_ia_form WHERE deleted = 0 AND ID = $ID" );
		if ( mysqli_num_rows($selectData) > 0 ) {
			$rowForm = mysqli_fetch_array($selectData);
			$form_organization = $rowForm['organization'];
			$form_audit_type = $rowForm['audit_type'];
			$form_inspected_by = $rowForm['inspected_by'];
			$form_auditee = $rowForm['auditee'];
			$form_verified_by = $rowForm['verified_by'];
			$form_date_start = $rowForm['date_start'];
			$form_date_end = $rowForm['date_end'];
			$form_audit_scope = $rowForm['audit_scope'];
			$form_file = $rowForm['file'];
			$form_data = $rowForm['data'];
			$form_label = $rowForm['label'];
			$form_description = $rowForm['description'];

            $form_score_type = $rowForm['score_type'];
            $form_score_data = array();
            if (!empty($rowForm['score_data'])) {
                $form_score_data = json_decode($rowForm['score_data'],true);
            }

			$form_ia_id = $rowForm['ia_id'];
			$selectFormIA = mysqli_query( $conn,"SELECT * FROM tbl_ia WHERE deleted = 0 AND ID = $form_ia_id" );
			if ( mysqli_num_rows($selectFormIA) > 0 ) {
				$rowFormIA = mysqli_fetch_array($selectFormIA);
				$form_ia_title = $rowFormIA['title'];
				$ia_sheet_id = $rowFormIA['sheet_id'];

				echo '<input class="form-control" type="hidden" name="ID" value = "'. $ID .'" />
				<h4 class="bold">'.stripcslashes($form_ia_title).'</h5>
				<div class="row">
	                <div class="col-md-4">
	                    <div class="form-group">
	                        <label>Organization</label>
	                        <input type="text" class="form-control" name="organization" value="'.$form_organization.'" />
	                    </div>
	                </div>
	                <div class="col-md-4">
	                    <div class="form-group">
	                        <label>Audit Type</label>
	                        <input type="text" class="form-control" name="audit_type" value="'.$form_audit_type.'" />
	                    </div>
	                </div>
	                <div class="col-md-4">
	                    <div class="form-group">
	                        <label>Inspected By</label>
	                        <input type="text" class="form-control" name="inspected_by" value="'.$form_inspected_by.'" />
	                    </div>
	                </div>
	                <div class="col-md-4">
	                    <div class="form-group">
	                        <label>Auditee</label>
	                        <input type="text" class="form-control" name="auditee" value="'.$form_auditee.'" />
	                    </div>
	                </div>
	                <div class="col-md-4">
	                    <div class="form-group">
	                        <label>Verified By</label>
	                        <input type="text" class="form-control" name="verified_by" value="'.$form_verified_by.'" />
	                    </div>
	                </div>
	                <div class="col-md-4">
		                <div class="form-group">
		                    <label class="control-label">Date</label>
			                <div class="input-group">
			                    <input type="text" class="form-control daterange" name="daterange" value="'.$form_date_start.' - '.$form_date_end.'" />
			                    <span class="input-group-btn">
			                        <button class="btn default date-range-toggle" type="button">
			                            <i class="fa fa-calendar"></i>
			                        </button>
			                    </span>
			                </div>
		                </div>
	                </div>

	                <div class="col-md-4">
		                <div class="form-group">
		                    <label class="control-label">Operation</label>
			                <textarea class="form-control" name="operation">'.$rowForm['operation'].'</textarea>
		                </div>
	                </div>
	                <div class="col-md-4">
		                <div class="form-group">
		                    <label class="control-label">Shipper</label>
			                <textarea class="form-control" name="shipper">'.$rowForm['shipper'].'</textarea>
		                </div>
	                </div>
	                <div class="col-md-4">
		                <div class="form-group">
		                    <label class="control-label">Operation Type</label>
			                <textarea class="form-control" name="operation_type">'.$rowForm['operation_type'].'</textarea>
		                </div>
	                </div>
	                <div class="col-md-4">
		                <div class="form-group">
		                    <label class="control-label">Audit Executive Summary</label>
			                <textarea class="form-control" name="audit_ex">'.$rowForm['audit_ex'].'</textarea>
		                </div>
	                </div>
	                <div class="col-md-4">
		                <div class="form-group">
		                    <label class="control-label">Addendum(s) included in the audit</label>
			                <textarea class="form-control" name="addendum">'.$rowForm['addendum'].'</textarea>
		                </div>
	                </div>
	                <div class="col-md-4">
		                <div class="form-group">
		                    <label class="control-label">Product(s) observed during audit</label>
			                <textarea class="form-control" name="product_observed">'.$rowForm['product_observed'].'</textarea>
		                </div>
	                </div>
	                <div class="col-md-4">
		                <div class="form-group">
		                    <label class="control-label">Similar product(s)/process(es) not observed</label>
			                <textarea class="form-control" name="similar_product">'.$rowForm['similar_product'].'</textarea>
		                </div>
	                </div>
	                <div class="col-md-4">
		                <div class="form-group">
		                    <label class="control-label">Product(s) applied for but not observed</label>
			                <textarea class="form-control" name="product_applied">'.$rowForm['product_applied'].'</textarea>
		                </div>
	                </div>
	                <div class="col-md-4">
		                <div class="form-group">
		                    <label class="control-label">Auditor</label>
			                <textarea class="form-control" name="auditor">'.$rowForm['auditor'].'</textarea>
		                </div>
	                </div>
	                <div class="col-md-4">
		                <div class="form-group">
		                    <label class="control-label">Preliminary Audit Score</label>
			                <input type="text" class="form-control" name="preliminary_audit" value="'.$rowForm['preliminary_audit'].'" readonly />
		                </div>
	                </div>
	                <div class="col-md-4">
		                <div class="form-group">
		                    <label class="control-label">Final Audit Score</label>
			                <input type="text" class="form-control" name="final_audit" value="'.$rowForm['final_audit'].'" readonly />
		                </div>
	                </div>
	                <div class="col-md-4">
		                <div class="form-group">
		                    <label class="control-label">Certificate Valid From</label>
			                <div class="input-group">
			                    <input type="text" class="form-control daterange" name="cert_valid" value="'.$rowForm['cert_valid'].'" />
			                    <span class="input-group-btn">
			                        <button class="btn default date-range-toggle" type="button">
			                            <i class="fa fa-calendar"></i>
			                        </button>
			                    </span>
			                </div>
		                </div>
	                </div>

	                <div class="col-md-4">
		                <div class="form-group">
		                    <label class="control-label">Date Documentation Review Started</label>
			                <input type="datetime-local" class="form-control" name="date_review_started" value="'.$rowForm['date_review_started'].'" />
		                </div>
	                </div>
	                <div class="col-md-4">
		                <div class="form-group">
		                    <label class="control-label">Date Documentation Review Finished</label>
			                <input type="datetime-local" class="form-control" name="date_review_finished" value="'.$rowForm['date_review_finished'].'" />
		                </div>
	                </div>
	                <div class="col-md-4">
		                <div class="form-group">
		                    <label class="control-label">Total Amount of Time on the Documentation Review</label>
			                <input type="text" class="form-control" name="total_time_review" value="'.$rowForm['total_time_review'].'" />
		                </div>
	                </div>

	                <div class="col-md-4">
		                <div class="form-group">
		                    <label class="control-label">Date Visual Inspection Started</label>
			                <input type="datetime-local" class="form-control" name="date_inspection_started" value="'.$rowForm['date_inspection_started'].'" />
		                </div>
	                </div>
	                <div class="col-md-4">
		                <div class="form-group">
		                    <label class="control-label">Date Visual Inspection Finished</label>
			                <input type="datetime-local" class="form-control" name="date_inspection_finished" value="'.$rowForm['date_inspection_finished'].'" />
		                </div>
	                </div>
	                <div class="col-md-4">
		                <div class="form-group">
		                    <label class="control-label">Total Amount of Time on Visual Inspection</label>
			                <input type="text" class="form-control" name="total_time_inspection" value="'.$rowForm['total_time_inspection'].'" />
		                </div>
	                </div>

	                <div class="col-md-4">
		                <div class="form-group">
		                    <label class="control-label">Company Logo <i>(Leave blank if not applicable)</i></label>';

			                if (!empty($form_file)) {
		                        echo '<input class="form-control '; echo !empty($form_file) ? 'hide':''; echo '" type="file" name="file" accept="image/*" />
			                    <p class="'; echo !empty($form_file) ? '':'hide'; echo '" style="margin: 0;"><a href="'.$form_file.'" data-src="'.$form_file.'" data-fancybox class="btn btn-link">View</a> | <button type="button" class="btn btn-link uploadNew" onclick="uploadNew(this)">Upload New</button></p>';
		                    } else {
		                    	echo '<input type="file" class="form-control" name="file" accept="image/*" />';
		                    }
		                    
		                	echo '<input type="hidden" name="file_temp" value="'.$form_file.'" />
		                </div>
	                </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label class="control-label">Set Scoring</label>
                            <select class="form-control" name="score_type" onchange="changeType(this, this.value)">
                                <option value="0" '; echo $form_score_type == 0 ? 'SELECTED':''; echo '>Default</option>
                                <option value="1" '; echo $form_score_type == 1 ? 'SELECTED':''; echo '>Custom</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-12 score_data '; echo $form_score_type == 1 ? '':'hide'; echo '">
                        <p>Custom Score Field(s) <a href="javascript:;" class="btn btn-success" onclick="btnRepeaterScoreAdd()"><i class="fa fa-plus"></i></a></p>
                        <div class="scoreCustom">';
                            if (count($form_score_data) >  0) {
                                $array_data = array();
                                foreach ($form_score_data as $key => $value) {
                                    $output = array(
                                        'score_label' => $value['score_label'],
                                        'score_rate' => $value['score_rate'],
                                        'score_color' => $value['score_color'],
                                    );
                                    array_push($array_data, $output);

                                    echo '<div class="row">
                                        <div class="col-md-4">
                                            <div class="form-group">
                                                <input type="text" class="form-control" name="score_label[]" placeholder="Label" value="'.$value['score_label'].'" required />
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-group">
                                                <div class="input-group">
                                                    <input type="text" class="form-control" name="score_rate[]" placeholder="Score Rate" value="'.$value['score_rate'].'" required />
                                                    <span class="input-group-addon" style="padding: 0;">
                                                        <input type="color" name="score_color[]" style="border: 0;" value="'.$value['score_color'].'" required />
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4 text-right">
                                            <div class="form-group">
                                                <a href="javascript:;" class="btn btn-danger" onclick="btnRepeaterScoreRemove(this)"><i class="fa fa-close"></i></a>
                                            </div>
                                        </div>
                                    </div>';
                                }


                                echo '<textarea class="form-control hide" id="range_'.$ID.'">';
                                    $ranges = [];

                                    // sort data result
                                    usort($array_data, function($a, $b) {
                                        return $a['score_rate'] - $b['score_rate'];
                                    });

                                    // convert into json
                                    for ($i=0; $i < count($array_data); $i++) { 
                                        $lo = $i == 0 ? 0 : $array_data[$i - 1]['score_rate'] + 1;
                                        $hi = $array_data[$i]['score_rate'];
                                        $color = $array_data[$i]['score_color'];
                                        $label = $array_data[$i]['score_label'];

                                        $ranges[] = [
                                            'label' => $label,
                                            'color' => $color,
                                            'lo' => $lo,
                                            'hi' => $hi
                                        ];
                                    }

                                    // echo (json_encode($array_data));
                                    echo (json_encode($ranges));
                                echo '</textarea><textarea class="form-control hide" id="label_'.$ID.'">';
                                    foreach ($ranges as $item) {
                                        echo 'if (val >= '.$item['lo'].' && val <= '.$item['hi'].') {
                                            return "'.$item['label'].'";
                                        }';
                                    }
                                echo '</textarea>';
                            }
                        echo '</div>
                    </div>

	                <div class="col-md-12">
	                    <div class="form-group">
	                        <label>Audit Scope</label>
	                        <textarea class="summernote" id="summernote_audit_scope2" name="audit_scope">'.$form_audit_scope .'</textarea>
	                    </div>
	                </div>
	            </div>

	            <p>Custom Field(s) <a href="javascript:;" class="btn btn-success" onclick="btnRepeaterFormAdd()"><i class="fa fa-plus"></i></a></p>
	            <div class="formCustom">';

	            	if (!empty($form_label)) {
			        	$form_label_arr = explode(' | ', $form_label);
			        	$form_description_arr = explode(' | ', $form_description);
			        	foreach($form_label_arr as $key => $value) {
			        		echo '<div class="row">
			        			<div class="col-md-4">
			        				<div class="form-group">
			        					<input type="text" class="form-control" name="label[]" placeholder="Label" value="'.$value.'" required="" />
			        				</div>
			        			</div>
			        			<div class="col-md-6">
			        				<div class="form-group">
			        					<input type="text" class="form-control" name="description[]" placeholder="Description" value="'.$form_description_arr[$key].'" required="" />
			        				</div>
			        			</div>
			        			<div class="col-md-2 text-right">
			        				<div class="form-group">
			        					<a href="javascript:;" class="btn btn-danger" onclick="btnRepeaterFormRemove(this)"><i class="fa fa-close"></i></a>
			        				</div>
			        			</div>
			        		</div>';
			        	}
	            	}

	            echo '</div>

                <div class="box">
                    <div id="gauge_'.$ID.'" class="gauge"></div>
                </div>

				<table class="table margin-top-20" id="tableForm_'.$ID.'">';

			        if (!empty($ia_sheet_id)) {
			        	$ia_sheet_id_arr = explode(' | ', $ia_sheet_id);
			        	foreach($ia_sheet_id_arr as $sheet_id) {

			        		$selectSheet = mysqli_query( $conn,"SELECT * FROM tbl_ia_sheet WHERE deleted = 0 AND ID = $sheet_id" );
			        		if ( mysqli_num_rows($selectSheet) > 0 ) {
			        			$rowSheet = mysqli_fetch_array($selectSheet);
								$sheet_name = $rowSheet['name'];
			        		}

			        		echo '<tr class="bg-warning">
								<td colspan="100%" class="text-center bold">'.$sheet_name.'</td>
							</tr>
			                <tr class="bg-default">';

								$selectFormat = mysqli_query( $conn,"SELECT * FROM tbl_ia_format WHERE deleted = 0 AND sheet_id = $sheet_id ORDER BY order_id" );
								if ( mysqli_num_rows($selectFormat) > 0 ) {
									while($rowFormat = mysqli_fetch_array($selectFormat)) {
								    	if ($rowFormat['type'] > 0) {
								    		if ($rowFormat['type'] == 1 OR $rowFormat['type'] == 3 OR $rowFormat['type'] == 4) {
								    			echo '<td class="bold">'.$rowFormat['label'].'</td>';
								    		} else if ($rowFormat['type'] == 2) {
												$radio_arr = explode(",", $rowFormat['label']);
												foreach ($radio_arr as $r) {
													echo '<td class="bold">'.$r.'</td>';
												}
												echo '<td class="bold hide">Result</td>';
								    		}
								    	}
									}
								}

							echo '</tr>';

							$selectDataRow = mysqli_query( $conn,"SELECT * FROM tbl_ia_data WHERE parent_id = 0 AND deleted = 0 AND LENGTH(data) > 0 AND sheet_id = $sheet_id ORDER BY order_id ASC, ID ASC" );
							if ( mysqli_num_rows($selectDataRow) > 0 ) {
								while($rowData = mysqli_fetch_array($selectDataRow)) {
									$data_ID = $rowData['ID'];

									$include_arr = array();
									if ($rowData['include'] != NULL) { $include_arr = explode(" | ", $rowData['include']); }

			                        $data_arr = json_decode($rowData['data'],true);

									echo '<tr id="tr_'.$data_ID.'">';

										$selectFormat = mysqli_query( $conn,"SELECT * FROM tbl_ia_format WHERE deleted = 0 AND sheet_id = $sheet_id ORDER BY order_id" );
			                			if ( mysqli_num_rows($selectFormat) > 0 ) {
			                				while($rowFormat = mysqli_fetch_array($selectFormat)) {
									            $formatID = $rowFormat['ID'];

									            $type = $rowFormat['type'];
												$type_arr = explode(" | ", $type);

									            $label = $rowFormat['label'];
												$label_arr = explode(" | ", $label);

												if ($type > 0) {
													if ($type == 1 OR $type == 3 OR $type == 4) {
														if (in_array($formatID, $include_arr)) {
															foreach($data_arr as $key => $value) {
																if ($formatID == $value['ID']) {
																	if (!empty($value['content'])) {
																		echo '<td>'.$value['content'].'</td>';
																	} else {
																		$rowColumnData = '';
																		if (!empty($form_data)) {
																			$form_data_arr = json_decode($form_data,true);

																			if (in_array($data_ID, array_column($form_data_arr, 'row'))) {
																				$rowColumnData = array_reduce($form_data_arr, function ($carry, $item) use ($data_ID, $formatID) {
																				    if ($item['row'] === $data_ID && $item['content']['column'] === $formatID) {
																				        return $item['content']['data'];
																				    }
																				    return $carry;
																				});
																			}
																		}

																		echo '<td>
																			<a href="javascript:;" onClick="btnEdit_summernote(this, '.$data_ID.', '.$formatID.')"><i class="fa fa-pencil"></i> [edit]</a>';

																			if (!empty($rowColumnData)) { echo '<div class="textarea_value">'.$rowColumnData.'</div>'; }

																			echo '<textarea class="hide" id="summernote_'.$data_ID.'_'.$formatID.'" name="columnData_'.$data_ID.'_'.$formatID.'">'.$rowColumnData.'</textarea>
																		</td>';
																	}
																}
															}
														} else {
															echo '<td></td>';
														}
													} else if ($type == 2) {
														$radio_arr = explode(",", $label);

														if (in_array($formatID, $include_arr)) {
															$rowColumnData = '';
															if (!empty($form_data)) {
																$form_data_arr = json_decode($form_data,true);

																if (in_array($data_ID, array_column($form_data_arr, 'row'))) {
																	$rowColumnData = array_reduce($form_data_arr, function ($carry, $item) use ($data_ID, $formatID) {
																	    if ($item['row'] === $data_ID && $item['content']['column'] === $formatID) {
																	        return $item['content']['data'];
																	    }
																	    return $carry;
																	});
																}
															}

															foreach ($radio_arr as $r) {
																if ($rowColumnData === $r) {
																	echo '<td><input type="radio" value="'.$r.'" name="radio_'.$data_ID.'_'.$formatID.'" onclick="changeRadio(this.value, '.$data_ID.', '.$formatID.', '.$ID.')" checked /></td>';
																} else {
																	echo '<td><input type="radio" value="'.$r.'" name="radio_'.$data_ID.'_'.$formatID.'" onclick="changeRadio(this.value, '.$data_ID.', '.$formatID.', '.$ID.')" /></td>';
																}
															}
															echo '<td class="hide"><input type="hidden" class="radio_'.$data_ID.'_'.$formatID.'" name="columnData_'.$formatID.'[]" value="'.$rowColumnData.'" /></td>';
														} else {
															echo '<td colspan="'.count($radio_arr).'"></td>
															<td class="hide"></td>';
														}
													}
												}
											}
			                			}

									echo '</tr>';

									echo ai_childView($ID, $data_ID, $sheet_id, $type_arr, $label_arr, 1, 0, $form_data);
								}
							}
			        	}
			        }

				echo '</table>';
			}
		}
	}
    if( isset($_GET['modalImport']) ) {
        $ID = $_GET['modalImport'];
        $timestamp_id = $_GET['t'];

        echo '<input type="hidden" name="sheet_id" value="'.$ID.'" />
        <input type="hidden" name="timestamp_id" value="'.$timestamp_id.'" />
        <input type="file" class="form-control" name="file" accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel" required />';
    }
	if( isset($_GET['btnDelete_Sheet']) ) {
		$ID = $_GET['btnDelete_Sheet'];

		mysqli_query( $conn,"UPDATE tbl_ia_sheet set deleted = 1 WHERE ID = $ID" );
	}
	if( isset($_GET['btnDelete_Format']) ) {
		$ID = $_GET['btnDelete_Format'];

		mysqli_query( $conn,"UPDATE tbl_ia_format set deleted = 1 WHERE ID = $ID" );
	}
	if( isset($_GET['btnDelete_Row']) ) {
		$ID = $_GET['btnDelete_Row'];

		mysqli_query( $conn,"UPDATE tbl_ia_data set deleted = 1 WHERE ID = $ID" );
	}
	if( isset($_GET['btnDelete_IA']) ) {
		$ID = $_GET['btnDelete_IA'];

		mysqli_query( $conn,"UPDATE tbl_ia set deleted = 1 WHERE ID = $ID" );

        if (!empty($_COOKIE['switchAccount'])) {
            $portal_user = $_COOKIE['ID'];
            $user_id = $_COOKIE['switchAccount'];
        }
        else {
            $portal_user = $_COOKIE['ID'];
            $user_id = employerID($portal_user);
        }
        $last_modified = date('Y-m-d');
        $sql_history = "INSERT INTO tbl_ia_history (user_id, portal_user, action, page, activity, last_modified)
        VALUES ('$user_id', '$portal_user', '3', '1', '$ID', '$last_modified')";
        mysqli_query($conn, $sql_history);
	}
	if( isset($_GET['btnDelete_Form']) ) {
		$ID = $_GET['btnDelete_Form'];

		mysqli_query( $conn,"UPDATE tbl_ia_form set deleted = 1 WHERE ID = $ID" );

        if (!empty($_COOKIE['switchAccount'])) {
            $portal_user = $_COOKIE['ID'];
            $user_id = $_COOKIE['switchAccount'];
        }
        else {
            $portal_user = $_COOKIE['ID'];
            $user_id = employerID($portal_user);
        }
        $last_modified = date('Y-m-d');
        $sql_history = "INSERT INTO tbl_ia_history (user_id, portal_user, action, page, activity, last_modified)
        VALUES ('$user_id', '$portal_user', '3', '2', '$ID', '$last_modified')";
        mysqli_query($conn, $sql_history);
	}
	if( isset($_GET['btnClose_Form']) ) {
		$ID = $_GET['btnClose_Form'];

		mysqli_query( $conn,"UPDATE tbl_ia_form set status = 0 WHERE ID = $ID" );

        if (!empty($_COOKIE['switchAccount'])) {
            $portal_user = $_COOKIE['ID'];
            $user_id = $_COOKIE['switchAccount'];
        }
        else {
            $portal_user = $_COOKIE['ID'];
            $user_id = employerID($portal_user);
        }
        $last_modified = date('Y-m-d');
        $sql_history = "INSERT INTO tbl_ia_history (user_id, portal_user, action, page, activity, last_modified)
        VALUES ('$user_id', '$portal_user', '4', '2', '$ID', '$last_modified')";
        mysqli_query($conn, $sql_history);
	}
	if( isset($_POST['btnSave_Sheet']) ) {
        if (!empty($_COOKIE['switchAccount'])) {
            $portal_user = $_COOKIE['ID'];
            $user_id = $_COOKIE['switchAccount'];
        }
        else {
            $portal_user = $_COOKIE['ID'];
            $user_id = employerID($portal_user);
        }

        $modal = $_POST['modal'];
        $timestamp_id = $_POST['timestamp_id'];
        $name = addslashes($_POST['name']);

        $sql = "INSERT INTO tbl_ia_sheet (user_id, portal_user, timestamp_id, name)
        VALUES ('$user_id', '$portal_user', '$timestamp_id', '$name')";
        if (mysqli_query($conn, $sql)) {
            $last_id = mysqli_insert_id($conn);

            $type = "";
            if (!empty($_POST['type'])) { 
                $type = $_POST['type'];
                $type = implode(' | ', $type);
            }

            $label = "";
            if (!empty($_POST['label'])) { 
                $label = $_POST['label'];
                $label = implode(' | ', $label);
            }

            $formatID = "";
            if (!empty($_POST['formatID'])) { 
                $formatID = $_POST['formatID'];
                $formatID = implode(' | ', $formatID);
            }

            $data = '';
            if (!empty($label)) {
                $type_arr = explode(" | ", $type);
                $label_arr = explode(" | ", $label);
                $formatID = explode(' | ', $formatID);

                $i = 0;
                foreach ($type_arr as $value) {
                    if ($value > 0) {
                        $selectFormat = mysqli_query( $conn,"SELECT * FROM tbl_ia_format WHERE deleted = 0 AND timestamp_id = $timestamp_id AND ID = $formatID[$i]" );
                        if ( mysqli_num_rows($selectFormat) > 0 ) {
                            mysqli_query( $conn,"UPDATE tbl_ia_format set order_id=$i, label='".$label_arr[$i]."' WHERE ID = $formatID[$i]" );
                        } else {
                            $sql_format = "INSERT INTO tbl_ia_format (order_id, timestamp_id, type, label)
                            VALUES ('$i', '$timestamp_id', '$value', '$label_arr[$i]')";
                            mysqli_query($conn, $sql_format);
                        }
                        $i++;
                    }
                }

                $data_export_header = '';
                $data_export_sub = '';
                $data_export_row = '';

                $data_thead = '<tr class="bg-default">
                    <th class="text-center" style="width: 135px;">Action</th>';
                    $i = 0;
                    foreach ($type_arr as $value) {
                        if ($value > 0) {

                            $data_export_sub .= '<th>Included? (Y/N)</th>';
                            if ($value == 1 OR $value == 3 OR $value == 4) {
                                $data_thead .= '<th>'.$label_arr[$i].'</th>';

                                $data_export_header .= '<th colspan="2">'.$label_arr[$i].'</th>';
                                $data_export_sub .= '<th>Content</th>';
                                $data_export_row .= '<td>Y</td>';
                                $data_export_row .= '<td>Sample Text</td>';
                            } else if ($value == 2) {
                                $radio_arr = explode(",", $label_arr[$i]);
                                foreach ($radio_arr as $r) {
                                    $data_thead .= '<th>'.$r.'</th>';
                                }

                                $data_export_header .= '<th>Radio Button: '.$label_arr[$i].'</th>';
                                $data_export_row .= '<td>Y</td>';
                            }
                            $i++;
                        }
                    }
                $data_thead .= '</tr>';

                $data_export = '<tr class="bg-default">'.$data_export_header.'</tr>
                <tr>'.$data_export_sub.'</tr>
                <tr>'.$data_export_row.'</tr>';

                $data_thead = '<tr class="bg-default">
                    <th class="text-center" style="width: 135px;">Action</th>';
                    $i = 0;
                    foreach ($type_arr as $value) {
                        if ($value > 0) {
                            if ($value == 1 OR $value == 3 OR $value == 4) {
                                $data_thead .= '<th>'.$label_arr[$i].'</th>';
                            } else if ($value == 2) {
                                $radio_arr = explode(",", $label_arr[$i]);
                                foreach ($radio_arr as $r) {
                                    $data_thead .= '<th>'.$r.'</th>';
                                }
                            }
                            $i++;
                        }
                    }
                $data_thead .= '</tr>';

                $data .= '<div class="tab-pane active" id="tabSheet_'.$last_id.'">
                    <table class="table table-bordered hide" id="tableTemplate_'.$last_id.'">
                        <tbody>'.$data_export.'</tbody>
                    </table>
                    <table class="table table-bordered">
                        <thead>'.$data_thead.'</thead>
                        <tbody></tbody>
                    </table>
                    <a href="#modalNewRow" data-toggle="modal" class="btn btn-success m-0" onclick="btnNewRow('.$last_id.', 0, '.$modal.', '.$timestamp_id.')"><i class="fa fa-plus"> Add Row</i></a>
                    <a href="javascript:;" class="btn btn-info m-0" onclick="btnTemplate('.$last_id.')"><i class="fa fa-download"> Download Template</i></a>
                    <a href="#modalImport" data-toggle="modal" class="btn btn-default m-0" onclick="btnImport('.$last_id.', '.$timestamp_id.')"><i class="fa fa-upload"> Import</i></a>
                </div>';
            }

            $output = array(
                "ID" => $last_id,
                "modal" => $modal,
                "timestamp_id" => $timestamp_id,
                "name" => stripcslashes($name),
                "data" => $data,
                "data_thead" => $data_thead,
                "data_export" => $data_export
            );
            echo json_encode($output);
        }
        mysqli_close($conn);
    }
	if( isset($_POST['btnUpdate_Sheet']) ) {
        if (!empty($_COOKIE['switchAccount'])) {
            $portal_user = $_COOKIE['ID'];
            $user_id = $_COOKIE['switchAccount'];
        }
        else {
            $portal_user = $_COOKIE['ID'];
            $user_id = employerID($portal_user);
        }

        $modal = $_POST['modal'];
        $timestamp_id = $_POST['timestamp_id'];
        $ID = $_POST['ID'];
        $name = addslashes($_POST['name']);

        mysqli_query( $conn,"UPDATE tbl_ia_sheet set portal_user='". $portal_user ."', name='". $name ."' WHERE ID='". $ID ."'" );
        if (!mysqli_error($conn)) {

            $type = "";
            if (!empty($_POST['type'])) { 
                $type = $_POST['type'];
                $type = implode(' | ', $type);
            }

            $label = "";
            if (!empty($_POST['label'])) { 
                $label = $_POST['label'];
                $label = implode(' | ', $label);
            }

            $formatID = "";
            if (!empty($_POST['formatID'])) { 
                $formatID = $_POST['formatID'];
                $formatID = implode(' | ', $formatID);
            }

            if (!empty($label)) {
                $type_arr = explode(" | ", $type);
                $label_arr = explode(" | ", $label);
                $formatID = explode(" | ", $formatID);

                $i = 0;
                foreach ($type_arr as $value) {
                    if ($value > 0) {
                        $selectFormat = mysqli_query( $conn,"SELECT * FROM tbl_ia_format WHERE deleted = 0 AND timestamp_id = $timestamp_id AND ID = $formatID[$i]" );
                        if ( mysqli_num_rows($selectFormat) > 0 ) {
                            mysqli_query( $conn,"UPDATE tbl_ia_format set order_id=$i, label='".$label_arr[$i]."' WHERE ID = $formatID[$i]" );
                        } else {
                            $sql_format = "INSERT INTO tbl_ia_format (order_id, timestamp_id, type, label)
                            VALUES ('$i', '$timestamp_id', '$value', '$label_arr[$i]')";
                            mysqli_query($conn, $sql_format);
                        }
                        $i++;
                    }
                }

                $data_export_header = '';
                $data_export_sub = '';
                $data_export_row = '';

                $data_thead = '<tr class="bg-default">
                    <th class="text-center" style="width: 135px;">Action</th>';
                    $i = 0;
                    foreach ($type_arr as $value) {
                        if ($value > 0) {

                            $data_export_sub .= '<th>Included? (Y/N)</th>';
                            if ($value == 1 OR $value == 3 OR $value == 4) {
                                $data_thead .= '<th>'.$label_arr[$i].'</th>';

                                $data_export_header .= '<th colspan="2">'.$label_arr[$i].'</th>';
                                $data_export_sub .= '<th>Content</th>';
                                $data_export_row .= '<td>Y</td>';
                                $data_export_row .= '<td>Sample Text</td>';
                            } else if ($value == 2) {
                                $radio_arr = explode(",", $label_arr[$i]);
                                foreach ($radio_arr as $r) {
                                    $data_thead .= '<th>'.$r.'</th>';
                                }

                                $data_export_header .= '<th>Radio Button: '.$label_arr[$i].'</th>';
                                $data_export_row .= '<td>Y</td>';
                            }
                            $i++;
                        }
                    }
                $data_thead .= '</tr>';

                $data_export = '<tr class="bg-default">'.$data_export_header.'</tr>
                <tr>'.$data_export_sub.'</tr>
                <tr>'.$data_export_row.'</tr>';

                $data = '<thead>'.$data_thead.'</thead>
                <tbody>';

                    $selectDataRow = mysqli_query( $conn,"SELECT * FROM tbl_ia_data WHERE parent_id = 0 AND deleted = 0 AND sheet_id = $ID ORDER BY order_id ASC, ID ASC" );
                    if ( mysqli_num_rows($selectDataRow) > 0 ) {
                        while($rowData = mysqli_fetch_array($selectDataRow)) {
                            $data_ID = $rowData['ID'];

                            $include_arr = array();
                            if ($rowData['include'] != NULL) { $include_arr = explode(" | ", $rowData['include']); }

                            $data_arr = json_decode($rowData['data'],true);

                            $data .= '<tr id="tr_'.$data_ID.'">
                                <td class="text-center">
                                    <a href="#modalEditRow" data-toggle="modal" class="btn btn-xs dark" onclick="btnEditRow('.$ID.', '.$data_ID.', '.$modal.', '.$timestamp_id.')"><i class="fa fa-pencil"></i></a>
                                    <a href="#modalNewRow" data-toggle="modal" class="btn btn-xs btn-success" onclick="btnNewRow('.$ID.', '.$data_ID.', '.$modal.', '.$timestamp_id.')"><i class="fa fa-plus"></i></a>
                                    <a href="javascript:;" class="btn btn-xs btn-danger m-0" onclick="btnDeleteRow(this, '.$data_ID.')"><i class="fa fa-close"></i></a>
                                </td>';

                                $selectFormat = mysqli_query( $conn,"SELECT * FROM tbl_ia_format WHERE deleted = 0 AND timestamp_id = $timestamp_id ORDER BY order_id" );
                                if ( mysqli_num_rows($selectFormat) > 0 ) {
                                    while($rowFormat = mysqli_fetch_array($selectFormat)) {
                                        $formatID = $rowFormat['ID'];

                                        $type = $rowFormat['type'];
                                        $type_arr = explode(" | ", $type);

                                        $label = $rowFormat['label'];
                                        $label_arr = explode(" | ", $label);

                                        if ($type > 0) {
                                            if ($type == 1 OR $type == 3 OR $type == 4) {
                                                if (in_array($formatID, $include_arr)) {
                                                    foreach($data_arr as $key => $value) {
                                                        if ($formatID == $value['ID']) {
                                                            $data .= '<td>'.$value['content'].'</td>';
                                                        }
                                                    }
                                                } else {
                                                    $data .= '<td></td>';
                                                }
                                            } else if ($type == 2) {
                                                $radio_arr = explode(",", $label);

                                                if (in_array($formatID, $include_arr)) {
                                                    foreach ($radio_arr as $r) {
                                                        $data .= '<td><input type="radio" class="m-0 radio_'.$data_ID.'_'.$formatID.'" value="'.$r.'" name="radio_'.$data_ID.'_'.$formatID.'" /></td>';
                                                    }
                                                } else {
                                                    $data .= '<td colspan="'.count($radio_arr).'"></td>';
                                                }
                                            }
                                        }
                                    }
                                }

                            $data .= '</tr>';

                            $data .= ai_child($data_ID, $ID, $type_arr, $label_arr, $modal, $timestamp_id);
                        }
                    }

                $data .= '</tbody>';
            }

            $output = array(
                "ID" => $ID,
                "modal" => $modal,
                "timestamp_id" => $timestamp_id,
                "name" => stripcslashes($name),
                "data" => $data,
                "data_thead" => $data_thead,
                "data_export" => $data_export
            );
            echo json_encode($output);
        }

        mysqli_close($conn);
    }
	if( isset($_POST['btnSave_Row']) ) {
        if (!empty($_COOKIE['switchAccount'])) {
            $portal_user = $_COOKIE['ID'];
            $user_id = $_COOKIE['switchAccount'];
        }
        else {
            $portal_user = $_COOKIE['ID'];
            $user_id = employerID($portal_user);
        }

        $sheet_id = $_POST['sheet_id'];
        $parent_id = $_POST['parent_id'];
        $modal = $_POST['modal'];
        $timestamp_id = $_POST['timestamp_id'];

        $rowData = implode(' | ', $_POST['rowData']);
        $data_arr = explode(" | ", $rowData);

        $data_result = array();
        $rowInclude = array();
        $include_arr = array();
        if (!empty($_POST['rowInclude'])) {
            $rowInclude = implode(' | ', $_POST['rowInclude']);
            $include_arr = explode(" | ", $rowInclude);

            $selectData = mysqli_query( $conn,"SELECT * FROM tbl_ia_format WHERE deleted = 0 AND timestamp_id = $timestamp_id ORDER BY order_id" );
            if ( mysqli_num_rows($selectData) > 0 ) {
                $x = 0;
                while($row = mysqli_fetch_array($selectData)) {
                    $formatID = $row['ID'];

                    if (in_array($formatID, $include_arr)) {
                        $data_output = array (
                            'ID' => $formatID,
                            'content' => addslashes($data_arr[$x])
                        );
                        array_push($data_result, $data_output);
                    }
                    $x++;
                }
            }
            $data_content = json_encode($data_result, JSON_HEX_APOS | JSON_UNESCAPED_UNICODE);

            $sql = "INSERT INTO tbl_ia_data (sheet_id, parent_id, include, data)
            VALUES ('$sheet_id', '$parent_id', '$rowInclude', '$data_content')";
            if (mysqli_query($conn, $sql)) {
                $last_id = mysqli_insert_id($conn);

                if ($parent_id == 0) { $data = '<tr id="tr_'.$last_id.'">'; }
                else { $data = '<tr class="child_'.$parent_id.'" id="tr_'.$last_id.'">'; }
                    $data .= '<td class="text-center">
                        <a href="#modalEditRow" data-toggle="modal" class="btn btn-xs dark" onclick="btnEditRow('.$sheet_id.', '.$last_id.', '.$modal.', '.$timestamp_id.')"><i class="fa fa-pencil"></i></a>
                        <a href="#modalNewRow" data-toggle="modal" class="btn btn-xs btn-success" onclick="btnNewRow('.$sheet_id.', '.$last_id.', '.$modal.', '.$timestamp_id.')"><i class="fa fa-plus"></i></a>
                        <a href="javascript:;" class="btn btn-xs btn-danger m-0" onclick="btnDeleteRow(this, '.$last_id.')"><i class="fa fa-close"></i></a>
                    </td>';

                    $selectData = mysqli_query( $conn,"SELECT * FROM tbl_ia_format WHERE deleted = 0 AND timestamp_id = $timestamp_id ORDER BY order_id" );
                    if ( mysqli_num_rows($selectData) > 0 ) {
                        while($row = mysqli_fetch_array($selectData)) {
                            $formatID = $row['ID'];

                            $type = $row['type'];
                            $type_arr = explode(" | ", $type);

                            $label = $row['label'];
                            $label_arr = explode(" | ", $label);

                            if ($type > 0) {
                                if ($type == 1 OR $type == 3 OR $type == 4) {
                                    if (in_array($formatID, $include_arr)) {
                                        foreach($data_result as $key => $value) {
                                            if ($formatID == $value['ID']) {
                                                $data .= '<td>'.$value['content'].'</td>';
                                            }
                                        }
                                    } else {
                                        $data .= '<td></td>';
                                    }
                                } else if ($type == 2) {
                                    $radio_arr = explode(",", $label);

                                    if (in_array($formatID, $include_arr)) {
                                        foreach ($radio_arr as $r) {
                                            $data .= '<td><input type="radio" class="m-0 radio_'.$last_id.'_'.$formatID.'" value="'.$r.'" name="radio_'.$last_id.'_'.$formatID.'" /></td>';
                                        }
                                    } else {
                                        $data .= '<td colspan="'.count($radio_arr).'"></td>';
                                    }
                                }
                            }
                        }
                    }

                $data .= '</tr>';

                $output = array(
                    "sheet_id" => $sheet_id,
                    "parent_id" => $parent_id,
                    "modal" => $modal,
                    "ID" => $last_id,
                    "data" => $data
                );
                echo json_encode($output);
            }
        }
        mysqli_close($conn);
    }
	if( isset($_POST['btnUpdate_Row']) ) {
        if (!empty($_COOKIE['switchAccount'])) {
            $portal_user = $_COOKIE['ID'];
            $user_id = $_COOKIE['switchAccount'];
        }
        else {
            $portal_user = $_COOKIE['ID'];
            $user_id = employerID($portal_user);
        }

        $sheet_id = $_POST['sheet_id'];
        $parent_id = $_POST['parent_id'];
        $modal = $_POST['modal'];
        $timestamp_id = $_POST['timestamp_id'];

        $rowData = implode(' | ', $_POST['rowData']);
        $data_arr = explode(" | ", $rowData);

        $rowInclude = implode(' | ', $_POST['rowInclude']);
        $include_arr = array();
        if ($rowInclude != NULL) { $include_arr = explode(" | ", $rowInclude); }

        $data_result = array();
        $selectData = mysqli_query( $conn,"SELECT * FROM tbl_ia_format WHERE deleted = 0 AND timestamp_id = $timestamp_id ORDER BY order_id" );
        if ( mysqli_num_rows($selectData) > 0 ) {
            $x = 0;
            while($row = mysqli_fetch_array($selectData)) {
                $formatID = $row['ID'];

                if (in_array($formatID, $include_arr)) {
                    $data_output = array (
                        'ID' => $formatID,
                        'content' => addslashes($data_arr[$x])
                    );
                    array_push($data_result, $data_output);
                }
                $x++;
            }
        }
        $data_content = json_encode($data_result, JSON_HEX_APOS | JSON_UNESCAPED_UNICODE);

        mysqli_query( $conn,"UPDATE tbl_ia_data set include='". $rowInclude ."', data='". $data_content ."' WHERE ID='". $parent_id ."'" );
        if (!mysqli_error($conn)) {
            $data = '<td class="text-center">
                <a href="#modalEditRow" data-toggle="modal" class="btn btn-xs dark" onclick="btnEditRow('.$sheet_id.', '.$parent_id.', '.$modal.', '.$timestamp_id.')"><i class="fa fa-pencil"></i></a>
                <a href="#modalNewRow" data-toggle="modal" class="btn btn-xs btn-success" onclick="btnNewRow('.$sheet_id.', '.$parent_id.', '.$modal.', '.$timestamp_id.')"><i class="fa fa-plus"></i></a>
                <a href="javascript:;" class="btn btn-xs btn-danger m-0" onclick="btnDeleteRow(this, '.$parent_id.')"><i class="fa fa-close"></i></a>
            </td>';

            $selectData = mysqli_query( $conn,"SELECT * FROM tbl_ia_format WHERE deleted = 0 AND timestamp_id = $timestamp_id ORDER BY order_id" );
            if ( mysqli_num_rows($selectData) > 0 ) {
                while($row = mysqli_fetch_array($selectData)) {
                    $formatID = $row['ID'];

                    $type = $row['type'];
                    $type_arr = explode(" | ", $type);

                    $label = $row['label'];
                    $label_arr = explode(" | ", $label);

                    if ($type > 0) {
                        if ($type == 1 OR $type == 3 OR $type == 4) {
                            if (in_array($formatID, $include_arr)) {
                                foreach($data_result as $key => $value) {
                                    if ($formatID == $value['ID']) {
                                        $data .= '<td>'.$value['content'].'</td>';
                                    }
                                }
                            } else {
                                $data .= '<td></td>';
                            }
                        } else if ($type == 2) {
                            $radio_arr = explode(",", $label);

                            if (in_array($formatID, $include_arr)) {
                                foreach ($radio_arr as $r) {
                                    $data .= '<td><input type="radio" class="m-0 radio_'.$parent_id.'_'.$formatID.'" value="'.$r.'" name="radio_'.$parent_id.'_'.$formatID.'" /></td>';
                                }
                            } else {
                                $data .= '<td colspan="'.count($radio_arr).'"></td>';
                            }
                        }
                    }
                }
            }

            $output = array(
                "sheet_id" => $sheet_id,
                "parent_id" => $parent_id,
                "modal" => $modal,
                "data" => $data
            );
            echo json_encode($output);
        }
        mysqli_close($conn);
    }
	if( isset($_POST['btnSave_IA']) ) {
		if (!empty($_COOKIE['switchAccount'])) {
			$portal_user = $_COOKIE['ID'];
			$user_id = $_COOKIE['switchAccount'];
		}
		else {
			$portal_user = $_COOKIE['ID'];
			$user_id = employerID($portal_user);
		}

        $timestamp_id = $_POST['timestamp_id'];
		$title = addslashes($_POST['title']);
		$description = addslashes($_POST['description']);
		$date = $_POST['date'];
        $last_modified = date('Y-m-d');

		$sheetID = '';
		if (!empty($_POST['sheetID'])) { $sheetID = implode(' | ', $_POST['sheetID']); }

		$sql = "INSERT INTO tbl_ia (user_id, portal_user, timestamp_id, title, description, sheet_id, last_modified)
		VALUES ('$user_id', '$portal_user', '$timestamp_id', '$title', '$description', '$sheetID', '$date')";
		if (mysqli_query($conn, $sql)) {
			$last_id = mysqli_insert_id($conn);

            $sql_history = "INSERT INTO tbl_ia_history (user_id, portal_user, action, page, activity, last_modified)
            VALUES ('$user_id', '$portal_user', '1', '1', '$last_id', '$last_modified')";
            mysqli_query($conn, $sql_history);

			$date = new DateTime($date);
			$date = $date->format('M d, Y');

			$data = '<tr id="tr_'.$last_id.'">
				<td>'.stripcslashes($title).'</td>
				<td>'.stripcslashes($description).'</td>
				<td>'.$date.'</td>
				<td class="text-center">';

                    if ($user_id == 1 OR $user_id == 163) {
                        $data .= '<a href="'.$base_url.'ia-form?t=3&i='.$last_id.'" class="btn btn-xs dark m-0" title="Edit" target="_blank"><i class="fa fa-pencil"></i></a>
                        <a href="'.$base_url.'ia-form?t=4&amp;i='.$last_id.'" class="btn btn-xs btn-success m-0" title="View" target="_blank"><i class="fa fa-search"></i></a>
                        <a href="javascript:;" class="btn btn-xs btn-danger m-0" onclick="btnDeleteIA(this, '.$last_id.')" title="Move to Archive"><i class="fa fa-archive"></i></a>
                        <a href="#modalClone" data-toggle="modal"" class="btn btn-xs btn-info m-0" onclick="btnCloneIA('.$last_id.')" title="Clone"><i class="fa fa-clone"></i></a>';
                    } else {
                        $data .= '<a href="'.$base_url.'ia-form?t=3&i='.$last_id.'" class="btn btn-xs dark m-0" title="Edit" target="_blank"><i class="fa fa-pencil"></i></a>
                        <a href="'.$base_url.'ia-form?t=4&amp;i='.$last_id.'" class="btn btn-xs btn-success m-0" title="View" target="_blank"><i class="fa fa-search"></i></a>
                        <a href="javascript:;" class="btn btn-xs btn-danger m-0" onclick="btnDeleteIA(this, '.$last_id.')" title="Move to Archive"><i class="fa fa-archive"></i></a>
                        <a href="'.$base_url.'ia-form?t=1&i='.$last_id.'" class="btn btn-xs btn-info m-0" title="Generate Form" target="_blank"><i class="fa fa-file-text-o"></i></a>';
                    }

			    $data .= '</td>
			</tr>';

			$output = array(
				"ID" => $last_id,
				"data" => $data
			);
			echo json_encode($output);
		}
		mysqli_close($conn);
	}
	if( isset($_POST['btnUpdate_IA']) ) {
		if (!empty($_COOKIE['switchAccount'])) {
			$portal_user = $_COOKIE['ID'];
			$user_id = $_COOKIE['switchAccount'];
		}
		else {
			$portal_user = $_COOKIE['ID'];
			$user_id = employerID($portal_user);
		}

		$ID = $_POST['ID'];
		$modal = $_POST['modal'];
		$title = addslashes($_POST['title']);
		$description = addslashes($_POST['description']);
		$date = $_POST['date'];
        $last_modified = date('Y-m-d');

		$sheetID = '';
		if (!empty($_POST['sheetID'])) { $sheetID = implode(' | ', $_POST['sheetID']); }


		mysqli_query( $conn,"UPDATE tbl_ia set title='". $title ."', description='". $description ."', sheet_id='". $sheetID ."' WHERE ID='". $ID ."'" );
		if (!mysqli_error($conn)) {

            $sql_history = "INSERT INTO tbl_ia_history (user_id, portal_user, action, page, activity, last_modified)
            VALUES ('$user_id', '$portal_user', '2', '1', '$ID', '$last_modified')";
            mysqli_query($conn, $sql_history);

			$date = new DateTime($date);
			$date = $date->format('M d, Y');

			$data = '<td>'.stripcslashes($title).'</td>
			<td>'.stripcslashes($description).'</td>
			<td>'.$date.'</td>
			<td class="text-center">';

		        if ($user_id == 1 OR $user_id == 163) {
                    $data .= '<a href="#modalEdit" data-toggle="modal" class="btn btn-xs dark m-0" onclick="btnEditIA('.$ID.', 2)" title="Edit"><i class="fa fa-pencil"></i></a>
                    <a href="'.$base_url.'ia-form?t=4&amp;i='.$ID.'" class="btn btn-xs btn-success m-0" title="View" target="_blank"><i class="fa fa-search"></i></a>
                    <a href="javascript:;" class="btn btn-xs btn-danger m-0" onclick="btnDeleteIA(this, '.$ID.')" title="Move to Archive"><i class="fa fa-archive"></i></a>
                    <a href="#modalClone" data-toggle="modal"" class="btn btn-xs btn-info m-0" onclick="btnCloneIA('.$ID.')" title="Clone"><i class="fa fa-clone"></i></a>';
                } else {
                    $data .= '<a href="#modalEdit" data-toggle="modal" class="btn btn-xs dark m-0" onclick="btnEditIA('.$ID.', 2)" title="Edit"><i class="fa fa-pencil"></i></a>
                    <a href="'.$base_url.'ia-form?t=4&amp;i='.$ID.'" class="btn btn-xs btn-success m-0" title="View" target="_blank"><i class="fa fa-search"></i></a>
                    <a href="javascript:;" class="btn btn-xs btn-danger m-0" onclick="btnDeleteIA(this, '.$ID.')" title="Move to Archive"><i class="fa fa-archive"></i></a>
                    <a href="#modalGenerate" data-toggle="modal" class="btn btn-xs btn-info m-0" onclick="btnGenerate('.$ID.')" title="Generate Form"><i class="fa fa-file-text-o"></i></a>';
                }

		    $data .= '</td>';

			$output = array(
				"ID" => $ID,
				"data" => $data
			);
			echo json_encode($output);
		}
		mysqli_close($conn);
	}
	if( isset($_POST['btnClone_IA']) ) {
        $ID = $_POST['ID'];
        $user = $_POST['user'];

        $selectData = mysqli_query( $conn,"SELECT
            i.timestamp_id AS i_timestamp_id,
            i.title AS i_title,
            i.description AS i_description,
            i.last_modified AS i_last_modified,
            i.sheet_id AS i_sheet_id
            FROM tbl_ia AS i

            LEFT JOIN (
                SELECT
                *
                FROM tbl_ia_sheet
                WHERE deleted = 0
                AND LENGTH(timestamp_id) > 0
            ) AS s
            ON FIND_IN_SET(s.ID, REPLACE(REPLACE(i.sheet_id, ' ', ''), '|',','  )  ) > 0

            WHERE i.deleted = 0 
            AND i.ID = $ID

            GROUP BY i.ID" );
        if ( mysqli_num_rows($selectData) > 0 ) {
            $rowIA = mysqli_fetch_array($selectData);
            $ia_sheet_id = $rowIA['i_sheet_id'];
            $i_timestamp_id = $rowIA['i_timestamp_id'];

            $timestamp_date = new DateTime(); //this returns the current date time
            $timestamp_id_new = $timestamp_date->format('YmdHisu');
            $last_modified = date('Y-m-d');

            // Select and Clone Format
            $format_output_arr = array();
            $format_type_arr = array();
            $format_ID_arr = array();
            $format_ID_new_arr = array();
            if (!empty($i_timestamp_id)) {
                $selectFormat = mysqli_query( $conn,"SELECT * FROM tbl_ia_format WHERE deleted = 0 AND timestamp_id = $i_timestamp_id");
                if ( mysqli_num_rows($selectFormat) > 0 ) {
                    while($rowFormat = mysqli_fetch_array($selectFormat)) {
                        $format_ID = $rowFormat['ID'];
                        $format_type = $rowFormat['type'];
                        $format_label = $rowFormat['label'];

                        $sql_format = "INSERT INTO tbl_ia_format (order_id, timestamp_id, type, label)
                        SELECT order_id, '$timestamp_id_new', type, label
                        FROM tbl_ia_format
                        WHERE deleted = 0 AND ID = $format_ID";
                        if (mysqli_query($conn, $sql_format)) {
                            $last_id_format = mysqli_insert_id($conn);

                            $output_format = array (
                                'old' => $format_ID,
                                'new' => $last_id_format,
                                'label' => $format_label
                            );
                            array_push($format_output_arr, $output_format);
                            array_push($format_type_arr, $format_type);
                            array_push($format_ID_arr, $format_ID);
                            array_push($format_ID_new_arr, $last_id_format);
                        }
                    }
                }

                $format_ID_new_arr_data = implode(' | ', $format_ID_new_arr);

                // Select and Clone Sheet
                if (!empty($ia_sheet_id)) {
                    $ia_sheet_id_arr = explode(" | ", $ia_sheet_id);

                    $sheet_output_arr = array();
                    $sheet_ID_arr = array();
                    $sheet_ID_new_arr = array();
                    $selectSheet = mysqli_query( $conn,"SELECT * FROM tbl_ia_sheet WHERE deleted = 0 AND timestamp_id = $i_timestamp_id");
                    if ( mysqli_num_rows($selectSheet) > 0 ) {
                        while($rowSheet = mysqli_fetch_array($selectSheet)) {
                            $sheet_ID = $rowSheet['ID'];

                            if (in_array($sheet_ID, $ia_sheet_id_arr)) {
                                $sql_format = "INSERT INTO tbl_ia_sheet (user_id, portal_user, timestamp_id, name)
                                SELECT '$user', '$user', '$timestamp_id_new', name
                                FROM tbl_ia_sheet
                                WHERE deleted = 0 AND ID = $sheet_ID";
                                if (mysqli_query($conn, $sql_format)) {
                                    $last_id_sheet = mysqli_insert_id($conn);

                                    $output_sheet = array (
                                        'old' => $sheet_ID,
                                        'new' => $last_id_sheet
                                    );
                                    array_push($sheet_output_arr, $output_sheet);
                                    array_push($sheet_ID_arr, $sheet_ID);
                                    array_push($sheet_ID_new_arr, $last_id_sheet);
                                }
                            }
                        }
                    }
                    $sheet_ID_new_arr_data = implode(' | ', $sheet_ID_new_arr);
                }

                // Select and Clone IA
                $sql_ia = "INSERT INTO tbl_ia (user_id, portal_user, timestamp_id, title, description, sheet_id, last_modified, is_generated)
                SELECT '$user', '$user', '$timestamp_id_new', title, description, '$sheet_ID_new_arr_data', '$last_modified', 0
                FROM tbl_ia
                WHERE ID = $ID";
                if (mysqli_query($conn, $sql_ia)) {
                    $last_id_ia = mysqli_insert_id($conn);
                }

                // Loop each sheet (old)
                $i = 0;
                $data_output_arr = array();
                $data_ID_arr = array();
                $data_ID_new_arr = array();
                foreach($sheet_ID_arr as $sheet_ID_val) {

                    // Select and Clone and Update Data
                    $selectData = mysqli_query( $conn,"SELECT * FROM tbl_ia_data WHERE deleted = 0 AND sheet_id = $sheet_ID_val");
                    if ( mysqli_num_rows($selectData) > 0 ) {
                        while($rowData = mysqli_fetch_array($selectData)) {
                            $data_ID = $rowData['ID'];

                            $sql_data = "INSERT INTO tbl_ia_data (order_id, sheet_id, parent_id, include, data)
                            SELECT order_id, '$sheet_ID_new_arr[$i]', parent_id, '$format_ID_new_arr_data', data
                            FROM tbl_ia_data
                            WHERE deleted = 0 AND ID = $data_ID";
                            if (mysqli_query($conn, $sql_data)) {
                                $last_id_data = mysqli_insert_id($conn);

                                $output_data = array (
                                    'old' => $data_ID,
                                    'new' => $last_id_data
                                );
                                array_push($data_output_arr, $output_data);
                                array_push($data_ID_arr, $data_ID);
                                array_push($data_ID_new_arr, $last_id_data);
                            }
                        }
                    }
                    $i++;
                }

                // Loop each sheet (new) 
                foreach($sheet_ID_new_arr as $sheet_ID_new_val) {

                    // Select and Reformat Data parent id and data
                    $selectData = mysqli_query( $conn,"SELECT * FROM tbl_ia_data WHERE deleted = 0 AND sheet_id = $sheet_ID_new_val");
                    if ( mysqli_num_rows($selectData) > 0 ) {
                        while($rowData = mysqli_fetch_array($selectData)) {
                            $data_ID = $rowData['ID'];
                            $data_data = $rowData['data'];

                            $data_parent_id_new = $rowData['parent_id'];
                            $data_key = array_search($rowData['parent_id'], array_column($data_output_arr, "old"));
                            if ($data_key !== false) {
                                $data_parent_id_new = $data_output_arr[$data_key]["new"];
                            }

                            // Loop each format (old)
                            $data_data_output = json_decode($data_data, true);
                            $data_data_new = array();
                            $f = 0;
                            foreach($format_ID_arr as $format_ID_val) {

                                $format_key = array_search($format_ID_val, array_column($data_data_output, "ID"));
                                if ($format_key !== false) {
                                    $data_output_new = array (
                                        'ID' => $format_ID_new_arr[$f],
                                        'content' => addslashes($data_data_output[$format_key]["content"])
                                    );
                                    array_push($data_data_new, $data_output_new);
                                }
                                $f++;
                            }
                            $data_data_new = json_encode($data_data_new, JSON_HEX_APOS | JSON_UNESCAPED_UNICODE);

                            mysqli_query( $conn,"UPDATE tbl_ia_data set parent_id = $data_parent_id_new, data = '".$data_data_new."' WHERE ID = $data_ID" );
                        }
                    }
                }

                echo 'Done';
            }
        }
    }
	if( isset($_POST['btnGenerate']) ) {
        if (!empty($_COOKIE['switchAccount'])) {
            $portal_user = $_COOKIE['ID'];
            $user_id = $_COOKIE['switchAccount'];
        }
        else {
            $portal_user = $_COOKIE['ID'];
            $user_id = employerID($portal_user);
        }

        $btnType = $_POST['btnType'];
        $ID = $_POST['ID'];
        $organization = addslashes($_POST['organization']);
        $audit_type = addslashes($_POST['audit_type']);
        $inspected_by = addslashes($_POST['inspected_by']);
        $auditee = addslashes($_POST['auditee']);
        $verified_by = addslashes($_POST['verified_by']);
        $audit_scope = addslashes($_POST['audit_scope']);

        $operation = addslashes($_POST['operation']);
        $shipper = addslashes($_POST['shipper']);
        $operation_type = addslashes($_POST['operation_type']);
        $audit_ex = addslashes($_POST['audit_ex']);
        $addendum = addslashes($_POST['addendum']);
        $product_observed = addslashes($_POST['product_observed']);
        $similar_product = addslashes($_POST['similar_product']);
        $product_applied = addslashes($_POST['product_applied']);
        $auditor = addslashes($_POST['auditor']);
        $cert_valid = addslashes($_POST['cert_valid']);

        $date_review_started = addslashes($_POST['date_review_started']);
        $date_review_finished = addslashes($_POST['date_review_finished']);
        $total_time_review = addslashes($_POST['total_time_review']);
        $date_inspection_started = addslashes($_POST['date_inspection_started']);
        $date_inspection_finished = addslashes($_POST['date_inspection_finished']);
        $total_time_inspection = addslashes($_POST['total_time_inspection']);

        $date = $_POST['daterange'];
        $date = explode(' - ', $date);
        $date_start = $date[0];
        $date_end = $date[1];

        $score_type = $_POST['score_type'];
        $score_data = "";
        if (!empty($_POST['score_label'])) {
            $arr_item = array();
            for ($i=0; $i < count($_POST['score_label']); $i++) {
                $score_label = addslashes($_POST['score_label'][$i]);
                $score_rate = addslashes($_POST['score_rate'][$i]);
                $score_color = addslashes($_POST['score_color'][$i]);
                $output = array (
                    'score_label'    =>  $score_label,
                    'score_rate'    =>  $score_rate,
                    'score_color'    =>  $score_color
                );
                array_push($arr_item, $output);
            }
            $score_data = json_encode($arr_item, JSON_HEX_APOS | JSON_UNESCAPED_UNICODE);
        } else {
            $score_type = 0;
        }

        $label = "";
        if (!empty($_POST['label'])) { 
            $label = $_POST['label'];
            $label = implode(' | ', $label);
        }

        $description = "";
        if (!empty($_POST['description'])) { 
            $description = $_POST['description'];
            $description = implode(' | ', $description);
        }

        $file = $_FILES['file']['name'];
        if (!empty($file)) {
            $base_tmp = $_FILES['file']['tmp_name'];
            $base_type = pathinfo($base_tmp, PATHINFO_EXTENSION);
            $base_data = file_get_contents($base_tmp);
            $file = 'data:image/png;base64,' . base64_encode($base_data);
        }

        $sql = "INSERT INTO tbl_ia_form (user_id, portal_user, ia_id, organization, audit_type, inspected_by, auditee, verified_by, date_start, date_end, audit_scope, file, score_type, score_data, label, description, operation, shipper, operation_type, audit_ex, addendum, product_observed, similar_product, product_applied, auditor, cert_valid, date_review_started, date_review_finished, total_time_review, date_inspection_started, date_inspection_finished, total_time_inspection)
        VALUES ('$user_id', '$portal_user', '$ID', '$organization', '$audit_type', '$inspected_by', '$auditee', '$verified_by', '$date_start', '$date_end', '$audit_scope', '$file', '$score_type', '$score_data', '$label', '$description', '$operation', '$shipper', '$operation_type', '$audit_ex', '$addendum', '$product_observed', '$similar_product', '$product_applied', '$auditor', '$cert_valid', '$date_review_started', '$date_review_finished', '$total_time_review', '$date_inspection_started', '$date_inspection_finished', '$total_time_inspection')";
        if (mysqli_query($conn, $sql)) {
            $last_id = mysqli_insert_id($conn);

            $date_start = new DateTime($date_start);
            $date_start = $date_start->format('M d, Y');

            $date_end = new DateTime($date_end);
            $date_end = $date_end->format('M d, Y');

            $last_modified = date('Y-m-d');
            $new_sheet_id = array();

            // CLone IA
            $sql_ia = "INSERT INTO tbl_ia (user_id, portal_user, title, description, sheet_id, last_modified, is_generated)
            SELECT user_id, $portal_user, title, description, sheet_id, '$last_modified', 1
            FROM tbl_ia
            WHERE ID = $ID";
            if (mysqli_query($conn, $sql_ia)) {
                $last_id_ia = mysqli_insert_id($conn);

                $selectIA = mysqli_query( $conn,"SELECT * FROM tbl_ia WHERE ID = $last_id_ia");
                if ( mysqli_num_rows($selectIA) > 0 ) {
                    $rowIA = mysqli_fetch_array($selectIA);
                    $ia_title = $rowIA['title'];
                    $ia_sheet_id = $rowIA['sheet_id'];

                    $data = '<tr id="tr_'.$last_id.'">
                        <td>'.stripcslashes($ia_title).'</td>
                        <td>'.stripcslashes($organization).'</td>
                        <td>'.stripcslashes($audit_type).'</td>
                        <td>'.stripcslashes($inspected_by).'</td>
                        <td>'.stripcslashes($auditee).'</td>
                        <td>'.stripcslashes($verified_by).'</td>
                        <td class="text-center">'.$date_start.'</td>
                        <td class="text-center">'.$date_end.'</td>
                        <td>'.$audit_scope.'</td>
                        <td class="text-center">
                            <a href="#modalEditForm" data-toggle="modal" class="btn btn-xs dark m-0" onclick="btnEditForm('.$last_id.')" title="Edit"><i class="fa fa-pencil"></i></a>
                            <a href="'.$base_url.'pdf_dom?id='.$last_id.'" class="btn btn-xs btn-success m-0" title="PDF" target="_blank"><i class="fa fa-file-pdf-o"></i></a>
                            <a href="javascript:;" class="btn btn-xs btn-danger m-0" onclick="btnDeleteForm(this, '.$last_id.')" title="Move to Archive"><i class="fa fa-archive"></i></a>
                            <a href="javascript:;" class="btn btn-xs btn-info m-0" onclick="btnCloseForm(this, '.$last_id.')" title="Close"><i class="fa fa-check"></i></a>
                        </td>
                    </tr>';

                    $output = array(
                        "ID" => $last_id,
                        "data" => $data
                    );

                    if (!empty($ia_sheet_id)) {
                        $data_result = array();
                        $temp_data = array();
                        $ia_sheet_id_arr = explode(' | ', $ia_sheet_id);
                        $columnResult = 0;
                        $columnYes = 0;
                        $columnNA = 0;
                        $columnCount = 0;
                        foreach($ia_sheet_id_arr as $value_sheet_id) {

                            // Clone Sheet
                            $sql_sheet = "INSERT INTO tbl_ia_sheet (user_id, portal_user, name)
                            SELECT user_id, $portal_user, name
                            FROM tbl_ia_sheet
                            WHERE deleted = 0 AND ID = $value_sheet_id";
                            if (mysqli_query($conn, $sql_sheet)) {
                                $last_id_sheet = mysqli_insert_id($conn);
                                array_push($new_sheet_id, $last_id_sheet);

                                // Select and Clone Data Parent
                                $selectData = mysqli_query( $conn,"SELECT * FROM tbl_ia_data WHERE parent_id = 0 AND deleted = 0 AND sheet_id = $value_sheet_id ORDER BY order_id ASC, ID ASC");
                                if ( mysqli_num_rows($selectData) > 0 ) {
                                    while($rowData = mysqli_fetch_array($selectData)) {
                                        $data_ID = $rowData['ID'];

                                        $sql_data = "INSERT INTO tbl_ia_data (order_id, sheet_id, parent_id, include, data)
                                        SELECT order_id, $last_id_sheet, parent_id, include, data
                                        FROM tbl_ia_data
                                        WHERE deleted = 0 AND ID = $data_ID";
                                        if (mysqli_query($conn, $sql_data)) {
                                            $last_id_data = mysqli_insert_id($conn);

                                            $data_Y = array (
                                                'old' => $data_ID,
                                                'new' => $last_id_data
                                            );
                                            array_push($temp_data, $data_Y);

                                            // Select and Clone Data Child
                                            $temp_data = cloneDataChild($value_sheet_id, $data_ID, $last_id_sheet, $last_id_data, $temp_data);
                                        }
                                    }
                                }

                                // Select and Clone Format
                                $selectFormat = mysqli_query( $conn,"SELECT * FROM tbl_ia_format WHERE deleted = 0 AND sheet_id = $value_sheet_id ORDER BY order_id");
                                if ( mysqli_num_rows($selectFormat) > 0 ) {
                                    while($rowFormat = mysqli_fetch_array($selectFormat)) {
                                        $format_ID = $rowFormat['ID'];

                                        // Clone Format
                                        $sql_format = "INSERT INTO tbl_ia_format (order_id, sheet_id, type, label)
                                        SELECT order_id, $last_id_sheet, type, label
                                        FROM tbl_ia_format
                                        WHERE deleted = 0 AND ID = $format_ID";
                                        if (mysqli_query($conn, $sql_format)) {
                                            $last_id_format = mysqli_insert_id($conn);

                                            $selectFormatData = mysqli_query( $conn,"SELECT * FROM tbl_ia_data WHERE deleted = 0 AND sheet_id = $last_id_sheet ORDER BY order_id ASC, ID ASC");
                                            if ( mysqli_num_rows($selectFormatData) > 0 ) {
                                                while($rowFormatData = mysqli_fetch_array($selectFormatData)) {
                                                    $formatdata_ID = $rowFormatData['ID'];

                                                    // Reformat Include
                                                    $new_include = array();
                                                    $formatdata_include_arr = explode(' | ', $rowFormatData['include']);
                                                    foreach($formatdata_include_arr as $value_include) {
                                                        if ($format_ID == $value_include) {
                                                            array_push($new_include, $last_id_format);
                                                        } else {
                                                            array_push($new_include, $value_include);
                                                        }
                                                    }
                                                    $new_include = implode(' | ', $new_include);
                                                    
                                                    // Reformat Data
                                                    $new_data = array();
                                                    $formatdata_data_arr = json_decode($rowFormatData['data'], true);
                                                    foreach($formatdata_data_arr as $key => $value_data) {
                                                        if ($format_ID == $value_data['ID']) {
                                                            $data_output = array (
                                                                'ID' => $last_id_format,
                                                                'content' => addslashes($value_data['content'])
                                                            );
                                                        } else {
                                                            $data_output = array (
                                                                'ID' => $value_data['ID'],
                                                                'content' => addslashes($value_data['content'])
                                                            );
                                                        }
                                                        array_push($new_data, $data_output);
                                                    }
                                                    $new_data = json_encode($new_data, JSON_HEX_APOS | JSON_UNESCAPED_UNICODE);

                                                    mysqli_query( $conn,"UPDATE tbl_ia_data set include = '". $new_include ."', data = '". $new_data ."' WHERE ID = '". $formatdata_ID ."'" );


                                                    // Gather Result
                                                    $oldValue = array_search($formatdata_ID, array_column($temp_data, 'new'));
                                                    if ($oldValue !== false) {
                                                        $oldValue = $temp_data[$oldValue]['old'];

                                                        if(!empty($_POST['radio_'.$oldValue.'_'.$format_ID])) {
                                                            $generate_data_column = array (
                                                                'column' => strval($last_id_format),
                                                                'data' => addslashes($_POST['radio_'.$oldValue.'_'.$format_ID])
                                                            );

                                                            $generate_data_output = array (
                                                                'row' => $formatdata_ID,
                                                                'content' => $generate_data_column
                                                            );
                                                            array_push($data_result, $generate_data_output);
                                                        } else if(!empty($_POST['columnData_'.$oldValue.'_'.$format_ID])) {
                                                            $generate_data_column = array (
                                                                'column' => strval($last_id_format),
                                                                'data' => addslashes($_POST['columnData_'.$oldValue.'_'.$format_ID])
                                                            );

                                                            $generate_data_output = array (
                                                                'row' => $formatdata_ID,
                                                                'content' => $generate_data_column
                                                            );
                                                            array_push($data_result, $generate_data_output);
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }

                            // Compute Each Radio Button per Sheet
                            $selectFormat2 = mysqli_query( $conn,"SELECT * FROM tbl_ia_format WHERE deleted = 0 AND type = 2 AND sheet_id = $value_sheet_id ORDER BY order_id" );
                            if ( mysqli_num_rows($selectFormat2) > 0 ) {
                                while($rowFormat2 = mysqli_fetch_array($selectFormat2)) {
                                    $formatID2 = $rowFormat2['ID'];

                                    if(!empty($_POST['columnData_'.$formatID2])) {
                                        $columnDatas = $_POST['columnData_'.$formatID2];
                                        $columnCount += count($columnDatas);

                                        if (in_array(strtolower('yes'), array_map('strtolower', $columnDatas))) {
                                            // if (in_array(strtolower('n/a'), array_map('strtolower', $columnDatas))) {
                                            //  $columnResult += array_count_values(array_map('strtolower', $columnDatas))['yes'] / (count($columnDatas) - array_count_values(array_map('strtolower', $columnDatas))['n/a']);
                                            // } else {
                                            //  $columnResult += array_count_values(array_map('strtolower', $columnDatas))['yes']  / count($columnDatas);
                                            // }

                                            if (in_array(strtolower('n/a'), array_map('strtolower', $columnDatas))) {
                                                $columnNA += array_count_values(array_map('strtolower', $columnDatas))['n/a'];
                                            }
                                            $columnYes += array_count_values(array_map('strtolower', $columnDatas))['yes'];
                                        }
                                    }
                                }
                            }
                        }
                        
                        if ($columnCount > $columnNA) { $columnResult = $columnYes / ($columnCount - $columnNA); }
                        $columnPercent = round($columnResult * 100);
                        if ($btnType == 'btnGenerate2') { $columnPercent = 0; }

                        $new_sheet_id = implode(' | ', $new_sheet_id);
                        // $new_temp_data = json_encode($temp_data, JSON_HEX_APOS | JSON_UNESCAPED_UNICODE);
                        // $de_temp_data = json_decode($temp_data, true);
                        $data_content = json_encode($data_result, JSON_HEX_APOS | JSON_UNESCAPED_UNICODE);
                        mysqli_query( $conn,"UPDATE tbl_ia set sheet_id = '". $new_sheet_id ."' WHERE ID = '". $last_id_ia ."'" );
                        mysqli_query( $conn,"UPDATE tbl_ia_form set ia_id = '". $last_id_ia ."', data = '".$data_content."', preliminary_audit = '".$columnPercent."' WHERE ID = '". $last_id ."'" );

                        if ($columnPercent == 100) { mysqli_query( $conn,"UPDATE tbl_ia_form set final_audit = '".$columnPercent."' WHERE ID = '". $last_id ."'" ); }
                    }
                }
            }
            echo json_encode($output);
        }
    }
	if( isset($_POST['btnEdit_Form']) ) {
		if (!empty($_COOKIE['switchAccount'])) {
			$portal_user = $_COOKIE['ID'];
			$user_id = $_COOKIE['switchAccount'];
		}
		else {
			$portal_user = $_COOKIE['ID'];
			$user_id = employerID($portal_user);
		}

		$btnType = $_POST['btnType'];
		$ID = $_POST['ID'];
		$organization = addslashes($_POST['organization']);
		$audit_type = addslashes($_POST['audit_type']);
		$inspected_by = addslashes($_POST['inspected_by']);
		$auditee = addslashes($_POST['auditee']);
		$verified_by = addslashes($_POST['verified_by']);
		$audit_scope = addslashes($_POST['audit_scope']);

		$operation = addslashes($_POST['operation']);
		$shipper = addslashes($_POST['shipper']);
		$operation_type = addslashes($_POST['operation_type']);
		$audit_ex = addslashes($_POST['audit_ex']);
		$addendum = addslashes($_POST['addendum']);
		$product_observed = addslashes($_POST['product_observed']);
		$similar_product = addslashes($_POST['similar_product']);
		$product_applied = addslashes($_POST['product_applied']);
		$auditor = addslashes($_POST['auditor']);
		$preliminary_audit = addslashes($_POST['preliminary_audit']);
		$final_audit = addslashes($_POST['final_audit']);
		$cert_valid = addslashes($_POST['cert_valid']);
		
		$date_review_started = addslashes($_POST['date_review_started']);
		$date_review_finished = addslashes($_POST['date_review_finished']);
		$total_time_review = addslashes($_POST['total_time_review']);
		$date_inspection_started = addslashes($_POST['date_inspection_started']);
		$date_inspection_finished = addslashes($_POST['date_inspection_finished']);
		$total_time_inspection = addslashes($_POST['total_time_inspection']);

		$date = $_POST['daterange'];
		$date = explode(' - ', $date);
		$date_start = $date[0];
		$date_end = $date[1];

		$label = "";
		if (!empty($_POST['label'])) { 
			$label = $_POST['label'];
			$label = implode(' | ', $label);
		}

		$description = "";
		if (!empty($_POST['description'])) { 
			$description = $_POST['description'];
			$description = implode(' | ', $description);
		}

		$file = $_FILES['file']['name'];
		if (!empty($file)) {
			$base_tmp = $_FILES['file']['tmp_name'];
			$base_type = pathinfo($base_tmp, PATHINFO_EXTENSION);
			$base_data = file_get_contents($base_tmp);
			$file = 'data:image/png;base64,' . base64_encode($base_data);
		} else {
			$file = $_POST['file_temp'];
		}

		mysqli_query( $conn,"UPDATE tbl_ia_form set portal_user = '". $portal_user ."', organization = '". $organization ."', audit_type = '". $audit_type ."', inspected_by = '". $inspected_by ."', auditee = '". $auditee ."', verified_by = '". $verified_by ."', audit_scope = '". $audit_scope ."', file = '". $file ."', label = '". $label ."', description = '". $description ."', operation = '". $operation ."', shipper = '". $shipper ."', operation_type = '". $operation_type ."', audit_ex = '". $audit_ex ."', addendum = '". $addendum ."', product_observed = '". $product_observed ."', similar_product = '". $similar_product ."', product_applied = '". $product_applied ."', auditor = '". $auditor ."', preliminary_audit = '". $preliminary_audit ."', final_audit = '". $final_audit ."', cert_valid = '". $cert_valid ."', date_review_started = '". $date_review_started ."', date_review_finished = '". $date_review_finished ."', total_time_review = '". $total_time_review ."', date_inspection_started = '". $date_inspection_started ."', date_inspection_finished = '". $date_inspection_finished ."', total_time_inspection = '". $total_time_inspection ."', date_start = '". $date_start ."', date_end = '". $date_end ."' WHERE ID = '". $ID ."'" );

		$selectForm = mysqli_query( $conn,"SELECT * FROM tbl_ia_form WHERE ID = $ID");
		if ( mysqli_num_rows($selectForm) > 0 ) {
			$rowForm = mysqli_fetch_array($selectForm);
			$form_ia_id = $rowForm['ia_id'];

			$selectIA = mysqli_query( $conn,"SELECT * FROM tbl_ia WHERE ID = $form_ia_id");
			if ( mysqli_num_rows($selectIA) > 0 ) {
				$rowIA = mysqli_fetch_array($selectIA);
				$ia_title = $rowIA['title'];
				$ia_sheet_id = $rowIA['sheet_id'];

		        $date_start = new DateTime($date_start);
		        $date_start = $date_start->format('M d, Y');

		        $date_end = new DateTime($date_end);
		        $date_end = $date_end->format('M d, Y');

		        $data = '<td>'.stripcslashes($ia_title).'</td>
		        <td>'.stripcslashes($organization).'</td>
		        <td>'.stripcslashes($audit_type).'</td>
		        <td>'.stripcslashes($inspected_by).'</td>
		        <td>'.stripcslashes($auditee).'</td>
		        <td>'.stripcslashes($verified_by).'</td>
		        <td class="text-center">'.$date_start.'</td>
		        <td class="text-center">'.$date_end.'</td>
		        <td>'.$audit_scope.'</td>
		        <td class="text-center">
		            <a href="#modalEditForm" data-toggle="modal" class="btn btn-xs dark m-0" onclick="btnEditForm('.$ID.')" title="Edit"><i class="fa fa-pencil"></i></a>
		            <a href="'.$base_url.'pdf_dom?id='.$ID.'" class="btn btn-xs btn-success m-0" title="PDF" target="_blank"><i class="fa fa-file-pdf-o"></i></a>
		            <a href="javascript:;" class="btn btn-xs btn-danger m-0" onclick="btnDeleteForm(this, '.$ID.')" title="Move to Archive"><i class="fa fa-archive"></i></a>
		            <a href="javascript:;" class="btn btn-xs btn-info m-0" onclick="btnCloseForm(this, '.$ID.')" title="Close"><i class="fa fa-check"></i></a>
		        </td>';

				$output = array(
					"ID" => $ID,
					"data" => $data
				);


				if (!empty($ia_sheet_id)) {
					$data_result = array();
		        	$ia_sheet_id_arr = explode(' | ', $ia_sheet_id);
		        	$columnResult = 0;
	        		$columnYes = 0;
	        		$columnNA = 0;
	        		$columnCount = 0;
		        	foreach($ia_sheet_id_arr as $sheet_id) {
						$selectDataRow = mysqli_query( $conn,"SELECT * FROM tbl_ia_data WHERE parent_id = 0 AND deleted = 0 AND LENGTH(data) > 0 AND sheet_id = $sheet_id ORDER BY order_id ASC, ID ASC" );
						if ( mysqli_num_rows($selectDataRow) > 0 ) {
							while($rowData = mysqli_fetch_array($selectDataRow)) {
								$data_ID = $rowData['ID'];

				        		$selectFormat = mysqli_query( $conn,"SELECT * FROM tbl_ia_format WHERE deleted = 0 AND sheet_id = $sheet_id ORDER BY order_id" );
		            			if ( mysqli_num_rows($selectFormat) > 0 ) {
		            				while($rowFormat = mysqli_fetch_array($selectFormat)) {
							            $formatID = $rowFormat['ID'];

							            if(!empty($_POST['radio_'.$data_ID.'_'.$formatID])) {
							            	$data_column = array (
												'column' => $formatID,
												'data' => addslashes($_POST['radio_'.$data_ID.'_'.$formatID])
											);

							            	$data_output = array (
												'row' => $data_ID,
												'content' => $data_column
											);
											array_push($data_result, $data_output);
							            } else if(!empty($_POST['columnData_'.$data_ID.'_'.$formatID])) {
							            	$data_column = array (
												'column' => $formatID,
												'data' => addslashes($_POST['columnData_'.$data_ID.'_'.$formatID])
											);

							            	$data_output = array (
												'row' => $data_ID,
												'content' => $data_column
											);
											array_push($data_result, $data_output);
							            }
							        }
							    }
								
								$data_result = form_childView($data_ID, $sheet_id, $data_result);
							}
						}

						// Compute Each Radio Button per Sheet
		        		$selectFormat2 = mysqli_query( $conn,"SELECT * FROM tbl_ia_format WHERE deleted = 0 AND type = 2 AND sheet_id = $sheet_id ORDER BY order_id" );
	        			if ( mysqli_num_rows($selectFormat2) > 0 ) {
	        				while($rowFormat2 = mysqli_fetch_array($selectFormat2)) {
					            $formatID2 = $rowFormat2['ID'];

					            if(!empty($_POST['columnData_'.$formatID2])) {
									$columnDatas = $_POST['columnData_'.$formatID2];
						        	$columnCount += count($columnDatas);

									if (in_array(strtolower('yes'), array_map('strtolower', $columnDatas))) {
										if (in_array(strtolower('n/a'), array_map('strtolower', $columnDatas))) {
											$columnNA += array_count_values(array_map('strtolower', $columnDatas))['n/a'];
										}
						        		$columnYes += array_count_values(array_map('strtolower', $columnDatas))['yes'];
									}
					            }
					        }
					    }
					}

					if ($columnCount > $columnNA) { $columnResult = $columnYes / ($columnCount - $columnNA); }
					$columnPercent = round($columnResult * 100);
					if ($btnType == 'btnEdit_Form2') {
						mysqli_query( $conn,"UPDATE tbl_ia_form set preliminary_audit = 0, final_audit = 0 WHERE ID = '". $ID ."'" );
					} else if ($btnType == 'btnEdit_Form3') {
						mysqli_query( $conn,"UPDATE tbl_ia_form set preliminary_audit = '". $columnPercent ."', final_audit = 0 WHERE ID = '". $ID ."'" );
					} else {
						mysqli_query( $conn,"UPDATE tbl_ia_form set final_audit = '". $columnPercent ."' WHERE ID = '". $ID ."'" );
					}

					$data_content = json_encode($data_result, JSON_HEX_APOS | JSON_UNESCAPED_UNICODE);
					mysqli_query( $conn,"UPDATE tbl_ia_form set data = '". $data_content ."' WHERE ID = '". $ID ."'" );
		        }
				echo json_encode($output);
			} else {
                $message = "Error: " . $sql . "<br>" . mysqli_error($conn);
                echo json_encode($message);
            }
		} else {
            $message = "Error: " . $sql . "<br>" . mysqli_error($conn);
            echo json_encode($message);
        }
	}
    if( isset($_POST['btnSave_Import']) ) {
        if (!empty($_COOKIE['switchAccount'])) {
            $portal_user = $_COOKIE['ID'];
            $user_id = $_COOKIE['switchAccount'];
        }
        else {
            $portal_user = $_COOKIE['ID'];
            $user_id = employerID($portal_user);
        }

        $data = '';
        $modal = 2;
        $timestamp_id = $_POST['timestamp_id'];
        $sheet_id = $_POST['sheet_id'];
        $files = $_FILES['file']['name'];
        if ($files) {
            $tmp = $_FILES['file']['tmp_name'];
            $file = fopen($tmp, "r");

            $csvFile = fopen($_FILES['file']['tmp_name'], 'r');
            fgetcsv($csvFile);
            fgetcsv($csvFile);

            // Get row data
            while(($line = fgetcsv($csvFile)) !== FALSE){
                $index = 0;
                $rowInclude = array();
                $data_result = array();

                $selectTemplate = mysqli_query( $conn,"SELECT * FROM tbl_ia_format WHERE deleted = 0 AND timestamp_id = $timestamp_id ORDER BY order_id" );
                if ( mysqli_num_rows($selectTemplate) > 0 ) {
                    while($rowTemplate = mysqli_fetch_array($selectTemplate)) {
                        $format_ID = $rowTemplate['ID'];
                        $format_type = $rowTemplate['type'];
                        $format_label = $rowTemplate['label'];

                        if ($format_type == 1 OR $format_type == 3 OR $format_type == 4) {
                            if (strtolower($line[$index]) == 'y') {
                                array_push($rowInclude, $format_ID);
                                $index++;

                                $data_output = array (
                                    'ID' => $format_ID,
                                    'content' => addslashes(str_replace(array("\r\n", "\r", "\n"), '<br>', mb_convert_encoding($line[$index], 'UTF-8', 'ISO-8859-1') ) )
                                );
                                array_push($data_result, $data_output);
                                $index++;
                            } else {
                                $index = $index + 2;
                            }
                        } else if ($format_type == 2) {
                            if (strtolower($line[$index]) == 'y') {
                                array_push($rowInclude, $format_ID);
                            }

                            $index++;
                        }
                    }
                }
                $data_content = json_encode($data_result, JSON_HEX_APOS | JSON_UNESCAPED_UNICODE);
                // $data_content = json_encode($data_result, JSON_HEX_TAG | JSON_HEX_APOS | JSON_HEX_QUOT | JSON_HEX_AMP | JSON_UNESCAPED_UNICODE);
                $rowInclude = implode(' | ', $rowInclude);

                $sql = "INSERT INTO tbl_ia_data (sheet_id, parent_id, include, data)
                VALUES ('$sheet_id', '0', '$rowInclude', '$data_content')";
                mysqli_query($conn, $sql);
            }
            fclose($csvFile);
            // echo $csvFile;

            $selectDataRow = mysqli_query( $conn,"SELECT * FROM tbl_ia_data WHERE parent_id = 0 AND deleted = 0 AND LENGTH(data) > 0 AND sheet_id = $sheet_id ORDER BY order_id ASC, ID ASC" );
            if ( mysqli_num_rows($selectDataRow) > 0 ) {
                while($rowData = mysqli_fetch_array($selectDataRow)) {
                    $data_ID = $rowData['ID'];

                    $include_arr = array();
                    if ($rowData['include'] != NULL) { $include_arr = explode(" | ", $rowData['include']); }

                    $data_arr = json_decode($rowData['data'],true);

                    $data .= '<tr id="tr_'.$data_ID.'">
                        <td class="text-center">
                            <a href="#modalEditRow" data-toggle="modal" class="btn btn-xs dark" onclick="btnEditRow('.$sheet_id.', '.$data_ID.', '.$modal.', '.$timestamp_id.')"><i class="fa fa-pencil"></i></a>
                            <a href="#modalNewRow" data-toggle="modal" class="btn btn-xs btn-success" onclick="btnNewRow('.$sheet_id.', '.$data_ID.', '.$modal.', '.$timestamp_id.')"><i class="fa fa-plus"></i></a>
                            <a href="javascript:;" class="btn btn-xs btn-danger m-0" onclick="btnDeleteRow(this, '.$data_ID.')"><i class="fa fa-close"></i></a>
                        </td>';

                        $selectFormat = mysqli_query( $conn,"SELECT * FROM tbl_ia_format WHERE deleted = 0 AND timestamp_id = $timestamp_id ORDER BY order_id" );
                        if ( mysqli_num_rows($selectFormat) > 0 ) {
                            while($rowFormat = mysqli_fetch_array($selectFormat)) {
                                $formatID = $rowFormat['ID'];

                                $type = $rowFormat['type'];
                                $type_arr = explode(" | ", $type);

                                $label = $rowFormat['label'];
                                $label_arr = explode(" | ", $label);

                                if ($type > 0) {
                                    if ($type == 1 OR $type == 3 OR $type == 4) {
                                        if (in_array($formatID, $include_arr)) {
                                            foreach($data_arr as $key => $value) {
                                                if ($formatID == $value['ID']) {
                                                    $data .= '<td>'.$value['content'].'</td>';
                                                }
                                            }
                                        } else {
                                            $data .= '<td></td>';
                                        }
                                    } else if ($type == 2) {
                                        $radio_arr = explode(",", $label);

                                        if (in_array($formatID, $include_arr)) {
                                            foreach ($radio_arr as $r) {
                                                $data .= '<td><input type="radio" class="m-0 radio_'.$data_ID.'_'.$formatID.'" value="'.$r.'" name="radio_'.$data_ID.'_'.$formatID.'" /></td>';
                                            }
                                        } else {
                                            $data .= '<td colspan="'.count($radio_arr).'"></td>';
                                        }
                                    }
                                }
                            }
                        }

                    $data .= '</tr>';

                    $data .= ai_child($data_ID, $sheet_id, $type_arr, $label_arr, $modal, $timestamp_id);
                }
            }

            $output = array(
                "sheet_id" => $sheet_id,
                "data" => $data
            );
            echo json_encode($output);
        }
        mysqli_close($conn);
    }


	// RVM PAGE
	if( isset($_GET['modalView_Eforms']) ) {
		$id = $_GET['modalView_Eforms'];

        if (!empty($_COOKIE['switchAccount'])) {
			$portal_user = $_COOKIE['ID'];
			$user_id = $_COOKIE['switchAccount'];
		}
		else {
			$portal_user = $_COOKIE['ID'];
			$user_id = employerID($portal_user);
		}

		$selectData = mysqli_query( $conn,"SELECT * FROM tbl_eforms WHERE ID = $id" );
		if ( mysqli_num_rows($selectData) > 0 ) {
            $row = mysqli_fetch_array($selectData);
			$data_id = $row['ID'];
			$data_department_id = $row['department_id'];
			$data_record = $row['record'];
			$data_description = $row['description'];
			$data_filled_out = $row['filled_out'];
			$data_filled_out_reason = $row['filled_out_reason'];
			$data_signed = $row['signed'];
			$data_signed_reason = $row['signed_reason'];
			$data_frequency = $row['frequency'];
			$data_frequency_other = $row['frequency_other'];
			$data_compliance = $row['compliance'];
			$data_compliance_reason = $row['compliance_reason'];
			$data_files_date = $row['files_date'];
			$data_verified_by = $row['verified_by'];
			$data_notes = $row['notes'];

            $data_assigned_to_id = '';
            if (!empty($row["assigned_to_id"])) {
                $data_assigned_to_id = explode(', ', $row["assigned_to_id"]);
            }

			$filetype = $row['filetype'];
			$data_files = $row['files'];
			$type = 'iframe';
			if (!empty($data_files)) {
				if ($filetype == 1) {
				    $fileExtension = fileExtension($data_files);
					$src = $fileExtension['src'];
					$embed = $fileExtension['embed'];
					$type = $fileExtension['type'];
					$file_extension = $fileExtension['file_extension'];
				    $url = $base_url.'uploads/eforms/';

				    $data_files = $src.$url.rawurlencode($data_files).$embed;
				} else if ($filetype == 3) {
					$data_files = preg_replace('#[^/]*$#', '', $data_files).'preview';
				}
			}
        }

        echo '<input class="form-control" type="hidden" name="ID" value="'. $id .'" />
        <div class="row">
            <div class="col-md-4">
                <div class="form-group">
                    <label class="control-label">Department</label>
                    <select class="form-control select2" name="department_id" onchange="changeDepartment(this, 2)" style="width: 100%;" required>
                        <option value="">Select</option>';

                            $resultDepartment = mysqli_query($conn,"SELECT * FROM tbl_eforms_department WHERE user_id = $user_id ORDER BY name");
                            while($rowDept = mysqli_fetch_array($resultDepartment)) {
                                $ID = $rowDept['ID'];
                                $name = $rowDept['name'];

                                echo '<option value="'. $ID .'" '; echo $ID == $data_department_id ? 'SELECTED':''; echo'>'. $name .'</option>';
                            }

                    	echo '<option value="other">Other</option>
                    </select>
                    <input type="text" class="form-control margin-top-15 display-none" name="department_id_other" id="department_id_other_2" placeholder="Specify others" required />
                </div>
            </div>
            <div class="col-md-4">
                <div class="form-group">
                    <label class="control-label">Record Name</label>
                    <input type="type" class="form-control" name="record" value="'. $data_record .'" />
                </div>
            </div>
            <div class="col-md-4">
                <div class="form-group">
                    <label class="control-label">Assigned To</label>
                    <select class="form-control mt-multiselect btn btn-default" name="assigned_to_id[]" multiple="multiple" >';

                        $selectEmployee = mysqli_query( $conn,"SELECT * FROM tbl_hr_employee WHERE status = 1 AND user_id=$user_id" );
                        if ( mysqli_num_rows($selectEmployee) > 0 ) {
                            while($rowEmployee = mysqli_fetch_array($selectEmployee)) {
                                $rowEmployeeID = $rowEmployee["ID"];
                                $rowEmployeeFName = $rowEmployee["first_name"];
                                $rowEmployeeLName = $rowEmployee["last_name"];

                                if (!empty($data_assigned_to_id) AND in_array($rowEmployeeID, $data_assigned_to_id)) {
	                                echo '<option value="'. $rowEmployeeID .'" SELECTED>'. $rowEmployeeFName .' '. $rowEmployeeLName .'</option>';
	                            } else {
	                            	echo '<option value="'. $rowEmployeeID .'">'. $rowEmployeeFName .' '. $rowEmployeeLName .'</option>';
	                            }
                            }
                        } else {
                            echo '<option disabled>No Available</option>';
                        }

                    echo '</select>
                </div>
            </div>
        </div>
        <div class="form-group">
            <label class="control-label">Description / Area</label>
            <textarea class="form-control" name="description" required>'. $data_record .'</textarea>
        </div>
        <div class="row">
            <div class="col-md-4" id="filled_2">
                <div class="form-group">
                    <label>Properly Filled Out ?</label>
                    <div class="mt-radio-line">
                        <label class="mt-radio mt-radio-outline"> Yes
                            <input type="radio" value="1" name="filled_out" onchange="radioFilled(this, 2)" '; echo $data_filled_out == 1 ? 'checked':'';  echo '/>
                            <span></span>
                        </label>
                        <label class="mt-radio mt-radio-outline"> No
                            <input type="radio" value="0" name="filled_out" onchange="radioFilled(this, 2)" '; echo $data_filled_out == 0 ? 'checked':'';  echo '/>
                            <span></span>
                        </label>
                    </div>
                    <input type="text" class="form-control '; echo $data_filled_out == 1 ? 'hide':''; echo '" name="filled_out_reason" id="filled_out_reason_2" value="'.$data_filled_out_reason.'" placeholder="Enter your reason here" />
                </div>
            </div>
            <div class="col-md-4" id="signed_2">
                <div class="form-group">
                    <label>Properly Signed or Initialed ?</label>
                    <div class="mt-radio-line">
                        <label class="mt-radio mt-radio-outline"> Yes
                            <input type="radio" value="1" name="signed" onchange="radioSigned(this, 2)" '; echo $data_signed == 1 ? 'checked':'';  echo '/>
                            <span></span>
                        </label>
                        <label class="mt-radio mt-radio-outline"> No
                            <input type="radio" value="0" name="signed" onchange="radioSigned(this, 2)" '; echo $data_signed == 0 ? 'checked':'';  echo '/>
                            <span></span>
                        </label>
                    </div>
                    <input type="text" class="form-control '; echo $data_signed == 1 ? 'hide':''; echo '" name="signed_reason" id="signed_reason_2" value="'.$data_signed_reason.'" placeholder="Enter your reason here" />
                </div>
            </div>
            <div class="col-md-4" id="compliance_2">
                <div class="form-group">
                    <label>Is Compliant ?</label>
                    <div class="mt-radio-line">
                        <label class="mt-radio mt-radio-outline"> Yes
                            <input type="radio" value="1" name="compliance" onchange="radioCompliance(this, 2)" '; echo $data_compliance == 1 ? 'checked':'';  echo '/>
                            <span></span>
                        </label>
                        <label class="mt-radio mt-radio-outline"> No
                            <input type="radio" value="0" name="compliance" onchange="radioCompliance(this, 2)" '; echo $data_compliance == 0 ? 'checked':'';  echo '/>
                            <span></span>
                        </label>
                    </div>
                    <input type="text" class="form-control '; echo $data_compliance == 1 ? 'hide':''; echo '" name="compliance_reason" id="compliance_reason_2" value="'.$data_compliance_reason.'" placeholder="Enter your reason here" />
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-4">
                <div class="form-group">
                    <label>Frequency of Collection</label>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mt-radio-list">
                                <label class="mt-radio mt-radio-outline"> Daily
                                    <input type="radio" value="0" name="frequency" '; echo $data_frequency == 0 ? 'checked':'';  echo '/>
                                    <span></span>
                                </label>
                                <label class="mt-radio mt-radio-outline"> Weekly
                                    <input type="radio" value="1" name="frequency" '; echo $data_frequency == 1 ? 'checked':'';  echo '/>
                                    <span></span>
                                </label>
                                <label class="mt-radio mt-radio-outline"> Monthly
                                    <input type="radio" value="2" name="frequency" '; echo $data_frequency == 2 ? 'checked':'';  echo '/>
                                    <span></span>
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mt-radio-list">
                                <label class="mt-radio mt-radio-outline"> Quarterly
                                    <input type="radio" value="3" name="frequency" '; echo $data_frequency == 3 ? 'checked':'';  echo '/>
                                    <span></span>
                                </label>
                                <label class="mt-radio mt-radio-outline"> Biannual
                                    <input type="radio" value="4" name="frequency" '; echo $data_frequency == 4 ? 'checked':'';  echo '/>
                                    <span></span>
                                </label>
                                <label class="mt-radio mt-radio-outline"> Annually
                                    <input type="radio" value="5" name="frequency" '; echo $data_frequency == 5 ? 'checked':'';  echo '/>
                                    <span></span>
                                </label>
                            </div>
                        </div>
                    </div>
                    <label>Others</label>
                    <div class="input-group">
                        <span class="input-group-addon">
                            <input type="radio" value="6" name="frequency" '; echo $data_frequency == 6 ? 'checked':'';  echo '/>
                            <span></span>
                        </span>
                        <input class="form-control "type="text" name="frequency_other" placeholder="Please specify" value="'. $data_frequency_other .'" />
                    </div>
                </div>
            </div>
            <div class="col-md-8">
                <div class="form-group">
                    <label class="control-label">Upload Document</label>
                    <select class="form-control '; echo !empty($data_files) ? 'hide':''; echo '" name="filetype" onchange="changeType(this)" required>
		            	<option value="0">Select option</option>
		            	<option value="1">Manual Upload</option>
		            	<option value="2">Youtube URL</option>
		            	<option value="3">Google Drive URL</option>
		            </select>
		            <input class="form-control margin-top-15 fileUpload" type="file" name="file" style="display: none;" />
		            <input class="form-control margin-top-15 fileURL" type="url" name="fileurl" style="display: none;" placeholder="https://" />
	                <p class="'; echo !empty($data_files) ? '':'hide'; echo '" style="margin: 0;"><a href="'.$data_files.'" data-src="'.$data_files.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a> | <button type="button" class="btn btn-link uploadNew" onclick="uploadNew(this)">Upload New</button></p>
				</div>
                <div class="form-group">
                    <label class="ccontrol-label">Document Date</label>
                    <input class="form-control" type="date" name="file_date" value="'. $data_files_date .'" required />
                </div>
                <div class="form-group">
                    <label class="control-label">Verified By</label>
                    <input class="form-control" type="text" name="verified" value="'. $data_verified_by .'" required />
                </div>
            </div>
        </div>
        <div class="form-group">
            <label class="control-label">Comment/Notes</label>
            <textarea class="form-control" name="notes" placeholder="Write some comment or notes here" required>'. $data_notes .'</textarea>
        </div>';

        mysqli_close($conn);
	}
	if( isset($_GET['modalViewFile_Eforms']) ) {
        $id = $_GET['modalViewFile_Eforms'];
        $FreeAccess = $_GET['freeaccess'];

        $selectData = mysqli_query( $conn,"SELECT * FROM tbl_eforms WHERE ID = $id" );
        if ( mysqli_num_rows($selectData) > 0 ) {
            $row = mysqli_fetch_array($selectData);
            $data_id = $row['ID'];
            $data_department_id = $row['department_id'];
            $data_record = $row['record'];
            $data_description = $row['description'];
            $data_filled_out = $row['filled_out'];
            $data_signed = $row['signed'];
            $data_frequency = $row['frequency'];
            $data_frequency_other = $row['frequency_other'];
            $data_compliance = $row['compliance'];
            $data_files = $row['files'];
            $data_files_date = $row['files_date'];
            $data_verified_by = $row['verified_by'];
            $data_notes = $row['notes'];

            $data_frequency = $row['frequency'];
            if ($data_frequency == 0) { $frequency = "Daily"; }
            else if ($data_frequency == 1) { $frequency = "Weekly"; }
            else if ($data_frequency == 2) { $frequency = "Monthly"; }
            else if ($data_frequency == 3) { $frequency = "Quarterly"; }
            else if ($data_frequency == 4) { $frequency = "Biannual"; }
            else if ($data_frequency == 5) { $frequency = "Annually"; }
            else {
                $frequency = "Others: ".$data_frequency_other;
            }
        }

        echo '<div class="row">
            <div class="col-md-6">';

                $filetype = $row['filetype'];
                $data_files = $row['files'];
                $type = 'iframe';
                if (!empty($data_files)) {
                    if ($filetype == 1) {
                        $fileExtension = fileExtension($data_files);
                        $src = $fileExtension['src'];
                        $embed = $fileExtension['embed'];
                        $type = $fileExtension['type'];
                        $file_extension = $fileExtension['file_extension'];
                        $url = $base_url.'uploads/eforms/';

                        $data_files = $src.$url.rawurlencode($data_files).$embed;

                        if (strtolower($file_extension) == "gif" OR strtolower($file_extension) == "jpg"  OR strtolower($file_extension) == "jpeg" OR strtolower($file_extension) == "png" OR strtolower($file_extension) == "ico") {
                            echo '<img src="'.$data_files.'" style="width: 100%; height: 400px; object-fit: contain; object-position: center;" />';
                        } else {
                            if ($FreeAccess == 1) { echo '<div style="height: 375px; overflow: hidden;">'; }
                                echo '<iframe src="'.$data_files.'" style="width: 100%; height: 400px; '; if (strtolower($file_extension) == "pdf" && $FreeAccess == 1) { echo 'margin-top: -75px;'; } echo '"></iframe>';
                            if ($FreeAccess == 1) { echo '</div>'; }
                        }

                        if ($FreeAccess != 1) {
                            echo '<a href="'.$data_files.'" data-src="'.$data_files.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a>';
                        }
                    } else {
                        if ($filetype == 3) {
                            $data_files = preg_replace('#[^/]*$#', '', $data_files).'preview';
                        }

                        if ($FreeAccess == 1) { echo '<div style="height: 375px; overflow: hidden;">'; }
                            echo '<iframe src="'.$data_files.'" style="width: 100%; height: 400px; '; if ($FreeAccess == 1) { echo 'margin-top: -75px;'; } echo '"></iframe>';
                        if ($FreeAccess == 1) { echo '</div>'; }

                        if ($FreeAccess != 1) {
                            echo '<a href="'.$data_files.'" data-src="'.$data_files.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a>';
                        }
                    }
                } else {
                    echo 'Empty File';
                }

            echo '</div>
            <div class="col-md-6">
                <table class="table table-bordered table-hover">
                    <tbody>
                        <tr>
                            <td>Record Name</td>
                            <td><strong>'. $data_record .'</strong></td>
                        </tr>
                        <tr>
                            <td>Description</td>
                            <td><strong>'. $data_description .'</strong></td>
                        </tr>
                        <tr>
                            <td>Filled Out</td>
                            <td><strong>'; echo $data_filled_out == 1 ? 'Yes':'No'; echo '</strong></td>
                        </tr>
                        <tr>
                            <td>Signed</td>
                            <td><strong>'; echo $data_signed == 1 ? 'Yes':'No'; echo '</strong></td>
                        </tr>
                        <tr>
                            <td>Frequency of Collection</td>
                            <td><strong>'. $frequency .'</strong></td>
                        </tr>
                        <tr>
                            <td>Compliant</td>
                            <td><strong>'; echo $data_compliance == 1 ? 'Yes':'No'; echo '</strong></td>
                        </tr>
                        <tr>
                            <td>Document Date</td>
                            <td><strong>'. $data_files_date .'</strong></td>
                        </tr>
                        <tr>
                            <td>Verified By</td>
                            <td><strong>'. $data_verified_by .'</strong></td>
                        </tr>
                        <tr>
                            <td>Notes</td>
                            <td><strong>'. $data_notes .'</strong></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>';

        mysqli_close($conn);
    }
	if( isset($_GET['modalViewDepartment_Eforms']) ) {
		$id = $_GET['modalViewDepartment_Eforms'];
		$FreeAccess = $_GET['freeaccess'];

		if (!empty($_COOKIE['switchAccount'])) {
			$portal_user = $_COOKIE['ID'];
			$user_id = $_COOKIE['switchAccount'];
		}
		else {
			$portal_user = $_COOKIE['ID'];
			$user_id = employerID($portal_user);
		}

		$selectData = mysqli_query( $conn,"SELECT * FROM tbl_eforms WHERE user_id=$user_id AND department_id = $id ORDER BY files_date DESC" );
		if ( mysqli_num_rows($selectData) > 0 ) {
			while($row = mysqli_fetch_array($selectData)) {
				$ID = $row['ID'];
                $record = $row['record'];
                $files_date = $row['files_date'];
                $verified_by = $row['verified_by'];

                echo '<tr id="tr_'. $ID .'">
                    <td>'. $record .'</td>
                    <td>'. $files_date .'</td>
                    <td>'. $verified_by .'</td>
                    <td class="text-center">';

                        if ($FreeAccess == 1) {
                            echo '<a href="#modalViewFile" class="btn btn-success btn-sm btnView btn-circle" data-toggle="modal" onclick="btnView('. $ID .', '.$FreeAccess.')">View</a>';
	                    } else {
	                        echo '<div class="btn-group btn-group-circle">
	                            <a href="#modalView" class="btn btn-outline dark btn-sm btnEdit" data-toggle="modal" onclick="btnEdit('. $ID.')">Edit</a>
	                            <a href="#modalViewFile" class="btn btn-success btn-sm btnView" data-toggle="modal" onclick="btnView('. $ID .', '.$FreeAccess.')">View</a>
	                        </div>';
                        }

                    echo '</td>
                </tr>';
			}
        }

        mysqli_close($conn);
	}
	if( isset($_GET['modalViewDepartmentViewAll_Eforms']) ) {
		$id = $_GET['modalViewDepartmentViewAll_Eforms'];
        $id = employerID($id);
		$FreeAccess = $_GET['freeaccess'];

        $result = mysqli_query( $conn,"SELECT * FROM tbl_eforms WHERE user_id=$id ORDER BY files_date DESC" );
        if ( mysqli_num_rows($result) > 0 ) {
            while($row = mysqli_fetch_array($result)) {
                $ID = $row['ID'];
                $record = $row['record'];
                $files_date = $row['files_date'];
                $verified_by = $row['verified_by'];

                echo '<tr id="tr_'. $ID .'">
                    <td>'. $record .'</td>
                    <td>'. $files_date .'</td>
                    <td>'. $verified_by .'</td>
                    <td class="text-center">';

                        if ($FreeAccess == 1) {
                            echo '<a href="#modalViewFile" class="btn btn-success btn-sm btnView btn-circle" data-toggle="modal" onclick="btnView('. $ID .', '.$FreeAccess.')">View</a>';
	                    } else {
	                        echo '<div class="btn-group btn-group-circle">
	                            <a href="#modalView" class="btn btn-outline dark btn-sm btnEdit" data-toggle="modal" onclick="btnEdit('. $ID.')">Edit</a>
	                            <a href="#modalViewFile" class="btn btn-success btn-sm btnView" data-toggle="modal" onclick="btnView('. $ID .', '.$FreeAccess.')">View</a>
	                        </div>';
                        }
                        
                    echo '</td>
                </tr>';
            }
        }

        mysqli_close($conn);
	}
	if( isset($_POST['btnSave_Eforms']) ) {
		if (!empty($_COOKIE['switchAccount'])) {
			$portal_user = $_COOKIE['ID'];
			$user_id = $_COOKIE['switchAccount'];
		}
		else {
			$portal_user = $_COOKIE['ID'];
			$user_id = employerID($portal_user);
		}

		$department_id = $_POST['department_id'];
		if ($department_id == "other") {
			$department_id_other = $_POST['department_id_other'];

			$sql = "INSERT INTO tbl_eforms_department (user_id, portal_user, name)
			VALUES ('$user_id', '$portal_user', '$department_id_other')";
			if (mysqli_query($conn, $sql)) {
				$department_id = mysqli_insert_id($conn);
			}
		}

		$record = addslashes($_POST['record']);
		$description = addslashes($_POST['description']);
		$filled_out = $_POST['filled_out'];
		$filled_out_reason = addslashes($_POST['filled_out_reason']);
		$signed = $_POST['signed'];
		$signed_reason = addslashes($_POST['signed_reason']);
		$compliance = $_POST['compliance'];
		$compliance_reason = addslashes($_POST['compliance_reason']);
		$frequency = $_POST['frequency'];
		$frequency_other = $_POST['frequency_other'];
		$files_date = $_POST['file_date'];
		$verified = addslashes($_POST['verified']);
		$notes = addslashes($_POST['notes']);
        $arr_item = array();
        $process = true;

		$filetype = $_POST['filetype'];
        if ($filetype == 1) {
            $files = $_FILES['file']['name'];
            if (!empty($files)) {
                $path = 'uploads/eforms/';
                $filesize = $_FILES['file']['size'];
                $tmp = $_FILES['file']['tmp_name'];
                $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                $ext = strtolower(pathinfo($files, PATHINFO_EXTENSION));
                $files = rand(1000,1000000) . ' - ' . $files;
                $path = $path.$files;

                if(!in_array($ext, $invalid_extensions)) {
                    move_uploaded_file($tmp,$path);
                } else {
                    $process = false;
                }
            }
        } else {
            $files = $_POST['fileurl'];
            $filesize = 0;
        }

        if ($process == true) {
            $output = array (
                'type'  =>  $filetype,
                'name' =>  $files,
                'size' =>  $filesize,
                'date' =>  $local_date
            );
            array_push($arr_item, $output);
            $file_history = json_encode($arr_item, JSON_HEX_APOS | JSON_UNESCAPED_UNICODE);

    		$assigned_to_id = '';
            $sender = array();
            $recipients = array();
    		if (!empty($_POST['assigned_to_id'])) {
    			$assigned_to_id = implode(", ",$_POST['assigned_to_id']);

                $employee_id_arr = explode(", ", $assigned_to_id);
                foreach($employee_id_arr as $key) {    
                    $selectEmployee = mysqli_query( $conn,"SELECT * FROM tbl_hr_employee WHERE ID = $key" );
                    if ( mysqli_num_rows($selectEmployee) > 0 ) {
                        $rowEmployee = mysqli_fetch_array($selectEmployee);
                        $employee_name = $rowEmployee["first_name"].' '.$rowEmployee["last_name"];
                        $employee_email = $rowEmployee["email"];
                        
                        $recipients[$employee_email] = $employee_name;
                    }
                }
    		}

    		$sql = "INSERT INTO tbl_eforms (user_id, portal_user, department_id, record, assigned_to_id, description, filled_out, filled_out_reason, signed, signed_reason, compliance, compliance_reason, frequency, frequency_other, files, filetype, filesize, file_history, files_date, verified_by, notes)
            VALUES ('$user_id', '$portal_user', '$department_id', '$record', '$assigned_to_id', '$description', '$filled_out', '$filled_out_reason', '$signed', '$signed_reason', '$compliance', '$compliance_reason', '$frequency', '$frequency_other', '$files', '$filetype', '$filesize', '$file_history', '$files_date', '$verified', '$notes')";
            
    		if (mysqli_query($conn, $sql)) {
    			$last_id = mysqli_insert_id($conn);
    			$selectData = mysqli_query( $conn,'SELECT * FROM tbl_eforms WHERE user_id="'. $user_id .'" AND ID="'. $last_id .'" ORDER BY ID LIMIT 1' );
    			if ( mysqli_num_rows($selectData) > 0 ) {
    				$rowData = mysqli_fetch_array($selectData);
    				$data_ID = $rowData['ID'];
    				$data_record = $rowData['record'];
    				$data_files_date = $rowData['files_date'];
    				$data_verified = $rowData['verified_by'];

                    if (!empty($assigned_to_id)) {
                        $selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $user_id" );
                        if ( mysqli_num_rows($selectUser) > 0 AND (intval($filled_out) == 0 OR intval($signed) == 0)) {
                            $rowUser = mysqli_fetch_array($selectUser);
                            $user_name = $rowUser['first_name'].' '.$rowUser['last_name'];
                            $user_email = $rowUser['email'];
                            $sender[$user_email] = $user_name;

                            $words = explode(' ', $user_name);
                            $user_name_initials = implode('', array_map(function ($word) {
                                return $word[0];
                            }, $words));

                            $subject = $user_name_initials.'-'.$record.'-NC Document Detected-'.$local_date;
                            $body = 'Hi '.$user_name.',<br><br>

                            I hope this message finds you well. We have detected a non-compliant document within our system, and it requires immediate attention.<br><br>

                            Document Details:<br>
                            Document Name: '.$record.'<br>
                            Date Uploaded: '.$files_date.'<br>
                            Verified By: '.$verified.'<br><br>

                            Please review the document and take the necessary actions to rectify the issue.<br><br>

                            Should you need assistance, kindly call 202-982-3002 or email '.$user_email.'<br><br>

                            InterlinkIQ.com Team
                            Consultare Inc. Group';

                            php_mailer_dynamic($sender, $recipients, $subject, $body);
                        }
                    }

    				$output = array(
    					"ID" => $data_ID,
    					"record" => $data_record,
    					"files_date" => $data_files_date,
    					"verified" => $data_verified
    				);
    				echo json_encode($output);
    			}
    		}
    		mysqli_close($conn);
        }
	}
	if( isset($_POST['btnUpdate_EForms']) ) {
		if (!empty($_COOKIE['switchAccount'])) {
			$portal_user = $_COOKIE['ID'];
			$user_id = $_COOKIE['switchAccount'];
		}
		else {
			$portal_user = $_COOKIE['ID'];
			$user_id = employerID($portal_user);
		}

		$department_id = $_POST['department_id'];
		if ($department_id == "other") {
			$department_id_other = $_POST['department_id_other'];

			$sql = "INSERT INTO tbl_eforms_department (user_id, portal_user, name)
			VALUES ('$user_id', '$portal_user', '$department_id_other')";
			if (mysqli_query($conn, $sql)) {
				$department_id = mysqli_insert_id($conn);
			}
		}

		$ID = $_POST['ID'];
		$record = addslashes($_POST['record']);
		$description = addslashes($_POST['description']);
		$filled_out = $_POST['filled_out'];
		$filled_out_reason = addslashes($_POST['filled_out_reason']);
		$signed = $_POST['signed'];
		$signed_reason = addslashes($_POST['signed_reason']);
		$compliance = $_POST['compliance'];
		$compliance_reason = addslashes($_POST['compliance_reason']);
		$frequency = $_POST['frequency'];
		$frequency_other = $_POST['frequency_other'];
		$files_date = $_POST['file_date'];
		$verified = addslashes($_POST['verified']);
		$notes = addslashes($_POST['notes']);
        $process = true;
		
        $sender = array();
		$assigned_to_id = '';
        $recipients = array();
		if (!empty($_POST['assigned_to_id'])) {
			$assigned_to_id = implode(", ",$_POST['assigned_to_id']);

            $employee_id_arr = explode(", ", $assigned_to_id);
            foreach($employee_id_arr as $key) {    
                $selectEmployee = mysqli_query( $conn,"SELECT * FROM tbl_hr_employee WHERE ID = $key" );
                if ( mysqli_num_rows($selectEmployee) > 0 ) {
                    $rowEmployee = mysqli_fetch_array($selectEmployee);
                    $employee_name = $rowEmployee["first_name"].' '.$rowEmployee["last_name"];
                    $employee_email = $rowEmployee["email"];
                    
                    $recipients[$employee_email] = $employee_name;
                }
            }
		}

		mysqli_query( $conn,"UPDATE tbl_eforms set portal_user='". $portal_user ."', department_id='". $department_id ."', record='". $record ."', assigned_to_id='". $assigned_to_id ."', description='". $description ."', filled_out='". $filled_out ."', filled_out_reason='". $filled_out_reason ."', signed='". $signed ."', signed_reason='". $signed_reason ."', frequency='". $frequency ."', frequency_other='". $frequency_other ."', compliance='". $compliance ."', compliance_reason='". $compliance_reason ."', verified_by='". $verified ."', notes='". $notes ."' WHERE ID='". $ID ."'" );

		$selectData = mysqli_query( $conn,'SELECT * FROM tbl_eforms WHERE ID="'. $ID .'" ORDER BY ID LIMIT 1' );
		if ( mysqli_num_rows($selectData) > 0 ) {
			$rowData = mysqli_fetch_array($selectData);
			$data_ID = $rowData['ID'];
			$data_record = $rowData['record'];
			$data_files_date = $rowData['files_date'];
			$data_verified = $rowData['verified_by'];

            $files = '';
            $arr_item = array();
            if (!empty($rowData["file_history"])) {
                $arr_item = json_decode($rowData["file_history"],true);
            }
            $filetype = $_POST['filetype'];
            if ($filetype > 0) {
                if ($filetype == 1) {
                    $files = $_FILES['file']['name'];
                    if (!empty($files)) {
                        $path = 'uploads/eforms/';
                        $filesize = $_FILES['file']['size'];
                        $tmp = $_FILES['file']['tmp_name'];
                        $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                        $ext = strtolower(pathinfo($files, PATHINFO_EXTENSION));
                        $files = rand(1000,1000000) . ' - ' . $files;
                        $path = $path.$files;

                        if(!in_array($ext, $invalid_extensions)) {
                            move_uploaded_file($tmp,$path);

                            $filesize_tot = $filesize + $rowData["filesize"];

                            mysqli_query( $conn,"UPDATE tbl_eforms SET filesize='". $filesize_tot ."' WHERE ID='". $ID ."'" );
                        } else {
                            $process = false;
                        }
                    }
                } else {
                    $files = $_POST['fileurl'];
                    $filesize = 0;
                }

                if (!empty($files) AND $process == true) {
                    $output = array (
                        'type'  =>  $filetype,
                        'name' =>  $files,
                        'size' =>  $filesize,
                        'date' =>  $local_date
                    );
                    array_push($arr_item, $output);
                    $file_history = json_encode($arr_item, JSON_HEX_APOS | JSON_UNESCAPED_UNICODE);

                    mysqli_query( $conn,"UPDATE tbl_eforms SET files='". $files ."', filetype='". $filetype ."', file_history='". $file_history ."' WHERE ID='". $ID ."'" );
                }
            }


            if ($process == true) {
                if (!empty($assigned_to_id)) {
                    $selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $user_id" );
                    if ( mysqli_num_rows($selectUser) > 0 AND (intval($filled_out) == 0 OR intval($signed) == 0)) {
                        $rowUser = mysqli_fetch_array($selectUser);
                        $user_name = $rowUser['first_name'].' '.$rowUser['last_name'];
                        $user_email = $rowUser['email'];
                        $sender[$user_email] = $user_name;

                        $words = explode(' ', $user_name);
                        $user_name_initials = implode('', array_map(function ($word) {
                            return $word[0];
                        }, $words));

                        $subject = $user_name_initials.'-'.$record.'-NC Document Detected-'.$local_date;
                        $body = 'Hi '.$user_name.',<br><br>

                        I hope this message finds you well. We have detected a non-compliant document within our system, and it requires immediate attention.<br><br>

                        Document Details:<br>
                        Document Name: '.$record.'<br>
                        Date Uploaded: '.$files_date.'<br>
                        Verified By: '.$verified.'<br><br>

                        Please review the document and take the necessary actions to rectify the issue.<br><br>

                        Should you need assistance, kindly call 202-982-3002 or email '.$user_email.'<br><br>

                        InterlinkIQ.com Team
                        Consultare Inc. Group';

                        php_mailer_dynamic($sender, $recipients, $subject, $body);
                    }
                }

    			$output = array(
    				"ID" => $data_ID,
    				"record" => $data_record,
    				"files_date" => $data_files_date,
    				"verified" => $data_verified
    			);
    			echo json_encode($output);
                mysqli_close($conn);
    		}
        }
	}


	// LIBRARY PAGE
	if( isset($_GET['modalView_library']) ) {
        $id = $_GET['modalView_library'];

        if (!empty($_COOKIE['switchAccount'])) {
            $portal_user = $_COOKIE['ID'];
            $user_id = $_COOKIE['switchAccount'];
        }
        else {
            $portal_user = $_COOKIE['ID'];
            $user_id = employerID($portal_user);
        }

        $selectData = mysqli_query( $conn,"SELECT * FROM tbl_lib WHERE ID = $id" );
        if ( mysqli_num_rows($selectData) > 0 ) {
            $row = mysqli_fetch_array($selectData);
            $data_id = $row['ID'];
            $data_department_id = $row['department_id'];
            $data_record = $row['record'];
            $data_files_date = $row['files_date'];
            $data_description = $row['description'];
            $data_notes = $row['notes'];

            $filetype = $row['filetype'];
            $data_files = $row['files'];
            $type = 'iframe';
            if (!empty($data_files)) {
                if ($filetype == 1) {
                    $fileExtension = fileExtension($data_files);
                    $src = $fileExtension['src'];
                    $embed = $fileExtension['embed'];
                    $type = $fileExtension['type'];
                    $file_extension = $fileExtension['file_extension'];
                    $url = $base_url.'uploads/lib/';

                    $data_files = $src.$url.rawurlencode($data_files).$embed;
                } else if ($filetype == 3) {
                    $data_files = preg_replace('#[^/]*$#', '', $data_files).'preview';
                }
            }
        }

        echo '<input class="form-control" type="hidden" name="ID" value="'. $id .'" />
        <div class="row">
            <div class="col-md-3">
                <div class="form-group">
                    <label class="control-label">Department</label>
                    <select class="form-control select2" name="department_id" onchange="changeDepartment(this, 2)" style="width: 100%;" required>
                        <option value="">Select</option>';

                            $resultDepartment = mysqli_query($conn,"SELECT * FROM tbl_lib_department ORDER BY name");
                            while($rowDept = mysqli_fetch_array($resultDepartment)) {
                                $ID = $rowDept['ID'];
                                $name = $rowDept['name'];

                                echo '<option value="'. $ID .'" '; echo $ID == $data_department_id ? 'SELECTED':''; echo'>'. $name .'</option>';
                            }

                        echo '<option value="other">Other</option>
                    </select>
                    <input type="text" class="form-control margin-top-15 display-none" name="department_id_other" id="department_id_other_2" placeholder="Specify others" required />
                </div>
            </div>
            <div class="col-md-3">
                <div class="form-group">
                    <label class="control-label">Name</label>
                    <input type="type" class="form-control" name="record" value="'. $data_record .'" />
                </div>
            </div>
            <div class="col-md-3">
                <div class="form-group">
                    <label class="control-label">Upload Document</label>
                    <select class="form-control '; echo !empty($data_files) ? 'hide':''; echo '" name="filetype" onchange="changeType(this)" required>
                        <option value="0">Select option</option>
                        <option value="1">Manual Upload</option>
                        <option value="2">Youtube URL</option>
                        <option value="3">Google Drive URL</option>
                    </select>
                    <input class="form-control margin-top-15 fileUpload" type="file" name="file" style="display: none;" />
                    <input class="form-control margin-top-15 fileURL" type="url" name="fileurl" style="display: none;" placeholder="https://" />
                    <p class="'; echo !empty($data_files) ? '':'hide'; echo '" style="margin: 0;"><a href="'.$data_files.'" data-src="'.$data_files.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a> | <button type="button" class="btn btn-link uploadNew" onclick="uploadNew(this)">Upload New</button></p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="form-group">
                    <label class="ccontrol-label">Document Date</label>
                    <input class="form-control" type="date" name="file_date" value="'. $data_files_date .'" required />
                </div>
            </div>
        </div>
        <div class="form-group">
            <label class="control-label">Description</label>
            <textarea class="form-control" name="description" required>'. $data_record .'</textarea>
        </div>
        <div class="form-group">
            <label class="control-label">Comment/Notes</label>
            <textarea class="form-control" name="notes" placeholder="Write some comment or notes here" required>'. $data_notes .'</textarea>
        </div>';

        mysqli_close($conn);
    }
    if( isset($_GET['modalViewFile_library']) ) {
        $id = $_GET['modalViewFile_library'];
        $FreeAccess = $_GET['freeaccess'];

        $selectData = mysqli_query( $conn,"SELECT * FROM tbl_lib WHERE ID = $id" );
        if ( mysqli_num_rows($selectData) > 0 ) {
            $row = mysqli_fetch_array($selectData);
            $data_id = $row['ID'];
            $data_department_id = $row['department_id'];
            $data_record = $row['record'];
            $data_files = $row['files'];
            $data_files_date = $row['files_date'];
            $data_description = $row['description'];
            $data_notes = $row['notes'];
        }

        echo '<div class="row">
            <div class="col-md-6">';
                
                $filetype = $row['filetype'];
                $data_files = $row['files'];
                $type = 'iframe';
                if (!empty($data_files)) {
                    if ($filetype == 1) {
                        $fileExtension = fileExtension($data_files);
                        $src = $fileExtension['src'];
                        $embed = $fileExtension['embed'];
                        $type = $fileExtension['type'];
                        $file_extension = $fileExtension['file_mime'];
                        $url = $base_url.'uploads/lib/';

                        $data_files = $src.$url.rawurlencode($data_files).$embed;

                        if (strtolower($file_extension) == "gif" OR strtolower($file_extension) == "jpg"  OR strtolower($file_extension) == "jpeg" OR strtolower($file_extension) == "png" OR strtolower($file_extension) == "ico") {
                            echo '<img src="'.$data_files.'" style="width: 100%; height: 400px; object-fit: contain; object-position: center;" />';
                        } else {
                            if ($FreeAccess == 1) { echo '<div style="height: 375px; overflow: hidden;">'; }
                                echo '<iframe src="'.$data_files.'" style="width: 100%; height: 400px; '; if (strtolower($file_extension) == "pdf" && $FreeAccess == 1) { echo 'margin-top: -75px;'; } echo '"></iframe>';
                            if ($FreeAccess == 1) { echo '</div>'; }
                        }
                    } else {
                        if ($filetype == 3) {
                            $data_files = preg_replace('#[^/]*$#', '', $data_files).'preview';
                        }

                        if ($FreeAccess == 1) { echo '<div style="height: 375px; overflow: hidden;">'; }
                            echo '<iframe src="'.$data_files.'" style="width: 100%; height: 400px; '; if ($FreeAccess == 1) { echo 'margin-top: -75px;'; } echo '"></iframe>';
                        if ($FreeAccess == 1) { echo '</div>'; }
                    }

                    if ($FreeAccess != 1) {
                        echo '<a href="'.$data_files.'" data-src="'.$data_files.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a>';
                    }
                } else {
                    echo 'Empty File';
                }

            echo '</div>
            <div class="col-md-6">
                <table class="table table-bordered table-hover">
                    <tbody>
                        <tr>
                            <td>Name</td>
                            <td><strong>'. $data_record .'</strong></td>
                        </tr>
                        <tr>
                            <td>Document Date</td>
                            <td><strong>'. $data_files_date .'</strong></td>
                        </tr>
                        <tr>
                            <td>Description</td>
                            <td><strong>'. $data_description .'</strong></td>
                        </tr>
                        <tr>
                            <td>Notes</td>
                            <td><strong>'. $data_notes .'</strong></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>';

        mysqli_close($conn);
    }
	if( isset($_GET['modalViewDepartment_library']) ) {
		$id = $_GET['modalViewDepartment_library'];
		$FreeAccess = $_GET['freeaccess'];

		if (!empty($_COOKIE['switchAccount'])) {
			$portal_user = $_COOKIE['ID'];
			$user_id = $_COOKIE['switchAccount'];
		}
		else {
			$portal_user = $_COOKIE['ID'];
			$user_id = employerID($portal_user);
		}

		$selectData = mysqli_query( $conn,"SELECT * FROM tbl_lib WHERE department_id = $id ORDER BY files_date DESC" );
		if ( mysqli_num_rows($selectData) > 0 ) {
			while($row = mysqli_fetch_array($selectData)) {
				$ID = $row['ID'];
                $record = $row['record'];
                $files_date = $row['files_date'];

                echo '<tr id="tr_'. $ID .'">
                    <td>'. $record .'</td>
                    <td class="text-center">'. $files_date .'</td>
                    <td class="text-center">';

                        if ($FreeAccess == 1) {
                            echo '<a href="#modalViewFile" class="btn btn-success btn-sm btnView btn-circle" data-toggle="modal" onclick="btnView('. $ID .', '.$FreeAccess.')">View</a>';
	                    } else {
	                    	if ($user_id == 34) {
		                        echo '<div class="btn-group btn-group-circle">
		                            <a href="#modalView" class="btn btn-outline dark btn-sm btnEdit" data-toggle="modal" onclick="btnEdit('. $ID.')">Edit</a>
		                            <a href="#modalViewFile" class="btn btn-success btn-sm btnView" data-toggle="modal" onclick="btnView('. $ID .', '.$FreeAccess.')">View</a>
		                        </div>';
	                    	} else {
	                    		echo '<a href="#modalViewFile" class="btn btn-success btn-sm btnView btn-circle" data-toggle="modal" onclick="btnView('. $ID .', '.$FreeAccess.')">View</a>';
	                    	}
                        }

                    echo '</td>
                </tr>';
			}
        }

        mysqli_close($conn);
	}
	if( isset($_GET['modalViewDepartmentViewAll_library']) ) {
		$id = $_GET['modalViewDepartmentViewAll_library'];
        $id = employerID($id);
		$FreeAccess = $_GET['freeaccess'];

		if (!empty($_COOKIE['switchAccount'])) {
			$portal_user = $_COOKIE['ID'];
			$user_id = $_COOKIE['switchAccount'];
		}
		else {
			$portal_user = $_COOKIE['ID'];
			$user_id = employerID($portal_user);
		}

        $result = mysqli_query( $conn,"SELECT * FROM tbl_lib ORDER BY files_date DESC" );
        if ( mysqli_num_rows($result) > 0 ) {
            while($row = mysqli_fetch_array($result)) {
                $ID = $row['ID'];
                $record = $row['record'];
                $files_date = $row['files_date'];

                echo '<tr id="tr_'. $ID .'">
                    <td>'. $record .'</td>
                    <td class="text-center">'. $files_date .'</td>
                    <td class="text-center">';

                        if ($FreeAccess == 1) {
                            echo '<a href="#modalViewFile" class="btn btn-success btn-sm btnView btn-circle" data-toggle="modal" onclick="btnView('. $ID .', '.$FreeAccess.')">View</a>';
	                    } else {
	                    	if ($user_id == 34) {
		                        echo '<div class="btn-group btn-group-circle">
		                            <a href="#modalView" class="btn btn-outline dark btn-sm btnEdit" data-toggle="modal" onclick="btnEdit('. $ID.')">Edit</a>
		                            <a href="#modalViewFile" class="btn btn-success btn-sm btnView" data-toggle="modal" onclick="btnView('. $ID .', '.$FreeAccess.')">View</a>
		                        </div>';
	                    	} else {
	                    		echo '<a href="#modalViewFile" class="btn btn-success btn-sm btnView btn-circle" data-toggle="modal" onclick="btnView('. $ID .', '.$FreeAccess.')">View</a>';
	                    	}
                        }
                        
                    echo '</td>
                </tr>';
            }
        }

        mysqli_close($conn);
	}
    if( isset($_GET['btnDelete_Library']) ) {
        $ID = $_GET['btnDelete_Library'];
        mysqli_query( $conn,"UPDATE tbl_lib set deleted = 1 WHERE ID = $ID" );
    }
	if( isset($_POST['btnSave_library']) ) {
        if (!empty($_COOKIE['switchAccount'])) {
            $portal_user = $_COOKIE['ID'];
            $user_id = $_COOKIE['switchAccount'];
        }
        else {
            $portal_user = $_COOKIE['ID'];
            $user_id = employerID($portal_user);
        }

        $department_id = $_POST['department_id'];
        if ($department_id == "other") {
            $department_id_other = $_POST['department_id_other'];

            $sql = "INSERT INTO tbl_lib_department (name)
            VALUES ( '$department_id_other')";
            if (mysqli_query($conn, $sql)) {
                $department_id = mysqli_insert_id($conn);
            }
        }

        $record = addslashes($_POST['record']);
        $files_date = $_POST['file_date'];
        $description = addslashes($_POST['description']);
        $notes = addslashes($_POST['notes']);
        $arr_item = array();
        $process = true;

        $filetype = $_POST['filetype'];
        if ($filetype == 1) {
            $files = $_FILES['file']['name'];
            if (!empty($files)) {
                $path = 'uploads/lib/';
                $filesize = $_FILES['file']['size'];
                $tmp = $_FILES['file']['tmp_name'];
                $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                $ext = strtolower(pathinfo($files, PATHINFO_EXTENSION));
                $files = rand(1000,1000000) . ' - ' . $files;
                $path = $path.$files;

                if(!in_array($ext, $invalid_extensions)) {
                    move_uploaded_file($tmp,$path);
                } else {
                    $process = false;
                }
            }
        } else {
            $files = $_POST['fileurl'];
            $filesize = 0;
        }

        if ($process == true) {
            $output = array (
                'type'  =>  $filetype,
                'name' =>  $files,
                'size' =>  $filesize,
                'date' =>  $local_date
            );
            array_push($arr_item, $output);
            $file_history = json_encode($arr_item, JSON_HEX_APOS | JSON_UNESCAPED_UNICODE);

            $sql = "INSERT INTO tbl_lib (user_id, portal_user, department_id, record, description, files, filetype, filesize, file_history, files_date, notes)
            VALUES ( '$user_id', '$portal_user', '$department_id', '$record', '$description', '$files', '$filetype', '$filesize', '$file_history', '$files_date', '$notes')";
            
            if (mysqli_query($conn, $sql)) {
                $last_id = mysqli_insert_id($conn);
                $selectData = mysqli_query( $conn,'SELECT * FROM tbl_lib WHERE user_id="'. $user_id .'" AND ID="'. $last_id .'" ORDER BY ID LIMIT 1' );
                if ( mysqli_num_rows($selectData) > 0 ) {
                    $rowData = mysqli_fetch_array($selectData);
                    $data_ID = $rowData['ID'];
                    $data_record = $rowData['record'];
                    $data_files_date = $rowData['files_date'];

                    $output = array(
                        "ID" => $data_ID,
                        "record" => $data_record,
                        "files_date" => $data_files_date
                    );
                    echo json_encode($output);
                }
            }
            mysqli_close($conn);
        }
    }
    if( isset($_POST['btnUpdate_library']) ) {
        if (!empty($_COOKIE['switchAccount'])) {
            $portal_user = $_COOKIE['ID'];
            $user_id = $_COOKIE['switchAccount'];
        }
        else {
            $portal_user = $_COOKIE['ID'];
            $user_id = employerID($portal_user);
        }

        $department_id = $_POST['department_id'];
        if ($department_id == "other") {
            $department_id_other = $_POST['department_id_other'];

            $sql = "INSERT INTO tbl_lib_department (name)
            VALUES ( '$department_id_other')";
            if (mysqli_query($conn, $sql)) {
                $department_id = mysqli_insert_id($conn);
            }
        }

        $ID = $_POST['ID'];
        $record = addslashes($_POST['record']);
        $files_date = $_POST['file_date'];
        $description = addslashes($_POST['description']);
        $notes = addslashes($_POST['notes']);
        $process = true;

        mysqli_query( $conn,"UPDATE tbl_lib set portal_user='". $portal_user ."', department_id='". $department_id ."', record='". $record ."', description='". $description ."', notes='". $notes ."' WHERE ID='". $ID ."'" );

        $selectData = mysqli_query( $conn,'SELECT * FROM tbl_lib WHERE ID="'. $ID .'" ORDER BY ID LIMIT 1' );
        if ( mysqli_num_rows($selectData) > 0 ) {
            $rowData = mysqli_fetch_array($selectData);
            $data_ID = $rowData['ID'];
            $data_record = $rowData['record'];
            $data_files_date = $rowData['files_date'];

            $files = '';
            $arr_item = array();
            if (!empty($rowData["file_history"])) {
                $arr_item = json_decode($rowData["file_history"],true);
            }
            $filetype = $_POST['filetype'];
            if ($filetype > 0) {
                if ($filetype == 1) {
                    $files = $_FILES['file']['name'];
                    if (!empty($files)) {
                        $path = 'uploads/lib/';
                        $filesize = $_FILES['file']['size'];
                        $tmp = $_FILES['file']['tmp_name'];
                        $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                        $ext = strtolower(pathinfo($files, PATHINFO_EXTENSION));
                        $files = rand(1000,1000000) . ' - ' . $files;
                        $path = $path.$files;

                        if(!in_array($ext, $invalid_extensions)) {
                            move_uploaded_file($tmp,$path);

                            $filesize_tot = $filesize + $rowData["filesize"];

                            mysqli_query( $conn,"UPDATE tbl_lib SET filesize='". $filesize_tot ."' WHERE ID='". $ID ."'" );
                        } else {
                            $process = false;
                        }
                    }
                } else {
                    $files = $_POST['fileurl'];
                    $filesize = 0;
                }

                if (!empty($files) AND $process == true) {
                    $output = array (
                        'type'  =>  $filetype,
                        'name' =>  $files,
                        'size' =>  $filesize,
                        'date' =>  $local_date
                    );
                    array_push($arr_item, $output);
                    $file_history = json_encode($arr_item, JSON_HEX_APOS | JSON_UNESCAPED_UNICODE);

                    mysqli_query( $conn,"UPDATE tbl_lib SET files='". $files ."', filetype='". $filetype ."', file_history='". $file_history ."' WHERE ID='". $ID ."'" );
                }
            }

            if ($process == true) {
                $output = array(
                    "ID" => $data_ID,
                    "record" => $data_record,
                    "files_date" => $data_files_date
                );
                echo json_encode($output);
                mysqli_close($conn);
            }
        }
    }


	// ARCHIVING PAGE
	if( isset($_GET['modalView_archiving']) ) {
		$id = $_GET['modalView_archiving'];

        if (!empty($_COOKIE['switchAccount'])) {
			$portal_user = $_COOKIE['ID'];
			$user_id = $_COOKIE['switchAccount'];
		}
		else {
			$portal_user = $_COOKIE['ID'];
			$user_id = employerID($portal_user);
		}

		$selectData = mysqli_query( $conn,"SELECT * FROM tbl_archiving WHERE ID = $id" );
		if ( mysqli_num_rows($selectData) > 0 ) {
            $row = mysqli_fetch_array($selectData);
			$data_id = $row['ID'];
			$data_department_id = $row['department_id'];
			$data_record = $row['record'];
			$data_files_date = $row['files_date'];
			$data_description = $row['description'];
			$data_notes = $row['notes'];

			$filetype = $row['filetype'];
			$data_files = $row['files'];
			$type = 'iframe';
			if (!empty($data_files)) {
				if ($filetype == 1) {
				    $fileExtension = fileExtension($data_files);
					$src = $fileExtension['src'];
					$embed = $fileExtension['embed'];
					$type = $fileExtension['type'];
					$file_extension = $fileExtension['file_extension'];
				    $url = $base_url.'uploads/archiving/';

				    $data_files = $src.$url.rawurlencode($data_files).$embed;
				} else if ($filetype == 3) {
					$data_files = preg_replace('#[^/]*$#', '', $data_files).'preview';
				}
			}
        }

        echo '<input class="form-control" type="hidden" name="ID" value="'. $id .'" />
        <div class="row">
            <div class="col-md-3">
                <div class="form-group">
                    <label class="control-label">Department</label>
                    <select class="form-control select2" name="department_id" onchange="changeDepartment(this, 2)" style="width: 100%;" required>
                        <option value="">Select</option>';

                            $resultDepartment = mysqli_query($conn,"SELECT 
                                d.ID AS d_ID,
                                d.name AS d_name
                                FROM tbl_archiving_department AS d

                                LEFT JOIN (
                                    SELECT
                                    *
                                    FROM tbl_archiving
                                ) AS a
                                ON a.department_id = d.ID

                                WHERE a.user_id = $user_id

                                GROUP BY d.name

                                ORDER BY d.name");
                            while($rowDept = mysqli_fetch_array($resultDepartment)) {
                                $ID = $rowDept['d_ID'];
                                $name = $rowDept['d_name'];

                                echo '<option value="'. $ID .'" '; echo $ID == $data_department_id ? 'SELECTED':''; echo'>'. $name .'</option>';
                            }

                    	echo '<option value="other">Other</option>
                    </select>
                    <input type="text" class="form-control margin-top-15 display-none" name="department_id_other" id="department_id_other_2" placeholder="Specify others" required />
                </div>
            </div>
            <div class="col-md-3">
                <div class="form-group">
                    <label class="control-label">Name</label>
                    <input type="type" class="form-control" name="record" value="'. $data_record .'" />
                </div>
            </div>
            <div class="col-md-3">
                <div class="form-group">
                    <label class="control-label">Upload Document</label>
                    <select class="form-control '; echo !empty($data_files) ? 'hide':''; echo '" name="filetype" onchange="changeType(this)" required>
		            	<option value="0">Select option</option>
		            	<option value="1">Manual Upload</option>
		            	<option value="2">Youtube URL</option>
		            	<option value="3">Google Drive URL</option>
		            </select>
		            <input class="form-control margin-top-15 fileUpload" type="file" name="file" style="display: none;" />
		            <input class="form-control margin-top-15 fileURL" type="url" name="fileurl" style="display: none;" placeholder="https://" />
	                <p class="'; echo !empty($data_files) ? '':'hide'; echo '" style="margin: 0;"><a href="'.$data_files.'" data-src="'.$data_files.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a> | <button type="button" class="btn btn-link uploadNew" onclick="uploadNew(this)">Upload New</button></p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="form-group">
                    <label class="ccontrol-label">Document Date</label>
                    <input class="form-control" type="date" name="file_date" value="'. $data_files_date .'" required />
                </div>
            </div>
        </div>
        <div class="form-group">
            <label class="control-label">Description</label>
            <textarea class="form-control" name="description" required>'. $data_description .'</textarea>
        </div>
        <div class="form-group">
            <label class="control-label">Comment/Notes</label>
            <textarea class="form-control" name="notes" placeholder="Write some comment or notes here" required>'. $data_notes .'</textarea>
        </div>';

        mysqli_close($conn);
	}
	if( isset($_GET['modalViewFile_archiving']) ) {
        $id = $_GET['modalViewFile_archiving'];
        $FreeAccess = $_GET['freeaccess'];

        $selectData = mysqli_query( $conn,"SELECT * FROM tbl_archiving WHERE ID = $id" );
        if ( mysqli_num_rows($selectData) > 0 ) {
            $row = mysqli_fetch_array($selectData);
            $data_id = $row['ID'];
            $data_department_id = $row['department_id'];
            $data_record = $row['record'];
            $data_files = $row['files'];
            $data_files_date = $row['files_date'];
            $data_description = $row['description'];
            $data_notes = $row['notes'];
        }

        echo '<div class="row">
            <div class="col-md-6">';

                $filetype = $row['filetype'];
                $data_files = $row['files'];
                $type = 'iframe';
                if (!empty($data_files)) {
                    if ($filetype == 1) {
                        $fileExtension = fileExtension($data_files);
                        $src = $fileExtension['src'];
                        $embed = $fileExtension['embed'];
                        $type = $fileExtension['type'];
                        $file_extension = $fileExtension['file_extension'];
                        $url = $base_url.'uploads/archiving/';

                        $data_files = $src.$url.rawurlencode($data_files).$embed;

                        if (strtolower($file_extension) == "gif" OR strtolower($file_extension) == "jpg"  OR strtolower($file_extension) == "jpeg" OR strtolower($file_extension) == "png" OR strtolower($file_extension) == "ico") {
                            echo '<img src="'.$data_files.'" style="width: 100%; height: 400px; object-fit: contain; object-position: center;" />';
                        } else {
                            if ($FreeAccess == 1) { echo '<div style="height: 375px; overflow: hidden;">'; }
                                echo '<iframe src="'.$data_files.'" style="width: 100%; height: 400px; '; if (strtolower($file_extension) == "pdf" && $FreeAccess == 1) { echo 'margin-top: -75px;'; } echo '"></iframe>';
                            if ($FreeAccess == 1) { echo '</div>'; }
                        }
                    } else {
                        if ($filetype == 3) {
                            $data_files = preg_replace('#[^/]*$#', '', $data_files).'preview';
                        }

                        if ($FreeAccess == 1) { echo '<div style="height: 375px; overflow: hidden;">'; }
                            echo '<iframe src="'.$data_files.'" style="width: 100%; height: 400px; '; if ($FreeAccess == 1) { echo 'margin-top: -75px;'; } echo '"></iframe>';
                        if ($FreeAccess == 1) { echo '</div>'; }
                    }

                    if ($FreeAccess != 1) {
                        echo '<a href="'.$data_files.'" data-src="'.$data_files.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a>';
                    }
                } else {
                    echo 'Empty File';
                }

            echo '</div>
            <div class="col-md-6">
                <table class="table table-bordered table-hover">
                    <tbody>
                        <tr>
                            <td>Name</td>
                            <td><strong>'. htmlentities($data_record) .'</strong></td>
                        </tr>
                        <tr>
                            <td>Document Date</td>
                            <td><strong>'. $data_files_date .'</strong></td>
                        </tr>
                        <tr>
                            <td>Description</td>
                            <td><strong>'. htmlentities($data_description) .'</strong></td>
                        </tr>
                        <tr>
                            <td>Notes</td>
                            <td><strong>'. htmlentities($data_notes) .'</strong></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>';

        mysqli_close($conn);
    }
	if( isset($_GET['modalViewDepartment_archiving']) ) {
		$id = $_GET['modalViewDepartment_archiving'];
		$FreeAccess = $_GET['freeaccess'];

		if (!empty($_COOKIE['switchAccount'])) {
			$portal_user = $_COOKIE['ID'];
			$user_id = $_COOKIE['switchAccount'];
		}
		else {
			$portal_user = $_COOKIE['ID'];
			$user_id = employerID($portal_user);
		}

		$selectData = mysqli_query( $conn,"SELECT * FROM tbl_archiving WHERE user_id=$user_id AND department_id = $id ORDER BY files_date DESC" );
		if ( mysqli_num_rows($selectData) > 0 ) {
			while($row = mysqli_fetch_array($selectData)) {
				$ID = $row['ID'];
                $record = $row['record'];
                $files_date = $row['files_date'];

                echo '<tr id="tr_'. $ID .'">
                    <td>'. htmlentities($record) .'</td>
                    <td class="text-center">'. $files_date .'</td>
                    <td class="text-center">';

                        if ($FreeAccess == 1) {
                            echo '<a href="#modalViewFile" class="btn btn-success btn-sm btnView btn-circle" data-toggle="modal" onclick="btnView('. $ID .')">View</a>';
	                    } else {
	                        echo '<div class="btn-group btn-group-circle">
	                            <a href="#modalView" class="btn btn-outline dark btn-sm btnEdit" data-toggle="modal" onclick="btnEdit('. $ID.')">Edit</a>
	                            <a href="#modalViewFile" class="btn btn-success btn-sm btnView" data-toggle="modal" onclick="btnView('. $ID .')">View</a>
	                        </div>';
                        }
                        
                    echo '</td>
                </tr>';
			}
        }

        mysqli_close($conn);
	}
	if( isset($_GET['modalViewDepartmentViewAll_archiving']) ) {
		$id = $_GET['modalViewDepartmentViewAll_archiving'];
        $id = employerID($id);
		$FreeAccess = $_GET['freeaccess'];

        $result = mysqli_query( $conn,"SELECT * FROM tbl_archiving WHERE user_id=$id ORDER BY files_date DESC" );
        if ( mysqli_num_rows($result) > 0 ) {
            while($row = mysqli_fetch_array($result)) {
                $ID = $row['ID'];
                $record = $row['record'];
                $files_date = $row['files_date'];

                echo '<tr id="tr_'. $ID .'">
                    <td>'. htmlentities($record) .'</td>
                    <td class="text-center">'. $files_date .'</td>
                    <td class="text-center">';

                        if ($FreeAccess == 1) {
                            echo '<a href="#modalViewFile" class="btn btn-success btn-sm btnView btn-circle" data-toggle="modal" onclick="btnView('. $ID .')">View</a>';
	                    } else {
	                        echo '<div class="btn-group btn-group-circle">
	                            <a href="#modalView" class="btn btn-outline dark btn-sm btnEdit" data-toggle="modal" onclick="btnEdit('. $ID.')">Edit</a>
	                            <a href="#modalViewFile" class="btn btn-success btn-sm btnView" data-toggle="modal" onclick="btnView('. $ID .')">View</a>
	                        </div>';
                        }
                        
                    echo '</td>
                </tr>';
            }
        }

        mysqli_close($conn);
	}
	if( isset($_POST['btnSave_archiving']) ) {
		if (!empty($_COOKIE['switchAccount'])) {
			$portal_user = $_COOKIE['ID'];
			$user_id = $_COOKIE['switchAccount'];
		}
		else {
			$portal_user = $_COOKIE['ID'];
			$user_id = employerID($portal_user);
		}

		$department_id = $_POST['department_id'];
		if ($department_id == "other") {
			$department_id_other = $_POST['department_id_other'];

			$sql = "INSERT INTO tbl_archiving_department (name)
			VALUES ( '$department_id_other')";
			if (mysqli_query($conn, $sql)) {
				$department_id = mysqli_insert_id($conn);
			}
		}

        $record = addslashes($_POST['record']);
		$files_date = $_POST['file_date'];
		$description = addslashes($_POST['description']);
		$notes = addslashes($_POST['notes']);
        $arr_item = array();
        $process = true;

		$filetype = $_POST['filetype'];
		if ($filetype == 1) {
			$files = $_FILES['file']['name'];
			if (!empty($files)) {
				$path = 'uploads/archiving/';
                $filesize = $_FILES['file']['size'];
				$tmp = $_FILES['file']['tmp_name'];
                $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                $ext = strtolower(pathinfo($files, PATHINFO_EXTENSION));
				$files = rand(1000,1000000) . ' - ' . $files;
				$path = $path.$files;

                if(!in_array($ext, $invalid_extensions)) {
                    move_uploaded_file($tmp,$path);
                } else {
                    $process = false;
                }
			}
		} else {
			$files = $_POST['fileurl'];
            $filesize = 0;
		}

        if ($process == true) {
            $output = array (
                'type'  =>  $filetype,
                'name' =>  $files,
                'size' =>  $filesize,
                'date' =>  $local_date
            );
            array_push($arr_item, $output);
            $file_history = json_encode($arr_item, JSON_HEX_APOS | JSON_UNESCAPED_UNICODE);

            $sql = "INSERT INTO tbl_archiving (user_id, portal_user, department_id, record, description, files, filetype, filesize, file_history, files_date, notes)
            VALUES ( '$user_id', '$portal_user', '$department_id', '$record', '$description', '$files', '$filetype', '$filesize', '$file_history', '$files_date', '$notes')";
            
    		if (mysqli_query($conn, $sql)) {
    			$last_id = mysqli_insert_id($conn);
    			$selectData = mysqli_query( $conn,'SELECT * FROM tbl_archiving WHERE user_id="'. $user_id .'" AND ID="'. $last_id .'" ORDER BY ID LIMIT 1' );
    			if ( mysqli_num_rows($selectData) > 0 ) {
    				$rowData = mysqli_fetch_array($selectData);
    				$data_ID = $rowData['ID'];
    				$data_record = $rowData['record'];
    				$data_files_date = $rowData['files_date'];

    				$output = array(
    					"ID" => $data_ID,
                        "record" => htmlentities($data_record ?? ''),
    					"files_date" => $data_files_date
    				);
    				echo json_encode($output);
    			}
    		}
    		mysqli_close($conn);
    	}
    }
	if( isset($_POST['btnUpdate_archiving']) ) {
		if (!empty($_COOKIE['switchAccount'])) {
			$portal_user = $_COOKIE['ID'];
			$user_id = $_COOKIE['switchAccount'];
		}
		else {
			$portal_user = $_COOKIE['ID'];
			$user_id = employerID($portal_user);
		}

		$department_id = $_POST['department_id'];
		if ($department_id == "other") {
			$department_id_other = $_POST['department_id_other'];

			$sql = "INSERT INTO tbl_archiving_department (name)
			VALUES ( '$department_id_other')";
			if (mysqli_query($conn, $sql)) {
				$department_id = mysqli_insert_id($conn);
			}
		}

		$ID = $_POST['ID'];
		$record = addslashes($_POST['record']);
		$files_date = $_POST['file_date'];
		$description = addslashes($_POST['description']);
		$notes = addslashes($_POST['notes']);
        $process = true;

        mysqli_query( $conn,"UPDATE tbl_archiving set portal_user='". $portal_user ."', department_id='". $department_id ."', record='". $record ."', description='". $description ."', files_date='". $files_date ."', notes='". $notes ."' WHERE ID='". $ID ."'" );

		$selectData = mysqli_query( $conn,'SELECT * FROM tbl_archiving WHERE ID="'. $ID .'" ORDER BY ID LIMIT 1' );
		if ( mysqli_num_rows($selectData) > 0 ) {
			$rowData = mysqli_fetch_array($selectData);
			$data_ID = $rowData['ID'];
			$data_record = $rowData['record'];
			$data_files_date = $rowData['files_date'];

            $files = '';
            $arr_item = array();
            if (!empty($rowData["file_history"])) {
                $arr_item = json_decode($rowData["file_history"],true);
            }
            $filetype = $_POST['filetype'];
            if ($filetype > 0) {
                if ($filetype == 1) {
                    $files = $_FILES['file']['name'];
                    if (!empty($files)) {
                        $path = 'uploads/archiving/';
                        $filesize = $_FILES['file']['size'];
                        $tmp = $_FILES['file']['tmp_name'];
                        $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                        $ext = strtolower(pathinfo($files, PATHINFO_EXTENSION));
                        $files = rand(1000,1000000) . ' - ' . $files;
                        $path = $path.$files;

                        if(!in_array($ext, $invalid_extensions)) {
                            move_uploaded_file($tmp,$path);

                            $filesize_tot = $filesize + $rowData["filesize"];

                            mysqli_query( $conn,"UPDATE tbl_archiving SET filesize='". $filesize_tot ."' WHERE ID='". $ID ."'" );
                        } else {
                            $process = false;
                        }
                    }
                } else {
                    $files = $_POST['fileurl'];
                    $filesize = 0;
                }

                if (!empty($files) AND $process == true) {
                    $output = array (
                        'type'  =>  $filetype,
                        'name' =>  $files,
                        'size' =>  $filesize,
                        'date' =>  $local_date
                    );
                    array_push($arr_item, $output);
                    $file_history = json_encode($arr_item, JSON_HEX_APOS | JSON_UNESCAPED_UNICODE);

                    mysqli_query( $conn,"UPDATE tbl_archiving SET files='". $files ."', filetype='". $filetype ."', file_history='". $file_history ."' WHERE ID='". $ID ."'" );
                }
            }

            if ($process == true) {
    			$output = array(
    				"ID" => $data_ID,
    				"record" => htmlentities($data_record ?? ''),
    				"files_date" => $data_files_date
    			);
    			echo json_encode($output);
                mysqli_close($conn);
            }
		}
	}


	// SERVICES PAGE
	if( isset($_GET['modalView_Services_Category']) ) {
		$id = $_GET['modalView_Services_Category'];

		$selectData = mysqli_query( $conn,"SELECT * FROM tbl_service_area WHERE service_entity = '".$id."' ORDER BY area_category" );
		if ( mysqli_num_rows($selectData) > 0 ) {

            $result = '<select class="form-control select2" name="area" onchange="serviceArea(this.value)" required style="width: 100%;">
                <option value="">Select</option>';

	            while($row = mysqli_fetch_array($selectData)) {
	            	$ID = $row['id'];
	                $name = $row['area_category'];

	                $result .= '<option value="'. $ID .'">'. $name .'</option>';
	            }

	        	$result .= '<option value="others">Others</option>
        	</select>
            <input type="text" class="form-control margin-top-15 hide area_other" name="area_other" placeholder="Please enter your area here" />';
        } else {
        	$result = '<input type="text" class="form-control area_other" name="area_other" placeholder="Please enter your area here" required />';
        }

        echo $result;

        mysqli_close($conn);
	}
	if( isset($_GET['modalView_Servicess']) ) {
		$id = $_GET['modalView_Servicess'];
        $count_files = 1;
		$selectData = mysqli_query( $conn,"SELECT * FROM tbl_service WHERE ID = $id" );
		if ( mysqli_num_rows($selectData) > 0 ) {
            $row = mysqli_fetch_array($selectData);

			$category_id = $row['category_id'];
			$category_other = $row['category_other'];

			$area_id = $row['area_id'];
			$area_other = $row['area_other'];

			$description = $row['description'];
			$location = $row['location'];

			$files = $row['files'];
            if (!empty($files)) {
                $output_files = json_decode($files,true);
                $count_files = count($output_files);
                if ($count_files == 0) { $count_files = 1; }
            }
        }

        echo '<input class="form-control" type="hidden" name="ID" value="'. $id .'" />
        <input class="form-control" type="hidden" name="count_file" value="'. $count_files .'" />
        <div class="form-group">
            <label class="col-md-3 control-label">Service Category</label>
            <div class="col-md-8">
                <select class="form-control select2" name="category" onchange="serviceCategory(this.value)" style="width: 100%;" required>
                    <option value="">Select</option>';

                        $selectCategory = mysqli_query($conn,"SELECT * FROM tbl_service_category ORDER BY service_category ASC");
                        while($rowCat = mysqli_fetch_array($selectCategory)) {
                            $cat_id = $rowCat['id'];
                            $cat_name = $rowCat['service_category'];

                            echo '<option value="'. $cat_id .'" '; echo $category_id == $cat_id ? 'SELECTED':'';  echo '>'. $cat_name .'</option>';
                        }
                    
                    echo '<option value="others" '; echo $category_id == "others" ? 'SELECTED':'';  echo '>Others</option>
                </select>
                <input type="text" class="form-control margin-top-15 category_other '; echo $category_id == "others" ? '':'hide';  echo '" name="category_other" placeholder="Please enter your category here" value="'. $category_other .'" />
            </div>
        </div>
        <div class="form-group">
            <label class="col-md-3 control-label">Area</label>
            <div class="col-md-8 area">
                <select class="form-control select2" name="area" onchange="serviceArea(this.value)" style="width: 100%;" required>
                    <option value="">Select</option>';

                        $selectArea = mysqli_query($conn,"SELECT * FROM tbl_service_area ORDER BY area_category ASC");
                        while($rowArea = mysqli_fetch_array($selectArea)) {
                            $a_id = $rowArea['id'];
                            $a_name = $rowArea['area_category'];

                            echo '<option value="'. $a_id .'" '; echo $area_id == $a_id ? 'SELECTED':'';  echo '>'. $a_name .'</option>';
                        }
                    
                    echo '<option value="others" '; echo $area_id == "others" ? 'SELECTED':'';  echo '>Others</option>
                </select>
                <input type="text" class="form-control margin-top-15 area_other '; echo $area_id == "others" ? '':'hide';  echo '" name="area_other" placeholder="Please enter your area here" value="'. $area_other .'" />
            </div>
        </div>
        <div class="form-group">
            <label class="col-md-3 control-label">Description of Service</label>
            <div class="col-md-8">
                <textarea class="form-control" name="description" placeholder="Specialties" required>'. $description .'</textarea>
            </div>
        </div>
        <div class="form-group">
            <label class="col-md-3 control-label">Location of Service</label>
            <div class="col-md-8">
                <input class="form-control" type="text" name="location" placeholder="Remote, On-site, US Only, etc." value="'. $location .'" required />
            </div>
        </div>
        <div class="form-group">
            <label class="col-md-3 control-label">Service Offering <p class="text-muted" style="margin: 0;"><small>(Brochure,Resume,Sample of Work, etc.)</small></p></label>
            <div class="col-md-8">
                <div class="mt-repeater mt-repeater-file">
                    <div data-repeater-list="offering">';

                        if (!empty($output_files)) {
		                    foreach ($output_files as $key => $value) {
		                        $file = $value['file_offering'];
								$fileExtension = fileExtension($file);
								$src = $fileExtension['src'];
								$embed = $fileExtension['embed'];
								$type = $fileExtension['type'];
								$file_extension = $fileExtension['file_extension'];
		                        $url = $base_url.'uploads/services/';

		                        echo '<div class="mt-repeater-item row" data-repeater-item>
		                            <div class="col-md-10">
	                                    <input class="form-control '; echo !empty($file) ? 'hide':''; echo '" type="file" name="file" />
	                                    <p class="'; echo !empty($file) ? '':'hide'; echo '" style="margin: 0;"><a data-src="'.$src.$url.rawurlencode($file).$embed.'" data-fancybox="gallery" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a> | <button type="button" class="btn btn-link uploadNew" onclick="uploadNew(this)">Upload New</button></p>
		                            </div>
		                            <div class="col-md-2 text-right">
		                                    <a href="javascript:;" data-repeater-delete class="btn btn-danger"><i class="fa fa-close"></i></a>
		                            </div>
		                        </div>';
		                    }
		                } else {
		                    echo '<div class="mt-repeater-item row" data-repeater-item>
		                        <div class="col-md-10">
		                            <input class="form-control" type="file" name="file" />
		                        </div>
		                        <div class="col-md-2  text-right">
		                            <a href="javascript:;" data-repeater-delete class="btn btn-danger"><i class="fa fa-close"></i></a>
		                        </div>
		                    </div>';
		                }
                    echo '</div>
                    <a href="javascript:;" data-repeater-create class="btn btn-success mt-repeater-add"><i class="fa fa-plus"></i> Add more</a>
                </div>
            </div>
        </div>';

        mysqli_close($conn);
	}
	if( isset($_GET['modalDelete_Servicess']) ) {
		$id = $_GET['modalDelete_Servicess'];

		mysqli_query( $conn,"UPDATE tbl_service set is_deleted=1 WHERE ID=$id" );
	}
	if( isset($_POST['btnSave_Servicess']) ) {
		if (!empty($_COOKIE['switchAccount'])) {
			$portal_user = $_COOKIE['ID'];
			$user_id = $_COOKIE['switchAccount'];
		}
		else {
			$portal_user = $_COOKIE['ID'];
			$user_id = employerID($portal_user);
		}

		$category = $_POST['category'];
		$category_other = $_POST['category_other'];

		$area = $_POST['area'];
		if ($category == "others") { $area = "others"; }
		$area_other = $_POST['area_other'];

		$description = addslashes($_POST['description']);
		$location = addslashes($_POST['location']);
        $process = true;

		$count_file = $_POST['count_file'];
		$arr_item = array();
        $arr_file = array();
		$path = 'uploads/services/';
		$random = rand(1000,1000000);
		$offering = $_FILES['offering']['name'];
		$file_history = '';
        $file_docs = '';
		if (!empty($offering)) {
			for ($i=0; $i < $count_file; $i++) {
				$files = implode('*', $_FILES['offering']['name'][$i]);
				if (!empty($files)) {
                    $filesize = implode('*', $_FILES['offering']['size'][$i]);
					$tmp_docs = implode('*', $_FILES['offering']['tmp_name'][$i]);
                    $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                    $ext = strtolower(pathinfo($files, PATHINFO_EXTENSION));
					$file_docs = $random.' - '.$files;
					$path_docs = $path.$file_docs;

                    if(!in_array($ext, $invalid_extensions)) {
                        move_uploaded_file($tmp_docs,$path_docs);

                        $output = array (
                            'type'  =>  0,
                            'name' =>  $file_docs,
                            'size' =>  $filesize,
                            'date' =>  $local_date
                        );
                        array_push($arr_item, $output);

                        $file_data = array (
                            'file_offering' => $file_docs
                        );
                        array_push( $arr_file, $file_data );
                    } else {
                        $process = false;
                    }
				}
			}
		}
        $file_history = json_encode($arr_item, JSON_HEX_APOS | JSON_UNESCAPED_UNICODE);
		$file_docs = json_encode($arr_file);

        if ($process == true) {
            $sql = "INSERT INTO tbl_service (user_id, portal_user, category_id, category_other, area_id, area_other, description, location, files, file_history)
            VALUES ( '$user_id', '$portal_user', '$category', '$category_other', '$area', '$area_other', '$description', '$location', '$file_docs', '$file_history')";
            
    		if (mysqli_query($conn, $sql)) {
    			$last_id = mysqli_insert_id($conn);
    			$selectData = mysqli_query( $conn,'SELECT * FROM tbl_service WHERE user_id="'. $user_id .'" AND ID="'. $last_id .'" ORDER BY ID LIMIT 1' );
    			if ( mysqli_num_rows($selectData) > 0 ) {
    				$rowData = mysqli_fetch_array($selectData);
    				$data_ID = $rowData['ID'];
    				$data_description = $rowData['description'];
    				$data_location = $rowData['location'];

    				$data_category_id = $rowData['category_id'];
    				if ($data_category_id == "others") {
    					$data_category = $rowData['category_other'];
    				} else {
    					$selectCategory = mysqli_query( $conn,'SELECT * FROM tbl_service_category WHERE id="'. $data_category_id .'" ORDER BY ID LIMIT 1' );
    					$rowCategory = mysqli_fetch_array($selectCategory);
    					$data_category = $rowCategory['service_category'];
    				}

    				$data_area_id = $rowData['area_id'];
    				if ($data_area_id == "others") {
    					$data_area = $rowData['area_other'];
    				} else {
    					$selectArea = mysqli_query( $conn,'SELECT * FROM tbl_service_area WHERE id="'. $data_area_id .'" ORDER BY ID LIMIT 1' );
    					$rowArea = mysqli_fetch_array($selectArea);
    					$data_area = $rowArea['area_category'];
    				}

    				$data_files = $rowData['files'];
    				$data_files_array = explode(", ", $data_files);

    				$output = array(
    					"ID" => $data_ID,
    					"category" => $data_category,
    					"area" => $data_area,
    					"description" => $data_description
    				);
    				echo json_encode($output);
    			}
    		}
    		mysqli_close($conn);
    	}
    }
	if( isset($_POST['btnUpdate_Services']) ) {
		$ID = $_POST['ID'];
		$category = $_POST['category'];
		$category_other = $_POST['category_other'];

		$area = $_POST['area'];
		if ($category == "others") { $area = "others"; }
		$area_other = $_POST['area_other'];

		$description = addslashes($_POST['description']);
		$location = addslashes($_POST['location']);
        $process = true;

		mysqli_query( $conn,"UPDATE tbl_service set category_id='". $category ."', category_other='". $category_other ."', area_id='". $area ."', area_other='". $area_other ."', description='". $description ."', location='". $location ."' WHERE ID='". $ID ."'" );

		$selectData = mysqli_query( $conn,'SELECT * FROM tbl_service WHERE ID="'. $ID .'"' );
		if ( mysqli_num_rows($selectData) > 0 ) {
			$rowData = mysqli_fetch_array($selectData);
			$data_ID = $rowData['ID'];
			$data_description = $rowData['description'];
			$data_location = $rowData['location'];

            $files = '';
            $arr_item = array();
            if (!empty($rowData["file_history"])) {
                $arr_item = json_decode($rowData["file_history"],true);
            }
            $count_file = $_POST['count_file'];
            $arr_file = array();
            $path = 'uploads/services/';
            $random = rand(1000,1000000);
            $offering = $_FILES['offering']['name'];
            $file_history = '';
            $file_docs = '';
            $file_docs_updated = false;

            if (!empty($offering)) {
                for ($i=0; $i < $count_file; $i++) {
                    $files = implode('*', $_FILES['offering']['name'][$i]);
                    if (!empty($files)) {
                        $filesize = implode('*', $_FILES['offering']['size'][$i]);
                        $tmp_docs = implode('*', $_FILES['offering']['tmp_name'][$i]);
                        $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                        $ext = strtolower(pathinfo($files, PATHINFO_EXTENSION));
                        $file_docs = $random.' - '.$files;
                        $path_docs = $path.$file_docs;

                        if(!in_array($ext, $invalid_extensions)) {
                            move_uploaded_file($tmp_docs,$path_docs);

                            $output = array (
                                'type'  =>  0,
                                'name' =>  $files,
                                'size' =>  $filesize,
                                'date' =>  $local_date
                            );
                            array_push($arr_item, $output);

                            $file_data = array (
                                'file_offering' => $file_docs
                            );
                            array_push( $arr_file, $file_data );
                            $file_docs_updated = true;
                        } else {
                            $process = false;
                        }
                    }
                }
            }
            if ($process == true) {
                if ($file_docs_updated == true) {
                    $file_history = json_encode($arr_item, JSON_HEX_APOS | JSON_UNESCAPED_UNICODE);
                    $file_docs = json_encode($arr_file);

                    mysqli_query( $conn,"UPDATE tbl_service set files='". $file_docs ."', file_history='". $file_history ."' WHERE ID='". $ID ."'" );
                }

    			$data_category_id = $rowData['category_id'];
    			if ($data_category_id == "others") {
    				$data_category = $rowData['category_other'];
    			} else {
    				$selectCategory = mysqli_query( $conn,'SELECT * FROM tbl_service_category WHERE id="'. $data_category_id .'" ORDER BY ID LIMIT 1' );
    				$rowCategory = mysqli_fetch_array($selectCategory);
    				$data_category = $rowCategory['service_category'];
    			}

    			$data_area_id = $rowData['area_id'];
    			if ($data_area_id == "others") {
    				$data_area = $rowData['area_other'];
    			} else {
    				$selectArea = mysqli_query( $conn,'SELECT * FROM tbl_service_area WHERE id="'. $data_area_id .'" ORDER BY ID LIMIT 1' );
    				$rowArea = mysqli_fetch_array($selectArea);
    				$data_area = $rowArea['area_category'];
    			}

    			$data_files = $rowData['files'];
    			$data_files_array = explode(", ", $data_files);

    			$output = array(
    				"ID" => $data_ID,
    				"category" => $data_category,
    				"area" => $data_area,
    				"description" => $data_description
    			);
    			echo json_encode($output);
                mysqli_close($conn);
    		}
        }
	}


	// JOB TICKET PAGE
	if( isset($_GET['modalView_Services']) ) {
		$id = $_GET['modalView_Services'];

		if (!empty($_COOKIE['switchAccount'])) {
			$portal_user = $_COOKIE['ID'];
			$user_id = $_COOKIE['switchAccount'];
			$user_emp_id = employeeID($user_id);
		}
		else {
			$portal_user = $_COOKIE['ID'];
			$user_id = employerID($portal_user);
			$user_emp_id = employeeID($portal_user);
		}

		$selectData = mysqli_query( $conn,"SELECT * FROM tbl_services WHERE ID = $id" );
		if ( mysqli_num_rows($selectData) > 0 ) {
            $row = mysqli_fetch_array($selectData);

            $category = $row['category'];
            $name = $row['name'];
            $title = $row['title'];
            $contact = $row['contact'];
            $email = $row['email'];
            $description = $row['description'];
            $due_date = $row['due_date'];
            $assigned_to_id = $row['assigned_to_id'];
            $status = $row['type'];

            $files = $row["files"];
            $fileExtension = fileExtension($files);
			$src = $fileExtension['src'];
			$embed = $fileExtension['embed'];
			$type = $fileExtension['type'];
			$file_extension = $fileExtension['file_extension'];
            $url = $base_url.'uploads/services/';
        }

        echo '<input class="form-control" type="hidden" name="ID" value="'.$id.'" />
        <div class="form-group">
            <label class="col-md-3 control-label">Category</label>
            <div class="col-md-8">
                <select class="form-control" name="category" onchange="serviceCat(this.value)" readonly disabled>
                    <option value=""></option>
                    <option value="1" '; echo $category == 1 ? 'SELECTED':''; echo '>IT Services</option>
                    <option value="2" '; echo $category == 2 ? 'SELECTED':''; echo '>Techinical Services</option>
                    <option value="3" '; echo $category == 3 ? 'SELECTED':''; echo '>Sales</option>
                    <option value="4" '; echo $category == 4 ? 'SELECTED':''; echo '>Request Demo</option>
                    <option value="5" '; echo $category == 5 ? 'SELECTED':''; echo '>Suggestion</option>
                    <option value="6" '; echo $category == 6 ? 'SELECTED':''; echo '>Problem</option>
                    <option value="7" '; echo $category == 7 ? 'SELECTED':''; echo '>Praise</option>
                </select>
            </div>
        </div>
        <div class="form-group">
            <label class="col-md-3 control-label">Name</label>
            <div class="col-md-8">
                <input class="form-control" type="text" name="name" placeholder="Enter your Name" value="'.$name.'" readonly />
            </div>
        </div>
        <div class="form-group">
            <label class="col-md-3 control-label">Request Title</label>
            <div class="col-md-8">
                <input class="form-control" type="text" name="title" placeholder="Example: Website, SOP, etc" value="'.$title.'" readonly />
            </div>
        </div>
        <div class="form-group">
            <label class="col-md-3 control-label">Description</label>
            <div class="col-md-8">
                <textarea class="form-control" name="description" placeholder="Describe your service request here" readonly>'.$description.'</textarea>
            </div>
        </div>
        <div class="form-group">
            <label class="col-md-3 control-label">Contact Number</label>
            <div class="col-md-8">
                <input class="form-control" type="text" name="contact" value="'.$contact.'" readonly />
            </div>
        </div>
        <div class="form-group">
            <label class="col-md-3 control-label">Email</label>
            <div class="col-md-8">
                <input class="form-control" type="email" name="email" value="'.$email.'" readonly />
            </div>
        </div>
        <div class="form-group">
            <label class="col-md-3 control-label">Attached File</label>
            <div class="col-md-8">
                <label control-label" style="padding-top: 7px;"><a data-src="'.$src.$url.rawurlencode($files).$embed.'" data-fancybox data-type="'.$type.'">'.$files.'</a></label>
            </div>
        </div>
        <div class="form-group" id="serviceDesiredDueDate">
            <label class="col-md-3 control-label">Desired Due Date</label>
            <div class="col-md-8">
                <input class="form-control" type="date" name="due_date" value="'.$due_date.'" readonly />
            </div>
        </div>';

        if ($portal_user == 1 OR $portal_user == 2 OR $portal_user == 19 OR $portal_user == 17 OR $portal_user == 185) {
        	echo '<div class="form-group">
	            <label class="col-md-3 control-label">Assigned to</label>
	            <div class="col-md-8">
	                <select class="form-control mt-multiselect btn btn-default" name="assigned_to_id[]" multiple="multiple">';

	                    $selectEmployee = mysqli_query( $conn,"SELECT * from tbl_hr_employee WHERE user_id = 34 AND suspended = 0 AND status = 1 ORDER BY first_name" );
						if ( mysqli_num_rows($selectEmployee) > 0 ) {
							while($rowEmployee = mysqli_fetch_array($selectEmployee)) {
						        $employee_id = $rowEmployee['ID'];
					            $employee_userFName = $rowEmployee['first_name'];
					            $employee_userLName = $rowEmployee['last_name'];

					            $assigned = array();
					            $assigned = explode(', ', $assigned_to_id);
					            if (in_array($employee_id, $assigned)) { echo '<option value="'.$employee_id.'" SELECTED>'.$employee_userFName.' '.$employee_userLName.'</option>'; }
					            else { echo '<option value="'.$employee_id.'">'.$employee_userFName.' '.$employee_userLName.'</option>'; }
						    }
						}

	                echo '</select>
	            </div>
	        </div>';
        }

        if (!empty($assigned_to_id)) {
        	$assigned_to_id_arr = explode(', ', $assigned_to_id);
        	if (in_array($user_emp_id, $assigned_to_id_arr)) {
        		echo '<div class="form-group">
		            <label class="col-md-3 control-label">Status</label>
		            <div class="col-md-8">
		                <select class="form-control" name="type">
		                	<option value="0" '; echo $status == 0 ? 'SELECTED':''; echo '>Assigned</option>
		                	<option value="1" '; echo $status == 1 ? 'SELECTED':''; echo '>On Queue</option>
		                	<option value="2" '; echo $status == 2 ? 'SELECTED':''; echo '>On Going</option>
		                	<option value="3" '; echo $status == 3 ? 'SELECTED':''; echo '>Fixed</option>
		                	<option value="4" '; echo $status == 4 ? 'SELECTED':''; echo '>Unresolved</option>
		                </select>
		            </div>
		        </div>';
        	}
        }

        echo '<div class="form-group">
            <label class="col-md-3 control-label">Comment</label>
            <div class="col-md-8">';

            	$selectComment = mysqli_query( $conn,"SELECT * from tbl_services_comment WHERE deleted = 0 AND services_id = $id" );
				if ( mysqli_num_rows($selectComment) > 0 ) {
					echo '<ul class="chats">';
						while($rowComment = mysqli_fetch_array($selectComment)) {
							$comment_user_id = $rowComment['user_id'];
							$comment_val = $rowComment['comment'];
							$comment_date = $rowComment['last_modified'];
							$comment_name = '';
							$comment_avatar = '';

							$selectUsers = mysqli_query( $conn,"SELECT * from tbl_user WHERE ID = $comment_user_id" );
							if ( mysqli_num_rows($selectUsers) > 0 ) {
								while($rowUser = mysqli_fetch_array($selectUsers)) {
									$comment_name = $rowUser['first_name'] .' '. $rowUser['last_name'];
								}
							}

							$selectUsersInfo = mysqli_query( $conn,"SELECT * from tbl_user_info WHERE user_id = $comment_user_id" );
							if ( mysqli_num_rows($selectUsersInfo) > 0 ) {
								while($rowUserInfo = mysqli_fetch_array($selectUsersInfo)) {
									$comment_avatar = $rowUserInfo['avatar'];
								}
							}

				            echo '<li class="in">
		                        <img class="avatar" src="uploads/avatar/'.$comment_avatar.'" onerror="this.onerror=null;this.src=\'https://via.placeholder.com/150x150/EFEFEF/AAAAAA.png?text=no+image\';" />
		                        <div class="message">
		                            <span class="arrow"> </span>
		                            <span class="name">'.$comment_name.'</span>
		                            <span class="datetime"> on '.$comment_date.'</span>
		                            <span class="body">'.nl2br($comment_val).'</span>
		                        </div>
		                    </li>';
					    }
					echo '</ul>';
				}
                
            	echo '<textarea class="form-control" name="comment"></textarea>
           	</div>
        </div>';

        mysqli_close($conn);
	}
	if( isset($_GET['btnDone']) ) {
		$id = $_GET['btnDone'];
		$last_modified = date('Y-m-d');

		mysqli_query( $conn,"UPDATE tbl_services set status=1, last_modified='".$last_modified."' WHERE ID=$id" );
		if (!mysqli_error($conn)) {
			$selectData = mysqli_query( $conn,"SELECT * FROM tbl_services WHERE ID = $id" );
			if ( mysqli_num_rows($selectData) > 0 ) {
	            $row = mysqli_fetch_array($selectData);
	            $title = $row['title'];
	            $description = $row['description'];
	            $contact = $row['contact'];
	            $email = $row['email'];
	            $due_date = $row['due_date'];
	            $last_modified = $row['last_modified'];

                $data_category_id = $row["category"];
                $data_category = array(
                    0 => 'Others',
                    1 => 'IT Services',
                    2 => 'Technical Services',
                    3 => 'Sales',
                    4 => 'Request Demo',
                    5 => 'Suggestion',
                    6 => 'Problem',
                    7 => 'Praise'
                );

	            $files = $row['files'];
				if (!empty($files)) {
		            $fileExtension = fileExtension($files);
					$src = $fileExtension['src'];
					$embed = $fileExtension['embed'];
					$type = $fileExtension['type'];
					$file_extension = $fileExtension['file_extension'];
		            $url = $base_url.'uploads/services/';
		            $files = 'File: <a data-src="'.$src.$url.rawurlencode($files).$embed.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a>';
		        };
	        }
	        
			$output = array(
				'ID' => $id,
				'category' => $data_category[$data_category_id],
				'title' => $title,
				'description' => $description,
				'files' => $files,
				'contact' => $contact,
				'email' => $email,
				'due_date' => $due_date,
				'last_modified' => $last_modified
			);
			echo json_encode($output);
		}
	}
	if( isset($_POST['btnSave_Services']) ) {
		$ID = $_POST['ID'];
		$category = $_POST['category'];
        $c_name = addslashes($_POST['name']);
		$title = addslashes($_POST['title']);
		$description = addslashes($_POST['description']);
		$contact = $_POST['contact'];
		$email = $_POST['email'];
		$due_date = $_POST['due_date'];
		$last_modified = date("Y-m-d");
        $process = true;

		$files = $_FILES['file']['name'];
		if (!empty($files)) {
			$path = 'uploads/services/';
			$tmp = $_FILES['file']['tmp_name'];
            $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
            $ext = strtolower(pathinfo($files, PATHINFO_EXTENSION));
			$files = rand(1000,1000000) . ' - ' . $files;
			$path = $path.$files;

            if(!in_array($ext, $invalid_extensions)) {
                move_uploaded_file($tmp,$path);
            } else {
                $process = false;
            }
		}

        if ($process == true) {
    		$sql = "INSERT INTO tbl_services (user_id, category, name, title, description, files, contact, email, due_date, last_modified)
    		VALUES ('$ID', '$category', '$c_name', '$title', '$description', '$files', '$contact', '$email', '$due_date', '$last_modified')";
    		
    		if (mysqli_query($conn, $sql)) {
    			$last_id = mysqli_insert_id($conn);
    			$selectData = mysqli_query( $conn,'SELECT * FROM tbl_services WHERE user_id="'. $ID .'" AND ID="'. $last_id .'" ORDER BY ID LIMIT 1' );
    			if ( mysqli_num_rows($selectData) > 0 ) {
    				$rowData = mysqli_fetch_array($selectData);
    				$data_ID = $rowData['ID'];
    				$data_title = $rowData['title'];
    				$data_description = $rowData['description'];
    				$data_contact = $rowData['contact'];
    				$data_email = $rowData['email'];
    				$data_last_modified = $rowData['last_modified'];
    				$data_due_date = $rowData['due_date'];

                    $data_category_id = $rowData["category"];
                    $data_category = array(
                        0 => 'Others',
                        1 => 'IT Services',
                        2 => 'Technical Services',
                        3 => 'Sales',
                        4 => 'Request Demo',
                        5 => 'Suggestion',
                        6 => 'Problem',
                        7 => 'Praise'
                    );

    				if (!empty($files)) {
    		            $fileExtension = fileExtension($files);
    					$src = $fileExtension['src'];
    					$embed = $fileExtension['embed'];
    					$type = $fileExtension['type'];
    					$file_extension = $fileExtension['file_extension'];
    		            $url = $base_url.'uploads/services/';
    		            $files = 'File: <a data-src="'.$src.$url.rawurlencode($files).$embed.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a>';
    		        }

                	$counterup_tbl = counterup_tbl('supplier');
    				$output = array(
    					"ID" => $data_ID,
    					"category" => $data_category[$data_category_id],
    					"title" => $data_title,
    					"description" => $data_description,
    					"files" => $files,
    					"contact" => $data_contact,
    					"email" => $data_email,
    					"last_modified" => $data_last_modified,
    					"due_date" => $data_due_date
    				);

    				// Customer Service
    				$from = 'services@interlinkiq.com';
    				$name = 'InterlinkIQ';
    				$to = 'services@interlinkiq.com';
    				$to2 = 'arnel@consultareinc.com';
    				$to3 = 'chris@consultareinc.com';
    				$user = 'InterlinkIQ';
    				$subject = 'New Job Ticket';
    				$body = 'Hi '.$user.'<br><br>

    				Please check your Job Ticket Tracker<br><br>

    				<b>Description:</b> '.$description.'<br>
    				<b>Contact:</b> '.$contact.'<br>
    				<b>Email:</b> '.$email.'<br><br>
    				
    				InterlinkIQ.com Team<br>
    				Consultare Inc. Group';
    				php_mailer_request_service($to, $to2, $to3, $user, $subject, $body);


    				// Requestor
    				$to = $email;
    				$user = '';
    				$subject = 'Job Ticket Tracker #'.$last_id;
                    $body = 'Hi, '.$c_name.'!<br><br>

    				Thank you for reaching out! We received your email with Job Ticket Tracker #'.$last_id.'. Our team will get back to you regarding your concern.<br><br>

    				Thank you for your patience and we look forward to talking to you soon!';
    				php_mailer_2($to, $user, $subject, $body, $from, $name);

    				echo json_encode($output);
    			}
    		}
    		mysqli_close($conn);
        }
	}
	if( isset($_POST['btnUpdate_Service']) ) {
		$ID = $_POST['ID'];
		$current_userID = $_COOKIE['ID'];
		$last_modified = date("Y-m-d");

		$selectDataTemp = mysqli_query( $conn,"SELECT * FROM tbl_services WHERE ID = $ID" );
		if ( mysqli_num_rows($selectDataTemp) > 0 ) {
	        $rowDataTemp = mysqli_fetch_array($selectDataTemp);
	        $rowDataTemp_assigned_to_id = $rowDataTemp['assigned_to_id'];
	    }

		$comment = addslashes($_POST['comment']);
		if (!empty($comment)) {
			$sql = "INSERT INTO tbl_services_comment (user_id, services_id, comment, last_modified)
			VALUES ('$current_userID', '$ID', '$comment', '$last_modified')";
			mysqli_query($conn, $sql);
		}

		$assigned_to_id = '';
		if (!empty($_POST['assigned_to_id'])) {
			$assigned_to_id = implode(", ",$_POST['assigned_to_id']);
			mysqli_query( $conn,"UPDATE tbl_services set assigned_to_id='". $assigned_to_id ."', last_modified='". $last_modified ."' WHERE ID='". $ID ."'" );
		}

		$type = '';
		if (!empty($_POST['type'])) {
			$type = $_POST['type'];
			mysqli_query( $conn,"UPDATE tbl_services set type='". $type ."', last_modified='". $last_modified ."' WHERE ID='". $ID ."'" );
		}

		$selectData = mysqli_query( $conn,"SELECT * FROM tbl_services WHERE ID = $ID" );
		if ( mysqli_num_rows($selectData) > 0 ) {
            $row = mysqli_fetch_array($selectData);
            $c_name = $row['name'];
            $title = $row['title'];
            $description = $row['description'];
            $contact = $row['contact'];
            $email = $row['email'];
            $due_date = $row['due_date'];
            $last_modified = $row['last_modified'];

            $data_category_id = $row["category"];
            $data_category = array(
                0 => 'Others',
                1 => 'IT Services',
                2 => 'Technical Services',
                3 => 'Sales',
                4 => 'Request Demo',
                5 => 'Suggestion',
                6 => 'Problem',
                7 => 'Praise'
            );

            $status_id = $row["type"];
            $status = array(
                0 => '<span class="label label-sm label-info">Assigned</span>',
                1 => '<span class="label label-sm label-primary">On Queue</span>',
                2 => '<span class="label label-sm label-warning">On Going</span>',
                3 => '<span class="label label-sm label-success">Fixed</span>',
                4 => '<span class="label label-sm label-danger">Unresolved</span>'
            );

            $files = $row['files'];
			if (!empty($files)) {
	            $fileExtension = fileExtension($files);
				$src = $fileExtension['src'];
				$embed = $fileExtension['embed'];
				$type = $fileExtension['type'];
				$file_extension = $fileExtension['file_extension'];
	            $url = $base_url.'uploads/services/';
	            $files = 'File: <a data-src="'.$src.$url.rawurlencode($files).$embed.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a>';
	        }

			$output = array(
				'ID' => $ID,
				'category' => $data_category[$data_category_id],
				'title' => $title,
				'description' => $description,
				'files' => $files,
				'contact' => $contact,
				'email' => $email,
				'due_date' => $due_date,
				'last_modified' => $last_modified,
				'status' => empty($row["assigned_to_id"]) ? 'Pending':$status[$status_id]
			);
			echo json_encode($output);

			if (!empty($assigned_to_id) AND $assigned_to_id != $rowDataTemp_assigned_to_id) {
				$from = 'services@interlinkiq.com';
				$name = 'InterlinkIQ';

	        	$to = $email;
	        	$user = '';
				$subject = 'Job Ticket Tracker #'.$ID.' - '.$title;
                $body = 'Hi, '.$c_name.'!<br><br>

				Your service request has been assigned to our team. Kindly wait for the next update.<br><br>

				Should you need assistance, kindly call 202-982-3002 or email <a href="mailto:'.$from.'" target="_blank">'.$from.'</a><br><br>
				
				InterlinkIQ.com Team<br>
				Consultare Inc. Group';

				php_mailer_1($to, $user, $subject, $body, $from, $name);

				$assigned_to_id_arr = explode(", ", $assigned_to_id);
				foreach ($assigned_to_id_arr as $value) {
					$selectEmployee = mysqli_query( $conn,"SELECT * FROM tbl_hr_employee WHERE ID=$value" );
                    if ( mysqli_num_rows($selectEmployee) > 0 ) {
                    	$rowEmp = mysqli_fetch_array($selectEmployee);

                    	$to = $rowEmp['email'];
                    	$user = $rowEmp['first_name'] .' '. $rowEmp['last_name'];
						$subject = 'Job Ticket Tracker #'.$ID.' - '.$title;
						$body = 'Hi '. $user .',<br><br>

						<b>Description:</b> '.$description.'<br>
						<b>Contact:</b> '.$contact.'<br>
						<b>Email:</b> '.$email.'<br><br>

						Should you need assistance, kindly call 202-982-3002 or email <a href="mailto:'.$from.'" target="_blank">'.$from.'</a><br><br>
						
						InterlinkIQ.com Team<br>
						Consultare Inc. Group';

						php_mailer_2($to, $user, $subject, $body, $from, $name);
                    }
				}
			}
        }

		mysqli_close($conn);
	}


	// PRODUCT PAGE
	if( isset($_GET['modalView_Products']) ) {
        $id = $_GET['modalView_Products'];
        $allergen = array();

        $selectData = mysqli_query( $conn,"SELECT * FROM tbl_products WHERE ID = $id" );
        if ( mysqli_num_rows($selectData) > 0 ) {
            $row = mysqli_fetch_array($selectData);
            $data_image = $row['image'];
            $data_image_array = explode(", ", $data_image);
            $image_main = "https://via.placeholder.com/400x250/EFEFEF/AAAAAA.png?text=Main+Product+View";
            $image_angle = "https://via.placeholder.com/120x90/EFEFEF/AAAAAA.png?text=No+Image";

            $allergen = explode(", ", $row["allergen"]);
        }

        echo '<div class="tabbable tabbable-tabdrop">
            <input class="form-control" type="hidden" name="ID" value="'. $row['ID'] .'" />
            <ul class="nav nav-tabs">
                <li class="active">
                    <a href="#tabBasic2" data-toggle="tab">Basic Details</a>
                </li>
                <li>
                    <a href="#tabProductDescription2" data-toggle="tab">Product Characteristics</a>
                </li>
                <li>
                    <a href="#tabAllergens2" data-toggle="tab">Allergens</a>
                </li>
                <li>
                    <a href="#tabDimensions2" data-toggle="tab">Dimensions</a>
                </li>
                <li>
                    <a href="#tabStorage2" data-toggle="tab">Storage & Distribution</a>
                </li>
                <li>
                    <a href="#tabManufacturing2" data-toggle="tab">Manufacturing Details</a>
                </li>
                <li>
                    <a href="#tabExercises2" data-toggle="tab">Exercises</a>
                </li>
                <li>
                    <a href="#tabDocuments2" data-toggle="tab">Documents</a>
                </li>
                <li>
                    <a href="#tabLabs2" data-toggle="tab">Labs</a>
                </li>
                <li class="hide">
                    <a href="#tabLabel2" data-toggle="tab">Label</a>
                </li>
                <li class="hide">
                    <a href="#tabFormulation2" data-toggle="tab">Formulation</a>
                </li>
                <li class="hide">
                    <a href="#modalService" data-toggle="modal">FFVA</a>
                </li>
            </ul>
            <div class="tab-content margin-top-20">
                <div class="tab-pane active" id="tabBasic2">
                    <h4><strong>Basic Details</strong></h4>
                    <div class="row margin-bottom-20">
                        <div class="col-md-6 productMain">
                            <p><strong>Main Product View</strong></p>
                            <div class="fileinput fileinput-new" data-provides="fileinput">
                                <div class="fileinput-new thumbnail">';

                                    if (!empty($data_image_array[0])) {
                                        echo '<img src="'. $base_url .'uploads/products/'. $data_image_array[0] .'" class="img-responsive" alt="Avatar" />';
                                    } else {
                                        echo '<img src="'. $image_main .'" class="img-responsive" alt="Avatar" />';
                                    }

                                echo '</div>
                                <div class="fileinput-preview fileinput-exists thumbnail"></div>
                                <div>
                                    <span class="btn default btn-file btn-xs">
                                        <span class="fileinput-new"> Select image </span>
                                        <span class="fileinput-exists"> Change </span>
                                        <input class="form-control" type="file" name="image_main" accept="image/png,image/PNG,image/jpg,image/jpeg" />
                                    </span>
                                    <a href="javascript:;" class="btn default fileinput-exists btn-xs" data-dismiss="fileinput"> Remove </a>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 productAngle">
                            <div class="row">
                                <div class="col-sm-4">
                                    <p><strong>Top View</strong></p>
                                    <div class="fileinput fileinput-new" data-provides="fileinput">
                                        <div class="fileinput-new thumbnail">';

                                            if (!empty($data_image_array[1])) {
                                                echo '<img src="'. $base_url .'uploads/products/'. $data_image_array[1] .'" class="img-responsive" alt="Avatar" />';
                                            } else {
                                                echo '<img src="'. $image_angle .'" class="img-responsive" alt="Avatar" />';
                                            }

                                        echo '</div>
                                        <div class="fileinput-preview fileinput-exists thumbnail"></div>
                                        <div>
                                            <span class="btn default btn-file btn-xs">
                                                <span class="fileinput-new"> Select image </span>
                                                <span class="fileinput-exists"> Change </span>
                                                <input class="form-control" type="file" name="image_top" accept="image/png,image/PNG,image/jpg,image/jpeg" />
                                            </span>
                                            <a href="javascript:;" class="btn default fileinput-exists btn-xs" data-dismiss="fileinput"> Remove </a>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-sm-4">
                                    <p><strong>Front View</strong></p>
                                    <div class="fileinput fileinput-new" data-provides="fileinput">
                                        <div class="fileinput-new thumbnail">';

                                            if (!empty($data_image_array[2])) {
                                                echo '<img src="'. $base_url .'uploads/products/'. $data_image_array[2] .'" class="img-responsive" alt="Avatar" />';
                                            } else {
                                                echo '<img src="'. $image_angle .'" class="img-responsive" alt="Avatar" />';
                                            }

                                        echo '</div>
                                        <div class="fileinput-preview fileinput-exists thumbnail"></div>
                                        <div>
                                            <span class="btn default btn-file btn-xs">
                                                <span class="fileinput-new"> Select image </span>
                                                <span class="fileinput-exists"> Change </span>
                                                <input class="form-control" type="file" name="image_front" accept="image/png,image/PNG,image/jpg,image/jpeg" />
                                            </span>
                                            <a href="javascript:;" class="btn default fileinput-exists btn-xs" data-dismiss="fileinput"> Remove </a>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-sm-4">
                                    <p><strong>Left View</strong></p>
                                    <div class="fileinput fileinput-new" data-provides="fileinput">
                                        <div class="fileinput-new thumbnail">';

                                            if (!empty($data_image_array[3])) {
                                                echo '<img src="'. $base_url .'uploads/products/'. $data_image_array[3] .'" class="img-responsive" alt="Avatar" />';
                                            } else {
                                                echo '<img src="'. $image_angle .'" class="img-responsive" alt="Avatar" />';
                                            }

                                        echo '</div>
                                        <div class="fileinput-preview fileinput-exists thumbnail"></div>
                                        <div>
                                            <span class="btn default btn-file btn-xs">
                                                <span class="fileinput-new"> Select image </span>
                                                <span class="fileinput-exists"> Change </span>
                                                <input class="form-control" type="file" name="image_left" accept="image/png,image/PNG,image/jpg,image/jpeg" />
                                            </span>
                                            <a href="javascript:;" class="btn default fileinput-exists btn-xs" data-dismiss="fileinput"> Remove </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row margin-top-20">
                                <div class="col-sm-4">
                                    <p><strong>Bottom View</strong></p>
                                    <div class="fileinput fileinput-new" data-provides="fileinput">
                                        <div class="fileinput-new thumbnail">';

                                            if (!empty($data_image_array[4])) {
                                                echo '<img src="'. $base_url .'uploads/products/'. $data_image_array[4] .'" class="img-responsive" alt="Avatar" />';
                                            } else {
                                                echo '<img src="'. $image_angle .'" class="img-responsive" alt="Avatar" />';
                                            }

                                        echo '</div>
                                        <div class="fileinput-preview fileinput-exists thumbnail"></div>
                                        <div>
                                            <span class="btn default btn-file btn-xs">
                                                <span class="fileinput-new"> Select image </span>
                                                <span class="fileinput-exists"> Change </span>
                                                <input class="form-control" type="file" name="image_bottom" accept="image/png,image/PNG,image/jpg,image/jpeg" />
                                            </span>
                                            <a href="javascript:;" class="btn default fileinput-exists btn-xs" data-dismiss="fileinput"> Remove </a>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-sm-4">
                                    <p><strong>Back View</strong></p>
                                    <div class="fileinput fileinput-new" data-provides="fileinput">
                                        <div class="fileinput-new thumbnail">';

                                            if (!empty($data_image_array[5])) {
                                                echo '<img src="'. $base_url .'uploads/products/'. $data_image_array[5] .'" class="img-responsive" alt="Avatar" />';
                                            } else {
                                                echo '<img src="'. $image_angle .'" class="img-responsive" alt="Avatar" />';
                                            }

                                        echo '</div>
                                        <div class="fileinput-preview fileinput-exists thumbnail"></div>
                                        <div>
                                            <span class="btn default btn-file btn-xs">
                                                <span class="fileinput-new"> Select image </span>
                                                <span class="fileinput-exists"> Change </span>
                                                <input class="form-control" type="file" name="image_back" accept="image/png,image/PNG,image/jpg,image/jpeg" />
                                            </span>
                                            <a href="javascript:;" class="btn default fileinput-exists btn-xs" data-dismiss="fileinput"> Remove </a>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-sm-4">
                                    <p><strong>Right View</strong></p>
                                    <div class="fileinput fileinput-new" data-provides="fileinput">
                                        <div class="fileinput-new thumbnail">';

                                            if (!empty($data_image_array[6])) {
                                                echo '<img src="'. $base_url .'uploads/products/'. $data_image_array[6] .'" class="img-responsive" alt="Avatar" />';
                                            } else {
                                                echo '<img src="'. $image_angle .'" class="img-responsive" alt="Avatar" />';
                                            }

                                        echo '</div>
                                        <div class="fileinput-preview fileinput-exists thumbnail"></div>
                                        <div>
                                            <span class="btn default btn-file btn-xs">
                                                <span class="fileinput-new"> Select image </span>
                                                <span class="fileinput-exists"> Change </span>
                                                <input class="form-control" type="file" name="image_right" accept="image/png,image/PNG,image/jpg,image/jpeg" />
                                            </span>
                                            <a href="javascript:;" class="btn default fileinput-exists btn-xs" data-dismiss="fileinput"> Remove </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row margin-top-20">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label class="control-label">Labeling Instructions</label>
                                <textarea class="form-control" name="labeling_instructions" row="3" placeholder="Add labeling instructions">'. ($row['labeling_instructions'] ?? '') .'</textarea>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="control-label">Product Code</label>
                                <input class="form-control" type="text" name="code" value="'. ($row['code'] ?? '') .'" placeholder="Enter product code" />
                            </div>
                        </div>
                        <div class="col-md-9">
                            <div class="form-group">
                                <label class="control-label">Product Name</label>
                                <input class="form-control" type="text" name="name" value="'. ($row['name'] ?? '') .'" required placeholder="Enter product name" />
                            </div>
                        </div>';

                        $supplierData = $conn->query("SELECT ID,name,vendor_code FROM tbl_supplier WHERE page = 2 AND user_id=".$row['user_id'] . "  AND is_deleted = 0 ORDER BY name ASC");
                        $supplierInfo = [];
                        if($supplierData->num_rows) while($sr = $supplierData->fetch_assoc()) {
                            $supplierInfo[] = $sr;
                        }

                        echo '<div class="col-md-3">
                            <div class="form-group">
                                <label class="control-label">Vendor Code</label>
                                <select class="form-control" name="vendor_code" disabled title="Automatically set when selecting a vendor name">
                                    <option value="" selected disabled>--Select--</option>';
                                    foreach($supplierInfo as $s) echo '<option value="'.$s['ID'].'" '.($s['ID'] == $row['vendor_name'] || $s['ID'] == $row['vendor_code'] ? 'selected' : '' ).'>'.(isset($s['vendor_code']) ? $s['vendor_code'] : 'No vendor code').'</option>';
                                    echo '
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="control-label">Vendor Name</label>
                                <select class="form-control" name="vendor_name" id="supplierNameSelectEdit">
                                    <option value="" selected disabled>--Select--</option>';
                                    foreach($supplierInfo as $s) echo '<option value="'.$s['ID'].'">'.$s['name'].'</option>';
                                    echo '
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="control-label">Product Category</label>
                                <select class="form-control" name="category" required onchange="evaluateManufacturingDetails(event)">
                                    <option value="" selected disabled>--Select category--</option>';

                                    $selectProductCategory = mysqli_query( $conn,"SELECT * FROM tbl_products_category ORDER BY name" );
                                    if ( mysqli_num_rows($selectProductCategory) > 0 ) {
                                        while($rowPC = mysqli_fetch_array($selectProductCategory)) {
                                            $pc_ID = $rowPC['ID'];
                                            $pc_name = $rowPC['name'];

                                            if ($row['category'] == $pc_ID) {
                                                echo '<option value="'. $pc_ID .'" SELECTED>'. $pc_name .'</option>';
                                            } else {
                                                echo '<option value="'. $pc_ID .'">'. $pc_name .'</option>';
                                            }
                                            
                                        }
                                    }

                                echo '</select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="control-label">(Specify if other)</label>
                                <input class="form-control" type="text" name="category_other" value="'. ($row['category_other'] ?? '') .'" />
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="control-label">Description</label>
                                <textarea class="form-control" name="description" required>'. ($row['description'] ?? '') .'</textarea>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="control-label">Ingredient List</label>
                                <textarea class="form-control" name="ingredient" required>'. ($row['ingredient'] ?? '') .'</textarea>
                            </div>
                        </div>
                    </div>

                    <h4><strong>Packaging Details</strong></h4>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="control-label">Primary/Unit</label>
                                <input class="form-control" type="text" name="packaging_1" value="'.($row['packaging_1'] ?? '').'" placeholder="Enter primary/unit packaging" />
                            </div>
                            <div class="form-group">
                                <label class="control-label">Secondary/Case</label>
                                <input class="form-control" type="text" name="packaging_2" value="'.($row['packaging_2'] ?? '').'" placeholder="Enter secondary/case packaging"  />
                            </div>
                            <div class="form-group">
                                <label class="control-label">Tertiary/Master Pack</label>
                                <input class="form-control" type="text" name="packaging_3" value="'.($row['packaging_3'] ?? '').'" placeholder="Enter tertiary/master pack packaging" />
                            </div>
                            <div class="form-group">
                                <label class="control-label">Packaging Temperature</label>
                                <input class="form-control" type="text" name="packaging_temperature" placeholder="Enter packaging temperature" value="'.($row['packaging_temperature'] ?? '').'" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="control-label">Intended Use</label>
                                <select class="form-control" name="intended">
                                    <option value="0" selected disabled>--Select intended use--</option>';

                                    $selectIntended = mysqli_query( $conn,"SELECT * FROM tbl_products_intended WHERE deleted = 0 ORDER BY name" );
                                    if ( mysqli_num_rows($selectIntended) > 0 ) {
                                        while($rowIntended = mysqli_fetch_array($selectIntended)) {
                                            $intended_ID = $rowIntended["ID"];
                                            $intended_name = $rowIntended["name"];

                                            echo '<option value="'.$intended_ID.'" '; echo $row['intended'] == $intended_ID ? 'SELECTED':''; echo '>'.$intended_name.'</option>';
                                        }
                                    }

                                echo '</select>
                            </div>
                            <div class="form-group">
                                <label class="control-label">Intended Consumers</label>
                                <input class="form-control" type="text" name="intended_consumers" placeholder="Enter intended consumers" value="'.($row['intended_consumers'] ?? '').'" />
                            </div>
                            <div class="form-group">
                                <label>Product Claims</label>
                                <div class="mt-checkbox-list" style="column-count: 3;">';

                                    $claims_array = explode(", ", $row["claims"]);
                                    $selectClaims = mysqli_query( $conn,"SELECT * FROM tbl_products_claims WHERE deleted = 0 ORDER BY name" );
                                    if ( mysqli_num_rows($selectClaims) > 0 ) {
                                        while($rowClaims = mysqli_fetch_array($selectClaims)) {
                                            $claims_ID = $rowClaims["ID"];
                                            $claims_name = $rowClaims["name"];

                                            echo '<label class="mt-checkbox mt-checkbox-outline"> '.$claims_name.'
                                                <input type="checkbox" value="'.$claims_ID.'" name="claims[]" '; echo in_array($claims_ID, $claims_array) ? 'checked' : ''; echo '>
                                                <span></span>
                                            </label>';
                                        }
                                    }

                                echo '</div>
                            </div>
                        </div>
                    </div>

                    <div class="row hide">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label class="control-label">Packaging Material List</label>
                                <textarea class="form-control" name="material">'. ($row['material'] ?? '') .'</textarea>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="tab-pane" id="tabAllergens2">
                    <h4><strong>Allergens</strong></h4>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <div class="mt-checkbox-list">
                                    <label class="mt-checkbox mt-checkbox-outline"> Milk
                                        <input type="checkbox" value="1" name="allergen[]" '; echo in_array(1, $allergen) ? 'checked' : ''; echo '/>
                                        <span></span>
                                    </label>
                                    <label class="mt-checkbox mt-checkbox-outline"> Eggs
                                        <input type="checkbox" value="2" name="allergen[]" '; echo in_array(2, $allergen) ? 'checked' : ''; echo '/>
                                        <span></span>
                                    </label>
                                    <label class="mt-checkbox mt-checkbox-outline"> Fish (e.g., bass, flounder, cod)
                                        <input type="checkbox" value="3" name="allergen[]" '; echo in_array(3, $allergen) ? 'checked' : ''; echo '/>
                                        <span></span>
                                    </label>
                                    <label class="mt-checkbox mt-checkbox-outline"> Crustacean shellfish (e.g., crab, lobster, shrimp)
                                        <input type="checkbox" value="4" name="allergen[]" '; echo in_array(4, $allergen) ? 'checked' : ''; echo '/>
                                        <span></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <div class="mt-checkbox-list">
                                    <label class="mt-checkbox mt-checkbox-outline"> Tree nuts (e.g., almonds, walnuts, pecans)
                                        <input type="checkbox" value="5" name="allergen[]" '; echo in_array(5, $allergen) ? 'checked' : ''; echo '/>
                                        <span></span>
                                    </label>
                                    <label class="mt-checkbox mt-checkbox-outline"> Peanuts
                                        <input type="checkbox" value="6" name="allergen[]" '; echo in_array(6, $allergen) ? 'checked' : ''; echo '/>
                                        <span></span>
                                    </label>
                                    <label class="mt-checkbox mt-checkbox-outline"> Wheat
                                        <input type="checkbox" value="7" name="allergen[]" '; echo in_array(7, $allergen) ? 'checked' : ''; echo '/>
                                        <span></span>
                                    </label>
                                    <label class="mt-checkbox mt-checkbox-outline"> Soybeans
                                        <input type="checkbox" value="8" name="allergen[]" '; echo in_array(8, $allergen) ? 'checked' : ''; echo '/>
                                        <span></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <div class="mt-checkbox-list">
                                    <label class="mt-checkbox mt-checkbox-outline"> Sesame
                                        <input type="checkbox" value="9" name="allergen[]" '; echo in_array(9, $allergen) ? 'checked' : ''; echo '/>
                                        <span></span>
                                    </label>
                                    <label class="mt-checkbox mt-checkbox-outline"> None
                                        <input type="checkbox" value="10" name="allergen[]" '; echo in_array(10, $allergen) ? 'checked' : ''; echo '/>
                                        <span></span>
                                    </label>
                                    <label class="mt-checkbox mt-checkbox-outline"> Other
                                        <input type="checkbox" value="11" name="allergen[]" '; echo in_array(11, $allergen) ? 'checked' : ''; echo '/>
                                        <span></span>
                                    </label>
                                </div>
                                <input class="form-control" type="text" name="allergen_other" placeholder="(Specify if Other)" value="'.$row['allergen_other'].'" />
                            </div>
                        </div>
                    </div>
                </div>
                <div class="tab-pane" id="tabDimensions2">
                    <h4><strong>Dimensions</strong></h4>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="control-label">Unit Dimension/s</label>
                                <input class="form-control" type="text" name="unit" value="'. ($row['unit'] ?? '') .'" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="control-label">Box Dimension/s</label>
                                <input class="form-control" type="text" name="boxes" value="'. ($row['boxes'] ?? '') .'" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="control-label">Pallet Dimension/s</label>
                                <input class="form-control" type="text" name="pallet" value="'. ($row['pallet'] ?? '') .'" />
                            </div>
                        </div>
                    </div>

                    <h4><strong>Count</strong></h4>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="control-label">How many units per carton/box?</label>
                                <input class="form-control" type="text" name="count_unit_box" value="'. ($row['count_unit_box'] ?? '') .'" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="control-label">How many units per pallet?</label>
                                <input class="form-control" type="text" name="count_unit_pallet" value="'. ($row['count_unit_pallet'] ?? '') .'" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="control-label">How many carton/box per pallet?</label>
                                <input class="form-control" type="text" name="count_unit_carton" value="'. ($row['count_unit_carton'] ?? '') .'" />
                            </div>
                        </div>
                    </div>
                </div>
                <div class="tab-pane" id="tabStorage2">
                    <h4><strong>Storage</strong></h4>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="control-label">Shelf Life</label>
                                <input class="form-control" type="text" name="shelf" value="'. ($row['shelf'] ?? '') .'" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="control-label">Storage and Handling Requirement</label>
                                <input class="form-control" type="text" name="storage" value="'. ($row['storage'] ?? '') .'" />
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="control-label">Storage/Warehouse</label>
                                <input class="form-control" type="text" name="warehouse" value="'. ($row['warehouse'] ?? '') .'" />
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="control-label">UPC Code</label>
                                <input class="form-control" type="text" name="upc" value="'. ($row['upc'] ?? '').'" />
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="control-label">GTIN Number</label>
                                <input class="form-control" type="text" name="gtin" value="'. ($row['gtin'] ?? '') .'" />
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="control-label">Lead Time</label>
                                <input class="form-control" type="text" name="lead" value="'. ($row['lead_time'] ?? '') .'" />
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="control-label">Minimum Order Quantity</label>
                                <input class="form-control" type="text" name="moq" value="'. ($row['moq'] ?? '').'" />
                            </div>
                        </div>
                    </div>

                    <h4><strong>Distribution</strong></h4>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Type of Distribution</label>
                                <div class="mt-radio-inline">
                                    <label class="mt-radio mt-radio-outline">
                                        <input type="radio" name="export" value="0" '; echo $row['export']==0 ? 'checked':''; echo '> Local
                                        <span></span>
                                    </label>
                                    <label class="mt-radio mt-radio-outline">
                                        <input type="radio" name="export" value="1" '; echo $row['export']==1 ? 'checked':''; echo '> International
                                        <span></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div class="form-group">
                                <label class="control-label">Specify the country</label>
                                <textarea class="form-control" name="countries">'. ($row['countries'] ?? '') .'</textarea>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="tab-pane" id="tabManufacturing2">
                    <h4><strong>Manufacturing Details</strong></h4>
                    <div class="row '.(!in_array($row['category'], [27,28,29,30]) ? '' : 'hide').'" data-manufacturing-details="default">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="control-label">Manufactured by</label>
                                <input class="form-control" type="text" name="manufactured_by" value="'. ($row['manufactured_by'] ?? '') .'" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="control-label">Manufactured for</label>
                                <input class="form-control" type="text" name="manufactured_for" value="'. ($row['manufactured_for'] ?? '') .'" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="control-label">Distributed by</label>
                                <input class="form-control" type="text" name="distributed_by" value="'. ($row['distributed_by'] ?? '') .'" />
                            </div>
                        </div>
                    </div>
                    <div class="row '.(in_array($row['category'], [27,28]) ? '' : 'hide').'" data-manufacturing-details="[27,28]">
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="control-label">Enterprise Name</label>
                                <!-- mb = *manufactured/distributed* -->
                                <input class="form-control" type="text" name="mb_enterprise_name" value="'. ($row['mb_enterprise_name'] ?? '') .'" />
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="control-label">Lot Code</label>
                                <input class="form-control" type="text" name="mb_lot_code" value="'. ($row['mb_lot_code'] ?? '') .'" />
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="control-label">Manufactured Date</label>
                                <input class="form-control" type="date" name="mb_manufactured_date" value="'. ($row['mb_manufactured_date'] ?? '') .'" />
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="control-label">Expiry Date</label>
                                <input class="form-control" type="date" name="mb_expiry_date" value="'. ($row['mb_expiry_date'] ?? '') .'" />
                            </div>
                        </div>
                    </div>
                    <div class="row '.(in_array($row['category'], [29]) ? '' : 'hide').'" data-manufacturing-details="[29]">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="control-label">Supplier Name</label>
                                <input class="form-control" type="text" name="traded_supplier_name" value="'. ($row['traded_supplier_name'] ?? '') .'" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="control-label">Supplied for</label>
                                <input class="form-control" type="text" name="traded_supplied_for" value="'. ($row['traded_supplied_for'] ?? '') .'" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="control-label">Supplier-issued Lot Code</label>
                                <input class="form-control" type="text" name="traded_supplied_lot_code" value="'. ($row['traded_supplied_lot_code'] ?? '') .'" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="control-label">Manufactured Date</label>
                                <input class="form-control" type="date" name="traded_manufactured_date" value="'. ($row['traded_manufactured_date'] ?? '') .'" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="control-label">Expiry Date</label>
                                <input class="form-control" type="date" name="traded_expiry_date" value="'. ($row['traded_expiry_date'] ?? '') .'" />
                            </div>
                        </div>
                    </div>
                    <div class="row '.(in_array($row['category'], [30]) ? '' : 'hide').'" data-manufacturing-details="[30]">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="control-label">Manufactured by</label>
                                <input class="form-control" type="text" name="branded_manufactured_by" value="'. ($row['branded_manufactured_by'] ?? '') .'" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="control-label">Manufactured for</label>
                                <input class="form-control" type="text" name="branded_manufactured_for" value="'. ($row['branded_manufactured_for'] ?? '') .'" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="control-label">Manufactured Date</label>
                                <input class="form-control" type="date" name="branded_manufactured_date" value="'. ($row['branded_manufactured_date'] ?? '') .'" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="control-label">Expiry Date</label>
                                <input class="form-control" type="date" name="branded_expiry_date" value="'. ($row['branded_expiry_date'] ?? '') .'" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="control-label">Lot Code assigned by Manufacturer</label>
                                <input class="form-control" type="text" name="branded_lot_code_by_manufacturer" value="'. ($row['branded_lot_code_by_manufacturer'] ?? '') .'" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="control-label">Lot code assigned by Enterprise</label>
                                <input class="form-control" type="text" name="branded_lot_code_by_enterprise" value="'. ($row['branded_lot_code_by_enterprise'] ?? '') .'" />
                            </div>
                        </div>
                    </div>
                    <h4><strong>Receiving Details</strong></h4>
                    <div class="row">';

                        $countriesArr = [];
                        $countriesResult = $conn->query("SELECT iso2,name FROM countries");
                        if($countriesResult->num_rows) while($r = $countriesResult->fetch_assoc()) {
                            $countriesArr[] = $r;
                        }

                        echo '<div class="col-md-4">
                            <div class="form-group">
                                <label class="control-label">Country of Purchase</label>
                                <select class="form-control" name="country_of_purchase">
                                    <option value="" selected disabled>--Select--</option>';
                                    foreach($countriesArr as $c) {
                                        echo '<option value="'.$c['iso2'].'" '.($row['country_of_purchase'] == $c['iso2'] ? 'selected' : '').'>'.$c['name'].'</option>';
                                    }
                                echo '</select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="control-label">Country of Origin</label>
                                <select class="form-control" name="country_of_origin">
                                    <option value="" selected disabled>--Select--</option>';
                                    foreach($countriesArr as $c) {
                                        echo '<option value="'.$c['iso2'].'" '.($row['country_of_origin'] == $c['iso2'] ? 'selected' : '').'>'.$c['name'].'</option>';
                                    }

                                echo '</select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="control-label">Delivered from</label>
                                <select class="form-control" name="delivered_from">
                                    <option value="" selected disabled>--Select--</option>';
                                    
                                    foreach($countriesArr as $c) {
                                        echo '<option value="'.$c['iso2'].'" '.($row['delivered_from'] == $c['iso2'] ? 'selected' : '').'>'.$c['name'].'</option>';
                                    }

                                echo '</select>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="tab-pane" id="tabProductDescription2">
                    <h4><strong>Product Description, including Important Food Safety Characteristics</strong></h4>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="control-label">Organoleptic/Sensory Characteristics</label>
                                <div class="chars-container">';
                                    $data = json_decode($row['physical_characteristics']) ?? null;
                                    if(isset($data) && is_array($data)) foreach($data as $v) {
                                        echo '<div class="chars-template margin-bottom-10" style="display:flex; align-items:center; gap:1rem;">
                                            <input type="text" name="physical_chars[]" class="form-control" style="flex-grow:1;" placeholder="e.g. Color, Flavor, Texture, Form" value="'.$v.'" />
                                            <button type="button" class="btn btn-danger" onclick="deleteChar(this)"><i class="fa fa-close"></i></button>
                                        </div>';
                                    } else {
                                        echo '<div class="chars-template margin-bottom-10" style="display:flex; align-items:center; gap:1rem;">
                                            <input type="text" name="physical_chars[]" class="form-control" style="flex-grow:1;" placeholder="e.g. Color, Flavor, Texture, Form" />
                                            <button type="button" class="btn btn-danger" onclick="deleteChar(this)"><i class="fa fa-close"></i></button>
                                        </div>';
                                    }
                                echo '</div>
                                <button type="button" class="btn btn-sm btn-link margin-top-10" data-name="physical_chars[]" data-placeholder="e.g. Color, Flavor, Texture, Form" onclick="addMoreChars(this)">
                                    <i class="fa fa-plus"></i> Add more
                                </button>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="control-label">Physico - Chemical Characteristics</label>
                                <div class="chars-container">';
                                    $data = json_decode($row['physico_chemical_characteristics']) ?? null;
                                    if(isset($data) && is_array($data)) foreach($data as $v) {
                                        echo '<div class="chars-template margin-bottom-10" style="display:flex; align-items:center; gap:1rem;">
                                            <input type="text" name="physico_chem_char[]" class="form-control" style="flex-grow:1;" placeholder="e.g. Moisture/Fat/Ash%, Brix, etc." value="'.$v.'" />
                                            <button type="button" class="btn btn-danger" onclick="deleteChar(this)"><i class="fa fa-close"></i></button>
                                        </div>';
                                    } else {
                                        echo '<div class="chars-template margin-bottom-10" style="display:flex; align-items:center; gap:1rem;">
                                            <input type="text" name="physico_chem_char[]" class="form-control" style="flex-grow:1;" placeholder="e.g. Moisture/Fat/Ash%, Brix, etc." />
                                            <button type="button" class="btn btn-danger" onclick="deleteChar(this)"><i class="fa fa-close"></i></button>
                                        </div>';
                                    }
                                echo '</div>
                                <button type="button" class="btn btn-sm btn-link margin-top-10" data-name="physico_chem_char[]" data-placeholder="e.g. Moisture/Fat/Ash%, Brix, etc." onclick="addMoreChars(this)">
                                    <i class="fa fa-plus"></i> Add more
                                </button>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="control-label">Microbiological Characteristics</label>
                                <div class="chars-container">';
                                    $data = json_decode($row['microbiological_characteristics']) ?? null;
                                    if(isset($data) && is_array($data)) foreach($data as $v) {
                                        echo '<div class="chars-template margin-bottom-10" style="display:flex; align-items:center; gap:1rem;">
                                            <input type="text" name="microbial_char[]" class="form-control" style="flex-grow:1;" placeholder="e.g. E.coli, Salmonella, Coliform, APC/TPC, Y&M, Listeria" value="'.$v.'" />
                                            <button type="button" class="btn btn-danger" onclick="deleteChar(this)"><i class="fa fa-close"></i></button>
                                        </div>';
                                    } else {
                                        echo '<div class="chars-template margin-bottom-10" style="display:flex; align-items:center; gap:1rem;">
                                            <input type="text" name="microbial_char[]" class="form-control" style="flex-grow:1;" placeholder="e.g. E.coli, Salmonella, Coliform, APC/TPC, Y&M, Listeria" />
                                            <button type="button" class="btn btn-danger" onclick="deleteChar(this)"><i class="fa fa-close"></i></button>
                                        </div>';
                                    }
                                echo '</div>
                                <button type="button" class="btn btn-sm btn-link margin-top-10" data-name="microbial_char[]" data-placeholder="e.g. E.coli, Salmonella, Coliform, APC/TPC, Y&M, Listeria" onclick="addMoreChars(this)">
                                    <i class="fa fa-plus"></i> Add more
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="tab-pane" id="tabExercises2">
                    <h4><strong>Exercises</strong></h4>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="control-label">Mock Recall Exercise</label>
                                <input class="form-control" type="date" name="mock_recall" value="'. $row['mock_recall'] .'" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="control-label">Product Trace Exercise</label>
                                <input class="form-control" type="date" name="product_trace" value="'. $row['product_trace'] .'" />
                            </div>
                        </div>
                    </div>
                </div>
                <div class="tab-pane" id="tabDocuments2">
                    <h4><strong>Documents</strong></h4>';
                    
                    $url = $base_url.'uploads/products/';

                    $files = $row["specifcation"];
                    $fileExtension = fileExtension($files);
                    $src = $fileExtension['src'];
                    $embed = $fileExtension['embed'];
                    $type = $fileExtension['type'];
                    $file_extension = $fileExtension['file_extension'];
                    echo '<div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="control-label">Product Specification</label>
                                <input class="form-control '; echo !empty($files) ? 'hide':''; echo '" type="file" name="specifcation" />
                                <p class="'; echo !empty($files) ? '':'hide'; echo '" style="margin: 0;"><a href="'.$src.$url.rawurlencode($files).$embed.'" data-src="'.$src.$url.rawurlencode($files).$embed.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a> | <button type="button" class="btn btn-link uploadNew" onclick="uploadNew(this)">Upload New</button></p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="control-label">Due Date</label>
                                <input class="form-control" type="date" name="specifcation_date" value="'.$row['specifcation_date'].'" />
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="control-label">Share to Marketplace?</label>
                                <div class="mt-radio-inline">
                                    <label class="mt-radio mt-radio-outline"> No
                                        <input type="radio" value="0" name="specifcation_radio" '; echo $row['specifcation_radio']==0 ? 'checked':''; echo ' />
                                        <span></span>
                                    </label>
                                    <label class="mt-radio mt-radio-outline"> Yes
                                        <input type="radio" value="1" name="specifcation_radio" '; echo $row['specifcation_radio']==1 ? 'checked':''; echo ' />
                                        <span></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>';

                    $files = $row["artwork"];
                    $fileExtension = fileExtension($files);
                    $src = $fileExtension['src'];
                    $embed = $fileExtension['embed'];
                    $type = $fileExtension['type'];
                    $file_extension = $fileExtension['file_extension'];
                    echo '<div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="control-label">Packaging Artwork</label>
                                <input class="form-control '; echo !empty($files) ? 'hide':''; echo '" type="file" name="artwork" />
                                <p class="'; echo !empty($files) ? '':'hide'; echo '" style="margin: 0;"><a href="'.$src.$url.rawurlencode($files).$embed.'" data-src="'.$src.$url.rawurlencode($files).$embed.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a> | <button type="button" class="btn btn-link uploadNew" onclick="uploadNew(this)">Upload New</button></p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="control-label">Due Date</label>
                                <input class="form-control" type="date" name="artwork_date" value="'.$row['artwork_date'].'" />
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="control-label">Share to Marketplace?</label>
                                <div class="mt-radio-inline">
                                    <label class="mt-radio mt-radio-outline"> No
                                        <input type="radio" value="0" name="artwork_radio" '; echo $row['artwork_radio']==0 ? 'checked':''; echo ' />
                                        <span></span>
                                    </label>
                                    <label class="mt-radio mt-radio-outline"> Yes
                                        <input type="radio" value="1" name="artwork_radio" '; echo $row['artwork_radio']==1 ? 'checked':''; echo ' />
                                        <span></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>';

                    $files = $row["haccp"];
                    $fileExtension = fileExtension($files);
                    $src = $fileExtension['src'];
                    $embed = $fileExtension['embed'];
                    $type = $fileExtension['type'];
                    $file_extension = $fileExtension['file_extension'];
                    echo '<div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="control-label">Food Safety Plan/HACCP</label>
                                <input class="form-control '; echo !empty($files) ? 'hide':''; echo '" type="file" name="haccp" />
                                <p class="'; echo !empty($files) ? '':'hide'; echo '" style="margin: 0;"><a href="'.$src.$url.rawurlencode($files).$embed.'" data-src="'.$src.$url.rawurlencode($files).$embed.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a> | <button type="button" class="btn btn-link uploadNew" onclick="uploadNew(this)">Upload New</button></p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="control-label">Due Date</label>
                                <input class="form-control" type="date" name="haccp_date" value="'.$row['haccp_date'].'" />
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="control-label">Share to Marketplace?</label>
                                <div class="mt-radio-inline">
                                    <label class="mt-radio mt-radio-outline"> No
                                        <input type="radio" value="0" name="haccp_radio" '; echo $row['haccp_radio']==0 ? 'checked':''; echo ' />
                                        <span></span>
                                    </label>
                                    <label class="mt-radio mt-radio-outline"> Yes
                                        <input type="radio" value="1" name="haccp_radio" '; echo $row['haccp_radio']==1 ? 'checked':''; echo ' />
                                        <span></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>';

                    $files = $row["label"];
                    $fileExtension = fileExtension($files);
                    $src = $fileExtension['src'];
                    $embed = $fileExtension['embed'];
                    $type = $fileExtension['type'];
                    $file_extension = $fileExtension['file_extension'];
                    echo '<div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="control-label">Label</label>
                                <input class="form-control '; echo !empty($files) ? 'hide':''; echo '" type="file" name="label" />
                                <p class="'; echo !empty($files) ? '':'hide'; echo '" style="margin: 0;"><a href="'.$src.$url.rawurlencode($files).$embed.'" data-src="'.$src.$url.rawurlencode($files).$embed.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a> | <button type="button" class="btn btn-link uploadNew" onclick="uploadNew(this)">Upload New</button></p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="control-label">Due Date</label>
                                <input class="form-control" type="date" name="label_date" value="'.$row['label_date'].'" />
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="control-label">Share to Marketplace?</label>
                                <div class="mt-radio-inline">
                                    <label class="mt-radio mt-radio-outline"> No
                                        <input type="radio" value="0" name="label_radio" '; echo $row['label_radio']==0 ? 'checked':''; echo ' />
                                        <span></span>
                                    </label>
                                    <label class="mt-radio mt-radio-outline"> Yes
                                        <input type="radio" value="1" name="label_radio" '; echo $row['label_radio']==1 ? 'checked':''; echo ' />
                                        <span></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>';

                    $files = $row["formulation"];
                    $fileExtension = fileExtension($files);
                    $src = $fileExtension['src'];
                    $embed = $fileExtension['embed'];
                    $type = $fileExtension['type'];
                    $file_extension = $fileExtension['file_extension'];
                    echo '<div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="control-label">Formulation</label>
                                <input class="form-control '; echo !empty($files) ? 'hide':''; echo '" type="file" name="formulation" />
                                <p class="'; echo !empty($files) ? '':'hide'; echo '" style="margin: 0;"><a href="'.$src.$url.rawurlencode($files).$embed.'" data-src="'.$src.$url.rawurlencode($files).$embed.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a> | <button type="button" class="btn btn-link uploadNew" onclick="uploadNew(this)">Upload New</button></p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="control-label">Due Date</label>
                                <input class="form-control" type="date" name="formulation_date" value="'.$row['formulation_date'].'" />
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="control-label">Share to Marketplace?</label>
                                <div class="mt-radio-inline">
                                    <label class="mt-radio mt-radio-outline"> No
                                        <input type="radio" value="0" name="formulation_radio" '; echo $row['formulation_radio']==0 ? 'checked':''; echo ' />
                                        <span></span>
                                    </label>
                                    <label class="mt-radio mt-radio-outline"> Yes
                                        <input type="radio" value="1" name="formulation_radio" '; echo $row['formulation_radio']==1 ? 'checked':''; echo ' />
                                        <span></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>';

                    echo '<div class="mt-repeater mt-repeater-docs">
                        <div data-repeater-list="docs">';

                            $docs = $row['docs'];
                            if (!empty($docs)) {
                                $output_docs = json_decode($docs,true);
                                $count_docs = count($output_docs);
                                if ($count_docs == 0) { $count_docs = 1; }
                            }

                            $docs_date_data = $row['docs_date'];
                            if (!empty($docs_date_data)) {
                                $docs_date = json_decode($docs_date_data,true);

                                if ($docs_date == NULL) { $docs_date_data = ''; }
                            }

                            if (!empty($output_docs)) {
                                echo '<div class="mt-repeater-item mt-repeater-item-hide row" data-repeater-item>
                                    <div class="col-lg-3">
                                        <div class="form-group">
                                            <label class="control-label">Document Name</label>
                                            <input class="form-control" type="text" name="docs_label" />
                                        </div>
                                    </div>
                                    <div class="col-lg-3">
                                        <div class="form-group">
                                            <label class="control-label">Document</label>
                                            <input class="form-control" type="file" name="docs_file" />
                                        </div>
                                    </div>
                                    <div class="col-lg-3">
                                        <div class="form-group">
                                            <label class="control-label">Date</label>
                                            <input class="form-control" type="date" name="docs_date" />
                                        </div>
                                    </div>
                                    <div class="col-lg-3">
                                        <div class="form-group">
                                            <label class="control-label">Share to Marketplace?</label>
                                            <div class="mt-radio-inline" style="position: relative;">
                                                <label class="mt-radio mt-radio-outline"> No
                                                    <input type="radio" value="0" name="docs_radio" checked />
                                                    <span></span>
                                                </label>
                                                <label class="mt-radio mt-radio-outline"> Yes
                                                    <input type="radio" value="1" name="docs_radio" />
                                                    <span></span>
                                                </label>
                                                <a href="javascript:;" data-repeater-delete class="btn btn-danger" style="position: absolute; right: 0; top: 0;"><i class="fa fa-close"></i></a>
                                            </div>
                                        </div>
                                    </div>
                                </div>';

                                foreach ($output_docs as $key => $value) {

                                    $files = $value['docs_file'];
                                    $fileExtension = fileExtension($files);
                                    $src = $fileExtension['src'];
                                    $embed = $fileExtension['embed'];
                                    $type = $fileExtension['type'];
                                    $file_extension = $fileExtension['file_extension'];

                                    echo '<div class="mt-repeater-item row" data-repeater-item>
                                        <div class="col-lg-3">
                                            <div class="form-group">
                                                <label class="control-label">Document Name</label>
                                                <input class="form-control" type="text" name="docs_label" value="'. $value['docs_label'] .'" />
                                            </div>
                                        </div>
                                        <div class="col-lg-3">
                                            <div class="form-group">
                                                <input type="hidden" name="docs_tmp" value="'.$value['docs_file'].'" />
                                                <label class="control-label">Document</label>
                                                <input class="form-control '; echo !empty($files) ? 'hide':''; echo '" type="file" name="docs_file" />
                                                <p class="'; echo !empty($files) ? '':'hide'; echo '" style="margin: 0;"><a href="'.$src.$url.rawurlencode($files).$embed.'" data-src="'.$src.$url.rawurlencode($files).$embed.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a> | <button type="button" class="btn btn-link uploadNew" onclick="uploadNew(this)">Upload New</button></p>
                                            </div>
                                        </div>
                                        <div class="col-lg-3">
                                            <div class="form-group">
                                                <label class="control-label">Date</label>
                                                <input class="form-control" type="date" name="docs_date" value="'; echo !empty($value['docs_date']) ? $value['docs_date']:''; echo '"/>
                                            </div>
                                        </div>
                                        <div class="col-lg-3">
                                            <div class="form-group">
                                                <label class="control-label">Share to Marketplace?</label>
                                                <div class="mt-radio-inline" style="position: relative;">
                                                    <label class="mt-radio mt-radio-outline"> No
                                                        <input type="radio" value="0" name="docs_radio" '; echo $value['docs_radio']==0 ? 'checked':''; echo ' />
                                                        <span></span>
                                                    </label>
                                                    <label class="mt-radio mt-radio-outline"> Yes
                                                        <input type="radio" value="1" name="docs_radio" '; echo $value['docs_radio']==1 ? 'checked':''; echo ' />
                                                        <span></span>
                                                    </label>
                                                    <a href="javascript:;" data-repeater-delete class="btn btn-danger" style="position: absolute; right: 0; top: 0;"><i class="fa fa-close"></i></a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>';
                                }
                            } else {
                                echo '
                                <div class="mt-repeater-item row" data-repeater-item>
                                    <div class="col-lg-3">
                                        <div class="form-group">
                                            <label class="control-label">Document Name</label>
                                            <input class="form-control" type="text" name="docs_label" />
                                        </div>
                                    </div>
                                    <div class="col-lg-3">
                                        <div class="form-group">
                                            <label class="control-label">Document</label>
                                            <input class="form-control" type="file" name="docs_file" />
                                        </div>
                                    </div>
                                    <div class="col-lg-3">
                                        <div class="form-group">
                                            <label class="control-label">Date</label>
                                            <input class="form-control" type="date" name="docs_date" />
                                        </div>
                                    </div>
                                    <div class="col-lg-3">
                                        <div class="form-group">
                                            <label class="control-label">Share to Marketplace?</label>
                                            <div class="mt-radio-inline" style="position: relative;">
                                                <label class="mt-radio mt-radio-outline"> No
                                                    <input type="radio" value="0" name="docs_radio" checked />
                                                    <span></span>
                                                </label>
                                                <label class="mt-radio mt-radio-outline"> Yes
                                                    <input type="radio" value="1" name="docs_radio" />
                                                    <span></span>
                                                </label>
                                                <a href="javascript:;" data-repeater-delete class="btn btn-danger" style="position: absolute; right: 0; top: 0;"><i class="fa fa-close"></i></a>
                                            </div>
                                        </div>
                                    </div>
                                </div>';
                            }
                            
                        echo '</div>
                        <a href="javascript:;" data-repeater-create class="btn btn-success mt-repeater-add btnEducation"><i class="fa fa-plus"></i> Add more Document</a>
                    </div>';

                    echo '<div class="row hidden">
                        <div class="col-md-8">
                            <div class="form-group">
                                <label class="control-label">Certificate of Origin</label>
                                <input class="form-control '; echo !empty($row['origin']) ? 'hide':''; echo '" type="file" name="origin" />
                                <p class="'; echo !empty($row['origin']) ? '':'hide'; echo '" style="margin: 0;"><a href="uploads/products/'.rawurlencode($row['origin']).'" target="_blank" class="btn btn-link">View</a> | <button type="button" class="btn btn-link uploadNew" onclick="uploadNew(this)">Upload New</button></p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="control-label">Share to Marketplace?</label>
                                <div class="mt-radio-inline">
                                    <label class="mt-radio mt-radio-outline"> No
                                        <input type="radio" value="0" name="origin_radio" '; echo $row['origin_radio']==0 ? 'checked':''; echo ' checked />
                                        <span></span>
                                    </label>
                                    <label class="mt-radio mt-radio-outline"> Yes
                                        <input type="radio" value="1" name="origin_radio" '; echo $row['origin_radio']==1 ? 'checked':''; echo ' />
                                        <span></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row hidden">
                        <div class="col-md-8">
                            <div class="form-group">
                                <label class="control-label">Finish Product Recall Procedures</label>
                                <input class="form-control '; echo !empty($row['procedures']) ? 'hide':''; echo '" type="file" name="procedures" />
                                <p class="'; echo !empty($row['procedures']) ? '':'hide'; echo '" style="margin: 0;"><a href="uploads/products/'.rawurlencode($row['procedures']).'" target="_blank" class="btn btn-link">View</a> | <button type="button" class="btn btn-link uploadNew" onclick="uploadNew(this)">Upload New</button></p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="control-label">Share to Marketplace?</label>
                                <div class="mt-radio-inline">
                                    <label class="mt-radio mt-radio-outline"> No
                                        <input type="radio" value="0" name="procedures_radio" '; echo $row['procedures_radio']==0 ? 'checked':''; echo ' checked />
                                        <span></span>
                                    </label>
                                    <label class="mt-radio mt-radio-outline"> Yes
                                        <input type="radio" value="1" name="procedures_radio" '; echo $row['procedures_radio']==1 ? 'checked':''; echo ' />
                                        <span></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row hidden">
                        <div class="col-md-8">
                            <div class="form-group">
                                <label class="control-label">Certificate of Analysis</label>
                                <input class="form-control '; echo !empty($row['analysis']) ? 'hide':''; echo '" type="file" name="analysis" />
                                <p class="'; echo !empty($row['analysis']) ? '':'hide'; echo '" style="margin: 0;"><a href="uploads/products/'.rawurlencode($row['analysis']).'" target="_blank" class="btn btn-link">View</a> | <button type="button" class="btn btn-link uploadNew" onclick="uploadNew(this)">Upload New</button></p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="control-label">Share to Marketplace?</label>
                                <div class="mt-radio-inline">
                                    <label class="mt-radio mt-radio-outline"> No
                                        <input type="radio" value="0" name="analysis_radio" '; echo $row['analysis_radio']==0 ? 'checked':''; echo ' checked />
                                        <span></span>
                                    </label>
                                    <label class="mt-radio mt-radio-outline"> Yes
                                        <input type="radio" value="1" name="analysis_radio" '; echo $row['analysis_radio']==1 ? 'checked':''; echo ' />
                                        <span></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row hidden">
                        <div class="col-md-8">
                            <div class="form-group">
                                <label class="control-label">Safety Data Sheet</label>
                                <input class="form-control '; echo !empty($row['sheet']) ? 'hide':''; echo '" type="file" name="sheet" />
                                <p class="'; echo !empty($row['sheet']) ? '':'hide'; echo '" style="margin: 0;"><a href="uploads/products/'.rawurlencode($row['sheet']).'" target="_blank" class="btn btn-link">View</a> | <button type="button" class="btn btn-link uploadNew" onclick="uploadNew(this)">Upload New</button></p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="control-label">Share to Marketplace?</label>
                                <div class="mt-radio-inline">
                                    <label class="mt-radio mt-radio-outline"> No
                                        <input type="radio" value="0" name="sheet_radio" '; echo $row['sheet_radio']==0 ? 'checked':''; echo ' checked />
                                        <span></span>
                                    </label>
                                    <label class="mt-radio mt-radio-outline"> Yes
                                        <input type="radio" value="1" name="sheet_radio" '; echo $row['sheet_radio']==1 ? 'checked':''; echo ' />
                                        <span></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row hidden">
                        <div class="col-md-8">
                            <div class="form-group">
                                <label class="control-label">Certificate of Guarantee</label>
                                <input class="form-control '; echo !empty($row['guarantee']) ? 'hide':''; echo '" type="file" name="guarantee" />
                                <p class="'; echo !empty($row['guarantee']) ? '':'hide'; echo '" style="margin: 0;"><a href="uploads/products/'.rawurlencode($row['guarantee']).'" target="_blank" class="btn btn-link">View</a> | <button type="button" class="btn btn-link uploadNew" onclick="uploadNew(this)">Upload New</button></p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="control-label">Share to Marketplace?</label>
                                <div class="mt-radio-inline">
                                    <label class="mt-radio mt-radio-outline"> No
                                        <input type="radio" value="0" name="guarantee_radio" '; echo $row['guarantee_radio']==0 ? 'checked':''; echo ' checked />
                                        <span></span>
                                    </label>
                                    <label class="mt-radio mt-radio-outline"> Yes
                                        <input type="radio" value="1" name="guarantee_radio" '; echo $row['guarantee_radio']==1 ? 'checked':''; echo ' />
                                        <span></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row hidden">
                        <div class="col-md-8">
                            <div class="form-group">
                                <label class="control-label">Certificate of Conformance</label>
                                <input class="form-control '; echo !empty($row['conformance']) ? 'hide':''; echo '" type="file" name="conformance" />
                                <p class="'; echo !empty($row['conformance']) ? '':'hide'; echo '" style="margin: 0;"><a href="uploads/products/'.rawurlencode($row['conformance']).'" target="_blank" class="btn btn-link">View</a> | <button type="button" class="btn btn-link uploadNew" onclick="uploadNew(this)">Upload New</button></p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="control-label">Share to Marketplace?</label>
                                <div class="mt-radio-inline">
                                    <label class="mt-radio mt-radio-outline"> No
                                        <input type="radio" value="0" name="conformance_radio" '; echo $row['conformance_radio']==0 ? 'checked':''; echo ' checked />
                                        <span></span>
                                    </label>
                                    <label class="mt-radio mt-radio-outline"> Yes
                                        <input type="radio" value="1" name="conformance_radio" '; echo $row['conformance_radio']==1 ? 'checked':''; echo ' />
                                        <span></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row hidden">
                        <div class="col-md-8">
                            <div class="form-group">
                                <label class="control-label">Product Liability Insurance</label>
                                <input class="form-control '; echo !empty($row['insurance']) ? 'hide':''; echo '" type="file" name="insurance" />
                                <p class="'; echo !empty($row['insurance']) ? '':'hide'; echo '" style="margin: 0;"><a href="uploads/products/'.rawurlencode($row['insurance']).'" target="_blank" class="btn btn-link">View</a> | <button type="button" class="btn btn-link uploadNew" onclick="uploadNew(this)">Upload New</button></p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="control-label">Share to Marketplace?</label>
                                <div class="mt-radio-inline">
                                    <label class="mt-radio mt-radio-outline"> No
                                        <input type="radio" value="0" name="insurance_radio" '; echo $row['insurance_radio']==0 ? 'checked':''; echo ' checked />
                                        <span></span>
                                    </label>
                                    <label class="mt-radio mt-radio-outline"> Yes
                                        <input type="radio" value="1" name="insurance_radio" '; echo $row['insurance_radio']==1 ? 'checked':''; echo ' />
                                        <span></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="tab-pane" id="tabLabs2">
                    <a href="#modalNewLab" data-toggle="modal" class="btn green" onclick="btnNew_Lab(2)">Add New Lab</a>
                    <div class="table-scrollable">
                        <table class="table table-bordered table-hover" id="tableLab_2">
                            <thead>
                                <tr>
                                    <th>Lot #</th>
                                    <th>Lab</th>
                                    <th>Analysis</th>
                                    <th>Method</th>
                                    <th>Sample Size</th>
                                    <th>Unit</th>
                                    <th class="text-center">Date Sent for Lab</th>
                                    <th class="text-center">Date Received</th>
                                    <th class="text-center">Action</th>
                                </tr>
                            </thead>
                            <tbody>';

                                $selectLabs = mysqli_query( $conn,"SELECT * FROM tbl_products_lab WHERE deleted = 0 AND product_id = $id" );
                                if ( mysqli_num_rows($selectLabs) > 0 ) {
                                    while($rowLabs = mysqli_fetch_array($selectLabs)) {
                                        echo '<tr id="tr_'.$rowLabs["ID"].'">
                                            <td>'.htmlentities($rowLabs["lot"]).'</td>
                                            <td>'.htmlentities($rowLabs["lab"]).'</td>
                                            <td>'.htmlentities($rowLabs["analysis"]).'</td>
                                            <td>'.htmlentities($rowLabs["method"]).'</td>
                                            <td>'.htmlentities($rowLabs["sample_size"]).'</td>
                                            <td>'.htmlentities($rowLabs["unit"]).'</td>
                                            <td class="text-center">'.$rowLabs["date_sent"].'</td>
                                            <td class="text-center">'.$rowLabs["date_received"].'</td>
                                            <td class="text-center">
                                                <input type="hidden" name="labs[]" value="'.$rowLabs["ID"].'" />
                                                <div class="btn-group btn-group-circle">
                                                    <a href="#modalEditLab" data-toggle="modal" class="btn btn-outline dark btn-sm" onclick="btnEdit_Lab('.$rowLabs["ID"].', 2)">Edit</a>
                                                    <a href="javascript:;" class="btn btn-outlinex red btn-sm" onclick="btnRemove_Lab('.$rowLabs["ID"].', this)">Delete</a>
                                                </div>
                                            </td>
                                        </tr>';
                                    }
                                }
                            echo '</tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>';

        mysqli_close($conn);
    }
	if( isset($_GET['btnDelete_Products']) ) {
		$id = $_GET['btnDelete_Products'];
		$last_modified = date('Y-m-d');

		mysqli_query( $conn,"UPDATE tbl_products set deleted=1, last_modified='".$last_modified."' WHERE ID=$id" );
		if (!mysqli_error($conn)) {
				        
			$output = array(
				'ID' => $id
			);
			echo json_encode($output);
		}
	}
	if( isset($_POST['btnSave_Products']) ) {
		$ID = $_POST['ID'];

		$path = 'uploads/products/';
		$random = rand(1000,1000000);
		$image_array = array();
        $arr_item = array();
        $file_history = '';
        $filesize = 0;
        $process = true;

		$image_main = addslashes($_FILES['image_main']['name']);
        if (!empty($image_main)) {
            $filesize = $_FILES['image_main']['size'];
            $tmp_image_main = addslashes($_FILES['image_main']['tmp_name']);
            $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
            $ext = strtolower(pathinfo($image_main, PATHINFO_EXTENSION));
            $file_image_main = $random.' - '.$image_main;
            $path_image_main = $path.$file_image_main;

            if(!in_array($ext, $invalid_extensions)) {
                if(move_uploaded_file($tmp_image_main,$path_image_main)) {
                    array_push($image_array, $file_image_main);

                    $output = array (
                        'type'  =>  0,
                        'name' =>  $file_image_main,
                        'size' =>  $filesize,
                        'date' =>  $local_date
                    );
                    array_push($arr_item, $output);
                }
            } else {
                $process = false;
            }
        } else {
            array_push($image_array, '');
        }

        $image_top = addslashes($_FILES['image_top']['name']);
        if (!empty($image_top)) {
            $filesize = $_FILES['image_top']['size'];
            $tmp_image_top = addslashes($_FILES['image_top']['tmp_name']);
            $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
            $ext = strtolower(pathinfo($image_top, PATHINFO_EXTENSION));
            $file_image_top = $random.' - '.$image_top;
            $path_image_top = $path.$file_image_top;

            if(!in_array($ext, $invalid_extensions)) {
                if(move_uploaded_file($tmp_image_top,$path_image_top)) {
                    array_push($image_array, $file_image_top);

                    $output = array (
                        'type'  =>  0,
                        'name' =>  $file_image_top,
                        'size' =>  $filesize,
                        'date' =>  $local_date
                    );
                    array_push($arr_item, $output);
                }
            } else {
                $process = false;
            }
        } else {
            array_push($image_array, '');
        }

        $image_front = addslashes($_FILES['image_front']['name']);
        if (!empty($image_front)) {
            $filesize = $_FILES['image_front']['size'];
            $tmp_image_front = addslashes($_FILES['image_front']['tmp_name']);
            $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
            $ext = strtolower(pathinfo($image_front, PATHINFO_EXTENSION));
            $file_image_front = $random.' - '.$image_front;
            $path_image_front = $path.$file_image_front;

            if(!in_array($ext, $invalid_extensions)) {
                if(move_uploaded_file($tmp_image_front,$path_image_front)) {
                    array_push($image_array, $file_image_front);

                    $output = array (
                        'type'  =>  0,
                        'name' =>  $file_image_front,
                        'size' =>  $filesize,
                        'date' =>  $local_date
                    );
                    array_push($arr_item, $output);
                }
            } else {
                $process = false;
            }
        } else {
            array_push($image_array, '');
        }

        $image_left = addslashes($_FILES['image_left']['name']);
        if (!empty($image_left)) {
            $filesize = $_FILES['image_left']['size'];
            $tmp_image_left = addslashes($_FILES['image_left']['tmp_name']);
            $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
            $ext = strtolower(pathinfo($image_left, PATHINFO_EXTENSION));
            $file_image_left = $random.' - '.$image_left;
            $path_image_left = $path.$file_image_left;

            if(!in_array($ext, $invalid_extensions)) {
                if(move_uploaded_file($tmp_image_left,$path_image_left)) {
                    array_push($image_array, $file_image_left);

                    $output = array (
                        'type'  =>  0,
                        'name' =>  $file_image_left,
                        'size' =>  $filesize,
                        'date' =>  $local_date
                    );
                    array_push($arr_item, $output);
                }
            } else {
                $process = false;
            }
        } else {
            array_push($image_array, '');
        }

        $image_bottom = addslashes($_FILES['image_bottom']['name']);
        if (!empty($image_bottom)) {
            $filesize = $_FILES['image_bottom']['size'];
            $tmp_image_bottom = addslashes($_FILES['image_bottom']['tmp_name']);
            $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
            $ext = strtolower(pathinfo($image_bottom, PATHINFO_EXTENSION));
            $file_image_bottom = $random.' - '.$image_bottom;
            $path_image_bottom = $path.$file_image_bottom;

            if(!in_array($ext, $invalid_extensions)) {
                if(move_uploaded_file($tmp_image_bottom,$path_image_bottom)) {
                    array_push($image_array, $file_image_bottom);

                    $output = array (
                        'type'  =>  0,
                        'name' =>  $file_image_bottom,
                        'size' =>  $filesize,
                        'date' =>  $local_date
                    );
                    array_push($arr_item, $output);
                }
            } else {
                $process = false;
            }
        } else {
            array_push($image_array, '');
        }

        $image_back = addslashes($_FILES['image_back']['name']);
        if (!empty($image_back)) {
            $filesize = $_FILES['image_back']['size'];
            $tmp_image_back = addslashes($_FILES['image_back']['tmp_name']);
            $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
            $ext = strtolower(pathinfo($image_back, PATHINFO_EXTENSION));
            $file_image_back = $random.' - '.$image_back;
            $path_image_back = $path.$file_image_back;

            if(!in_array($ext, $invalid_extensions)) {
                if(move_uploaded_file($tmp_image_main,$path_image_back)) {
                    array_push($image_array, $file_image_back);

                    $output = array (
                        'type'  =>  0,
                        'name' =>  $file_image_back,
                        'size' =>  $filesize,
                        'date' =>  $local_date
                    );
                    array_push($arr_item, $output);
                }
            } else {
                $process = false;
            }
        } else {
            array_push($image_array, '');
        }

        $image_right = addslashes($_FILES['image_right']['name']);
        if (!empty($image_right)) {
            $filesize = $_FILES['image_right']['size'];
            $tmp_image_right = addslashes($_FILES['image_right']['tmp_name']);
            $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
            $ext = strtolower(pathinfo($image_right, PATHINFO_EXTENSION));
            $file_image_right = $random.' - '.$image_right;
            $path_image_right = $path.$file_image_right;

            if(!in_array($ext, $invalid_extensions)) {
                if(move_uploaded_file($tmp_image_right,$path_image_right)) {
                    array_push($image_array, $file_image_right);

                    $output = array (
                        'type'  =>  0,
                        'name' =>  $file_image_right,
                        'size' =>  $filesize,
                        'date' =>  $local_date
                    );
                    array_push($arr_item, $output);
                }
            } else {
                $process = false;
            }
        } else {
            array_push($image_array, '');
        }
		$image_array = implode(", ",$image_array);

		$code = addslashes($_POST['code']);
		$name = addslashes($_POST['name']);
		$category = $_POST['category'];
		$category_other = addslashes($_POST['category_other']);
		$description = addslashes($_POST['description']);
		$ingredient = addslashes($_POST['ingredient']);
		$packaging_1 = $_POST['packaging_1'];
		$packaging_2 = $_POST['packaging_2'];
		$packaging_3 = $_POST['packaging_3'];
        $intended = $_POST['intended'] ?? 0; // throws an "Undefined array key" warning so I added a default value
		$claims = "";
		if (!empty($_POST["claims"])) { $claims = implode(", ", $_POST["claims"]); }

		if (!empty($_POST["allergen"])) {
			$allergen = implode(", ", $_POST["allergen"]);
		} else {
			$allergen = "";
		}

		$allergen_other = addslashes($_POST['allergen_other']);
		$material = addslashes($_POST['material']);
		$unit = $_POST['unit'];
		$boxes = $_POST['boxes'];
		$pallet = $_POST['pallet'];
		$count_unit_box = $_POST['count_unit_box'];
		$count_unit_pallet = $_POST['count_unit_pallet'];
		$count_unit_carton = $_POST['count_unit_carton'];
		$shelf = $_POST['shelf'];
		$storage = $_POST['storage'];
		$upc = $_POST['upc'];
		$gtin = $_POST['gtin'];
		$lead = $_POST['lead'];
		$moq = $_POST['moq'];
		$export = $_POST['export'];
		$countries = addslashes($_POST['countries']);
		$manufactured_by = addslashes($_POST['manufactured_by']);
		$manufactured_for = addslashes($_POST['manufactured_for']);
		$distributed_by = addslashes($_POST['distributed_by']);
		$warehouse = addslashes($_POST['warehouse']);
        $lot_code = addslashes($_POST['lot_code'] ?? ''); // throws an "Undefined array key" warning so I added a default value
		$mock_recall = $_POST['mock_recall'];
		$product_trace = $_POST['product_trace'];


		$specifcation = addslashes($_FILES['specifcation']['name']);
        if (!empty($specifcation)) {
            $filesize = $_FILES['specifcation']['size'];
            $tmp_image_specifcation = addslashes($_FILES['specifcation']['tmp_name']);
            $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
            $ext = strtolower(pathinfo($specifcation, PATHINFO_EXTENSION));
            $specifcation = $random.' - '.$specifcation;
            $path_image_specifcation = $path.$specifcation;

            if(!in_array($ext, $invalid_extensions)) {
                move_uploaded_file($tmp_image_specifcation,$path_image_specifcation);

                $output = array (
                    'type'  =>  0,
                    'name' =>  $specifcation,
                    'size' =>  $filesize,
                    'date' =>  $local_date
                );
                array_push($arr_item, $output);
            } else {
                $process = false;
            }
        }

        $artwork = addslashes($_FILES['artwork']['name']);
        if (!empty($artwork)) {
            $filesize = $_FILES['artwork']['size'];
            $tmp_image_artwork = addslashes($_FILES['artwork']['tmp_name']);
            $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
            $ext = strtolower(pathinfo($artwork, PATHINFO_EXTENSION));
            $artwork = $random.' - '.$artwork;
            $path_image_artwork = $path.$artwork;

            if(!in_array($ext, $invalid_extensions)) {
                move_uploaded_file($tmp_image_artwork,$path_image_artwork);

                $output = array (
                    'type'  =>  0,
                    'name' =>  $artwork,
                    'size' =>  $filesize,
                    'date' =>  $local_date
                );
                array_push($arr_item, $output);
            } else {
                $process = false;
            }
        }

        $haccp = addslashes($_FILES['haccp']['name']);
        if (!empty($haccp)) {
            $filesize = $_FILES['haccp']['size'];
            $tmp_image_haccp = addslashes($_FILES['haccp']['tmp_name']);
            $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
            $ext = strtolower(pathinfo($haccp, PATHINFO_EXTENSION));
            $haccp = $random.' - '.$haccp;
            $path_image_haccp = $path.$haccp;

            if(!in_array($ext, $invalid_extensions)) {
                move_uploaded_file($tmp_image_haccp,$path_image_haccp);

                $output = array (
                    'type'  =>  0,
                    'name' =>  $haccp,
                    'size' =>  $filesize,
                    'date' =>  $local_date
                );
                array_push($arr_item, $output);
            } else {
                $process = false;
            }
        }

        $label = addslashes($_FILES['label']['name']);
        if (!empty($label)) {
            $filesize = $_FILES['label']['size'];
            $tmp_image_label = addslashes($_FILES['label']['tmp_name']);
            $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
            $ext = strtolower(pathinfo($label, PATHINFO_EXTENSION));
            $label = $random.' - '.$label;
            $path_image_label = $path.$label;

            if(!in_array($ext, $invalid_extensions)) {
                move_uploaded_file($tmp_image_label,$path_image_label);

                $output = array (
                    'type'  =>  0,
                    'name' =>  $label,
                    'size' =>  $filesize,
                    'date' =>  $local_date
                );
                array_push($arr_item, $output);
            } else {
                $process = false;
            }
        }

        $formulation = addslashes($_FILES['formulation']['name']);
        if (!empty($formulation)) {
            $filesize = $_FILES['formulation']['size'];
            $tmp_image_formulation = addslashes($_FILES['formulation']['tmp_name']);
            $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
            $ext = strtolower(pathinfo($formulation, PATHINFO_EXTENSION));
            $formulation = $random.' - '.$formulation;
            $path_image_formulation = $path.$formulation;

            if(!in_array($ext, $invalid_extensions)) {
                move_uploaded_file($tmp_image_formulation,$path_image_formulation);

                $output = array (
                    'type'  =>  0,
                    'name' =>  $formulation,
                    'size' =>  $filesize,
                    'date' =>  $local_date
                );
                array_push($arr_item, $output);
            } else {
                $process = false;
            }
        }

        $origin = addslashes($_FILES['origin']['name']);
        if (!empty($origin)) {
            $filesize = $_FILES['origin']['size'];
            $tmp_image_origin = addslashes($_FILES['origin']['tmp_name']);
            $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
            $ext = strtolower(pathinfo($origin, PATHINFO_EXTENSION));
            $origin = $random.' - '.$origin;
            $path_image_origin = $path.$origin;

            if(!in_array($ext, $invalid_extensions)) {
                move_uploaded_file($tmp_image_origin,$path_image_origin);

                $output = array (
                    'type'  =>  0,
                    'name' =>  $origin,
                    'size' =>  $filesize,
                    'date' =>  $local_date
                );
                array_push($arr_item, $output);
            } else {
                $process = false;
            }
        }

        $procedures = addslashes($_FILES['procedures']['name']);
        if (!empty($procedures)) {
            $filesize = $_FILES['procedures']['size'];
            $tmp_image_procedures = addslashes($_FILES['procedures']['tmp_name']);
            $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
            $ext = strtolower(pathinfo($procedures, PATHINFO_EXTENSION));
            $procedures = $random.' - '.$procedures;
            $path_image_procedures = $path.$procedures;

            if(!in_array($ext, $invalid_extensions)) {
                move_uploaded_file($tmp_image_procedures,$path_image_procedures);

                $output = array (
                    'type'  =>  0,
                    'name' =>  $procedures,
                    'size' =>  $filesize,
                    'date' =>  $local_date
                );
                array_push($arr_item, $output);
            } else {
                $process = false;
            }
        }

        $analysis = addslashes($_FILES['analysis']['name']);
        if (!empty($analysis)) {
            $filesize = $_FILES['analysis']['size'];
            $tmp_image_analysis = addslashes($_FILES['analysis']['tmp_name']);
            $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
            $ext = strtolower(pathinfo($analysis, PATHINFO_EXTENSION));
            $procedures = $random.' - '.$analysis;
            $path_image_analysis = $path.$procedures;

            if(!in_array($ext, $invalid_extensions)) {
                move_uploaded_file($tmp_image_analysis,$path_image_analysis);

                $output = array (
                    'type'  =>  0,
                    'name' =>  $procedures,
                    'size' =>  $filesize,
                    'date' =>  $local_date
                );
                array_push($arr_item, $output);
            } else {
                $process = false;
            }
        }

        $sheet = addslashes($_FILES['sheet']['name']);
        if (!empty($sheet)) {
            $filesize = $_FILES['sheet']['size'];
            $tmp_image_sheet = addslashes($_FILES['sheet']['tmp_name']);
            $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
            $ext = strtolower(pathinfo($sheet, PATHINFO_EXTENSION));
            $sheet = $random.' - '.$sheet;
            $path_image_sheet = $path.$sheet;

            if(!in_array($ext, $invalid_extensions)) {
                move_uploaded_file($tmp_image_sheet,$path_image_sheet);

                $output = array (
                    'type'  =>  0,
                    'name' =>  $sheet,
                    'size' =>  $filesize,
                    'date' =>  $local_date
                );
                array_push($arr_item, $output);
            } else {
                $process = false;
            }
        }

        $guarantee = addslashes($_FILES['guarantee']['name']);
        if (!empty($guarantee)) {
            $filesize = $_FILES['guarantee']['size'];
            $tmp_image_guarantee = addslashes($_FILES['guarantee']['tmp_name']);
            $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
            $ext = strtolower(pathinfo($guarantee, PATHINFO_EXTENSION));
            $guarantee = $random.' - '.$guarantee;
            $path_image_guarantee = $path.$guarantee;

            if(!in_array($ext, $invalid_extensions)) {
                move_uploaded_file($tmp_image_guarantee,$path_image_guarantee);

                $output = array (
                    'type'  =>  0,
                    'name' =>  $guarantee,
                    'size' =>  $filesize,
                    'date' =>  $local_date
                );
                array_push($arr_item, $output);
            } else {
                $process = false;
            }
        }

        $conformance = addslashes($_FILES['conformance']['name']);
        if (!empty($conformance)) {
            $filesize = $_FILES['conformance']['size'];
            $tmp_image_conformance = addslashes($_FILES['conformance']['tmp_name']);
            $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
            $ext = strtolower(pathinfo($conformance, PATHINFO_EXTENSION));
            $conformance = $random.' - '.$conformance;
            $path_image_conformance = $path.$conformance;

            if(!in_array($ext, $invalid_extensions)) {
                move_uploaded_file($tmp_image_conformance,$path_image_conformance);

                $output = array (
                    'type'  =>  0,
                    'name' =>  $conformance,
                    'size' =>  $filesize,
                    'date' =>  $local_date
                );
                array_push($arr_item, $output);
            } else {
                $process = false;
            }
        }

        $insurance = addslashes($_FILES['insurance']['name']);
        if (!empty($insurance)) {
            $filesize = $_FILES['insurance']['size'];
            $tmp_image_insurance = addslashes($_FILES['insurance']['tmp_name']);
            $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
            $ext = strtolower(pathinfo($insurance, PATHINFO_EXTENSION));
            $insurance = $random.' - '.$insurance;
            $path_image_insurance = $path.$insurance;

            if(!in_array($ext, $invalid_extensions)) {
                move_uploaded_file($tmp_image_insurance,$path_image_insurance);

                $output = array (
                    'type'  =>  0,
                    'name' =>  $insurance,
                    'size' =>  $filesize,
                    'date' =>  $local_date
                );
                array_push($arr_item, $output);
            } else {
                $process = false;
            }
        }

		$specifcation_date = $_POST['specifcation_date'];
		$artwork_date = $_POST['artwork_date'];
		$haccp_date = $_POST['haccp_date'];
		$label_date = $_POST['label_date'];
		$formulation_date = $_POST['formulation_date'];

		$artwork_radio = $_POST['artwork_radio'];
		$haccp_radio = $_POST['haccp_radio'];
		$label_radio = $_POST['label_radio'];
		$formulation_radio = $_POST['formulation_radio'];
		$origin_radio = $_POST['origin_radio'];
		$procedures_radio = $_POST['procedures_radio'];
		$analysis_radio = $_POST['analysis_radio'];
		$specifcation_radio = $_POST['specifcation_radio'];
		$sheet_radio = $_POST['sheet_radio'];
		$guarantee_radio = $_POST['guarantee_radio'];
		$conformance_radio = $_POST['conformance_radio'];
		$insurance_radio = $_POST['insurance_radio'];

        $intended_consumers = $_POST['intended_consumers'];
        $packaging_temperature = $_POST['packaging_temperature'];
        $labeling_instructions = $_POST['labeling_instructions'];
        $physical_chars = isset($_POST['physical_chars']) && count($_POST['physical_chars']) > 0 ? json_encode($_POST['physical_chars']) : NULL;
        $physico_chem_char = isset($_POST['physico_chem_char']) && count($_POST['physico_chem_char']) > 0 ? json_encode($_POST['physico_chem_char']) : NULL;
        $microbial_char = isset($_POST['microbial_char']) && count($_POST['microbial_char']) > 0 ? json_encode($_POST['microbial_char']) : NULL;
        
        $vendor_name = $_POST['vendor_name'] ?? '';
        $vendor_code = $_POST['vendor_code'] ?? '';
        $mb_enterprise_name = $_POST['mb_enterprise_name'] ?? '';
        $mb_lot_code = $_POST['mb_lot_code'] ?? '';
        $mb_manufactured_date = $_POST['mb_manufactured_date'] ?? '';
        $mb_expiry_date = $_POST['mb_expiry_date'] ?? '';
        $traded_supplier_name = $_POST['traded_supplier_name'] ?? '';
        $traded_supplied_for = $_POST['traded_supplied_for'] ?? '';
        $traded_manufactured_date = $_POST['traded_manufactured_date'] ?? '';
        $traded_expiry_date = $_POST['traded_expiry_date'] ?? '';
        $branded_manufactured_by = $_POST['branded_manufactured_by'] ?? '';
        $branded_manufactured_for = $_POST['branded_manufactured_for'] ?? '';
        $branded_manufactured_date = $_POST['branded_manufactured_date'] ?? '';
        $branded_expiry_date = $_POST['branded_expiry_date'] ?? '';
        $branded_lot_code_by_manufacturer = $_POST['branded_lot_code_by_manufacturer'] ?? '';
        $branded_lot_code_by_enterprise = $_POST['branded_lot_code_by_enterprise'] ?? '';
        $delivered_from = $_POST['delivered_from'] ?? '';
        $country_of_origin = $_POST['country_of_origin'] ?? '';
        $country_of_purchase = $_POST['country_of_purchase'] ?? '';
		
		$arr_docs = array();
		$arr_docs_date = array();
		for ($i=0; $i < count($_POST['docs']); $i++) {
			$docs_label = $_POST['docs'][$i]['docs_label'];
			$docs_date = $_POST['docs'][$i]['docs_date'];
            $docs_tmp = $_POST['docs'][$i]['docs_tmp'] ?? '';
            $docs_radio = $_POST['docs'][$i]['docs_radio'] ?? 0;
            $docs_file = implode('*', $_FILES['docs']['name'][$i]);

			$final_file = '';
			if (!empty($docs_file)) {
				$filesize = implode('*', $_FILES['docs']['size'][$i]);
                $tmp = implode('*', $_FILES['docs']['tmp_name'][$i]);
                $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                $ext = strtolower(pathinfo($docs_file, PATHINFO_EXTENSION));
                $files = $docs_file;
				$final_file = $random . ' - ' . $files;
				$final_path = $path.$final_file;

                if(!in_array($ext, $invalid_extensions)) {
                    move_uploaded_file($tmp,$final_path);

                    $output = array (
                        'type'  =>  0,
                        'name' =>  $final_file,
                        'size' =>  $filesize,
                        'date' =>  $local_date
                    );
                    array_push($arr_item, $output);

                    $docs_data = array (
                        'docs_label'    =>  $docs_label,
                        'docs_radio'    =>  $docs_radio,
                        'docs_file'     =>  $final_file,
                        'docs_date'     =>  $docs_date
                    );
                    array_push( $arr_docs, $docs_data );

                    // $docs_data_date = array (
                    //     'docs_date'     =>  $docs_date
                    // );
                    // array_push( $arr_docs_date, $docs_data_date );
                } else {
                    $process = false;
                }
			} else if (!empty($docs_tmp)) {
                $docs_data = array (
                    'docs_label'    =>  $docs_label,
                    'docs_radio'    =>  $docs_radio,
                    'docs_file'     =>  $docs_tmp,
                    'docs_date'     =>  $docs_date
                );
                array_push( $arr_docs, $docs_data );
            }
		}
        $docs = json_encode($arr_docs, JSON_HEX_APOS | JSON_UNESCAPED_UNICODE);
		// $docs_dates = json_encode($arr_docs_date);
        $file_history = json_encode($arr_item, JSON_HEX_APOS | JSON_UNESCAPED_UNICODE);

        if ($process == true) {
            $sql = "INSERT INTO tbl_products (user_id, image, code, name, category, category_other, description, ingredient, packaging_1, packaging_2, packaging_3, intended, claims, allergen, allergen_other, material, unit, boxes, pallet, count_unit_box, count_unit_pallet, count_unit_carton, shelf, storage, upc, gtin, lead_time, moq, export, countries, manufactured_by, manufactured_for, distributed_by, warehouse, lot_code, mock_recall, product_trace, artwork, haccp, label, formulation, origin, procedures, analysis, specifcation, sheet, guarantee, conformance, insurance, specifcation_date, artwork_date, haccp_date, label_date, formulation_date, artwork_radio, haccp_radio, label_radio, formulation_radio, origin_radio, procedures_radio, analysis_radio, specifcation_radio, sheet_radio, guarantee_radio, conformance_radio, insurance_radio, docs, docs_date, intended_consumers, packaging_temperature, labeling_instructions, physical_characteristics, physico_chemical_characteristics, microbiological_characteristics, vendor_name, vendor_code, mb_enterprise_name, mb_lot_code, mb_manufactured_date, mb_expiry_date, traded_supplier_name, traded_supplied_for, traded_manufactured_date, traded_expiry_date, branded_manufactured_by, branded_manufactured_for, branded_manufactured_date, branded_expiry_date, branded_lot_code_by_manufacturer, branded_lot_code_by_enterprise, delivered_from, country_of_origin, country_of_purchase, file_history)
            VALUES ('$ID', '$image_array', '$code', '$name', '$category', '$category_other', '$description', '$ingredient', '$packaging_1', '$packaging_2', '$packaging_3', '$intended', '$claims', '$allergen', '$allergen_other', '$material', '$unit', '$boxes', '$pallet', '$count_unit_box', '$count_unit_pallet', '$count_unit_carton', '$shelf', '$storage', '$upc', '$gtin', '$lead', '$moq', '$export', '$countries', '$manufactured_by', '$manufactured_for', '$distributed_by', '$warehouse', '$lot_code', '$mock_recall', '$product_trace', '$artwork', '$haccp', '$label', '$formulation', '$origin', '$procedures', '$analysis', '$specifcation', '$sheet', '$guarantee', '$conformance', '$insurance', '$specifcation_date', '$artwork_date', '$haccp_date', '$label_date', '$formulation_date', '$artwork_radio', '$haccp_radio', '$label_radio', '$formulation_radio', '$origin_radio', '$procedures_radio', '$analysis_radio', '$specifcation_radio', '$sheet_radio', '$guarantee_radio', '$conformance_radio', '$insurance_radio', '$docs', '$docs_date', '$intended_consumers', '$packaging_temperature', '$labeling_instructions', 
                    ".(isset($physical_chars) ? "'$physical_chars'" : "NULL").",
                    ".(isset($physico_chem_char) ? "'$physico_chem_char'" : "NULL").",
                    ".(isset($microbial_char) ? "'$microbial_char'" : "NULL").",
                    '$vendor_name', '$vendor_code', '$mb_enterprise_name', '$mb_lot_code', '$mb_manufactured_date', '$mb_expiry_date', '$traded_supplier_name', '$traded_supplied_for', '$traded_manufactured_date', '$traded_expiry_date', '$branded_manufactured_by', '$branded_manufactured_for', '$branded_manufactured_date', '$branded_expiry_date', '$branded_lot_code_by_manufacturer', '$branded_lot_code_by_enterprise', '$delivered_from', '$country_of_origin', '$country_of_purchase', '$file_history')";
                    // updated this query - almario

    		if (mysqli_query($conn, $sql)) {
    			$last_id = mysqli_insert_id($conn);

                if (!empty($_POST['labs'])) {
                    $labs = implode(", ", $_POST["labs"]);
                    $labs_arr = explode(", ", $labs);
                    foreach ($labs_arr as $value) {
                        mysqli_query( $conn,"UPDATE tbl_products_lab set product_id = $last_id WHERE ID = $value" );
                    }
                }

    			$selectData = mysqli_query( $conn,'SELECT * FROM tbl_products WHERE user_id="'. $ID .'" AND ID="'. $last_id .'" ORDER BY ID LIMIT 1' );
    			if ( mysqli_num_rows($selectData) > 0 ) {
    				$rowData = mysqli_fetch_array($selectData);
    				$data_ID = $rowData['ID'];
    				$data_last_modified = $rowData['last_modified'];

    				$data_image = $rowData['image'];
    				$data_image_array = explode(", ", $data_image);

                    $url_base = "";
                    $image_main = "https://via.placeholder.com/40x40/EFEFEF/AAAAAA.png?text=No+Image";

                    if (!empty($data_image)) {

                        $data_image_array = explode(", ", $data_image);
                        if (!empty($data_image_array[0])) {
                            $url_base = $base_url."uploads/products/";

                            $image_main = $data_image_array[0];
                        }
                    }

                    $img_url = $url_base.$image_main;

                    $data_category_id = $rowData['category'];
                    if ($data_category_id == 9) {
                        $category = $rowData['category_other'];
                    } else {
                        $resultCategory = mysqli_query( $conn,"SELECT * FROM tbl_products_category WHERE ID = $data_category_id" );
                        $rowCategory = mysqli_fetch_array($resultCategory);
                        $category = $rowCategory['name'];
                    }

    				$output = array(
    					"ID" => $data_ID,
                        "name" => stripcslashes(htmlentities($name)),
                        "description" => stripcslashes(htmlentities($description)),
    					"image" => $img_url,
    					"category" => $category,
    					"last_modified" => $data_last_modified
    				);
    				echo json_encode($output);
    			}
    		}
    		mysqli_close($conn);
    	}
    }
	if( isset($_POST['btnUpdate_Products']) ) {
		$ID = $_POST['ID'];
		$last_modified = date('Y-m-d');

		$path = 'uploads/products/';
		$random = rand(1000,1000000);
		$image_array = array();
        $process = true;

		$selectImage = mysqli_query( $conn,"SELECT * FROM tbl_products WHERE ID = $ID" );
		if ( mysqli_num_rows($selectImage) > 0 ) {
            $rowImage = mysqli_fetch_array($selectImage);
            $current_image = $rowImage['image'];
			$current_image_array = explode(", ", $current_image);
        }
        $arr_item = array();
        if (!empty($rowImage["file_history"])) {
            $arr_item = json_decode($rowImage["file_history"],true);
        }

		$image_main = addslashes($_FILES['image_main']['name']);
        if (!empty($image_main)) {
            $filesize = $_FILES['image_main']['size'];
            $tmp_image_main = addslashes($_FILES['image_main']['tmp_name']);
            $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
            $ext = strtolower(pathinfo($image_main, PATHINFO_EXTENSION));
            $file_image_main = $random.' - '.$image_main;
            $path_image_main = $path.$file_image_main;

            if(!in_array($ext, $invalid_extensions)) {
                if(move_uploaded_file($tmp_image_main,$path_image_main)) {
                    array_push($image_array, $file_image_main);

                    $output = array (
                        'type'  =>  0,
                        'name' =>  $file_image_main,
                        'size' =>  $filesize,
                        'date' =>  $local_date
                    );
                    array_push($arr_item, $output);
                }
            } else {
                $process = false;
            }
        } else {
            array_push($image_array, $current_image_array[0]);
        }

        $image_top = addslashes($_FILES['image_top']['name']);
        if (!empty($image_top)) {
            $filesize = $_FILES['image_top']['size'];
            $tmp_image_top = addslashes($_FILES['image_top']['tmp_name']);
            $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
            $ext = strtolower(pathinfo($image_top, PATHINFO_EXTENSION));
            $file_image_top = $random.' - '.$image_top;
            $path_image_top = $path.$file_image_top;

            if(!in_array($ext, $invalid_extensions)) {
                if(move_uploaded_file($tmp_image_top,$path_image_top)) {
                    array_push($image_array, $file_image_top);

                    $output = array (
                        'type'  =>  0,
                        'name' =>  $file_image_top,
                        'size' =>  $filesize,
                        'date' =>  $local_date
                    );
                    array_push($arr_item, $output);
                }
            } else {
                $process = false;
            }
        } else {
            array_push($image_array, $current_image_array[1]);
        }

        $image_front = addslashes($_FILES['image_front']['name']);
        if (!empty($image_front)) {
            $filesize = $_FILES['image_front']['size'];
            $tmp_image_front = addslashes($_FILES['image_front']['tmp_name']);
            $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
            $ext = strtolower(pathinfo($image_front, PATHINFO_EXTENSION));
            $file_image_front = $random.' - '.$image_front;
            $path_image_front = $path.$file_image_front;

            if(!in_array($ext, $invalid_extensions)) {
                if(move_uploaded_file($tmp_image_front,$path_image_front)) {
                    array_push($image_array, $file_image_front);

                    $output = array (
                        'type'  =>  0,
                        'name' =>  $file_image_front,
                        'size' =>  $filesize,
                        'date' =>  $local_date
                    );
                    array_push($arr_item, $output);
                }
            } else {
                $process = false;
            }
        } else {
            array_push($image_array, $current_image_array[2]);
        }

        $image_left = addslashes($_FILES['image_left']['name']);
        if (!empty($image_left)) {
            $filesize = $_FILES['image_left']['size'];
            $tmp_image_left = addslashes($_FILES['image_left']['tmp_name']);
            $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
            $ext = strtolower(pathinfo($image_left, PATHINFO_EXTENSION));
            $file_image_left = $random.' - '.$image_left;
            $path_image_left = $path.$file_image_left;

            if(!in_array($ext, $invalid_extensions)) {
                if(move_uploaded_file($tmp_image_left,$path_image_left)) {
                    array_push($image_array, $file_image_left);

                    $output = array (
                        'type'  =>  0,
                        'name' =>  $file_image_left,
                        'size' =>  $filesize,
                        'date' =>  $local_date
                    );
                    array_push($arr_item, $output);
                }
            } else {
                $process = false;
            }
        } else {
            array_push($image_array, $current_image_array[3]);
        }

        $image_bottom = addslashes($_FILES['image_bottom']['name']);
        if (!empty($image_bottom)) {
            $filesize = $_FILES['image_bottom']['size'];
            $tmp_image_bottom = addslashes($_FILES['image_bottom']['tmp_name']);
            $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
            $ext = strtolower(pathinfo($image_bottom, PATHINFO_EXTENSION));
            $file_image_bottom = $random.' - '.$image_bottom;
            $path_image_bottom = $path.$file_image_bottom;

            if(!in_array($ext, $invalid_extensions)) {
                if(move_uploaded_file($tmp_image_bottom,$path_image_bottom)) {
                    array_push($image_array, $file_image_bottom);

                    $output = array (
                        'type'  =>  0,
                        'name' =>  $file_image_bottom,
                        'size' =>  $filesize,
                        'date' =>  $local_date
                    );
                    array_push($arr_item, $output);
                }
            } else {
                $process = false;
            }
        } else {
            array_push($image_array, $current_image_array[4]);
        }

        $image_back = addslashes($_FILES['image_back']['name']);
        if (!empty($image_back)) {
            $filesize = $_FILES['image_back']['size'];
            $tmp_image_back = addslashes($_FILES['image_back']['tmp_name']);
            $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
            $ext = strtolower(pathinfo($image_back, PATHINFO_EXTENSION));
            $file_image_back = $random.' - '.$image_back;
            $path_image_back = $path.$file_image_back;

            if(!in_array($ext, $invalid_extensions)) {
                if(move_uploaded_file($tmp_image_main,$path_image_back)) {
                    array_push($image_array, $file_image_back);

                    $output = array (
                        'type'  =>  0,
                        'name' =>  $file_image_back,
                        'size' =>  $filesize,
                        'date' =>  $local_date
                    );
                    array_push($arr_item, $output);
                }
            } else {
                $process = false;
            }
        } else {
            array_push($image_array, $current_image_array[5]);
        }

        $image_right = addslashes($_FILES['image_right']['name']);
        if (!empty($image_right)) {
            $filesize = $_FILES['image_right']['size'];
            $tmp_image_right = addslashes($_FILES['image_right']['tmp_name']);
            $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
            $ext = strtolower(pathinfo($image_right, PATHINFO_EXTENSION));
            $file_image_right = $random.' - '.$image_right;
            $path_image_right = $path.$file_image_right;

            if(!in_array($ext, $invalid_extensions)) {
                if(move_uploaded_file($tmp_image_right,$path_image_right)) {
                    array_push($image_array, $file_image_right);

                    $output = array (
                        'type'  =>  0,
                        'name' =>  $file_image_right,
                        'size' =>  $filesize,
                        'date' =>  $local_date
                    );
                    array_push($arr_item, $output);
                }
            } else {
                $process = false;
            }
        } else {
            array_push($image_array, $current_image_array[6]);
        }
		$image_array = implode(", ",$image_array);
		mysqli_query( $conn,"UPDATE tbl_products set image='". $image_array ."' WHERE ID='". $ID ."'" );

		$code = addslashes($_POST['code']);
		$name = addslashes($_POST['name']);
		$category = $_POST['category'];
		$category_other = addslashes($_POST['category_other']);
		$description = addslashes($_POST['description']);
		$ingredient = addslashes($_POST['ingredient']);
		$packaging_1 = $_POST['packaging_1'];
		$packaging_2 = $_POST['packaging_2'];
		$packaging_3 = $_POST['packaging_3'];
        $intended = $_POST['intended'] ?? 0;
		$claims = "";
		if (!empty($_POST["claims"])) { $claims = implode(", ", $_POST["claims"]); }
		mysqli_query( $conn,"UPDATE tbl_products set code='". $code ."', name='". $name ."', category='". $category ."', category_other='". $category_other ."', description='". $description ."', ingredient='". $ingredient ."', packaging_1='". $packaging_1 ."', packaging_2='". $packaging_2 ."', packaging_3='". $packaging_3 ."', intended='". $intended ."', claims='". $claims ."' WHERE ID='". $ID ."'" );

		if (!empty($_POST["allergen"])) {
			$allergen = implode(", ", $_POST["allergen"]);
		} else {
			$allergen = "";
		}

		$allergen_other = addslashes($_POST['allergen_other']);
		$material = addslashes($_POST['material']);
		mysqli_query( $conn,"UPDATE tbl_products set allergen='". $allergen ."', allergen_other='". $allergen_other ."', material='". $material ."' WHERE ID='". $ID ."'" );

		$unit = $_POST['unit'];
		$boxes = $_POST['boxes'];
		$pallet = $_POST['pallet'];
		mysqli_query( $conn,"UPDATE tbl_products set unit='". $unit ."', boxes='". $boxes ."', pallet='". $pallet ."' WHERE ID='". $ID ."'" );

		$count_unit_box = $_POST['count_unit_box'];
		$count_unit_pallet = $_POST['count_unit_pallet'];
		$count_unit_carton = $_POST['count_unit_carton'];
		mysqli_query( $conn,"UPDATE tbl_products set count_unit_box='". $count_unit_box ."', count_unit_pallet='". $count_unit_pallet ."', count_unit_carton='". $count_unit_carton ."' WHERE ID='". $ID ."'" );

		$shelf = $_POST['shelf'];
		$storage = $_POST['storage'];
		$upc = $_POST['upc'];
		$gtin = $_POST['gtin'];
		$lead = $_POST['lead'];
		$moq = $_POST['moq'];
		$export = $_POST['export'];
		$countries = $_POST['countries'];
		mysqli_query( $conn,"UPDATE tbl_products set shelf='". $shelf ."', storage='". $storage ."', upc='". $upc ."', gtin='". $gtin ."', lead_time='". $lead ."', moq='". $moq ."', export='". $export ."', countries='". $countries ."' WHERE ID='". $ID ."'" );

		$manufactured_by = addslashes($_POST['manufactured_by']);
		$manufactured_for = addslashes($_POST['manufactured_for']);
		$distributed_by = addslashes($_POST['distributed_by']);
		$warehouse = addslashes($_POST['warehouse']);
        $lot_code = addslashes($_POST['lot_code'] ?? '');
		mysqli_query( $conn,"UPDATE tbl_products set manufactured_by='". $manufactured_by ."', manufactured_for='". $manufactured_for ."', distributed_by='". $distributed_by ."', warehouse='". $warehouse ."', lot_code='". $lot_code ."' WHERE ID='". $ID ."'" );

		$mock_recall = $_POST['mock_recall'];
		$product_trace = $_POST['product_trace'];
		mysqli_query( $conn,"UPDATE tbl_products set mock_recall='". $mock_recall ."', product_trace='". $product_trace ."' WHERE ID='". $ID ."'" );

		$specifcation = addslashes($_FILES['specifcation']['name']);
        if (!empty($specifcation)) {
            $filesize = $_FILES['specifcation']['size'];
            $tmp_image_specifcation = addslashes($_FILES['specifcation']['tmp_name']);
            $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
            $ext = strtolower(pathinfo($specifcation, PATHINFO_EXTENSION));
            $specifcation = $random.' - '.$specifcation;
            $path_image_specifcation = $path.$specifcation;

            if(!in_array($ext, $invalid_extensions)) {
                move_uploaded_file($tmp_image_specifcation,$path_image_specifcation);
                mysqli_query( $conn,"UPDATE tbl_products set specifcation='". $specifcation ."' WHERE ID='". $ID ."'" );

                $output = array (
                    'type'  =>  0,
                    'name' =>  $specifcation,
                    'size' =>  $filesize,
                    'date' =>  $local_date
                );
                array_push($arr_item, $output);
            } else {
                $process = false;
            }
        }

        $artwork = addslashes($_FILES['artwork']['name']);
        if (!empty($artwork)) {
            $filesize = $_FILES['artwork']['size'];
            $tmp_image_artwork = addslashes($_FILES['artwork']['tmp_name']);
            $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
            $ext = strtolower(pathinfo($artwork, PATHINFO_EXTENSION));
            $artwork = $random.' - '.$artwork;
            $path_image_artwork = $path.$artwork;

            if(!in_array($ext, $invalid_extensions)) {
                move_uploaded_file($tmp_image_artwork,$path_image_artwork);
                mysqli_query( $conn,"UPDATE tbl_products set artwork='". $artwork ."' WHERE ID='". $ID ."'" );

                $output = array (
                    'type'  =>  0,
                    'name' =>  $artwork,
                    'size' =>  $filesize,
                    'date' =>  $local_date
                );
                array_push($arr_item, $output);
            } else {
                $process = false;
            }
        }
    
        $haccp = addslashes($_FILES['haccp']['name']);
        if (!empty($haccp)) {
            $filesize = $_FILES['haccp']['size'];
            $tmp_image_haccp = addslashes($_FILES['haccp']['tmp_name']);
            $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
            $ext = strtolower(pathinfo($haccp, PATHINFO_EXTENSION));
            $haccp = $random.' - '.$haccp;
            $path_image_haccp = $path.$haccp;

            if(!in_array($ext, $invalid_extensions)) {
                move_uploaded_file($tmp_image_haccp,$path_image_haccp);
                mysqli_query( $conn,"UPDATE tbl_products set haccp='". $haccp ."' WHERE ID='". $ID ."'" );

                $output = array (
                    'type'  =>  0,
                    'name' =>  $haccp,
                    'size' =>  $filesize,
                    'date' =>  $local_date
                );
                array_push($arr_item, $output);
            } else {
                $process = false;
            }
        }

        $label = addslashes($_FILES['label']['name']);
        if (!empty($label)) {
            $filesize = $_FILES['label']['size'];
            $tmp_image_label = addslashes($_FILES['label']['tmp_name']);
            $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
            $ext = strtolower(pathinfo($label, PATHINFO_EXTENSION));
            $label = $random.' - '.$label;
            $path_image_label = $path.$label;

            if(!in_array($ext, $invalid_extensions)) {
                move_uploaded_file($tmp_image_label,$path_image_label);
                mysqli_query( $conn,"UPDATE tbl_products set label='". $label ."' WHERE ID='". $ID ."'" );

                $output = array (
                    'type'  =>  0,
                    'name' =>  $label,
                    'size' =>  $filesize,
                    'date' =>  $local_date
                );
                array_push($arr_item, $output);
            } else {
                $process = false;
            }
        }

        $formulation = addslashes($_FILES['formulation']['name']);
        if (!empty($formulation)) {
            $filesize = $_FILES['formulation']['size'];
            $tmp_image_formulation = addslashes($_FILES['formulation']['tmp_name']);
            $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
            $ext = strtolower(pathinfo($formulation, PATHINFO_EXTENSION));
            $formulation = $random.' - '.$formulation;
            $path_image_formulation = $path.$formulation;

            if(!in_array($ext, $invalid_extensions)) {
                move_uploaded_file($tmp_image_formulation,$path_image_formulation);
                mysqli_query( $conn,"UPDATE tbl_products set formulation='". $formulation ."' WHERE ID='". $ID ."'" );

                $output = array (
                    'type'  =>  0,
                    'name' =>  $formulation,
                    'size' =>  $filesize,
                    'date' =>  $local_date
                );
                array_push($arr_item, $output);
            } else {
                $process = false;
            }
        }

        $origin = addslashes($_FILES['origin']['name']);
        if (!empty($origin)) {
            $filesize = $_FILES['origin']['size'];
            $tmp_image_origin = addslashes($_FILES['origin']['tmp_name']);
            $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
            $ext = strtolower(pathinfo($specifcation, PATHINFO_EXTENSION));
            $origin = $random.' - '.$origin;
            $path_image_origin = $path.$origin;

            if(!in_array($ext, $invalid_extensions)) {
                move_uploaded_file($tmp_image_origin,$path_image_origin);
                mysqli_query( $conn,"UPDATE tbl_products set origin='". $origin ."' WHERE ID='". $ID ."'" );

                $output = array (
                    'type'  =>  0,
                    'name' =>  $origin,
                    'size' =>  $filesize,
                    'date' =>  $local_date
                );
                array_push($arr_item, $output);
            } else {
                $process = false;
            }
        }

        $procedures = addslashes($_FILES['procedures']['name']);
        if (!empty($procedures)) {
            $filesize = $_FILES['procedures']['size'];
            $tmp_image_procedures = addslashes($_FILES['procedures']['tmp_name']);
            $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
            $ext = strtolower(pathinfo($procedures, PATHINFO_EXTENSION));
            $procedures = $random.' - '.$procedures;
            $path_image_procedures = $path.$procedures;

            if(!in_array($ext, $invalid_extensions)) {
                move_uploaded_file($tmp_image_procedures,$path_image_procedures);
                mysqli_query( $conn,"UPDATE tbl_products set procedures='". $procedures ."' WHERE ID='". $ID ."'" );

                $output = array (
                    'type'  =>  0,
                    'name' =>  $procedures,
                    'size' =>  $filesize,
                    'date' =>  $local_date
                );
                array_push($arr_item, $output);
            } else {
                $process = false;
            }
        }

        $analysis = addslashes($_FILES['analysis']['name']);
        if (!empty($analysis)) {
            $filesize = $_FILES['analysis']['size'];
            $tmp_image_analysis = addslashes($_FILES['analysis']['tmp_name']);
            $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
            $ext = strtolower(pathinfo($analysis, PATHINFO_EXTENSION));
            $analysis = $random.' - '.$analysis;
            $path_image_analysis = $path.$analysis;

            if(!in_array($ext, $invalid_extensions)) {
                move_uploaded_file($tmp_image_analysis,$path_image_analysis);
                mysqli_query( $conn,"UPDATE tbl_products set analysis='". $analysis ."' WHERE ID='". $ID ."'" );

                $output = array (
                    'type'  =>  0,
                    'name' =>  $analysis,
                    'size' =>  $filesize,
                    'date' =>  $local_date
                );
                array_push($arr_item, $output);
            } else {
                $process = false;
            }
        }

        $sheet = addslashes($_FILES['sheet']['name']);
        if (!empty($sheet)) {
            $filesize = $_FILES['sheet']['size'];
            $tmp_image_sheet = addslashes($_FILES['sheet']['tmp_name']);
            $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
            $ext = strtolower(pathinfo($sheet, PATHINFO_EXTENSION));
            $sheet = $random.' - '.$sheet;
            $path_image_sheet = $path.$sheet;

            if(!in_array($ext, $invalid_extensions)) {
                move_uploaded_file($tmp_image_sheet,$path_image_sheet);
                mysqli_query( $conn,"UPDATE tbl_products set sheet='". $sheet ."' WHERE ID='". $ID ."'" );

                $output = array (
                    'type'  =>  0,
                    'name' =>  $sheet,
                    'size' =>  $filesize,
                    'date' =>  $local_date
                );
                array_push($arr_item, $output);
            } else {
                $process = false;
            }
        }

        $guarantee = addslashes($_FILES['guarantee']['name']);
        if (!empty($guarantee)) {
            $filesize = $_FILES['guarantee']['size'];
            $tmp_image_guarantee = addslashes($_FILES['guarantee']['tmp_name']);
            $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
            $ext = strtolower(pathinfo($guarantee, PATHINFO_EXTENSION));
            $guarantee = $random.' - '.$guarantee;
            $path_image_guarantee = $path.$guarantee;

            if(!in_array($ext, $invalid_extensions)) {
                move_uploaded_file($tmp_image_guarantee,$path_image_guarantee);
                mysqli_query( $conn,"UPDATE tbl_products set guarantee='". $guarantee ."' WHERE ID='". $ID ."'" );

                $output = array (
                    'type'  =>  0,
                    'name' =>  $guarantee,
                    'size' =>  $filesize,
                    'date' =>  $local_date
                );
                array_push($arr_item, $output);
            } else {
                $process = false;
            }
        }

        $conformance = addslashes($_FILES['conformance']['name']);
        if (!empty($conformance)) {
            $filesize = $_FILES['conformance']['size'];
            $tmp_image_conformance = addslashes($_FILES['conformance']['tmp_name']);
            $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
            $ext = strtolower(pathinfo($conformance, PATHINFO_EXTENSION));
            $conformance = $random.' - '.$conformance;
            $path_image_conformance = $path.$conformance;

            if(!in_array($ext, $invalid_extensions)) {
                move_uploaded_file($tmp_image_conformance,$path_image_conformance);
                mysqli_query( $conn,"UPDATE tbl_products set conformance='". $conformance ."' WHERE ID='". $ID ."'" );

                $output = array (
                    'type'  =>  0,
                    'name' =>  $conformance,
                    'size' =>  $filesize,
                    'date' =>  $local_date
                );
                array_push($arr_item, $output);
            } else {
                $process = false;
            }
        }

        $insurance = addslashes($_FILES['insurance']['name']);
        if (!empty($insurance)) {
            $filesize = $_FILES['insurance']['size'];
            $tmp_image_insurance = addslashes($_FILES['insurance']['tmp_name']);
            $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
            $ext = strtolower(pathinfo($insurance, PATHINFO_EXTENSION));
            $insurance = $random.' - '.$insurance;
            $path_image_insurance = $path.$insurance;

            if(!in_array($ext, $invalid_extensions)) {
                move_uploaded_file($tmp_image_insurance,$path_image_insurance);
                mysqli_query( $conn,"UPDATE tbl_products set insurance='". $insurance ."' WHERE ID='". $ID ."'" );

                $output = array (
                    'type'  =>  0,
                    'name' =>  $insurance,
                    'size' =>  $filesize,
                    'date' =>  $local_date
                );
                array_push($arr_item, $output);
            } else {
                $process = false;
            }
        }

		$specifcation_date = $_POST['specifcation_date'];
		$artwork_date = $_POST['artwork_date'];
		$haccp_date = $_POST['haccp_date'];
		$label_date = $_POST['label_date'];
		$formulation_date = $_POST['formulation_date'];
		mysqli_query( $conn,"UPDATE tbl_products set specifcation_date='". $specifcation_date ."', artwork_date='". $artwork_date ."', haccp_date='". $haccp_date ."', label_date='". $label_date ."', formulation_date='". $formulation_date ."' WHERE ID='". $ID ."'" );

		$artwork_radio = $_POST['artwork_radio'];
		$haccp_radio = $_POST['haccp_radio'];
		$label_radio = $_POST['label_radio'];
		$formulation_radio = $_POST['formulation_radio'];
		$origin_radio = $_POST['origin_radio'];
		$procedures_radio = $_POST['procedures_radio'];
		$analysis_radio = $_POST['analysis_radio'];
		$specifcation_radio = $_POST['specifcation_radio'];
		$sheet_radio = $_POST['sheet_radio'];
		$guarantee_radio = $_POST['guarantee_radio'];
		$conformance_radio = $_POST['conformance_radio'];
		$insurance_radio = $_POST['insurance_radio'];
		mysqli_query( $conn,"UPDATE tbl_products set haccp_radio='". $haccp_radio ."', label_radio='". $label_radio ."', formulation_radio='". $formulation_radio ."', artwork_radio='". $artwork_radio ."', origin_radio='". $origin_radio ."', procedures_radio='". $procedures_radio ."', analysis_radio='". $analysis_radio ."', specifcation_radio='". $specifcation_radio ."', sheet_radio='". $sheet_radio ."', guarantee_radio='". $guarantee_radio ."', conformance_radio='". $conformance_radio ."', insurance_radio='". $insurance_radio ."' WHERE ID='". $ID ."'" );

        $intended_consumers = $_POST['intended_consumers'];
        $packaging_temperature = $_POST['packaging_temperature'];
        $labeling_instructions = $_POST['labeling_instructions'];
        $physical_chars = isset($_POST['physical_chars']) && count($_POST['physical_chars']) > 0 ? json_encode($_POST['physical_chars']) : NULL;
        $physico_chem_char = isset($_POST['physico_chem_char']) && count($_POST['physico_chem_char']) > 0 ? json_encode($_POST['physico_chem_char']) : NULL;
        $microbial_char = isset($_POST['microbial_char']) && count($_POST['microbial_char']) > 0 ? json_encode($_POST['microbial_char']) : NULL;
        mysqli_query( $conn,"UPDATE tbl_products set intended_consumers='$intended_consumers', packaging_temperature='$packaging_temperature', labeling_instructions='$labeling_instructions', 
        physical_characteristics=".(isset($physical_chars) ? "'$physical_chars'" : "NULL").",
        physico_chemical_characteristics=".(isset($physico_chem_char) ? "'$physico_chem_char'" : "NULL").",
        microbiological_characteristics=".(isset($microbial_char) ? "'$microbial_char'" : "NULL")." WHERE ID='". $ID ."'" );

        $vendor_name = $_POST['vendor_name'] ?? '';
        $vendor_code = $_POST['vendor_code'] ?? '';
        $mb_enterprise_name = $_POST['mb_enterprise_name'] ?? '';
        $mb_lot_code = $_POST['mb_lot_code'] ?? '';
        $mb_manufactured_date = $_POST['mb_manufactured_date'] ?? '';
        $mb_expiry_date = $_POST['mb_expiry_date'] ?? '';
        $traded_supplier_name = $_POST['traded_supplier_name'] ?? '';
        $traded_supplied_for = $_POST['traded_supplied_for'] ?? '';
        $traded_manufactured_date = $_POST['traded_manufactured_date'] ?? '';
        $traded_expiry_date = $_POST['traded_expiry_date'] ?? '';
        $branded_manufactured_by = $_POST['branded_manufactured_by'] ?? '';
        $branded_manufactured_for = $_POST['branded_manufactured_for'] ?? '';
        $branded_manufactured_date = $_POST['branded_manufactured_date'] ?? '';
        $branded_expiry_date = $_POST['branded_expiry_date'] ?? '';
        $branded_lot_code_by_manufacturer = $_POST['branded_lot_code_by_manufacturer'] ?? '';
        $branded_lot_code_by_enterprise = $_POST['branded_lot_code_by_enterprise'] ?? '';
        $delivered_from = $_POST['delivered_from'] ?? '';
        $country_of_origin = $_POST['country_of_origin'] ?? '';
        $country_of_purchase = $_POST['country_of_purchase'] ?? '';
        mysqli_query( $conn,"UPDATE tbl_products set vendor_name='$vendor_name', vendor_code='$vendor_code', mb_enterprise_name='$mb_enterprise_name', mb_lot_code='$mb_lot_code', mb_manufactured_date='$mb_manufactured_date', mb_expiry_date='$mb_expiry_date', traded_supplier_name='$traded_supplier_name', traded_supplied_for='$traded_supplied_for', traded_manufactured_date='$traded_manufactured_date', traded_expiry_date='$traded_expiry_date', branded_manufactured_by='$branded_manufactured_by', branded_manufactured_for='$branded_manufactured_for', branded_manufactured_date='$branded_manufactured_date', branded_expiry_date='$branded_expiry_date', branded_lot_code_by_manufacturer='$branded_lot_code_by_manufacturer', branded_lot_code_by_enterprise='$branded_lot_code_by_enterprise', delivered_from='$delivered_from', country_of_origin='$country_of_origin', country_of_purchase='$country_of_purchase' WHERE ID='". $ID ."'" );
        // almario

		$arr_docs = array();
		$arr_docs_date = array();
		for ($i=0; $i < count($_POST['docs']); $i++) {
            $docs_label = $_POST['docs'][$i]['docs_label'];
            $docs_date = $_POST['docs'][$i]['docs_date'];
            $docs_tmp = $_POST['docs'][$i]['docs_tmp'] ?? '';
            $docs_radio = $_POST['docs'][$i]['docs_radio'] ?? 0;
            $docs_file = implode('*', $_FILES['docs']['name'][$i]);

            $final_file = '';
            if (!empty($docs_file)) {
                $filesize = implode('*', $_FILES['docs']['size'][$i]);
                $tmp = implode('*', $_FILES['docs']['tmp_name'][$i]);
                $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                $ext = strtolower(pathinfo($docs_file, PATHINFO_EXTENSION));
                $files = $docs_file;
                $final_file = $random . ' - ' . $files;
                $final_path = $path.$final_file;

                if(!in_array($ext, $invalid_extensions)) {
                    move_uploaded_file($tmp,$final_path);

                    $output = array (
                        'type'  =>  0,
                        'name' =>  $final_file,
                        'size' =>  $filesize,
                        'date' =>  $local_date
                    );
                    array_push($arr_item, $output);

                    $docs_data = array (
                        'docs_label'    =>  $docs_label,
                        'docs_radio'    =>  $docs_radio,
                        'docs_file'     =>  $final_file,
                        'docs_date'     =>  $docs_date
                    );
                    array_push( $arr_docs, $docs_data );

                    // $docs_data_date = array (
                    //     'docs_date'     =>  $docs_date
                    // );
                    // array_push( $arr_docs_date, $docs_data_date );
                } else {
                    $process = false;
                }
            } else if (!empty($docs_tmp)) {
                $docs_data = array (
                    'docs_label'    =>  $docs_label,
                    'docs_radio'    =>  $docs_radio,
                    'docs_file'     =>  $docs_tmp,
                    'docs_date'     =>  $docs_date
                );
                array_push( $arr_docs, $docs_data );
            }
        }
        if ($process == true) {
            $docs = json_encode($arr_docs, JSON_HEX_APOS | JSON_UNESCAPED_UNICODE);
    		mysqli_query( $conn,"UPDATE tbl_products set docs='". $docs ."' WHERE ID='". $ID ."'" );

    		// $docs_dates = json_encode($arr_docs_date);
    		// mysqli_query( $conn,"UPDATE tbl_products set docs_date='". $docs_dates ."' WHERE ID='". $ID ."'" );

            $file_history = json_encode($arr_item, JSON_HEX_APOS | JSON_UNESCAPED_UNICODE);
            mysqli_query( $conn,"UPDATE tbl_products set file_history='". $file_history ."' WHERE ID='". $ID ."'" );

    		if (!mysqli_error($conn)) {

                if (!empty($_POST['labs'])) {
                    $labs = implode(", ", $_POST["labs"]);
                    $labs_arr = explode(", ", $labs);
                    foreach ($labs_arr as $value) {
                        mysqli_query( $conn,"UPDATE tbl_products_lab set product_id = $ID WHERE ID = $value" );
                    }
                }

    			$selectData = mysqli_query( $conn,"SELECT * FROM tbl_products WHERE ID = $ID" );
    			if ( mysqli_num_rows($selectData) > 0 ) {
    	            $row = mysqli_fetch_array($selectData);
    	            $data_name = $row['name'];
    	            $data_description = $row['description'];
    	            $data_last_modified = $row['last_modified'];

    				$data_image = $row['image'];
                    $url_base = "";
                    $image_main = "https://via.placeholder.com/40x40/EFEFEF/AAAAAA.png?text=No+Image";

                    if (!empty($data_image)) {

                        $data_image_array = explode(", ", $data_image);
                        if (!empty($data_image_array[0])) {
                            $url_base = $base_url."uploads/products/";

                            $image_main = $data_image_array[0];
                        }
                    }

                    $img_url = $url_base.$image_main;

                    $data_category_id = $row['category'];
                    if ($data_category_id == 9) {
                        $category = $row['category_other'];
                    } else {
                        $resultCategory = mysqli_query( $conn,"SELECT * FROM tbl_products_category WHERE ID = $data_category_id" );
                        $rowCategory = mysqli_fetch_array($resultCategory);
                        $category = $rowCategory['name'];
                    }
    	        }

    			$output = array(
    				'ID' => $ID,
                    "name" => stripcslashes(htmlentities($data_name)),
                    "description" => stripcslashes(htmlentities($data_description)),
    				'image' => $img_url,
    				'category' => $category,
    				'last_modified' => $last_modified
    			);
    			echo json_encode($output);
    		}

    		mysqli_close($conn);
    	}
    }

    // Lab Section
    if( isset($_GET['modalNew_Lab']) ) {
        $modal = $_GET['modalNew_Lab'];

        echo '<input class="form-control" type="hidden" name="modal" value="'.$modal.'" />
        <div class="row">
            <div class="col-md-3">
                <div class="form-group">
                    <label class="control-label">Lot #</label>
                    <input class="form-control" type="text" name="lot" />
                </div>
            </div>
            <div class="col-md-3">
                <div class="form-group">
                    <label class="control-label">Lab</label>
                    <input class="form-control" type="text" name="lab" />
                </div>
            </div>
            <div class="col-md-3">
                <div class="form-group">
                    <label class="control-label">Analysis</label>
                    <input class="form-control" type="text" name="analysis" />
                </div>
            </div>
            <div class="col-md-3">
                <div class="form-group">
                    <label class="control-label">Method</label>
                    <input class="form-control" type="text" name="method" />
                </div>
            </div>
            <div class="col-md-3">
                <div class="form-group">
                    <label class="control-label">Sample Size</label>
                    <input class="form-control" type="text" name="sample_size" />
                </div>
            </div>
            <div class="col-md-3">
                <div class="form-group">
                    <label class="control-label">Unit</label>
                    <input class="form-control" type="text" name="unit" />
                </div>
            </div>
            <div class="col-md-3">
                <div class="form-group">
                    <label class="control-label">Date Sent for Lab</label>
                    <input class="form-control" type="date" name="date_sent" />
                </div>
            </div>
            <div class="col-md-3">
                <div class="form-group">
                    <label class="control-label">Date Received</label>
                    <input class="form-control" type="date" name="date_received" />
                </div>
            </div>
        </div>';
    }
    if( isset($_GET['modalEdit_Lab']) ) {
        $ID = $_GET['modalEdit_Lab'];
        $modal = $_GET['modal'];

        $selectData = mysqli_query( $conn,"SELECT * FROM tbl_products_lab WHERE ID = $ID" );
        if ( mysqli_num_rows($selectData) > 0 ) {
            $rowData = mysqli_fetch_array($selectData);

            echo '<input class="form-control" type="hidden" name="ID" value="'.$ID.'" />
            <input class="form-control" type="hidden" name="modal" value="'.$modal.'" />
            <div class="row">
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="control-label">Lot #</label>
                        <input class="form-control" type="text" name="lot" value="'.$rowData['lot'].'" />
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="control-label">Lab</label>
                        <input class="form-control" type="text" name="lab" value="'.$rowData['lab'].'" />
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="control-label">Analysis</label>
                        <input class="form-control" type="text" name="analysis" value="'.$rowData['analysis'].'" />
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="control-label">Method</label>
                        <input class="form-control" type="text" name="method" value="'.$rowData['method'].'" />
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="control-label">Sample Size</label>
                        <input class="form-control" type="text" name="sample_size" value="'.$rowData['sample_size'].'" />
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="control-label">Unit</label>
                        <input class="form-control" type="text" name="unit" value="'.$rowData['unit'].'" />
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="control-label">Date Sent for Lab</label>
                        <input class="form-control" type="date" name="date_sent" value="'.$rowData['date_sent'].'" />
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="control-label">Date Received</label>
                        <input class="form-control" type="date" name="date_received" value="'.$rowData['date_received'].'" />
                    </div>
                </div>
            </div>';
        }
    }
    if( isset($_GET['btnDelete_Lab']) ) {
        $ID = $_GET['btnDelete_Lab'];

        mysqli_query( $conn,"UPDATE tbl_products_lab set deleted = 1 WHERE ID = $ID" );
    }
    if( isset($_POST['btnSave_Lab']) ) {
        $modal = $_POST['modal'];

        $lot = addslashes($_POST['lot']);
        $lab = addslashes($_POST['lab']);
        $analysis = addslashes($_POST['analysis']);
        $method = addslashes($_POST['method']);
        $sample_size = addslashes($_POST['sample_size']);
        $unit = addslashes($_POST['unit']);
        $date_sent = addslashes($_POST['date_sent']);
        $date_received = addslashes($_POST['date_received']);

        $sql = "INSERT INTO tbl_products_lab (lot, lab, analysis, method, sample_size, unit, date_sent, date_received)
        VALUES ('$lot', '$lab', '$analysis', '$method', '$sample_size', '$unit', '$date_sent', '$date_received')";
        if (mysqli_query($conn, $sql)) {
            $last_id = mysqli_insert_id($conn);

            $data = '<tr id="tr_'.$last_id.'">
                <td>'.htmlentities($lot).'</td>
                <td>'.htmlentities($lab).'</td>
                <td>'.htmlentities($analysis).'</td>
                <td>'.htmlentities($method).'</td>
                <td>'.htmlentities($sample_size).'</td>
                <td>'.htmlentities($unit).'</td>
                <td class="text-center">'.$date_sent.'</td>
                <td class="text-center">'.$date_received.'</td>
                <td class="text-center">
                    <input type="hidden" name="labs[]" value="'.$last_id.'" />
                    <div class="btn-group btn-group-circle">
                        <a href="#modalEditLab" data-toggle="modal" class="btn btn-outline dark btn-sm" onclick="btnEdit_Lab('.$last_id.', '.$modal.')">Edit</a>
                        <a href="javascript:;" class="btn btn-outlinex red btn-sm" onclick="btnRemove_Lab('.$last_id.', this)">Delete</a>
                    </div>
                </td>
            </tr>';
            
            $output = array(
                "ID" => $last_id,
                "data" => $data,
                "modal" => $modal
            );
            echo json_encode($output);
        }
    }
    if( isset($_POST['btnUpdate_Lab']) ) {
        $ID = $_POST['ID'];
        $modal = $_POST['modal'];

        $lot = addslashes($_POST['lot']);
        $lab = addslashes($_POST['lab']);
        $analysis = addslashes($_POST['analysis']);
        $method = addslashes($_POST['method']);
        $sample_size = addslashes($_POST['sample_size']);
        $unit = addslashes($_POST['unit']);
        $date_sent = addslashes($_POST['date_sent']);
        $date_received = addslashes($_POST['date_received']);

        mysqli_query( $conn,"UPDATE tbl_products_lab set lot = '".$lot."', lab = '".$lab."', analysis = '".$analysis."', method = '".$method."', sample_size = '".$sample_size."', unit = '".$unit."', date_sent = '".$date_sent."', date_received = '".$date_received."' WHERE ID = $ID" );
        if (!mysqli_error($conn)) {
            $data = '<td>'.htmlentities($lot).'</td>
            <td>'.htmlentities($lab).'</td>
            <td>'.htmlentities($analysis).'</td>
            <td>'.htmlentities($method).'</td>
            <td>'.htmlentities($sample_size).'</td>
            <td>'.htmlentities($unit).'</td>
            <td class="text-center">'.$date_sent.'</td>
            <td class="text-center">'.$date_received.'</td>
            <td class="text-center">
                <input type="hidden" name="labs[]" value="'.$ID.'" />
                <div class="btn-group btn-group-circle">
                    <a href="#modalEditLab" data-toggle="modal" class="btn btn-outline dark btn-sm" onclick="btnEdit_Lab('.$ID.', '.$modal.')">Edit</a>
                    <a href="javascript:;" class="btn btn-outlinex red btn-sm" onclick="btnRemove_Lab('.$ID.', this)">Delete</a>
                </div>
            </td>';
            
            $output = array(
                "ID" => $ID,
                "data" => $data,
                "modal" => $modal
            );
            echo json_encode($output);
        }
    }


	// INSTRUCTION PAGE
	if( isset($_GET['modalInstruction']) ) {
		$site = $_GET['modalInstruction'];
    	$current_userID = $_COOKIE['ID'];
        $file_title = '';
        $type_id = 0;
        $file_upload = '';
        $youtube_link = '';
		$src = '';
		$embed = '';
		$type = '';
        $url = '';
        $file_url = '';

		// $selectData = mysqli_query( $conn,"SELECT * FROM tbl_pages_demo_video WHERE user_id = $current_userID AND page = '".$site."'" );
		$selectData = mysqli_query( $conn,"SELECT * FROM tbl_pages_demo_video WHERE page = '".$site."'" );
		if ( mysqli_num_rows($selectData) > 0 ) {
            $row = mysqli_fetch_array($selectData);
            $id = $row["id"];
            $file_name = $row["file_name"];
            $page = $row["page"];
            $file_title = $row["file_title"];
            $privacy = $row["privacy"];
            $type_id = $row["type"];
            $youtube_link = $row["youtube_link"];

            $file_upload = $row["file_upload"];
            if (!empty($file_upload)) {
	            $fileExtension = fileExtension($file_upload);
				$src = $fileExtension['src'];
				$embed = $fileExtension['embed'];
				$type = $fileExtension['type'];
				$file_extension = $fileExtension['file_extension'];
	            $url = $base_url.'uploads/instruction/';

        		$file_url = $src.$url.rawurlencode($file_upload).$embed;
            }
        }

		echo '<input class="form-control" type="hidden" name="page" value="'. $site .'" />
        <div class="form-group">
            <label class="col-md-3 control-label">Title</label>
            <div class="col-md-8">
                <input class="form-control" type="text" name="description" value="'.$file_title.'" />
            </div>
        </div>
		<div class="form-group">
            <label class="col-md-3 control-label">Select Type</label>
            <div class="col-md-8">
                <select class="form-control" name="type" onchange="selectInstruction(this.value)">
                	<option value="0" '; echo $type_id == 0 ? 'SELECTED':''; echo '>Upload Instruction</option>
                	<option value="1" '; echo $type_id == 1 ? 'SELECTED':''; echo '>Youtube URL</option>
                	<option value="2" '; echo $type_id == 2 ? 'SELECTED':''; echo '>Google Drive URL</option>
                </select>
            </div>
        </div>
		<div class="form-group selInstruction '; echo $type_id == 0 ? '':'hide'; echo '" id="selFile">
            <label class="col-md-3 control-label">Select File</label>
            <div class="col-md-8">
                <input class="form-control '; echo !empty($file_upload) ? 'hide':''; echo '" type="file" name="file" />
                <p class="'; echo !empty($file_upload) ? '':'hide'; echo '" style="margin: 0;"><a data-src="'.$file_url.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a> | <button type="button" class="btn btn-link uploadNew" onclick="uploadNew(this)">Upload New</button></p>
            </div>
        </div>
		<div class="form-group selInstruction '; echo $type_id == 0 ? 'hide':''; echo '" id="selURL">
            <label class="col-md-3 control-label">Enter URL</label>
            <div class="col-md-8">
                <input class="form-control" type="text" name="url" value="'.$youtube_link.'" placeholder="https://" />
            </div>
        </div>';

        mysqli_close($conn);
	}
	if( isset($_POST['btnSave_Instruction']) ) {
		$site = $_POST['page'];
    	$current_userID = $_COOKIE['ID'];
		$file_title = addslashes($_POST['description']);
		$type_id = $_POST['type'];
		$youtube_link = $_POST['url'];
		$path = 'uploads/instruction/';
		$random = rand(1000,1000000);
		$msg = 'No';
        $process = true;

		$selectData = mysqli_query( $conn,"SELECT * FROM tbl_pages_demo_video WHERE user_id = $current_userID AND page = '".$site."'" );
		if ( mysqli_num_rows($selectData) > 0 ) {
            $row = mysqli_fetch_array($selectData);
            $last_id = $row["id"];

            mysqli_query( $conn,"UPDATE tbl_pages_demo_video SET file_title = '".$file_title."', type = '".$type_id."' WHERE id = '".$last_id."'" );
            $msg = "Update";
        } else {
			$sql = "INSERT INTO tbl_pages_demo_video (page, user_id, file_title, type)
			VALUES ('$site', '$current_userID', '$file_title', '$type_id')";
			if (mysqli_query($conn, $sql)) {
				$last_id = mysqli_insert_id($conn);
			}
            $msg = "New";
        }

		if ($type_id == 0) {
			$file_upload = $_FILES['file']['name'];
			if (!empty($file_upload)) {
				$tmp = $_FILES['file']['tmp_name'];
                $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                $ext = strtolower(pathinfo($file_upload, PATHINFO_EXTENSION));
				$file_upload = $random . ' - ' . $file_upload;
				$path = $path.$file_upload;

                if(!in_array($ext, $invalid_extensions)) {
                    move_uploaded_file($tmp,$path);

                    mysqli_query( $conn,"UPDATE tbl_pages_demo_video SET file_upload = '".$file_upload."' WHERE id = '".$last_id."'" );
                } else {
                    $process = false;
                }
			}
		} else if ($type_id == 1 OR $type_id == 2) {
			mysqli_query( $conn,"UPDATE tbl_pages_demo_video SET youtube_link = '".$youtube_link."' WHERE id = '".$last_id."'" );
		}

        if ($process == true) {
    		$output = array(
    			'message' => $msg
    		);
    		echo json_encode($output);
    	}
    }


	// SPEAKUP PAGE
	if( isset($_GET['modalSpeakup']) ) {
		$ID = $_GET['modalSpeakup'];

		$portal_user = $_COOKIE['ID'];
		$user_id = employerID($portal_user);

		$selectData = mysqli_query( $conn,"SELECT * FROM tbl_speakup WHERE ID = $ID" );
		if ( mysqli_num_rows($selectData) > 0 ) {
            $row = mysqli_fetch_array($selectData);
            $data_ortal_user = $row["portal_user"];
            $comment = nl2br($row["comment"]);

            if ($row["portal_user"] <> $portal_user) {
            	mysqli_query( $conn,"UPDATE tbl_speakup set seen = 1 WHERE ID = $ID" );
            }
        }

        $data = '<input type="hidden" name="ID" value="'.$ID.'" />'.$comment;
		$data .= '<ul class="speakup_list margin-top-15">';
			$selectDataReply = mysqli_query( $conn,"SELECT * FROM tbl_speakup WHERE reply_to = $ID" );
			if ( mysqli_num_rows($selectDataReply) > 0 ) {
				while($row = mysqli_fetch_array($selectDataReply)) {
					$comment = nl2br($row["comment"]);

					$last_modified = $row["last_modified"];
                    $last_modified = new DateTime($last_modified);
                    $last_modified = $last_modified->format('M d, Y');

					$data .= '<li>'.$comment.'<br>'.$last_modified.'</li>';
				}
	        }
        $data .= '</ul>';

        echo $data;
	}
	if( isset($_GET['modalSpeakupAll']) ) {
		$ID = $_GET['modalSpeakupAll'];

		$selectData = mysqli_query( $conn,"SELECT * FROM tbl_speakup WHERE reply_to = 0 AND user_id = $ID" );
		if ( mysqli_num_rows($selectData) > 0 ) {
			while($row = mysqli_fetch_array($selectData)) {
				$data_ID = $row["ID"];
				$data_comment = nl2br($row["comment"]);

				$data_last_modified = $row["last_modified"];
                $data_last_modified = new DateTime($data_last_modified);
                $data_last_modified = $data_last_modified->format('M d, Y');

				echo '<tr>
					<td><div class="line-clamp">'.$data_comment.'</div></td>
					<td class="text-center">'.$data_last_modified.'</td>
					<td class="text-center"><a href="#modalSpeakUpView" class="btn btn-success btn-sm btn-circle" data-toggle="modal" onclick="btnSpeakup('.$data_ID.')">View</a></td>
				</tr>';
			}
        }
	}
	if( isset($_POST['btnSave_Speakup']) ) {
		$portal_user = $_COOKIE['ID'];
		$user_id = employerID($portal_user);

		$comment = addslashes($_POST['comment']);
		$last_modified = date('Y-m-d');
		$msg = 'Sent';

		$sql = "INSERT INTO tbl_speakup (user_id, portal_user, comment, last_modified)
		VALUES ('$user_id', '$portal_user', '$comment', '$last_modified')";
		if (mysqli_query($conn, $sql)) {
			$last_id = mysqli_insert_id($conn);

            $last_modified = new DateTime($last_modified);
            $last_modified = $last_modified->format('M d, Y');

			$data = '<li>
	            <a href="#modalSpeakUpView" data-toggle="modal" onclick="btnSpeakup('.$last_id.')" style="text-decoration: none;">
	                <span class="sbold">'.stripcslashes($comment).'</span>
	                <div class="time text-right">'.$last_modified.'</div>
	            </a>
	        </li>';
		}

		$to = 'arnel@consultareinc.com';
		$to2 = 'cristina@consultareinc.com';
		$to3 = '';
		$user = 'InterlinkIQ';
		$subject = 'New SpeakUp '.$last_modified;
		$body = 'Annonymous said:<br><br>

		<i>'.nl2br($comment).'</i>';

		php_mailer_request_service($to, $to2, $to3, $user, $subject, $body);


		$output = array(
			'data' => $data
		);
		echo json_encode($output);
	}
	if( isset($_POST['btnSave_SpeakupView']) ) {
		$portal_user = $_COOKIE['ID'];
		$user_id = employerID($portal_user);

		$ID = $_POST['ID'];
		$comment = addslashes($_POST['comment']);
		$last_modified = date('Y-m-d');
		$msg = 'Sent';

		$sql = "INSERT INTO tbl_speakup (user_id, portal_user, reply_to, comment, last_modified)
		VALUES ('$user_id', '$portal_user', '$ID', '$comment', '$last_modified')";
		mysqli_query($conn, $sql);

        $last_modified = new DateTime($last_modified);
        $last_modified = $last_modified->format('M d, Y');

		$to = 'arnel@consultareinc.com';
		$to2 = 'cristina@consultareinc.com';
		$to3 = '';
		$user = 'InterlinkIQ';
		$subject = 'New SpeakUp '.$last_modified;
		$body = 'Annonymous said:<br><br>

		<i>'.nl2br($comment).'</i>';

		php_mailer_request_service($to, $to2, $to3, $user, $subject, $body);

		$output = array(
			'comment' => stripcslashes($comment),
			'last_modified' => $last_modified
		);
		echo json_encode($output);
	}


	// STICKY NOTES
	if( isset($_GET['modalNotes_view']) ) {
		$ID = $_GET['modalNotes_view'];
		$portal_user = $_COOKIE['ID'];
		$user_id = employerID($portal_user);

		$result = mysqli_query( $conn,"SELECT * FROM tbl_notes WHERE ID = $ID" );
        if ( mysqli_num_rows($result) > 0 ) {
        	$row = mysqli_fetch_array($result);
        	$description = $row["description"];
        	$status = $row["status"];
        }

		echo '<input type="hidden" value="'.$ID.'" name="ID" />
		<div class="form-group">
            <textarea class="form-control" name="description" rows="5">'.$description.'</textarea>
       	</div>
    	<div class="form-group hide">
            <label>Endorse To</label>
            <select class="form-control mt-multiselect" name="assigned_to[]" multiple="multiple">';

            	$array_assigned_to = explode(", ", $row["assigned_to"]);
                $selectEmployeee = mysqli_query( $conn,"SELECT * FROM tbl_hr_employee WHERE suspended = 0 AND status = 1 AND user_id = $user_id ORDER BY first_name" );
                if ( mysqli_num_rows($selectEmployeee) > 0 ) {
                    while($rowEmployee = mysqli_fetch_array($selectEmployeee)) {
                    	if (in_array($rowEmployee["ID"], $array_assigned_to)) {
                    		echo '<option value="'. $rowEmployee["ID"] .'" SELECTED>'. $rowEmployee["first_name"] .' '. $rowEmployee["last_name"] .'</option>';
                    	} else {
                    		echo '<option value="'. $rowEmployee["ID"] .'">'. $rowEmployee["first_name"] .' '. $rowEmployee["last_name"] .'</option>';
                    	}
                    }
                }

            echo '</select>
       	</div>
    	<div class="form-group hide">
            <label>Copy To</label>
            <select class="form-control mt-multiselect" name="copy_to[]" multiple="multiple">';

        		$array_copy_to = explode(", ", $row["copy_to"]);
                $selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE is_verified = 1 AND is_active = 1 AND ID IN ($user_id, 189) ORDER BY first_name" );
                if ( mysqli_num_rows($selectUser) > 0 ) {
                    while($rowUser = mysqli_fetch_array($selectUser)) {
                        echo '<option value="'. $rowUser["ID"] .'" '; echo in_array($rowUser["ID"], $array_copy_to) ? 'SELECTED':''; echo '>'. $rowUser["first_name"] .' '. $rowUser["last_name"] .'</option>';
                    }
                }
                $selectEmployeee = mysqli_query( $conn,"SELECT USER.ID AS userID, USER.employee_id AS userEMPID, USER.first_name AS userFN, USER.last_name AS userLN, USER.email AS userEmail, USER.is_verified AS userVerified, USER.is_active AS userActive, EMPLOYEE.ID AS empID, EMPLOYEE.user_id AS empUSERID, EMPLOYEE.suspended AS empSUSPENDED, EMPLOYEE.status AS empSTATUS, EMPLOYEE.verified AS empVERIFIED
					FROM tbl_user AS USER
					INNER JOIN tbl_hr_employee AS EMPLOYEE
					ON USER.employee_id = EMPLOYEE.ID
					WHERE USER.is_verified = 1 AND USER.is_active = 1 AND EMPLOYEE.user_id = $user_id AND EMPLOYEE.suspended = 0 AND EMPLOYEE.status = 1 AND EMPLOYEE.verified = 0
					ORDER BY USER.first_name" );
                if ( mysqli_num_rows($selectEmployeee) > 0 ) {
                    while($rowEmployee = mysqli_fetch_array($selectEmployeee)) {
                        echo '<option value="'. $rowEmployee["userID"] .'" '; echo in_array($rowEmployee["userID"], $array_copy_to) ? 'SELECTED':''; echo '>'. $rowEmployee["userFN"] .' '. $rowEmployee["userLN"] .'</option>';
                    }
                }

            echo '</select>
       	</div>
    	<div class="form-group">
            <label>Status</label>
            <select class="form-control" name="status">
            	<option value="0"></option>
            	<option value="1" '; echo $status == 1 ? 'SELECTED':''; echo '>Pending</option>
            	<option value="2" '; echo $status == 2 ? 'SELECTED':''; echo '>Completed</option>
            	<option value="3" '; echo $status == 3 ? 'SELECTED':''; echo '>Not Completed</option>
            </select>
       	</div>';
	}
	if( isset($_GET['modalNotes_delete']) ) {
		$ID = $_GET['modalNotes_delete'];

        mysqli_query( $conn,"UPDATE tbl_notes set deleted = 1 WHERE ID = $ID" );
    }
	if( isset($_POST['btnSave_Notes']) ) {
		$portal_user = $_COOKIE['ID'];
		$user_id = employerID($portal_user);

		$description = addslashes($_POST['description']);
		$status = $_POST['status'];
		$status_type = array(
		    0 => 'N/A',
		    1 => 'Pending',
		    2 => 'Completed',
		    3 => 'Not Completed',
		    4 => 'PTO'
		);
		$last_modified = date('Y-m-d');
		$mail_sent = 0;

		$assigned_to = '';
		if (!empty($_POST['assigned_to'])) {
			$assigned_to = implode(", ",$_POST['assigned_to']);
		}

		$copy_to = '';
		if (!empty($_POST['copy_to'])) {
			$copy_to = implode(", ",$_POST['copy_to']);
		}

		$sql = "INSERT INTO tbl_notes (user_id, description, assigned_to, copy_to, status, last_modified)
		VALUES ('$portal_user', '$description', '$assigned_to', '$copy_to', '$status', '$last_modified')";
		if (mysqli_query($conn, $sql)) {
			$last_id = mysqli_insert_id($conn);

	        $data = '<div class="userResult" id="note_'.$last_id.'">
                <div class="d-flex align-items-center img-rounded excerpt p-2 position-relative">
                    <div class="userData flex-grow-1" data-toggle="modal" data-target="#modalNotesView" onclick="noteView('.$last_id.')">
                        <p class="mb-0 bold" style="font-size: 15px;">'.nl2br($description).'</p>
                        <p class="mb-0 text-muted " style="font-size: 13px;">'.$last_modified.'</p>
                    </div>
                    <a href="javascript:;" class="hide h4 text-danger p-2 position-absolute end-0" style="margin: 0;" onclick="noteDelete('.$last_id.')">
                        <i class="icon-trash"></i>
                    </a>
                </div>
            </div>';

            $recipients = array();
            if (!empty($assigned_to)) {
            	$array_assigned_to = explode(", ", $assigned_to);
            	foreach ($array_assigned_to as $value) {
	                $selectEmployeee = mysqli_query( $conn,"SELECT * FROM tbl_hr_employee WHERE suspended = 0 AND status = 1 AND ID = $value" );
	                if ( mysqli_num_rows($selectEmployeee) > 0 ) {
	                    $rowEmployee = mysqli_fetch_array($selectEmployeee);
						$to = $rowEmployee["email"];
						$user = $rowEmployee["first_name"] .' '. $rowEmployee["last_name"];

						$recipients[$to] = $user;
	                }
            	}
            }

            $recipientsCC = array();
            if (!empty($copy_to)) {
            	$array_copy_to = explode(", ", $copy_to);
            	foreach ($array_copy_to as $value) {
	                $selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE is_verified = 1 AND is_active = 1 AND ID = $value" );
	                if ( mysqli_num_rows($selectUser) > 0 ) {
	                    $rowUser = mysqli_fetch_array($selectUser);
						$to = $rowUser["email"];
						$user = $rowUser["first_name"] .' '. $rowUser["last_name"];

						$recipientsCC[$to] = $user;
	                }
            	}
            }

            $selectUserFrom = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE is_verified = 1 AND is_active = 1 AND ID = $user_id" );
            if ( mysqli_num_rows($selectUserFrom) > 0 ) {
                $rowUserFrom = mysqli_fetch_array($selectUserFrom);
				$from_email = $rowUserFrom["email"];
				$from_name = $rowUserFrom["first_name"] .' '. $rowUserFrom["last_name"];
            }

			if (count($recipients) > 0) {
				$subject = 'Sticky Note Endorsement #'.$last_id;
				$body = '<b>From</b><br>
				'.$from_name.'<br><br>

				<b>Description</b><br>
				'.nl2br($description).'<br><br>

				<b>Status</b><br>
				'.$status_type[$status].'<br><br>

				Thanks';
				php_mailer_multi($recipients, $recipientsCC, $subject, $body, $from_email, $from_name);
			}
		}

		$output = array(
			'data' => $data
		);
		echo json_encode($output);
	}
	if( isset($_POST['btnUpdate_Notes']) ) {
		$portal_user = $_COOKIE['ID'];
		$user_id = employerID($portal_user);

		$ID = $_POST['ID'];
		$description = addslashes($_POST['description']);
		$status = $_POST['status'];
		$status_type = array(
		    0 => 'N/A',
		    1 => 'Pending',
		    2 => 'Completed',
		    3 => 'Not Completed',
		    4 => 'PTO'
		);
		$last_modified = date('Y-m-d');

		$assigned_to = '';
		if (!empty($_POST['assigned_to'])) {
			$assigned_to = implode(", ",$_POST['assigned_to']);
		}

		$copy_to = '';
		if (!empty($_POST['copy_to'])) {
			$copy_to = implode(", ",$_POST['copy_to']);
		}

		mysqli_query( $conn,"UPDATE tbl_notes set description = '".$description."', assigned_to = '".$assigned_to."', copy_to = '".$copy_to."', status = '".$status."' WHERE ID = $ID" );

		$selectNote = mysqli_query( $conn,"SELECT * FROM tbl_notes WHERE deleted = 0 AND ID = $ID" );
	    if ( mysqli_num_rows($selectNote) > 0 ) {
        	$rowNote = mysqli_fetch_array($selectNote);
            $note_ID = $rowNote['ID'];
            $note_user_id = $rowNote['user_id'];
            $note_description = $rowNote['description'];
            $note_last_modified = $rowNote['last_modified'];

            $data = '<div class="d-flex align-items-center img-rounded excerpt p-2 position-relative">
                <div class="userData flex-grow-1" data-toggle="modal" data-target="#modalNotesView" onclick="noteView('.$note_ID.')">
                    <p class="mb-0 bold" style="font-size: 15px;">'.nl2br($note_description).'</p>
                    <p class="mb-0 text-muted " style="font-size: 13px;">'.$note_last_modified.'</p>
                </div>
                <a href="javascript:;" class="hide h4 text-danger p-2 position-absolute end-0" style="margin: 0;" onclick="noteDelete('.$note_ID.')">
                    <i class="icon-trash"></i>
                </a>
            </div>';

            $recipients = array();
            if (!empty($assigned_to)) {
            	$array_assigned_to = explode(", ", $assigned_to);
            	foreach ($array_assigned_to as $value) {
	                $selectEmployeee = mysqli_query( $conn,"SELECT * FROM tbl_hr_employee WHERE suspended = 0 AND status = 1 AND ID = $value" );
	                if ( mysqli_num_rows($selectEmployeee) > 0 ) {
	                    $rowEmployee = mysqli_fetch_array($selectEmployeee);
						$to = $rowEmployee["email"];
						$user = $rowEmployee["first_name"] .' '. $rowEmployee["last_name"];

						$recipients[$to] = $user;
	                }
            	}
            }

            $recipientsCC = array();
            if (!empty($copy_to)) {
            	$array_copy_to = explode(", ", $copy_to);
            	foreach ($array_copy_to as $value) {
	                $selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE is_verified = 1 AND is_active = 1 AND ID = $value" );
	                if ( mysqli_num_rows($selectUser) > 0 ) {
	                    $rowUser = mysqli_fetch_array($selectUser);
						$to = $rowUser["email"];
						$user = $rowUser["first_name"] .' '. $rowUser["last_name"];

						$recipientsCC[$to] = $user;
	                }
            	}
            }

            $selectUserFrom = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE is_verified = 1 AND is_active = 1 AND ID = $note_user_id" );
            if ( mysqli_num_rows($selectUserFrom) > 0 ) {
                $rowUserFrom = mysqli_fetch_array($selectUserFrom);
				$from_email = $rowUserFrom["email"];
				$from_name = $rowUserFrom["first_name"] .' '. $rowUserFrom["last_name"];
            }

			if (count($recipients) > 0) {
				$subject = 'Sticky Note Endorsement #'.$note_ID;
				$body = '<b>From</b><br>
				'.$from_name.'<br><br>

				<b>Description</b><br>
				'.nl2br($description).'<br><br>

				<b>Status</b><br>
				'.$status_type[$status].'<br><br>

				Thanks';
				php_mailer_multi($recipients, $recipientsCC, $subject, $body, $from_email, $from_name);
			}
	    }

		$output = array(
			'ID' => $note_ID,
			'data' => $data
		);
		echo json_encode($output);
	}


	//CAM PAGE
	function counterup_cam() {
		global $conn;
		if (!empty($_COOKIE['switchAccount'])) {
			$portal_user = $_COOKIE['ID'];
			$user_id = $_COOKIE['switchAccount'];
		}
		else {
			$portal_user = $_COOKIE['ID'];
			$user_id = employerID($portal_user);
		}

		$selectOpen = mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE status = 0 AND user_id = $user_id" );
	    $statusOpen = mysqli_num_rows($selectOpen);

        $selectOpen2 = mysqli_query( $conn,"SELECT * FROM tbl_complaint_records WHERE deleted = 0 AND capam = 1 AND status = 0 AND care_ownedby = $user_id" );
        $statusOpen2 = mysqli_num_rows($selectOpen2);

		$selectClose = mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE status = 1 AND user_id = $user_id" );
	    $statusClose = mysqli_num_rows($selectClose);

        $selectClose2 = mysqli_query( $conn,"SELECT * FROM tbl_complaint_records WHERE deleted = 0 AND capam = 1 AND status = 1 AND care_ownedby = $user_id" );
        $statusClose2 = mysqli_num_rows($selectClose2);


		$output = array(
            'statusOpen' => $statusOpen + $statusOpen2,
            'statusClose' => $statusClose + $statusClose2
		);
		return $output;
	}
	if( isset($_GET['counterup_cam']) ) {
		echo json_encode(counterup_cam());
	}
	if( isset($_GET['modalStatus_CAM']) ) {
		$ID = $_GET['modalStatus_CAM'];
		$s = $_GET['s'];

        mysqli_query( $conn,"UPDATE tbl_cam set status = $s WHERE ID = $ID" );
    }
    if( isset($_GET['modalStatus_CAM2']) ) {
        $ID = $_GET['modalStatus_CAM2'];
        $s = $_GET['s'];

        mysqli_query( $conn,"UPDATE tbl_complaint_records set status = $s WHERE care_id = $ID" );
    }
	if( isset($_GET['modalTrend_CAM_Dept']) ) {
		$ID = $_GET['modalTrend_CAM_Dept'];
        $page = $_GET['p'];
		$portal_user = $_COOKIE['ID'];
		$user_id = employerID($portal_user);

		$cam_employee_id = '';
		$cam_training = '';
		if ($ID > 0) {
            if (!empty($_GET['p'])) {
                $selectCAM= mysqli_query( $conn,"SELECT * FROM tbl_complaint_records WHERE care_id = $ID" );
                if ( mysqli_num_rows($selectCAM) > 0 ) {
                    $rowCAM = mysqli_fetch_array($selectCAM);
                    $cam_employee_id = explode(',', $rowCAM["employee_id"]);
                    $cam_training = explode(',', $rowCAM["training"]);
                }
            } else {
                $selectCAM= mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE ID = $ID" );
                if ( mysqli_num_rows($selectCAM) > 0 ) {
                    $rowCAM = mysqli_fetch_array($selectCAM);
                    $cam_employee_id = explode(',', $rowCAM["employee_id"]);
                    $cam_training = explode(',', $rowCAM["training"]);
                }
            }
		}

        $array_employee_id = array();
		if (!empty($_POST['department_id'])) {
			$department_id = $_POST['department_id'];
			$department_id = implode(",", $department_id);
			$department_id_arr = explode(",", $department_id);
	        $optionEmployee = '';
	        $optionTraining = '';
	        foreach ($department_id_arr as $value) {

	            $selectEmployee = mysqli_query( $conn,"SELECT * FROM tbl_hr_employee WHERE suspended = 0 AND status = 1 AND department_id = $value AND user_id = $user_id ORDER BY first_name" );
	            if ( mysqli_num_rows($selectEmployee) > 0 ) {
	            	while($rowEmployee = mysqli_fetch_array($selectEmployee)) {
		                $emp_ID = $rowEmployee["ID"];
		                $emp_name = $rowEmployee["first_name"] .' '. $rowEmployee["last_name"];
                        $emp_email = $rowEmployee["email"];

                        if (!in_array($emp_ID, $array_employee_id)) {
                            array_push($array_employee_id, $emp_ID);

                            $selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE is_verified = 1 AND is_active = 1 AND email = '".$emp_email."' ORDER BY first_name");
                            if ( mysqli_num_rows($selectUser) > 0 ) {
                            	if (!empty($cam_employee_id)) {
                            		$optionEmployee .= '<option value="'.$emp_ID.'" '; $optionEmployee .= in_array($emp_ID, $cam_employee_id) ? 'SELECTED':''; $optionEmployee .= '>'.$emp_name.'</option>';
                            	} else {
                            		$optionEmployee .= '<option value="'.$emp_ID.'">'.$emp_name.'</option>';
                            	}
                            }
                        }
	            	}
	            }

	            $selectTrainings = mysqli_query( $conn,"SELECT 
					*
					FROM (
					    SELECT
					    d.ID AS d_ID,
					    jd.ID AS jd_ID,
					    jd.title AS jd_title,
    					t.ID AS t_ID,
					    t.title AS t_title
					    FROM tbl_hr_department AS d
					    
					    LEFT JOIN (
					        SELECT
					        ID,
					        department_id,
					        title
					        FROM tbl_hr_job_description 
					        WHERE status = 1
					    ) AS jd
					    ON d.ID = jd.department_id
					    
					    LEFT JOIN (
					        SELECT
					        ID,
					        job_description_id,
					        replace(job_description_id , ' ','') AS jdID,
					        title
					        FROM tbl_hr_trainings 
					        WHERE status = 1
					        AND deleted = 0
					    ) AS t
					    ON t.jdID IN (jd.ID)
					    
					    WHERE d.status = 1
					    AND t.title IS NOT NULL
					    AND d.user_id = $user_id
					    AND d.ID = $value
					) AS r" );
	            if ( mysqli_num_rows($selectTrainings) > 0 ) {
	            	while($rowTraining = mysqli_fetch_array($selectTrainings)) {
		                $t_ID = $rowTraining["t_ID"];
                        $t_title = $rowTraining["t_title"];

                        if (!empty($cam_training)) {
                        	$optionTraining .= '<option value="'.$t_ID.'" '; $optionTraining .= in_array($t_ID, $cam_training) ? 'SELECTED':''; $optionTraining .= '>'.$t_title.'</option>';
                        } else {
                        	$optionTraining .= '<option value="'.$t_ID.'">'.$t_title.'</option>';
                        }
	            	}
	            }
	        }


			$output = array(
				'employee' => $optionEmployee,
				'training' => $optionTraining
			);
			echo json_encode($output);
		}
    }
    if( isset($_GET['modalEdit_CAM']) ) {
        $ID = $_GET['modalEdit_CAM'];

        $current_client = 0;
        if (isset($_COOKIE['client'])) { $current_client = $_COOKIE['client']; }

        if (!empty($_COOKIE['switchAccount'])) {
            $portal_user = $_COOKIE['ID'];
            $user_id = $_COOKIE['switchAccount'];
        }
        else {
            $portal_user = $_COOKIE['ID'];
            $user_id = employerID($portal_user);
        }

        $selectData = mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE ID = $ID" );
        if ( mysqli_num_rows($selectData) > 0 ) {
            $row = mysqli_fetch_array($selectData);

            echo '<input class="form-control" type="hidden" name="ID" value="'.$ID.'" />
            <div class="portlet box default margin-bottom-15">
                <div class="portlet-body">
                    <div class="row form-horizontal">
                        <div class="col-md-4">
                            <label class="control-label">Is this a Product related  issue?</label>
                        </div>
                        <div class="col-md-2">
                            <select class="form-control margin-bottom-15" name="product_related">
                                <option value="0"'; echo $row['product_related'] == 0 ? 'SELECTED':''; echo '>No</option>
                                <option value="1"'; echo $row['product_related'] == 1 ? 'SELECTED':''; echo '>Yes</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-2">
                            <label class="control-label">Date of Issue</label>
                            <input type="date" class="form-control" name="date" value="'.$row['date'].'" />
                        </div>
                        <div class="col-md-2">
                            <label class="control-label">Time of Issue</label>
                            <input type="time" class="form-control" name="time" value="'.$row['time'].'" />
                        </div>
                        <div class="col-md-2 col-md-offset-1">
                            <label class="control-label">Observed By</label>
                            <input type="text" class="form-control" name="observed_by" value="'.$row['observed_by'].'"  />
                        </div>
                        <div class="col-md-2">
                            <label class="control-label">Reported By</label>
                            <input type="text" class="form-control" name="reported_by" value="'.$row['reported_by'].'" />
                        </div>
                        <div class="col-md-2 col-md-offset-1 '; echo $current_client == 1 ? 'hide':''; echo '">
                            <label class="control-label">CAPA Reference No.</label>
                            <input type="text" class="form-control" name="reference" value="'.$row['reference'].'" />
                        </div>
                    </div>
                </div>
            </div>';

            if ($current_client == 1) {
                echo '<div class="portlet box default margin-bottom-15">
                    <div class="portlet-title">
                        <div class="caption">
                            <span class="caption-subject font-dark bold">Program</span>
                        </div>
                    </div>
                    <div class="portlet-body">
                        <div class="mt-checkbox-inline">';

                            $selectProgram = mysqli_query( $conn,"SELECT * FROM tbl_library WHERE type = 1 AND deleted = 0 AND user_id = $user_id" );
                            if ( mysqli_num_rows($selectProgram) > 0 ) {
                                while ($rowProgram = mysqli_fetch_array($selectProgram)) {
                                    $program_ID = $rowProgram['ID'];
                                    $program_name = $rowProgram['name'];

                                    $arr_program_ID =  array();
                                    if (!empty($row['program_id'])) {
                                        $arr_program_ID =  explode(', ', $row['program_id']);
                                    }

                                    echo '<label class="mt-checkbox mt-checkbox-outline">
                                        <input type="checkbox" name="program_id[]" value="'.$program_ID.'" '; echo in_array($program_ID, $arr_program_ID) ? 'checked':''; echo '> '.$program_name.'
                                        <span></span>
                                    </label>';
                                }
                            }

                        echo '</div>
                    </div>
                </div>';

                echo '<div class="portlet box default margin-bottom-15">
                    <div class="portlet-title">
                        <div class="caption">
                            <span class="caption-subject font-dark bold">Complaint Category</span>
                        </div>
                    </div>
                    <div class="portlet-body">
                        <div class="mt-checkbox-inline">';

                            $selectComplaint = mysqli_query( $conn,"SELECT * FROM tbl_cam_complaint_category WHERE deleted = 0 ORDER BY name" );
                            if ( mysqli_num_rows($selectComplaint) > 0 ) {
                                while ($rowComp = mysqli_fetch_array($selectComplaint)) {
                                    $comp_ID = $rowComp['ID'];
                                    $comp_name = $rowComp['name'];
                                    $arr_complaint_id =  explode(', ', $row['complaint_id']);

                                    echo '<label class="mt-checkbox mt-checkbox-outline">
                                        <input type="checkbox" name="complaint_id[]" value="'.$comp_ID.'" '; echo in_array($comp_ID, $arr_complaint_id) ? 'checked':''; echo '> '.$comp_name.'
                                        <span></span>
                                    </label>';
                                }
                            }

                            echo '<label class="mt-checkbox mt-checkbox-outline">
                                <input type="checkbox" name="complaint_id[]" value="0" '; echo !empty($row['complaint_other']) ? 'checked':''; echo ' onClick="btnCategory(this)"> Other
                                <span></span>
                            </label>
                            <input type="text" class="form-control '; echo !empty($row['category_other']) ? '':'hide'; echo '" name="category_other" placeholder="Specify Complaint Category" value="'.$row['complaint_other'].'" />
                        </div>
                    </div>
                </div>';
            } else {
                echo '<div class="portlet box default margin-bottom-15">
                    <div class="portlet-title">
                        <div class="caption">
                            <span class="caption-subject font-dark bold">Category</span>
                        </div>
                    </div>
                    <div class="portlet-body">
                        <div class="mt-checkbox-inline">';

                            $selectCategory = mysqli_query( $conn,"SELECT * FROM tbl_cam_category WHERE deleted = 0 ORDER BY name" );
                            if ( mysqli_num_rows($selectCategory) > 0 ) {
                                while ($rowCat = mysqli_fetch_array($selectCategory)) {
                                    $cat_ID = $rowCat['ID'];
                                    $cat_name = $rowCat['name'];
                                    $arr_category_id =  explode(', ', $row['category_id']);

                                    echo '<label class="mt-checkbox mt-checkbox-outline">
                                        <input type="checkbox" name="category_id[]" value="'.$cat_ID.'" '; echo in_array($cat_ID, $arr_category_id) ? 'checked':''; echo '> '.$cat_name.'
                                        <span></span>
                                    </label>';
                                }
                            }

                            echo '<label class="mt-checkbox mt-checkbox-outline">
                                <input type="checkbox" name="category_id[]" value="0" '; echo !empty($row['category_other']) ? 'checked':''; echo ' onClick="btnCategory(this)"> Other
                                <span></span>
                            </label>
                            <input type="text" class="form-control '; echo !empty($row['category_other']) ? '':'hide'; echo '" name="category_other" placeholder="Specify Category" value="'.$row['category_other'].'" />
                        </div>
                    </div>
                </div>';
            }

            echo '<div class="portlet box default margin-bottom-15">
                <div class="portlet-title">
                    <div class="caption">
                        <span class="caption-subject font-dark bold">Department(s) Involved</span>
                    </div>
                </div>
                <div class="portlet-body">
                    <div class="mt-checkbox-inline">';

                            // $selectDepartment = mysqli_query( $conn,"SELECT * FROM tbl_cam_department WHERE deleted = 0 ORDER BY name" );
                            // if ( mysqli_num_rows($selectDepartment) > 0 ) {
                            //     while ($rowDept = mysqli_fetch_array($selectDepartment)) {
                            //         $dept_ID = $rowDept['ID'];
                            //         $dept_name = $rowDept['name'];
                            //         $arr_department_id =  explode(', ', $row['department_id']);

                            //         echo '<label class="mt-checkbox mt-checkbox-outline">
                            //             <input type="checkbox"name="department_id[]" value="'.$dept_ID.'" '; echo in_array($dept_ID, $arr_department_id) ? 'checked':''; echo '> '.$dept_name.'
                            //             <span></span>
                            //         </label>';
                            //     }
                            // }

                            $selectDepartment = mysqli_query( $conn,"SELECT * FROM tbl_hr_department WHERE status = 1 AND user_id = $user_id ORDER BY title" );
                            if ( mysqli_num_rows($selectDepartment) > 0 ) {
                                while ($rowDept = mysqli_fetch_array($selectDepartment)) {
                                    $dept_ID = $rowDept['ID'];
                                    $dept_title = $rowDept['title'];
                                    $arr_department_id =  explode(', ', $row['department_id']);

                                    echo '<label class="mt-checkbox mt-checkbox-outline">
                                        <input type="checkbox" class="department_id_2" name="department_id[]" value="'.$dept_ID.'" '; echo in_array($dept_ID, $arr_department_id) ? 'checked':''; echo ' onclick="changeDepartment(2, '.$dept_ID.')" /> '.$dept_title.'
                                        <span></span>
                                    </label>';
                                }
                            }

                        echo '<label class="mt-checkbox mt-checkbox-outline hide">
                            <input type="checkbox" name="department_id[]" value="0"> Other
                            <span></span>
                        </label>
                        <input type="text" class="form-control hide" name="department_other" placeholder="Specify Department" value="'.$row['department_other'].'" />
                    </div>
                </div>
            </div>

            <div class="portlet box default margin-bottom-15">
                <div class="portlet-title">
                    <div class="caption">
                        <span class="caption-subject font-dark bold">Involved Personnel</span>
                    </div>
                </div>
                <div class="portlet-body">
                    <select class="form-control mt-multiselect employee_id_2" data-placeholder="Select Personnel" name="employee_id[]" multiple="multiple"></select>
                </div>
            </div>

            <div class="portlet box default margin-bottom-15">
                <div class="portlet-title">
                    <div class="caption">
                        <span class="caption-subject font-dark bold">Description of Issue</span>
                    </div>
                </div>
                <div class="portlet-body">
                    <textarea class="form-control" rows="3" name="description">'.$row['description'].'</textarea>
                </div>
            </div>

            <div class="portlet box default margin-bottom-15 hide '; echo $_COOKIE['client'] == 0 ? '':'hide'; echo '">
                <div class="portlet-title">
                    <div class="caption">
                        <span class="caption-subject font-dark bold">Trend Category</span>
                    </div>
                </div>
                <div class="portlet-body">
                    <div class="mt-repeater mt-repeater-trend">
                        <div data-repeater-list="trend">';

                            if (!empty($row['trend'])) {
                                $array_trend = explode(' | ', $row['trend']);
                                foreach($array_trend as $value) {
                                    if (!empty($value)) {
                                        echo '<div class="mt-repeater-item row" data-repeater-item>
                                            <div class="col-xs-11">
                                                <input class="form-control" type="text" name="trend_desc" value="'.$value.'" />
                                            </div>
                                            <div class="col-xs-1">
                                                <a href="javascript:;" data-repeater-delete class="btn btn-danger"><i class="fa fa-close"></i></a>
                                            </div>
                                        </div>';
                                    }
                                }
                            }
                            
                        echo '</div>
                        <a href="javascript:;" data-repeater-create class="btn btn-success mt-repeater-add"><i class="fa fa-plus"></i> Add more</a>
                    </div>
                </div>
            </div>

            <div class="portlet box default margin-bottom-15">
                <div class="portlet-title">
                    <div class="caption">
                        <span class="caption-subject font-dark bold">Observation'; echo $current_client == 1 ? '(s)':' / Issue(s)'; echo '</span>
                    </div>
                </div>
                <div class="portlet-body">
                    <div class="row">
                        <div class="col-md-7">
                            <textarea class="form-control" rows="10" name="observation_desc">'.$row['observation'].'</textarea>
                        </div>
                        <div class="col-md-5">
                            <label>Supporting Documents / Evidence:</label>
                            <div class="mt-repeater mt-repeater-observation">
                                <div data-repeater-list="observation">';

                                    echo '<div class="mt-repeater-item mt-repeater-item-hide row" data-repeater-item>
                                        <div class="col-xs-10">
                                            <input type="hidden" name="observation_file_temp" value="" />
                                            <input class="form-control" type="file" name="observation_file" />
                                        </div>
                                        <div class="col-xs-2">
                                            <a href="javascript:;" data-repeater-delete class="btn btn-danger"><i class="fa fa-close"></i></a>
                                        </div>
                                    </div>';

                                    if (!empty($row['observation_file'])) {
                                        $array_observation_file = explode(' | ', $row['observation_file']);
                                        foreach($array_observation_file as $value) {
                                            if (!empty($value)) {
                                                $file = $value;
                                                $fileExtension = fileExtension($file);
                                                $src = $fileExtension['src'];
                                                $embed = $fileExtension['embed'];
                                                $type = $fileExtension['type'];
                                                $file_extension = $fileExtension['file_extension'];
                                                $url = $base_url.'uploads/cam/';
                                                $file_src = $src.$url.rawurlencode($file).$embed;

                                                echo '<div class="mt-repeater-item row" data-repeater-item>
                                                    <div class="col-xs-10">
                                                        <input type="hidden" name="observation_file_temp" value="'.$value.'" />
                                                        <input class="form-control '; echo !empty($file) ? 'hide':''; echo '" type="file" name="observation_file" />
                                                        <p class="'; echo !empty($file) ? '':'hide'; echo '" style="margin: 0;"><a data-src="'.$file_src.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a> | <button type="button" class="btn btn-link uploadNew" onclick="uploadNew(this)">Upload New</button></p>
                                                    </div>
                                                    <div class="col-xs-2">
                                                        <a href="javascript:;" data-repeater-delete class="btn btn-danger"><i class="fa fa-close"></i></a>
                                                    </div>
                                                </div>';
                                            }
                                        }
                                    } else {
                                        echo '<div class="mt-repeater-item row" data-repeater-item>
                                            <div class="col-xs-10">
                                                <input type="hidden" name="observation_file_temp" value="" />
                                                <input class="form-control" type="file" name="observation_file" />
                                            </div>
                                            <div class="col-xs-2">
                                                <a href="javascript:;" data-repeater-delete class="btn btn-danger"><i class="fa fa-close"></i></a>
                                            </div>
                                        </div>';
                                    }
                                    
                                echo '</div>
                                <a href="javascript:;" data-repeater-create class="btn btn-success mt-repeater-add"><i class="fa fa-plus"></i> Add more</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="portlet box default margin-bottom-15">
                <div class="portlet-title">
                    <div class="caption">
                        <span class="caption-subject font-dark bold">Root Cause(s)</span>
                    </div>
                </div>
                <div class="portlet-body">
                    <div class="row">
                        <div class="col-md-7">
                            <textarea class="form-control" rows="10" name="root_cause_desc">'.$row['root_cause'].'</textarea>
                        </div>
                        <div class="col-md-5">
                            <label>Supporting Documents / Evidence:</label>
                            <div class="mt-repeater mt-repeater-root_cause">
                                <div data-repeater-list="root_cause">';

                                    echo '<div class="mt-repeater-item mt-repeater-item-hide row" data-repeater-item>
                                        <div class="col-xs-10">
                                            <input type="hidden" name="root_cause_file_temp" value="" />
                                            <input class="form-control" type="file" name="root_cause_file" />
                                        </div>
                                        <div class="col-xs-2">
                                            <a href="javascript:;" data-repeater-delete class="btn btn-danger"><i class="fa fa-close"></i></a>
                                        </div>
                                    </div>';

                                    if (!empty($row['root_cause_file'])) {
                                        $array_root_cause_file = explode(' | ', $row['root_cause_file']);
                                        foreach($array_root_cause_file as $value) {
                                            if (!empty($value)) {
                                                $file = $value;
                                                $fileExtension = fileExtension($file);
                                                $src = $fileExtension['src'];
                                                $embed = $fileExtension['embed'];
                                                $type = $fileExtension['type'];
                                                $file_extension = $fileExtension['file_extension'];
                                                $url = $base_url.'uploads/cam/';
                                                $file_src = $src.$url.rawurlencode($file).$embed;

                                                echo '<div class="mt-repeater-item row" data-repeater-item>
                                                    <div class="col-xs-10">
                                                        <input type="hidden" name="root_cause_file_temp" value="'.$value.'" />
                                                        <input class="form-control '; echo !empty($file) ? 'hide':''; echo '" type="file" name="root_cause_file" />
                                                        <p class="'; echo !empty($file) ? '':'hide'; echo '" style="margin: 0;"><a data-src="'.$file_src.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a> | <button type="button" class="btn btn-link uploadNew" onclick="uploadNew(this)">Upload New</button></p>
                                                    </div>
                                                    <div class="col-xs-2">
                                                        <a href="javascript:;" data-repeater-delete class="btn btn-danger"><i class="fa fa-close"></i></a>
                                                    </div>
                                                </div>';
                                            }
                                        }
                                    } else {
                                        echo '<div class="mt-repeater-item row" data-repeater-item>
                                            <div class="col-xs-10">
                                                <input type="hidden" name="root_cause_file_temp" value="" />
                                                <input class="form-control" type="file" name="root_cause_file" />
                                            </div>
                                            <div class="col-xs-2">
                                                <a href="javascript:;" data-repeater-delete class="btn btn-danger"><i class="fa fa-close"></i></a>
                                            </div>
                                        </div>';
                                    }
                                    
                                echo '</div>
                                <a href="javascript:;" data-repeater-create class="btn btn-success mt-repeater-add"><i class="fa fa-plus"></i> Add more</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="portlet box default margin-bottom-15">
                <div class="portlet-title">
                    <div class="caption">
                        <span class="caption-subject font-dark bold">Corrective Action(s)</span>
                    </div>
                </div>
                <div class="portlet-body">
                    <div class="row">
                        <div class="col-md-7">
                            <select class="form-control margin-bottom-15 '; echo $current_client == 1 ? 'hide':''; echo '" name="corrective_status">
                                <option value="0" '; echo $row['corrective_status'] == 0 ? 'SELECTED':''; echo '>--Select Status--</option>
                                <option value="1" '; echo $row['corrective_status'] == 1 ? 'SELECTED':''; echo '>Proposed</option>
                                <option value="2" '; echo $row['corrective_status'] == 2 ? 'SELECTED':''; echo '>Implemented</option>
                            </select>
                            <textarea class="form-control margin-bottom-15" rows="10" name="corrective_desc">'.$row['corrective_desc'].'</textarea>
                            <div class="row">
                                <div class="col-md-4">
                                    <input type="date" class="form-control margin-bottom-15" name="corrective_date" placeholder="Date" value="'.$row['corrective_date'].'" />
                                </div>
                                <div class="col-md-4">
                                    <input type="time" class="form-control margin-bottom-15" name="corrective_time" placeholder="Time" value="'.$row['corrective_time'].'" />
                                </div>
                                <div class="col-md-4">
                                    <input type="text" class="form-control margin-bottom-15" name="corrective_by" placeholder="Corrected By" value="'.$row['corrective_by'].'" />
                                </div>
                            </div>
                        </div>
                        <div class="col-md-5">
                            <label>Supporting Documents / Evidence:</label>
                            <div class="mt-repeater mt-repeater-corrective">
                                <div data-repeater-list="corrective">';

                                    echo '<div class="mt-repeater-item mt-repeater-item-hide row" data-repeater-item>
                                        <div class="col-xs-10">
                                            <input type="hidden" name="corrective_file_temp" value="" />
                                            <input class="form-control" type="file" name="corrective_file" />
                                        </div>
                                        <div class="col-xs-2">
                                            <a href="javascript:;" data-repeater-delete class="btn btn-danger"><i class="fa fa-close"></i></a>
                                        </div>
                                    </div>';

                                    if (!empty($row['corrective_file'])) {
                                        $array_corrective_file = explode(' | ', $row['corrective_file']);
                                        foreach($array_corrective_file as $value) {
                                            if (!empty($value)) {
                                                $file = $value;
                                                $fileExtension = fileExtension($file);
                                                $src = $fileExtension['src'];
                                                $embed = $fileExtension['embed'];
                                                $type = $fileExtension['type'];
                                                $file_extension = $fileExtension['file_extension'];
                                                $url = $base_url.'uploads/cam/';
                                                $file_src = $src.$url.rawurlencode($file).$embed;

                                                echo '<div class="mt-repeater-item row" data-repeater-item>
                                                    <div class="col-xs-10">
                                                        <input type="hidden" name="corrective_file_temp" value="'.$value.'" />
                                                        <input class="form-control '; echo !empty($file) ? 'hide':''; echo '" type="file" name="corrective_file" />
                                                        <p class="'; echo !empty($file) ? '':'hide'; echo '" style="margin: 0;"><a data-src="'.$file_src.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a> | <button type="button" class="btn btn-link uploadNew" onclick="uploadNew(this)">Upload New</button></p>
                                                    </div>
                                                    <div class="col-xs-2">
                                                        <a href="javascript:;" data-repeater-delete class="btn btn-danger"><i class="fa fa-close"></i></a>
                                                    </div>
                                                </div>';
                                            }
                                        }
                                    } else {
                                        echo '<div class="mt-repeater-item row" data-repeater-item>
                                            <div class="col-xs-10">
                                                <input type="hidden" name="corrective_file_temp" value="" />
                                                <input class="form-control" type="file" name="corrective_file" />
                                            </div>
                                            <div class="col-xs-2">
                                                <a href="javascript:;" data-repeater-delete class="btn btn-danger"><i class="fa fa-close"></i></a>
                                            </div>
                                        </div>';
                                    }
                                    
                                echo '</div>
                                <a href="javascript:;" data-repeater-create class="btn btn-success mt-repeater-add"><i class="fa fa-plus"></i> Add more</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="portlet box default margin-bottom-15">
                <div class="portlet-title">
                    <div class="caption">
                        <span class="caption-subject font-dark bold">Implementation(s)</span>
                    </div>
                </div>
                <div class="portlet-body">
                    <div class="row">
                        <div class="col-md-7">
                            <select class="form-control margin-bottom-15" name="implementation_status">
                                <option value="0" '; echo $row['implementation_status'] == 0 ? 'SELECTED':''; echo '>--Select Status--</option>
                                <option value="1" '; echo $row['implementation_status'] == 1 ? 'SELECTED':''; echo '>Proposed</option>
                                <option value="2" '; echo $row['implementation_status'] == 2 ? 'SELECTED':''; echo '>Implemented</option>
                            </select>
                            <textarea class="form-control margin-bottom-15" rows="10" name="implementation_desc">'.$row['implementation_desc'].'</textarea>
                            <div class="row form-horizontal">
                                <div class="col-md-4">
                                    <label class="control-label">Effective Date of Resolution</label>
                                </div>
                                <div class="col-md-4">
                                    <input type="date" class="form-control margin-bottom-15" name="implementation_date" placeholder="Date" value="'.$row['implementation_date'].'"/>
                                </div>
                                <div class="col-md-4">
                                    <input type="text" class="form-control margin-bottom-15" name="implementation_by" placeholder="Implemented By" value="'.$row['implementation_by'].'" />
                                </div>
                            </div>
                        </div>
                        <div class="col-md-5">
                            <label>Supporting Documents / Evidence:</label>
                            <div class="mt-repeater mt-repeater-implementation">
                                <div data-repeater-list="implementation">';

                                    echo '<div class="mt-repeater-item mt-repeater-item-hide row" data-repeater-item>
                                        <div class="col-xs-10">
                                            <input type="hidden" name="implementation_file_temp" value="" />
                                            <input class="form-control" type="file" name="implementation_file" />
                                        </div>
                                        <div class="col-xs-2">
                                            <a href="javascript:;" data-repeater-delete class="btn btn-danger"><i class="fa fa-close"></i></a>
                                        </div>
                                    </div>';

                                    if (!empty($row['implementation_file'])) {
                                        $array_implementation_file = explode(' | ', $row['implementation_file']);
                                        foreach($array_implementation_file as $value) {
                                            if (!empty($value)) {
                                                $file = $value;
                                                $fileExtension = fileExtension($file);
                                                $src = $fileExtension['src'];
                                                $embed = $fileExtension['embed'];
                                                $type = $fileExtension['type'];
                                                $file_extension = $fileExtension['file_extension'];
                                                $url = $base_url.'uploads/cam/';
                                                $file_src = $src.$url.rawurlencode($file).$embed;

                                                echo '<div class="mt-repeater-item row" data-repeater-item>
                                                    <div class="col-xs-10">
                                                        <input type="hidden" name="implementation_file_temp" value="'.$value.'" />
                                                        <input class="form-control '; echo !empty($file) ? 'hide':''; echo '" type="file" name="implementation_file" />
                                                        <p class="'; echo !empty($file) ? '':'hide'; echo '" style="margin: 0;"><a data-src="'.$file_src.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a> | <button type="button" class="btn btn-link uploadNew" onclick="uploadNew(this)">Upload New</button></p>
                                                    </div>
                                                    <div class="col-xs-2">
                                                        <a href="javascript:;" data-repeater-delete class="btn btn-danger"><i class="fa fa-close"></i></a>
                                                    </div>
                                                </div>';
                                            }
                                        }
                                    } else {
                                        echo '<div class="mt-repeater-item row" data-repeater-item>
                                            <div class="col-xs-10">
                                                <input type="hidden" name="implementation_file_temp" value="" />
                                                <input class="form-control" type="file" name="implementation_file" />
                                            </div>
                                            <div class="col-xs-2">
                                                <a href="javascript:;" data-repeater-delete class="btn btn-danger"><i class="fa fa-close"></i></a>
                                            </div>
                                        </div>';
                                    }
                                    
                                echo '</div>
                                <a href="javascript:;" data-repeater-create class="btn btn-success mt-repeater-add"><i class="fa fa-plus"></i> Add more</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="portlet box default margin-bottom-15">
                <div class="portlet-title">
                    <div class="caption">
                        <span class="caption-subject font-dark bold">Preventive Action(s)</span>
                    </div>
                </div>
                <div class="portlet-body">
                    <div class="row">
                        <div class="col-md-7">
                            <select class="form-control margin-bottom-15" name="preventive_status">
                                <option value="0" '; echo $row['implementation_status'] == 0 ? 'SELECTED':''; echo '>--Select Status--</option>
                                <option value="1" '; echo $row['implementation_status'] == 1 ? 'SELECTED':''; echo '>Proposed</option>
                                <option value="2" '; echo $row['implementation_status'] == 2 ? 'SELECTED':''; echo '>Implemented</option>
                            </select>
                            <textarea class="form-control margin-bottom-15" rows="10" name="preventive_desc">'.$row['preventive_desc'].'</textarea>
                        </div>
                        <div class="col-md-5">
                            <label>Supporting Documents / Evidence:</label>
                            <div class="mt-repeater mt-repeater-preventive">
                                <div data-repeater-list="preventive">';

                                    echo '<div class="mt-repeater-item mt-repeater-item-hide row" data-repeater-item>
                                        <div class="col-xs-10">
                                            <input type="hidden" name="preventive_file_temp" value="" />
                                            <input class="form-control" type="file" name="preventive_file" />
                                        </div>
                                        <div class="col-xs-2">
                                            <a href="javascript:;" data-repeater-delete class="btn btn-danger"><i class="fa fa-close"></i></a>
                                        </div>
                                    </div>';

                                    if (!empty($row['preventive_file'])) {
                                        $array_preventive_file = explode(' | ', $row['preventive_file']);
                                        foreach($array_preventive_file as $value) {
                                            if (!empty($value)) {
                                                $file = $value;
                                                $fileExtension = fileExtension($file);
                                                $src = $fileExtension['src'];
                                                $embed = $fileExtension['embed'];
                                                $type = $fileExtension['type'];
                                                $file_extension = $fileExtension['file_extension'];
                                                $url = $base_url.'uploads/cam/';
                                                $file_src = $src.$url.rawurlencode($file).$embed;

                                                echo '<div class="mt-repeater-item row" data-repeater-item>
                                                    <div class="col-xs-10">
                                                        <input type="hidden" name="preventive_file_temp" value="'.$value.'" />
                                                        <input class="form-control '; echo !empty($file) ? 'hide':''; echo '" type="file" name="preventive_file" />
                                                        <p class="'; echo !empty($file) ? '':'hide'; echo '" style="margin: 0;"><a data-src="'.$file_src.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a> | <button type="button" class="btn btn-link uploadNew" onclick="uploadNew(this)">Upload New</button></p>
                                                    </div>
                                                    <div class="col-xs-2">
                                                        <a href="javascript:;" data-repeater-delete class="btn btn-danger"><i class="fa fa-close"></i></a>
                                                    </div>
                                                </div>';
                                            }
                                        }
                                    } else {
                                        echo '<div class="mt-repeater-item row" data-repeater-item>
                                            <div class="col-xs-10">
                                                <input type="hidden" name="preventive_file_temp" value="" />
                                                <input class="form-control" type="file" name="preventive_file" />
                                            </div>
                                            <div class="col-xs-2">
                                                <a href="javascript:;" data-repeater-delete class="btn btn-danger"><i class="fa fa-close"></i></a>
                                            </div>
                                        </div>';
                                    }
                                    
                                echo '</div>
                                <a href="javascript:;" data-repeater-create class="btn btn-success mt-repeater-add"><i class="fa fa-plus"></i> Add more</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="portlet box default margin-bottom-15">
                <div class="portlet-title">
                    <div class="caption">
                        <span class="caption-subject font-dark bold">Evaluation(s) and Follow Up(s)</span>
                    </div>
                </div>
                <div class="portlet-body">
                    <div class="row">
                        <div class="col-md-7">
                            <select class="form-control margin-bottom-15" name="evaluation_status">
                                <option value="0" '; echo $row['evaluation_status'] == 0 ? 'SELECTED':''; echo '>--Select Status--</option>
                                <option value="1" '; echo $row['evaluation_status'] == 1 ? 'SELECTED':''; echo '>Proposed</option>
                                <option value="2" '; echo $row['evaluation_status'] == 2 ? 'SELECTED':''; echo '>Implemented</option>
                            </select>
                            <textarea class="form-control margin-bottom-15" rows="10" name="evaluation_desc">'.$row['evaluation_desc'].'</textarea>
                        </div>
                        <div class="col-md-5">
                            <label>Supporting Documents / Evidence:</label>
                            <div class="mt-repeater mt-repeater-evaluation">
                                <div data-repeater-list="evaluation">';

                                    echo '<div class="mt-repeater-item mt-repeater-item-hide row" data-repeater-item>
                                        <div class="col-xs-10">
                                            <input type="hidden" name="evaluation_file_temp" value="" />
                                            <input class="form-control" type="file" name="evaluation_file" />
                                        </div>
                                        <div class="col-xs-2">
                                            <a href="javascript:;" data-repeater-delete class="btn btn-danger"><i class="fa fa-close"></i></a>
                                        </div>
                                    </div>';

                                    if (!empty($row['evaluation_file'])) {
                                        $array_evaluation_file = explode(' | ', $row['evaluation_file']);
                                        foreach($array_evaluation_file as $value) {
                                            if (!empty($value)) {
                                                $file = $value;
                                                $fileExtension = fileExtension($file);
                                                $src = $fileExtension['src'];
                                                $embed = $fileExtension['embed'];
                                                $type = $fileExtension['type'];
                                                $file_extension = $fileExtension['file_extension'];
                                                $url = $base_url.'uploads/cam/';
                                                $file_src = $src.$url.rawurlencode($file).$embed;

                                                echo '<div class="mt-repeater-item row" data-repeater-item>
                                                    <div class="col-xs-10">
                                                        <input type="hidden" name="evaluation_file_temp" value="'.$value.'" />
                                                        <input class="form-control '; echo !empty($file) ? 'hide':''; echo '" type="file" name="evaluation_file" />
                                                        <p class="'; echo !empty($file) ? '':'hide'; echo '" style="margin: 0;"><a data-src="'.$file_src.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a> | <button type="button" class="btn btn-link uploadNew" onclick="uploadNew(this)">Upload New</button></p>
                                                    </div>
                                                    <div class="col-xs-2">
                                                        <a href="javascript:;" data-repeater-delete class="btn btn-danger"><i class="fa fa-close"></i></a>
                                                    </div>
                                                </div>';
                                            }
                                        }
                                    } else {
                                        echo '<div class="mt-repeater-item row" data-repeater-item>
                                            <div class="col-xs-10">
                                                <input type="hidden" name="evaluation_file_temp" value="" />
                                                <input class="form-control" type="file" name="evaluation_file" />
                                            </div>
                                            <div class="col-xs-2">
                                                <a href="javascript:;" data-repeater-delete class="btn btn-danger"><i class="fa fa-close"></i></a>
                                            </div>
                                        </div>';
                                    }
                                    
                                echo '</div>
                                <a href="javascript:;" data-repeater-create class="btn btn-success mt-repeater-add"><i class="fa fa-plus"></i> Add more</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="portlet box default margin-bottom-15">
                <div class="portlet-title">
                    <div class="caption">
                        <span class="caption-subject font-dark bold">Comments</span>
                    </div>
                </div>
                <div class="portlet-body">
                    <div class="row">
                        <div class="col-md-7">
                            <textarea class="form-control margin-bottom-15" rows="10" name="comment_desc">'.$row['comment'].'</textarea>
                        </div>
                        <div class="col-md-5">
                            <label>Supporting Documents / Evidence:</label>
                            <div class="mt-repeater mt-repeater-comment">
                                <div data-repeater-list="comment">';

                                    echo '<div class="mt-repeater-item mt-repeater-item-hide row" data-repeater-item>
                                        <div class="col-xs-10">
                                            <input type="hidden" name="comment_file_temp" value="" />
                                            <input class="form-control" type="file" name="comment_file" />
                                        </div>
                                        <div class="col-xs-2">
                                            <a href="javascript:;" data-repeater-delete class="btn btn-danger"><i class="fa fa-close"></i></a>
                                        </div>
                                    </div>';

                                    if (!empty($row['comment_file'])) {
                                        $array_comment_file = explode(' | ', $row['comment_file']);
                                        foreach($array_comment_file as $value) {
                                            if (!empty($value)) {
                                                $file = $value;
                                                $fileExtension = fileExtension($file);
                                                $src = $fileExtension['src'];
                                                $embed = $fileExtension['embed'];
                                                $type = $fileExtension['type'];
                                                $file_extension = $fileExtension['file_extension'];
                                                $url = $base_url.'uploads/cam/';
                                                $file_src = $src.$url.rawurlencode($file).$embed;

                                                echo '<div class="mt-repeater-item row" data-repeater-item>
                                                    <div class="col-xs-10">
                                                        <input type="hidden" name="comment_file_temp" value="'.$value.'" />
                                                        <input class="form-control '; echo !empty($file) ? 'hide':''; echo '" type="file" name="comment_file" />
                                                        <p class="'; echo !empty($file) ? '':'hide'; echo '" style="margin: 0;"><a data-src="'.$file_src.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a> | <button type="button" class="btn btn-link uploadNew" onclick="uploadNew(this)">Upload New</button></p>
                                                    </div>
                                                    <div class="col-xs-2">
                                                        <a href="javascript:;" data-repeater-delete class="btn btn-danger"><i class="fa fa-close"></i></a>
                                                    </div>
                                                </div>';
                                            }
                                        }
                                    } else {
                                        echo '<div class="mt-repeater-item row" data-repeater-item>
                                            <div class="col-xs-10">
                                                <input type="hidden" name="comment_file_temp" value="" />
                                                <input class="form-control" type="file" name="comment_file" />
                                            </div>
                                            <div class="col-xs-2">
                                                <a href="javascript:;" data-repeater-delete class="btn btn-danger"><i class="fa fa-close"></i></a>
                                            </div>
                                        </div>';
                                    }
                                    
                                echo '</div>
                                <a href="javascript:;" data-repeater-create class="btn btn-success mt-repeater-add"><i class="fa fa-plus"></i> Add more</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="portlet box default margin-bottom-15">
                <div class="portlet-title">
                    <div class="caption">
                        <span class="caption-subject font-dark bold">Applicable Trainings</span>
                    </div>
                </div>
                <div class="portlet-body">
                    <div class="row">
                        <div class="col-md-7">';

                            // if ($current_client == 1) {
                                echo '<label>Training(s):</label>
                                <select class="form-control mt-multiselect training_desc_2" data-placeholder="Please Select" name="training_desc[]" multiple="multiple"></select>';
                            // } else {
                            //     echo '<textarea class="form-control" rows="10" name="training_desc">'.$row['training'].'</textarea>';
                            // }

                            echo '<div class="row margin-top-15">
                                <div class="col-md-6">
                                    <input type="time" class="form-control margin-bottom-15" name="training_date" placeholder="Date" value="'.$row['training_date'].'" />
                                </div>
                            </div>
                        </div>
                        <div class="col-md-5">
                            <label>Supporting Documents / Evidence:</label>
                            <div class="mt-repeater mt-repeater-training">
                                <div data-repeater-list="training">';

                                    echo '<div class="mt-repeater-item mt-repeater-item-hide row" data-repeater-item>
                                        <div class="col-xs-10">
                                            <input type="hidden" name="training_file_temp" value="" />
                                            <input class="form-control" type="file" name="training_file" />
                                        </div>
                                        <div class="col-xs-2">
                                            <a href="javascript:;" data-repeater-delete class="btn btn-danger"><i class="fa fa-close"></i></a>
                                        </div>
                                    </div>';

                                    if (!empty($row['training_file'])) {
                                        $array_training_file = explode(' | ', $row['training_file']);
                                        foreach($array_training_file as $value) {
                                            if (!empty($value)) {
                                                $file = $value;
                                                $fileExtension = fileExtension($file);
                                                $src = $fileExtension['src'];
                                                $embed = $fileExtension['embed'];
                                                $type = $fileExtension['type'];
                                                $file_extension = $fileExtension['file_extension'];
                                                $url = $base_url.'uploads/cam/';
                                                $file_src = $src.$url.rawurlencode($file).$embed;

                                                echo '<div class="mt-repeater-item row" data-repeater-item>
                                                    <div class="col-xs-10">
                                                        <input type="hidden" name="training_file_temp" value="'.$value.'" />
                                                        <input class="form-control '; echo !empty($file) ? 'hide':''; echo '" type="file" name="training_file" />
                                                        <p class="'; echo !empty($file) ? '':'hide'; echo '" style="margin: 0;"><a data-src="'.$file_src.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a> | <button type="button" class="btn btn-link uploadNew" onclick="uploadNew(this)">Upload New</button></p>
                                                    </div>
                                                    <div class="col-xs-2">
                                                        <a href="javascript:;" data-repeater-delete class="btn btn-danger"><i class="fa fa-close"></i></a>
                                                    </div>
                                                </div>';
                                            }
                                        }
                                    } else {
                                        echo '<div class="mt-repeater-item row" data-repeater-item>
                                            <div class="col-xs-10">
                                                <input type="hidden" name="training_file_temp" value="" />
                                                <input class="form-control" type="file" name="training_file" />
                                            </div>
                                            <div class="col-xs-2">
                                                <a href="javascript:;" data-repeater-delete class="btn btn-danger"><i class="fa fa-close"></i></a>
                                            </div>
                                        </div>';
                                    }
                                    
                                echo '</div>
                                <a href="javascript:;" data-repeater-create class="btn btn-success mt-repeater-add"><i class="fa fa-plus"></i> Add more</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="portlet box default margin-bottom-15">
                <div class="portlet-body">
                    <div class="row">
                        <div class="col-md-3">
                            <input type="text" class="form-control margin-bottom-15" name="investigated_by" placeholder="Investigated By" value="'.$row['investigated_by'].'" />
                        </div>
                        <div class="col-md-3">
                            <input type="text" class="form-control margin-bottom-15" name="investigated_title" placeholder="Title" value="'.$row['investigated_title'].'" />
                        </div>
                        <div class="col-md-3">
                            <input type="date" class="form-control margin-bottom-15" name="investigated_date" placeholder="text" value="'.$row['investigated_date'].'" />
                        </div>
                        <div class="col-md-3">
                            <input type="time" class="form-control margin-bottom-15" name="investigated_time" placeholder="text" value="'.$row['investigated_time'].'" />
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-3">
                            <input type="text" class="form-control margin-bottom-15" name="verified_by" placeholder="CAPA Verified By" value="'.$row['verified_by'].'" />
                        </div>
                        <div class="col-md-3">
                            <input type="text" class="form-control margin-bottom-15" name="verified_title" placeholder="Title" value="'.$row['verified_title'].'" />
                        </div>
                        <div class="col-md-3">
                            <input type="date" class="form-control margin-bottom-15" name="verified_date" placeholder="text" value="'.$row['verified_date'].'" />
                        </div>
                        <div class="col-md-3">
                            <input type="time" class="form-control margin-bottom-15" name="verified_time" placeholder="text" value="'.$row['verified_time'].'" />
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-3">
                            <input type="text" class="form-control margin-bottom-15" name="completed_by" placeholder="CAPA Completed By" value="'.$row['completed_by'].'" />
                        </div>
                        <div class="col-md-3">
                            <input type="text" class="form-control margin-bottom-15" name="completed_title" placeholder="Title" value="'.$row['completed_title'].'" />
                        </div>
                        <div class="col-md-3">
                            <input type="date" class="form-control margin-bottom-15" name="completed_date" placeholder="text" value="'.$row['completed_date'].'" />
                        </div>
                        <div class="col-md-3">
                            <input type="time" class="form-control margin-bottom-15" name="completed_time" placeholder="text" value="'.$row['completed_time'].'" />
                        </div>
                    </div>
                </div>
            </div>';
        }
    }
    if( isset($_GET['modalEdit_CAM2']) ) {
        $ID = $_GET['modalEdit_CAM2'];

        $current_client = 0;
        if (isset($_COOKIE['client'])) { $current_client = $_COOKIE['client']; }

        if (!empty($_COOKIE['switchAccount'])) {
            $portal_user = $_COOKIE['ID'];
            $user_id = $_COOKIE['switchAccount'];
        }
        else {
            $portal_user = $_COOKIE['ID'];
            $user_id = employerID($portal_user);
        }

        $selectData = mysqli_query( $conn,"SELECT * FROM tbl_complaint_records WHERE care_id = $ID" );
        if ( mysqli_num_rows($selectData) > 0 ) {
            $row = mysqli_fetch_array($selectData);

            echo '<input class="form-control" type="hidden" name="ID" value="'.$ID.'" />
            <div class="portlet box default margin-bottom-15">
                <div class="portlet-body">
                    <div class="row form-horizontal">
                        <div class="col-md-4">
                            <label class="control-label">Is this a Product related  issue?</label>
                        </div>
                        <div class="col-md-2">
                            <select class="form-control margin-bottom-15" name="product_related">
                                <option value="0"'; echo $row['product_related'] == 0 ? 'SELECTED':''; echo '>No</option>
                                <option value="1"'; echo $row['product_related'] == 0 ? 'SELECTED':''; echo '>Yes</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-2">
                            <label class="control-label">Date of Issue</label>
                            <input type="date" class="form-control" name="date" value="'.date('Y-m-d', strtotime($row['care_date'])).'" />
                        </div>
                        <div class="col-md-2">
                            <label class="control-label">Time of Issue</label>
                            <input type="time" class="form-control" name="time" value="'.$row['time'].'" />
                        </div>
                        <div class="col-md-2 col-md-offset-1">
                            <label class="control-label">Observed By</label>
                            <input type="text" class="form-control" name="observed_by" value="'.$row['observed_by'].'"  />
                        </div>
                        <div class="col-md-2">
                            <label class="control-label">Reported By</label>
                            <input type="text" class="form-control" name="reported_by" value="'.$row['reported_by'].'" />
                        </div>
                        <div class="col-md-2 col-md-offset-1 '; echo $current_client == 1 ? 'hide':''; echo '">
                            <label class="control-label">CAPA Reference No.</label>
                            <input type="text" class="form-control" name="reference" value="'.$row['reference'].'" />
                        </div>
                    </div>
                </div>
            </div>';

            if ($current_client == 1) {
                echo '<div class="portlet box default margin-bottom-15">
                    <div class="portlet-title">
                        <div class="caption">
                            <span class="caption-subject font-dark bold">Program</span>
                        </div>
                    </div>
                    <div class="portlet-body">
                        <div class="mt-checkbox-inline">';

                            $selectProgram = mysqli_query( $conn,"SELECT * FROM tbl_library WHERE type = 1 AND deleted = 0 AND user_id = $user_id" );
                            if ( mysqli_num_rows($selectProgram) > 0 ) {
                                while ($rowProgram = mysqli_fetch_array($selectProgram)) {
                                    $program_ID = $rowProgram['ID'];
                                    $program_name = $rowProgram['name'];

                                    $arr_program_ID =  array();
                                    if (!empty($row['program_id'])) {
                                        $arr_program_ID =  explode(', ', $row['program_id']);
                                    }

                                    echo '<label class="mt-checkbox mt-checkbox-outline">
                                        <input type="checkbox" name="program_id[]" value="'.$program_ID.'" '; echo in_array($program_ID, $arr_program_ID) ? 'checked':''; echo '> '.$program_name.'
                                        <span></span>
                                    </label>';
                                }
                            }

                        echo '</div>
                    </div>
                </div>';

                echo '<div class="portlet box default margin-bottom-15">
                    <div class="portlet-title">
                        <div class="caption">
                            <span class="caption-subject font-dark bold">Complaint Category</span>
                        </div>
                    </div>
                    <div class="portlet-body">
                        <div class="mt-checkbox-inline">';

                            $arr_complaint_id =  explode(', ', $row['complaint_category']);
                            $selectComplaint = mysqli_query( $conn,"SELECT * FROM tbl_cam_complaint_category WHERE deleted = 0 ORDER BY name" );
                            if ( mysqli_num_rows($selectComplaint) > 0 ) {
                                while ($rowComp = mysqli_fetch_array($selectComplaint)) {
                                    $comp_ID = $rowComp['ID'];
                                    $comp_name = $rowComp['name'];

                                    echo '<label class="mt-checkbox mt-checkbox-outline">
                                        <input type="checkbox" name="complaint_id[]" value="'.$comp_ID.'" '; echo in_array($comp_ID, $arr_complaint_id) ? 'checked':''; echo '> '.$comp_name.'
                                        <span></span>
                                    </label>';
                                }
                            }

                            echo '<label class="mt-checkbox mt-checkbox-outline">
                                <input type="checkbox" name="complaint_id[]" value="0" '; echo !is_numeric($row['complaint_category']) ? 'checked':''; echo ' onClick="btnCategory(this)"> Other
                                <span></span>
                            </label>
                            <input type="text" class="form-control '; echo !is_numeric($row['complaint_category']) ? '':'hide'; echo '" name="category_other" placeholder="Specify Complaint Category" value="'.$row['complaint_category'].'" />
                        </div>
                    </div>
                </div>';
            } else {
                echo '<div class="portlet box default margin-bottom-15">
                    <div class="portlet-title">
                        <div class="caption">
                            <span class="caption-subject font-dark bold">Category</span>
                        </div>
                    </div>
                    <div class="portlet-body">
                        <div class="mt-checkbox-inline">';

                            $selectCategory = mysqli_query( $conn,"SELECT * FROM tbl_cam_category WHERE deleted = 0 ORDER BY name" );
                            if ( mysqli_num_rows($selectCategory) > 0 ) {
                                while ($rowCat = mysqli_fetch_array($selectCategory)) {
                                    $cat_ID = $rowCat['ID'];
                                    $cat_name = $rowCat['name'];
                                    $arr_category_id =  explode(', ', $row['category_id']);

                                    echo '<label class="mt-checkbox mt-checkbox-outline">
                                        <input type="checkbox" name="category_id[]" value="'.$cat_ID.'" '; echo in_array($cat_ID, $arr_category_id) ? 'checked':''; echo '> '.$cat_name.'
                                        <span></span>
                                    </label>';
                                }
                            }

                            echo '<label class="mt-checkbox mt-checkbox-outline">
                                <input type="checkbox" name="category_id[]" value="0" '; echo !empty($row['category_other']) ? 'checked':''; echo ' onClick="btnCategory(this)"> Other
                                <span></span>
                            </label>
                            <input type="text" class="form-control '; echo !empty($row['category_other']) ? '':'hide'; echo '" name="category_other" placeholder="Specify Category" value="'.$row['category_other'].'" />
                        </div>
                    </div>
                </div>';
            }

            echo '<div class="portlet box default margin-bottom-15">
                <div class="portlet-title">
                    <div class="caption">
                        <span class="caption-subject font-dark bold">Department(s) Involved</span>
                    </div>
                </div>
                <div class="portlet-body">
                    <div class="mt-checkbox-inline">';

                        $arr_department_id = array();
                        $cam_person_handlingn = $row['person_handling'];
                        if ($cam_person_handlingn > 0) {
                            $selectEmp = mysqli_query( $conn,"SELECT * FROM tbl_hr_employee WHERE ID = $cam_person_handlingn" );
                            if ( mysqli_num_rows($selectEmp) > 0 ) {
                                $rowEmp= mysqli_fetch_array($selectEmp);
                                $arr_department_id =  explode(', ', $rowEmp['department_id']);
                            }
                        }
                        if (!empty($row['department_id'])) { $arr_department_id =  explode(', ', $row['department_id']); }

                        $selectDepartment = mysqli_query( $conn,"SELECT * FROM tbl_hr_department WHERE status = 1 AND user_id = $user_id ORDER BY title" );
                        if ( mysqli_num_rows($selectDepartment) > 0 ) {
                            while ($rowDept = mysqli_fetch_array($selectDepartment)) {
                                $dept_ID = $rowDept['ID'];
                                $dept_title = $rowDept['title'];

                                echo '<label class="mt-checkbox mt-checkbox-outline">
                                    <input type="checkbox" class="department_id_2" name="department_id[]" value="'.$dept_ID.'" '; echo in_array($dept_ID, $arr_department_id) ? 'checked':''; echo ' onclick="changeDepartment(2, '.$dept_ID.')" /> '.$dept_title.'
                                    <span></span>
                                </label>';
                            }
                        }

                        echo '<label class="mt-checkbox mt-checkbox-outline hide">
                            <input type="checkbox" name="department_id[]" value="0"> Other
                            <span></span>
                        </label>
                        <input type="text" class="form-control hide" name="department_other" placeholder="Specify Department" value="'.$row['department_other'].'" />
                    </div>
                </div>
            </div>

            <div class="portlet box default margin-bottom-15">
                <div class="portlet-title">
                    <div class="caption">
                        <span class="caption-subject font-dark bold">Involved Personnel</span>
                    </div>
                </div>
                <div class="portlet-body">
                    <select class="form-control mt-multiselect employee_id_2" data-placeholder="Select Personnel" name="employee_id[]" multiple="multiple"></select>
                </div>
            </div>

            <div class="portlet box default margin-bottom-15">
                <div class="portlet-title">
                    <div class="caption">
                        <span class="caption-subject font-dark bold">Description of Issue</span>
                    </div>
                </div>
                <div class="portlet-body">
                    <textarea class="form-control" rows="3" name="description">'.$row['nature_complaint'].'</textarea>
                </div>
            </div>

            <div class="portlet box default margin-bottom-15 hide '; echo $_COOKIE['client'] == 0 ? '':'hide'; echo '">
                <div class="portlet-title">
                    <div class="caption">
                        <span class="caption-subject font-dark bold">Trend Category</span>
                    </div>
                </div>
                <div class="portlet-body">
                    <div class="mt-repeater mt-repeater-trend">
                        <div data-repeater-list="trend">';

                            if (!empty($row['trend'])) {
                                $array_trend = explode(' | ', $row['trend']);
                                foreach($array_trend as $value) {
                                    if (!empty($value)) {
                                        echo '<div class="mt-repeater-item row" data-repeater-item>
                                            <div class="col-xs-11">
                                                <input class="form-control" type="text" name="trend_desc" value="'.$value.'" />
                                            </div>
                                            <div class="col-xs-1">
                                                <a href="javascript:;" data-repeater-delete class="btn btn-danger"><i class="fa fa-close"></i></a>
                                            </div>
                                        </div>';
                                    }
                                }
                            }
                            
                        echo '</div>
                        <a href="javascript:;" data-repeater-create class="btn btn-success mt-repeater-add"><i class="fa fa-plus"></i> Add more</a>
                    </div>
                </div>
            </div>

            <div class="portlet box default margin-bottom-15">
                <div class="portlet-title">
                    <div class="caption">
                        <span class="caption-subject font-dark bold">Observation'; echo $current_client == 1 ? '(s)':' / Issue(s)'; echo '</span>
                    </div>
                </div>
                <div class="portlet-body">
                    <div class="row">
                        <div class="col-md-7">
                            <textarea class="form-control" rows="10" name="observation_desc">'.$row['observation'].'</textarea>
                        </div>
                        <div class="col-md-5">
                            <label>Supporting Documents / Evidence:</label>
                            <div class="mt-repeater mt-repeater-observation">
                                <div data-repeater-list="observation">';

                                    if (!empty($row['observation_file'])) {
                                        $array_observation_file = explode(' | ', $row['observation_file']);
                                        foreach($array_observation_file as $value) {
                                            if (!empty($value)) {
                                                $file = $value;
                                                $fileExtension = fileExtension($file);
                                                $src = $fileExtension['src'];
                                                $embed = $fileExtension['embed'];
                                                $type = $fileExtension['type'];
                                                $file_extension = $fileExtension['file_extension'];
                                                $url = $base_url.'uploads/cam/';
                                                $file_src = $src.$url.rawurlencode($file).$embed;

                                                echo '<div class="mt-repeater-item row" data-repeater-item>
                                                    <div class="col-xs-10">
                                                        <input type="hidden" name="observation_file_temp" value="'.$value.'" />
                                                        <input class="form-control '; echo !empty($file) ? 'hide':''; echo '" type="file" name="observation_file" />
                                                        <p class="'; echo !empty($file) ? '':'hide'; echo '" style="margin: 0;"><a data-src="'.$file_src.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a> | <button type="button" class="btn btn-link uploadNew" onclick="uploadNew(this)">Upload New</button></p>
                                                    </div>
                                                    <div class="col-xs-2">
                                                        <a href="javascript:;" data-repeater-delete class="btn btn-danger"><i class="fa fa-close"></i></a>
                                                    </div>
                                                </div>';
                                            }
                                        }
                                    } else {
                                        echo '<div class="mt-repeater-item row" data-repeater-item>
                                            <div class="col-xs-10">
                                                <input type="hidden" name="observation_file_temp" value="" />
                                                <input class="form-control" type="file" name="observation_file" />
                                            </div>
                                            <div class="col-xs-2">
                                                <a href="javascript:;" data-repeater-delete class="btn btn-danger"><i class="fa fa-close"></i></a>
                                            </div>
                                        </div>';
                                    }
                                    
                                echo '</div>
                                <a href="javascript:;" data-repeater-create class="btn btn-success mt-repeater-add"><i class="fa fa-plus"></i> Add more</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="portlet box default margin-bottom-15">
                <div class="portlet-title">
                    <div class="caption">
                        <span class="caption-subject font-dark bold">Root Cause(s)</span>
                    </div>
                </div>
                <div class="portlet-body">
                    <div class="row">
                        <div class="col-md-7">
                            <textarea class="form-control" rows="10" name="root_cause_desc">'.$row['root_cause'].'</textarea>
                        </div>
                        <div class="col-md-5">
                            <label>Supporting Documents / Evidence:</label>
                            <div class="mt-repeater mt-repeater-root_cause">
                                <div data-repeater-list="root_cause">';

                                    if (!empty($row['root_cause_file'])) {
                                        $array_root_cause_file = explode(' | ', $row['root_cause_file']);
                                        foreach($array_root_cause_file as $value) {
                                            if (!empty($value)) {
                                                $file = $value;
                                                $fileExtension = fileExtension($file);
                                                $src = $fileExtension['src'];
                                                $embed = $fileExtension['embed'];
                                                $type = $fileExtension['type'];
                                                $file_extension = $fileExtension['file_extension'];
                                                $url = $base_url.'uploads/cam/';
                                                $file_src = $src.$url.rawurlencode($file).$embed;

                                                echo '<div class="mt-repeater-item row" data-repeater-item>
                                                    <div class="col-xs-10">
                                                        <input type="hidden" name="root_cause_file_temp" value="'.$value.'" />
                                                        <input class="form-control '; echo !empty($file) ? 'hide':''; echo '" type="file" name="root_cause_file" />
                                                        <p class="'; echo !empty($file) ? '':'hide'; echo '" style="margin: 0;"><a data-src="'.$file_src.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a> | <button type="button" class="btn btn-link uploadNew" onclick="uploadNew(this)">Upload New</button></p>
                                                    </div>
                                                    <div class="col-xs-2">
                                                        <a href="javascript:;" data-repeater-delete class="btn btn-danger"><i class="fa fa-close"></i></a>
                                                    </div>
                                                </div>';
                                            }
                                        }
                                    } else {
                                        echo '<div class="mt-repeater-item row" data-repeater-item>
                                            <div class="col-xs-10">
                                                <input type="hidden" name="root_cause_file_temp" value="" />
                                                <input class="form-control" type="file" name="root_cause_file" />
                                            </div>
                                            <div class="col-xs-2">
                                                <a href="javascript:;" data-repeater-delete class="btn btn-danger"><i class="fa fa-close"></i></a>
                                            </div>
                                        </div>';
                                    }
                                    
                                echo '</div>
                                <a href="javascript:;" data-repeater-create class="btn btn-success mt-repeater-add"><i class="fa fa-plus"></i> Add more</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="portlet box default margin-bottom-15">
                <div class="portlet-title">
                    <div class="caption">
                        <span class="caption-subject font-dark bold">Corrective Action(s)</span>
                    </div>
                </div>
                <div class="portlet-body">
                    <div class="row">
                        <div class="col-md-7">
                            <select class="form-control margin-bottom-15 '; echo $current_client == 1 ? 'hide':''; echo '" name="corrective_status">
                                <option value="0" '; echo $row['corrective_status'] == 0 ? 'SELECTED':''; echo '>--Select Status--</option>
                                <option value="1" '; echo $row['corrective_status'] == 1 ? 'SELECTED':''; echo '>Proposed</option>
                                <option value="2" '; echo $row['corrective_status'] == 2 ? 'SELECTED':''; echo '>Implemented</option>
                            </select>
                            <textarea class="form-control margin-bottom-15" rows="10" name="corrective_desc">'.$row['action_taken'].'</textarea>
                            <div class="row">
                                <div class="col-md-4">
                                    <input type="date" class="form-control margin-bottom-15" name="corrective_date" placeholder="Date" value="'.date('Y-m-d', strtotime($row['date_resolution'])).'" />
                                </div>
                                <div class="col-md-4">
                                    <input type="time" class="form-control margin-bottom-15" name="corrective_time" placeholder="Time" value="'.$row['corrective_time'].'" />
                                </div>
                                <div class="col-md-4">
                                    <input type="text" class="form-control margin-bottom-15" name="corrective_by" placeholder="Corrected By" value="'.$row['corrective_by'].'" />
                                </div>
                            </div>
                        </div>
                        <div class="col-md-5">
                            <label>Supporting Documents / Evidence:</label>
                            <div class="mt-repeater mt-repeater-corrective">
                                <div data-repeater-list="corrective">';

                                    if (!empty($row['corrective_file'])) {
                                        $array_corrective_file = explode(' | ', $row['corrective_file']);
                                        foreach($array_corrective_file as $value) {
                                            if (!empty($value)) {
                                                $file = $value;
                                                $fileExtension = fileExtension($file);
                                                $src = $fileExtension['src'];
                                                $embed = $fileExtension['embed'];
                                                $type = $fileExtension['type'];
                                                $file_extension = $fileExtension['file_extension'];
                                                $url = $base_url.'uploads/cam/';
                                                $file_src = $src.$url.rawurlencode($file).$embed;

                                                echo '<div class="mt-repeater-item row" data-repeater-item>
                                                    <div class="col-xs-10">
                                                        <input type="hidden" name="corrective_file_temp" value="'.$value.'" />
                                                        <input class="form-control '; echo !empty($file) ? 'hide':''; echo '" type="file" name="corrective_file" />
                                                        <p class="'; echo !empty($file) ? '':'hide'; echo '" style="margin: 0;"><a data-src="'.$file_src.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a> | <button type="button" class="btn btn-link uploadNew" onclick="uploadNew(this)">Upload New</button></p>
                                                    </div>
                                                    <div class="col-xs-2">
                                                        <a href="javascript:;" data-repeater-delete class="btn btn-danger"><i class="fa fa-close"></i></a>
                                                    </div>
                                                </div>';
                                            }
                                        }
                                    } else {
                                        echo '<div class="mt-repeater-item row" data-repeater-item>
                                            <div class="col-xs-10">
                                                <input type="hidden" name="corrective_file_temp" value="" />
                                                <input class="form-control" type="file" name="corrective_file" />
                                            </div>
                                            <div class="col-xs-2">
                                                <a href="javascript:;" data-repeater-delete class="btn btn-danger"><i class="fa fa-close"></i></a>
                                            </div>
                                        </div>';
                                    }
                                    
                                echo '</div>
                                <a href="javascript:;" data-repeater-create class="btn btn-success mt-repeater-add"><i class="fa fa-plus"></i> Add more</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="portlet box default margin-bottom-15">
                <div class="portlet-title">
                    <div class="caption">
                        <span class="caption-subject font-dark bold">Implementation(s)</span>
                    </div>
                </div>
                <div class="portlet-body">
                    <div class="row">
                        <div class="col-md-7">
                            <select class="form-control margin-bottom-15" name="implementation_status">
                                <option value="0" '; echo $row['implementation_status'] == 0 ? 'SELECTED':''; echo '>--Select Status--</option>
                                <option value="1" '; echo $row['implementation_status'] == 1 ? 'SELECTED':''; echo '>Proposed</option>
                                <option value="2" '; echo $row['implementation_status'] == 2 ? 'SELECTED':''; echo '>Implemented</option>
                            </select>
                            <textarea class="form-control margin-bottom-15" rows="10" name="implementation_desc">'.$row['implementation_desc'].'</textarea>
                            <div class="row form-horizontal">
                                <div class="col-md-4">
                                    <label class="control-label">Effective Date of Resolution</label>
                                </div>
                                <div class="col-md-4">
                                    <input type="date" class="form-control margin-bottom-15" name="implementation_date" placeholder="Date" value="'.$row['implementation_date'].'"/>
                                </div>
                                <div class="col-md-4">
                                    <input type="text" class="form-control margin-bottom-15" name="implementation_by" placeholder="Implemented By" value="'.$row['implementation_by'].'" />
                                </div>
                            </div>
                        </div>
                        <div class="col-md-5">
                            <label>Supporting Documents / Evidence:</label>
                            <div class="mt-repeater mt-repeater-implementation">
                                <div data-repeater-list="implementation">';

                                    if (!empty($row['implementation_file'])) {
                                        $array_implementation_file = explode(' | ', $row['implementation_file']);
                                        foreach($array_implementation_file as $value) {
                                            if (!empty($value)) {
                                                $file = $value;
                                                $fileExtension = fileExtension($file);
                                                $src = $fileExtension['src'];
                                                $embed = $fileExtension['embed'];
                                                $type = $fileExtension['type'];
                                                $file_extension = $fileExtension['file_extension'];
                                                $url = $base_url.'uploads/cam/';
                                                $file_src = $src.$url.rawurlencode($file).$embed;

                                                echo '<div class="mt-repeater-item row" data-repeater-item>
                                                    <div class="col-xs-10">
                                                        <input type="hidden" name="implementation_file_temp" value="'.$value.'" />
                                                        <input class="form-control '; echo !empty($file) ? 'hide':''; echo '" type="file" name="implementation_file" />
                                                        <p class="'; echo !empty($file) ? '':'hide'; echo '" style="margin: 0;"><a data-src="'.$file_src.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a> | <button type="button" class="btn btn-link uploadNew" onclick="uploadNew(this)">Upload New</button></p>
                                                    </div>
                                                    <div class="col-xs-2">
                                                        <a href="javascript:;" data-repeater-delete class="btn btn-danger"><i class="fa fa-close"></i></a>
                                                    </div>
                                                </div>';
                                            }
                                        }
                                    } else {
                                        echo '<div class="mt-repeater-item row" data-repeater-item>
                                            <div class="col-xs-10">
                                                <input type="hidden" name="implementation_file_temp" value="" />
                                                <input class="form-control" type="file" name="implementation_file" />
                                            </div>
                                            <div class="col-xs-2">
                                                <a href="javascript:;" data-repeater-delete class="btn btn-danger"><i class="fa fa-close"></i></a>
                                            </div>
                                        </div>';
                                    }
                                    
                                echo '</div>
                                <a href="javascript:;" data-repeater-create class="btn btn-success mt-repeater-add"><i class="fa fa-plus"></i> Add more</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="portlet box default margin-bottom-15">
                <div class="portlet-title">
                    <div class="caption">
                        <span class="caption-subject font-dark bold">Preventive Action(s)</span>
                    </div>
                </div>
                <div class="portlet-body">
                    <div class="row">
                        <div class="col-md-7">
                            <select class="form-control margin-bottom-15" name="preventive_status">
                                <option value="0" '; echo $row['implementation_status'] == 0 ? 'SELECTED':''; echo '>--Select Status--</option>
                                <option value="1" '; echo $row['implementation_status'] == 1 ? 'SELECTED':''; echo '>Proposed</option>
                                <option value="2" '; echo $row['implementation_status'] == 2 ? 'SELECTED':''; echo '>Implemented</option>
                            </select>
                            <textarea class="form-control margin-bottom-15" rows="10" name="preventive_desc">'.$row['preventive_desc'].'</textarea>
                        </div>
                        <div class="col-md-5">
                            <label>Supporting Documents / Evidence:</label>
                            <div class="mt-repeater mt-repeater-preventive">
                                <div data-repeater-list="preventive">';

                                    if (!empty($row['preventive_file'])) {
                                        $array_preventive_file = explode(' | ', $row['preventive_file']);
                                        foreach($array_preventive_file as $value) {
                                            if (!empty($value)) {
                                                $file = $value;
                                                $fileExtension = fileExtension($file);
                                                $src = $fileExtension['src'];
                                                $embed = $fileExtension['embed'];
                                                $type = $fileExtension['type'];
                                                $file_extension = $fileExtension['file_extension'];
                                                $url = $base_url.'uploads/cam/';
                                                $file_src = $src.$url.rawurlencode($file).$embed;

                                                echo '<div class="mt-repeater-item row" data-repeater-item>
                                                    <div class="col-xs-10">
                                                        <input type="hidden" name="preventive_file_temp" value="'.$value.'" />
                                                        <input class="form-control '; echo !empty($file) ? 'hide':''; echo '" type="file" name="preventive_file" />
                                                        <p class="'; echo !empty($file) ? '':'hide'; echo '" style="margin: 0;"><a data-src="'.$file_src.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a> | <button type="button" class="btn btn-link uploadNew" onclick="uploadNew(this)">Upload New</button></p>
                                                    </div>
                                                    <div class="col-xs-2">
                                                        <a href="javascript:;" data-repeater-delete class="btn btn-danger"><i class="fa fa-close"></i></a>
                                                    </div>
                                                </div>';
                                            }
                                        }
                                    } else {
                                        echo '<div class="mt-repeater-item row" data-repeater-item>
                                            <div class="col-xs-10">
                                                <input type="hidden" name="preventive_file_temp" value="" />
                                                <input class="form-control" type="file" name="preventive_file" />
                                            </div>
                                            <div class="col-xs-2">
                                                <a href="javascript:;" data-repeater-delete class="btn btn-danger"><i class="fa fa-close"></i></a>
                                            </div>
                                        </div>';
                                    }
                                    
                                echo '</div>
                                <a href="javascript:;" data-repeater-create class="btn btn-success mt-repeater-add"><i class="fa fa-plus"></i> Add more</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="portlet box default margin-bottom-15">
                <div class="portlet-title">
                    <div class="caption">
                        <span class="caption-subject font-dark bold">Evaluation(s) and Follow Up(s)</span>
                    </div>
                </div>
                <div class="portlet-body">
                    <div class="row">
                        <div class="col-md-7">
                            <select class="form-control margin-bottom-15" name="evaluation_status">
                                <option value="0" '; echo $row['evaluation_status'] == 0 ? 'SELECTED':''; echo '>--Select Status--</option>
                                <option value="1" '; echo $row['evaluation_status'] == 1 ? 'SELECTED':''; echo '>Proposed</option>
                                <option value="2" '; echo $row['evaluation_status'] == 2 ? 'SELECTED':''; echo '>Implemented</option>
                            </select>
                            <textarea class="form-control margin-bottom-15" rows="10" name="evaluation_desc">'.$row['evaluation_desc'].'</textarea>
                        </div>
                        <div class="col-md-5">
                            <label>Supporting Documents / Evidence:</label>
                            <div class="mt-repeater mt-repeater-evaluation">
                                <div data-repeater-list="evaluation">';

                                    if (!empty($row['evaluation_file'])) {
                                        $array_evaluation_file = explode(' | ', $row['evaluation_file']);
                                        foreach($array_evaluation_file as $value) {
                                            if (!empty($value)) {
                                                $file = $value;
                                                $fileExtension = fileExtension($file);
                                                $src = $fileExtension['src'];
                                                $embed = $fileExtension['embed'];
                                                $type = $fileExtension['type'];
                                                $file_extension = $fileExtension['file_extension'];
                                                $url = $base_url.'uploads/cam/';
                                                $file_src = $src.$url.rawurlencode($file).$embed;

                                                echo '<div class="mt-repeater-item row" data-repeater-item>
                                                    <div class="col-xs-10">
                                                        <input type="hidden" name="evaluation_file_temp" value="'.$value.'" />
                                                        <input class="form-control '; echo !empty($file) ? 'hide':''; echo '" type="file" name="evaluation_file" />
                                                        <p class="'; echo !empty($file) ? '':'hide'; echo '" style="margin: 0;"><a data-src="'.$file_src.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a> | <button type="button" class="btn btn-link uploadNew" onclick="uploadNew(this)">Upload New</button></p>
                                                    </div>
                                                    <div class="col-xs-2">
                                                        <a href="javascript:;" data-repeater-delete class="btn btn-danger"><i class="fa fa-close"></i></a>
                                                    </div>
                                                </div>';
                                            }
                                        }
                                    } else {
                                        echo '<div class="mt-repeater-item row" data-repeater-item>
                                            <div class="col-xs-10">
                                                <input type="hidden" name="evaluation_file_temp" value="" />
                                                <input class="form-control" type="file" name="evaluation_file" />
                                            </div>
                                            <div class="col-xs-2">
                                                <a href="javascript:;" data-repeater-delete class="btn btn-danger"><i class="fa fa-close"></i></a>
                                            </div>
                                        </div>';
                                    }
                                    
                                echo '</div>
                                <a href="javascript:;" data-repeater-create class="btn btn-success mt-repeater-add"><i class="fa fa-plus"></i> Add more</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="portlet box default margin-bottom-15">
                <div class="portlet-title">
                    <div class="caption">
                        <span class="caption-subject font-dark bold">Comments</span>
                    </div>
                </div>
                <div class="portlet-body">
                    <div class="row">
                        <div class="col-md-7">
                            <textarea class="form-control margin-bottom-15" rows="10" name="comment_desc">'.$row['comment'].'</textarea>
                        </div>
                        <div class="col-md-5">
                            <label>Supporting Documents / Evidence:</label>
                            <div class="mt-repeater mt-repeater-comment">
                                <div data-repeater-list="comment">';

                                    if (!empty($row['comment_file'])) {
                                        $array_comment_file = explode(' | ', $row['comment_file']);
                                        foreach($array_comment_file as $value) {
                                            if (!empty($value)) {
                                                $file = $value;
                                                $fileExtension = fileExtension($file);
                                                $src = $fileExtension['src'];
                                                $embed = $fileExtension['embed'];
                                                $type = $fileExtension['type'];
                                                $file_extension = $fileExtension['file_extension'];
                                                $url = $base_url.'uploads/cam/';
                                                $file_src = $src.$url.rawurlencode($file).$embed;

                                                echo '<div class="mt-repeater-item row" data-repeater-item>
                                                    <div class="col-xs-10">
                                                        <input type="hidden" name="comment_file_temp" value="'.$value.'" />
                                                        <input class="form-control '; echo !empty($file) ? 'hide':''; echo '" type="file" name="comment_file" />
                                                        <p class="'; echo !empty($file) ? '':'hide'; echo '" style="margin: 0;"><a data-src="'.$file_src.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a> | <button type="button" class="btn btn-link uploadNew" onclick="uploadNew(this)">Upload New</button></p>
                                                    </div>
                                                    <div class="col-xs-2">
                                                        <a href="javascript:;" data-repeater-delete class="btn btn-danger"><i class="fa fa-close"></i></a>
                                                    </div>
                                                </div>';
                                            }
                                        }
                                    } else {
                                        echo '<div class="mt-repeater-item row" data-repeater-item>
                                            <div class="col-xs-10">
                                                <input type="hidden" name="comment_file_temp" value="" />
                                                <input class="form-control" type="file" name="comment_file" />
                                            </div>
                                            <div class="col-xs-2">
                                                <a href="javascript:;" data-repeater-delete class="btn btn-danger"><i class="fa fa-close"></i></a>
                                            </div>
                                        </div>';
                                    }
                                    
                                echo '</div>
                                <a href="javascript:;" data-repeater-create class="btn btn-success mt-repeater-add"><i class="fa fa-plus"></i> Add more</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="portlet box default margin-bottom-15">
                <div class="portlet-title">
                    <div class="caption">
                        <span class="caption-subject font-dark bold">Applicable Trainings</span>
                    </div>
                </div>
                <div class="portlet-body">
                    <div class="row">
                        <div class="col-md-7">';

                            // if ($current_client == 1) {
                                echo '<label>Training(s):</label>
                                <select class="form-control mt-multiselect training_desc_2" data-placeholder="Please Select" name="training_desc[]" multiple="multiple"></select>';
                            // } else {
                            //  echo '<textarea class="form-control" rows="10" name="training_desc">'.$row['training'].'</textarea>';
                            // }

                            echo '<div class="row margin-top-15">
                                <div class="col-md-6">
                                    <input type="time" class="form-control margin-bottom-15" name="training_date" placeholder="Date" value="'.$row['training_date'].'" />
                                </div>
                            </div>
                        </div>
                        <div class="col-md-5">
                            <label>Supporting Documents / Evidence:</label>
                            <div class="mt-repeater mt-repeater-training">
                                <div data-repeater-list="training">';

                                    if (!empty($row['training_file'])) {
                                        $array_training_file = explode(' | ', $row['training_file']);
                                        foreach($array_training_file as $value) {
                                            if (!empty($value)) {
                                                $file = $value;
                                                $fileExtension = fileExtension($file);
                                                $src = $fileExtension['src'];
                                                $embed = $fileExtension['embed'];
                                                $type = $fileExtension['type'];
                                                $file_extension = $fileExtension['file_extension'];
                                                $url = $base_url.'uploads/cam/';
                                                $file_src = $src.$url.rawurlencode($file).$embed;

                                                echo '<div class="mt-repeater-item row" data-repeater-item>
                                                    <div class="col-xs-10">
                                                        <input type="hidden" name="training_file_temp" value="'.$value.'" />
                                                        <input class="form-control '; echo !empty($file) ? 'hide':''; echo '" type="file" name="training_file" />
                                                        <p class="'; echo !empty($file) ? '':'hide'; echo '" style="margin: 0;"><a data-src="'.$file_src.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a> | <button type="button" class="btn btn-link uploadNew" onclick="uploadNew(this)">Upload New</button></p>
                                                    </div>
                                                    <div class="col-xs-2">
                                                        <a href="javascript:;" data-repeater-delete class="btn btn-danger"><i class="fa fa-close"></i></a>
                                                    </div>
                                                </div>';
                                            }
                                        }
                                    } else {
                                        echo '<div class="mt-repeater-item row" data-repeater-item>
                                            <div class="col-xs-10">
                                                <input type="hidden" name="training_file_temp" value="" />
                                                <input class="form-control" type="file" name="training_file" />
                                            </div>
                                            <div class="col-xs-2">
                                                <a href="javascript:;" data-repeater-delete class="btn btn-danger"><i class="fa fa-close"></i></a>
                                            </div>
                                        </div>';
                                    }
                                    
                                echo '</div>
                                <a href="javascript:;" data-repeater-create class="btn btn-success mt-repeater-add"><i class="fa fa-plus"></i> Add more</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="portlet box default margin-bottom-15">
                <div class="portlet-body">
                    <div class="row">
                        <div class="col-md-3">
                            <input type="text" class="form-control margin-bottom-15" name="investigated_by" placeholder="Investigated By" value="'.$row['investigated_by'].'" />
                        </div>
                        <div class="col-md-3">
                            <input type="text" class="form-control margin-bottom-15" name="investigated_title" placeholder="Title" value="'.$row['investigated_title'].'" />
                        </div>
                        <div class="col-md-3">
                            <input type="date" class="form-control margin-bottom-15" name="investigated_date" placeholder="text" value="'.$row['investigated_date'].'" />
                        </div>
                        <div class="col-md-3">
                            <input type="time" class="form-control margin-bottom-15" name="investigated_time" placeholder="text" value="'.$row['investigated_time'].'" />
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-3">
                            <input type="text" class="form-control margin-bottom-15" name="verified_by" placeholder="CAPA Verified By" value="'.$row['verified_by'].'" />
                        </div>
                        <div class="col-md-3">
                            <input type="text" class="form-control margin-bottom-15" name="verified_title" placeholder="Title" value="'.$row['verified_title'].'" />
                        </div>
                        <div class="col-md-3">
                            <input type="date" class="form-control margin-bottom-15" name="verified_date" placeholder="text" value="'.$row['verified_date'].'" />
                        </div>
                        <div class="col-md-3">
                            <input type="time" class="form-control margin-bottom-15" name="verified_time" placeholder="text" value="'.$row['verified_time'].'" />
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-3">
                            <input type="text" class="form-control margin-bottom-15" name="completed_by" placeholder="CAPA Completed By" value="'.$row['completed_by'].'" />
                        </div>
                        <div class="col-md-3">
                            <input type="text" class="form-control margin-bottom-15" name="completed_title" placeholder="Title" value="'.$row['completed_title'].'" />
                        </div>
                        <div class="col-md-3">
                            <input type="date" class="form-control margin-bottom-15" name="completed_date" placeholder="text" value="'.$row['completed_date'].'" />
                        </div>
                        <div class="col-md-3">
                            <input type="time" class="form-control margin-bottom-15" name="completed_time" placeholder="text" value="'.$row['completed_time'].'" />
                        </div>
                    </div>
                </div>
            </div>';
        }
    }
    if( isset($_GET['modalEdit_CAM22']) ) {
        $ID = $_GET['modalEdit_CAM22'];

        $current_client = 0;
        if (isset($_COOKIE['client'])) { $current_client = $_COOKIE['client']; }

        if (!empty($_COOKIE['switchAccount'])) {
            $portal_user = $_COOKIE['ID'];
            $user_id = $_COOKIE['switchAccount'];
        }
        else {
            $portal_user = $_COOKIE['ID'];
            $user_id = employerID($portal_user);
        }

        $selectData = mysqli_query( $conn,"SELECT * FROM tbl_complaint_records WHERE care_id = $ID" );
        if ( mysqli_num_rows($selectData) > 0 ) {
            $row = mysqli_fetch_array($selectData);

            echo '<input class="form-control" type="hidden" name="ID" value="'.$ID.'" />
            <div class="portlet box default margin-bottom-15">
                <div class="portlet-body">
                    <div class="row form-horizontal">
                        <div class="col-md-4">
                            <label class="control-label">Is this a Product related  issue?</label>
                        </div>
                        <div class="col-md-2">
                            <select class="form-control margin-bottom-15" name="product_related">
                                <option value="0">No</option>
                                <option value="1">Yes</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-2">
                            <label class="control-label">Date of Issue</label>
                            <input type="date" class="form-control" name="date" value="'.$row['care_date'].'" />
                        </div>
                        <div class="col-md-2">
                            <label class="control-label">Time of Issue</label>
                            <input type="time" class="form-control" name="time" value="" />
                        </div>
                        <div class="col-md-2 col-md-offset-1">
                            <label class="control-label">Observed By</label>
                            <input type="text" class="form-control" name="observed_by" value=""  />
                        </div>
                        <div class="col-md-2">
                            <label class="control-label">Reported By</label>
                            <input type="text" class="form-control" name="reported_by" value="" />
                        </div>
                        <div class="col-md-2 col-md-offset-1 '; echo $current_client == 1 ? 'hide':''; echo '">
                            <label class="control-label">CAPA Reference No.</label>
                            <input type="text" class="form-control" name="reference" value="" />
                        </div>
                    </div>
                </div>
            </div>';

            if ($current_client == 1) {
                echo '<div class="portlet box default margin-bottom-15">
                    <div class="portlet-title">
                        <div class="caption">
                            <span class="caption-subject font-dark bold">Program</span>
                        </div>
                    </div>
                    <div class="portlet-body">
                        <div class="mt-checkbox-inline">';

                                $selectProgram = mysqli_query( $conn,"SELECT * FROM tbl_library WHERE type = 1 AND deleted = 0 AND user_id = $user_id" );
                                if ( mysqli_num_rows($selectProgram) > 0 ) {
                                    while ($rowProgram = mysqli_fetch_array($selectProgram)) {
                                        $program_ID = $rowProgram['ID'];
                                        $program_name = $rowProgram['name'];

                                        echo '<label class="mt-checkbox mt-checkbox-outline">
                                            <input type="checkbox" name="program_id[]" value="'.$program_ID.'" > '.$program_name.'
                                            <span></span>
                                        </label>';
                                    }
                                }

                        echo '</div>
                    </div>
                </div>';
            } else {
                echo '<div class="portlet box default margin-bottom-15">
                    <div class="portlet-title">
                        <div class="caption">
                            <span class="caption-subject font-dark bold">Category</span>
                        </div>
                    </div>
                    <div class="portlet-body">
                        <div class="mt-checkbox-inline">';

                            $selectCategory = mysqli_query( $conn,"SELECT * FROM tbl_cam_category WHERE deleted = 0 ORDER BY name" );
                            if ( mysqli_num_rows($selectCategory) > 0 ) {
                                while ($rowCat = mysqli_fetch_array($selectCategory)) {
                                    $cat_ID = $rowCat['ID'];
                                    $cat_name = $rowCat['name'];

                                    echo '<label class="mt-checkbox mt-checkbox-outline">
                                        <input type="checkbox" name="category_id[]" value="'.$cat_ID.'"> '.$cat_name.'
                                        <span></span>
                                    </label>';
                                }
                            }

                            echo '<label class="mt-checkbox mt-checkbox-outline">
                                <input type="checkbox" name="category_id[]" value="0" onClick="btnCategory(this)"> Other
                                <span></span>
                            </label>
                            <input type="text" class="form-control" name="category_other" placeholder="Specify Category" value="" />
                        </div>
                    </div>
                </div>';
            }

            echo '<div class="portlet box default margin-bottom-15">
                <div class="portlet-title">
                    <div class="caption">
                        <span class="caption-subject font-dark bold">Department(s) Involved</span>
                    </div>
                </div>
                <div class="portlet-body">
                    <div class="mt-checkbox-inline">';

                            $selectDepartment = mysqli_query( $conn,"SELECT * FROM tbl_hr_department WHERE status = 1 AND user_id = $user_id ORDER BY title" );
                            if ( mysqli_num_rows($selectDepartment) > 0 ) {
                                while ($rowDept = mysqli_fetch_array($selectDepartment)) {
                                    $dept_ID = $rowDept['ID'];
                                    $dept_title = $rowDept['title'];

                                    echo '<label class="mt-checkbox mt-checkbox-outline">
                                        <input type="checkbox" class="department_id_2" name="department_id[]" onclick="changeDepartment(2, '.$dept_ID.')" /> '.$dept_title.'
                                        <span></span>
                                    </label>';
                                }
                            }

                        echo '<label class="mt-checkbox mt-checkbox-outline hide">
                            <input type="checkbox" name="department_id[]" value="0"> Other
                            <span></span>
                        </label>
                        <input type="text" class="form-control hide" name="department_other" placeholder="Specify Department" value="" />
                    </div>
                </div>
            </div>

            <div class="portlet box default margin-bottom-15">
                <div class="portlet-title">
                    <div class="caption">
                        <span class="caption-subject font-dark bold">Involved Personnel</span>
                    </div>
                </div>
                <div class="portlet-body">
                    <select class="form-control mt-multiselect employee_id_2" data-placeholder="Select Personnel" name="employee_id[]" multiple="multiple"></select>
                </div>
            </div>

            <div class="portlet box default margin-bottom-15">
                <div class="portlet-title">
                    <div class="caption">
                        <span class="caption-subject font-dark bold">Description of Issue</span>
                    </div>
                </div>
                <div class="portlet-body">
                    <textarea class="form-control" rows="3" name="description">'.$row['nature_complaint'].'</textarea>
                </div>
            </div>

            <div class="portlet box default margin-bottom-15 hide '; echo $_COOKIE['client'] == 0 ? '':'hide'; echo '">
                <div class="portlet-title">
                    <div class="caption">
                        <span class="caption-subject font-dark bold">Trend Category</span>
                    </div>
                </div>
                <div class="portlet-body">
                    <div class="mt-repeater mt-repeater-trend">
                        <div data-repeater-list="trend">';

                            
                        echo '</div>
                        <a href="javascript:;" data-repeater-create class="btn btn-success mt-repeater-add"><i class="fa fa-plus"></i> Add more</a>
                    </div>
                </div>
            </div>

            <div class="portlet box default margin-bottom-15">
                <div class="portlet-title">
                    <div class="caption">
                        <span class="caption-subject font-dark bold">Observation'; echo $current_client == 1 ? '(s)':' / Issue(s)'; echo '</span>
                    </div>
                </div>
                <div class="portlet-body">
                    <div class="row">
                        <div class="col-md-7">
                            <textarea class="form-control" rows="10" name="observation_desc"></textarea>
                        </div>
                        <div class="col-md-5">
                            <label>Supporting Documents / Evidence:</label>
                            <div class="mt-repeater mt-repeater-observation">
                                <div data-repeater-list="observation">';

                                    echo '<div class="mt-repeater-item row" data-repeater-item>
                                        <div class="col-xs-10">
                                            <input type="hidden" name="observation_file_temp" value="" />
                                            <input class="form-control" type="file" name="observation_file" />
                                        </div>
                                        <div class="col-xs-2">
                                            <a href="javascript:;" data-repeater-delete class="btn btn-danger"><i class="fa fa-close"></i></a>
                                        </div>
                                    </div>';
                                    
                                echo '</div>
                                <a href="javascript:;" data-repeater-create class="btn btn-success mt-repeater-add"><i class="fa fa-plus"></i> Add more</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="portlet box default margin-bottom-15">
                <div class="portlet-title">
                    <div class="caption">
                        <span class="caption-subject font-dark bold">Root Cause(s)</span>
                    </div>
                </div>
                <div class="portlet-body">
                    <div class="row">
                        <div class="col-md-7">
                            <textarea class="form-control" rows="10" name="root_cause_desc"></textarea>
                        </div>
                        <div class="col-md-5">
                            <label>Supporting Documents / Evidence:</label>
                            <div class="mt-repeater mt-repeater-root_cause">
                                <div data-repeater-list="root_cause">';

                                    echo '<div class="mt-repeater-item row" data-repeater-item>
                                        <div class="col-xs-10">
                                            <input type="hidden" name="root_cause_file_temp" value="" />
                                            <input class="form-control" type="file" name="root_cause_file" />
                                        </div>
                                        <div class="col-xs-2">
                                            <a href="javascript:;" data-repeater-delete class="btn btn-danger"><i class="fa fa-close"></i></a>
                                        </div>
                                    </div>';
                                    
                                echo '</div>
                                <a href="javascript:;" data-repeater-create class="btn btn-success mt-repeater-add"><i class="fa fa-plus"></i> Add more</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="portlet box default margin-bottom-15">
                <div class="portlet-title">
                    <div class="caption">
                        <span class="caption-subject font-dark bold">Corrective Action(s)</span>
                    </div>
                </div>
                <div class="portlet-body">
                    <div class="row">
                        <div class="col-md-7">
                            <select class="form-control margin-bottom-15 '; echo $current_client == 1 ? 'hide':''; echo '" name="corrective_status">
                                <option value="0">--Select Status--</option>
                                <option value="1">Proposed</option>
                                <option value="2">Implemented</option>
                            </select>
                            <textarea class="form-control margin-bottom-15" rows="10" name="corrective_desc">'.$row['action_taken'].'</textarea>
                            <div class="row">
                                <div class="col-md-4">
                                    <input type="date" class="form-control margin-bottom-15" name="corrective_date" placeholder="Date" value="'.$row['date_resolution'].'" />
                                </div>
                                <div class="col-md-4">
                                    <input type="time" class="form-control margin-bottom-15" name="corrective_time" placeholder="Time" value="" />
                                </div>
                                <div class="col-md-4">
                                    <input type="text" class="form-control margin-bottom-15" name="corrective_by" placeholder="Corrected By" value="" />
                                </div>
                            </div>
                        </div>
                        <div class="col-md-5">
                            <label>Supporting Documents / Evidence:</label>
                            <div class="mt-repeater mt-repeater-corrective">
                                <div data-repeater-list="corrective">';

                                    echo '<div class="mt-repeater-item row" data-repeater-item>
                                        <div class="col-xs-10">
                                            <input type="hidden" name="corrective_file_temp" value="" />
                                            <input class="form-control" type="file" name="corrective_file" />
                                        </div>
                                        <div class="col-xs-2">
                                            <a href="javascript:;" data-repeater-delete class="btn btn-danger"><i class="fa fa-close"></i></a>
                                        </div>
                                    </div>';
                                    
                                echo '</div>
                                <a href="javascript:;" data-repeater-create class="btn btn-success mt-repeater-add"><i class="fa fa-plus"></i> Add more</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="portlet box default margin-bottom-15">
                <div class="portlet-title">
                    <div class="caption">
                        <span class="caption-subject font-dark bold">Implementation(s)</span>
                    </div>
                </div>
                <div class="portlet-body">
                    <div class="row">
                        <div class="col-md-7">
                            <select class="form-control margin-bottom-15" name="implementation_status">
                                <option value="0">--Select Status--</option>
                                <option value="1">Proposed</option>
                                <option value="2">Implemented</option>
                            </select>
                            <textarea class="form-control margin-bottom-15" rows="10" name="implementation_desc"></textarea>
                            <div class="row form-horizontal">
                                <div class="col-md-4">
                                    <label class="control-label">Effective Date of Resolution</label>
                                </div>
                                <div class="col-md-4">
                                    <input type="date" class="form-control margin-bottom-15" name="implementation_date" placeholder="Date" value=""/>
                                </div>
                                <div class="col-md-4">
                                    <input type="text" class="form-control margin-bottom-15" name="implementation_by" placeholder="Implemented By" value="" />
                                </div>
                            </div>
                        </div>
                        <div class="col-md-5">
                            <label>Supporting Documents / Evidence:</label>
                            <div class="mt-repeater mt-repeater-implementation">
                                <div data-repeater-list="implementation">';

                                    echo '<div class="mt-repeater-item row" data-repeater-item>
                                        <div class="col-xs-10">
                                            <input type="hidden" name="implementation_file_temp" value="" />
                                            <input class="form-control" type="file" name="implementation_file" />
                                        </div>
                                        <div class="col-xs-2">
                                            <a href="javascript:;" data-repeater-delete class="btn btn-danger"><i class="fa fa-close"></i></a>
                                        </div>
                                    </div>';
                                    
                                echo '</div>
                                <a href="javascript:;" data-repeater-create class="btn btn-success mt-repeater-add"><i class="fa fa-plus"></i> Add more</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="portlet box default margin-bottom-15">
                <div class="portlet-title">
                    <div class="caption">
                        <span class="caption-subject font-dark bold">Preventive Action(s)</span>
                    </div>
                </div>
                <div class="portlet-body">
                    <div class="row">
                        <div class="col-md-7">
                            <select class="form-control margin-bottom-15" name="preventive_status">
                                <option value="0">--Select Status--</option>
                                <option value="1">Proposed</option>
                                <option value="2">Implemented</option>
                            </select>
                            <textarea class="form-control margin-bottom-15" rows="10" name="preventive_desc"></textarea>
                        </div>
                        <div class="col-md-5">
                            <label>Supporting Documents / Evidence:</label>
                            <div class="mt-repeater mt-repeater-preventive">
                                <div data-repeater-list="preventive">';

                                    echo '<div class="mt-repeater-item row" data-repeater-item>
                                        <div class="col-xs-10">
                                            <input type="hidden" name="preventive_file_temp" value="" />
                                            <input class="form-control" type="file" name="preventive_file" />
                                        </div>
                                        <div class="col-xs-2">
                                            <a href="javascript:;" data-repeater-delete class="btn btn-danger"><i class="fa fa-close"></i></a>
                                        </div>
                                    </div>';
                                    
                                echo '</div>
                                <a href="javascript:;" data-repeater-create class="btn btn-success mt-repeater-add"><i class="fa fa-plus"></i> Add more</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="portlet box default margin-bottom-15">
                <div class="portlet-title">
                    <div class="caption">
                        <span class="caption-subject font-dark bold">Evaluation(s) and Follow Up(s)</span>
                    </div>
                </div>
                <div class="portlet-body">
                    <div class="row">
                        <div class="col-md-7">
                            <select class="form-control margin-bottom-15" name="evaluation_status">
                                <option value="0">--Select Status--</option>
                                <option value="1">Proposed</option>
                                <option value="2">Implemented</option>
                            </select>
                            <textarea class="form-control margin-bottom-15" rows="10" name="evaluation_desc"></textarea>
                        </div>
                        <div class="col-md-5">
                            <label>Supporting Documents / Evidence:</label>
                            <div class="mt-repeater mt-repeater-evaluation">
                                <div data-repeater-list="evaluation">';

                                    echo '<div class="mt-repeater-item row" data-repeater-item>
                                        <div class="col-xs-10">
                                            <input type="hidden" name="evaluation_file_temp" value="" />
                                            <input class="form-control" type="file" name="evaluation_file" />
                                        </div>
                                        <div class="col-xs-2">
                                            <a href="javascript:;" data-repeater-delete class="btn btn-danger"><i class="fa fa-close"></i></a>
                                        </div>
                                    </div>';
                                    
                                echo '</div>
                                <a href="javascript:;" data-repeater-create class="btn btn-success mt-repeater-add"><i class="fa fa-plus"></i> Add more</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="portlet box default margin-bottom-15">
                <div class="portlet-title">
                    <div class="caption">
                        <span class="caption-subject font-dark bold">Comments</span>
                    </div>
                </div>
                <div class="portlet-body">
                    <div class="row">
                        <div class="col-md-7">
                            <textarea class="form-control margin-bottom-15" rows="10" name="comment_desc"></textarea>
                        </div>
                        <div class="col-md-5">
                            <label>Supporting Documents / Evidence:</label>
                            <div class="mt-repeater mt-repeater-comment">
                                <div data-repeater-list="comment">';

                                    echo '<div class="mt-repeater-item row" data-repeater-item>
                                        <div class="col-xs-10">
                                            <input type="hidden" name="comment_file_temp" value="" />
                                            <input class="form-control" type="file" name="comment_file" />
                                        </div>
                                        <div class="col-xs-2">
                                            <a href="javascript:;" data-repeater-delete class="btn btn-danger"><i class="fa fa-close"></i></a>
                                        </div>
                                    </div>';
                                    
                                echo '</div>
                                <a href="javascript:;" data-repeater-create class="btn btn-success mt-repeater-add"><i class="fa fa-plus"></i> Add more</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="portlet box default margin-bottom-15">
                <div class="portlet-title">
                    <div class="caption">
                        <span class="caption-subject font-dark bold">Applicable Trainings</span>
                    </div>
                </div>
                <div class="portlet-body">
                    <div class="row">
                        <div class="col-md-7">';

                            // if ($current_client == 1) {
                                echo '<label>Training(s):</label>
                                <select class="form-control mt-multiselect training_desc_2" data-placeholder="Please Select" name="training_desc[]" multiple="multiple"></select>';
                            // } else {
                            //  echo '<textarea class="form-control" rows="10" name="training_desc">'.$row['training'].'</textarea>';
                            // }

                            echo '<div class="row margin-top-15">
                                <div class="col-md-6">
                                    <input type="time" class="form-control margin-bottom-15" name="training_date" placeholder="Date" value="" />
                                </div>
                            </div>
                        </div>
                        <div class="col-md-5">
                            <label>Supporting Documents / Evidence:</label>
                            <div class="mt-repeater mt-repeater-training">
                                <div data-repeater-list="training">';

                                    echo '<div class="mt-repeater-item row" data-repeater-item>
                                        <div class="col-xs-10">
                                            <input type="hidden" name="training_file_temp" value="" />
                                            <input class="form-control" type="file" name="training_file" />
                                        </div>
                                        <div class="col-xs-2">
                                            <a href="javascript:;" data-repeater-delete class="btn btn-danger"><i class="fa fa-close"></i></a>
                                        </div>
                                    </div>';
                                    
                                echo '</div>
                                <a href="javascript:;" data-repeater-create class="btn btn-success mt-repeater-add"><i class="fa fa-plus"></i> Add more</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="portlet box default margin-bottom-15">
                <div class="portlet-body">
                    <div class="row">
                        <div class="col-md-3">
                            <input type="text" class="form-control margin-bottom-15" name="investigated_by" placeholder="Investigated By" value="" />
                        </div>
                        <div class="col-md-3">
                            <input type="text" class="form-control margin-bottom-15" name="investigated_title" placeholder="Title" value="" />
                        </div>
                        <div class="col-md-3">
                            <input type="date" class="form-control margin-bottom-15" name="investigated_date" placeholder="text" value="" />
                        </div>
                        <div class="col-md-3">
                            <input type="time" class="form-control margin-bottom-15" name="investigated_time" placeholder="text" value="" />
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-3">
                            <input type="text" class="form-control margin-bottom-15" name="verified_by" placeholder="CAPA Verified By" value="" />
                        </div>
                        <div class="col-md-3">
                            <input type="text" class="form-control margin-bottom-15" name="verified_title" placeholder="Title" value="" />
                        </div>
                        <div class="col-md-3">
                            <input type="date" class="form-control margin-bottom-15" name="verified_date" placeholder="text" value="" />
                        </div>
                        <div class="col-md-3">
                            <input type="time" class="form-control margin-bottom-15" name="verified_time" placeholder="text" value="" />
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-3">
                            <input type="text" class="form-control margin-bottom-15" name="completed_by" placeholder="CAPA Completed By" value="" />
                        </div>
                        <div class="col-md-3">
                            <input type="text" class="form-control margin-bottom-15" name="completed_title" placeholder="Title" value="" />
                        </div>
                        <div class="col-md-3">
                            <input type="date" class="form-control margin-bottom-15" name="completed_date" placeholder="text" value="" />
                        </div>
                        <div class="col-md-3">
                            <input type="time" class="form-control margin-bottom-15" name="completed_time" placeholder="text" value="" />
                        </div>
                    </div>
                </div>
            </div>';
        }
    }
    if( isset($_GET['modalView_CAM']) ) {
        $ID = $_GET['modalView_CAM'];

        $current_client = 0;
        if (isset($_COOKIE['client'])) { $current_client = $_COOKIE['client']; }

        if (!empty($_COOKIE['switchAccount'])) {
            $portal_user = $_COOKIE['ID'];
            $user_id = $_COOKIE['switchAccount'];
        }
        else {
            $portal_user = $_COOKIE['ID'];
            $user_id = employerID($portal_user);
        }

        $selectData = mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE ID = $ID" );
        if ( mysqli_num_rows($selectData) > 0 ) {
            $row = mysqli_fetch_array($selectData);

            echo '<input class="form-control" type="hidden" name="ID" value="'.$ID.'" />
            <div class="portlet box default margin-bottom-15">
                <div class="portlet-body">
                    <div class="row form-horizontal">
                        <div class="col-md-4">
                            <label class="control-label">Is this a Product related  issue?</label>
                        </div>
                        <div class="col-md-2">
                            <select class="form-control margin-bottom-15" name="product_related" disabled>
                                <option value="0"'; echo $row['product_related'] == 0 ? 'SELECTED':''; echo '>No</option>
                                <option value="1"'; echo $row['product_related'] == 0 ? 'SELECTED':''; echo '>Yes</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-2">
                            <label class="control-label">Date of Issue</label>
                            <input type="date" class="form-control" name="date" value="'.$row['date'].'" disabled />
                        </div>
                        <div class="col-md-2">
                            <label class="control-label">Time of Issue</label>
                            <input type="time" class="form-control" name="time" value="'.$row['time'].'" disabled />
                        </div>
                        <div class="col-md-2 col-md-offset-1">
                            <label class="control-label">Observed By</label>
                            <input type="text" class="form-control" name="observed_by" value="'.$row['observed_by'].'" disabled />
                        </div>
                        <div class="col-md-2">
                            <label class="control-label">Reported By</label>
                            <input type="text" class="form-control" name="reported_by" value="'.$row['reported_by'].'" disabled />
                        </div>
                        <div class="col-md-2 col-md-offset-1 '; echo $current_client == 1 ? 'hide':''; echo '">
                            <label class="control-label">CAPA Reference No.</label>
                            <input type="text" class="form-control" name="reference" value="'.$row['reference'].'" disabled />
                        </div>
                    </div>
                </div>
            </div>';

            if ($current_client == 1) {
                echo '<div class="portlet box default margin-bottom-15">
                    <div class="portlet-title">
                        <div class="caption">
                            <span class="caption-subject font-dark bold">Program</span>
                        </div>
                    </div>
                    <div class="portlet-body">
                        <div class="mt-checkbox-inline">';

                            $selectProgram = mysqli_query( $conn,"SELECT * FROM tbl_library WHERE type = 1 AND deleted = 0 AND user_id = $user_id" );
                            if ( mysqli_num_rows($selectProgram) > 0 ) {
                                while ($rowProgram = mysqli_fetch_array($selectProgram)) {
                                    $program_ID = $rowProgram['ID'];
                                    $program_name = $rowProgram['name'];

                                    $arr_program_ID =  array();
                                    if (!empty($row['program_id'])) {
                                        $arr_program_ID =  explode(', ', $row['program_id']);
                                    }

                                    echo '<label class="mt-checkbox mt-checkbox-outline">
                                        <input type="checkbox" name="program_id[]" value="'.$program_ID.'" '; echo in_array($program_ID, $arr_program_ID) ? 'checked':''; echo ' disabled> '.$program_name.'
                                        <span></span>
                                    </label>';
                                }
                            }

                        echo '</div>
                    </div>
                </div>';
            } else {
                echo '<div class="portlet box default margin-bottom-15">
                    <div class="portlet-title">
                        <div class="caption">
                            <span class="caption-subject font-dark bold">Category</span>
                        </div>
                    </div>
                    <div class="portlet-body">
                        <div class="mt-checkbox-inline">';

                            $selectCategory = mysqli_query( $conn,"SELECT * FROM tbl_cam_category WHERE deleted = 0 ORDER BY name" );
                            if ( mysqli_num_rows($selectCategory) > 0 ) {
                                while ($rowCat = mysqli_fetch_array($selectCategory)) {
                                    $cat_ID = $rowCat['ID'];
                                    $cat_name = $rowCat['name'];
                                    $arr_category_id =  explode(', ', $row['category_id']);

                                    echo '<label class="mt-checkbox mt-checkbox-outline">
                                        <input type="checkbox" name="category_id[]" value="'.$cat_ID.'" '; echo in_array($cat_ID, $arr_category_id) ? 'checked':''; echo ' disabled /> '.$cat_name.'
                                        <span></span>
                                    </label>';
                                }
                            }

                            echo '<label class="mt-checkbox mt-checkbox-outline">
                                <input type="checkbox" name="category_id[]" value="0" '; echo !empty($row['category_other']) ? 'checked':''; echo ' onClick="btnCategory(this)" disabled /> Other
                                <span></span>
                            </label>
                            <input type="text" class="form-control '; echo !empty($row['category_other']) ? '':'hide'; echo '" name="category_other" placeholder="Specify Category" value="'.$row['category_other'].'" disabled />
                        </div>
                    </div>
                </div>';
            }
            
            echo '<div class="portlet box default margin-bottom-15">
                <div class="portlet-title">
                    <div class="caption">
                        <span class="caption-subject font-dark bold">Department(s) Involved</span>
                    </div>
                </div>
                <div class="portlet-body">
                    <div class="mt-checkbox-inline">';

                        // $selectDepartment = mysqli_query( $conn,"SELECT * FROM tbl_cam_department WHERE deleted = 0 ORDER BY name" );
                        // if ( mysqli_num_rows($selectDepartment) > 0 ) {
                        //     while ($rowDept = mysqli_fetch_array($selectDepartment)) {
                        //         $dept_ID = $rowDept['ID'];
                        //         $dept_name = $rowDept['name'];
                        //         $arr_department_id =  explode(', ', $row['department_id']);

                        //         echo '<label class="mt-checkbox mt-checkbox-outline">
                        //             <input type="checkbox" name="department_id[]" value="'.$dept_ID.'" '; echo in_array($dept_ID, $arr_department_id) ? 'checked':''; echo ' disabled> '.$dept_name.'
                        //             <span></span>
                        //         </label>';
                        //     }
                        // }

                        $selectDepartment = mysqli_query( $conn,"SELECT * FROM tbl_hr_department WHERE status = 1 AND user_id = $user_id ORDER BY title" );
                        if ( mysqli_num_rows($selectDepartment) > 0 ) {
                            while ($rowDept = mysqli_fetch_array($selectDepartment)) {
                                $dept_ID = $rowDept['ID'];
                                $dept_title = $rowDept['title'];
                                $arr_department_id =  explode(', ', $row['department_id']);

                                echo '<label class="mt-checkbox mt-checkbox-outline">
                                    <input type="checkbox" class="department_id_3" name="department_id[]" value="'.$dept_ID.'" '; echo in_array($dept_ID, $arr_department_id) ? 'checked':''; echo ' onclick="changeDepartment(3)" disabled /> '.$dept_title.'
                                    <span></span>
                                </label>';
                            }
                        }

                        echo '<label class="mt-checkbox mt-checkbox-outline hide">
                            <input type="checkbox" name="department_id[]" value="0" disabled> Other
                            <span></span>
                        </label>
                        <input type="text" class="form-control hide" name="department_other" placeholder="Specify Department" value="'.$row['department_other'].'" disabled />
                    </div>
                </div>
            </div>

            <div class="portlet box default margin-bottom-15">
                <div class="portlet-title">
                    <div class="caption">
                        <span class="caption-subject font-dark bold">Involved Personnel</span>
                    </div>
                </div>
                <div class="portlet-body">
                    <select class="form-control mt-multiselect employee_id_3" data-placeholder="Select Personnel" name="employee_id[]" multiple="multiple" disabled></select>
                </div>
            </div>

            <div class="portlet box default margin-bottom-15">
                <div class="portlet-title">
                    <div class="caption">
                        <span class="caption-subject font-dark bold">Description of Issue</span>
                    </div>
                </div>
                <div class="portlet-body">
                    <textarea class="form-control" rows="3" name="description" disabled>'.$row['description'].'</textarea>
                </div>
            </div>

            <div class="portlet box default margin-bottom-15 hide '; echo $_COOKIE['client'] == 0 ? '':'hide'; echo '">
                <div class="portlet-title">
                    <div class="caption">
                        <span class="caption-subject font-dark bold">Trend Category</span>
                    </div>
                </div>
                <div class="portlet-body">
                    <div class="mt-repeater mt-repeater-trend">
                        <div data-repeater-list="trend">';

                            if (!empty($row['trend'])) {
                                $array_trend = explode(' | ', $row['trend']);
                                foreach($array_trend as $value) {
                                    if (!empty($value)) {
                                        echo '<div class="mt-repeater-item row" data-repeater-item>
                                            <div class="col-xs-12">
                                                <input class="form-control" type="text" name="trend_desc" value="'.$value.'" disabled />
                                            </div>
                                        </div>';
                                    }
                                }
                            }
                            
                        echo '</div>
                    </div>
                </div>
            </div>

            <div class="portlet box default margin-bottom-15">
                <div class="portlet-title">
                    <div class="caption">
                        <span class="caption-subject font-dark bold">Observation'; echo $current_client == 1 ? '(s)':' / Issue(s)'; echo '</span>
                    </div>
                </div>
                <div class="portlet-body">
                    <div class="row">
                        <div class="col-md-7">
                            <textarea class="form-control" rows="10" name="observation_desc" disabled>'.$row['observation'].'</textarea>
                        </div>
                        <div class="col-md-5">
                            <label>Supporting Documents / Evidence:</label>
                            <div class="mt-repeater mt-repeater-observation">
                                <div data-repeater-list="observation">';

                                    if (!empty($row['observation_file'])) {
                                        $array_observation_file = explode(' | ', $row['observation_file']);
                                        foreach($array_observation_file as $value) {
                                            if (!empty($value)) {
                                                $file = $value;
                                                $fileExtension = fileExtension($file);
                                                $src = $fileExtension['src'];
                                                $embed = $fileExtension['embed'];
                                                $type = $fileExtension['type'];
                                                $file_extension = $fileExtension['file_extension'];
                                                $url = $base_url.'uploads/cam/';
                                                $file_src = $src.$url.rawurlencode($file).$embed;

                                                echo '<div class="mt-repeater-item row" data-repeater-item>
                                                    <div class="col-xs-12">
                                                        <p class="'; echo !empty($file) ? '':'hide'; echo '" style="margin: 0;"><a data-src="'.$file_src.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a></p>
                                                    </div>
                                                </div>';
                                            }
                                        }
                                    }
                                    
                                echo '</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="portlet box default margin-bottom-15">
                <div class="portlet-title">
                    <div class="caption">
                        <span class="caption-subject font-dark bold">Root Cause(s)</span>
                    </div>
                </div>
                <div class="portlet-body">
                    <div class="row">
                        <div class="col-md-7">
                            <textarea class="form-control" rows="10" name="root_cause_desc" disabled>'.$row['root_cause'].'</textarea>
                        </div>
                        <div class="col-md-5">
                            <label>Supporting Documents / Evidence:</label>
                            <div class="mt-repeater mt-repeater-root_cause">
                                <div data-repeater-list="root_cause">';

                                    if (!empty($row['root_cause_file'])) {
                                        $array_root_cause_file = explode(' | ', $row['root_cause_file']);
                                        foreach($array_root_cause_file as $value) {
                                            if (!empty($value)) {
                                                $file = $value;
                                                $fileExtension = fileExtension($file);
                                                $src = $fileExtension['src'];
                                                $embed = $fileExtension['embed'];
                                                $type = $fileExtension['type'];
                                                $file_extension = $fileExtension['file_extension'];
                                                $url = $base_url.'uploads/cam/';
                                                $file_src = $src.$url.rawurlencode($file).$embed;

                                                echo '<div class="mt-repeater-item row" data-repeater-item>
                                                    <div class="col-xs-12">
                                                        <p class="'; echo !empty($file) ? '':'hide'; echo '" style="margin: 0;"><a data-src="'.$file_src.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a></p>
                                                    </div>
                                                </div>';
                                            }
                                        }
                                    }
                                    
                                echo '</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="portlet box default margin-bottom-15">
                <div class="portlet-title">
                    <div class="caption">
                        <span class="caption-subject font-dark bold">Corrective Action(s)</span>
                    </div>
                </div>
                <div class="portlet-body">
                    <div class="row">
                        <div class="col-md-7">
                            <select class="form-control margin-bottom-15 '; echo $current_client == 1 ? 'hide':''; echo '" name="corrective_status" disabled>
                                <option value="0" '; echo $row['corrective_status'] == 0 ? 'SELECTED':''; echo '>--Select Status--</option>
                                <option value="1" '; echo $row['corrective_status'] == 1 ? 'SELECTED':''; echo '>Proposed</option>
                                <option value="2" '; echo $row['corrective_status'] == 2 ? 'SELECTED':''; echo '>Implemented</option>
                            </select>
                            <textarea class="form-control margin-bottom-15" rows="10" name="corrective_desc" disabled>'.$row['corrective_desc'].'</textarea>
                            <div class="row">
                                <div class="col-md-4">
                                    <input type="date" class="form-control margin-bottom-15" name="corrective_date" placeholder="Date" value="'.$row['corrective_date'].'" disabled />
                                </div>
                                <div class="col-md-4">
                                    <input type="time" class="form-control margin-bottom-15" name="corrective_time" placeholder="Time" value="'.$row['corrective_time'].'" disabled />
                                </div>
                                <div class="col-md-4">
                                    <input type="text" class="form-control margin-bottom-15" name="corrective_by" placeholder="Corrected By" value="'.$row['corrective_by'].'" disabled />
                                </div>
                            </div>
                        </div>
                        <div class="col-md-5">
                            <label>Supporting Documents / Evidence:</label>
                            <div class="mt-repeater mt-repeater-corrective">
                                <div data-repeater-list="corrective">';

                                    if (!empty($row['corrective_file'])) {
                                        $array_corrective_file = explode(' | ', $row['corrective_file']);
                                        foreach($array_corrective_file as $value) {
                                            if (!empty($value)) {
                                                $file = $value;
                                                $fileExtension = fileExtension($file);
                                                $src = $fileExtension['src'];
                                                $embed = $fileExtension['embed'];
                                                $type = $fileExtension['type'];
                                                $file_extension = $fileExtension['file_extension'];
                                                $url = $base_url.'uploads/cam/';
                                                $file_src = $src.$url.rawurlencode($file).$embed;

                                                echo '<div class="mt-repeater-item row" data-repeater-item>
                                                    <div class="col-xs-12">
                                                        <p class="'; echo !empty($file) ? '':'hide'; echo '" style="margin: 0;"><a data-src="'.$file_src.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a></p>
                                                    </div>
                                                </div>';
                                            }
                                        }
                                    }
                                    
                                echo '</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="portlet box default margin-bottom-15">
                <div class="portlet-title">
                    <div class="caption">
                        <span class="caption-subject font-dark bold">Implementation(s)</span>
                    </div>
                </div>
                <div class="portlet-body">
                    <div class="row">
                        <div class="col-md-7">
                            <select class="form-control margin-bottom-15" name="implementation_status" disabled>
                                <option value="0" '; echo $row['implementation_status'] == 0 ? 'SELECTED':''; echo '>--Select Status--</option>
                                <option value="1" '; echo $row['implementation_status'] == 1 ? 'SELECTED':''; echo '>Proposed</option>
                                <option value="2" '; echo $row['implementation_status'] == 2 ? 'SELECTED':''; echo '>Implemented</option>
                            </select>
                            <textarea class="form-control margin-bottom-15" rows="10" name="implementation_desc" disabled>'.$row['implementation_desc'].'</textarea>
                            <div class="row form-horizontal">
                                <div class="col-md-4">
                                    <label class="control-label">Effective Date of Resolution</label>
                                </div>
                                <div class="col-md-4">
                                    <input type="date" class="form-control margin-bottom-15" name="implementation_date" placeholder="Date" value="'.$row['implementation_date'].'" disabled/>
                                </div>
                                <div class="col-md-4">
                                    <input type="text" class="form-control margin-bottom-15" name="implementation_by" placeholder="Implemented By" value="'.$row['implementation_by'].'" disabled />
                                </div>
                            </div>
                        </div>
                        <div class="col-md-5">
                            <label>Supporting Documents / Evidence:</label>
                            <div class="mt-repeater mt-repeater-implementation">
                                <div data-repeater-list="implementation">';

                                    if (!empty($row['implementation_file'])) {
                                        $array_implementation_file = explode(' | ', $row['implementation_file']);
                                        foreach($array_implementation_file as $value) {
                                            if (!empty($value)) {
                                                $file = $value;
                                                $fileExtension = fileExtension($file);
                                                $src = $fileExtension['src'];
                                                $embed = $fileExtension['embed'];
                                                $type = $fileExtension['type'];
                                                $file_extension = $fileExtension['file_extension'];
                                                $url = $base_url.'uploads/cam/';
                                                $file_src = $src.$url.rawurlencode($file).$embed;

                                                echo '<div class="mt-repeater-item row" data-repeater-item>
                                                    <div class="col-xs-12">
                                                        <p class="'; echo !empty($file) ? '':'hide'; echo '" style="margin: 0;"><a data-src="'.$file_src.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a></p>
                                                    </div>
                                                </div>';
                                            }
                                        }
                                    }
                                    
                                echo '</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="portlet box default margin-bottom-15">
                <div class="portlet-title">
                    <div class="caption">
                        <span class="caption-subject font-dark bold">Preventive Action(s)</span>
                    </div>
                </div>
                <div class="portlet-body">
                    <div class="row">
                        <div class="col-md-7">
                            <select class="form-control margin-bottom-15" name="preventive_status" disabled>
                                <option value="0" '; echo $row['implementation_status'] == 0 ? 'SELECTED':''; echo '>--Select Status--</option>
                                <option value="1" '; echo $row['implementation_status'] == 1 ? 'SELECTED':''; echo '>Proposed</option>
                                <option value="2" '; echo $row['implementation_status'] == 2 ? 'SELECTED':''; echo '>Implemented</option>
                            </select>
                            <textarea class="form-control margin-bottom-15" rows="10" name="preventive_desc" disabled>'.$row['preventive_desc'].'</textarea>
                        </div>
                        <div class="col-md-5">
                            <label>Supporting Documents / Evidence:</label>
                            <div class="mt-repeater mt-repeater-preventive">
                                <div data-repeater-list="preventive">';

                                    if (!empty($row['preventive_file'])) {
                                        $array_preventive_file = explode(' | ', $row['preventive_file']);
                                        foreach($array_preventive_file as $value) {
                                            if (!empty($value)) {
                                                $file = $value;
                                                $fileExtension = fileExtension($file);
                                                $src = $fileExtension['src'];
                                                $embed = $fileExtension['embed'];
                                                $type = $fileExtension['type'];
                                                $file_extension = $fileExtension['file_extension'];
                                                $url = $base_url.'uploads/cam/';
                                                $file_src = $src.$url.rawurlencode($file).$embed;

                                                echo '<div class="mt-repeater-item row" data-repeater-item>
                                                    <div class="col-xs-12">
                                                        <p class="'; echo !empty($file) ? '':'hide'; echo '" style="margin: 0;"><a data-src="'.$file_src.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a></p>
                                                    </div>
                                                </div>';
                                            }
                                        }
                                    }
                                    
                                echo '</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="portlet box default margin-bottom-15">
                <div class="portlet-title">
                    <div class="caption">
                        <span class="caption-subject font-dark bold">Evaluation(s) and Follow Up(s)</span>
                    </div>
                </div>
                <div class="portlet-body">
                    <div class="row">
                        <div class="col-md-7">
                            <select class="form-control margin-bottom-15" name="evaluation_status" disabled>
                                <option value="0" '; echo $row['evaluation_status'] == 0 ? 'SELECTED':''; echo '>--Select Status--</option>
                                <option value="1" '; echo $row['evaluation_status'] == 1 ? 'SELECTED':''; echo '>Proposed</option>
                                <option value="2" '; echo $row['evaluation_status'] == 2 ? 'SELECTED':''; echo '>Implemented</option>
                            </select>
                            <textarea class="form-control margin-bottom-15" rows="10" name="evaluation_desc" disabled>'.$row['evaluation_desc'].'</textarea>
                        </div>
                        <div class="col-md-5">
                            <label>Supporting Documents / Evidence:</label>
                            <div class="mt-repeater mt-repeater-evaluation">
                                <div data-repeater-list="evaluation">';

                                    if (!empty($row['evaluation_file'])) {
                                        $array_evaluation_file = explode(' | ', $row['evaluation_file']);
                                        foreach($array_evaluation_file as $value) {
                                            if (!empty($value)) {
                                                $file = $value;
                                                $fileExtension = fileExtension($file);
                                                $src = $fileExtension['src'];
                                                $embed = $fileExtension['embed'];
                                                $type = $fileExtension['type'];
                                                $file_extension = $fileExtension['file_extension'];
                                                $url = $base_url.'uploads/cam/';
                                                $file_src = $src.$url.rawurlencode($file).$embed;

                                                echo '<div class="mt-repeater-item row" data-repeater-item>
                                                    <div class="col-xs-12">
                                                        <p class="'; echo !empty($file) ? '':'hide'; echo '" style="margin: 0;"><a data-src="'.$file_src.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a></p>
                                                    </div>
                                                </div>';
                                            }
                                        }
                                    }
                                    
                                echo '</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="portlet box default margin-bottom-15">
                <div class="portlet-title">
                    <div class="caption">
                        <span class="caption-subject font-dark bold">Comments</span>
                    </div>
                </div>
                <div class="portlet-body">
                    <div class="row">
                        <div class="col-md-7">
                            <textarea class="form-control margin-bottom-15" rows="10" name="comment_desc" disabled>'.$row['comment'].'</textarea>
                        </div>
                        <div class="col-md-5">
                            <label>Supporting Documents / Evidence:</label>
                            <div class="mt-repeater mt-repeater-comment">
                                <div data-repeater-list="comment">';

                                    if (!empty($row['comment_file'])) {
                                        $array_comment_file = explode(' | ', $row['comment_file']);
                                        foreach($array_comment_file as $value) {
                                            if (!empty($value)) {
                                                $file = $value;
                                                $fileExtension = fileExtension($file);
                                                $src = $fileExtension['src'];
                                                $embed = $fileExtension['embed'];
                                                $type = $fileExtension['type'];
                                                $file_extension = $fileExtension['file_extension'];
                                                $url = $base_url.'uploads/cam/';
                                                $file_src = $src.$url.rawurlencode($file).$embed;

                                                echo '<div class="mt-repeater-item row" data-repeater-item>
                                                    <div class="col-xs-12">
                                                        <p class="'; echo !empty($file) ? '':'hide'; echo '" style="margin: 0;"><a data-src="'.$file_src.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a></p>
                                                    </div>
                                                </div>';
                                            }
                                        }
                                    }
                                    
                                echo '</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="portlet box default margin-bottom-15">
                <div class="portlet-title">
                    <div class="caption">
                        <span class="caption-subject font-dark bold">Applicable Trainings</span>
                    </div>
                </div>
                <div class="portlet-body">
                    <div class="row">
                        <div class="col-md-7">';

                            // if ($current_client == 1) {
                                echo '<label>Training(s):</label>
                                <select class="form-control mt-multiselect training_desc_3" data-placeholder="Please Select" name="training_desc[]" multiple="multiple"></select>';
                            // } else {
                            //     echo '<textarea class="form-control" rows="10" name="training_desc" disabled>'.$row['training'].'</textarea>';
                            // }

                            echo '<div class="row margin-top-15">
                                <div class="col-md-6">
                                    <input type="time" class="form-control margin-bottom-15" name="training_date" placeholder="Date" value="'.$row['training_date'].'" disabled />
                                </div>
                            </div>
                        </div>
                        <div class="col-md-5">
                            <label>Supporting Documents / Evidence:</label>
                            <div class="mt-repeater mt-repeater-training">
                                <div data-repeater-list="training">';

                                    if (!empty($row['training_file'])) {
                                        $array_training_file = explode(' | ', $row['training_file']);
                                        foreach($array_training_file as $value) {
                                            if (!empty($value)) {
                                                $file = $value;
                                                $fileExtension = fileExtension($file);
                                                $src = $fileExtension['src'];
                                                $embed = $fileExtension['embed'];
                                                $type = $fileExtension['type'];
                                                $file_extension = $fileExtension['file_extension'];
                                                $url = $base_url.'uploads/cam/';
                                                $file_src = $src.$url.rawurlencode($file).$embed;

                                                echo '<div class="mt-repeater-item row" data-repeater-item>
                                                    <div class="col-xs-12">
                                                        <p class="'; echo !empty($file) ? '':'hide'; echo '" style="margin: 0;"><a data-src="'.$file_src.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a></p>
                                                    </div>
                                                </div>';
                                            }
                                        }
                                    }
                                    
                                echo '</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="portlet box default margin-bottom-15">
                <div class="portlet-body">
                    <div class="row">
                        <div class="col-md-3">
                            <input type="text" class="form-control margin-bottom-15" name="investigated_by" placeholder="Investigated By" value="'.$row['investigated_by'].'" disabled />
                        </div>
                        <div class="col-md-3">
                            <input type="text" class="form-control margin-bottom-15" name="investigated_title" placeholder="Title" value="'.$row['investigated_title'].'" disabled />
                        </div>
                        <div class="col-md-3">
                            <input type="date" class="form-control margin-bottom-15" name="investigated_date" placeholder="text" value="'.$row['investigated_date'].'" disabled />
                        </div>
                        <div class="col-md-3">
                            <input type="time" class="form-control margin-bottom-15" name="investigated_time" placeholder="text" value="'.$row['investigated_time'].'" disabled />
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-3">
                            <input type="text" class="form-control margin-bottom-15" name="verified_by" placeholder="CAPA Verified By" value="'.$row['verified_by'].'" disabled />
                        </div>
                        <div class="col-md-3">
                            <input type="text" class="form-control margin-bottom-15" name="verified_title" placeholder="Title" value="'.$row['verified_title'].'" disabled />
                        </div>
                        <div class="col-md-3">
                            <input type="date" class="form-control margin-bottom-15" name="verified_date" placeholder="text" value="'.$row['verified_date'].'" disabled />
                        </div>
                        <div class="col-md-3">
                            <input type="time" class="form-control margin-bottom-15" name="verified_time" placeholder="text" value="'.$row['verified_time'].'" disabled />
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-3">
                            <input type="text" class="form-control margin-bottom-15" name="completed_by" placeholder="CAPA Completed By" value="'.$row['completed_by'].'" disabled />
                        </div>
                        <div class="col-md-3">
                            <input type="text" class="form-control margin-bottom-15" name="completed_title" placeholder="Title" value="'.$row['completed_title'].'" disabled />
                        </div>
                        <div class="col-md-3">
                            <input type="date" class="form-control margin-bottom-15" name="completed_date" placeholder="text" value="'.$row['completed_date'].'" disabled />
                        </div>
                        <div class="col-md-3">
                            <input type="time" class="form-control margin-bottom-15" name="completed_time" placeholder="text" value="'.$row['completed_time'].'" disabled />
                        </div>
                    </div>
                </div>
            </div>';
        }
    }
    if( isset($_GET['modalView_CAM2']) ) {
        $ID = $_GET['modalView_CAM2'];

        $current_client = 0;
        if (isset($_COOKIE['client'])) { $current_client = $_COOKIE['client']; }

        if (!empty($_COOKIE['switchAccount'])) {
            $portal_user = $_COOKIE['ID'];
            $user_id = $_COOKIE['switchAccount'];
        }
        else {
            $portal_user = $_COOKIE['ID'];
            $user_id = employerID($portal_user);
        }

        $selectData = mysqli_query( $conn,"SELECT * FROM tbl_complaint_records WHERE care_id = $ID" );
        if ( mysqli_num_rows($selectData) > 0 ) {
            $row = mysqli_fetch_array($selectData);

            echo '<input class="form-control" type="hidden" name="ID" value="'.$ID.'" />
            <div class="portlet box default margin-bottom-15">
                <div class="portlet-body">
                    <div class="row form-horizontal">
                        <div class="col-md-4">
                            <label class="control-label">Is this a Product related  issue?</label>
                        </div>
                        <div class="col-md-2">
                            <select class="form-control margin-bottom-15" name="product_related" disabled>
                                <option value="0"'; echo $row['product_related'] == 0 ? 'SELECTED':''; echo '>No</option>
                                <option value="1"'; echo $row['product_related'] == 0 ? 'SELECTED':''; echo '>Yes</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-2">
                            <label class="control-label">Date of Issue</label>
                            <input type="date" class="form-control" name="date" value="'.date('Y-m-d', strtotime($row['care_date'])).'" disabled />
                        </div>
                        <div class="col-md-2">
                            <label class="control-label">Time of Issue</label>
                            <input type="time" class="form-control" name="time" value="'.$row['time'].'" disabled />
                        </div>
                        <div class="col-md-2 col-md-offset-1">
                            <label class="control-label">Observed By</label>
                            <input type="text" class="form-control" name="observed_by" value="'.$row['observed_by'].'" disabled />
                        </div>
                        <div class="col-md-2">
                            <label class="control-label">Reported By</label>
                            <input type="text" class="form-control" name="reported_by" value="'.$row['reported_by'].'" disabled />
                        </div>
                        <div class="col-md-2 col-md-offset-1 '; echo $current_client == 1 ? 'hide':''; echo '">
                            <label class="control-label">CAPA Reference No.</label>
                            <input type="text" class="form-control" name="reference" value="'.$row['reference'].'" disabled />
                        </div>
                    </div>
                </div>
            </div>';

            if ($current_client == 1) {
                echo '<div class="portlet box default margin-bottom-15">
                    <div class="portlet-title">
                        <div class="caption">
                            <span class="caption-subject font-dark bold">Program</span>
                        </div>
                    </div>
                    <div class="portlet-body">
                        <div class="mt-checkbox-inline">';

                            $selectProgram = mysqli_query( $conn,"SELECT * FROM tbl_library WHERE type = 1 AND deleted = 0 AND user_id = $user_id" );
                            if ( mysqli_num_rows($selectProgram) > 0 ) {
                                while ($rowProgram = mysqli_fetch_array($selectProgram)) {
                                    $program_ID = $rowProgram['ID'];
                                    $program_name = $rowProgram['name'];

                                    $arr_program_ID =  array();
                                    if (!empty($row['program_id'])) {
                                        $arr_program_ID =  explode(', ', $row['program_id']);
                                    }

                                    echo '<label class="mt-checkbox mt-checkbox-outline">
                                        <input type="checkbox" name="program_id[]" value="'.$program_ID.'" '; echo in_array($program_ID, $arr_program_ID) ? 'checked':''; echo ' disabled> '.$program_name.'
                                        <span></span>
                                    </label>';
                                }
                            }

                        echo '</div>
                    </div>
                </div>';
            } else {
                echo '<div class="portlet box default margin-bottom-15">
                    <div class="portlet-title">
                        <div class="caption">
                            <span class="caption-subject font-dark bold">Category</span>
                        </div>
                    </div>
                    <div class="portlet-body">
                        <div class="mt-checkbox-inline">';

                            $selectCategory = mysqli_query( $conn,"SELECT * FROM tbl_cam_category WHERE deleted = 0 ORDER BY name" );
                            if ( mysqli_num_rows($selectCategory) > 0 ) {
                                while ($rowCat = mysqli_fetch_array($selectCategory)) {
                                    $cat_ID = $rowCat['ID'];
                                    $cat_name = $rowCat['name'];
                                    $arr_category_id =  explode(', ', $row['category_id']);

                                    echo '<label class="mt-checkbox mt-checkbox-outline">
                                        <input type="checkbox" name="category_id[]" value="'.$cat_ID.'" '; echo in_array($cat_ID, $arr_category_id) ? 'checked':''; echo ' disabled /> '.$cat_name.'
                                        <span></span>
                                    </label>';
                                }
                            }

                            echo '<label class="mt-checkbox mt-checkbox-outline">
                                <input type="checkbox" name="category_id[]" value="0" '; echo !empty($row['category_other']) ? 'checked':''; echo ' onClick="btnCategory(this)" disabled /> Other
                                <span></span>
                            </label>
                            <input type="text" class="form-control '; echo !empty($row['category_other']) ? '':'hide'; echo '" name="category_other" placeholder="Specify Category" value="'.$row['category_other'].'" disabled />
                        </div>
                    </div>
                </div>';
            }
            
            echo '<div class="portlet box default margin-bottom-15">
                <div class="portlet-title">
                    <div class="caption">
                        <span class="caption-subject font-dark bold">Department(s) Involved</span>
                    </div>
                </div>
                <div class="portlet-body">
                    <div class="mt-checkbox-inline">';

                        // $selectDepartment = mysqli_query( $conn,"SELECT * FROM tbl_cam_department WHERE deleted = 0 ORDER BY name" );
                        // if ( mysqli_num_rows($selectDepartment) > 0 ) {
                        //     while ($rowDept = mysqli_fetch_array($selectDepartment)) {
                        //         $dept_ID = $rowDept['ID'];
                        //         $dept_name = $rowDept['name'];
                        //         $arr_department_id =  explode(', ', $row['department_id']);

                        //         echo '<label class="mt-checkbox mt-checkbox-outline">
                        //             <input type="checkbox" name="department_id[]" value="'.$dept_ID.'" '; echo in_array($dept_ID, $arr_department_id) ? 'checked':''; echo ' disabled> '.$dept_name.'
                        //             <span></span>
                        //         </label>';
                        //     }
                        // }

                        $selectDepartment = mysqli_query( $conn,"SELECT * FROM tbl_hr_department WHERE status = 1 AND user_id = $user_id ORDER BY title" );
                        if ( mysqli_num_rows($selectDepartment) > 0 ) {
                            while ($rowDept = mysqli_fetch_array($selectDepartment)) {
                                $dept_ID = $rowDept['ID'];
                                $dept_title = $rowDept['title'];
                                $arr_department_id =  explode(', ', $row['department_id']);

                                echo '<label class="mt-checkbox mt-checkbox-outline">
                                    <input type="checkbox" class="department_id_3" name="department_id[]" value="'.$dept_ID.'" '; echo in_array($dept_ID, $arr_department_id) ? 'checked':''; echo ' onclick="changeDepartment(3)" disabled /> '.$dept_title.'
                                    <span></span>
                                </label>';
                            }
                        }

                        echo '<label class="mt-checkbox mt-checkbox-outline hide">
                            <input type="checkbox" name="department_id[]" value="0" disabled> Other
                            <span></span>
                        </label>
                        <input type="text" class="form-control hide" name="department_other" placeholder="Specify Department" value="'.$row['department_other'].'" disabled />
                    </div>
                </div>
            </div>

            <div class="portlet box default margin-bottom-15">
                <div class="portlet-title">
                    <div class="caption">
                        <span class="caption-subject font-dark bold">Involved Personnel</span>
                    </div>
                </div>
                <div class="portlet-body">
                    <select class="form-control mt-multiselect employee_id_3" data-placeholder="Select Personnel" name="employee_id[]" multiple="multiple" disabled></select>
                </div>
            </div>

            <div class="portlet box default margin-bottom-15">
                <div class="portlet-title">
                    <div class="caption">
                        <span class="caption-subject font-dark bold">Description of Issue</span>
                    </div>
                </div>
                <div class="portlet-body">
                    <textarea class="form-control" rows="3" name="description" disabled>'.$row['nature_complaint'].'</textarea>
                </div>
            </div>

            <div class="portlet box default margin-bottom-15 hide '; echo $_COOKIE['client'] == 0 ? '':'hide'; echo '">
                <div class="portlet-title">
                    <div class="caption">
                        <span class="caption-subject font-dark bold">Trend Category</span>
                    </div>
                </div>
                <div class="portlet-body">
                    <div class="mt-repeater mt-repeater-trend">
                        <div data-repeater-list="trend">';

                            if (!empty($row['trend'])) {
                                $array_trend = explode(' | ', $row['trend']);
                                foreach($array_trend as $value) {
                                    if (!empty($value)) {
                                        echo '<div class="mt-repeater-item row" data-repeater-item>
                                            <div class="col-xs-12">
                                                <input class="form-control" type="text" name="trend_desc" value="'.$value.'" disabled />
                                            </div>
                                        </div>';
                                    }
                                }
                            }
                            
                        echo '</div>
                    </div>
                </div>
            </div>

            <div class="portlet box default margin-bottom-15">
                <div class="portlet-title">
                    <div class="caption">
                        <span class="caption-subject font-dark bold">Observation'; echo $current_client == 1 ? '(s)':' / Issue(s)'; echo '</span>
                    </div>
                </div>
                <div class="portlet-body">
                    <div class="row">
                        <div class="col-md-7">
                            <textarea class="form-control" rows="10" name="observation_desc" disabled>'.$row['observation'].'</textarea>
                        </div>
                        <div class="col-md-5">
                            <label>Supporting Documents / Evidence:</label>
                            <div class="mt-repeater mt-repeater-observation">
                                <div data-repeater-list="observation">';

                                    if (!empty($row['observation_file'])) {
                                        $array_observation_file = explode(' | ', $row['observation_file']);
                                        foreach($array_observation_file as $value) {
                                            if (!empty($value)) {
                                                $file = $value;
                                                $fileExtension = fileExtension($file);
                                                $src = $fileExtension['src'];
                                                $embed = $fileExtension['embed'];
                                                $type = $fileExtension['type'];
                                                $file_extension = $fileExtension['file_extension'];
                                                $url = $base_url.'uploads/cam/';
                                                $file_src = $src.$url.rawurlencode($file).$embed;

                                                echo '<div class="mt-repeater-item row" data-repeater-item>
                                                    <div class="col-xs-12">
                                                        <p class="'; echo !empty($file) ? '':'hide'; echo '" style="margin: 0;"><a data-src="'.$file_src.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a></p>
                                                    </div>
                                                </div>';
                                            }
                                        }
                                    }
                                    
                                echo '</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="portlet box default margin-bottom-15">
                <div class="portlet-title">
                    <div class="caption">
                        <span class="caption-subject font-dark bold">Root Cause(s)</span>
                    </div>
                </div>
                <div class="portlet-body">
                    <div class="row">
                        <div class="col-md-7">
                            <textarea class="form-control" rows="10" name="root_cause_desc" disabled>'.$row['root_cause'].'</textarea>
                        </div>
                        <div class="col-md-5">
                            <label>Supporting Documents / Evidence:</label>
                            <div class="mt-repeater mt-repeater-root_cause">
                                <div data-repeater-list="root_cause">';

                                    if (!empty($row['root_cause_file'])) {
                                        $array_root_cause_file = explode(' | ', $row['root_cause_file']);
                                        foreach($array_root_cause_file as $value) {
                                            if (!empty($value)) {
                                                $file = $value;
                                                $fileExtension = fileExtension($file);
                                                $src = $fileExtension['src'];
                                                $embed = $fileExtension['embed'];
                                                $type = $fileExtension['type'];
                                                $file_extension = $fileExtension['file_extension'];
                                                $url = $base_url.'uploads/cam/';
                                                $file_src = $src.$url.rawurlencode($file).$embed;

                                                echo '<div class="mt-repeater-item row" data-repeater-item>
                                                    <div class="col-xs-12">
                                                        <p class="'; echo !empty($file) ? '':'hide'; echo '" style="margin: 0;"><a data-src="'.$file_src.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a></p>
                                                    </div>
                                                </div>';
                                            }
                                        }
                                    }
                                    
                                echo '</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="portlet box default margin-bottom-15">
                <div class="portlet-title">
                    <div class="caption">
                        <span class="caption-subject font-dark bold">Corrective Action(s)</span>
                    </div>
                </div>
                <div class="portlet-body">
                    <div class="row">
                        <div class="col-md-7">
                            <select class="form-control margin-bottom-15 '; echo $current_client == 1 ? 'hide':''; echo '" name="corrective_status" disabled>
                                <option value="0" '; echo $row['corrective_status'] == 0 ? 'SELECTED':''; echo '>--Select Status--</option>
                                <option value="1" '; echo $row['corrective_status'] == 1 ? 'SELECTED':''; echo '>Proposed</option>
                                <option value="2" '; echo $row['corrective_status'] == 2 ? 'SELECTED':''; echo '>Implemented</option>
                            </select>
                            <textarea class="form-control margin-bottom-15" rows="10" name="corrective_desc" disabled>'.$row['action_taken'].'</textarea>
                            <div class="row">
                                <div class="col-md-4">
                                    <input type="date" class="form-control margin-bottom-15" name="corrective_date" placeholder="Date" value="'.date('Y-m-d', strtotime($row['date_resolution'])).'" disabled />
                                </div>
                                <div class="col-md-4">
                                    <input type="time" class="form-control margin-bottom-15" name="corrective_time" placeholder="Time" value="'.$row['corrective_time'].'" disabled />
                                </div>
                                <div class="col-md-4">
                                    <input type="text" class="form-control margin-bottom-15" name="corrective_by" placeholder="Corrected By" value="'.$row['corrective_by'].'" disabled />
                                </div>
                            </div>
                        </div>
                        <div class="col-md-5">
                            <label>Supporting Documents / Evidence:</label>
                            <div class="mt-repeater mt-repeater-corrective">
                                <div data-repeater-list="corrective">';

                                    if (!empty($row['corrective_file'])) {
                                        $array_corrective_file = explode(' | ', $row['corrective_file']);
                                        foreach($array_corrective_file as $value) {
                                            if (!empty($value)) {
                                                $file = $value;
                                                $fileExtension = fileExtension($file);
                                                $src = $fileExtension['src'];
                                                $embed = $fileExtension['embed'];
                                                $type = $fileExtension['type'];
                                                $file_extension = $fileExtension['file_extension'];
                                                $url = $base_url.'uploads/cam/';
                                                $file_src = $src.$url.rawurlencode($file).$embed;

                                                echo '<div class="mt-repeater-item row" data-repeater-item>
                                                    <div class="col-xs-12">
                                                        <p class="'; echo !empty($file) ? '':'hide'; echo '" style="margin: 0;"><a data-src="'.$file_src.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a></p>
                                                    </div>
                                                </div>';
                                            }
                                        }
                                    }
                                    
                                echo '</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="portlet box default margin-bottom-15">
                <div class="portlet-title">
                    <div class="caption">
                        <span class="caption-subject font-dark bold">Implementation(s)</span>
                    </div>
                </div>
                <div class="portlet-body">
                    <div class="row">
                        <div class="col-md-7">
                            <select class="form-control margin-bottom-15" name="implementation_status" disabled>
                                <option value="0" '; echo $row['implementation_status'] == 0 ? 'SELECTED':''; echo '>--Select Status--</option>
                                <option value="1" '; echo $row['implementation_status'] == 1 ? 'SELECTED':''; echo '>Proposed</option>
                                <option value="2" '; echo $row['implementation_status'] == 2 ? 'SELECTED':''; echo '>Implemented</option>
                            </select>
                            <textarea class="form-control margin-bottom-15" rows="10" name="implementation_desc" disabled>'.$row['implementation_desc'].'</textarea>
                            <div class="row form-horizontal">
                                <div class="col-md-4">
                                    <label class="control-label">Effective Date of Resolution</label>
                                </div>
                                <div class="col-md-4">
                                    <input type="date" class="form-control margin-bottom-15" name="implementation_date" placeholder="Date" value="'.$row['implementation_date'].'" disabled/>
                                </div>
                                <div class="col-md-4">
                                    <input type="text" class="form-control margin-bottom-15" name="implementation_by" placeholder="Implemented By" value="'.$row['implementation_by'].'" disabled />
                                </div>
                            </div>
                        </div>
                        <div class="col-md-5">
                            <label>Supporting Documents / Evidence:</label>
                            <div class="mt-repeater mt-repeater-implementation">
                                <div data-repeater-list="implementation">';

                                    if (!empty($row['implementation_file'])) {
                                        $array_implementation_file = explode(' | ', $row['implementation_file']);
                                        foreach($array_implementation_file as $value) {
                                            if (!empty($value)) {
                                                $file = $value;
                                                $fileExtension = fileExtension($file);
                                                $src = $fileExtension['src'];
                                                $embed = $fileExtension['embed'];
                                                $type = $fileExtension['type'];
                                                $file_extension = $fileExtension['file_extension'];
                                                $url = $base_url.'uploads/cam/';
                                                $file_src = $src.$url.rawurlencode($file).$embed;

                                                echo '<div class="mt-repeater-item row" data-repeater-item>
                                                    <div class="col-xs-12">
                                                        <p class="'; echo !empty($file) ? '':'hide'; echo '" style="margin: 0;"><a data-src="'.$file_src.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a></p>
                                                    </div>
                                                </div>';
                                            }
                                        }
                                    }
                                    
                                echo '</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="portlet box default margin-bottom-15">
                <div class="portlet-title">
                    <div class="caption">
                        <span class="caption-subject font-dark bold">Preventive Action(s)</span>
                    </div>
                </div>
                <div class="portlet-body">
                    <div class="row">
                        <div class="col-md-7">
                            <select class="form-control margin-bottom-15" name="preventive_status" disabled>
                                <option value="0" '; echo $row['implementation_status'] == 0 ? 'SELECTED':''; echo '>--Select Status--</option>
                                <option value="1" '; echo $row['implementation_status'] == 1 ? 'SELECTED':''; echo '>Proposed</option>
                                <option value="2" '; echo $row['implementation_status'] == 2 ? 'SELECTED':''; echo '>Implemented</option>
                            </select>
                            <textarea class="form-control margin-bottom-15" rows="10" name="preventive_desc" disabled>'.$row['preventive_desc'].'</textarea>
                        </div>
                        <div class="col-md-5">
                            <label>Supporting Documents / Evidence:</label>
                            <div class="mt-repeater mt-repeater-preventive">
                                <div data-repeater-list="preventive">';

                                    if (!empty($row['preventive_file'])) {
                                        $array_preventive_file = explode(' | ', $row['preventive_file']);
                                        foreach($array_preventive_file as $value) {
                                            if (!empty($value)) {
                                                $file = $value;
                                                $fileExtension = fileExtension($file);
                                                $src = $fileExtension['src'];
                                                $embed = $fileExtension['embed'];
                                                $type = $fileExtension['type'];
                                                $file_extension = $fileExtension['file_extension'];
                                                $url = $base_url.'uploads/cam/';
                                                $file_src = $src.$url.rawurlencode($file).$embed;

                                                echo '<div class="mt-repeater-item row" data-repeater-item>
                                                    <div class="col-xs-12">
                                                        <p class="'; echo !empty($file) ? '':'hide'; echo '" style="margin: 0;"><a data-src="'.$file_src.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a></p>
                                                    </div>
                                                </div>';
                                            }
                                        }
                                    }
                                    
                                echo '</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="portlet box default margin-bottom-15">
                <div class="portlet-title">
                    <div class="caption">
                        <span class="caption-subject font-dark bold">Evaluation(s) and Follow Up(s)</span>
                    </div>
                </div>
                <div class="portlet-body">
                    <div class="row">
                        <div class="col-md-7">
                            <select class="form-control margin-bottom-15" name="evaluation_status" disabled>
                                <option value="0" '; echo $row['evaluation_status'] == 0 ? 'SELECTED':''; echo '>--Select Status--</option>
                                <option value="1" '; echo $row['evaluation_status'] == 1 ? 'SELECTED':''; echo '>Proposed</option>
                                <option value="2" '; echo $row['evaluation_status'] == 2 ? 'SELECTED':''; echo '>Implemented</option>
                            </select>
                            <textarea class="form-control margin-bottom-15" rows="10" name="evaluation_desc" disabled>'.$row['evaluation_desc'].'</textarea>
                        </div>
                        <div class="col-md-5">
                            <label>Supporting Documents / Evidence:</label>
                            <div class="mt-repeater mt-repeater-evaluation">
                                <div data-repeater-list="evaluation">';

                                    if (!empty($row['evaluation_file'])) {
                                        $array_evaluation_file = explode(' | ', $row['evaluation_file']);
                                        foreach($array_evaluation_file as $value) {
                                            if (!empty($value)) {
                                                $file = $value;
                                                $fileExtension = fileExtension($file);
                                                $src = $fileExtension['src'];
                                                $embed = $fileExtension['embed'];
                                                $type = $fileExtension['type'];
                                                $file_extension = $fileExtension['file_extension'];
                                                $url = $base_url.'uploads/cam/';
                                                $file_src = $src.$url.rawurlencode($file).$embed;

                                                echo '<div class="mt-repeater-item row" data-repeater-item>
                                                    <div class="col-xs-12">
                                                        <p class="'; echo !empty($file) ? '':'hide'; echo '" style="margin: 0;"><a data-src="'.$file_src.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a></p>
                                                    </div>
                                                </div>';
                                            }
                                        }
                                    }
                                    
                                echo '</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="portlet box default margin-bottom-15">
                <div class="portlet-title">
                    <div class="caption">
                        <span class="caption-subject font-dark bold">Comments</span>
                    </div>
                </div>
                <div class="portlet-body">
                    <div class="row">
                        <div class="col-md-7">
                            <textarea class="form-control margin-bottom-15" rows="10" name="comment_desc" disabled>'.$row['comment'].'</textarea>
                        </div>
                        <div class="col-md-5">
                            <label>Supporting Documents / Evidence:</label>
                            <div class="mt-repeater mt-repeater-comment">
                                <div data-repeater-list="comment">';

                                    if (!empty($row['comment_file'])) {
                                        $array_comment_file = explode(' | ', $row['comment_file']);
                                        foreach($array_comment_file as $value) {
                                            if (!empty($value)) {
                                                $file = $value;
                                                $fileExtension = fileExtension($file);
                                                $src = $fileExtension['src'];
                                                $embed = $fileExtension['embed'];
                                                $type = $fileExtension['type'];
                                                $file_extension = $fileExtension['file_extension'];
                                                $url = $base_url.'uploads/cam/';
                                                $file_src = $src.$url.rawurlencode($file).$embed;

                                                echo '<div class="mt-repeater-item row" data-repeater-item>
                                                    <div class="col-xs-12">
                                                        <p class="'; echo !empty($file) ? '':'hide'; echo '" style="margin: 0;"><a data-src="'.$file_src.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a></p>
                                                    </div>
                                                </div>';
                                            }
                                        }
                                    }
                                    
                                echo '</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="portlet box default margin-bottom-15">
                <div class="portlet-title">
                    <div class="caption">
                        <span class="caption-subject font-dark bold">Applicable Trainings</span>
                    </div>
                </div>
                <div class="portlet-body">
                    <div class="row">
                        <div class="col-md-7">';

                            // if ($current_client == 1) {
                                echo '<label>Training(s):</label>
                                <select class="form-control mt-multiselect training_desc_3" data-placeholder="Please Select" name="training_desc[]" multiple="multiple"></select>';
                            // } else {
                            //  echo '<textarea class="form-control" rows="10" name="training_desc" disabled>'.$row['training'].'</textarea>';
                            // }

                            echo '<div class="row margin-top-15">
                                <div class="col-md-6">
                                    <input type="time" class="form-control margin-bottom-15" name="training_date" placeholder="Date" value="'.$row['training_date'].'" disabled />
                                </div>
                            </div>
                        </div>
                        <div class="col-md-5">
                            <label>Supporting Documents / Evidence:</label>
                            <div class="mt-repeater mt-repeater-training">
                                <div data-repeater-list="training">';

                                    if (!empty($row['training_file'])) {
                                        $array_training_file = explode(' | ', $row['training_file']);
                                        foreach($array_training_file as $value) {
                                            if (!empty($value)) {
                                                $file = $value;
                                                $fileExtension = fileExtension($file);
                                                $src = $fileExtension['src'];
                                                $embed = $fileExtension['embed'];
                                                $type = $fileExtension['type'];
                                                $file_extension = $fileExtension['file_extension'];
                                                $url = $base_url.'uploads/cam/';
                                                $file_src = $src.$url.rawurlencode($file).$embed;

                                                echo '<div class="mt-repeater-item row" data-repeater-item>
                                                    <div class="col-xs-12">
                                                        <p class="'; echo !empty($file) ? '':'hide'; echo '" style="margin: 0;"><a data-src="'.$file_src.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a></p>
                                                    </div>
                                                </div>';
                                            }
                                        }
                                    }
                                    
                                echo '</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="portlet box default margin-bottom-15">
                <div class="portlet-body">
                    <div class="row">
                        <div class="col-md-3">
                            <input type="text" class="form-control margin-bottom-15" name="investigated_by" placeholder="Investigated By" value="'.$row['investigated_by'].'" disabled />
                        </div>
                        <div class="col-md-3">
                            <input type="text" class="form-control margin-bottom-15" name="investigated_title" placeholder="Title" value="'.$row['investigated_title'].'" disabled />
                        </div>
                        <div class="col-md-3">
                            <input type="date" class="form-control margin-bottom-15" name="investigated_date" placeholder="text" value="'.$row['investigated_date'].'" disabled />
                        </div>
                        <div class="col-md-3">
                            <input type="time" class="form-control margin-bottom-15" name="investigated_time" placeholder="text" value="'.$row['investigated_time'].'" disabled />
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-3">
                            <input type="text" class="form-control margin-bottom-15" name="verified_by" placeholder="CAPA Verified By" value="'.$row['verified_by'].'" disabled />
                        </div>
                        <div class="col-md-3">
                            <input type="text" class="form-control margin-bottom-15" name="verified_title" placeholder="Title" value="'.$row['verified_title'].'" disabled />
                        </div>
                        <div class="col-md-3">
                            <input type="date" class="form-control margin-bottom-15" name="verified_date" placeholder="text" value="'.$row['verified_date'].'" disabled />
                        </div>
                        <div class="col-md-3">
                            <input type="time" class="form-control margin-bottom-15" name="verified_time" placeholder="text" value="'.$row['verified_time'].'" disabled />
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-3">
                            <input type="text" class="form-control margin-bottom-15" name="completed_by" placeholder="CAPA Completed By" value="'.$row['completed_by'].'" disabled />
                        </div>
                        <div class="col-md-3">
                            <input type="text" class="form-control margin-bottom-15" name="completed_title" placeholder="Title" value="'.$row['completed_title'].'" disabled />
                        </div>
                        <div class="col-md-3">
                            <input type="date" class="form-control margin-bottom-15" name="completed_date" placeholder="text" value="'.$row['completed_date'].'" disabled />
                        </div>
                        <div class="col-md-3">
                            <input type="time" class="form-control margin-bottom-15" name="completed_time" placeholder="text" value="'.$row['completed_time'].'" disabled />
                        </div>
                    </div>
                </div>
            </div>';
        }
    }
	if( isset($_GET['modalTrend_CAM']) ) {
		$val = $_GET['modalTrend_CAM'];
		$years = $_GET['years'];
		$months = $_GET['months'];
        $complaints = $_GET['complaints'];
        $departments = $_GET['departments'];

		if (!empty($_COOKIE['switchAccount'])) {
			$portal_user = $_COOKIE['ID'];
			$user_id = $_COOKIE['switchAccount'];
		}
		else {
			$portal_user = $_COOKIE['ID'];
			$user_id = employerID($portal_user);
		}

        $current_client = 0;
        if (isset($_COOKIE['client'])) { $current_client = $_COOKIE['client']; }
        if ($current_client == 1) {
            $selectProgram = mysqli_query( $conn,"SELECT
                *
                FROM (
                    SELECT 
                    l.ID AS l_ID,
                    l.user_id AS l_user_id,
                    l.name AS l_name,
                    c.ID AS c_ID,
                    c.program_id AS c_program_id,
                    c.complaint_id AS c_complaint_id,
                    c.complaint_other AS c_complaint_other,
                    c.department_id AS c_department_id,
                    c.date AS c_date,
                    c.status AS c_status
                    FROM tbl_library AS l

                    INNER JOIN (
                        SELECT
                        *
                        FROM tbl_cam
                        WHERE user_id = $user_id
                    ) AS c
                    ON FIND_IN_SET(l.ID, REPLACE(c.program_id, ' ', '')) > 0

                    WHERE l.deleted = 0
                    AND l.type = 1
                    AND l.user_id = $user_id

                    GROUP BY l.ID

                    UNION ALL

                    SELECT 
                    l2.ID AS l_ID,
                    l2.user_id AS l_user_id,
                    l2.name AS l_name,
                    r.care_id AS c_ID,
                    r.program_id COLLATE utf8mb4_general_ci AS c_program_id,
                    CASE WHEN r.complaint_category COLLATE utf8mb4_general_ci > 0 THEN r.complaint_category COLLATE utf8mb4_general_ci ELSE NULL END AS c_complaint_id,
                    CASE WHEN r.complaint_category COLLATE utf8mb4_general_ci > 0 THEN NULL ELSE r.complaint_category COLLATE utf8mb4_general_ci END AS c_complaint_other,
                    r.department_id COLLATE utf8mb4_general_ci AS c_department_id,
                    r.care_date AS c_date,
                    r.status AS c_status
                    FROM tbl_library AS l2

                    INNER JOIN (
                        SELECT
                        *
                        FROM tbl_complaint_records
                        WHERE care_ownedby = $user_id
                        AND deleted = 0
                        AND capam = 1
                    ) AS r
                    ON FIND_IN_SET(l2.ID, REPLACE(r.program_id, ' ', '')) > 0

                    WHERE l2.deleted = 0
                    AND l2.type = 1
                    AND l2.user_id = $user_id

                    GROUP BY l2.ID
                ) t
                GROUP BY l_ID

                ORDER BY l_name" );
            $selectProgram_count = mysqli_num_rows($selectProgram);
        } else {
    		$legend = array(
    			0 => 'Other',
    			1 => 'Biological',
    			2 => 'Physical',
    			3 => 'Chemical',
    			4 => 'Allergen',
    			5 => 'Intentional Contamination / Intentional Adulteration',
    			6 => 'Economic Fraud',
                7 => 'Radiological',
                8 => 'Kosher',
                9 => 'Halal',
                10 => 'Organic violation'
    		);
    		$selectCategory = mysqli_query( $conn,"SELECT * FROM tbl_cam_category WHERE deleted = 0" );
    		$selectCategory_count = mysqli_num_rows($selectCategory);
        }

        // Category
		if (!empty($complaints) AND !empty($years) AND !empty($months)) {
            $complaints_arr = explode(',',$complaints);
            $years_arr = explode(',',$years);
            $months_arr = explode(',',$months);

            $dept_year_month = array();
            foreach($complaints_arr as $c) {
                $selectcomplaint = mysqli_query( $conn,"SELECT * FROM tbl_cam_complaint_category WHERE deleted = 0 AND ID = $c ORDER BY name" );
                if ( mysqli_num_rows($selectcomplaint) > 0 ) {
                    $rowDept = mysqli_fetch_array($selectcomplaint);

                    foreach($years_arr as $y) {
                        foreach($months_arr as $m) {
                            $rowComp   = DateTime::createFromFormat('!m', $m);
                            $monthName = $dateObj->format('F');
                            array_push($dept_year_month, $rowComp['title'] .' ('.$monthName.' '.$y.')');
                        }
                    }
                }
            }

            $category = $dept_year_month;
        } else if (!empty($departments) AND !empty($years) AND !empty($months)) {
            $departments_arr = explode(',',$departments);
            $years_arr = explode(',',$years);
            $months_arr = explode(',',$months);

            $dept_year_month = array();
            foreach($departments_arr as $d) {
                $selectDepartment = mysqli_query( $conn,"SELECT * FROM tbl_hr_department WHERE status = 1 AND ID = $d" );
                if ( mysqli_num_rows($selectDepartment) > 0 ) {
                    $rowDept = mysqli_fetch_array($selectDepartment);

                    foreach($years_arr as $y) {
                        foreach($months_arr as $m) {
                            $dateObj   = DateTime::createFromFormat('!m', $m);
                            $monthName = $dateObj->format('F');
                            array_push($dept_year_month, $rowDept['title'] .' ('.$monthName.' '.$y.')');
                        }
                    }
                }
            }

            $category = $dept_year_month;
        } else if (!empty($years) AND !empty($months)) {
            $years_arr = explode(',',$years);
            $months_arr = explode(',',$months);

            $year_month = array();
            foreach($years_arr as $y) {
                foreach($months_arr as $m) {
                    $dateObj   = DateTime::createFromFormat('!m', $m);
                    $monthName = $dateObj->format('F');
                    array_push($year_month, $monthName.' '.$y);
                }
            }

            $category = $year_month;
        } else if (!empty($complaints) AND !empty($years)) {
            $complaints_arr = explode(',',$complaints);
            $years_arr = explode(',',$years);

            $dept_year = array();
            foreach($complaints_arr as $c) {
                $selectcomplaint = mysqli_query( $conn,"SELECT * FROM tbl_cam_complaint_category WHERE deleted = 0 AND ID = $c ORDER BY name" );
                if ( mysqli_num_rows($selectcomplaint) > 0 ) {
                    $rowComp = mysqli_fetch_array($selectcomplaint);

                    foreach($years_arr as $y) {
                        array_push($dept_year, $rowComp['name'] .' ('. $y.')');
                    }
                }
            }

            $category = $dept_year;
        } else if (!empty($complaints) AND !empty($months)) {
            $complaints_arr = explode(',',$complaints);
            $months_arr = explode(',',$months);

            $dept_month = array();
            foreach($complaints_arr as $c) {
                $selectcomplaint = mysqli_query( $conn,"SELECT * FROM tbl_cam_complaint_category WHERE deleted = 0 AND ID = $c ORDER BY name" );
                if ( mysqli_num_rows($selectcomplaint) > 0 ) {
                    $rowComp = mysqli_fetch_array($selectcomplaint);

                    foreach($months_arr as $m) {
                        $dateObj   = DateTime::createFromFormat('!m', $m);
                        $monthName = $dateObj->format('F');
                        array_push($dept_month, $rowComp['name'] .' ('. $monthName.')');
                    }
                }
            }

            $category = $dept_month;
        } else if (!empty($departments) AND !empty($years)) {
            $departments_arr = explode(',',$departments);
            $years_arr = explode(',',$years);

            $dept_year = array();
            foreach($departments_arr as $d) {
                $selectDepartment = mysqli_query( $conn,"SELECT * FROM tbl_hr_department WHERE status = 1 AND ID = $d" );
                if ( mysqli_num_rows($selectDepartment) > 0 ) {
                    $rowDept = mysqli_fetch_array($selectDepartment);

                    foreach($years_arr as $y) {
                        array_push($dept_year, $rowDept['title'] .' ('. $y.')');
                    }
                }
            }

            $category = $dept_year;
        } else if (!empty($departments) AND !empty($months)) {
            $departments_arr = explode(',',$departments);
            $months_arr = explode(',',$months);

            $dept_month = array();
            foreach($departments_arr as $d) {
                $selectDepartment = mysqli_query( $conn,"SELECT * FROM tbl_hr_department WHERE status = 1 AND ID = $d" );
                if ( mysqli_num_rows($selectDepartment) > 0 ) {
                    $rowDept = mysqli_fetch_array($selectDepartment);

                    foreach($months_arr as $m) {
                        $dateObj   = DateTime::createFromFormat('!m', $m);
                        $monthName = $dateObj->format('F');
                        array_push($dept_month, $rowDept['title'] .' ('. $monthName.')');
                    }
                }
            }

            $category = $dept_month;
        } else {
			if (!empty($years)) {
				$years_arr = explode(',',$years);

				$category = $years_arr;
			} else if (!empty($months)) {
				$months_arr = explode(',',$months);
				$month_array = array();
				foreach($months_arr as $m) {
					$dateObj   = DateTime::createFromFormat('!m', $m);
					$monthName = $dateObj->format('F');
					array_push($month_array, $monthName);
				}

				$category = $month_array;
			} else if (!empty($complaints)) {
                $complaints_arr = explode(',',$complaints);
                $complaint_array = array();
                foreach($complaints_arr as $c) {
                    $selectcomplaint = mysqli_query( $conn,"SELECT * FROM tbl_cam_complaint_category WHERE deleted = 0 AND ID = $c" );
                    if ( mysqli_num_rows($selectcomplaint) > 0 ) {
                        $rowComp = mysqli_fetch_array($selectcomplaint);
                        array_push($complaint_array, $rowComp['name']);
                    }
                }

                $category = $complaint_array;
            } else if (!empty($departments)) {
                $departments_arr = explode(',',$departments);
                $department_array = array();
                foreach($departments_arr as $d) {
                    $selectDepartment = mysqli_query( $conn,"SELECT * FROM tbl_hr_department WHERE status = 1 AND ID = $d" );
                    if ( mysqli_num_rows($selectDepartment) > 0 ) {
                        $rowDept = mysqli_fetch_array($selectDepartment);
                        array_push($department_array, $rowDept['title']);
                    }
                }

                $category = $department_array;
            } else {
				$category = ['All'];
			}
		}

        //  Series Data
		$serries_array = array();
		$record = 0;
        if ($val == 'statusAll') {
            if ($current_client == 1) {
                if ($selectProgram_count > 0) {
                    while ($rowProgram = mysqli_fetch_array($selectProgram)) {
                        $l_ID = $rowProgram['l_ID'];
                        $l_name = $rowProgram['l_name'];

                        for ($x=0; $x < 2 ; $x++) { 
                            $count_program_arr = array();
                            if (!empty($complaints) AND !empty($years) AND !empty($months)) {
                                foreach($complaints_arr as $complaints_value) {
                                    foreach($years_arr as $year_value) {
                                        foreach($months_arr as $months_value) {
                                            $count_program = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = $x AND FIND_IN_SET($complaints_value, REPLACE(complaint_id, ' ', '')) > 0 AND YEAR(date) = $year_value AND MONTH(date) = $months_value AND user_id = $user_id" ));
                                            $count_program2 = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_complaint_records WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = $x AND FIND_IN_SET($complaints_value, REPLACE(complaint_category, ' ', '')) > 0 AND YEAR(care_date) = $year_value AND MONTH(care_date) = $months_value AND deleted = 0 AND capam = 1 AND care_ownedby = $user_id" ));
                                            array_push($count_program_arr, $count_program + $count_program2);
                                        }
                                    }
                                }
                            } else if (!empty($departments) AND !empty($years) AND !empty($months)) {
                                foreach($departments_arr as $departments_value) {
                                    foreach($years_arr as $year_value) {
                                        foreach($months_arr as $months_value) {
                                            $count_program = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = $x AND FIND_IN_SET($departments_value, REPLACE(department_id, ' ', '')) > 0 AND YEAR(date) = $year_value AND MONTH(date) = $months_value AND user_id = $user_id" ));
                                            $count_program2 = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_complaint_records WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = $x AND FIND_IN_SET($departments_value, REPLACE(department_id, ' ', '')) > 0 AND YEAR(care_date) = $year_value AND MONTH(care_date) = $months_value AND deleted = 0 AND capam = 1 AND care_ownedby = $user_id" ));
                                            array_push($count_program_arr, $count_program + $count_program2);
                                        }
                                    }
                                }
                            } else if (!empty($years) AND !empty($months)) {
                                foreach($years_arr as $year_value) {
                                    foreach($months_arr as $months_value) {
                                        $count_program = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = $x AND YEAR(date) = $year_value AND MONTH(date) = $months_value AND user_id = $user_id" ));
                                        $count_program2 = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_complaint_records WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = $x AND YEAR(care_date) = $year_value AND MONTH(care_date) = $months_value AND deleted = 0 AND capam = 1 AND care_ownedby = $user_id" ));
                                        array_push($count_program_arr, $count_program + $count_program2);
                                    }
                                }
                            } else if (!empty($complaints) AND !empty($years)) {
                                foreach($complaints_arr as $complaints_value) {
                                    foreach($years_arr as $year_value) {
                                        $count_program = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = $x AND FIND_IN_SET($complaints_value, REPLACE(complaint_id, ' ', '')) > 0 AND YEAR(date) = $year_value AND user_id = $user_id" ));
                                        $count_program2 = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_complaint_records WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = $x AND FIND_IN_SET($complaints_value, REPLACE(complaint_category, ' ', '')) > 0 AND YEAR(care_date) = $year_value AND deleted = 0 AND capam = 1 AND care_ownedby = $user_id" ));
                                        array_push($count_program_arr, $count_program + $count_program2);
                                    }
                                }
                            } else if (!empty($complaints) AND !empty($months)) {
                                foreach($complaints_arr as $complaints_value) {
                                    foreach($months_arr as $months_value) {
                                        $count_program = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = $x AND FIND_IN_SET($complaints_value, REPLACE(complaint_id, ' ', '')) > 0 AND MONTH(date) = $months_value AND user_id = $user_id" ));
                                        $count_program2 = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_complaint_records WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = $x AND FIND_IN_SET($complaints_value, REPLACE(complaint_category, ' ', '')) > 0 AND MONTH(care_date) = $months_value AND deleted = 0 AND capam = 1 AND care_ownedby = $user_id" ));
                                        array_push($count_program_arr, $count_program + $count_program2);
                                    }
                                }
                            } else if (!empty($departments) AND !empty($years)) {
                                foreach($departments_arr as $departments_value) {
                                    foreach($years_arr as $year_value) {
                                        $count_program = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = $x AND FIND_IN_SET($departments_value, REPLACE(department_id, ' ', '')) > 0 AND YEAR(date) = $year_value AND user_id = $user_id" ));
                                        $count_program2 = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_complaint_records WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = $x AND FIND_IN_SET($departments_value, REPLACE(department_id, ' ', '')) > 0 AND YEAR(care_date) = $year_value AND deleted = 0 AND capam = 1 AND care_ownedby = $user_id" ));
                                        array_push($count_program_arr, $count_program + $count_program2);
                                    }
                                }
                            } else if (!empty($departments) AND !empty($months)) {
                                foreach($departments_arr as $departments_value) {
                                    foreach($months_arr as $months_value) {
                                        $count_program = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = $x AND FIND_IN_SET($departments_value, REPLACE(department_id, ' ', '')) > 0 AND MONTH(date) = $months_value AND user_id = $user_id" ));
                                        $count_program2 = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_complaint_records WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = $x AND FIND_IN_SET($departments_value, REPLACE(department_id, ' ', '')) > 0 AND MONTH(care_date) = $months_value AND deleted = 0 AND capam = 1 AND care_ownedby = $user_id" ));
                                        array_push($count_program_arr, $count_program + $count_program2);
                                    }
                                }
                            } else {
                                if (!empty($years)) {
                                    foreach($years_arr as $year_value) {
                                        $count_program = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = $x AND YEAR(date) = $year_value AND user_id = $user_id" ));
                                        $count_program2 = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_complaint_records WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = $x AND YEAR(care_date) = $year_value AND deleted = 0 AND capam = 1 AND care_ownedby = $user_id" ));
                                        array_push($count_program_arr, $count_program + $count_program2);
                                    }
                                } else if (!empty($months)) {
                                    foreach($months_arr as $months_value) {
                                        $count_program = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = $x AND MONTH(date) = $months_value AND user_id = $user_id" ));
                                        $count_program2 = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_complaint_records WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = $x AND MONTH(care_date) = $months_value AND deleted = 0 AND capam = 1 AND care_ownedby = $user_id" ));
                                        array_push($count_program_arr, $count_program + $count_program2);
                                    }
                                } else if (!empty($complaints)) {
                                    foreach($complaints_arr as $complaints_value) {
                                        $count_program = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = $x AND FIND_IN_SET($complaints_value, REPLACE(complaint_id, ' ', '')) > 0 AND user_id = $user_id" ));
                                        $count_program2 = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_complaint_records WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = $x AND FIND_IN_SET($complaints_value, REPLACE(complaint_category, ' ', '')) > 0 AND deleted = 0 AND capam = 1 AND care_ownedby = $user_id" ));
                                        array_push($count_program_arr, $count_program + $count_program2);
                                    }
                                } else if (!empty($departments)) {
                                    foreach($departments_arr as $departments_value) {
                                        $count_program = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = $x AND FIND_IN_SET($departments_value, REPLACE(department_id, ' ', '')) > 0 AND user_id = $user_id" ));
                                        $count_program2 = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_complaint_records WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = $x AND FIND_IN_SET($departments_value, REPLACE(department_id, ' ', '')) > 0 AND deleted = 0 AND capam = 1 AND care_ownedby = $user_id" ));
                                        array_push($count_program_arr, $count_program + $count_program2);
                                    }
                                } else {
                                    $count_program = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = $x AND user_id = $user_id" ));
                                    $count_program2 = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_complaint_records WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = $x AND deleted = 0 AND capam = 1 AND care_ownedby = $user_id" ));
                                    array_push($count_program_arr, $count_program + $count_program2);
                                }
                            }

                            if ($x == 0) {
                                $series_data = array(
                                    'id' => 'g'.$record,
                                    'name' => 'Open',
                                    'data' => $count_program_arr,
                                    'stack' => $l_name
                                );
                            } else {
                                $series_data = array(
                                    'linkedTo' => 'g'.$record,
                                    'color' => '#e7505a',
                                    'name' => 'Close',
                                    'data' => $count_program_arr,
                                    'stack' => $l_name
                                );
                            }
                            array_push($serries_array, $series_data);
                        }
                        $record++;
                    }
                }
            } else {
            	for ($i=0; $i < $selectCategory_count; $i++) {
            		for ($x=0; $x < 2 ; $x++) {
            			$count_category_arr = array();
            			if (!empty($years) AND !empty($months)) {
    						foreach($years_arr as $year_value) {
    							foreach($months_arr as $months_value) {
    	        					$count_category = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE category_id REGEXP $i AND status = $x AND YEAR(date) = $year_value AND MONTH(date) = $months_value AND user_id = $user_id" ));
    								array_push($count_category_arr, $count_category);
    							}
    						}
            			} else {
            				if (!empty($years)) {
    	        				foreach($years_arr as $year_value) {
    	        					$count_category = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE category_id REGEXP $i AND status = $x AND YEAR(date) = $year_value AND user_id = $user_id" ));
    								array_push($count_category_arr, $count_category);
    		        			}
            				} else if (!empty($months)) {
    	        				foreach($months_arr as $months_value) {
    	        					$count_category = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE category_id REGEXP $i AND status = $x AND MONTH(date) = $months_value AND user_id = $user_id" ));
    								array_push($count_category_arr, $count_category);
    		        			}
            				} else {
    		        			$count_category = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE category_id REGEXP $i AND status = $x AND user_id = $user_id" ));
    		        			array_push($count_category_arr, $count_category);
            				}
            			}

            			if ($x == 0) {
    			        	$series_data = array(
    				        	'id' => 'g'.$record,
    				        	'name' => 'Open',
    				        	'data' => $count_category_arr,
    				        	'stack' => $legend[$i]
    				        );
    			        } else {
    			        	$series_data = array(
    				        	'linkedTo' => 'g'.$record,
    				        	'color' => '#e7505a',
    				        	'name' => 'Close',
    				        	'data' => $count_category_arr,
    				        	'stack' => $legend[$i]
    				        );
    			        }
    			        array_push($serries_array, $series_data);
            		}
            		$record++;
            	}
            }
        } else if ($val == 'statusOpen') {
            if ($current_client == 1) {
                if ($selectProgram_count > 0) {
                    while ($rowProgram = mysqli_fetch_array($selectProgram)) {
                        $l_ID = $rowProgram['l_ID'];
                        $l_name = $rowProgram['l_name'];

                        $count_program_arr = array();
                        if (!empty($complaints) AND !empty($years) AND !empty($months)) {
                            foreach($complaints_arr as $complaints_value) {
                                foreach($years_arr as $year_value) {
                                    foreach($months_arr as $months_value) {
                                        $count_program = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = 0 AND FIND_IN_SET($complaints_value, REPLACE(complaint_id, ' ', '')) > 0 AND YEAR(date) = $year_value AND MONTH(date) = $months_value AND user_id = $user_id" ));
                                        $count_program2 = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_complaint_records WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = 0 AND FIND_IN_SET($complaints_value, REPLACE(complaint_id, ' ', '')) > 0 AND YEAR(care_date) = $year_value AND MONTH(care_date) = $months_value AND deleted = 0 AND capam = 1 AND care_ownedby = $user_id" ));
                                        array_push($count_program_arr, $count_program + $count_program2);
                                    }
                                }
                            }
                        } else if (!empty($departments) AND !empty($years) AND !empty($months)) {
                            foreach($departments_arr as $departments_value) {
                                foreach($years_arr as $year_value) {
                                    foreach($months_arr as $months_value) {
                                        $count_program = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = 0 AND FIND_IN_SET($departments_value, REPLACE(department_id, ' ', '')) > 0 AND YEAR(date) = $year_value AND MONTH(date) = $months_value AND user_id = $user_id" ));
                                        $count_program2 = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_complaint_records WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = 0 AND FIND_IN_SET($departments_value, REPLACE(department_id, ' ', '')) > 0 AND YEAR(care_date) = $year_value AND MONTH(care_date) = $months_value AND deleted = 0 AND capam = 1 AND care_ownedby = $user_id" ));
                                        array_push($count_program_arr, $count_program + $count_program2);
                                    }
                                }
                            }
                        } else if (!empty($years) AND !empty($months)) {
                            foreach($years_arr as $year_value) {
                                foreach($months_arr as $months_value) {
                                    $count_program = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = 0 AND YEAR(date) = $year_value AND MONTH(date) = $months_value AND user_id = $user_id" ));
                                    $count_program2 = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_complaint_records WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = 0 AND YEAR(care_date) = $year_value AND MONTH(care_date) = $months_value AND deleted = 0 AND capam = 1 AND care_ownedby = $user_id" ));
                                    array_push($count_program_arr, $count_program + $count_program2);
                                }
                            }
                        } else if (!empty($complaints) AND !empty($years)) {
                            foreach($complaints_arr as $complaints_value) {
                                foreach($years_arr as $year_value) {
                                    $count_program = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = 0 AND FIND_IN_SET($complaints_value, REPLACE(complaint_id, ' ', '')) > 0 AND YEAR(date) = $year_value AND user_id = $user_id" ));
                                    $count_program2 = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_complaint_records WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = 0 AND FIND_IN_SET($departments_value, REPLACE(complaint_id, ' ', '')) > 0 AND YEAR(care_date) = $year_value AND deleted = 0 AND capam = 1 AND care_ownedby = $user_id" ));
                                    array_push($count_program_arr, $count_program + $count_program2);
                                }
                            }
                        } else if (!empty($complaints) AND !empty($months)) {
                            foreach($complaints_arr as $complaints_value) {
                                foreach($months_arr as $months_value) {
                                    $count_program = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = 0 AND FIND_IN_SET($complaints_value, REPLACE(complaint_id, ' ', '')) > 0 AND MONTH(date) = $months_value AND user_id = $user_id" ));
                                    $count_program2 = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_complaint_records WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = 0 AND FIND_IN_SET($complaints_value, REPLACE(complaint_id, ' ', '')) > 0 AND MONTH(care_date) = $months_value AND deleted = 0 AND capam = 1 AND care_ownedby = $user_id" ));
                                    array_push($count_program_arr, $count_program + $count_program2);
                                }
                            }
                        } else if (!empty($departments) AND !empty($years)) {
                            foreach($departments_arr as $departments_value) {
                                foreach($years_arr as $year_value) {
                                    $count_program = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = 0 AND FIND_IN_SET($departments_value, REPLACE(department_id, ' ', '')) > 0 AND YEAR(date) = $year_value AND user_id = $user_id" ));
                                    $count_program2 = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_complaint_records WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = 0 AND FIND_IN_SET($departments_value, REPLACE(department_id, ' ', '')) > 0 AND YEAR(care_date) = $year_value AND deleted = 0 AND capam = 1 AND care_ownedby = $user_id" ));
                                    array_push($count_program_arr, $count_program + $count_program2);
                                }
                            }
                        } else if (!empty($departments) AND !empty($months)) {
                            foreach($departments_arr as $departments_value) {
                                foreach($months_arr as $months_value) {
                                    $count_program = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = 0 AND FIND_IN_SET($departments_value, REPLACE(department_id, ' ', '')) > 0 AND MONTH(date) = $months_value AND user_id = $user_id" ));
                                    $count_program2 = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_complaint_records WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = 0 AND FIND_IN_SET($departments_value, REPLACE(department_id, ' ', '')) > 0 AND MONTH(care_date) = $months_value AND deleted = 0 AND capam = 1 AND care_ownedby = $user_id" ));
                                    array_push($count_program_arr, $count_program + $count_program2);
                                }
                            }
                        } else {
                            if (!empty($years)) {
                                foreach($years_arr as $year_value) {
                                    $count_program = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = 0 AND YEAR(date) = $year_value AND user_id = $user_id" ));
                                    $count_program2 = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_complaint_records WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = 0 AND YEAR(care_date) = $year_value AND deleted = 0 AND capam = 1 AND care_ownedby = $user_id" ));
                                    array_push($count_program_arr, $count_program + $count_program2);
                                }
                            } else if (!empty($months)) {
                                foreach($months_arr as $months_value) {
                                    $count_program = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = 0 AND MONTH(date) = $months_value AND user_id = $user_id" ));
                                    $count_program2 = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_complaint_records WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = 0 AND MONTH(care_date) = $months_value AND deleted = 0 AND capam = 1 AND care_ownedby = $user_id" ));
                                    array_push($count_program_arr, $count_program + $count_program2);
                                }
                            } else if (!empty($complaints)) {
                                foreach($complaints_arr as $complaints_value) {
                                    $count_program = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = 0 AND FIND_IN_SET($complaints_value, REPLACE(complaint_id, ' ', '')) > 0 AND user_id = $user_id" ));
                                    $count_program2 = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_complaint_records WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = 0 AND FIND_IN_SET($complaints_value, REPLACE(complaint_id, ' ', '')) > 0 deleted = 0 AND capam = 1 AND care_ownedby = $user_id" ));
                                    array_push($count_program_arr, $count_program + $count_program2);
                                }
                            } else if (!empty($departments)) {
                                foreach($departments_arr as $departments_value) {
                                    $count_program = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = 0 AND FIND_IN_SET($departments_value, REPLACE(department_id, ' ', '')) > 0 AND user_id = $user_id" ));
                                    $count_program2 = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_complaint_records WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = 0 AND FIND_IN_SET($departments_value, REPLACE(department_id, ' ', '')) > 0 deleted = 0 AND capam = 1 AND care_ownedby = $user_id" ));
                                    array_push($count_program_arr, $count_program + $count_program2);
                                }
                            } else {
                                $count_program = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = 0 AND user_id = $user_id" ));
                                $count_program2 = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_complaint_records WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = 0 AND deleted = 0 AND capam = 1 AND care_ownedby = $user_id" ));
                                array_push($count_program_arr, $count_program + $count_program2);
                            }
                        }

                        $series_data = array(
                            'id' => 'g'.$record++,
                            'name' => 'Open',
                            'data' => $count_program_arr,
                            'stack' => $l_name
                        );
                        array_push($serries_array, $series_data);
                    }
                }
            } else {
            	for ($i=0; $i < $selectCategory_count; $i++) {
        			$count_category_arr = array();
        			if (!empty($years) AND !empty($months)) {
    					foreach($years_arr as $year_value) {
    						foreach($months_arr as $months_value) {
            					$count_category = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE category_id REGEXP $i AND status = 0 AND YEAR(date) = $year_value AND MONTH(date) = $months_value AND user_id = $user_id" ));
    							array_push($count_category_arr, $count_category);
    						}
    					}
        			} else {
        				if (!empty($years)) {
            				foreach($years_arr as $year_value) {
            					$count_category = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE category_id REGEXP $i AND status = 0 AND YEAR(date) = $year_value AND user_id = $user_id" ));
    							array_push($count_category_arr, $count_category);
    	        			}
        				} else if (!empty($months)) {
            				foreach($months_arr as $months_value) {
            					$count_category = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE category_id REGEXP $i AND status = 0 AND MONTH(date) = $months_value AND user_id = $user_id" ));
    							array_push($count_category_arr, $count_category);
    	        			}
        				} else {
    	        			$count_category = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE category_id REGEXP $i AND status = 0 AND user_id = $user_id" ));
    	        			array_push($count_category_arr, $count_category);
        				}
        			}

        			$series_data = array(
    		        	'id' => 'g'.$record++,
    		        	'name' => 'Open',
    		        	'data' => $count_category_arr,
    		        	'stack' => $legend[$i]
    		        );
    		        array_push($serries_array, $series_data);
            	}
            }
        } else if ($val == 'statusClose') {
            if ($current_client == 1) {
                if ($selectProgram_count > 0) {
                    while ($rowProgram = mysqli_fetch_array($selectProgram)) {
                        $l_ID = $rowProgram['l_ID'];
                        $l_name = $rowProgram['l_name'];

                        $count_program_arr = array();
                        if (!empty($complaints) AND !empty($years) AND !empty($months)) {
                            foreach($complaints_arr as $complaints_value) {
                                foreach($years_arr as $year_value) {
                                    foreach($months_arr as $months_value) {
                                        $count_program = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = 1 AND FIND_IN_SET($complaints_value, REPLACE(complaint_id, ' ', '')) > 0 AND YEAR(date) = $year_value AND MONTH(date) = $months_value AND user_id = $user_id" ));
                                        $count_program2 = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_complaint_records WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = 1 AND FIND_IN_SET($complaints_value, REPLACE(complaint_id, ' ', '')) > 0 AND YEAR(care_date) = $year_value AND MONTH(care_date) = $months_value AND deleted = 0 AND capam = 1 AND care_ownedby = $user_id" ));
                                        array_push($count_program_arr, $count_program + $count_program2);
                                    }
                                }
                            }
                        } else if (!empty($departments) AND !empty($years) AND !empty($months)) {
                            foreach($departments_arr as $departments_value) {
                                foreach($years_arr as $year_value) {
                                    foreach($months_arr as $months_value) {
                                        $count_program = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = 1 AND FIND_IN_SET($departments_value, REPLACE(department_id, ' ', '')) > 0 AND YEAR(date) = $year_value AND MONTH(date) = $months_value AND user_id = $user_id" ));
                                        $count_program2 = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_complaint_records WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = 1 AND FIND_IN_SET($departments_value, REPLACE(department_id, ' ', '')) > 0 AND YEAR(care_date) = $year_value AND MONTH(care_date) = $months_value AND deleted = 0 AND capam = 1 AND care_ownedby = $user_id" ));
                                        array_push($count_program_arr, $count_program + $count_program2);
                                    }
                                }
                            }
                        } else if (!empty($years) AND !empty($months)) {
                            foreach($years_arr as $year_value) {
                                foreach($months_arr as $months_value) {
                                    $count_program = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = 1 AND YEAR(date) = $year_value AND MONTH(date) = $months_value AND user_id = $user_id" ));
                                    $count_program2 = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_complaint_records WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = 1 AND YEAR(care_date) = $year_value AND MONTH(care_date) = $months_value AND deleted = 0 AND capam = 1 AND care_ownedby = $user_id" ));
                                    array_push($count_program_arr, $count_program + $count_program2);
                                }
                            }
                        } else if (!empty($complaints) AND !empty($years)) {
                            foreach($complaints_arr as $complaints_value) {
                                foreach($years_arr as $year_value) {
                                    $count_program = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = 1 AND FIND_IN_SET($complaints_value, REPLACE(complaint_id, ' ', '')) > 0 AND YEAR(date) = $year_value AND user_id = $user_id" ));
                                    $count_program2 = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_complaint_records WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = 1 AND FIND_IN_SET($complaints_value, REPLACE(complaint_id, ' ', '')) > 0 AND YEAR(care_date) = $year_value AND deleted = 0 AND capam = 1 AND care_ownedby = $user_id" ));
                                    array_push($count_program_arr, $count_program + $count_program2);
                                }
                            }
                        } else if (!empty($complaints) AND !empty($months)) {
                            foreach($complaints_arr as $complaints_value) {
                                foreach($months_arr as $months_value) {
                                    $count_program = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = 1 AND FIND_IN_SET($complaints_value, REPLACE(complaint_id, ' ', '')) > 0 AND MONTH(date) = $months_value AND user_id = $user_id" ));
                                    $count_program2 = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_complaint_records WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = 1 AND FIND_IN_SET($complaints_value, REPLACE(complaint_id, ' ', '')) > 0 AND MONTH(care_date) = $months_value AND deleted = 0 AND capam = 1 AND care_ownedby = $user_id" ));
                                    array_push($count_program_arr, $count_program + $count_program2);
                                }
                            }
                        } else if (!empty($departments) AND !empty($years)) {
                            foreach($departments_arr as $departments_value) {
                                foreach($years_arr as $year_value) {
                                    $count_program = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = 1 AND FIND_IN_SET($departments_value, REPLACE(department_id, ' ', '')) > 0 AND YEAR(date) = $year_value AND user_id = $user_id" ));
                                    $count_program2 = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_complaint_records WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = 1 AND FIND_IN_SET($departments_value, REPLACE(department_id, ' ', '')) > 0 AND YEAR(care_date) = $year_value AND deleted = 0 AND capam = 1 AND care_ownedby = $user_id" ));
                                    array_push($count_program_arr, $count_program + $count_program2);
                                }
                            }
                        } else if (!empty($departments) AND !empty($months)) {
                            foreach($departments_arr as $departments_value) {
                                foreach($months_arr as $months_value) {
                                    $count_program = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = 1 AND FIND_IN_SET($departments_value, REPLACE(department_id, ' ', '')) > 0 AND MONTH(date) = $months_value AND user_id = $user_id" ));
                                    $count_program2 = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_complaint_records WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = 1 AND FIND_IN_SET($departments_value, REPLACE(department_id, ' ', '')) > 0 AND MONTH(care_date) = $months_value AND deleted = 0 AND capam = 1 AND care_ownedby = $user_id" ));
                                    array_push($count_program_arr, $count_program + $count_program2);
                                }
                            }
                        } else {
                            if (!empty($years)) {
                                foreach($years_arr as $year_value) {
                                    $count_program = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = 1 AND YEAR(date) = $year_value AND user_id = $user_id" ));
                                    $count_program2 = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_complaint_records WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = 1 AND YEAR(care_date) = $year_value AND deleted = 0 AND capam = 1 AND care_ownedby = $user_id" ));
                                    array_push($count_program_arr, $count_program + $count_program2);
                                }
                            } else if (!empty($months)) {
                                foreach($months_arr as $months_value) {
                                    $count_program = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = 1 AND MONTH(date) = $months_value AND user_id = $user_id" ));
                                    $count_program2 = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_complaint_records WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 1 AND status = 0 AND MONTH(care_date) = $months_value AND deleted = 0 AND capam = 1 AND care_ownedby = $user_id" ));
                                    array_push($count_program_arr, $count_program + $count_program2);
                                }
                            } else if (!empty($complaints)) {
                                foreach($complaints_arr as $complaints_value) {
                                    $count_program = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = 1 AND FIND_IN_SET($complaints_value, REPLACE(complaint_id, ' ', '')) > 0 AND user_id = $user_id" ));
                                    $count_program2 = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_complaint_records WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 1 AND status = 0 AND FIND_IN_SET($complaints_value, REPLACE(complaint_id, ' ', '')) > 0 deleted = 0 AND capam = 1 AND care_ownedby = $user_id" ));
                                    array_push($count_program_arr, $count_program + $count_program2);
                                }
                            } else if (!empty($departments)) {
                                foreach($departments_arr as $departments_value) {
                                    $count_program = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = 1 AND FIND_IN_SET($departments_value, REPLACE(department_id, ' ', '')) > 0 AND user_id = $user_id" ));
                                    $count_program2 = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_complaint_records WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 1 AND status = 0 AND FIND_IN_SET($departments_value, REPLACE(department_id, ' ', '')) > 0 deleted = 0 AND capam = 1 AND care_ownedby = $user_id" ));
                                    array_push($count_program_arr, $count_program + $count_program2);
                                }
                            } else {
                                $count_program = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = 1 AND user_id = $user_id" ));
                                $count_program2 = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_complaint_records WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = 1 AND deleted = 0 AND capam = 1 AND care_ownedby = $user_id" ));
                                array_push($count_program_arr, $count_program + $count_program2);
                            }
                        }

                        $series_data = array(
                            'id' => 'g'.$record++,
                            'name' => 'Close',
                            'data' => $count_program_arr,
                            'stack' => $l_name
                        );
                        array_push($serries_array, $series_data);
                    }
                }
            } else {
            	for ($i=0; $i < $selectCategory_count; $i++) {
        			$count_category_arr = array();
        			if (!empty($years) AND !empty($months)) {
    					foreach($years_arr as $year_value) {
    						foreach($months_arr as $months_value) {
            					$count_category = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE category_id REGEXP $i AND status = 1 AND YEAR(date) = $year_value AND MONTH(date) = $months_value AND user_id = $user_id" ));
    							array_push($count_category_arr, $count_category);
    						}
    					}
        			} else {
        				if (!empty($years)) {
            				foreach($years_arr as $year_value) {
            					$count_category = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE category_id REGEXP $i AND status = 1 AND YEAR(date) = $year_value AND user_id = $user_id" ));
    							array_push($count_category_arr, $count_category);
    	        			}
        				} else if (!empty($months)) {
            				foreach($months_arr as $months_value) {
            					$count_category = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE category_id REGEXP $i AND status = 1 AND MONTH(date) = $months_value AND user_id = $user_id" ));
    							array_push($count_category_arr, $count_category);
    	        			}
        				} else {
    	        			$count_category = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE category_id REGEXP $i AND status = 1 AND user_id = $user_id" ));
    	        			array_push($count_category_arr, $count_category);
        				}
        			}

        			$series_data = array(
    		        	'id' => 'g'.$record++,
    		        	'name' => 'Close',
    		        	'data' => $count_category_arr,
    		        	'stack' => $legend[$i]
    		        );
    		        array_push($serries_array, $series_data);
            	}
            }
        }

        $output = array(
			"category" => $category,
			"series" => $serries_array
		);
		echo json_encode($output);
    }
	if( isset($_GET['modalTrend_CAMSummary']) ) {
		$val = $_GET['modalTrend_CAMSummary'];
		$year = $_GET['year'];
        $months = $_GET['months'];
        $complaints = $_GET['complaints'];
        $departments = $_GET['departments'];

		if (!empty($_COOKIE['switchAccount'])) {
			$portal_user = $_COOKIE['ID'];
			$user_id = $_COOKIE['switchAccount'];
		}
		else {
			$portal_user = $_COOKIE['ID'];
			$user_id = employerID($portal_user);
		}

        $current_client = 0;
        if (isset($_COOKIE['client'])) { $current_client = $_COOKIE['client']; }
        if ($current_client == 1) {
            // $selectProgram = mysqli_query( $conn,"SELECT 
            //     l.ID AS l_ID,
            //     l.user_id AS l_user_id,
            //     l.name AS l_name,
            //     c.ID AS c_ID,
            //     c.program_id AS c_program_id,
            //     c.complaint_id AS c_complaint_id,
            //     c.complaint_other AS c_complaint_other,
            //     c.department_id AS c_department_id,
            //     c.department_other AS c_department_other,
            //     c.date AS c_date,
            //     c.status AS c_status
            //     FROM tbl_library AS l

            //     INNER JOIN (
            //         SELECT
            //         *
            //         FROM tbl_cam
            //         WHERE user_id = $user_id
            //     ) AS c
            //     ON FIND_IN_SET(l.ID, REPLACE(c.program_id, ' ', '')) > 0

            //     WHERE l.deleted = 0
            //     AND l.type = 1
            //     AND l.user_id = $user_id

            //     GROUP BY l.ID

            //     ORDER BY l.name" );
            // $selectProgram_count = mysqli_num_rows($selectProgram);


            $selectProgram = mysqli_query( $conn,"SELECT
                *
                FROM (
                    SELECT 
                    l.ID AS l_ID,
                    l.user_id AS l_user_id,
                    l.name AS l_name,
                    c.ID AS c_ID,
                    c.program_id AS c_program_id,
                    c.complaint_id AS c_complaint_id,
                    c.complaint_other AS c_complaint_other,
                    c.department_id AS c_department_id,
                    c.date AS c_date,
                    c.status AS c_status
                    FROM tbl_library AS l

                    INNER JOIN (
                        SELECT
                        *
                        FROM tbl_cam
                        WHERE user_id = $user_id
                    ) AS c
                    ON FIND_IN_SET(l.ID, REPLACE(c.program_id, ' ', '')) > 0

                    WHERE l.deleted = 0
                    AND l.type = 1
                    AND l.user_id = $user_id

                    GROUP BY l.ID

                    UNION ALL

                    SELECT 
                    l2.ID AS l_ID,
                    l2.user_id AS l_user_id,
                    l2.name AS l_name,
                    r.care_id AS c_ID,
                    r.program_id COLLATE utf8mb4_general_ci AS c_program_id,
                    CASE WHEN r.complaint_category COLLATE utf8mb4_general_ci > 0 THEN r.complaint_category COLLATE utf8mb4_general_ci ELSE NULL END AS c_complaint_id,
                    CASE WHEN r.complaint_category COLLATE utf8mb4_general_ci > 0 THEN NULL ELSE r.complaint_category COLLATE utf8mb4_general_ci END AS c_complaint_other,
                    r.department_id COLLATE utf8mb4_general_ci AS c_department_id,
                    r.care_date AS c_date,
                    r.status AS c_status
                    FROM tbl_library AS l2

                    INNER JOIN (
                        SELECT
                        *
                        FROM tbl_complaint_records
                        WHERE care_ownedby = $user_id
                        AND deleted = 0
                        AND capam = 1
                    ) AS r
                    ON FIND_IN_SET(l2.ID, REPLACE(r.program_id, ' ', '')) > 0

                    WHERE l2.deleted = 0
                    AND l2.type = 1
                    AND l2.user_id = $user_id

                    GROUP BY l2.ID
                ) t
                GROUP BY l_ID

                ORDER BY l_name" );
            $selectProgram_count = mysqli_num_rows($selectProgram);
        } else {
    		$legend = array(
    			0 => 'Other',
    			1 => 'Biological',
    			2 => 'Physical',
    			3 => 'Chemical',
    			4 => 'Allergen',
    			5 => 'Intentional Contamination / Intentional Adulteration',
    			6 => 'Economic Fraud',
                7 => 'Radiological',
                8 => 'Kosher',
                9 => 'Halal',
                10 => 'Organic violation'
    		);
    		$selectCategory = mysqli_query( $conn,"SELECT * FROM tbl_cam_category WHERE deleted = 0" );
    		$selectCategory_count = mysqli_num_rows($selectCategory);
        }

        // Category
        if (!empty($complaints) AND !empty($year) AND !empty($months)) {
            $complaints_arr = explode(',',$complaints);
            $years_arr = explode(',',$year);
            $months_arr = explode(',',$months);

            $dept_year_month = array();
            foreach($complaints_arr as $c) {
                $selectcomplaint = mysqli_query( $conn,"SELECT * FROM tbl_cam_complaint_category WHERE deleted = 0 AND ID = $c ORDER BY name" );
                if ( mysqli_num_rows($selectcomplaint) > 0 ) {
                    $rowDept = mysqli_fetch_array($selectcomplaint);

                    foreach($years_arr as $y) {
                        foreach($months_arr as $m) {
                            $rowComp   = DateTime::createFromFormat('!m', $m);
                            $monthName = $dateObj->format('F');
                            array_push($dept_year_month, $rowComp['title'] .' ('.$monthName.' '.$y.')');
                        }
                    }
                }
            }

            $category = $dept_year_month;
        } else if (!empty($departments) AND !empty($year) AND !empty($months)) {
            $departments_arr = explode(',',$departments);
            $years_arr = explode(',',$year);
            $months_arr = explode(',',$months);

            $dept_year_month = array();
            foreach($departments_arr as $d) {
                $selectDepartment = mysqli_query( $conn,"SELECT * FROM tbl_hr_department WHERE status = 1 AND ID = $d" );
                if ( mysqli_num_rows($selectDepartment) > 0 ) {
                    $rowDept = mysqli_fetch_array($selectDepartment);

                    foreach($years_arr as $y) {
                        foreach($months_arr as $m) {
                            $dateObj   = DateTime::createFromFormat('!m', $m);
                            $monthName = $dateObj->format('F');
                            array_push($dept_year_month, $rowDept['title'] .' ('.$monthName.' '.$y.')');
                        }
                    }
                }
            }

            $category = $dept_year_month;
        } else if (!empty($year) AND !empty($months)) {
            $years_arr = explode(',',$year);
            $months_arr = explode(',',$months);

            $year_month = array();
            foreach($years_arr as $y) {
                foreach($months_arr as $m) {
                    $dateObj   = DateTime::createFromFormat('!m', $m);
                    $monthName = $dateObj->format('F');
                    array_push($year_month, $monthName.' '.$y);
                }
            }

            $category = $year_month;
        } else if (!empty($complaints) AND !empty($year)) {
            $complaints_arr = explode(',',$complaints);
            $years_arr = explode(',',$year);

            $dept_year = array();
            foreach($complaints_arr as $c) {
                $selectcomplaint = mysqli_query( $conn,"SELECT * FROM tbl_cam_complaint_category WHERE deleted = 0 AND ID = $c ORDER BY name" );
                if ( mysqli_num_rows($selectcomplaint) > 0 ) {
                    $rowComp = mysqli_fetch_array($selectcomplaint);

                    foreach($years_arr as $y) {
                        array_push($dept_year, $rowComp['name'] .' ('. $y.')');
                    }
                }
            }

            $category = $dept_year;
        } else if (!empty($complaints) AND !empty($months)) {
            $complaints_arr = explode(',',$complaints);
            $months_arr = explode(',',$months);

            $dept_month = array();
            foreach($complaints_arr as $c) {
                $selectcomplaint = mysqli_query( $conn,"SELECT * FROM tbl_cam_complaint_category WHERE deleted = 0 AND ID = $c ORDER BY name" );
                if ( mysqli_num_rows($selectcomplaint) > 0 ) {
                    $rowComp = mysqli_fetch_array($selectcomplaint);

                    foreach($months_arr as $m) {
                        $dateObj   = DateTime::createFromFormat('!m', $m);
                        $monthName = $dateObj->format('F');
                        array_push($dept_month, $rowComp['name'] .' ('. $monthName.')');
                    }
                }
            }

            $category = $dept_month;
        } else if (!empty($departments) AND !empty($year)) {
            $departments_arr = explode(',',$departments);
            $years_arr = explode(',',$year);

            $dept_year = array();
            foreach($departments_arr as $d) {
                $selectDepartment = mysqli_query( $conn,"SELECT * FROM tbl_hr_department WHERE status = 1 AND ID = $d" );
                if ( mysqli_num_rows($selectDepartment) > 0 ) {
                    $rowDept = mysqli_fetch_array($selectDepartment);

                    foreach($years_arr as $y) {
                        array_push($dept_year, $rowDept['title'] .' ('. $y.')');
                    }
                }
            }

            $category = $dept_year;
        } else if (!empty($departments) AND !empty($months)) {
            $departments_arr = explode(',',$departments);
            $months_arr = explode(',',$months);

            $dept_month = array();
            foreach($departments_arr as $d) {
                $selectDepartment = mysqli_query( $conn,"SELECT * FROM tbl_hr_department WHERE status = 1 AND ID = $d" );
                if ( mysqli_num_rows($selectDepartment) > 0 ) {
                    $rowDept = mysqli_fetch_array($selectDepartment);

                    foreach($months_arr as $m) {
                        $dateObj   = DateTime::createFromFormat('!m', $m);
                        $monthName = $dateObj->format('F');
                        array_push($dept_month, $rowDept['title'] .' ('. $monthName.')');
                    }
                }
            }

            $category = $dept_month;
        } else {
            if (!empty($year)) {
                $years_arr = explode(',',$year);

                $category = $years_arr;
            } else if (!empty($months)) {
                $months_arr = explode(',',$months);
                $month_array = array();
                foreach($months_arr as $m) {
                    $dateObj   = DateTime::createFromFormat('!m', $m);
                    $monthName = $dateObj->format('F');
                    array_push($month_array, $monthName);
                }

                $category = $month_array;
            } else if (!empty($complaints)) {
                $complaints_arr = explode(',',$complaints);
                $complaint_array = array();
                foreach($complaints_arr as $c) {
                    $selectcomplaint = mysqli_query( $conn,"SELECT * FROM tbl_cam_complaint_category WHERE deleted = 0 AND ID = $c" );
                    if ( mysqli_num_rows($selectcomplaint) > 0 ) {
                        $rowComp = mysqli_fetch_array($selectcomplaint);
                        array_push($complaint_array, $rowComp['name']);
                    }
                }

                $category = $complaint_array;
            } else if (!empty($departments)) {
                $departments_arr = explode(',',$departments);
                $department_array = array();
                foreach($departments_arr as $d) {
                    $selectDepartment = mysqli_query( $conn,"SELECT * FROM tbl_hr_department WHERE status = 1 AND ID = $d" );
                    if ( mysqli_num_rows($selectDepartment) > 0 ) {
                        $rowDept = mysqli_fetch_array($selectDepartment);
                        array_push($department_array, $rowDept['title']);
                    }
                }

                $category = $department_array;
            } else {
                $category = ['All'];
            }
        }

        // Series Data
        $serries_array = array();
        $record = 0;
        if ($val == 'statusAll') {
            if ($current_client == 1) {
                if ($selectProgram_count > 0) {
                    while ($rowProgram = mysqli_fetch_array($selectProgram)) {
                        $l_ID = $rowProgram['l_ID'];
                        $l_name = $rowProgram['l_name'];

                        for ($x=0; $x < 2 ; $x++) { 
                            $count_program_arr = array();
                            if (!empty($complaints) AND !empty($year) AND !empty($months)) {
                                foreach($complaints_arr as $complaints_value) {
                                    foreach($years_arr as $year_value) {
                                        foreach($months_arr as $months_value) {
                                            $count_program = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = $x AND FIND_IN_SET($complaints_value, REPLACE(complaint_id, ' ', '')) > 0 AND YEAR(date) = $year_value AND MONTH(date) = $months_value AND user_id = $user_id" ));
                                            $count_program2 = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_complaint_records WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = $x AND FIND_IN_SET($complaints_value, REPLACE(complaint_category, ' ', '')) > 0 AND YEAR(care_date) = $year_value AND MONTH(care_date) = $months_value AND deleted = 0 AND capam = 1 AND care_ownedby = $user_id" ));
                                            array_push($count_program_arr, $count_program + $count_program2);
                                        }
                                    }
                                }
                            } else if (!empty($departments) AND !empty($year) AND !empty($months)) {
                                foreach($departments_arr as $departments_value) {
                                    foreach($years_arr as $year_value) {
                                        foreach($months_arr as $months_value) {
                                            $count_program = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = $x AND FIND_IN_SET($departments_value, REPLACE(department_id, ' ', '')) > 0 AND YEAR(date) = $year_value AND MONTH(date) = $months_value AND user_id = $user_id" ));
                                            $count_program2 = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_complaint_records WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = $x AND FIND_IN_SET($departments_value, REPLACE(department_id, ' ', '')) > 0 AND YEAR(care_date) = $year_value AND MONTH(care_date) = $months_value AND deleted = 0 AND capam = 1 AND care_ownedby = $user_id" ));
                                            array_push($count_program_arr, $count_program + $count_program2);
                                        }
                                    }
                                }
                            } else if (!empty($year) AND !empty($months)) {
                                foreach($years_arr as $year_value) {
                                    foreach($months_arr as $months_value) {
                                        $count_program = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = $x AND YEAR(date) = $year_value AND MONTH(date) = $months_value AND user_id = $user_id" ));
                                        $count_program2 = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_complaint_records WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = $x AND YEAR(care_date) = $year_value AND MONTH(care_date) = $months_value AND deleted = 0 AND capam = 1 AND care_ownedby = $user_id" ));
                                        array_push($count_program_arr, $count_program + $count_program2);
                                    }
                                }
                            } else if (!empty($complaints) AND !empty($year)) {
                                foreach($complaints_arr as $complaints_value) {
                                    foreach($years_arr as $year_value) {
                                        $count_program = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = $x AND FIND_IN_SET($complaints_value, REPLACE(complaint_id, ' ', '')) > 0 AND YEAR(date) = $year_value AND user_id = $user_id" ));
                                        $count_program2 = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_complaint_records WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = $x AND FIND_IN_SET($complaints_value, REPLACE(complaint_category, ' ', '')) > 0 AND YEAR(care_date) = $year_value AND deleted = 0 AND capam = 1 AND care_ownedby = $user_id" ));
                                        array_push($count_program_arr, $count_program + $count_program2);
                                    }
                                }
                            } else if (!empty($complaints) AND !empty($months)) {
                                foreach($complaints_arr as $complaints_value) {
                                    foreach($months_arr as $months_value) {
                                        $count_program = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = $x AND FIND_IN_SET($complaints_value, REPLACE(complaint_id, ' ', '')) > 0 AND MONTH(date) = $months_value AND user_id = $user_id" ));
                                        $count_program2 = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_complaint_records WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = $x AND FIND_IN_SET($complaints_value, REPLACE(complaint_category, ' ', '')) > 0 AND MONTH(care_date) = $months_value AND deleted = 0 AND capam = 1 AND care_ownedby = $user_id" ));
                                        array_push($count_program_arr, $count_program + $count_program2);
                                    }
                                }
                            } else if (!empty($departments) AND !empty($year)) {
                                foreach($departments_arr as $departments_value) {
                                    foreach($years_arr as $year_value) {
                                        $count_program = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = $x AND FIND_IN_SET($departments_value, REPLACE(department_id, ' ', '')) > 0 AND YEAR(date) = $year_value AND user_id = $user_id" ));
                                        $count_program2 = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_complaint_records WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = $x AND FIND_IN_SET($departments_value, REPLACE(department_id, ' ', '')) > 0 AND YEAR(care_date) = $year_value AND deleted = 0 AND capam = 1 AND care_ownedby = $user_id" ));
                                        array_push($count_program_arr, $count_program + $count_program2);
                                    }
                                }
                            } else if (!empty($departments) AND !empty($months)) {
                                foreach($departments_arr as $departments_value) {
                                    foreach($months_arr as $months_value) {
                                        $count_program = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = $x AND FIND_IN_SET($departments_value, REPLACE(department_id, ' ', '')) > 0 AND MONTH(date) = $months_value AND user_id = $user_id" ));
                                        $count_program2 = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_complaint_records WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = $x AND FIND_IN_SET($departments_value, REPLACE(department_id, ' ', '')) > 0 AND MONTH(care_date) = $months_value AND deleted = 0 AND capam = 1 AND care_ownedby = $user_id" ));
                                        array_push($count_program_arr, $count_program + $count_program2);
                                    }
                                }
                            } else {
                                if (!empty($year)) {
                                    foreach($years_arr as $year_value) {
                                        $count_program = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = $x AND YEAR(date) = $year_value AND user_id = $user_id" ));
                                        $count_program2 = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_complaint_records WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = $x AND YEAR(care_date) = $year_value AND deleted = 0 AND capam = 1 AND care_ownedby = $user_id" ));
                                        array_push($count_program_arr, $count_program + $count_program2);
                                    }
                                } else if (!empty($months)) {
                                    foreach($months_arr as $months_value) {
                                        $count_program = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = $x AND MONTH(date) = $months_value AND user_id = $user_id" ));
                                        $count_program2 = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_complaint_records WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = $x AND MONTH(care_date) = $months_value AND deleted = 0 AND capam = 1 AND care_ownedby = $user_id" ));
                                        array_push($count_program_arr, $count_program + $count_program2);
                                    }
                                } else if (!empty($complaints)) {
                                    foreach($complaints_arr as $complaints_value) {
                                        $count_program = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = $x AND FIND_IN_SET($complaints_value, REPLACE(complaint_id, ' ', '')) > 0 AND user_id = $user_id" ));
                                        $count_program2 = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_complaint_records WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = $x AND FIND_IN_SET($complaints_value, REPLACE(complaint_category, ' ', '')) > 0 AND deleted = 0 AND capam = 1 AND care_ownedby = $user_id" ));
                                        array_push($count_program_arr, $count_program + $count_program2);
                                    }
                                } else if (!empty($departments)) {
                                    foreach($departments_arr as $departments_value) {
                                        $count_program = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = $x AND FIND_IN_SET($departments_value, REPLACE(department_id, ' ', '')) > 0 AND user_id = $user_id" ));
                                        $count_program2 = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_complaint_records WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = $x AND FIND_IN_SET($departments_value, REPLACE(department_id, ' ', '')) > 0 AND deleted = 0 AND capam = 1 AND care_ownedby = $user_id" ));
                                        array_push($count_program_arr, $count_program + $count_program2);
                                    }
                                } else {
                                    $count_program = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = $x AND user_id = $user_id" ));
                                    $count_program2 = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_complaint_records WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = $x AND deleted = 0 AND capam = 1 AND care_ownedby = $user_id" ));
                                    array_push($count_program_arr, $count_program + $count_program2);
                                }
                            }

                            if ($x == 0) {
                                $series_data = array(
                                    'id' => 'g'.$record,
                                    'name' => 'Open',
                                    'data' => $count_program_arr,
                                    'stack' => $l_name
                                );
                            } else {
                                $series_data = array(
                                    'linkedTo' => 'g'.$record,
                                    'color' => '#e7505a',
                                    'name' => 'Close',
                                    'data' => $count_program_arr,
                                    'stack' => $l_name
                                );
                            }
                            array_push($serries_array, $series_data);
                        }
                        $record++;
                    }
                }
            } else {
                for ($i=0; $i < $selectCategory_count; $i++) {
                    for ($x=0; $x < 2 ; $x++) {
                        $count_category_arr = array();
                        if (!empty($year) AND !empty($months)) {
                            foreach($years_arr as $year_value) {
                                foreach($months_arr as $months_value) {
                                    $count_category = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE category_id REGEXP $i AND status = $x AND YEAR(date) = $year_value AND MONTH(date) = $months_value AND user_id = $user_id" ));
                                    array_push($count_category_arr, $count_category);
                                }
                            }
                        } else {
                            if (!empty($year)) {
                                foreach($years_arr as $year_value) {
                                    $count_category = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE category_id REGEXP $i AND status = $x AND YEAR(date) = $year_value AND user_id = $user_id" ));
                                    array_push($count_category_arr, $count_category);
                                }
                            } else if (!empty($months)) {
                                foreach($months_arr as $months_value) {
                                    $count_category = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE category_id REGEXP $i AND status = $x AND MONTH(date) = $months_value AND user_id = $user_id" ));
                                    array_push($count_category_arr, $count_category);
                                }
                            } else {
                                $count_category = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE category_id REGEXP $i AND status = $x AND user_id = $user_id" ));
                                array_push($count_category_arr, $count_category);
                            }
                        }

                        if ($x == 0) {
                            $series_data = array(
                                'id' => 'g'.$record,
                                'name' => 'Open',
                                'data' => $count_category_arr,
                                'stack' => $legend[$i]
                            );
                        } else {
                            $series_data = array(
                                'linkedTo' => 'g'.$record,
                                'color' => '#e7505a',
                                'name' => 'Close',
                                'data' => $count_category_arr,
                                'stack' => $legend[$i]
                            );
                        }
                        array_push($serries_array, $series_data);
                    }
                    $record++;
                }
            }
        } else if ($val == 'statusOpen') {
            if ($current_client == 1) {
                if ($selectProgram_count > 0) {
                    while ($rowProgram = mysqli_fetch_array($selectProgram)) {
                        $l_ID = $rowProgram['l_ID'];
                        $l_name = $rowProgram['l_name'];

                        $count_program_arr = array();
                        if (!empty($complaints) AND !empty($year) AND !empty($months)) {
                            foreach($complaints_arr as $complaints_value) {
                                foreach($years_arr as $year_value) {
                                    foreach($months_arr as $months_value) {
                                        $count_program = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = 0 AND FIND_IN_SET($complaints_value, REPLACE(complaint_id, ' ', '')) > 0 AND YEAR(date) = $year_value AND MONTH(date) = $months_value AND user_id = $user_id" ));
                                        $count_program2 = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_complaint_records WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = 0 AND FIND_IN_SET($complaints_value, REPLACE(complaint_category, ' ', '')) > 0 AND YEAR(care_date) = $year_value AND MONTH(care_date) = $months_value AND deleted = 0 AND capam = 1 AND care_ownedby = $user_id" ));
                                        array_push($count_program_arr, $count_program + $count_program2);
                                    }
                                }
                            }
                        } else if (!empty($departments) AND !empty($year) AND !empty($months)) {
                            foreach($departments_arr as $departments_value) {
                                foreach($years_arr as $year_value) {
                                    foreach($months_arr as $months_value) {
                                        $count_program = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = 0 AND FIND_IN_SET($departments_value, REPLACE(department_id, ' ', '')) > 0 AND YEAR(date) = $year_value AND MONTH(date) = $months_value AND user_id = $user_id" ));
                                        $count_program2 = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_complaint_records WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = 0 AND FIND_IN_SET($departments_value, REPLACE(department_id, ' ', '')) > 0 AND YEAR(care_date) = $year_value AND MONTH(care_date) = $months_value AND deleted = 0 AND capam = 1 AND care_ownedby = $user_id" ));
                                        array_push($count_program_arr, $count_program + $count_program2);
                                    }
                                }
                            }
                        } else if (!empty($year) AND !empty($months)) {
                            foreach($years_arr as $year_value) {
                                foreach($months_arr as $months_value) {
                                    $count_program = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = 0 AND YEAR(date) = $year_value AND MONTH(date) = $months_value AND user_id = $user_id" ));
                                    $count_program2 = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_complaint_records WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = 0 AND YEAR(care_date) = $year_value AND MONTH(care_date) = $months_value AND deleted = 0 AND capam = 1 AND care_ownedby = $user_id" ));
                                    array_push($count_program_arr, $count_program + $count_program2);
                                }
                            }
                        } else if (!empty($complaints) AND !empty($year)) {
                            foreach($complaints_arr as $complaints_value) {
                                foreach($years_arr as $year_value) {
                                    $count_program = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = 0 AND FIND_IN_SET($complaints_value, REPLACE(complaint_id, ' ', '')) > 0 AND YEAR(date) = $year_value AND user_id = $user_id" ));
                                    $count_program2 = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_complaint_records WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = 0 AND FIND_IN_SET($departments_value, REPLACE(complaint_category, ' ', '')) > 0 AND YEAR(care_date) = $year_value AND deleted = 0 AND capam = 1 AND care_ownedby = $user_id" ));
                                    array_push($count_program_arr, $count_program + $count_program2);
                                }
                            }
                        } else if (!empty($complaints) AND !empty($months)) {
                            foreach($complaints_arr as $complaints_value) {
                                foreach($months_arr as $months_value) {
                                    $count_program = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = 0 AND FIND_IN_SET($complaints_value, REPLACE(complaint_id, ' ', '')) > 0 AND MONTH(date) = $months_value AND user_id = $user_id" ));
                                    $count_program2 = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_complaint_records WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = 0 AND FIND_IN_SET($complaints_value, REPLACE(complaint_category, ' ', '')) > 0 AND MONTH(care_date) = $months_value AND deleted = 0 AND capam = 1 AND care_ownedby = $user_id" ));
                                    array_push($count_program_arr, $count_program + $count_program2);
                                }
                            }
                        } else if (!empty($departments) AND !empty($year)) {
                            foreach($departments_arr as $departments_value) {
                                foreach($years_arr as $year_value) {
                                    $count_program = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = 0 AND FIND_IN_SET($departments_value, REPLACE(department_id, ' ', '')) > 0 AND YEAR(date) = $year_value AND user_id = $user_id" ));
                                    $count_program2 = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_complaint_records WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = 0 AND FIND_IN_SET($departments_value, REPLACE(department_id, ' ', '')) > 0 AND YEAR(care_date) = $year_value AND deleted = 0 AND capam = 1 AND care_ownedby = $user_id" ));
                                    array_push($count_program_arr, $count_program + $count_program2);
                                }
                            }
                        } else if (!empty($departments) AND !empty($months)) {
                            foreach($departments_arr as $departments_value) {
                                foreach($months_arr as $months_value) {
                                    $count_program = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = 0 AND FIND_IN_SET($departments_value, REPLACE(department_id, ' ', '')) > 0 AND MONTH(date) = $months_value AND user_id = $user_id" ));
                                    $count_program2 = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_complaint_records WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = 0 AND FIND_IN_SET($departments_value, REPLACE(department_id, ' ', '')) > 0 AND MONTH(care_date) = $months_value AND deleted = 0 AND capam = 1 AND care_ownedby = $user_id" ));
                                    array_push($count_program_arr, $count_program + $count_program2);
                                }
                            }
                        } else {
                            if (!empty($year)) {
                                foreach($years_arr as $year_value) {
                                    $count_program = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = 0 AND YEAR(date) = $year_value AND user_id = $user_id" ));
                                    $count_program2 = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_complaint_records WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = 0 AND YEAR(care_date) = $year_value AND deleted = 0 AND capam = 1 AND care_ownedby = $user_id" ));
                                    array_push($count_program_arr, $count_program + $count_program2);
                                }
                            } else if (!empty($months)) {
                                foreach($months_arr as $months_value) {
                                    $count_program = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = 0 AND MONTH(date) = $months_value AND user_id = $user_id" ));
                                    $count_program2 = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_complaint_records WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = 0 AND MONTH(care_date) = $months_value AND deleted = 0 AND capam = 1 AND care_ownedby = $user_id" ));
                                    array_push($count_program_arr, $count_program + $count_program2);
                                }
                            } else if (!empty($complaints)) {
                                foreach($complaints_arr as $complaints_value) {
                                    $count_program = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = 0 AND FIND_IN_SET($complaints_value, REPLACE(complaint_id, ' ', '')) > 0 AND user_id = $user_id" ));
                                    $count_program2 = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_complaint_records WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = 0 AND FIND_IN_SET($complaints_value, REPLACE(complaint_category, ' ', '')) > 0 deleted = 0 AND capam = 1 AND care_ownedby = $user_id" ));
                                    array_push($count_program_arr, $count_program + $count_program2);
                                }
                            } else if (!empty($departments)) {
                                foreach($departments_arr as $departments_value) {
                                    $count_program = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = 0 AND FIND_IN_SET($departments_value, REPLACE(department_id, ' ', '')) > 0 AND user_id = $user_id" ));
                                    $count_program2 = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_complaint_records WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = 0 AND FIND_IN_SET($departments_value, REPLACE(department_id, ' ', '')) > 0 deleted = 0 AND capam = 1 AND care_ownedby = $user_id" ));
                                    array_push($count_program_arr, $count_program + $count_program2);
                                }
                            } else {
                                $count_program = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = 0 AND user_id = $user_id" ));
                                $count_program2 = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_complaint_records WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = 0 AND deleted = 0 AND capam = 1 AND care_ownedby = $user_id" ));
                                array_push($count_program_arr, $count_program + $count_program2);
                            }
                        }

                        $series_data = array(
                            'id' => 'g'.$record++,
                            'name' => 'Open',
                            'data' => $count_program_arr,
                            'stack' => $l_name
                        );
                        array_push($serries_array, $series_data);
                    }
                }
            } else {
                for ($i=0; $i < $selectCategory_count; $i++) {
                    $count_category_arr = array();
                    if (!empty($year) AND !empty($months)) {
                        foreach($years_arr as $year_value) {
                            foreach($months_arr as $months_value) {
                                $count_category = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE category_id REGEXP $i AND status = 0 AND YEAR(date) = $year_value AND MONTH(date) = $months_value AND user_id = $user_id" ));
                                array_push($count_category_arr, $count_category);
                            }
                        }
                    } else {
                        if (!empty($year)) {
                            foreach($years_arr as $year_value) {
                                $count_category = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE category_id REGEXP $i AND status = 0 AND YEAR(date) = $year_value AND user_id = $user_id" ));
                                array_push($count_category_arr, $count_category);
                            }
                        } else if (!empty($months)) {
                            foreach($months_arr as $months_value) {
                                $count_category = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE category_id REGEXP $i AND status = 0 AND MONTH(date) = $months_value AND user_id = $user_id" ));
                                array_push($count_category_arr, $count_category);
                            }
                        } else {
                            $count_category = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE category_id REGEXP $i AND status = 0 AND user_id = $user_id" ));
                            array_push($count_category_arr, $count_category);
                        }
                    }

                    $series_data = array(
                        'id' => 'g'.$record++,
                        'name' => 'Open',
                        'data' => $count_category_arr,
                        'stack' => $legend[$i]
                    );
                    array_push($serries_array, $series_data);
                }
            }
        } else if ($val == 'statusClose') {
            if ($current_client == 1) {
                if ($selectProgram_count > 0) {
                    while ($rowProgram = mysqli_fetch_array($selectProgram)) {
                        $l_ID = $rowProgram['l_ID'];
                        $l_name = $rowProgram['l_name'];

                        $count_program_arr = array();
                        if (!empty($complaints) AND !empty($year) AND !empty($months)) {
                            foreach($complaints_arr as $complaints_value) {
                                foreach($years_arr as $year_value) {
                                    foreach($months_arr as $months_value) {
                                        $count_program = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = 1 AND FIND_IN_SET($complaints_value, REPLACE(complaint_id, ' ', '')) > 0 AND YEAR(date) = $year_value AND MONTH(date) = $months_value AND user_id = $user_id" ));
                                        $count_program2 = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_complaint_records WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = 1 AND FIND_IN_SET($complaints_value, REPLACE(complaint_category, ' ', '')) > 0 AND YEAR(care_date) = $year_value AND MONTH(care_date) = $months_value AND deleted = 0 AND capam = 1 AND care_ownedby = $user_id" ));
                                        array_push($count_program_arr, $count_program + $count_program2);
                                    }
                                }
                            }
                        } else if (!empty($departments) AND !empty($year) AND !empty($months)) {
                            foreach($departments_arr as $departments_value) {
                                foreach($years_arr as $year_value) {
                                    foreach($months_arr as $months_value) {
                                        $count_program = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = 1 AND FIND_IN_SET($departments_value, REPLACE(department_id, ' ', '')) > 0 AND YEAR(date) = $year_value AND MONTH(date) = $months_value AND user_id = $user_id" ));
                                        $count_program2 = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_complaint_records WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = 1 AND FIND_IN_SET($departments_value, REPLACE(department_id, ' ', '')) > 0 AND YEAR(care_date) = $year_value AND MONTH(care_date) = $months_value AND deleted = 0 AND capam = 1 AND care_ownedby = $user_id" ));
                                        array_push($count_program_arr, $count_program + $count_program2);
                                    }
                                }
                            }
                        } else if (!empty($year) AND !empty($months)) {
                            foreach($years_arr as $year_value) {
                                foreach($months_arr as $months_value) {
                                    $count_program = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = 1 AND YEAR(date) = $year_value AND MONTH(date) = $months_value AND user_id = $user_id" ));
                                    $count_program2 = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_complaint_records WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = 1 AND YEAR(care_date) = $year_value AND MONTH(care_date) = $months_value AND deleted = 0 AND capam = 1 AND care_ownedby = $user_id" ));
                                    array_push($count_program_arr, $count_program + $count_program2);
                                }
                            }
                        } else if (!empty($complaints) AND !empty($year)) {
                            foreach($complaints_arr as $complaints_value) {
                                foreach($years_arr as $year_value) {
                                    $count_program = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = 1 AND FIND_IN_SET($complaints_value, REPLACE(complaint_id, ' ', '')) > 0 AND YEAR(date) = $year_value AND user_id = $user_id" ));
                                    $count_program2 = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_complaint_records WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = 1 AND FIND_IN_SET($complaints_value, REPLACE(complaint_category, ' ', '')) > 0 AND YEAR(care_date) = $year_value AND deleted = 0 AND capam = 1 AND care_ownedby = $user_id" ));
                                    array_push($count_program_arr, $count_program + $count_program2);
                                }
                            }
                        } else if (!empty($complaints) AND !empty($months)) {
                            foreach($complaints_arr as $complaints_value) {
                                foreach($months_arr as $months_value) {
                                    $count_program = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = 1 AND FIND_IN_SET($complaints_value, REPLACE(complaint_id, ' ', '')) > 0 AND MONTH(date) = $months_value AND user_id = $user_id" ));
                                    $count_program2 = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_complaint_records WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = 1 AND FIND_IN_SET($complaints_value, REPLACE(complaint_category, ' ', '')) > 0 AND MONTH(care_date) = $months_value AND deleted = 0 AND capam = 1 AND care_ownedby = $user_id" ));
                                    array_push($count_program_arr, $count_program + $count_program2);
                                }
                            }
                        } else if (!empty($departments) AND !empty($year)) {
                            foreach($departments_arr as $departments_value) {
                                foreach($years_arr as $year_value) {
                                    $count_program = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = 1 AND FIND_IN_SET($departments_value, REPLACE(department_id, ' ', '')) > 0 AND YEAR(date) = $year_value AND user_id = $user_id" ));
                                    $count_program2 = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_complaint_records WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = 1 AND FIND_IN_SET($departments_value, REPLACE(department_id, ' ', '')) > 0 AND YEAR(care_date) = $year_value AND deleted = 0 AND capam = 1 AND care_ownedby = $user_id" ));
                                    array_push($count_program_arr, $count_program + $count_program2);
                                }
                            }
                        } else if (!empty($departments) AND !empty($months)) {
                            foreach($departments_arr as $departments_value) {
                                foreach($months_arr as $months_value) {
                                    $count_program = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = 1 AND FIND_IN_SET($departments_value, REPLACE(department_id, ' ', '')) > 0 AND MONTH(date) = $months_value AND user_id = $user_id" ));
                                    $count_program2 = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_complaint_records WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = 1 AND FIND_IN_SET($departments_value, REPLACE(department_id, ' ', '')) > 0 AND MONTH(care_date) = $months_value AND deleted = 0 AND capam = 1 AND care_ownedby = $user_id" ));
                                    array_push($count_program_arr, $count_program + $count_program2);
                                }
                            }
                        } else {
                            if (!empty($year)) {
                                foreach($years_arr as $year_value) {
                                    $count_program = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = 1 AND YEAR(date) = $year_value AND user_id = $user_id" ));
                                    $count_program2 = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_complaint_records WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = 1 AND YEAR(care_date) = $year_value AND deleted = 0 AND capam = 1 AND care_ownedby = $user_id" ));
                                    array_push($count_program_arr, $count_program + $count_program2);
                                }
                            } else if (!empty($months)) {
                                foreach($months_arr as $months_value) {
                                    $count_program = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = 1 AND MONTH(date) = $months_value AND user_id = $user_id" ));
                                    $count_program2 = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_complaint_records WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 1 AND status = 0 AND MONTH(care_date) = $months_value AND deleted = 0 AND capam = 1 AND care_ownedby = $user_id" ));
                                    array_push($count_program_arr, $count_program + $count_program2);
                                }
                            } else if (!empty($complaints)) {
                                foreach($complaints_arr as $complaints_value) {
                                    $count_program = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = 1 AND FIND_IN_SET($complaints_value, REPLACE(complaint_id, ' ', '')) > 0 AND user_id = $user_id" ));
                                    $count_program2 = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_complaint_records WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 1 AND status = 0 AND FIND_IN_SET($complaints_value, REPLACE(complaint_category, ' ', '')) > 0 deleted = 0 AND capam = 1 AND care_ownedby = $user_id" ));
                                    array_push($count_program_arr, $count_program + $count_program2);
                                }
                            } else if (!empty($departments)) {
                                foreach($departments_arr as $departments_value) {
                                    $count_program = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = 1 AND FIND_IN_SET($departments_value, REPLACE(department_id, ' ', '')) > 0 AND user_id = $user_id" ));
                                    $count_program2 = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_complaint_records WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 1 AND status = 0 AND FIND_IN_SET($departments_value, REPLACE(department_id, ' ', '')) > 0 deleted = 0 AND capam = 1 AND care_ownedby = $user_id" ));
                                    array_push($count_program_arr, $count_program + $count_program2);
                                }
                            } else {
                                $count_program = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = 1 AND user_id = $user_id" ));
                                $count_program2 = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_complaint_records WHERE FIND_IN_SET($l_ID, REPLACE(program_id, ' ', '')) > 0 AND status = 1 AND deleted = 0 AND capam = 1 AND care_ownedby = $user_id" ));
                                array_push($count_program_arr, $count_program + $count_program2);
                            }
                        }

                        $series_data = array(
                            'id' => 'g'.$record++,
                            'name' => 'Close',
                            'data' => $count_program_arr,
                            'stack' => $l_name
                        );
                        array_push($serries_array, $series_data);
                    }
                }
            } else {
                for ($i=0; $i < $selectCategory_count; $i++) {
                    $count_category_arr = array();
                    if (!empty($year) AND !empty($months)) {
                        foreach($years_arr as $year_value) {
                            foreach($months_arr as $months_value) {
                                $count_category = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE category_id REGEXP $i AND status = 1 AND YEAR(date) = $year_value AND MONTH(date) = $months_value AND user_id = $user_id" ));
                                array_push($count_category_arr, $count_category);
                            }
                        }
                    } else {
                        if (!empty($year)) {
                            foreach($years_arr as $year_value) {
                                $count_category = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE category_id REGEXP $i AND status = 1 AND YEAR(date) = $year_value AND user_id = $user_id" ));
                                array_push($count_category_arr, $count_category);
                            }
                        } else if (!empty($months)) {
                            foreach($months_arr as $months_value) {
                                $count_category = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE category_id REGEXP $i AND status = 1 AND MONTH(date) = $months_value AND user_id = $user_id" ));
                                array_push($count_category_arr, $count_category);
                            }
                        } else {
                            $count_category = mysqli_num_rows(mysqli_query( $conn,"SELECT * FROM tbl_cam WHERE category_id REGEXP $i AND status = 1 AND user_id = $user_id" ));
                            array_push($count_category_arr, $count_category);
                        }
                    }

                    $series_data = array(
                        'id' => 'g'.$record++,
                        'name' => 'Close',
                        'data' => $count_category_arr,
                        'stack' => $legend[$i]
                    );
                    array_push($serries_array, $series_data);
                }
            }
        }

        $output = array(
			"category" => $category,
			"series" => $serries_array
		);
		echo json_encode($output);
	}
    if( isset($_POST['btnSave_CAM']) ) {

        $current_client = 0;
        if (isset($_COOKIE['client'])) { $current_client = $_COOKIE['client']; }

        if (!empty($_COOKIE['switchAccount'])) {
            $portal_user = $_COOKIE['ID'];
            $user_id = $_COOKIE['switchAccount'];
        }
        else {
            $portal_user = $_COOKIE['ID'];
            $user_id = employerID($portal_user);
        }

        $product_related = $_POST['product_related'];
        $date = $_POST['date'];
        $time = $_POST['time'];
        $observed_by = $_POST['observed_by'];
        $reported_by = $_POST['reported_by'];
        $reference = $_POST['reference'];
        $description = addslashes($_POST['description']);
        $process = true;

        $program_id = "";
        if (!empty($_POST["program_id"])) { $program_id = implode(", ", $_POST["program_id"]); }

        $complaint_id = "";
        if (!empty($_POST["complaint_id"])) { $complaint_id = implode(", ", $_POST["complaint_id"]); }

        $complaint_other = "";
        if (!empty($_POST['complaint_other'])) { $complaint_other = addslashes($_POST['complaint_other']); }

        $category_id = "";
        if (!empty($_POST["category_id"])) { $category_id = implode(", ", $_POST["category_id"]); }

        $category_other = "";
        if (!empty($_POST['category_other'])) { $category_other = addslashes($_POST['category_other']); }
        
        if (!empty($_POST["department_id"])) { $department_id = implode(", ", $_POST["department_id"]); }
        else { $department_id = ""; }
        $department_other = addslashes($_POST['department_other']);

        $employee_id = '';
        if (!empty($_POST['employee_id'])) { $employee_id = implode(",",$_POST['employee_id']); }

        $trend = '';
        if (!empty($_POST['trend'])) {
            $arr_item = array();
            for ($i=0; $i < count($_POST['trend']); $i++) {
                $trend_desc = addslashes($_POST['trend'][$i]['trend_desc']);
                array_push($arr_item, $trend_desc);
            }
            $trend = implode(' | ', $arr_item);
        }

        $observation = addslashes($_POST['observation_desc']);
        $observation_file = '';
        if (!empty($_FILES['observation']['name'])) {
            $arr_item = array();
            for ($i=0; $i < count($_FILES['observation']['name']); $i++) {
                $file_name = implode('*', $_FILES['observation']['name'][$i]);
                if (!empty($file_name)) {
                    $tmp = implode('*', $_FILES['observation']['tmp_name'][$i]);
                    $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                    $ext = strtolower(pathinfo($file_name, PATHINFO_EXTENSION));
                    $path = 'uploads/cam/';
                    $random = rand(1000,1000000);
                    $files = $random . ' - ' . $file_name;
                    $path = $path.$files;

                    if(!in_array($ext, $invalid_extensions)) {
                        move_uploaded_file($tmp, $path);

                        array_push($arr_item, $files);
                    } else {
                        $process = false;
                    }
                }
            }
            $observation_file = implode(' | ', $arr_item);
        }

        $root_cause = addslashes($_POST['root_cause_desc']);
        $root_cause_file = '';
        if (!empty($_FILES['root_cause']['name'])) {
            $arr_item = array();
            for ($i=0; $i < count($_FILES['root_cause']['name']); $i++) {
                $file_name = implode('*', $_FILES['root_cause']['name'][$i]);
                if (!empty($file_name)) {
                    $tmp = implode('*', $_FILES['root_cause']['tmp_name'][$i]);
                    $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                    $ext = strtolower(pathinfo($file_name, PATHINFO_EXTENSION));
                    $path = 'uploads/cam/';
                    $random = rand(1000,1000000);
                    $files = $random . ' - ' . $file_name;
                    $path = $path.$files;

                    if(!in_array($ext, $invalid_extensions)) {
                        move_uploaded_file($tmp, $path);

                        array_push($arr_item, $files);
                    } else {
                        $process = false;
                    }
                }
            }
            $root_cause_file = implode(' | ', $arr_item);
        }

        $corrective_status = $_POST['corrective_status'];
        $corrective_desc = addslashes($_POST['corrective_desc']);
        $corrective_date = $_POST['corrective_date'];
        $corrective_time = $_POST['corrective_time'];
        $corrective_by = $_POST['corrective_by'];
        $corrective_file = '';
        if (!empty($_FILES['corrective']['name'])) {
            $arr_item = array();
            for ($i=0; $i < count($_FILES['corrective']['name']); $i++) {
                $file_name = implode('*', $_FILES['corrective']['name'][$i]);
                if (!empty($file_name)) {
                    $tmp = implode('*', $_FILES['corrective']['tmp_name'][$i]);
                    $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                    $ext = strtolower(pathinfo($file_name, PATHINFO_EXTENSION));
                    $path = 'uploads/cam/';
                    $random = rand(1000,1000000);
                    $files = $random . ' - ' . $file_name;
                    $path = $path.$files;

                    if(!in_array($ext, $invalid_extensions)) {
                        move_uploaded_file($tmp, $path);

                        array_push($arr_item, $files);
                    } else {
                        $process = false;
                    }
                }
            }
            $corrective_file = implode(' | ', $arr_item);
        }

        $implementation_status = $_POST['implementation_status'];
        $implementation_desc = addslashes($_POST['implementation_desc']);
        $implementation_date = $_POST['implementation_date'];
        $implementation_by = addslashes($_POST['implementation_by']);
        $implementation_file = '';
        if (!empty($_FILES['implementation']['name'])) {
            $arr_item = array();
            for ($i=0; $i < count($_FILES['implementation']['name']); $i++) {
                $file_name = implode('*', $_FILES['implementation']['name'][$i]);
                if (!empty($file_name)) {
                    $tmp = implode('*', $_FILES['implementation']['tmp_name'][$i]);
                    $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                    $ext = strtolower(pathinfo($file_name, PATHINFO_EXTENSION));
                    $path = 'uploads/cam/';
                    $random = rand(1000,1000000);
                    $files = $random . ' - ' . $file_name;
                    $path = $path.$files;

                    if(!in_array($ext, $invalid_extensions)) {
                        move_uploaded_file($tmp, $path);

                        array_push($arr_item, $files);
                    } else {
                        $process = false;
                    }
                }
            }
            $implementation_file = implode(' | ', $arr_item);
        }

        $preventive_status = $_POST['preventive_status'];
        $preventive_desc = addslashes($_POST['preventive_desc']);
        $preventive_file = '';
        if (!empty($_FILES['preventive']['name'])) {
            $arr_item = array();
            for ($i=0; $i < count($_FILES['preventive']['name']); $i++) {
                $file_name = implode('*', $_FILES['preventive']['name'][$i]);
                if (!empty($file_name)) {
                    $tmp = implode('*', $_FILES['preventive']['tmp_name'][$i]);
                    $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                    $ext = strtolower(pathinfo($file_name, PATHINFO_EXTENSION));
                    $path = 'uploads/cam/';
                    $random = rand(1000,1000000);
                    $files = $random . ' - ' . $file_name;
                    $path = $path.$files;

                    if(!in_array($ext, $invalid_extensions)) {
                        move_uploaded_file($tmp, $path);

                        array_push($arr_item, $files);
                    } else {
                        $process = false;
                    }
                }
            }
            $preventive_file = implode(' | ', $arr_item);
        }

        $evaluation_status = $_POST['evaluation_status'];
        $evaluation_desc = addslashes($_POST['evaluation_desc']);
        $evaluation_file = '';
        if (!empty($_FILES['evaluation']['name'])) {
            $arr_item = array();
            for ($i=0; $i < count($_FILES['evaluation']['name']); $i++) {
                $file_name = implode('*', $_FILES['evaluation']['name'][$i]);
                if (!empty($file_name)) {
                    $tmp = implode('*', $_FILES['evaluation']['tmp_name'][$i]);
                    $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                    $ext = strtolower(pathinfo($file_name, PATHINFO_EXTENSION));
                    $path = 'uploads/cam/';
                    $random = rand(1000,1000000);
                    $files = $random . ' - ' . $file_name;
                    $path = $path.$files;

                    if(!in_array($ext, $invalid_extensions)) {
                        move_uploaded_file($tmp, $path);

                        array_push($arr_item, $files);
                    } else {
                        $process = false;
                    }
                }
            }
            $evaluation_file = implode(' | ', $arr_item);
        }

        $comment = addslashes($_POST['comment_desc']);
        $comment_file = '';
        if (!empty($_FILES['comment']['name'])) {
            $arr_item = array();
            for ($i=0; $i < count($_FILES['comment']['name']); $i++) {
                $file_name = implode('*', $_FILES['comment']['name'][$i]);
                if (!empty($file_name)) {
                    $tmp = implode('*', $_FILES['comment']['tmp_name'][$i]);
                    $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                    $ext = strtolower(pathinfo($file_name, PATHINFO_EXTENSION));
                    $path = 'uploads/cam/';
                    $random = rand(1000,1000000);
                    $files = $random . ' - ' . $file_name;
                    $path = $path.$files;

                    if(!in_array($ext, $invalid_extensions)) {
                        move_uploaded_file($tmp, $path);

                        array_push($arr_item, $files);
                    } else {
                        $process = false;
                    }
                }
            }
            $comment_file = implode(' | ', $arr_item);
        }

        // if ($current_client == 1) {
            $training = '';
            if (!empty($_POST['training_desc'])) { $training = implode(",",$_POST['training_desc']); }
        // } else {
        //     $training = addslashes($_POST['training_desc']);
        // }
        $training_date = $_POST['training_date'];
        $training_file = '';
        if (!empty($_FILES['training']['name'])) {
            $arr_item = array();
            for ($i=0; $i < count($_FILES['training']['name']); $i++) {
                $file_name = implode('*', $_FILES['training']['name'][$i]);
                if (!empty($file_name)) {
                    $tmp = implode('*', $_FILES['training']['tmp_name'][$i]);
                    $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                    $ext = strtolower(pathinfo($file_name, PATHINFO_EXTENSION));
                    $path = 'uploads/cam/';
                    $random = rand(1000,1000000);
                    $files = $random . ' - ' . $file_name;
                    $path = $path.$files;

                    if(!in_array($ext, $invalid_extensions)) {
                        move_uploaded_file($tmp, $path);

                        array_push($arr_item, $files);
                    } else {
                        $process = false;
                    }
                }
            }
            $training_file = implode(' | ', $arr_item);
        }

        $investigated_by = $_POST['investigated_by'];
        $investigated_title = $_POST['investigated_title'];
        $investigated_date = $_POST['investigated_date'];
        $investigated_time = $_POST['investigated_time'];
        $verified_by = $_POST['verified_by'];
        $verified_title = $_POST['verified_title'];
        $verified_date = $_POST['verified_date'];
        $verified_time = $_POST['verified_time'];
        $completed_by = $_POST['completed_by'];
        $completed_title = $_POST['completed_title'];
        $completed_date = $_POST['completed_date'];
        $completed_time = $_POST['completed_time'];

        if ($process == true) {
            $sql = "INSERT INTO tbl_cam (user_id, portal_user, product_related, date, time, observed_by, reported_by, reference, description, program_id, complaint_id, complaint_other, category_id, category_other, department_id, department_other, employee_id, trend, observation, observation_file, root_cause, root_cause_file, corrective_status, corrective_desc, corrective_date, corrective_time, corrective_by, corrective_file, implementation_status, implementation_desc, implementation_date, implementation_by, implementation_file, preventive_status, preventive_desc, preventive_file, evaluation_status, evaluation_desc, evaluation_file, comment, comment_file, training, training_date, training_file, investigated_by, investigated_title, investigated_date, investigated_time, verified_by, verified_title, verified_date, verified_time, completed_by, completed_title, completed_date, completed_time)
            VALUES ('$user_id', '$portal_user', '$product_related', '$date', '$time', '$observed_by', '$reported_by', '$reference', '$description', '$program_id', '$complaint_id', '$complaint_other', '$category_id', '$category_other', '$department_id', '$department_other', '$employee_id', '$trend', '$observation', '$observation_file', '$root_cause', '$root_cause_file', '$corrective_status', '$corrective_desc', '$corrective_date', '$corrective_time', '$corrective_by', '$corrective_file', '$implementation_status', '$implementation_desc', '$implementation_date', '$implementation_by', '$implementation_file', '$preventive_status', '$preventive_desc', '$preventive_file', '$evaluation_status', '$evaluation_desc', '$evaluation_file', '$comment', '$comment_file', '$training', '$training_date', '$training_file', '$investigated_by', '$investigated_title', '$investigated_date', '$investigated_time', '$verified_by', '$verified_title', '$verified_date', '$verified_time', '$completed_by', '$completed_title', '$completed_date', '$completed_time')";
            if (mysqli_query($conn, $sql)) {
                $last_id = mysqli_insert_id($conn);

                $data_department_id = array();
                if (!empty($department_id)) {
                    $array_department_id = explode(", ", $department_id);
                    // $selectDepartment = mysqli_query( $conn,"SELECT * FROM tbl_cam_department WHERE deleted = 0 ORDER BY name" );
                    // if ( mysqli_num_rows($selectDepartment) > 0 ) {
                    //     while($rowDept = mysqli_fetch_array($selectDepartment)) {
                    //      if (in_array($rowDept["ID"], $array_department_id)) {
                    //          array_push($data_department_id, $rowDept["name"]);
                    //      }
                    //     }
                    // }

                    $selectDepartment = mysqli_query( $conn,"SELECT * FROM tbl_hr_department WHERE status = 1 AND user_id = $user_id ORDER BY title" );
                    if ( mysqli_num_rows($selectDepartment) > 0 ) {
                        while ($rowDept = mysqli_fetch_array($selectDepartment)) {
                            if (in_array($rowDept["ID"], $array_department_id)) {
                                array_push($data_department_id, $rowDept["title"]);
                            }
                        }
                    }

                    if (in_array(0, $array_department_id)) {
                        array_push($data_department_id, stripcslashes($department_other));
                    }
                }
                $data_department_id = implode(", ",$data_department_id);

                $data_employee_id = array();
                if (!empty($employee_id)) {
                    $array_employee_id = explode(", ", $employee_id);
                    $selectEmployee = mysqli_query( $conn,"SELECT * FROM tbl_hr_employee WHERE suspended = 0 AND status = 1 AND user_id = $user_id ORDER BY first_name" );
                    if ( mysqli_num_rows($selectEmployee) > 0 ) {
                        while ($rowEmployee = mysqli_fetch_array($selectEmployee)) {
                            if (in_array($rowEmployee["ID"], $array_employee_id)) {
                                array_push($data_employee_id, $rowEmployee["first_name"].' '.$rowEmployee["last_name"]);
                            }
                        }
                    }
                }
                $data_employee_id = implode(", ",$data_employee_id);

                if (!empty($employee_id)) {
                    $subject = 'New CAPA Notification!';
                    $mail_sent = 0;

                    // Employee
                    $array_employee_id = explode(", ", $employee_id);
                    $selectEmployee = mysqli_query( $conn,"SELECT * FROM tbl_hr_employee WHERE suspended = 0 AND status = 1 AND user_id = $user_id ORDER BY first_name" );
                    if ( mysqli_num_rows($selectEmployee) > 0 ) {
                        while ($rowEmployee = mysqli_fetch_array($selectEmployee)) {
                            if (in_array($rowEmployee["ID"], $array_employee_id)) {
                                $to = $rowEmployee["email"];
                                $user = $rowEmployee["first_name"].' '.$rowEmployee["last_name"];
                                $body = 'You are being notified of your involvement in the following CAPA record:<br><br>

                                CAPA ID  '.$last_id.'<br>
                                Date Created  '.$date.'<br>
                                Involved Personnel  '.$data_employee_id.'<br>
                                Department Involved  '.$data_department_id.'<br>
                                Description of Issue  '.stripcslashes($description).'<br>
                                Product Related Issue  '; $body .= $product_related == 1 ? 'YES':'NO';

                                if ($_COOKIE['client'] == 1) {
                                    $from = 'CannOS@begreenlegal.com';
                                    $name = 'BeGreenLegal';
                                    $body .= '<br><br>Cann OS Team';
                                } else if ($_COOKIE['client'] == 2) {
                                    $from = 'foodsafety360r@gmail.com';
                                    $name = 'FoodSafety360';
                                    $body .= '<br><br>FoodSafety360';
                                } else if ($_COOKIE['client'] == 3) {
                                    $from = 'cannabis360r@gmail.com';
                                    $name = 'SafeCannabis360';
                                    $body .= '<br><br>SafeCannabis360';
                                } else if ($_COOKIE['client'] == 4) {
                                    $from = 'exim360r@gmail.com';
                                    $name = 'Exim360';
                                    $body .= '<br><br>Exim360';
                                } else {
                                    $from = 'services@interlinkiq.com';
                                    $name = 'InterlinkIQ';
                                    $body .= '<br><br>InterlinkIQ.com Team<br>
                                    Consultare Inc.';
                                }

                                if ($mail_sent > 0) {
                                    php_mailer_2($to, $user, $subject, $body, $from, $name);
                                    $mail_sent++;
                                } else {
                                    php_mailer_1($to, $user, $subject, $body, $from, $name);
                                    $mail_sent++;
                                }
                            }
                        }
                    }

                    // Employer
                    $selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $user_id" );
                    if ( mysqli_num_rows($selectUser) > 0 ) {
                        $rowUser = mysqli_fetch_array($selectUser);
                        $to = $rowUser["email"];
                        $user = $rowUser["first_name"].' '.$rowUser["last_name"];

                        $body = 'Hi [User],<br><br>

                        The following CAPA record has been added:<br><br>
                        CAPA ID  '.$last_id.'<br>
                        Date Created  '.$date.'<br>
                        Involved Personnel  '.$data_employee_id.'<br>
                        Department Involved  '.$data_department_id.'<br>
                        Description of Issue  '.stripcslashes($description).'<br>
                        Product Related Issue  '; $body .= $product_related == 1 ? 'YES':'NO';
                        $body .= '<br>Reported By  '.$reported_by.'<br>
                        Observed By  '.$observed_by.'<br>';

                        if ($_COOKIE['client'] == 1) {
                            $from = 'CannOS@begreenlegal.com';
                            $name = 'BeGreenLegal';
                            $body .= '<br><br>Cann OS Team';
                        } else if ($_COOKIE['client'] == 2) {
                            $from = 'foodsafety360r@gmail.com';
                            $name = 'FoodSafety360';
                            $body .= '<br><br>FoodSafety360';
                        } else if ($_COOKIE['client'] == 3) {
                            $from = 'cannabis360r@gmail.com';
                            $name = 'SafeCannabis360';
                            $body .= '<br><br>SafeCannabis360';
                        } else if ($_COOKIE['client'] == 4) {
                            $from = 'exim360r@gmail.com';
                            $name = 'Exim360';
                            $body .= '<br><br>Exim360';
                        } else {
                            $from = 'services@interlinkiq.com';
                            $name = 'InterlinkIQ';
                            $body .= '<br><br>InterlinkIQ.com Team<br>
                            Consultare Inc.';
                        }

                        if ($mail_sent > 0) {
                            php_mailer_2($to, $user, $subject, $body, $from, $name);
                            $mail_sent++;
                        } else {
                            php_mailer_1($to, $user, $subject, $body, $from, $name);
                            $mail_sent++;
                        }
                    }
                }

                $data = '<tr id="tr_'.$last_id.'">
                    <td>'.$last_id.'</td>';

                    if ($current_client == 0) { $data .= '<td>'.$reference.'</td>'; }
                    
                    $data .= '<td>'.$date.'</td>
                    <td>'.$observed_by.'</td>
                    <td>'.$reported_by.'</td>';

                    if ($current_client == 1) { $data .= '<td>'.$data_employee_id.'</td>'; }
                    
                    $data .= '<td>'.$data_department_id.'</td>
                    <td>'.stripcslashes($description).'</td>
                    <td class="text-center">
                        <div class="btn-group btn-group-circle">
                            <a href="'.$base_url.'pdf_c?id='.$last_id.'&t=1" target="_blank" class="btn btn-info btn-sm">PDF</a>
                            <a href="#modalEdit" class="btn btn-outline dark btn-sm" data-toggle="modal" onclick="btnEdit('. $last_id.')">Edit</a>
                            <a href="javascript:;" class="btn btn-danger btn-sm" onclick="btnClose('. $last_id .')">Close</a>
                        </div>
                    </td>
                </tr>';
            }
            
            $output = array(
                'data' => $data
            );
            echo json_encode($output);
            mysqli_close($conn);
        }
    }
    if( isset($_POST['btnUpdate_CAM']) ) {

        $current_client = 0;
        if (isset($_COOKIE['client'])) { $current_client = $_COOKIE['client']; }

        if (!empty($_COOKIE['switchAccount'])) {
            $portal_user = $_COOKIE['ID'];
            $user_id = $_COOKIE['switchAccount'];
        }
        else {
            $portal_user = $_COOKIE['ID'];
            $user_id = employerID($portal_user);
        }

        $process = true;
        $ID = $_POST['ID'];
        $product_related = $_POST['product_related'];
        $date = $_POST['date'];
        $time = $_POST['time'];
        $observed_by = $_POST['observed_by'];
        $reported_by = $_POST['reported_by'];
        $reference = $_POST['reference'];
        $description = addslashes($_POST['description']);
        mysqli_query( $conn,"UPDATE tbl_cam set portal_user = '".$portal_user."', product_related = '".$product_related."', date = '".$date."', time = '".$time."', observed_by = '".$observed_by."', reported_by = '".$reported_by."', reference = '".$reference."', description = '".$description."' WHERE ID = $ID" );

        $program_id = "";
        if (!empty($_POST["program_id"])) { $program_id = implode(", ", $_POST["program_id"]); }

        $complaint_id = "";
        if (!empty($_POST["complaint_id"])) { $complaint_id = implode(", ", $_POST["complaint_id"]); }

        $complaint_other = "";
        if (!empty($_POST['complaint_other'])) { $complaint_other = addslashes($_POST['complaint_other']); }

        if (!empty($_POST["category_id"])) { $category_id = implode(", ", $_POST["category_id"]); }
        else { $category_id = ""; }
        $category_other = addslashes($_POST['category_other']);

        if (!empty($_POST["department_id"])) { $department_id = implode(", ", $_POST["department_id"]); }
        else { $department_id = ""; }
        $department_other = addslashes($_POST['department_other']);

        $employee_id = '';
        if (!empty($_POST['employee_id'])) { $employee_id = implode(",",$_POST['employee_id']); }

        $trend = '';
        if (!empty($_POST['trend'])) {
            $arr_item = array();
            for ($i=0; $i < count($_POST['trend']); $i++) {
                $trend_desc = addslashes($_POST['trend'][$i]['trend_desc']);
                array_push($arr_item, $trend_desc);
            }
            $trend = implode(' | ', $arr_item);
        }
        if ($process == true) {
            mysqli_query( $conn,"UPDATE tbl_cam set program_id = '".$program_id."', complaint_id = '".$complaint_id."', complaint_other = '".$complaint_other."', category_id = '".$category_id."', category_other = '".$category_other."', department_id = '".$department_id."', department_other = '".$department_other."', employee_id = '".$employee_id."', trend = '".$trend."' WHERE ID = $ID" );
        }
        $observation = addslashes($_POST['observation_desc']);
        $observation_file = '';
        if (!empty($_FILES['observation']['name'])) {
            $arr_item = array();
            for ($i=0; $i < count($_FILES['observation']['name']); $i++) {
                $file_temp = addslashes($_POST['observation'][$i]['observation_file_temp']);
                $file_name = implode('*', $_FILES['observation']['name'][$i]);
                if (!empty($file_name)) {
                    $tmp = implode('*', $_FILES['observation']['tmp_name'][$i]);
                    $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                    $ext = strtolower(pathinfo($file_name, PATHINFO_EXTENSION));
                    $path = 'uploads/cam/';
                    $random = rand(1000,1000000);
                    $files = $random . ' - ' . $file_name;
                    $path = $path.$files;

                    if(!in_array($ext, $invalid_extensions)) {
                        move_uploaded_file($tmp, $path);

                        array_push($arr_item, $files);
                    } else {
                        $process = false;
                    }
                } else {
                    array_push($arr_item, $file_temp);
                }
            }
            $observation_file = implode(' | ', $arr_item);
        }
        if ($process == true) {
            mysqli_query( $conn,"UPDATE tbl_cam set observation = '".$observation."', observation_file = '".$observation_file."' WHERE ID = $ID" );
        }
        $root_cause = addslashes($_POST['root_cause_desc']);
        $root_cause_file = '';
        if (!empty($_FILES['root_cause']['name'])) {
            $arr_item = array();
            for ($i=0; $i < count($_FILES['root_cause']['name']); $i++) {
                $file_temp = addslashes($_POST['root_cause'][$i]['root_cause_file_temp']);
                $file_name = implode('*', $_FILES['root_cause']['name'][$i]);
                if (!empty($file_name)) {
                    $tmp = implode('*', $_FILES['root_cause']['tmp_name'][$i]);
                    $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                    $ext = strtolower(pathinfo($file_name, PATHINFO_EXTENSION));
                    $path = 'uploads/cam/';
                    $random = rand(1000,1000000);
                    $files = $random . ' - ' . $file_name;
                    $path = $path.$files;

                    if(!in_array($ext, $invalid_extensions)) {
                        move_uploaded_file($tmp, $path);

                        array_push($arr_item, $files);
                    } else {
                        $process = false;
                    }
                } else {
                    array_push($arr_item, $file_temp);
                }
            }
            $root_cause_file = implode(' | ', $arr_item);
        }
        if ($process == true) {
            mysqli_query( $conn,"UPDATE tbl_cam set root_cause = '".$root_cause."', root_cause_file = '".$root_cause_file."' WHERE ID = $ID" );
        }
        $corrective_status = $_POST['corrective_status'];
        $corrective_desc = addslashes($_POST['corrective_desc']);
        $corrective_date = $_POST['corrective_date'];
        $corrective_time = $_POST['corrective_time'];
        $corrective_by = $_POST['corrective_by'];
        $corrective_file = '';
        if (!empty($_FILES['corrective']['name'])) {
            $arr_item = array();
            for ($i=0; $i < count($_FILES['corrective']['name']); $i++) {
                $file_temp = addslashes($_POST['corrective'][$i]['corrective_file_temp']);
                $file_name = implode('*', $_FILES['corrective']['name'][$i]);
                if (!empty($file_name)) {
                    $tmp = implode('*', $_FILES['corrective']['tmp_name'][$i]);
                    $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                    $ext = strtolower(pathinfo($file_name, PATHINFO_EXTENSION));
                    $path = 'uploads/cam/';
                    $random = rand(1000,1000000);
                    $files = $random . ' - ' . $file_name;
                    $path = $path.$files;

                    if(!in_array($ext, $invalid_extensions)) {
                        move_uploaded_file($tmp, $path);

                        array_push($arr_item, $files);
                    } else {
                        $process = false;
                    }
                } else {
                    array_push($arr_item, $file_temp);
                }
            }
            $corrective_file = implode(' | ', $arr_item);
        }
        if ($process == true) {
            mysqli_query( $conn,"UPDATE tbl_cam set corrective_status = '".$corrective_status."', corrective_desc = '".$corrective_desc."', corrective_date = '".$corrective_date."', corrective_time = '".$corrective_time."', corrective_by = '".$corrective_by."', corrective_file = '".$corrective_file."' WHERE ID = $ID" );
        }
        $implementation_status = $_POST['implementation_status'];
        $implementation_desc = addslashes($_POST['implementation_desc']);
        $implementation_date = $_POST['implementation_date'];
        $implementation_by = addslashes($_POST['implementation_by']);
        $implementation_file = '';
        if (!empty($_FILES['implementation']['name'])) {
            $arr_item = array();
            for ($i=0; $i < count($_FILES['implementation']['name']); $i++) {
                $file_temp = addslashes($_POST['implementation'][$i]['implementation_file_temp']);
                $file_name = implode('*', $_FILES['implementation']['name'][$i]);
                if (!empty($file_name)) {
                    $tmp = implode('*', $_FILES['implementation']['tmp_name'][$i]);
                    $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                    $ext = strtolower(pathinfo($file_name, PATHINFO_EXTENSION));
                    $path = 'uploads/cam/';
                    $random = rand(1000,1000000);
                    $files = $random . ' - ' . $file_name;
                    $path = $path.$files;

                    if(!in_array($ext, $invalid_extensions)) {
                        move_uploaded_file($tmp, $path);

                        array_push($arr_item, $files);
                    } else {
                        $process = false;
                    }
                } else {
                    array_push($arr_item, $file_temp);
                }
            }
            $implementation_file = implode(' | ', $arr_item);
        }
        if ($process == true) {
            mysqli_query( $conn,"UPDATE tbl_cam set implementation_status = '".$implementation_status."', implementation_desc = '".$implementation_desc."', implementation_date = '".$implementation_date."', implementation_by = '".$implementation_by."', implementation_file = '".$implementation_file."' WHERE ID = $ID" );
        }
        $preventive_status = $_POST['preventive_status'];
        $preventive_desc = addslashes($_POST['preventive_desc']);
        $preventive_file = '';
        if (!empty($_FILES['preventive']['name'])) {
            $arr_item = array();
            for ($i=0; $i < count($_FILES['preventive']['name']); $i++) {
                $file_temp = addslashes($_POST['preventive'][$i]['preventive_file_temp']);
                $file_name = implode('*', $_FILES['preventive']['name'][$i]);
                if (!empty($file_name)) {
                    $tmp = implode('*', $_FILES['preventive']['tmp_name'][$i]);
                    $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                    $ext = strtolower(pathinfo($file_name, PATHINFO_EXTENSION));
                    $path = 'uploads/cam/';
                    $random = rand(1000,1000000);
                    $files = $random . ' - ' . $file_name;
                    $path = $path.$files;

                    if(!in_array($ext, $invalid_extensions)) {
                        move_uploaded_file($tmp, $path);

                        array_push($arr_item, $files);
                    } else {
                        $process = false;
                    }
                } else {
                    array_push($arr_item, $file_temp);
                }
            }
            $preventive_file = implode(' | ', $arr_item);
        }
        if ($process == true) {
            mysqli_query( $conn,"UPDATE tbl_cam set preventive_status = '".$preventive_status."', preventive_desc = '".$preventive_desc."', preventive_file = '".$preventive_file."' WHERE ID = $ID" );
        }
        $evaluation_status = $_POST['evaluation_status'];
        $evaluation_desc = addslashes($_POST['evaluation_desc']);
        $evaluation_file = '';
        if (!empty($_FILES['evaluation']['name'])) {
            $arr_item = array();
            for ($i=0; $i < count($_FILES['evaluation']['name']); $i++) {
                $file_temp = addslashes($_POST['evaluation'][$i]['evaluation_file_temp']);
                $file_name = implode('*', $_FILES['evaluation']['name'][$i]);
                if (!empty($file_name)) {
                    $tmp = implode('*', $_FILES['evaluation']['tmp_name'][$i]);
                    $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                    $ext = strtolower(pathinfo($file_name, PATHINFO_EXTENSION));
                    $path = 'uploads/cam/';
                    $random = rand(1000,1000000);
                    $files = $random . ' - ' . $file_name;
                    $path = $path.$files;

                    if(!in_array($ext, $invalid_extensions)) {
                        move_uploaded_file($tmp, $path);

                        array_push($arr_item, $files);
                    } else {
                        $process = false;
                    }
                } else {
                    array_push($arr_item, $file_temp);
                }
            }
            $evaluation_file = implode(' | ', $arr_item);
        }
        if ($process == true) {
            mysqli_query( $conn,"UPDATE tbl_cam set evaluation_status = '".$evaluation_status."', evaluation_desc = '".$evaluation_desc."', evaluation_file = '".$evaluation_file."' WHERE ID = $ID" );
        }
        $comment = addslashes($_POST['comment_desc']);
        $comment_file = '';
        if (!empty($_FILES['comment']['name'])) {
            $arr_item = array();
            for ($i=0; $i < count($_FILES['comment']['name']); $i++) {
                $file_temp = addslashes($_POST['comment'][$i]['comment_file_temp']);
                $file_name = implode('*', $_FILES['comment']['name'][$i]);
                if (!empty($file_name)) {
                    $tmp = implode('*', $_FILES['comment']['tmp_name'][$i]);
                    $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                    $ext = strtolower(pathinfo($file_name, PATHINFO_EXTENSION));
                    $path = 'uploads/cam/';
                    $random = rand(1000,1000000);
                    $files = $random . ' - ' . $file_name;
                    $path = $path.$files;

                    if(!in_array($ext, $invalid_extensions)) {
                        move_uploaded_file($tmp, $path);

                        array_push($arr_item, $files);
                    } else {
                        $process = false;
                    }
                } else {
                    array_push($arr_item, $file_temp);
                }
            }
            $comment_file = implode(' | ', $arr_item);
        }
        if ($process == true) {
            mysqli_query( $conn,"UPDATE tbl_cam set comment = '".$comment."', comment_file = '".$comment_file."' WHERE ID = $ID" );
        }
        // if ($current_client == 1) {
            $training = '';
            if (!empty($_POST['training_desc'])) { $training = implode(",",$_POST['training_desc']); }
        // } else {
        //     $training = addslashes($_POST['training_desc']);
        // }
        $training_date = $_POST['training_date'];
        $training_file = '';
        if (!empty($_FILES['training']['name'])) {
            $arr_item = array();
            for ($i=0; $i < count($_FILES['training']['name']); $i++) {
                $file_temp = addslashes($_POST['training'][$i]['training_file_temp']);
                $file_name = implode('*', $_FILES['training']['name'][$i]);
                if (!empty($file_name)) {
                    $tmp = implode('*', $_FILES['training']['tmp_name'][$i]);
                    $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                    $ext = strtolower(pathinfo($file_name, PATHINFO_EXTENSION));
                    $path = 'uploads/cam/';
                    $random = rand(1000,1000000);
                    $files = $random . ' - ' . $file_name;
                    $path = $path.$files;

                    if(!in_array($ext, $invalid_extensions)) {
                        move_uploaded_file($tmp, $path);

                        array_push($arr_item, $files);
                    } else {
                        $process = false;
                    }
                } else {
                    array_push($arr_item, $file_temp);
                }
            }
            $training_file = implode(' | ', $arr_item);
        }
        if ($process == true) {
            mysqli_query( $conn,"UPDATE tbl_cam set training = '".$training."', training_date = '".$training_date."', training_file = '".$training_file."' WHERE ID = $ID" );

            $investigated_by = $_POST['investigated_by'];
            $investigated_title = $_POST['investigated_title'];
            $investigated_date = $_POST['investigated_date'];
            $investigated_time = $_POST['investigated_time'];
            $verified_by = $_POST['verified_by'];
            $verified_title = $_POST['verified_title'];
            $verified_date = $_POST['verified_date'];
            $verified_time = $_POST['verified_time'];
            $completed_by = $_POST['completed_by'];
            $completed_title = $_POST['completed_title'];
            $completed_date = $_POST['completed_date'];
            $completed_time = $_POST['completed_time'];
            mysqli_query( $conn,"UPDATE tbl_cam set investigated_by = '".$investigated_by."', investigated_title = '".$investigated_title."', investigated_date = '".$investigated_date."', investigated_time = '".$investigated_time."', verified_by = '".$verified_by."', verified_title = '".$verified_title."', verified_date = '".$verified_date."', verified_time = '".$verified_time."', completed_by = '".$completed_by."', completed_title = '".$completed_title."', completed_date = '".$completed_date."', completed_time = '".$completed_time."' WHERE ID = $ID" );


            $data_department_id = array();
            if (!empty($department_id)) {
                $array_department_id = explode(", ", $department_id);
                // $selectDepartment = mysqli_query( $conn,"SELECT * FROM tbl_cam_department WHERE deleted = 0 ORDER BY name" );
                // if ( mysqli_num_rows($selectDepartment) > 0 ) {
                //     while($rowDept = mysqli_fetch_array($selectDepartment)) {
                //      if (in_array($rowDept["ID"], $array_department_id)) {
                //          array_push($data_department_id, $rowDept["name"]);
                //      }
                //     }
                // }

                $selectDepartment = mysqli_query( $conn,"SELECT * FROM tbl_hr_department WHERE status = 1 AND user_id = $user_id ORDER BY title" );
                if ( mysqli_num_rows($selectDepartment) > 0 ) {
                    while ($rowDept = mysqli_fetch_array($selectDepartment)) {
                        if (in_array($rowDept["ID"], $array_department_id)) {
                            array_push($data_department_id, $rowDept["title"]);
                        }
                    }
                }

                if (in_array(0, $array_department_id)) {
                    array_push($data_department_id, stripcslashes($department_other));
                }
            }
            $data_department_id = implode(", ",$data_department_id);

            $data_employee_id = array();
            if (!empty($employee_id)) {
                $array_employee_id = explode(", ", $employee_id);
                $selectEmployee = mysqli_query( $conn,"SELECT * FROM tbl_hr_employee WHERE suspended = 0 AND status = 1 AND user_id = $user_id ORDER BY first_name" );
                if ( mysqli_num_rows($selectEmployee) > 0 ) {
                    while ($rowEmployee = mysqli_fetch_array($selectEmployee)) {
                        if (in_array($rowEmployee["ID"], $array_employee_id)) {
                            array_push($data_employee_id, $rowEmployee["first_name"].' '.$rowEmployee["last_name"]);
                        }
                    }
                }
            }
            $data_employee_id = implode(", ",$data_employee_id);

            $data = '<td>'.$ID.'</td>';

            if ($current_client == 0) { $data .= '<td>'.$reference.'</td>'; }
            
            $data .= '<td>'.$date.'</td>
            <td>'.$observed_by.'</td>
            <td>'.$reported_by.'</td>';

            if ($current_client == 1) { $data .= '<td>'.$data_employee_id.'</td>'; }
            
            $data .= '<td>'.$data_department_id.'</td>
            <td>'.stripcslashes($description).'</td>
            <td class="text-center">
                <div class="btn-group btn-group-circle">
                    <a href="'.$base_url.'pdf_c?id='.$ID.'&t=1" target="_blank" class="btn btn-info btn-sm">PDF</a>
                    <a href="#modalEdit" class="btn btn-outline dark btn-sm" data-toggle="modal" onclick="btnEdit('. $ID.')">Edit</a>
                    <a href="javascript:;" class="btn btn-danger btn-sm" onclick="btnClose('. $ID .')">Close</a>
                </div>
            </td>';

            $output = array(
                'ID' => $ID,
                'data' => $data
            );
            echo json_encode($output);
            mysqli_close($conn);
        }
    }
    if( isset($_POST['btnUpdate_CAM2']) ) {

        $current_client = 0;
        if (isset($_COOKIE['client'])) { $current_client = $_COOKIE['client']; }

        if (!empty($_COOKIE['switchAccount'])) {
            $portal_user = $_COOKIE['ID'];
            $user_id = $_COOKIE['switchAccount'];
        }
        else {
            $portal_user = $_COOKIE['ID'];
            $user_id = employerID($portal_user);
        }

        $process = true;
        $ID = $_POST['ID'];
        $product_related = $_POST['product_related'];
        $date = $_POST['date'];
        $time = $_POST['time'];
        $observed_by = $_POST['observed_by'];
        $reported_by = $_POST['reported_by'];
        $reference = $_POST['reference'];
        $description = addslashes($_POST['description']);
        mysqli_query( $conn,"UPDATE tbl_complaint_records set portal_user = '".$portal_user."', product_related = '".$product_related."', care_date = '".$date."', time = '".$time."', observed_by = '".$observed_by."', reported_by = '".$reported_by."', reference = '".$reference."', nature_complaint = '".$description."' WHERE care_id = $ID" );

        $program_id = "";
        if (!empty($_POST["program_id"])) { $program_id = implode(", ", $_POST["program_id"]); }

        if (!empty($_POST["category_id"])) { $category_id = implode(", ", $_POST["category_id"]); }
        else { $category_id = ""; }
        $category_other = addslashes($_POST['category_other']);

        if (!empty($_POST["department_id"])) { $department_id = implode(", ", $_POST["department_id"]); }
        else { $department_id = ""; }
        $department_other = addslashes($_POST['department_other']);

        $employee_id = '';
        if (!empty($_POST['employee_id'])) { $employee_id = implode(",",$_POST['employee_id']); }

        $trend = '';
        if (!empty($_POST['trend'])) {
            $arr_item = array();
            for ($i=0; $i < count($_POST['trend']); $i++) {
                $trend_desc = addslashes($_POST['trend'][$i]['trend_desc']);
                array_push($arr_item, $trend_desc);
            }
            $trend = implode(' | ', $arr_item);
        }
        mysqli_query( $conn,"UPDATE tbl_complaint_records set program_id = '".$program_id."', category_id = '".$category_id."', category_other = '".$category_other."', department_id = '".$department_id."', department_other = '".$department_other."', employee_id = '".$employee_id."', trend = '".$trend."' WHERE care_id = $ID" );

        $observation = addslashes($_POST['observation_desc']);
        $observation_file = '';
        if (!empty($_FILES['observation']['name'])) {
            $arr_item = array();
            for ($i=0; $i < count($_FILES['observation']['name']); $i++) {
                $file_temp = addslashes($_POST['observation'][$i]['observation_file_temp']);
                $file_name = implode('*', $_FILES['observation']['name'][$i]);
                if (!empty($file_name)) {
                    $tmp = implode('*', $_FILES['observation']['tmp_name'][$i]);
                    $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                    $ext = strtolower(pathinfo($file_name, PATHINFO_EXTENSION));
                    $path = 'uploads/cam/';
                    $random = rand(1000,1000000);
                    $files = $random . ' - ' . $file_name;
                    $path = $path.$files;

                    if(!in_array($ext, $invalid_extensions)) {
                        move_uploaded_file($tmp, $path);

                        array_push($arr_item, $files);
                    } else {
                        $process = false;
                    }
                } else {
                    array_push($arr_item, $file_temp);
                }
            }
            $observation_file = implode(' | ', $arr_item);
        }
        if ($process == true) {
            mysqli_query( $conn,"UPDATE tbl_complaint_records set observation = '".$observation."', observation_file = '".$observation_file."' WHERE care_id = $ID" );
        }
        $root_cause = addslashes($_POST['root_cause_desc']);
        $root_cause_file = '';
        if (!empty($_FILES['root_cause']['name'])) {
            $arr_item = array();
            for ($i=0; $i < count($_FILES['root_cause']['name']); $i++) {
                $file_temp = addslashes($_POST['root_cause'][$i]['root_cause_file_temp']);
                $file_name = implode('*', $_FILES['root_cause']['name'][$i]);
                if (!empty($file_name)) {
                    $tmp = implode('*', $_FILES['root_cause']['tmp_name'][$i]);
                    $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                    $ext = strtolower(pathinfo($file_name, PATHINFO_EXTENSION));
                    $path = 'uploads/cam/';
                    $random = rand(1000,1000000);
                    $files = $random . ' - ' . $file_name;
                    $path = $path.$files;

                    if(!in_array($ext, $invalid_extensions)) {
                        move_uploaded_file($tmp, $path);

                        array_push($arr_item, $files);
                    } else {
                        $process = false;
                    }
                } else {
                    array_push($arr_item, $file_temp);
                }
            }
            $root_cause_file = implode(' | ', $arr_item);
        }
        if ($process == true) {
            mysqli_query( $conn,"UPDATE tbl_complaint_records set root_cause = '".$root_cause."', root_cause_file = '".$root_cause_file."' WHERE care_id = $ID" );
        }
        $corrective_status = $_POST['corrective_status'];
        $corrective_desc = addslashes($_POST['corrective_desc']);
        $corrective_date = $_POST['corrective_date'];
        $corrective_time = $_POST['corrective_time'];
        $corrective_by = $_POST['corrective_by'];
        $corrective_file = '';
        if (!empty($_FILES['corrective']['name'])) {
            $arr_item = array();
            for ($i=0; $i < count($_FILES['corrective']['name']); $i++) {
                $file_temp = addslashes($_POST['corrective'][$i]['corrective_file_temp']);
                $file_name = implode('*', $_FILES['corrective']['name'][$i]);
                if (!empty($file_name)) {
                    $tmp = implode('*', $_FILES['corrective']['tmp_name'][$i]);
                    $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                    $ext = strtolower(pathinfo($file_name, PATHINFO_EXTENSION));
                    $path = 'uploads/cam/';
                    $random = rand(1000,1000000);
                    $files = $random . ' - ' . $file_name;
                    $path = $path.$files;

                    if(!in_array($ext, $invalid_extensions)) {
                        move_uploaded_file($tmp, $path);

                        array_push($arr_item, $files);
                    } else {
                        $process = false;
                    }
                } else {
                    array_push($arr_item, $file_temp);
                }
            }
            $corrective_file = implode(' | ', $arr_item);
        }
        if ($process == true) {
            mysqli_query( $conn,"UPDATE tbl_complaint_records set corrective_status = '".$corrective_status."', action_taken = '".$corrective_desc."', date_resolution = '".$corrective_date."', corrective_time = '".$corrective_time."', corrective_by = '".$corrective_by."', corrective_file = '".$corrective_file."' WHERE care_id = $ID" );
        }
        $implementation_status = $_POST['implementation_status'];
        $implementation_desc = addslashes($_POST['implementation_desc']);
        $implementation_date = $_POST['implementation_date'];
        $implementation_by = addslashes($_POST['implementation_by']);
        $implementation_file = '';
        if (!empty($_FILES['implementation']['name'])) {
            $arr_item = array();
            for ($i=0; $i < count($_FILES['implementation']['name']); $i++) {
                $file_temp = addslashes($_POST['implementation'][$i]['implementation_file_temp']);
                $file_name = implode('*', $_FILES['implementation']['name'][$i]);
                if (!empty($file_name)) {
                    $tmp = implode('*', $_FILES['implementation']['tmp_name'][$i]);
                    $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                    $ext = strtolower(pathinfo($file_name, PATHINFO_EXTENSION));
                    $path = 'uploads/cam/';
                    $random = rand(1000,1000000);
                    $files = $random . ' - ' . $file_name;
                    $path = $path.$files;

                    if(!in_array($ext, $invalid_extensions)) {
                        move_uploaded_file($tmp, $path);

                        array_push($arr_item, $files);
                    } else {
                        $process = false;
                    }
                } else {
                    array_push($arr_item, $file_temp);
                }
            }
            $implementation_file = implode(' | ', $arr_item);
        }
        if ($process == true) {
            mysqli_query( $conn,"UPDATE tbl_complaint_records set implementation_status = '".$implementation_status."', implementation_desc = '".$implementation_desc."', implementation_date = '".$implementation_date."', implementation_by = '".$implementation_by."', implementation_file = '".$implementation_file."' WHERE care_id = $ID" );
        }
        $preventive_status = $_POST['preventive_status'];
        $preventive_desc = addslashes($_POST['preventive_desc']);
        $preventive_file = '';
        if (!empty($_FILES['preventive']['name'])) {
            $arr_item = array();
            for ($i=0; $i < count($_FILES['preventive']['name']); $i++) {
                $file_temp = addslashes($_POST['preventive'][$i]['preventive_file_temp']);
                $file_name = implode('*', $_FILES['preventive']['name'][$i]);
                if (!empty($file_name)) {
                    $tmp = implode('*', $_FILES['preventive']['tmp_name'][$i]);
                    $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                    $ext = strtolower(pathinfo($file_name, PATHINFO_EXTENSION));
                    $path = 'uploads/cam/';
                    $random = rand(1000,1000000);
                    $files = $random . ' - ' . $file_name;
                    $path = $path.$files;

                    if(!in_array($ext, $invalid_extensions)) {
                        move_uploaded_file($tmp, $path);

                        array_push($arr_item, $files);
                    } else {
                        $process = false;
                    }
                } else {
                    array_push($arr_item, $file_temp);
                }
            }
            $preventive_file = implode(' | ', $arr_item);
        }
        if ($process == true) {
            mysqli_query( $conn,"UPDATE tbl_complaint_records set preventive_status = '".$preventive_status."', preventive_desc = '".$preventive_desc."', preventive_file = '".$preventive_file."' WHERE care_id = $ID" );
        }
        $evaluation_status = $_POST['evaluation_status'];
        $evaluation_desc = addslashes($_POST['evaluation_desc']);
        $evaluation_file = '';
        if (!empty($_FILES['evaluation']['name'])) {
            $arr_item = array();
            for ($i=0; $i < count($_FILES['evaluation']['name']); $i++) {
                $file_temp = addslashes($_POST['evaluation'][$i]['evaluation_file_temp']);
                $file_name = implode('*', $_FILES['evaluation']['name'][$i]);
                if (!empty($file_name)) {
                    $tmp = implode('*', $_FILES['evaluation']['tmp_name'][$i]);
                    $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                    $ext = strtolower(pathinfo($file_name, PATHINFO_EXTENSION));
                    $path = 'uploads/cam/';
                    $random = rand(1000,1000000);
                    $files = $random . ' - ' . $file_name;
                    $path = $path.$files;

                    if(!in_array($ext, $invalid_extensions)) {
                        move_uploaded_file($tmp, $path);

                        array_push($arr_item, $files);
                    } else {
                        $process = false;
                    }
                } else {
                    array_push($arr_item, $file_temp);
                }
            }
            $evaluation_file = implode(' | ', $arr_item);
        }
        if ($process == true) {
            mysqli_query( $conn,"UPDATE tbl_complaint_records set evaluation_status = '".$evaluation_status."', evaluation_desc = '".$evaluation_desc."', evaluation_file = '".$evaluation_file."' WHERE care_id = $ID" );
        }
        $comment = addslashes($_POST['comment_desc']);
        $comment_file = '';
        if (!empty($_FILES['comment']['name'])) {
            $arr_item = array();
            for ($i=0; $i < count($_FILES['comment']['name']); $i++) {
                $file_temp = addslashes($_POST['comment'][$i]['comment_file_temp']);
                $file_name = implode('*', $_FILES['comment']['name'][$i]);
                if (!empty($file_name)) {
                    $tmp = implode('*', $_FILES['comment']['tmp_name'][$i]);
                    $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                    $ext = strtolower(pathinfo($file_name, PATHINFO_EXTENSION));
                    $path = 'uploads/cam/';
                    $random = rand(1000,1000000);
                    $files = $random . ' - ' . $file_name;
                    $path = $path.$files;

                    if(!in_array($ext, $invalid_extensions)) {
                        move_uploaded_file($tmp, $path);

                        array_push($arr_item, $files);
                    } else {
                        $process = false;
                    }
                } else {
                    array_push($arr_item, $file_temp);
                }
            }
            $comment_file = implode(' | ', $arr_item);
        }
        if ($process == true) {
            mysqli_query( $conn,"UPDATE tbl_complaint_records set comment = '".$comment."', comment_file = '".$comment_file."' WHERE care_id = $ID" );
        }
        // if ($current_client == 1) {
            $training = '';
            if (!empty($_POST['training_desc'])) { $training = implode(",",$_POST['training_desc']); }
        // } else {
        //  $training = addslashes($_POST['training_desc']);
        // }
        $training_date = $_POST['training_date'];
        $training_file = '';
        if (!empty($_FILES['training']['name'])) {
            $arr_item = array();
            for ($i=0; $i < count($_FILES['training']['name']); $i++) {
                $file_temp = addslashes($_POST['training'][$i]['training_file_temp']);
                $file_name = implode('*', $_FILES['training']['name'][$i]);
                if (!empty($file_name)) {
                    $tmp = implode('*', $_FILES['training']['tmp_name'][$i]);
                    $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                    $ext = strtolower(pathinfo($file_name, PATHINFO_EXTENSION));
                    $path = 'uploads/cam/';
                    $random = rand(1000,1000000);
                    $files = $random . ' - ' . $file_name;
                    $path = $path.$files;

                    if(!in_array($ext, $invalid_extensions)) {
                        move_uploaded_file($tmp, $path);

                        array_push($arr_item, $files);
                    } else {
                        $process = false;
                    }
                } else {
                    array_push($arr_item, $file_temp);
                }
            }
            $training_file = implode(' | ', $arr_item);
        }
        if ($process == true) {
            mysqli_query( $conn,"UPDATE tbl_complaint_records set training = '".$training."', training_date = '".$training_date."', training_file = '".$training_file."' WHERE care_id = $ID" );

            $investigated_by = $_POST['investigated_by'];
            $investigated_title = $_POST['investigated_title'];
            $investigated_date = $_POST['investigated_date'];
            $investigated_time = $_POST['investigated_time'];
            $verified_by = $_POST['verified_by'];
            $verified_title = $_POST['verified_title'];
            $verified_date = $_POST['verified_date'];
            $verified_time = $_POST['verified_time'];
            $completed_by = $_POST['completed_by'];
            $completed_title = $_POST['completed_title'];
            $completed_date = $_POST['completed_date'];
            $completed_time = $_POST['completed_time'];
            mysqli_query( $conn,"UPDATE tbl_complaint_records set investigated_by = '".$investigated_by."', investigated_title = '".$investigated_title."', investigated_date = '".$investigated_date."', investigated_time = '".$investigated_time."', verified_by = '".$verified_by."', verified_title = '".$verified_title."', verified_date = '".$verified_date."', verified_time = '".$verified_time."', completed_by = '".$completed_by."', completed_title = '".$completed_title."', completed_date = '".$completed_date."', completed_time = '".$completed_time."' WHERE care_id = $ID" );


            $data_department_id = array();
            if (!empty($department_id)) {
                $array_department_id = explode(", ", $department_id);
                // $selectDepartment = mysqli_query( $conn,"SELECT * FROM tbl_cam_department WHERE deleted = 0 ORDER BY name" );
                // if ( mysqli_num_rows($selectDepartment) > 0 ) {
                //     while($rowDept = mysqli_fetch_array($selectDepartment)) {
                //      if (in_array($rowDept["ID"], $array_department_id)) {
                //          array_push($data_department_id, $rowDept["name"]);
                //      }
                //     }
                // }

                $selectDepartment = mysqli_query( $conn,"SELECT * FROM tbl_hr_department WHERE status = 1 AND user_id = $user_id ORDER BY title" );
                if ( mysqli_num_rows($selectDepartment) > 0 ) {
                    while ($rowDept = mysqli_fetch_array($selectDepartment)) {
                        if (in_array($rowDept["ID"], $array_department_id)) {
                            array_push($data_department_id, $rowDept["title"]);
                        }
                    }
                }

                if (in_array(0, $array_department_id)) {
                    array_push($data_department_id, stripcslashes($department_other));
                }
            }
            $data_department_id = implode(", ",$data_department_id);

            $data_employee_id = array();
            if (!empty($employee_id)) {
                $array_employee_id = explode(", ", $employee_id);
                $selectEmployee = mysqli_query( $conn,"SELECT * FROM tbl_hr_employee WHERE suspended = 0 AND status = 1 AND user_id = $user_id ORDER BY first_name" );
                if ( mysqli_num_rows($selectEmployee) > 0 ) {
                    while ($rowEmployee = mysqli_fetch_array($selectEmployee)) {
                        if (in_array($rowEmployee["ID"], $array_employee_id)) {
                            array_push($data_employee_id, $rowEmployee["first_name"].' '.$rowEmployee["last_name"]);
                        }
                    }
                }
            }
            $data_employee_id = implode(", ",$data_employee_id);

            $data = '<td>'.$ID.'</td>';

            if ($current_client == 0) { $data .= '<td>'.$reference.'</td>'; }
            
            $data .= '<td>'.$date.'</td>
            <td>'.$observed_by.'</td>
            <td>'.$reported_by.'</td>';

            if ($current_client == 1) { $data .= '<td>'.$data_employee_id.'</td>'; }
            
            $data .= '<td>'.$data_department_id.'</td>
            <td>'.stripcslashes($description).'</td>
            <td class="text-center">
                <div class="btn-group btn-group-circle">
                    <a href="'.$base_url.'pdf_c?id='.$ID.'&t=2" target="_blank" class="btn btn-info btn-sm">PDF</a>
                    <a href="#modalEdit" class="btn btn-outline dark btn-sm" data-toggle="modal" onclick="btnEdit('. $ID.')">Edit</a>
                    <a href="javascript:;" class="btn btn-danger btn-sm" onclick="btnClose('. $ID .')">Close</a>
                </div>
            </td>';

            $output = array(
                'ID' => $ID,
                'data' => $data
            );
            echo json_encode($output);
            mysqli_close($conn);
        }
    }


	// CHAT WIDGET
	if( isset($_GET['modalNew_Message']) ) {
		$ID = $_GET['modalNew_Message'];

		echo '<input type="hidden" name="to_id" value="'.$ID.'" />
	    <div class="form-group">
	        <textarea class="form-control" name="message" rows="5" placeholder="Message" required></textarea>
	    </div>';
	}
	if( isset($_GET['modalChat_Refresh']) ) {
		$current_userID = $_GET['modalChat_Refresh'];

        $current_userVIP = false;
        $chat_seen_counter = 0;

        $selectUserChat = mysqli_query( $conn,"SELECT MAX(ID), from_id, to_id FROM tbl_user_chat WHERE from_id = $current_userID OR to_id = $current_userID GROUP BY from_id, to_id ORDER BY MAX(ID) DESC" );
        if ($current_userID == 1 OR $current_userID == 34 OR $current_userID == 163) {
            $current_userVIP = true;
            $selectUserChat = mysqli_query( $conn,"SELECT MAX(ID), from_id, to_id FROM tbl_user_chat GROUP BY from_id, to_id ORDER BY MAX(ID) DESC" );
        }

        if ( mysqli_num_rows($selectUserChat) > 0 ) {
            $chat_user_id_arr = array();
            while($rowUserChat = mysqli_fetch_array($selectUserChat)) {
                $ID = $rowUserChat['MAX(ID)'];

                $selectUserChatData = mysqli_query( $conn,"SELECT * FROM tbl_user_chat WHERE ID = $ID" );
                if ( mysqli_num_rows($selectUserChatData) > 0 ) {
                    $rowUserChatData = mysqli_fetch_array($selectUserChatData);
                    $chat_from_id = $rowUserChatData['from_id'];
                    $chat_to_id = $rowUserChatData['to_id'];
                    $chat_seen = $rowUserChatData['seen'];

                    $chat_user_id = $chat_to_id;
                    $chat_user_id_2 = $chat_from_id;
                    if ($current_userID == $chat_user_id) {
                        $chat_user_id = $chat_from_id;
                        $chat_user_id_2 = $chat_to_id;
                    }

                    if (!in_array($chat_user_id .' | '. $chat_user_id_2, $chat_user_id_arr) OR !in_array($chat_user_id_2 .' | '. $chat_user_id, $chat_user_id_arr)) {
                        if ($chat_seen == 0 AND $chat_to_id == $current_userID) { $chat_seen_counter++; }
                    }
                }
            }
        }

        echo $chat_seen_counter;
	}
	if( isset($_GET['modalChatBox_Refresh']) AND isset($_GET['p']) ) {
		$current_userID = $_GET['modalChatBox_Refresh'];
		$p = $_GET['p'];

        $chat_userAvatar = '';
        $current_userVIP = false;
        $chat_seen_counter = 0;
        $selectUserChat = mysqli_query( $conn,"SELECT MAX(ID), from_id, to_id FROM tbl_user_chat WHERE from_id = $current_userID OR to_id = $current_userID GROUP BY from_id, to_id ORDER BY MAX(ID) DESC" );
        if ($current_userID == 1 OR $current_userID == 34 OR $current_userID == 163) {
            $current_userVIP = true;
            $selectUserChat = mysqli_query( $conn,"SELECT MAX(ID), from_id, to_id FROM tbl_user_chat GROUP BY from_id, to_id ORDER BY MAX(ID) DESC" );
        }

        if ( mysqli_num_rows($selectUserChat) > 0 ) {
            $chat_user_id_arr = array();
            while($rowUserChat = mysqli_fetch_array($selectUserChat)) {
                $ID = $rowUserChat['MAX(ID)'];

                $selectUserChatData = mysqli_query( $conn,"SELECT * FROM tbl_user_chat WHERE ID = $ID" );
                if ( mysqli_num_rows($selectUserChatData) > 0 ) {
                    $rowUserChatData = mysqli_fetch_array($selectUserChatData);
                    $chat_from_id = $rowUserChatData['from_id'];
                    $chat_to_id = $rowUserChatData['to_id'];
                    $chat_message = $rowUserChatData['message'];
                    $chat_seen = $rowUserChatData['seen'];

                    $chat_user_id = $chat_to_id;
                    $chat_user_id_2 = $chat_from_id;
                    if ($current_userID == $chat_user_id) {
                        $chat_user_id = $chat_from_id;
                        $chat_user_id_2 = $chat_to_id;
                    }

                    if (!in_array($chat_user_id .' | '. $chat_user_id_2, $chat_user_id_arr) OR !in_array($chat_user_id_2 .' | '. $chat_user_id, $chat_user_id_arr)) {
                        array_push($chat_user_id_arr, $chat_user_id .' | '. $chat_user_id_2);
                        array_push($chat_user_id_arr, $chat_user_id_2 .' | '. $chat_user_id);

                        $selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE is_active = 1 AND ID = $chat_user_id" );
                        if ( mysqli_num_rows($selectUser) > 0 ) {
                            $rowUser = mysqli_fetch_array($selectUser);
                            $user_fullname = $rowUser['first_name'].' '.$rowUser['last_name'];
                        }

                        $selectUserInfo = mysqli_query( $conn,"SELECT * FROM tbl_user_info WHERE user_id = $chat_user_id" );
                        if ( mysqli_num_rows($selectUserInfo) > 0 ) {
                            $rowUserInfo = mysqli_fetch_array($selectUserInfo);
                            $chat_userAvatar = $rowUserInfo['avatar'];
                        }

                        if ($p == 1) {
	                        echo '<div class="userResult">
	                            <div class="d-flex align-items-center img-rounded excerpt p-1" id="user_'.$chat_user_id.'" data-toggle="modal" data-target="#sendMessage2" onClick="sendChat('.$chat_user_id.', '.$chat_user_id_2.')">';

	                                if ($current_userVIP == true AND $current_userID <> $chat_user_id AND $current_userID <> $chat_user_id_2) {
	                                    $selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE is_active = 1 AND ID = $chat_user_id_2" );
	                                    if ( mysqli_num_rows($selectUser) > 0 ) {
	                                        $rowUser = mysqli_fetch_array($selectUser);
	                                        $user_fullname_2 = $rowUser['first_name'].' '.$rowUser['last_name'];
	                                    }

	                                    $selectUserInfo_2 = mysqli_query( $conn,"SELECT * FROM tbl_user_info WHERE user_id = $chat_user_id_2" );
	                                    if ( mysqli_num_rows($selectUserInfo_2) > 0 ) {
	                                        $rowUserInfo_2 = mysqli_fetch_array($selectUserInfo_2);
	                                        $chat_userAvatar_2 = $rowUserInfo_2['avatar'];
	                                    }

	                                    echo '<div class="flex-shrink-0 position-relative" style="width: 50px; height: 50px;"">
	                                        <img class="position-absolute top-0 start-0 border border-default bg-white img-circle" style="width: 35px; height: 35px; object-fit: contain;" src="'.$base_url.'uploads/avatar/'.$chat_userAvatar.'" alt="Avatar" onerror="this.onerror=null;this.src=\'https://via.placeholder.com/40x40/EFEFEF/AAAAAA.png?text=no+image\';" />
	                                        <img class="position-absolute bottom-0 end-0 border border-default bg-white img-circle" style="width: 35px; height: 35px; object-fit: contain;" src="'.$base_url.'uploads/avatar/'.$chat_userAvatar_2.'" alt="Avatar" onerror="this.onerror=null;this.src=\'https://via.placeholder.com/40x40/EFEFEF/AAAAAA.png?text=no+image\';" />
	                                    </div>
	                                    <div class="userData flex-grow-1 ms-3">
	                                        <p class="mb-0 bold" style="font-size: 15px;">'.$user_fullname.' / '.$user_fullname_2.'</p>
	                                        <p class="mb-0 text-muted '; if ($chat_seen == 0 AND $chat_to_id == $current_userID) { $chat_seen_counter++; echo 'bold'; } echo '" style="font-size: 13px;">'; echo $chat_from_id == $current_userID ? 'You: ':''; echo $chat_message .'</p>
	                                    </div>';
	                                } else {
	                                    echo '<div class="flex-shrink-0 position-relative">
	                                        <span class="hide position-absolute bottom-0 end-0 translate-middlex badge border border-white img-circle p-1 '; echo $rowUser['is_active'] == 1 ? 'bg-success':'bg-danger'; echo '">
	                                            <span class="visually-hidden">unread messages</span>
	                                        </span>
	                                        <img class="border border-default bg-white img-circle" style="width: 50px; height: 50px; object-fit: contain;" src="'.$base_url.'uploads/avatar/'.$chat_userAvatar.'" alt="Avatar" onerror="this.onerror=null;this.src=\'https://via.placeholder.com/40x40/EFEFEF/AAAAAA.png?text=no+image\';" />
	                                    </div>
	                                    <div class="userData flex-grow-1 ms-3">
	                                        <p class="mb-0 bold" style="font-size: 15px;">'.$user_fullname.'</p>
	                                        <p class="mb-0 text-muted '; if ($chat_seen == 0 AND $chat_to_id == $current_userID) { $chat_seen_counter++; echo 'bold'; } echo '" style="font-size: 13px;">'; echo $chat_from_id == $current_userID ? 'You: ':''; echo $chat_message .'</p>
	                                    </div>';
	                                }
	                                
	                            echo '</div>
	                        </div>';
                        } else if ($p == 2) {
	                        echo '<div class="userResult">
	                            <div class="d-flex align-items-center rounded excerpt p-1" id="user_'.$chat_user_id.'" data-bs-toggle="modal" data-bs-target="#sendMessage2" onClick="sendChat('.$chat_user_id.', '.$chat_user_id_2.')">';

	                                if ($current_userVIP == true AND $current_userID <> $chat_user_id AND $current_userID <> $chat_user_id_2) {
	                                    $selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE is_active = 1 AND ID = $chat_user_id_2" );
	                                    if ( mysqli_num_rows($selectUser) > 0 ) {
	                                        $rowUser = mysqli_fetch_array($selectUser);
	                                        $user_fullname_2 = $rowUser['first_name'].' '.$rowUser['last_name'];
	                                    }

	                                    $selectUserInfo_2 = mysqli_query( $conn,"SELECT * FROM tbl_user_info WHERE user_id = $chat_user_id_2" );
	                                    if ( mysqli_num_rows($selectUserInfo_2) > 0 ) {
	                                        $rowUserInfo_2 = mysqli_fetch_array($selectUserInfo_2);
	                                        $chat_userAvatar_2 = $rowUserInfo_2['avatar'];
	                                    }

	                                    echo '<div class="flex-shrink-0 position-relative" style="width: 50px; height: 50px;"">
	                                        <img class="position-absolute top-0 start-0 border border-2 bg-light rounded-circle" style="width: 35px; height: 35px; object-fit: contain;" src="'.$base_url.'uploads/avatar/'.$chat_userAvatar.'" alt="Avatar" onerror="this.onerror=null;this.src=\'https://via.placeholder.com/40x40/EFEFEF/AAAAAA.png?text=no+image\';" />
	                                        <img class="position-absolute bottom-0 end-0 border border-2 bg-light rounded-circle" style="width: 35px; height: 35px; object-fit: contain;" src="'.$base_url.'uploads/avatar/'.$chat_userAvatar_2.'" alt="Avatar" onerror="this.onerror=null;this.src=\'https://via.placeholder.com/40x40/EFEFEF/AAAAAA.png?text=no+image\';" />
	                                    </div>
	                                    <div class="userData flex-grow-1 ms-3">
	                                        <p class="mb-0 fw-bold" style="font-size: 15px;">'.$user_fullname.' / '.$user_fullname_2.'</p>
	                                        <p class="mb-0 text-muted '; if ($chat_seen == 0 AND $chat_to_id == $current_userID) { $chat_seen_counter++; echo 'fw-bold'; } echo '" style="font-size: 13px;">'; echo $chat_from_id == $current_userID ? 'You: ':''; echo $chat_message .'</p>
	                                    </div>';
	                                } else {
	                                    echo '<div class="flex-shrink-0 position-relative">
	                                        <span class="d-none position-absolute bottom-0 end-0 translate-middlex badge border border-light rounded-circle p-1 '; echo $rowUser['is_active'] == 1 ? 'bg-success':'bg-danger'; echo '">
	                                            <span class="visually-hidden">unread messages</span>
	                                        </span>
	                                        <img class="border border-2 bg-light rounded-circle" style="width: 50px; height: 50px; object-fit: contain;" src="'.$base_url.'uploads/avatar/'.$chat_userAvatar.'" alt="Avatar" onerror="this.onerror=null;this.src=\'https://via.placeholder.com/40x40/EFEFEF/AAAAAA.png?text=no+image\';" />
	                                    </div>
	                                    <div class="userData flex-grow-1 ms-3">
	                                        <p class="mb-0 fw-bold" style="font-size: 15px;">'.$user_fullname.'</p>
	                                        <p class="mb-0 text-muted '; if ($chat_seen == 0 AND $chat_to_id == $current_userID) { $chat_seen_counter++; echo 'fw-bold'; } echo '" style="font-size: 13px;">'; echo $chat_from_id == $current_userID ? 'You: ':''; echo $chat_message .'</p>
	                                    </div>';
	                                }
	                                
	                            echo '</div>
	                        </div>';
                        }
                    }
                }
            }
        }
	}
	if( isset($_GET['modalNew_Chat']) ) {
		$ID = $_GET['modalNew_Chat'];
		$ID2 = $_GET['chat'];

    	$current_userID = $_COOKIE['ID'];
    	$sender_fullname = '';
    	$sender_userAvatar = '';
    	$receiver_fullname = '';
    	$receiver_userAvatar = '';

    	// Seen Message
    	mysqli_query( $conn,"UPDATE tbl_user_chat SET seen = 1 WHERE from_id = $ID AND to_id = $ID2" );

    	// Sender
        $selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE is_active = 1 AND ID = $ID2" );
        if ( mysqli_num_rows($selectUser) > 0 ) {
            $rowUser = mysqli_fetch_array($selectUser);
            $sender_fullname = $rowUser['first_name'].' '.$rowUser['last_name'];
        }
        $selectUserInfo = mysqli_query( $conn,"SELECT * FROM tbl_user_info WHERE user_id = $ID2" );
        if ( mysqli_num_rows($selectUserInfo) > 0 ) {
            $rowUserInfo = mysqli_fetch_array($selectUserInfo);
            $sender_userAvatar = $rowUserInfo['avatar'];
        }

    	// Receiver
        $selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE is_active = 1 AND ID = $ID" );
        if ( mysqli_num_rows($selectUser) > 0 ) {
            $rowUser = mysqli_fetch_array($selectUser);
            $receiver_fullname = $rowUser['first_name'].' '.$rowUser['last_name'];
        }
        $selectUserInfo = mysqli_query( $conn,"SELECT * FROM tbl_user_info WHERE user_id = $ID" );
        if ( mysqli_num_rows($selectUserInfo) > 0 ) {
            $rowUserInfo = mysqli_fetch_array($selectUserInfo);
            $receiver_userAvatar = $rowUserInfo['avatar'];
        }

        echo '<input type="hidden" name="to_id" value="'.$ID.'" />';
        echo '<input type="hidden" name="from_id" value="'.$ID2.'" />';
        $selectUserChat = mysqli_query( $conn,"SELECT * FROM tbl_user_chat WHERE (from_id = $ID2 AND to_id = $ID) OR (from_id = $ID AND to_id = $ID2) ORDER BY ID DESC" );
        if ( mysqli_num_rows($selectUserChat) > 0 ) {
        	$secContainer = 0;
        	$secContainer_end = 0;
        	$secContainer_tmp_user = '';
            while($rowUserChat = mysqli_fetch_array($selectUserChat)) {
	            $chat_from_id = $rowUserChat['from_id'];
	            $chat_message = $rowUserChat['message'];
	            $chat_seen = $rowUserChat['seen'];

            	if (empty($secContainer_tmp_user)) {
            		$secContainer_tmp_user = $chat_from_id;
            		$secContainer_end++;
            	} else {
            		if ($secContainer_tmp_user <> $chat_from_id) {
            			$secContainer_tmp_user = $chat_from_id;
            			$secContainer = 0;
            			$secContainer_end = 0;
            		}
            	}

	            if ($secContainer_end == 0) {
	            	$secContainer_end++;
						echo '</div>
					</div>';
	            }

	            if ($secContainer == 0) {
					$secContainer++;

					if ($secContainer_tmp_user == $ID2) {
						echo '<div class="d-flex secContainer secSender">
							<div class="flex-shrink-0">
								<img src="'.$base_url.'uploads/avatar/'.$sender_userAvatar.'" alt="'.$sender_fullname.'" class="border border-2 rounded-circle" style="width: 40px; height: 40px;" onerror="this.onerror=null;this.src=\'https://via.placeholder.com/40x40/EFEFEF/AAAAAA.png?text=no+image\';">
							</div>
							<div class="d-flex flex-column-reverse flex-grow-1 secMessage">';
					} else {
						echo '<div class="d-flex secContainer secReceiver">
							<div class="flex-shrink-0">
								<img src="'.$base_url.'uploads/avatar/'.$receiver_userAvatar.'" alt="'.$receiver_fullname.'" class="border border-2 rounded-circle" style="width: 40px; height: 40px;" onerror="this.onerror=null;this.src=\'https://via.placeholder.com/40x40/EFEFEF/AAAAAA.png?text=no+image\';">
							</div>
							<div class="d-flex flex-column-reverse flex-grow-1 secMessage">';
					}
	            }
							echo '<div class="mb-1 p-2">'.$chat_message.'</div>';

            }

	            if ($secContainer_end > 0) {
	            	$secContainer_end = 0;
						echo '</div>
					</div>';
	            }
        }
	}
	if( isset($_POST['btnSend_Message']) ) {
    	$current_userID = $_COOKIE['ID'];
		$message = addslashes($_POST['message']);
		$sender = $_POST['from_id'];
		$receiver = $_POST['to_id'];
		$last_modified = date('Y-m-d');
		$msg = 'Sending Failed!';

		$sql = "INSERT INTO tbl_user_chat (user_id, from_id, to_id, message, last_modified)
		VALUES ('$current_userID', '$sender', '$receiver', '$message', '$last_modified')";
		if (mysqli_query($conn, $sql)) {
			$last_id = mysqli_insert_id($conn);
			$msg = 'Message Sent!';
		}

		$output = array(
			'message' => $msg
		);
		echo json_encode($output);
	}
	if( isset($_POST['btnSend_Chat']) ) {
    	$current_userID = $_COOKIE['ID'];

    	// Sender
		$sender = $_POST['from_id'];
    	$sender_fullname = '';
    	$sender_userAvatar = '';
        $selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE is_active = 1 AND ID = $sender" );
        if ( mysqli_num_rows($selectUser) > 0 ) {
            $rowUser = mysqli_fetch_array($selectUser);
            $sender_fullname = $rowUser['first_name'].' '.$rowUser['last_name'];
            $sender_email = $rowUser['email'];
        }
        $selectUserInfo = mysqli_query( $conn,"SELECT * FROM tbl_user_info WHERE user_id = $sender" );
        if ( mysqli_num_rows($selectUserInfo) > 0 ) {
            $rowUserInfo = mysqli_fetch_array($selectUserInfo);
            $sender_userAvatar = $rowUserInfo['avatar'];
        }

		$message = addslashes($_POST['message']);
		$receiver = $_POST['to_id'];
		$last_modified = date('Y-m-d');
		$msg = 'Sending Failed!';
        $selectUserR = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE is_active = 1 AND ID = $receiver" );
        if ( mysqli_num_rows($selectUserR) > 0 ) {
            $rowUserR = mysqli_fetch_array($selectUserR);
            $receiver_fullname = $rowUserR['first_name'].' '.$rowUserR['last_name'];
            $receiver_email = $rowUserR['email'];
        }

		$sql = "INSERT INTO tbl_user_chat (user_id, from_id, to_id, message, last_modified)
		VALUES ('$current_userID', '$sender', '$receiver', '$message', '$last_modified')";
		if (mysqli_query($conn, $sql)) {
			$last_id = mysqli_insert_id($conn);
			$msg = 'Message Sent!';

			$data_1 = '<div class="d-flex secContainer secSender">
				<div class="flex-shrink-0">
					<img src="'.$base_url.'uploads/avatar/'.$sender_userAvatar.'" alt="'.$sender_fullname.'" class="border border-2 rounded-circle" style="width: 40px; height: 40px;" onerror="this.onerror=null;this.src=\'https://via.placeholder.com/40x40/EFEFEF/AAAAAA.png?text=no+image\';">
				</div>
				<div class="d-flex flex-column-reverse flex-grow-1 secMessage">
					<div class="mb-1 p-2">'.stripcslashes($message).'</div>
				</div>
			</div>';

			$data_2 = '<div class="mb-1 p-2">'.stripcslashes($message).'</div>';


			$to = $receiver_email;
			$user = $receiver_fullname;
        	$from = $sender_email;
        	$name = $sender_fullname;
			$subject = 'New Message From '.$sender_fullname;
			
			$body = 'Hi '. $receiver_fullname .',<br><br>


			<b>'.$sender_fullname.'</b> said:<br>
			<i>"'.stripcslashes($message).'"</i><br><br>

			<a href="'. $base_url .'profile" target="_blank" style="font-weight: 600; padding: 10px 20px!important; text-decoration: none; color: #fff; background-color: #27a4b0; border-color: #208992; display: inline-block;">Reply</a>';
			
			php_mailer_chat($to, $user, $subject, $body, $from, $name);
		}

		$output = array(
			'current_userID' => $current_userID,
			'message' => $msg,
			'data_1' => $data_1,
			'data_2' => $data_2
		);
		echo json_encode($output);
	}


	// MARKETPLACE PAGE
	if( isset($_GET['marketplace_view']) ) {
		$category = $_GET['category'];

		$selectProd = mysqli_query( $conn,"SELECT * FROM tbl_products WHERE deleted = 0 ORDER BY ID DESC" );
		if (!empty($category)) { $selectProd = mysqli_query( $conn,"SELECT * FROM tbl_products WHERE deleted = 0 AND category IN ($category) ORDER BY ID DESC" ); }
        if ( mysqli_num_rows($selectProd) > 0 ) {
        	while($rowProd = mysqli_fetch_array($selectProd)) {
        		$data_ID = $rowProd['ID'];
        		$data_image = $rowProd['image'];
        		$data_name = $rowProd['name'];
        		$image_counter = 0;


        		if (!empty($data_image)) {
        			$data_image_array = explode(", ", $data_image);
        			foreach($data_image_array as $value) {
        				if (!empty($value)) {
        					$image_counter++;
        				}
        			}
        		}

        		if ($image_counter > 0) {
        			echo '<div class="col-md-3 mb-4 imgSet">
						<div id="product_'.$data_ID.'" class="carousel slide border rounded" data-bs-interval="false">';
							if ($image_counter > 1) {
								echo '<div class="carousel-indicators">
									<button type="button" data-bs-target="#product_'.$data_ID.'" data-bs-slide-to="0" aria-current="true" class="active"></button>';

									for ($i=1; $i < $image_counter ; $i++) { 
										echo '<button type="button" data-bs-target="#product_'.$data_ID.'" data-bs-slide-to="'.$i.'"></button>';
									}

								echo '</div>';
							}

							echo '<div class="carousel-inner rounded">';

								$active = 0;
                    			foreach($data_image_array as $value) {
                    				if (!empty($value)) {
                    					echo '<div class="carousel-item '; if ($active == 0) { $active++; echo 'active'; } echo '">
											<img src="'.$base_url.'uploads/products/'.$value.'" class="d-block w-100 imgCover" onerror="this.onerror=null;this.src=\'https://via.placeholder.com/150x150/EFEFEF/AAAAAA.png?text=no+image\';" />


										</div>';
                    				}
                    			}

							echo '</div>';

							if ($image_counter > 1) {
								echo '<button class="carousel-control-prev" type="button" data-bs-target="#product_'.$data_ID.'" data-bs-slide="prev">
									<span class="carousel-control-prev-icon" aria-hidden="true"></span>
									<span class="visually-hidden">Previous</span>
								</button>
								<button class="carousel-control-next" type="button" data-bs-target="#product_'.$data_ID.'" data-bs-slide="next">
									<span class="carousel-control-next-icon" aria-hidden="true"></span>
									<span class="visually-hidden">Next</span>
								</button>';
							}
							
							echo '<div class="d-flex justify-content-center align-items-center position-absolute imgView">
								<a href="marketplace-view?ID='.$data_ID.'"><h5 class="bg-primary text-light rounded p-2 bi bi-search"></h5></a>
							</div>
						</div>
						<p class="mt-3 mb-0 fw-bold imgName">'.$data_name.'</p>
					</div>';
        		} else {
					echo '<div class="col-md-3 mb-4 imgSet">
						<div class="position-relative">
							<img src="https://via.placeholder.com/150x150/EFEFEF/AAAAAA.png?text=no+image" class="d-block w-100 imgCover border rounded" />
							<div class="d-flex justify-content-center align-items-center position-absolute imgView">
								<a href="marketplace-view?ID='.$data_ID.'"><h5 class="bg-primary text-light rounded p-2 bi bi-search"></h5></a>
							</div>
						</div>
						<p class="mt-3 mb-0 fw-bold imgName">'.$data_name.'</p>
					</div>';
        		}
        	}
        }
	}
	if( isset($_POST['btnMarket_Review']) ) {
		$ID = $_POST['ID'];
		$rating = $_POST['rating'];
		$comment = addslashes($_POST['comment']);

    	$current_userID = 0;
    	if (isset($_COOKIE['ID'])) { $current_userID = $_COOKIE['ID']; }
		$last_modified = date('Y-m-d');

		$sql = "INSERT INTO tbl_products_review (user_id, product_id, rating, comment, last_modified)
		VALUES ('$current_userID', '$ID', '$rating', '$comment', '$last_modified')";
		if (mysqli_query($conn, $sql)) {
			$last_id = mysqli_insert_id($conn);

            $last_modified = new DateTime($last_modified);
            $last_modified = $last_modified->format('M d, Y');

			$data = '<li class="list-group-item d-flex justify-content-between align-items-start" id="li_'.$last_id.'">
				<div class="ms-2 me-auto">
					<div class="fw-bold">Annonymous</div>
					<span class="star-rating star-5">
						<input type="radio" name="rating_'.$last_id.'" value="1" disabled '; $data .= $rating == 1 ? 'checked':''; $data .= '><i></i>
						<input type="radio" name="rating_'.$last_id.'" value="2" disabled '; $data .= $rating == 2 ? 'checked':''; $data .= '><i></i>
						<input type="radio" name="rating_'.$last_id.'" value="3" disabled '; $data .= $rating == 3 ? 'checked':''; $data .= '><i></i>
						<input type="radio" name="rating_'.$last_id.'" value="4" disabled '; $data .= $rating == 4 ? 'checked':''; $data .= '><i></i>
						<input type="radio" name="rating_'.$last_id.'" value="5" disabled '; $data .= $rating == 5 ? 'checked':''; $data .= '><i></i>
					</span><br>
					'.stripcslashes($comment).'
				</div>
				<div class="text-end">
					<small class="fw-lighter text-muted">'.$last_modified.'</small><br>
					<span class="btn badge btn-primary rounded-pill '; if($current_userID == 0) { $data .= 'd-none'; } $data .= '" onclick="btnReviewReply('.$current_userID.')">Reply</span>
				</div>
			</li>';

			$output = array(
				'data' => $data
			);
			echo json_encode($output);
		}
	}


    // CONTACT PAGE
    if( isset($_POST['btnSend_Contact']) ) {
        $name = addslashes($_POST['name']);
        $email = $_POST['email'];
        $contact = addslashes($_POST['contact']);
        $message = addslashes($_POST['message']);

        $sql = "INSERT INTO tbl_contact (name, email, contact, message)
        VALUES ('$name', '$email', '$contact', '$message')";

        if (mysqli_query($conn, $sql)) {

            $last_id = mysqli_insert_id($conn);

            $from_email = $email;
            $from_name = $name;
            $to = 'services@interlinkiq.com';
            $to2 = 'enterprise@interlinkiq.com';
            $to3 = 'virginia@consultareinc.com';
            $user = 'InterlinkIQ';

            $subject = 'InterlinkIQ-Consultare Inc. Group Inquiry';
            
            $body = '<b>From:</b> '.$name.'<br>
            <b>Email:</b> '.$email.'<br>
            <b>Contact:</b> '.$contact.'<br>
            <b>Message:</b><br>'.$message;
            
            php_mailer_contact($to, $to2, $to3, $user, $from_email, $from_name, $subject, $body);

            echo json_encode($last_id);
        }
        mysqli_close($conn);
    }


    if( isset($_GET['summary']) ) {
        $ID = $_GET['summary'];
        $type = $_GET['type'];

        if ($type == 1) {
            $selectData = mysqli_query( $conn,"SELECT * FROM tbl_hr_department WHERE deleted = 0 AND user_id = $ID AND status = 1 ORDER BY title" );
            if ( mysqli_num_rows($selectData) > 0 ) {
                $counter = 1;
                while($rowData = mysqli_fetch_array($selectData)) {
                    $data_ID = $rowData["ID"];
                    $data_title = $rowData["title"];
                    $data_description = $rowData["description"];

                    echo '<tr>
                        <td>'.$counter++.'</td>
                        <td>'.$data_title.'</td>
                        <td>'.$data_description.'</td>
                    </tr>';
                }
            }
        } else if ($type == 2) {
            $selectData = mysqli_query( $conn,"SELECT * FROM tbl_hr_department WHERE deleted = 0 AND user_id = $ID AND status = 0 ORDER BY title" );
            if ( mysqli_num_rows($selectData) > 0 ) {
                $counter = 1;
                while($rowData = mysqli_fetch_array($selectData)) {
                    $data_ID = $rowData["ID"];
                    $data_title = $rowData["title"];
                    $data_description = $rowData["description"];

                    echo '<tr>
                        <td>'.$counter++.'</td>
                        <td>'.$data_title.'</td>
                        <td>'.$data_description.'</td>
                    </tr>';
                }
            }
        } else if ($type == 3) {
            $selectData = mysqli_query( $conn,"SELECT
                *
                FROM (
                    SELECT 
                    d.ID AS d_ID,
                    d.title AS d_title,
                    d.description AS d_description,
                    e.ID AS e_ID,
                    e.first_name AS e_first_name
                    FROM tbl_hr_department AS d

                    LEFT JOIN (
                        SELECT
                        *
                        FROM tbl_hr_employee
                        WHERE user_id = $ID
                        AND suspended = 0
                        AND status = 1
                    ) AS e
                    ON FIND_IN_SET(d.ID, REPLACE(e.department_id, ' ', '')) > 0

                    WHERE d.user_id = $ID

                    GROUP BY d.ID
                    ORDER BY d.title
                ) AS r
                WHERE e_ID IS NULL" );
            if ( mysqli_num_rows($selectData) > 0 ) {
                $counter = 1;
                while($rowData = mysqli_fetch_array($selectData)) {
                    $d_ID = $rowData["d_ID"];
                    $d_title = $rowData["d_title"];
                    $d_description = $rowData["d_description"];

                    echo '<tr>
                        <td>'.$counter++.'</td>
                        <td>'.$d_title.'</td>
                        <td>'.$d_description.'</td>
                    </tr>';
                }
            }
        } else if ($type == 4) {
            $selectData = mysqli_query( $conn,"SELECT * FROM tbl_hr_department WHERE deleted = 0 AND user_id = $ID AND LENGTH(files) = 0 ORDER BY title" );
            if ( mysqli_num_rows($selectData) > 0 ) {
                $counter = 1;
                while($rowData = mysqli_fetch_array($selectData)) {
                    $data_ID = $rowData["ID"];
                    $data_title = $rowData["title"];
                    $data_description = $rowData["description"];

                    echo '<tr>
                        <td>'.$counter++.'</td>
                        <td>'.$data_title.'</td>
                        <td>'.$data_description.'</td>
                    </tr>';
                }
            }
        }
    }
    if( isset($_GET['summary_JD']) ) {
        $ID = $_GET['summary_JD'];
        $type = $_GET['type'];

        if ($type == 1) {
            $selectData = mysqli_query( $conn,"SELECT * FROM tbl_hr_job_description WHERE user_id = $ID AND status = 1 ORDER BY title" );
            if ( mysqli_num_rows($selectData) > 0 ) {
                $counter = 1;
                while($rowData = mysqli_fetch_array($selectData)) {
                    $data_ID = $rowData["ID"];
                    $data_title = $rowData["title"];
                    $data_description = $rowData["description"];

                    echo '<tr>
                        <td>'.$counter++.'</td>
                        <td>'.$data_title.'</td>
                        <td>'.$data_description.'</td>
                    </tr>';
                }
            }
        } else if ($type == 2) {
            $selectData = mysqli_query( $conn,"SELECT * FROM tbl_hr_job_description WHERE user_id = $ID AND status = 0 ORDER BY title" );
            if ( mysqli_num_rows($selectData) > 0 ) {
                $counter = 1;
                while($rowData = mysqli_fetch_array($selectData)) {
                    $data_ID = $rowData["ID"];
                    $data_title = $rowData["title"];
                    $data_description = $rowData["description"];

                    echo '<tr>
                        <td>'.$counter++.'</td>
                        <td>'.$data_title.'</td>
                        <td>'.$data_description.'</td>
                    </tr>';
                }
            }
        } else if ($type == 3) {
            $selectData = mysqli_query( $conn,"SELECT
                *
                FROM (
                    SELECT 
                    jd.ID AS jd_ID,
                    jd.title AS jd_title,
                    jd.description AS jd_description,
                    e.ID AS e_ID,
                    e.first_name AS e_first_name
                    FROM tbl_hr_job_description AS jd

                    LEFT JOIN (
                        SELECT
                        *
                        FROM tbl_hr_employee
                        WHERE user_id = $ID
                        AND suspended = 0
                        AND status = 1
                    ) AS e
                    ON FIND_IN_SET(jd.ID, REPLACE(e.job_description_id, ' ', '')) > 0

                    WHERE jd.user_id = $ID

                    GROUP BY jd.ID
                    ORDER BY jd.title
                ) AS r
                WHERE e_ID IS NULL" );
            if ( mysqli_num_rows($selectData) > 0 ) {
                $counter = 1;
                while($rowData = mysqli_fetch_array($selectData)) {
                    $jd_ID = $rowData["jd_ID"];
                    $jd_title = $rowData["jd_title"];
                    $jd_description = $rowData["jd_description"];

                    echo '<tr>
                        <td>'.$counter++.'</td>
                        <td>'.$jd_title.'</td>
                        <td>'.$jd_description.'</td>
                    </tr>';
                }
            }
        } else if ($type == 4) {
            $selectData = mysqli_query( $conn,"SELECT
                *
                FROM (
                    SELECT 
                    jd.ID AS jd_ID,
                    jd.title AS jd_title,
                    jd.description AS jd_description,
                    t.ID AS t_ID,
                    t.title AS t_title
                    FROM tbl_hr_job_description AS jd

                    LEFT JOIN (
                        SELECT
                        *
                        FROM tbl_hr_trainings
                        WHERE user_id = $ID
                        AND deleted = 0
                    ) AS t
                    ON FIND_IN_SET(jd.ID, REPLACE(t.job_description_id, ' ', '')) > 0

                    WHERE jd.user_id = $ID

                    GROUP BY jd.ID
                    ORDER BY jd.title
                ) AS r
                WHERE t_ID IS NULL" );
            if ( mysqli_num_rows($selectData) > 0 ) {
                $counter = 1;
                while($rowData = mysqli_fetch_array($selectData)) {
                    $jd_ID = $rowData["jd_ID"];
                    $jd_title = $rowData["jd_title"];
                    $jd_description = $rowData["jd_description"];

                    echo '<tr>
                        <td>'.$counter++.'</td>
                        <td>'.$jd_title.'</td>
                        <td>'.$jd_description.'</td>
                    </tr>';
                }
            }
        }
    }


	if( isset($_GET['counterup']) ) {
		$page = $_GET['counterup'];

		echo json_encode(counterup_tbl($page));
	}

	function counterup_tbl($page){
		global $conn;
		if (!empty($_COOKIE['switchAccount'])) {
			$portal_user = $_COOKIE['ID'];
			$user_id = $_COOKIE['switchAccount'];
		}
		else {
			$portal_user = $_COOKIE['ID'];
			$user_id = employerID($portal_user);
		}

		$statusActive = 0;
        $statusSuspended = 0;
        $statusInactive = 0;
        $statusInactiveMonth = 0;
        $statusNotYetPerform = 0;
        $statusNoEmployee = 0;
        $statusNoTraining = 0;
        $statusFiles = 0;
        $statusTotal = 0;

        if ($page === "department") {
	        $selectedDepartmentCounter = mysqli_query( $conn,"SELECT * FROM tbl_hr_department WHERE deleted = 0 AND user_id = $user_id" );
	        if ( mysqli_num_rows($selectedDepartmentCounter) > 0 ) {
	            while($rowDepartmentCounter = mysqli_fetch_array($selectedDepartmentCounter)) {
	                $files = $rowDepartmentCounter["files"];
	                $status = $rowDepartmentCounter["status"];
	                $statusID = $rowDepartmentCounter["ID"];

	                if ( $status == 0 ) { $statusInactive++; }
	                else if ( $status == 1 ) { $statusActive++; }
	                $statusTotal++;

	                if ( $files === "" ) { $statusFiles++; }

                    $HasEmployee = false;
	                // $selectEmployeeCounter = mysqli_query( $conn,"SELECT * FROM tbl_hr_employee WHERE trainings_id_status <> '' " );
	                $selectEmployeeCounter = mysqli_query( $conn,"SELECT * FROM tbl_hr_employee WHERE user_id = $user_id AND suspended = 0 AND status = 1" );
                    if ( mysqli_num_rows($selectEmployeeCounter) > 0 ) {
                        $countDepartmentChecking = 0;
                        while($rowEmployeeCounter = mysqli_fetch_array($selectEmployeeCounter)) {
                            $rowEmployeeDepartment = $rowEmployeeCounter['department_id'];

                            $array_employeeJD = explode(", ", $rowEmployeeDepartment);
                            if (in_array($rowDepartmentCounter['ID'], $array_employeeJD)) {
                                $HasEmployee = true;
                            }
                        }

                        if ( $HasEmployee == false ) {
                            $statusNotYetPerform++;
                        }
                    }
	            }
	        }
		} else if ($page === "trainings") {
            $selectTrainingCounter = mysqli_query( $conn,"SELECT * FROM tbl_hr_trainings WHERE deleted = 0 AND user_id = $user_id" );
            if ( mysqli_num_rows($selectTrainingCounter) > 0 ) {
                while($rowTrainingCounter = mysqli_fetch_array($selectTrainingCounter)) {
                    $files = $rowTrainingCounter["files"];
                    $status = $rowTrainingCounter["status"];
                    $statusID = $rowTrainingCounter["ID"];

                    if ( $status == 0 ) { $statusInactive++; }
                    else if ( $status == 1 ) { $statusActive++; }
                    $statusTotal++;

                    // if (empty($files)) { $statusFiles++; }

                    if (!empty($files)) {
                        $output_file = json_decode($files,true);

                        // if (!empty($output_file[])) {
                        //  if (count($output_file['file_doc']) > 0) { $statusFiles++; }
                        // }
                        $file_doc = false;
                        if ($output_file) {
                            foreach ($output_file as $key => $value) {
                                // $file_doc = $value['file_doc'];
                                if (!empty($value['file_doc'])) {
                                    $file_doc = true;
                                }
                            }
                        }

                        if ($file_doc == false) {
                            $statusFiles++;
                        }
                    } else {
                        $statusFiles++;
                    }

                    $selectEmployeeCounter = mysqli_query( $conn,"SELECT * FROM tbl_hr_employee WHERE trainings_id_status > 0 " );
                    if ( mysqli_num_rows($selectEmployeeCounter) > 0 ) {
                        $countRequiredTrainingChecking = 0;
                        while($rowEmployeeCounter = mysqli_fetch_array($selectEmployeeCounter)) {
                            $rowEmployeeTrainingStatus = $rowEmployeeCounter['trainings_id_status'];
                            $output = json_decode($rowEmployeeTrainingStatus,true);
                            if (array_key_exists($statusID, $output)) {
                                if ( $output[$statusID] == 0 ) {
                                    $countRequiredTrainingChecking++;
                                }
                            } else {
                                 $countRequiredTrainingChecking++;
                            }
                        }

                        if ($countRequiredTrainingChecking > 0) {
                            $statusNotYetPerform++;
                        }
                    } else {
                        $statusNotYetPerform++;
                    }
                }
            }
		} else if ($page === "job-description") {
            $selectJDCounter = mysqli_query( $conn,"SELECT * FROM tbl_hr_job_description WHERE user_id = $user_id" );
            if ( mysqli_num_rows($selectJDCounter) > 0 ) {
                while($rowJDCounter = mysqli_fetch_array($selectJDCounter)) {
                    $status = $rowJDCounter["status"];

                    if ( $status == 0 ) { $statusInactive++; }
                    else if ( $status == 1 ) { $statusActive++; }
                    $statusTotal++;


                    // TOTAL JOB DESC. W/NO TRAINING
                    $HasTrainings = false;
                    $selectTrainingsCounter = mysqli_query( $conn,"SELECT * FROM tbl_hr_trainings" );
                    while($rowTrainingCounter = mysqli_fetch_array($selectTrainingsCounter)) {
                        $array_jd_counter = explode(", ", $rowTrainingCounter["job_description_id"]);
                        foreach ($array_jd_counter as $value) {
                            if ( $value == $rowJDCounter["ID"] ) {
                                $HasTrainings = true;
                            }
                        }
                    }
                    if ( $HasTrainings == false ) { $statusNoTraining++; }

                    // TOTAL JOB DESC. W/NO EMPLOYEE
                    $HasEmployee = false;
                    // $selectEmployee = mysqli_query( $conn,"SELECT * FROM tbl_hr_employee WHERE trainings_id_status <> '' " );
                    $selectEmployee = mysqli_query( $conn,"SELECT * FROM tbl_hr_employee WHERE user_id = $user_id AND suspended = 0 AND status = 1" );
                    if ( mysqli_num_rows($selectEmployee) > 0 ) {
                        while($rowEmployee = mysqli_fetch_array($selectEmployee)) {
                            $rowEmployeeJD = $rowEmployee['job_description_id'];

                            $array_employeeJD = explode(", ", $rowEmployeeJD);
                            if (in_array($rowJDCounter['ID'], $array_employeeJD)) {
                                $HasEmployee = true;
                            }
                        }
                    }

                    if ( $HasEmployee == false ) {
                        $statusNoEmployee++;
                    }
                }
            }
		} else if ($page === "employee") {
            $selectEmployeeCounter = mysqli_query( $conn,"SELECT * FROM tbl_hr_employee WHERE user_id = $user_id" );
            if ( mysqli_num_rows($selectEmployeeCounter) > 0 ) {
                while($rowEmployeeCounter = mysqli_fetch_array($selectEmployeeCounter)) {
                    $suspended = $rowEmployeeCounter["suspended"];
                    $status = $rowEmployeeCounter["status"];

                    if ($suspended != 1) {
                        if ( $status == 0 ) { $statusInactive++; }
                        else if ( $status == 1 ) { $statusActive++; }
                    }
                    $statusTotal++;
                }
            }
            
            $selectEmployeeSuspendedCounter = mysqli_query( $conn,"SELECT * FROM tbl_hr_employee WHERE suspended = 1 AND user_id = $user_id" );
            if ( mysqli_num_rows($selectEmployeeSuspendedCounter) > 0 ) {
                while($rowEmployeeSuspendedCounter = mysqli_fetch_array($selectEmployeeSuspendedCounter)) {
                    $statusSuspended++;
                }
            }

            $selectEmployeeMonthCounter = mysqli_query( $conn,"SELECT * FROM tbl_hr_employee WHERE last_modified>=DATE_SUB( CURDATE(), INTERVAL 1 MONTH ) AND status = 0 AND user_id = $user_id" );
            if ( mysqli_num_rows($selectEmployeeMonthCounter) > 0 ) {
                while($rowEmployeeCounter = mysqli_fetch_array($selectEmployeeMonthCounter)) {
                    $statusInactiveMonth++;
                }
            }
		} else if ($page === "customer") {
            $selectCustomerCounter = mysqli_query( $conn,"SELECT * FROM tbl_customer WHERE user_id = $user_id" );
            if ( mysqli_num_rows($selectCustomerCounter) > 0 ) {
                while($rowCustomerCounter = mysqli_fetch_array($selectCustomerCounter)) {
                    $status = $rowCustomerCounter["status"];

                    if ( $status == 0 ) { $statusInactive++; }
                    else if ( $status == 1 ) { $statusActive++; }
                    $statusTotal++;
                }
            }

            $selectCustomerMonthCounter = mysqli_query( $conn,"SELECT * FROM tbl_customer WHERE last_modified>=DATE_SUB( CURDATE(), INTERVAL 1 MONTH ) AND status = 0" );
            if ( mysqli_num_rows($selectCustomerMonthCounter) > 0 ) {
                while($rowCustomerMonthCounter = mysqli_fetch_array($selectCustomerMonthCounter)) {
                    $statusInactiveMonth++;
                }
            }
		} else if ($page === "supplier") {
            $selectSupplierCounter = mysqli_query( $conn,"SELECT * FROM tbl_supplier WHERE user_id = $user_id" );
            if ( mysqli_num_rows($selectSupplierCounter) > 0 ) {
                while($rowSupplierCounter = mysqli_fetch_array($selectSupplierCounter)) {
                    $status = $rowSupplierCounter["status"];

                    if ( $status == 0 ) { $statusInactive++; }
                    else if ( $status == 1 ) { $statusActive++; }
                    $statusTotal++;
                }
            }

            $selectSupplierMonthCounter = mysqli_query( $conn,"SELECT * FROM tbl_supplier WHERE last_modified>=DATE_SUB( CURDATE(), INTERVAL 1 MONTH ) AND status = 0" );
            if ( mysqli_num_rows($selectSupplierMonthCounter) > 0 ) {
                while($rowSupplierMonthCounter = mysqli_fetch_array($selectSupplierMonthCounter)) {
                    $statusInactiveMonth++;
                }
            }
		} else if ($page === "rd") {
            $selectSupplierCounter = mysqli_query( $conn,"SELECT * FROM tbl_rd WHERE user_id = $user_id" );
            if ( mysqli_num_rows($selectSupplierCounter) > 0 ) {
                while($rowSupplierCounter = mysqli_fetch_array($selectSupplierCounter)) {
                    $status = $rowSupplierCounter["status"];

                    if ( $status == 0 ) { $statusInactive++; }
                    else if ( $status == 1 ) { $statusActive++; }
                    $statusTotal++;
                }
            }

            $selectSupplierMonthCounter = mysqli_query( $conn,"SELECT * FROM tbl_supplier WHERE last_modified>=DATE_SUB( CURDATE(), INTERVAL 1 MONTH ) AND status = 0" );
            if ( mysqli_num_rows($selectSupplierMonthCounter) > 0 ) {
                while($rowSupplierMonthCounter = mysqli_fetch_array($selectSupplierMonthCounter)) {
                    $statusInactiveMonth++;
                }
            }
		}

        //Error catching
        if ($statusTotal == 0) {
            $statusTotal = 100;
        }

		$output = array(
			'statusActive' => $statusActive,
			'statusInactive' => $statusInactive,
            'statusSuspended' => $statusSuspended,
			'statusInactiveMonth' => $statusInactiveMonth,
			'statusNotYetPerform' => $statusNotYetPerform,
			'statusNoEmployee' => $statusNoEmployee,
			'statusNoTraining' => $statusNoTraining,
			'statusFiles' => $statusFiles,
			'statusTotal' => $statusTotal,
			'ID' => $user_id
		);
		return $output;
	}
	
	function employerID($ID) {
		global $conn;

		$selectUser = mysqli_query( $conn,"SELECT * from tbl_user WHERE ID = $ID" );
        $rowUser = mysqli_fetch_array($selectUser);
        $current_userEmployeeID = $rowUser['employee_id'];

        $current_userEmployerID = $ID;
        if ($current_userEmployeeID > 0) {
            // $selectEmployer = mysqli_query( $conn,"SELECT * FROM tbl_hr_employee WHERE suspended = 0 AND status = 1 AND ID=$current_userEmployeeID" );
            $selectEmployer = mysqli_query( $conn,"SELECT * FROM tbl_hr_employee WHERE ID=$current_userEmployeeID" );
            if ( mysqli_num_rows($selectEmployer) > 0 ) {
                $rowEmployer = mysqli_fetch_array($selectEmployer);
                $current_userEmployerID = $rowEmployer["user_id"];
            }
        }

        return $current_userEmployerID;
	}
	function employeeID($ID) {
		global $conn;

		$selectUser = mysqli_query( $conn,"SELECT * from tbl_user WHERE ID = $ID" );
        $rowUser = mysqli_fetch_array($selectUser);
        $current_userEmployeeID = $rowUser['employee_id'];

        return $current_userEmployeeID;
	}



	if( isset($_POST['btnSave_userInfo']) ) {
		$ID = $_POST['ID'];	 
		$first_name = $_POST['first_name'];
		$last_name = $_POST['last_name'];
		$mobile = $_POST['mobile'];
		$interest = $_POST['interest'];
		$address = $_POST['address'];
		$driver_license = $_POST['driver_license'];
		$occupation = $_POST['occupation'];
		$about = $_POST['about'];
		$website = $_POST['website'];
		$message = "Error";


		mysqli_query( $conn,"UPDATE tbl_user set first_name='". $first_name ."', last_name='". $last_name ."' WHERE ID='". $ID ."'" );

		$selectData = mysqli_query( $conn,'SELECT * FROM tbl_user_info WHERE user_id="'. $ID .'"' );
		if ( mysqli_num_rows($selectData) > 0 ) {
			$rowData = mysqli_fetch_array($selectData);
			$data_ID = $rowData['ID'];

			mysqli_query( $conn,"UPDATE tbl_user_info set mobile='". $mobile ."', interest='". $interest ."', address='". $address ."', driver_license='". $driver_license ."', occupation='". $occupation ."', about='". $about ."', website='". $website ."' WHERE ID='". $data_ID ."'" );
			$message = "Success";
		} else {
			$sql = "INSERT INTO tbl_user_info (user_id, mobile, interest, occupation, about, website)
			VALUES ('$ID', '$mobile', '$interest', '$occupation', '$about', '$website')";

			if (mysqli_query($conn, $sql)) {
				$message = "Success";
			}
		}
		
		$output = array(
			'ID' => $ID,
			'first_name' => $first_name,
			'last_name' => $last_name,
			'mobile' => $mobile,
			'interest' => $interest,
			'occupation' => $occupation,
			'about' => $about,
			'website' => $website
		);
		echo json_encode($output);
		mysqli_close($conn);
	}

	if( isset($_POST['btnSave_userSocial']) ) {
		$ID = $_POST['ID'];
		$linkedin = $_POST['linkedin'];
		$facebook = $_POST['facebook'];
		$message = "Error";

		$selectData = mysqli_query( $conn,'SELECT * FROM tbl_user_social_media WHERE user_id="'. $ID .'"' );
		if ( mysqli_num_rows($selectData) > 0 ) {
			$rowData = mysqli_fetch_array($selectData);
			$data_ID = $rowData['ID'];

			mysqli_query( $conn,"UPDATE tbl_user_social_media set linkedin='". $linkedin ."', facebook='". $facebook ."' WHERE ID='". $data_ID ."'" );
			$message = "Success";
		} else {
			$sql = "INSERT INTO tbl_user_social_media (user_id, linkedin, facebook)
			VALUES ('$ID', '$linkedin', '$facebook')";

			if (mysqli_query($conn, $sql)) {
				$message = "Success";
			}
		}

		$output = array(
			'linkedin' => $linkedin,
			'facebook' => $facebook
		);
		echo json_encode($output);
		mysqli_close($conn);
	}

	if( isset($_POST['btnSave_userAvatar']) ) {
		$ID = $_POST['ID'];	 
		$files = "";
		$success = true;
		$message = "Error";

		if( !empty( $_FILES['file']['name'] ) ) {
			$valid_extensions = array('jpeg', 'jpg', 'png'); // valid extensions
			$path = 'uploads/avatar/'; // upload directory
			$file = $_FILES['file']['name'];
			$tmp = $_FILES['file']['tmp_name'];
			// get uploaded file's extension
			$ext = strtolower(pathinfo($file, PATHINFO_EXTENSION));
			// can upload same image using rand function
			$final_file = rand(1000,1000000).' - '.$file;
			// check's valid format
			if(in_array($ext, $valid_extensions)) {
				$files = $final_file;
				$path = $path.$final_file;
				if(move_uploaded_file($tmp,$path)) {
					$success = true;
				}
			} else {
				$success = false;
			}
		}

		if ($success == true) {

			$selectData = mysqli_query( $conn,'SELECT * FROM tbl_user_info WHERE user_id="'. $ID .'"' );
			if ( mysqli_num_rows($selectData) > 0 ) {
				$rowData = mysqli_fetch_array($selectData);
				$data_ID = $rowData['ID'];

				mysqli_query( $conn,"UPDATE tbl_user_info set avatar='". $files ."' WHERE ID='". $data_ID ."'" );
				$message = "Success";
			} else {
				$sql = "INSERT INTO tbl_user_info (user_id, avatar) VALUES ('$ID', '$files')";

				if (mysqli_query($conn, $sql)) {
					$message = "Success";
				}
			}

			if (!mysqli_error($conn)) {
				$output = array(
					'avatar' => $files
				);
				echo json_encode($output);
			}
			mysqli_close($conn);
		}
	}

	if( isset($_POST['btnSave_userPassword']) ) {
		$ID = $_POST['ID'];
		$password = $_POST['password'];
		$password_new = $_POST['password_new'];
		$password_hash = password_hash($password_new, PASSWORD_DEFAULT);
		$message = "Error";

		$selectData = mysqli_query( $conn,'SELECT * FROM tbl_user WHERE ID="'. $ID .'"' );
		if ( mysqli_num_rows($selectData) > 0 ) {
			$rowData = mysqli_fetch_array($selectData);
			$data_ID = $rowData['ID'];
			$data_password = $rowData['password'];

			$isPasswordCorrect = password_verify($password, $data_password);
			if ($isPasswordCorrect == true) {
				mysqli_query( $conn,"UPDATE tbl_user set password='". $password_hash ."' WHERE ID='". $data_ID ."'" );
				$message = "Success";
			} else {
				$message = "Incorrect Password! Please try again";
			}
		}
		
		$output = array(
			'message' => $message
		);
		echo json_encode($output);
		mysqli_close($conn);
	}

	if( isset($_POST['btnSave_userPrivacy']) ) {
		$ID = $_POST['ID'];
		$optionPrivacy = array();
		array_push($optionPrivacy, $_POST['optionPrivacy1']);
		array_push($optionPrivacy, $_POST['optionPrivacy2']);
		array_push($optionPrivacy, $_POST['optionPrivacy3']);
		array_push($optionPrivacy, $_POST['optionPrivacy4']);
		array_push($optionPrivacy, $_POST['optionPrivacy5']);
		$message = "Error";

		$optionPrivacy = implode(", ",$optionPrivacy);

		$selectData = mysqli_query( $conn,'SELECT * FROM tbl_user_info WHERE user_id="'. $ID .'"' );
		if ( mysqli_num_rows($selectData) > 0 ) {
			$rowData = mysqli_fetch_array($selectData);
			$data_ID = $rowData['ID'];

			mysqli_query( $conn,"UPDATE tbl_user_info set privacy='". $optionPrivacy ."' WHERE ID='". $data_ID ."'" );
			$message = "Success";
		} else {
			$sql = "INSERT INTO tbl_user_info (user_id, privacy) VALUES ('$ID', '$optionPrivacy')";

			if (mysqli_query($conn, $sql)) {
				$message = "Success";
			}
		}
		
		$output = array(
			'message' => $message
		);
		echo json_encode($output);
		mysqli_close($conn);
	}

	if( isset($_POST['btnSave_Settings']) ) {
		$ID = $_POST['ID'];
		$background = array();
		array_push($background, $_POST['bgHeader']);
		array_push($background, $_POST['bgHeaderLogo']);
		array_push($background, $_POST['bgSidebar']);
		array_push($background, $_POST['bgBody']);
		$message = "Error";

		$background = implode(", ",$background);

		$selectData = mysqli_query( $conn,'SELECT * FROM tbl_settings WHERE user_id="'. $ID .'"' );
		if ( mysqli_num_rows($selectData) > 0 ) {
			$rowData = mysqli_fetch_array($selectData);
			$data_ID = $rowData['ID'];

			mysqli_query( $conn,"UPDATE tbl_settings set background='". $background ."', reset='1' WHERE ID='". $data_ID ."'" );
			$message = "Success";
		} else {
			$sql = "INSERT INTO tbl_settings (user_id, background) VALUES ('$ID', '$background')";

			if (mysqli_query($conn, $sql)) {
				$message = "Success";
			}
		}

		$output = array(
			'message' => $message
		);
		echo json_encode($output);
		mysqli_close($conn);
	}
	
	if( isset($_POST['btnSave_SettingsDefault']) ) {
		$ID = $_POST['ID'];
		$message = "Error";

		$selectData = mysqli_query( $conn,'SELECT * FROM tbl_settings WHERE user_id="'. $ID .'"' );
		if ( mysqli_num_rows($selectData) > 0 ) {
			$rowData = mysqli_fetch_array($selectData);
			$data_ID = $rowData['ID'];

			mysqli_query( $conn,"UPDATE tbl_settings set reset='0' WHERE ID='". $data_ID ."'" );
			$message = "Success";
		} else {
			$message = "Success";
		}

		$output = array(
			'message' => $message
		);
		echo json_encode($output);
		mysqli_close($conn);
	}

	if( isset($_POST['btnSave_userJob']) ) {
		$ID = $_POST['ID'];
		$is_active = 0;

        if (!empty($_COOKIE['switchAccount'])) {
			$portal_user = $_COOKIE['ID'];
			$user_id = $_COOKIE['switchAccount'];
		}
		else {
			$portal_user = $_COOKIE['ID'];
			$user_id = employerID($portal_user);
		}
        $process = true;

		// User Section
		$first_name = addslashes($_POST['first_name']);
		$last_name = addslashes($_POST['last_name']);
		mysqli_query( $conn,"UPDATE tbl_user set first_name='". $first_name ."', last_name='". $last_name ."' WHERE ID='". $ID ."'" );

		// Social Media
		$website = addslashes($_POST['website']);
		$linkedin = addslashes($_POST['linkedin']);
		$facebook = addslashes($_POST['facebook']);
		$twitter = addslashes($_POST['twitter']);
		$selectSocial = mysqli_query( $conn,"SELECT * FROM tbl_user_social_media WHERE user_id=$ID");
		if ( mysqli_num_rows($selectSocial) > 0 ) {
			mysqli_query( $conn,"UPDATE tbl_user_social_media set linkedin='". $linkedin ."', facebook='". $facebook ."', twitter='". $twitter ."', website='". $website ."' WHERE user_id='". $ID ."'" );
		} else {
			$sql = "INSERT INTO tbl_user_social_media (user_id, linkedin, facebook, twitter, website)
			VALUES ( '$ID', '$linkedin', '$facebook', '$twitter', '$website')";
			mysqli_query($conn, $sql);
		}

		// Info Section
		$mobile = addslashes($_POST['mobile']);
		$address = addslashes($_POST['address']);

		$profile_tmp = $_POST['profile_tmp'];
		$profile_file = $_FILES['profile']['name'];
		if (!empty($profile_file)) {
			$cv_file_tmp = $_FILES['profile']['tmp_name'];
            $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
            $ext = strtolower(pathinfo($profile_file, PATHINFO_EXTENSION));
			$path = 'uploads/avatar/';
			$random = rand(1000,1000000);
			$profile_file = $random . ' - ' . $profile_file;
			$path = $path.$profile_file;

            if(!in_array($ext, $invalid_extensions)) {
                move_uploaded_file($cv_file_tmp, $path);
            } else {
                $process = false;
            }
		} else {
			$profile_file = $profile_tmp;
		}
        if ($process == true) {
    		$selectInfo = mysqli_query( $conn,"SELECT * FROM tbl_user_info WHERE user_id=$ID");
    		if ( mysqli_num_rows($selectInfo) > 0 ) {
    			mysqli_query( $conn,"UPDATE tbl_user_info set mobile='". $mobile ."', address='". $address ."', website='". $website ."', avatar='". $profile_file ."' WHERE user_id='". $ID ."'" );
    		} else {
    			$sql = "INSERT INTO tbl_user_info (user_id, mobile, address, website, avatar) VALUES ( '$ID', '$mobile', '$address', '$website', '$profile_file' )";
    			mysqli_query($conn, $sql);
    		}
        }

		$cv_tmp = $_POST['cv_tmp'];
		$cv_file = $_FILES['cv']['name'];
		if (!empty($cv_file)) {
			$cv_file_tmp = $_FILES['cv']['tmp_name'];
            $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
            $ext = strtolower(pathinfo($profile_file, PATHINFO_EXTENSION));
			$path = 'uploads/job/';
			$random = rand(1000,1000000);
			$cv_file = $random . ' - ' . $cv_file;
			$path = $path.$cv_file;

            if(!in_array($ext, $invalid_extensions)) {
                move_uploaded_file($cv_file_tmp, $path);
            } else {
                $process = false;
            }

		} else {
			$cv_file = $cv_tmp;
		}

		// Other Info Section
		$education = '';
		if (!empty($_POST['education'])) {
			$arr_item = array();
			for ($i=0; $i < count($_POST['education']); $i++) {
				$educ_school = addslashes($_POST['education'][$i]['educ_school']);
				$educ_degree = addslashes($_POST['education'][$i]['educ_degree']);
				$educ_diploma_tmp = $_POST['education'][$i]['educ_diploma_tmp'];

				$educ_diploma = implode('*', $_FILES['education']['name'][$i]);
				if (!empty($educ_diploma)) {
					$files = implode('*', $_FILES['education']['name'][$i]);
					$tmp = implode('*', $_FILES['education']['tmp_name'][$i]);
                    $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                    $ext = strtolower(pathinfo($profile_file, PATHINFO_EXTENSION));
					$path = 'uploads/job/';
					$random = rand(1000,1000000);
					$files = $random . ' - ' . $files;
					$path = $path.$files;

                    if(!in_array($ext, $invalid_extensions)) {
                        move_uploaded_file($tmp, $path);

                        $output = array (
                            'educ_school'   =>  $educ_school,
                            'educ_degree'   =>  $educ_degree,
                            'educ_diploma'  =>  $files
                        );
                    } else {
                        $process = false;
                    }

				} else {
					$output = array (
						'educ_school' 	=> 	$educ_school,
						'educ_degree' 	=>	$educ_degree,
						'educ_diploma' 	=>	$educ_diploma_tmp
					);
				}
				array_push($arr_item, $output);
			}
			$education = json_encode($arr_item, JSON_HEX_APOS | JSON_UNESCAPED_UNICODE);
		}

        if ($process == true) {
    		$reference = '';
    		if (!empty($_POST['reference'])) {
    			$arr_item = array();
    			for ($i=0; $i < count($_POST['reference']); $i++) {
    				$ref_name = $_POST['reference'][$i]['ref_name'];
    				$ref_email = $_POST['reference'][$i]['ref_email'];
    				$ref_phone = $_POST['reference'][$i]['ref_phone'];
    				$output = array (
    					'ref_name'	=>	$ref_name,
    					'ref_email' =>	$ref_email,
    					'ref_phone' =>	$ref_phone
    				);
    				array_push($arr_item, $output);
    			}
    			$reference = json_encode($arr_item, JSON_HEX_APOS | JSON_UNESCAPED_UNICODE);
    		}

    		$skill = '';
    		if (!empty($_POST['skill'])) {
    			$arr_item = array();
    			for ($i=0; $i < count($_POST['skill']); $i++) {
    				$skill_name = addslashes($_POST['skill'][$i]['skill_name']);
    				$output = array (
    					'skill_name'	=>	$skill_name
    				);
    				array_push($arr_item, $output);
    			}
    			$skill = json_encode($arr_item, JSON_HEX_APOS | JSON_UNESCAPED_UNICODE);
    		}

    		if (!empty($_POST["availability"])) {
    			$availability = implode(", ", $_POST["availability"]);
    		} else {
    			$availability = "";
    		}

    		if (!empty($_POST["preference"])) {
    			$preference = implode(", ", $_POST["preference"]);
    		} else {
    			$preference = "";
    		}

    		$skill_set = addslashes($_POST["skill_set"]);

    		$selectJob = mysqli_query( $conn,"SELECT * FROM tbl_user_job WHERE user_id=$ID");
    		if ( mysqli_num_rows($selectJob) > 0 ) {
    			mysqli_query( $conn,"UPDATE tbl_user_job set cv='". $cv_file ."', education='". $education ."', reference='". $reference ."', skill='". $skill ."', availability='". $availability ."', preference='". $preference ."', skill_set='". $skill_set ."' WHERE user_id='". $ID ."'" );
    		} else {
    			if ($user_id == 34) { $is_active = 1; }
    			$sql = "INSERT INTO tbl_user_job (user_id, cv, education, reference, skill, availability, preference, skill_set, is_active)
    			VALUES ( '$ID', '$cv_file', '$education', '$reference', '$skill', '$availability', '$preference', '$skill_set', '$is_active')";
    			mysqli_query($conn, $sql);


    			$from = 'services@interlinkiq.com';
    			$name = 'InterlinkIQ';

    			$to = 'services@interlinkiq.com';
    			$to2 = 'enterprise@interlinkiq.com';
    			$to3 = 'virginia@consultareinc.com';
    			$user = 'InterlinkIQ';
    			$subject = 'New Specialist!';
    			$body = 'Hi Team<br><br>

    			We have a new specialist candidate. Kindly check your Listing Page.<br><br>

    			Should you need assistance, kindly call 202-982-3002 or email <a href="mailto:'.$from.'" target="_blank">'.$from.'</a><br><br>
    			
    			InterlinkIQ.com Team<br>
    			Consultare Inc. Group';
    			php_mailer_request_service($to, $to2, $to3, $user, $subject, $body);
    		}
    		
    		$output = array(
    			'ID' => $ID,
    			'first_name' => stripcslashes($first_name),
    			'last_name' => stripcslashes($last_name),

    			'website' => stripcslashes($website),
    			'linkedin' => stripcslashes($linkedin),
    			'facebook' => stripcslashes($facebook),
    			'twitter' => stripcslashes($twitter)
    		);
    		echo json_encode($output);
    		mysqli_close($conn);
    	}
    }


	if( isset($_POST['btnSave_USER_Project']) ) {
		$ID = $_POST['ID'];
		$project_id = $_POST['project_id'];
		$project = $_POST['project'];
		$due_date = $_POST['due_date'];
		$priority = isset($_POST['priority']) ? 1 : 0;

		$assigned_to_id = array();
		for($i=0; $i<count($_POST['assigned_to_id']); $i++){
			array_push($assigned_to_id, $_POST['assigned_to_id'][$i]);
		}
		$assigned_to_id = implode(", ",$assigned_to_id);

		if ($project_id) {
			mysqli_query( $conn,"UPDATE tbl_user_project set project='". $project ."', assigned_to_id='". $assigned_to_id ."', due_date='". $due_date ."', priority='". $priority ."' WHERE ID='". $project_id ."'" );
			
			echo json_encode(select_project($ID));
		} else {
			$sql = "INSERT INTO tbl_user_project (user_id, project, assigned_to_id, due_date, priority)
			VALUES ( '$ID', '$project', '$assigned_to_id', '$due_date', '$priority' )";

			if (mysqli_query($conn, $sql)) {

				echo json_encode(select_project($ID));
			}
		}
	}

	function select_project($ID) {
		global $conn;

		$last_id = mysqli_insert_id($conn);
		$selectData = mysqli_query( $conn,'SELECT * FROM tbl_user_project WHERE user_id="'. $ID .'" AND ID="'. $last_id .'" ORDER BY ID LIMIT 1' );
		if ( mysqli_num_rows($selectData) > 0 ) {
			$rowData = mysqli_fetch_array($selectData);
			$data_ID = $rowData['ID'];
			$data_project = $rowData['project'];
			$data_due_date = $rowData['due_date'];
			$data_priority = $rowData['priority'];
			$data_status = $rowData['is_completed'];

			$data_assigned_to_id = array();
			$array_assigned_to_id = explode(", ", $rowData["assigned_to_id"]);

            $resultEmployee = mysqli_query( $conn,"SELECT * FROM tbl_hr_employee" );
            if ( mysqli_num_rows($resultEmployee) > 0 ) {
                while($rowEmployee = mysqli_fetch_array($resultEmployee)) {
					if (in_array($rowEmployee["ID"], $array_assigned_to_id)) {
						array_push($data_assigned_to_id, $rowEmployee["first_name"] .' '. $rowEmployee["last_name"]);
					}
                }
            }
			$data_assigned_to_id = implode(", ",$data_assigned_to_id);

        	$sidebar_count = sidebar_count('project');
			$output = array(
				'ID' => $data_ID,
				'project' => $data_project,
				'assigned_to_id' => $data_assigned_to_id,
				'due_date' => $data_due_date,
				'priority' => $data_priority,
				'status' => intval($data_status)
			);

			$result = array_merge($sidebar_count, $output);
			return $result;
		}
	}

	if( isset($_GET['modalProject_Delete']) ) {
		$ID = $_GET['modalProject_Delete'];

        mysqli_query( $conn,"UPDATE tbl_user_project set is_removed='1' WHERE ID='". $ID ."'" );

	    $sidebar_count = sidebar_count('project');
	    echo json_encode($sidebar_count);
    }



	if( isset($_POST['btnSave_USER_Task']) ) {
		$ID = $_POST['ID'];
		$task_id = $_POST['task_id'];
		$task = $_POST['task'];
		$due_date = $_POST['due_date'];
		$priority = isset($_POST['priority']) ? 1 : 0;

		$assigned_to_id = $_POST['assigned_to_id'];

		if ($task_id) {
			mysqli_query( $conn,"UPDATE tbl_user_task set task='". $task ."', assigned_to_id='". $assigned_to_id ."', due_date='". $due_date ."', priority='". $priority ."' WHERE ID='". $task_id ."'" );
			
			$selectData = mysqli_query( $conn,'SELECT * FROM tbl_user_task WHERE ID="'. $task_id .'" ORDER BY ID LIMIT 1' );
			if ( mysqli_num_rows($selectData) > 0 ) {
				$rowData = mysqli_fetch_array($selectData);
				
				echo json_encode(select_task($rowData));
			}
		} else {
			$sql = "INSERT INTO tbl_user_task (user_id, task, assigned_to_id, due_date, priority)
			VALUES ( '$ID', '$task', '$assigned_to_id', '$due_date', '$priority' )";

			if (mysqli_query($conn, $sql)) {

				$last_id = mysqli_insert_id($conn);
				$selectData = mysqli_query( $conn,'SELECT * FROM tbl_user_task WHERE user_id="'. $ID .'" AND ID="'. $last_id .'" ORDER BY ID LIMIT 1' );
				if ( mysqli_num_rows($selectData) > 0 ) {
					$rowData = mysqli_fetch_array($selectData);
					
					echo json_encode(select_task($rowData));
				}
			}
		}
	}

	function select_task($data) {
		global $conn;

		$rowData = $data;
		$data_ID = $rowData['ID'];
		$data_task = $rowData['task'];
		$data_due_date = $rowData['due_date'];
		$data_priority = $rowData['priority'];
		$data_status = $rowData['is_completed'];

		$data_assigned_to_id = array();
		$array_assigned_to_id = explode(", ", $rowData["assigned_to_id"]);

        $resultEmployee = mysqli_query( $conn,"SELECT * FROM tbl_hr_employee" );
        if ( mysqli_num_rows($resultEmployee) > 0 ) {
            while($rowEmployee = mysqli_fetch_array($resultEmployee)) {
				if (in_array($rowEmployee["ID"], $array_assigned_to_id)) {
					array_push($data_assigned_to_id, $rowEmployee["first_name"] .' '. $rowEmployee["last_name"]);
				}
            }
        }
		$data_assigned_to_id = implode(", ",$data_assigned_to_id);

    	$sidebar_count = sidebar_count('task');
		$output = array(
			'ID' => $data_ID,
			'task' => $data_task,
			'assigned_to_id' => $data_assigned_to_id,
			'due_date' => $data_due_date,
			'priority' => $data_priority,
			'status' => intval($data_status)
		);

		$result = array_merge($sidebar_count, $output);
		return $result;
	}

	if( isset($_GET['modalTask_Delete']) ) {
		$ID = $_GET['modalTask_Delete'];

        mysqli_query( $conn,"UPDATE tbl_user_task set is_removed='1' WHERE ID='". $ID ."'" );

	    $sidebar_count = sidebar_count('task');
	    echo json_encode($sidebar_count);
    }



	if( isset($_POST['btnSave_USER_Upload']) ) {
		$ID = $_POST['ID'];	 
		$description = $_POST['description'];	 
		$files = "";

		$success = false;
		if( !empty( $_FILES['file']['name'] ) ) {
			$valid_extensions = array('jpeg', 'jpg', 'png', 'gif', 'bmp' , 'pdf' , 'doc' , 'ppt'); // valid extensions
			$path = 'uploads/'; // upload directory
			$file = $_FILES['file']['name'];
			$tmp = $_FILES['file']['tmp_name'];
			// get uploaded file's extension
			$ext = strtolower(pathinfo($file, PATHINFO_EXTENSION));
			// can upload same image using rand function
			$final_file = rand(1000,1000000).' - '.$file;
			// check's valid format
			if(in_array($ext, $valid_extensions)) {
				$files = $final_file;
				$path = $path.$final_file;
				if(move_uploaded_file($tmp,$path)) {
					$success = true;
				}
			} else {
				$success = false;
			}
		}

		if ($success == true) {
			$sql = "INSERT INTO tbl_user_upload (user_id, description, files)
			VALUES ( '$ID', '$description', '$files' )";
			
			if (mysqli_query($conn, $sql)) {
				$last_id = mysqli_insert_id($conn);
				$selectData = mysqli_query( $conn,'SELECT * FROM tbl_user_upload WHERE user_id="'. $ID .'" AND ID="'. $last_id .'" ORDER BY ID LIMIT 1' );
				if ( mysqli_num_rows($selectData) > 0 ) {
					$rowData = mysqli_fetch_array($selectData);
					$data_ID = $rowData['ID'];
					$data_description = $rowData['description'];
					$data_file = $rowData['files'];

                	$sidebar_count = sidebar_count('upload');
					$output = array(
						'ID' => $data_ID,
						'description' => $data_description,
						'files' => $data_file
					);

					$result = array_merge($sidebar_count, $output);
					echo json_encode($result);
				}
			}
		}
	}

	if( isset($_GET['modalUpload_Remove']) ) {
		$ID = $_GET['modalUpload_Remove'];

        mysqli_query( $conn,"UPDATE tbl_user_upload set is_remove='1' WHERE ID='". $ID ."'" );

	    $sidebar_count = sidebar_count('upload');
	    echo json_encode($sidebar_count);
    }



	if( isset($_GET['profile_project']) ) {
		$userID = $_GET['profile_project'];

        $selectProject = mysqli_query( $conn,"SELECT * FROM tbl_user_project WHERE is_completed = 0 AND is_removed = 0" );
        if ( mysqli_num_rows($selectProject) > 0 ) {
            while($rowProject = mysqli_fetch_array($selectProject)) {

                $array_Project = explode(", ", $rowProject["assigned_to_id"]);
                if (in_array($userID, $array_Project)) {
                    $project_userID = $rowProject["user_id"];

                    $selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $project_userID" );
                    if ( mysqli_num_rows($selectUser) > 0 ) {
                        while($rowUser = mysqli_fetch_array($selectUser)) {
                            $project_userName = $rowUser["first_name"] .' '. $rowUser["last_name"];
                        }
                    }

                    echo '<div class="mt-action" id="project_'. $rowProject["ID"] .'">
                        <div class="mt-action-body">
                            <div class="mt-action-row">
                                <div class="mt-action-info ">
                                    <div class="mt-action-details ">
                                        <span class="mt-action-author">'. $project_userName .'</span> ';

                                        if ($rowProject["priority"] == 1) {
			                                echo '<span class="project-bell"><i class="fa fa-bell-o"></i></span>';
			                            }
                                        
                                        echo '<p class="mt-action-desc">'. $rowProject["project"] .'</p>
                                    </div>
                                </div>
                                <div class="mt-action-datetime ">
                                    <span class="mt-action-date">'. $rowProject["due_date"] .'</span>
                                </div>
                                <div class="mt-action-buttons ">
                                    <div class="btn-group btn-group-circle">
                                        <button type="button" class="btn btn-outline green btn-sm btnProjectApprove" data-id="'. $rowProject["ID"] .'" onClick="btnProjectApprove('. $rowProject["ID"] .')">Appove</button>
                                        <button type="button" class="btn btn-outline red btn-sm btnProjectReject" data-id="'. $rowProject["ID"] .'" onClick="btnProjectReject('. $rowProject["ID"] .')">Reject</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>';
                }

            }
        }

		mysqli_close($conn);
	}

	if( isset($_GET['profile_project_approve']) ) {
		$task_id = $_GET['profile_project_approve'];
		$task_remarks = $_GET['profile_project_remarks'];

		mysqli_query( $conn,"UPDATE tbl_user_project set is_completed='1', remarks = '". $task_remarks ."' WHERE ID='". $task_id ."'" );

	    $sidebar_count = sidebar_count('project');
	    echo json_encode($sidebar_count);
	}

	if( isset($_GET['profile_project_reject']) ) {
		$task_id = $_GET['profile_project_reject'];

		mysqli_query( $conn,"UPDATE tbl_user_project set is_completed='2' WHERE ID='". $task_id ."'" );

	    $sidebar_count = sidebar_count('project');
	    echo json_encode($sidebar_count);
	}



	if( isset($_GET['my_task']) ) {
		$userID = $_GET['my_task'];
		$task_user_id = false;
		$task_assigned_to_id = false;
		$myTask = 0;

        // $selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID=$userID" );
        // if ( mysqli_num_rows($selectUser) > 0 ) {
        // 	$rowUser = mysqli_fetch_array($selectUser);

        // 	$user_id = $rowUser["ID"];
        // 	$user_employee_id = $rowUser["employee_id"];

	    //     $selectTask = mysqli_query( $conn,"SELECT * FROM tbl_user_task WHERE is_removed = 0" );
	    //     if ( mysqli_num_rows($selectTask) > 0 ) {
	    //         while($rowTask = mysqli_fetch_array($selectTask)) {

	    //             $array_Task_userID = explode(", ", $rowTask["assigned_to_id"]);
	    //             $array_Task_assignedID = explode(", ", $rowTask["assigned_to_id"]);

	    //             if (in_array($user_id, $array_Task_userID)) {
	    //             	$task_user_id = true;
	    //             }

	    //             if (in_array($user_employee_id, $array_Task_assignedID)) {
	    //             	$task_assigned_to_id = true;
	    //             }

	    //             if ( $task_user_id == true OR $task_assigned_to_id == true ) {
	    //             	$myTask++;
	    //             }

	    //         }
	    //     }
        // }
	    echo $myTask;

		// mysqli_close($conn);
	}

	if( isset($_GET['profile_task']) ) {
		$userID = $_GET['profile_task'];

        $selectTask = mysqli_query( $conn,"SELECT * FROM tbl_user_task WHERE is_completed = 0 AND is_removed = 0" );
        if ( mysqli_num_rows($selectTask) > 0 ) {
            while($rowTask = mysqli_fetch_array($selectTask)) {
                $task_userID = $rowTask["user_id"];
                $task_type = $rowTask["type"];
                $task_target_id = $rowTask["target_id"];
                $array_Task = explode(", ", $rowTask["assigned_to_id"]);

                if ($task_type == 2) {
                	$selectDashboardFile = mysqli_query( $conn,"SELECT * FROM tbl_library_file WHERE ID = $task_target_id" );
                	if ( mysqli_num_rows($selectDashboardFile) > 0 ) {
                		$rowDashboardFile = mysqli_fetch_array($selectDashboardFile);
                        $task_assigned_to_action = $rowDashboardFile["assigned_to_action"];
                        $task_files = $rowDashboardFile["files"];

                        if (!empty($array_Task[$task_assigned_to_action])) {
	                        if ($userID == $array_Task[$task_assigned_to_action]) {
	                        	$selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $task_userID" );
			                    if ( mysqli_num_rows($selectUser) > 0 ) {
			                        while($rowUser = mysqli_fetch_array($selectUser)) {
			                            $task_userName = $rowUser["first_name"] .' '. $rowUser["last_name"];
			                        }
			                    }

			                    echo '<div class="mt-action" id="task_'. $rowTask["ID"] .'">
			                        <div class="mt-action-body">
			                            <div class="mt-action-row">
			                                <div class="mt-action-info ">
			                                    <div class="mt-action-details ">
			                                        <span class="mt-action-author">'. $task_userName .'</span>
													<p class="mt-action-desc">'. $rowTask["task"] .'</p>
													<p class="mt-action-file"><a href="uploads/library/'. $task_files .'" target="_blank">'. $task_files .'</a></p>
			                                    </div>
			                                </div>
			                                <div class="mt-action-datetime ">
			                                    <span class="mt-action-date">'. $rowTask["due_date"] .'</span>
			                                </div>
			                                <div class="mt-action-buttons ">
			                                    <div class="btn-group btn-group-circle">
			                                    	<a href="#modalAttachedEdit" type="button" class="btn btn-outline dark btn-sm btnAttachedEdit" data-toggle="modal" onclick="btnAttachedEdit('. $rowTask["target_id"] .')">Edit</a>
			                                    	<button type="button" class="btn btn-outline red btn-sm btnTaskReject" data-id="'. $rowTask["ID"] .'" onClick="btnTaskReject('. $rowTask["ID"] .')">Reject</button>
			                                    </div>
			                                </div>
			                            </div>
			                        </div>
			                    </div>';
	                        }
                        }
                	}
                } else {
	                if (in_array($userID, $array_Task)) {

	                    $selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $task_userID" );
	                    if ( mysqli_num_rows($selectUser) > 0 ) {
	                        while($rowUser = mysqli_fetch_array($selectUser)) {
	                            $task_userName = $rowUser["first_name"] .' '. $rowUser["last_name"];
	                        }
	                    }

	                    echo '<div class="mt-action" id="task_'. $rowTask["ID"] .'">
	                        <div class="mt-action-body">
	                            <div class="mt-action-row">
	                                <div class="mt-action-info ">
	                                    <div class="mt-action-details ">
	                                        <span class="mt-action-author">'. $task_userName .'</span> ';

	                                        if ($rowTask["priority"] == 1) {
				                                echo '<span class="task-bell"><i class="fa fa-bell-o"></i></span>';
				                            }
	                                        
	                                        echo '<p class="mt-action-desc">'. $rowTask["task"] .'</p>
	                                    </div>
	                                </div>
	                                <div class="mt-action-datetime ">
	                                    <span class="mt-action-date">'. $rowTask["due_date"] .'</span>
	                                </div>
	                                <div class="mt-action-buttons ">
	                                    <div class="btn-group btn-group-circle">
	                                    	<button type="button" class="btn btn-outline green btn-sm btnTaskApprove" data-id="'. $rowTask["ID"] .'" onClick="btnTaskApprove('. $rowTask["ID"] .')">Appove</button>
	                                    	<button type="button" class="btn btn-outline red btn-sm btnTaskReject" data-id="'. $rowTask["ID"] .'" onClick="btnTaskReject('. $rowTask["ID"] .')">Reject</button>
	                                    </div>
	                                </div>
	                            </div>
	                        </div>
	                    </div>';
	                }
                }

            }
        }

		mysqli_close($conn);
	}

	if( isset($_GET['profile_task_approve']) ) {
		$task_id = $_GET['profile_task_approve'];
		$task_remarks = $_GET['profile_task_remarks'];

		mysqli_query( $conn,"UPDATE tbl_user_task set is_completed='1', remarks = '". $task_remarks ."' WHERE ID='". $task_id ."'" );

	    $sidebar_count = sidebar_count('task');
	    echo json_encode($sidebar_count);
	}

	if( isset($_GET['profile_task_reject']) ) {
		$task_id = $_GET['profile_task_reject'];

		mysqli_query( $conn,"UPDATE tbl_user_task set is_completed='2' WHERE ID='". $task_id ."'" );

	    $sidebar_count = sidebar_count('task');
	    echo json_encode($sidebar_count);
	}

	// List of Training Section
	if( isset($_GET['modalQuiz_View']) ) {
		$id = $_GET['modalQuiz_View'];

		if (!empty($_COOKIE['switchAccount'])) { $user_id = $_COOKIE['switchAccount']; }
		else { $user_id = $_COOKIE['ID']; }
        $current_userEmployerID = employerID($user_id);
		$current_userID = $_COOKIE['ID'];
		
		$selectData = mysqli_query( $conn,"SELECT * FROM tbl_hr_trainings WHERE ID = $id" );
		if ( mysqli_num_rows($selectData) > 0 ) {
            $row = mysqli_fetch_array($selectData);
			$data_id = $row['ID'];
			$data_title = $row['title'];
			$data_description = $row['description'];
			$data_quiz_id = $row['quiz_id'];

			$data_files = $row['files'];
        }

        echo '<div class="row">
            <div class="col-md-6">
                <div class="tabbable tabbable-tabdrop">
                    <ul class="nav nav-tabs">';

		                if (!empty($data_files)) {
		                	$output_file = json_decode($data_files,true);
		                	foreach ($output_file as $key => $value) {
		                        $file_lang = $value['file_lang'];
                                if ($file_lang == "0") { $file_lang = 'English'; }
                                if ($file_lang == "1") { $file_lang = 'Spanish'; }
                                if ($file_lang == "2") { $file_lang = 'Arabic'; }

		                        echo '<li><a href="#tab_'.$key.'" data-toggle="tab">'.$file_lang.'</a></li>';
		                    }
		                }

                    echo '</ul>
                    <div class="tab-content margin-top-20">';

                        if (!empty($data_files)) {
                            $output_file = json_decode($data_files,true);
                            foreach ($output_file as $key => $value) {
                                $file_doc = $value['file_doc'];
                                $type = 'iframe';

                                $filetype = 1;
                                if (!empty($value['file_type'])) { $filetype = $value['file_type']; }
                                if ($filetype == 1) {
                                    $fileExtension = fileExtension($file_doc);
                                    $src = $fileExtension['src'];
                                    $embed = $fileExtension['embed'];
                                    $type = $fileExtension['type'];
                                    $file_extension = $fileExtension['file_extension'];
                                    $file_mime = $fileExtension['file_mime'];
                                    $url = $base_url.'uploads/';

                                    $file_doc = $src.$url.rawurlencode($file_doc).$embed;
                                } else if ($filetype == 3) {
                                    $file_doc = preg_replace('#[^/]*$#', '', $file_doc).'preview';
                                }


                                echo '<div class="tab-pane" id="tab_'.$key.'">';
                                    if ($filetype == 1) {
                                        if (strtolower($file_mime) == "gif" OR strtolower($file_mime) == "jpg"  OR strtolower($file_mime) == "jpeg" OR strtolower($file_mime) == "png" OR strtolower($file_mime) == "ico") {
                                            echo '<img src="'.$file_doc.'" style="width: 100%; height: 400px; object-fit: contain; object-position: center;" />';
                                        } else if (strtolower($file_mime) == "mp4" OR strtolower($file_mime) == "mov"  OR strtolower($file_mime) == "wmv" OR strtolower($file_mime) == "flv" OR strtolower($file_mime) == "avi" OR strtolower($file_mime) == "avchd" OR strtolower($file_mime) == "webm" OR strtolower($file_mime) == "mkv") {
                                            echo '<iframe src="'.$file_doc.'" style="width: 100%; height: 400px;" sandbox=""></iframe>';
                                        } else {
                                            echo '<iframe src="'.$file_doc.'" style="width: 100%; height: 400px;"></iframe>';
                                        }
                                    } else {
                                        echo '<iframe src="'.$file_doc.'" style="width: 100%; height: 400px;"></iframe>';
                                    }
                                    echo '<a data-src="'.$file_doc.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a>';

                                echo '</div>';
                            }
                        }
                        
                    echo '</div>
                </div>
            </div>
            <div class="col-md-6">
            	<input class="form-control" type="hidden" name="ID" value="'.$data_id.'" />
            	<input class="form-control" type="hidden" name="start_time" value="'.date("Y/m/d h:i:sa").'" />
				<div class="form-group">
				    <label class="col-md-3 control-label">Training Title</label>
				    <div class="col-md-9"><p class="form-control-static">'.$data_title.'</p></div>
				</div>
				<div class="form-group">
				    <label class="col-md-3 control-label">Training Description</label>
				    <div class="col-md-9"><p class="form-control-static">'.$data_description.'</p></div>
				</div>
            	<div class="form-group">
	                <label class="col-md-3 control-label">Select Trainer</label>
	                <div class="col-md-9">
	                    <select class="form-control" name="trainer" required >
	                    	<option value="">Select</option>';

                            $selectEmployee = mysqli_query( $conn,"SELECT * FROM tbl_hr_employee WHERE status = 1 AND user_id = $current_userEmployerID ORDER BY first_name" );
                            if ( mysqli_num_rows($selectEmployee) > 0 ) {
                                while($rowEmployee = mysqli_fetch_array($selectEmployee)) {
                                    $rowEmployeeID = $rowEmployee["ID"];
                                    $rowEmployeeFName = $rowEmployee["first_name"];
                                    $rowEmployeeLName = $rowEmployee["last_name"];

                                    echo '<option value="'. $rowEmployeeID .'">'. $rowEmployeeFName .' '. $rowEmployeeLName .'</option>';
                                }
                            } else {
                                echo '<option disabled>No Available</option>';
                            }

	                    echo '</select>
	                </div>
	            </div>
            	<div class="form-group">
	                <label class="col-md-3 control-label">Select Quiz</label>
	                <div class="col-md-9">
	                    <select class="form-control" onchange="changedQuiz(this)" name="quiz_id" required >
	                    	<option value="">Select</option>';

	                    	if (!empty($data_quiz_id)) {
                            	$arr_quiz = explode(', ', $data_quiz_id);
                                foreach($arr_quiz as $value) {
                                    $selectQuizSet = mysqli_query( $conn,"SELECT * FROM tbl_hr_quiz_set WHERE status = 1 AND deleted = 0 AND ID = $value" );
                                    if ( mysqli_num_rows($selectQuizSet) > 0 ) {
                                        $rowQuizSet = mysqli_fetch_array($selectQuizSet);
                                        $quiz_ID = $rowQuizSet["ID"];
                                        $quiz_title = $rowQuizSet["title"];

                                        echo '<option value="'.$quiz_ID.'">'.$quiz_title.'</option>';
                                    }
                                }
                            } else {
                            	echo '<option value="">No Available</option>';
                            }

	                    echo '</select>
	                </div>
	            </div>
	            <div id="quizSet"></div>
	            <div class="display-none" id="signatureContainer">
	            	<span>Signature:</span>
	                <div id="signature"></div>
	                <input type="button" class="btn btn-danger btnClear" onclick="btnClear()" value="Clear" />
                </div>
            </div>
        </div>';
	}
	if( isset($_GET['modalQuiz_Set']) ) {
		$id = $_GET['modalQuiz_Set'];

		$selectData = mysqli_query( $conn,"SELECT * FROM tbl_hr_quiz_set WHERE ID = $id" );
		if ( mysqli_num_rows($selectData) > 0 ) {
            $row = mysqli_fetch_array($selectData);
            $data_quiz_id = $row['quiz_id'];

            if (!empty($data_quiz_id)) {
                echo '<ol>';
                	$arr_quiz = explode(', ', $data_quiz_id);
                    foreach($arr_quiz as $value) {
                        $selectQuizSet = mysqli_query( $conn,"SELECT * FROM tbl_hr_quiz WHERE deleted = 0 AND ID = $value" );
                        if ( mysqli_num_rows($selectQuizSet) > 0 ) {
                            $rowQuizSet = mysqli_fetch_array($selectQuizSet);
                            $quiz_ID = $rowQuizSet["ID"];
                            $quiz_question = $rowQuizSet["question"];
                            $quiz_answer = $rowQuizSet["answer"];

                            echo '<li id="'.$quiz_ID.'">
                                '.htmlentities($quiz_question ?? '').'

                            	<ol type="a">';

                            		$quiz_choices = $rowQuizSet["choices"];
                            		$arr_choices = explode(' | ', $quiz_choices);
                            		$option = 0;
                            		foreach($arr_choices as $choice) {
                            			echo '<li>
                                            <label class="mt-radio mt-radio-outline"> '.htmlentities($choice ?? '').'
		                                        <input type="radio" value="'.$option.'" name="option_'.$quiz_ID.'" required />
		                                        <span></span>
		                                    </label>
		                                </li>';
		                                $option++;
                            		}
	                            
	                            echo '</ol>
                            </li>';
                        }
                    }
                echo '</ol>';
            }
        }
	}
	if( isset($_POST['btnUpdate_quiz']) ) {
		$user_id = $_COOKIE['ID'];
		$sigData = $_POST['sigData'];
		$quiz_training_id = $_POST['ID'];
		$trainer_id = $_POST['trainer'];
		$quiz_id = $_POST['quiz_id'];
		$start_time = $_POST['start_time'];
		$end_time = date('Y/m/d h:i:sa');
		$last_modified = date('Y-m-d');
    	$countQuiz = 0;
    	$countCorrect = 0;
    	$result = 0;
	    $arr_incorrect = array();

		$selectData = mysqli_query( $conn,"SELECT * FROM tbl_hr_quiz_set WHERE ID = $quiz_id" );
		if ( mysqli_num_rows($selectData) > 0 ) {
            $row = mysqli_fetch_array($selectData);
            $data_quiz_id = $row['quiz_id'];

            if (!empty($data_quiz_id)) {
	        	$arr_quiz = explode(', ', $data_quiz_id);
	            foreach($arr_quiz as $value) {
	                $selectQuizSet = mysqli_query( $conn,"SELECT * FROM tbl_hr_quiz WHERE deleted = 0 AND ID = $value" );
	                if ( mysqli_num_rows($selectQuizSet) > 0 ) {
	                    $rowQuizSet = mysqli_fetch_array($selectQuizSet);
	                    $quiz_ID = $rowQuizSet["ID"];
	                    $quiz_answer = $rowQuizSet["answer"];
	                	$selectedOption = $_POST['option_'.$quiz_ID];
	                	$countQuiz++;

	                	if ($selectedOption == $quiz_answer) {
	                		$countCorrect++;
	                	} else {
	                		array_push($arr_incorrect, $quiz_ID);
	                	}
	                }
	            }
            }
            if ($countQuiz > 0) { $result = ($countCorrect / $countQuiz) * 100; } 
        }
        $arr_incorrect = implode(', ', $arr_incorrect);

        $sql = "INSERT INTO tbl_hr_quiz_result (user_id, trainer_id, quiz_id, result, start_time, end_time, signature, last_modified)
		VALUES ('$user_id', '$trainer_id', '$quiz_id', '$result', '$start_time', '$end_time', '$sigData', '$last_modified')";
		if (mysqli_query($conn, $sql)) {
			$last_id = mysqli_insert_id($conn);

            // $futureDate = date('Y-m-d', strtotime('+1 year'));
            // mysqli_query( $conn,"UPDATE tbl_hr_trainings SET last_modified='". $futureDate ."' WHERE ID='". $quiz_training_id ."'" );

			$selectTraining = mysqli_query( $conn,"SELECT * FROM tbl_hr_trainings WHERE ID = $quiz_training_id" );
			if ( mysqli_num_rows($selectTraining) > 0 ) {
				$rowTraining = mysqli_fetch_array($selectTraining);
            	$training_id = $rowTraining['ID'];
            	$training_title = $rowTraining['title'];

                $training_frequency = array(
                    0 => '+1 month',
                    1 => '+3 month',
                    2 => '+6 month',
                    3 => '+1 year'
                );

            	$training_last_modified = $rowTraining['last_modified'];
                $training_last_modified = new DateTime($training_last_modified);
                $training_last_modified = $training_last_modified->format('M d, Y');

                $trainingStatus = "Not Yet Started";
                $trainingResult = 0;
                $completed_date = '';
                $due_date = '';
                $certificate = '';
                $selectQuizResult = mysqli_query( $conn,"SELECT * FROM tbl_hr_quiz_result WHERE user_id = $user_id " );
                if ( mysqli_num_rows($selectQuizResult) > 0 ) {
                    while($rowQuizResult = mysqli_fetch_array($selectQuizResult)) {
                        $trainingQuizID = $rowQuizResult['quiz_id'];

                        if (!empty($rowTraining['quiz_id'])) {
                            $array_quiz_id = explode(', ', $rowTraining['quiz_id']);
                            if (in_array($trainingQuizID, $array_quiz_id)) {
                                $trainingResult = $rowQuizResult['result'];

                                if ($trainingResult == 100) {
                                	$trainingStatus = 'Completed';
                                	$certificate = '<a href="'.$base_url.'pdf?id='.$last_id.'" target="_blank" class="btn btn-circle btn-success">View</a>';

	                                $completed_date = $rowQuizResult['last_modified'];
	                                $completed_date = new DateTime($completed_date);
	                                $completed_date = $completed_date->format('M d, Y');
                                                                            
                                    $due_date = date('Y-m-d', strtotime($training_frequency[$rowTraining['frequency']], strtotime($completed_date)) );
                                    $due_date = new DateTime($due_date);
                                    $due_date = $due_date->format('M d, Y');

                                    $selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $user_id" );
                                    if ( mysqli_num_rows($selectUser) > 0 ) {
                                        $rowUser = mysqli_fetch_array($selectUser);
                                        $to = $rowUser["email"];
                                        $user = $rowUser["first_name"].' '.$rowUser["last_name"];

                                        $subject = 'Training Completed!';
                                        $body = 'Hi '.$user.',<br><br>

                                        The following training has been completed:<br>
                                        '.$training_title.'<br>
                                        '.$completed_date.'<br><br>';

                                        if ($_COOKIE['client'] == 1) {
                                            $from = 'CannOS@begreenlegal.com';
                                            $name = 'BeGreenLegal';
                                            $body .= 'Cann OS Team';
                                        } else if ($_COOKIE['client'] == 2) {
                                            $from = 'foodsafety360r@gmail.com';
                                            $name = 'FoodSafety360';
                                            $body .= '<br><br>FoodSafety360';
                                        } else if ($_COOKIE['client'] == 3) {
                                            $from = 'cannabis360r@gmail.com';
                                            $name = 'SafeCannabis360';
                                            $body .= '<br><br>SafeCannabis360';
                                        } else if ($_COOKIE['client'] == 4) {
                                            $from = 'exim360r@gmail.com';
                                            $name = 'Exim360';
                                            $body .= '<br><br>Exim360';
                                        } else {
                                            $from = 'services@interlinkiq.com';
                                            $name = 'InterlinkIQ';
                                            $body .= 'InterlinkIQ.com Team<br>
                                            Consultare Inc.';
                                        }
                                        php_mailer_1($to, $user, $subject, $body, $from, $name);
                                    }
                                } else {
                                	$trainingStatus = 'Not Yet Started';
                                	$certificate = '';
                					$completed_date = '';
                                }
                
                            }
                        }

                    }
                }


				$output = array(
					"ID" => $training_id,
					"title" => $training_title,
					"completed_date" => $completed_date,
					"last_modified" => $due_date,
					"status" => $trainingStatus,
					"quiz_id" => $quiz_id,
					"certificate" => $certificate,
					"record" => $result,
					"arr_incorrect" => $arr_incorrect
				);
			}
		}
		echo json_encode($output);
	}



    function sidebar_count($type) {
    	global $conn;
    	// global $current_userID;
    	$current_userID = $_COOKIE['ID'];

    	$profileProject = 0;
    	$profileTask = 0;
    	$profileUpload = 0;

    	if ($type === "project") {
    		$selectProject = mysqli_query( $conn,"SELECT * FROM tbl_user_project WHERE is_removed = 0 AND user_id = $current_userID " );
            if ( mysqli_num_rows($selectProject) > 0 ) {
                while($rowProject = mysqli_fetch_array($selectProject)) {
                    $profileProject++;
                }
            }
    	} else if ($type === "task") {
            $selectTask = mysqli_query( $conn,'SELECT * FROM tbl_user_task WHERE is_removed = 0 AND user_id ="'. $current_userID .'"' );
            if ( mysqli_num_rows($selectTask) > 0 ) {
                while($rowTask = mysqli_fetch_array($selectTask)) {
                    $profileTask++;
                }
            }
    	} else if ($type === "upload") {
            $selectUpload = mysqli_query( $conn,"SELECT * FROM tbl_user_upload WHERE is_remove = 0 AND user_id = $current_userID " );
            if ( mysqli_num_rows($selectUpload) > 0 ) {
                while($rowUpload = mysqli_fetch_array($selectUpload)) {
                    $profileUpload++;
                }
            }
    	}
		mysqli_close($conn);

    	$output = array(
			'profileProject' => $profileProject,
			'profileTask' => $profileTask,
			'profileUpload' => $profileUpload
		);
		return $output;
    }


    // APP CATALOG
    // Pro Services
	if( isset($_POST['btnSave_ProServices']) ) {

		if (!empty($_COOKIE['switchAccount'])) {
			$portal_user = $_COOKIE['ID'];
			$user_id = $_COOKIE['switchAccount'];
		}
		else {
			$portal_user = $_COOKIE['ID'];
			$user_id = employerID($portal_user);
		}

		$name = addslashes($_POST['name']);
        $process = true;

		$files = $_FILES['file']['name'];
		if (!empty($files)) {
			$path = 'uploads/pro_services/';
			$tmp = $_FILES['file']['tmp_name'];
            $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
            $ext = strtolower(pathinfo($files, PATHINFO_EXTENSION));
			$files = rand(1000,1000000) . ' - ' . $files;
			$path = $path.$files;

            if(!in_array($ext, $invalid_extensions)) {
                move_uploaded_file($tmp,$path);
            } else {
                $process = false;
            }
		}

        if ($process == true) {
            $sql = "INSERT INTO tbl_app_pro_service (user_id, portal_user, name, file)
    		VALUES ('$user_id', '$portal_user', '$name', '$files')";
    		if (mysqli_query($conn, $sql)) {
    			$last_id = mysqli_insert_id($conn);

    			$selectData = mysqli_query( $conn,"SELECT * FROM tbl_app_pro_service WHERE ID = $last_id" );
    			if ( mysqli_num_rows($selectData) > 0 ) {
    				$rowData = mysqli_fetch_array($selectData);
                	$data_ID = $rowData['ID'];
                	$data_name = stripcslashes($rowData['name']);

                	$data_file = $rowData['file'];
                    $fileExtension = fileExtension($data_file);
    				$src = $fileExtension['src'];
    				$embed = $fileExtension['embed'];
    				$type = $fileExtension['type'];
    				$file_extension = $fileExtension['file_extension'];
    	            $url = $base_url.'uploads/pro_services/';

                    $data = '<tr id="tr_'.$data_ID.'">
    	                <td>'.$data_name.'</td>
    	                <td class="text-center">';
    	                    if ($user_id == 1 || $user_id == 19 || $user_id == 163) {
    	                        $data .= '<div class="btn-group btn-group-circle">
    	                            <a href="'.$src.$url.rawurlencode($data_file).$embed.'" data-src="'.$src.$url.rawurlencode($data_file).$embed.'" data-fancybox data-type="'.$type.'" class="btn btn-outline dark btn-sm">View</a>
    	    	                    <a href="javascript:;" class="btn btn-danger btn-sm" onclick="btnDelete('.$data_ID.')">Delete</a>
                                </div>';
    	                    } else {
    	                        $data .= '<a href="'.$src.$url.rawurlencode($data_file).$embed.'" data-src="'.$src.$url.rawurlencode($data_file).$embed.'" data-fancybox data-type="'.$type.'" class="btn btn-outline dark btn-sm">View</a>';
    	                    }
    	                $data .= '</td>
    	            </tr>';

    				$output = array(
    					"data" => $data
    				);
    			}
    		}
    		echo json_encode($output);
    	}
    }
	if( isset($_GET['btnDelete_ProService']) ) {
		$id = $_GET['btnDelete_ProService'];
    	$current_userID = $_COOKIE['ID'];

		mysqli_query($conn,"UPDATE tbl_app_pro_service set deleted = 1, remark = $current_userID WHERE ID = $id");
	}

    // Comply
	if( isset($_GET['modalView_Comply']) ) {
		$id = $_GET['modalView_Comply'];

		$selectData = mysqli_query( $conn,"SELECT * FROM tblDashboardForm WHERE Dash_id = $id" );
		if ( mysqli_num_rows($selectData) > 0 ) {
            $row = mysqli_fetch_array($selectData);
			$data_id = $row['Dash_id'];
			$data_name = stripcslashes($row['QualitySystems']);
			$data_description = stripcslashes($row['Descriptions']);
        }

        echo '<input class="form-control" type="hidden" name="ID" value="'. $id .'" />
		<div class="form-group">
			<label class="col-md-3 control-label">Quality Systems</label>
			<div class="col-md-8">
				<input type="text" class="form-control" name="comply_name" placeholder="Module Name" value="'.$data_name.'" />
			</div>
		</div>
		<div class="form-group">
			<label class="col-md-3 control-label">Description</label>
			<div class="col-md-8">
				<textarea class="form-control" name="comply_description" placeholder="Description">'.$data_description.'</textarea>
			</div>
		</div>';
	}
	if( isset($_GET['btnDelete_Comply']) ) {
		$id = $_GET['btnDelete_Comply'];

		mysqli_query($conn,"UPDATE tblDashboardForm set deleted = 1 WHERE Dash_id = $id");
	}
	if( isset($_POST['btnSave_Comply']) ) {

		if (!empty($_COOKIE['switchAccount'])) {
			$portal_user = $_COOKIE['ID'];
			$user_id = $_COOKIE['switchAccount'];
		}
		else {
			$portal_user = $_COOKIE['ID'];
			$user_id = employerID($portal_user);
		}

		$name = addslashes($_POST['comply_name']);
		$description = addslashes($_POST['comply_description']);

        $sql = "INSERT INTO tblDashboardForm (QualitySystems, Descriptions)
		VALUES ('$name', '$description')";
		if (mysqli_query($conn, $sql)) {
			$last_id = mysqli_insert_id($conn);

			$selectData = mysqli_query( $conn,"SELECT * FROM tblDashboardForm WHERE Dash_id = $last_id" );
			if ( mysqli_num_rows($selectData) > 0 ) {
				$rowData = mysqli_fetch_array($selectData);
            	$data_ID = $rowData['Dash_id'];
            	$data_name = stripcslashes($rowData['QualitySystems']);
            	$data_description = stripcslashes($rowData['Descriptions']);

                $data = '<tr id="tr_'.$data_ID.'">
	                <td>'.$data_name.'</td>
	                <td>'.$data_description.'</td>';

	                if ($user_id == 1 || $user_id == 19 || $user_id == 163) {
                        $data .= '<td class="text-center">
	                        <div class="btn-group btn-group-circle">
	                            <a href="#modalViewComply" class="btn btn-outline dark btn-sm" data-toggle="modal" onclick="btnViewComply('.$data_ID.')">View</a>
	                            <a href="javascript:;" class="btn btn-danger btn-sm" onclick="btnDeleteComply('.$data_ID.')">Delete</a>
                            </div>
                        </td>';
                    }

	             $data .= '</tr>';

				$output = array(
					"data" => $data
				);
			}
		}
		echo json_encode($output);
	}
	if( isset($_POST['btnUpdate_Comply']) ) {

		if (!empty($_COOKIE['switchAccount'])) {
			$portal_user = $_COOKIE['ID'];
			$user_id = $_COOKIE['switchAccount'];
		}
		else {
			$portal_user = $_COOKIE['ID'];
			$user_id = employerID($portal_user);
		}

		$ID = $_POST['ID'];
		$name = addslashes($_POST['comply_name']);
		$description = addslashes($_POST['comply_description']);

		mysqli_query( $conn,"UPDATE tblDashboardForm set QualitySystems='". $name ."', Descriptions='". $description ."' WHERE Dash_id='". $ID ."'" );

        $data = '<td>'.$name.'</td>
        <td>'.$description.'</td>';

        if ($user_id == 1 || $user_id == 19 || $user_id == 163) {
            $data .= '<td class="text-center">
                <div class="btn-group btn-group-circle">
                    <a href="#modalViewComply" class="btn btn-outline dark btn-sm" data-toggle="modal" onclick="btnViewComply('.$ID.')">View</a>
                    <a href="javascript:;" class="btn btn-danger btn-sm" onclick="btnDeleteComply('.$ID.')">Delete</a>
                </div>
            </td>';
        }

		$output = array(
			"ID" => $ID,
			"data" => $data
		);
		echo json_encode($output);
	}

    // Module
	if( isset($_GET['modalView_Module']) ) {
		$id = $_GET['modalView_Module'];

		if (!empty($_COOKIE['switchAccount'])) {
			$portal_user = $_COOKIE['ID'];
			$user_id = $_COOKIE['switchAccount'];
		}
		else {
			$portal_user = $_COOKIE['ID'];
			$user_id = employerID($portal_user);
		}

		$selectData = mysqli_query( $conn,"SELECT * FROM tblPlugins WHERE plugin_id = $id" );
		if ( mysqli_num_rows($selectData) > 0 ) {
            $row = mysqli_fetch_array($selectData);
			$data_id = $row['plugin_id'];
			$data_name = stripcslashes($row['plugin_name']);
			$data_description = stripcslashes($row['plugin_description']);
			$data_available = $row['available'];
			$data_menu_id = $row['menu_id'];

			$data_type = 0;
			$data_collab = 0;
			$data_icon = '';
			$data_path = '';
			$data_label = '';
        }

        echo '<input class="form-control" type="hidden" name="ID" value="'. $id .'" />
        <div class="tabbable tabbable-tabdrop">
            <ul class="nav nav-tabs">
                <li class="active">
                    <a href="#tabBasic" data-toggle="tab">Basic</a>
                </li>
                <li>
                    <a href="#tabMenu" data-toggle="tab">Menu Setting</a>
                </li>
            </ul>
            <div class="tab-content margin-top-20">
                <div class="tab-pane active" id="tabBasic">
					<div class="form-group">
						<label class="col-md-3 control-label">Module Name</label>
						<div class="col-md-8">
							<input type="text" class="form-control" name="module_name" value="'.$data_name.'" />
						</div>
					</div>
					<div class="form-group">
						<label class="col-md-3 control-label">Description</label>
						<div class="col-md-8">
							<textarea class="form-control" name="module_description">'.$data_description.'</textarea>
						</div>
					</div>
					<div class="form-group">
						<label class="col-md-3 control-label">Available</label>
						<div class="col-md-8">
							<select class="form-control" name="module_available">
								<option value="0" '; echo $data_available == 0 ? 'SELECTED':''; echo '>Not Yet</option>
								<option value="1" '; echo $data_available == 1 ? 'SELECTED':''; echo '>Yes</option>
							</select>
						</div>
					</div>
                </div>
                <div class="tab-pane" id="tabMenu">';

                	if ($data_menu_id > 0) {
                		$selectMenu = mysqli_query( $conn,"SELECT * FROM tbl_menu WHERE ID = $data_menu_id" );
						if ( mysqli_num_rows($selectMenu) > 0 ) {
							$rowMenu = mysqli_fetch_array($selectMenu);

							$data_type = $rowMenu['type'];
							$data_collab = $rowMenu['collab'];
							$data_icon = $rowMenu['icon'];
							$data_path = $rowMenu['url'];
							$data_label = $rowMenu['description'];
						}
                	}

					echo '<div class="form-group hide">
						<label class="col-md-3 control-label">Module Type</label>
						<div class="col-md-8">
							<select class="form-control" name="module_type">
								<option value="0" '; echo $data_type == 0 ? 'SELECTED':''; echo '>Default</option>
								<option value="1" '; echo $data_type == 1 ? 'SELECTED':''; echo '>Dropdown</option>
							</select>
						</div>
					</div>
					<div class="form-group">
						<label class="col-md-3 control-label">Allow Collaborator</label>
						<div class="col-md-8">
							<select class="form-control" name="module_collab">
								<option value="0" '; echo $data_collab == 0 ? 'SELECTED':''; echo '>No</option>
								<option value="1" '; echo $data_collab == 1 ? 'SELECTED':''; echo '>Yes</option>
							</select>
						</div>
					</div>
					<div class="form-group">
						<label class="col-md-3 control-label">Select Icon</label>
						<div class="col-md-8">
							<select class="selectpicker form-control" data-show-subtext="true" data-live-search="true" data-icon-base="" name="module_icon">';

								$selectIcon = mysqli_query( $conn,"SELECT * FROM tbl_icon WHERE deleted = 0" );
								if ( mysqli_num_rows($selectIcon) > 0 ) {
									while($rowIcon = mysqli_fetch_array($selectIcon)) {
										$icon_name = $rowIcon['name'];

										echo '<option data-icon="'.$icon_name.'" value="'.$icon_name.'" '; echo $icon_name == $data_icon ? 'SELECTED':''; echo '>'.$icon_name.'</option>';
									}
								}
                            echo '</select>
						</div>
					</div>
					<div class="form-group">
						<label class="col-md-3 control-label">Module Path</label>
						<div class="col-md-8">
							<input type="text" class="form-control" name="module_path" value="'.$data_path.'" />
							<i class="text-danger">File extension is optional</i>
						</div>
					</div>
					<div class="form-group">
						<label class="col-md-3 control-label">Module Label</label>
						<div class="col-md-8">
							<input type="text" class="form-control" name="module_label" value="'.$data_label.'" />
						</div>
					</div>
                </div>
            </div>
        </div>';
	}
	if( isset($_GET['btnDelete_Module']) ) {
		$id = $_GET['btnDelete_Module'];

		mysqli_query($conn,"UPDATE tblPlugins set deleted = 1 WHERE plugin_id = $id");
	}
	if( isset($_POST['btnSave_Module']) ) {

		if (!empty($_COOKIE['switchAccount'])) {
			$portal_user = $_COOKIE['ID'];
			$user_id = $_COOKIE['switchAccount'];
		}
		else {
			$portal_user = $_COOKIE['ID'];
			$user_id = employerID($portal_user);
		}

		$name = addslashes($_POST['module_name']);
		$description = addslashes($_POST['module_description']);

        $sql = "INSERT INTO tblPlugins (plugin_name, plugin_description)
		VALUES ('$name', '$description')";
		if (mysqli_query($conn, $sql)) {
			$last_id = mysqli_insert_id($conn);

			$selectData = mysqli_query( $conn,"SELECT * FROM tblPlugins WHERE plugin_id = $last_id" );
			if ( mysqli_num_rows($selectData) > 0 ) {
				$rowData = mysqli_fetch_array($selectData);
            	$data_ID = $rowData['plugin_id'];
            	$data_name = stripcslashes($rowData['plugin_name']);
            	$data_description = stripcslashes($rowData['plugin_description']);

                $data = '<tr id="tr_'.$data_ID.'">
	                <td>'.$data_name.'</td>
	                <td>'.$data_description.'</td>';

	                if ($user_id == 1 || $user_id == 19 || $user_id == 163) {
                        $data .= '<td class="text-center">
	                        <div class="btn-group btn-group-circle">
	                            <a href="#modalViewModule" class="btn btn-outline dark btn-sm" data-toggle="modal" onclick="btnViewModule('.$data_ID.')">View</a>
	                            <a href="javascript:;" class="btn btn-danger btn-sm" onclick="btnDeleteModule('.$data_ID.')">Delete</a>
                            </div>
                        </td>';
                    }

	             $data .= '</tr>';

				$output = array(
					"data" => $data
				);
			}
		}
		echo json_encode($output);
	}
	if( isset($_POST['btnUpdate_Module']) ) {

		if (!empty($_COOKIE['switchAccount'])) {
			$portal_user = $_COOKIE['ID'];
			$user_id = $_COOKIE['switchAccount'];
		}
		else {
			$portal_user = $_COOKIE['ID'];
			$user_id = employerID($portal_user);
		}

		$ID = $_POST['ID'];
		$name = addslashes($_POST['module_name']);
		$description = addslashes($_POST['module_description']);
		$available = $_POST['module_available'];
		mysqli_query( $conn,"UPDATE tblPlugins set plugin_name='". $name ."', plugin_description='". $description ."', available='". $available ."' WHERE plugin_id='". $ID ."'" );

		if ($available == 1) {
			$module_type = $_POST['module_type'];
			$module_collab = $_POST['module_collab'];
			$module_icon = $_POST['module_icon'];
			$module_path = $_POST['module_path'];
			$module_label = $_POST['module_label'];

			if ($module_type == 0) {
				$selectMenu = mysqli_query( $conn,"SELECT * FROM tbl_menu WHERE url = '".$module_path."'" );
				if ( mysqli_num_rows($selectMenu) > 0 ) {
		            $rowMenu = mysqli_fetch_array($selectMenu);
					$data_id = $rowMenu['ID'];

					// Update Data
					mysqli_query( $conn,"UPDATE tbl_menu set name='". $module_path ."', type='". $module_type ."', collab='". $module_collab ."', icon='". $module_icon ."', url='". $module_path ."', description='". $module_label ."' WHERE ID='". $data_id ."'" );
                    mysqli_query( $conn,"UPDATE tblPlugins set menu_id=$data_id WHERE plugin_id=$ID" );
		        } else {

		        	// Insert New
			        $sql = "INSERT INTO tbl_menu (name, module, type, collab, icon, url, description)
					VALUES ('$module_path', '1', '$module_type', '$module_collab', '$module_icon', '$module_path', '$module_label')";
					if (mysqli_query($conn, $sql)) {
						$last_id = mysqli_insert_id($conn);

						mysqli_query( $conn,"UPDATE tblPlugins set menu_id='". $last_id ."' WHERE plugin_id='". $ID ."'" );
					}
		        }
			}
		}

        $data = '<td>';
        	if ($available == 1) {
        		if (!empty($module_path)) {
        			$data .= '<a href="'.$module_path.'" class="blue-steel bold" target="_blank">'.$name.'</a>';
        		} else {
        			$data .= $name;
        		}
        	} else {
    			$data .= $name;
    		}
        $data .= '<td>'.$description.'</td>';

        if ($user_id == 1 || $user_id == 19 || $user_id == 163) {
            $data .= '<td class="text-center">
                <div class="btn-group btn-group-circle">
                    <a href="#modalViewModule" class="btn btn-outline dark btn-sm" data-toggle="modal" onclick="btnViewModule('.$ID.')">View</a>
                    <a href="javascript:;" class="btn btn-danger btn-sm" onclick="btnDeleteModule('.$ID.')">Delete</a>
                </div>
            </td>';
        }

		$output = array(
			"ID" => $ID,
			"data" => $data
		);
		echo json_encode($output);
	}

    // SOP
	if( isset($_GET['modalView_SOP']) ) {
		$id = $_GET['modalView_SOP'];

		$selectData = mysqli_query( $conn,"SELECT * FROM tbl_SOPs WHERE sops_id = $id" );
		if ( mysqli_num_rows($selectData) > 0 ) {
            $row = mysqli_fetch_array($selectData);
			$data_id = $row['sops_id'];
			$data_name = stripcslashes($row['Category']);
			$data_description = stripcslashes($row['Topic_Area']);
        }

        echo '<input class="form-control" type="hidden" name="ID" value="'. $id .'" />
		<div class="form-group">
			<label class="col-md-3 control-label">Category Name</label>
			<div class="col-md-8">
				<input type="text" class="form-control" name="category_name" placeholder="Category Name" value="'.$data_name.'" />
			</div>
		</div>
		<div class="form-group">
			<label class="col-md-3 control-label">Topic / Area</label>
			<div class="col-md-8">
				<textarea class="form-control" name="category_description" placeholder="Topic / Area">'.$data_description.'</textarea>
			</div>
		</div>';
	}
	if( isset($_GET['btnDelete_SOP']) ) {
		$id = $_GET['btnDelete_SOP'];

		mysqli_query($conn,"UPDATE tbl_SOPs set deleted = 1 WHERE sops_id = $id");
	}
	if( isset($_POST['btnSave_SOP']) ) {

		if (!empty($_COOKIE['switchAccount'])) {
			$portal_user = $_COOKIE['ID'];
			$user_id = $_COOKIE['switchAccount'];
		}
		else {
			$portal_user = $_COOKIE['ID'];
			$user_id = employerID($portal_user);
		}

		$name = addslashes($_POST['category_name']);
		$description = addslashes($_POST['category_description']);

        $sql = "INSERT INTO tbl_SOPs (Category, Topic_Area)
		VALUES ('$name', '$description')";
		if (mysqli_query($conn, $sql)) {
			$last_id = mysqli_insert_id($conn);

			$selectData = mysqli_query( $conn,"SELECT * FROM tbl_SOPs WHERE sops_id = $last_id" );
			if ( mysqli_num_rows($selectData) > 0 ) {
				$rowData = mysqli_fetch_array($selectData);
            	$data_ID = $rowData['sops_id'];
            	$data_name = stripcslashes($rowData['Category']);
            	$data_description = stripcslashes($rowData['Topic_Area']);

                $data = '<tr id="tr_'.$data_ID.'">
	                <td>'.$data_name.'</td>
	                <td>'.$data_description.'</td>';

	                if ($user_id == 1 || $user_id == 19 || $user_id == 163) {
                        $data .= '<td class="text-center">
	                        <div class="btn-group btn-group-circle">
	                            <a href="#modalViewSOP" class="btn btn-outline dark btn-sm" data-toggle="modal" onclick="btnViewSOP('.$data_ID.')">View</a>
	                            <a href="javascript:;" class="btn btn-danger btn-sm" onclick="btnDeleteSOP('.$data_ID.')">Delete</a>
                            </div>
                        </td>';
                    }

	             $data .= '</tr>';

				$output = array(
					"data" => $data
				);
			}
		}
		echo json_encode($output);
	}
	if( isset($_POST['btnUpdate_SOP']) ) {

		if (!empty($_COOKIE['switchAccount'])) {
			$portal_user = $_COOKIE['ID'];
			$user_id = $_COOKIE['switchAccount'];
		}
		else {
			$portal_user = $_COOKIE['ID'];
			$user_id = employerID($portal_user);
		}

		$ID = $_POST['ID'];
		$name = addslashes($_POST['category_name']);
		$description = addslashes($_POST['category_description']);

		mysqli_query( $conn,"UPDATE tbl_SOPs set Category='". $name ."', Topic_Area='". $description ."' WHERE sops_id='". $ID ."'" );

        $data = '<td>'.$name.'</td>
        <td>'.$description.'</td>';

        if ($user_id == 1 || $user_id == 19 || $user_id == 163) {
            $data .= '<td class="text-center">
                <div class="btn-group btn-group-circle">
                    <a href="#modalViewSOP" class="btn btn-outline dark btn-sm" data-toggle="modal" onclick="btnViewSOP('.$ID.')">View</a>
                    <a href="javascript:;" class="btn btn-danger btn-sm" onclick="btnDeleteSOP('.$ID.')">Delete</a>
                </div>
            </td>';
        }

		$output = array(
			"ID" => $ID,
			"data" => $data
		);
		echo json_encode($output);
	}



    // TRACKING PAGE
	if( isset($_GET['modalTracking']) ) {
		$frequency = $_GET['modalTracking'];

        if ($frequency == 1) {
        	echo '<div class=row>
                <div class="col-md-5 col-md-offset-1">
                    <div class="form-group">
                        <div class="input-group">
                            <input type="text" class="form-control daterange" name="daterange" />
                            <span class="input-group-btn">
                                <button class="btn default date-range-toggle" type="button">
                                    <i class="fa fa-calendar"></i>
                                </button>
                            </span>
                        </div>
                    </div>
                </div>
                <div class="col-md-5">
                    <input type=button id=generate_report_btn class="btn btn-primary btn-sm" onclick="btnGenerate(this)" value="Generate Report">
                </div>
            </div>
            <div class=row>
                <div class="col-md-12">
                    <div class="table-responsive"><table id="main" class="mt-1 table table-borderedx table-sm table-condensed" style="width: calc(100% - 100px);"></table></div>
                </div>
            </div>
            <div class=row>
                <div class="col-md-12">
                    <table id=legend class="table table-borderless">
                     <thead>
                        <tr>
                           <th colspan=2 class=text-left>Legend:</th>
                        </tr>
                     </thead>
                     <tbody>
                        <tr>
                           <td style="width:35px;height:35px;background-color:#16a085";></td>
                           <td class=ps-3>Performed - All is well</td>
                        </tr>
                        <tr>
                           <td style="width:35px;height:35px;background-color:#e59866";></td>
                           <td class=ps-3>Encountered Issue</td>
                        </tr>
                     </tbody>
                  </table>
                </div>
            </div>';
        }
	}
	if( isset($_POST['btnSave_Tracking']) ) {
		$name = addslashes($_POST['name']);
        $process = true;

		$files = $_FILES['file']['name'];
		if (!empty($files)) {
			$path = 'uploads/tracking/';
			$tmp = $_FILES['file']['tmp_name'];
            $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
            $ext = strtolower(pathinfo($files, PATHINFO_EXTENSION));
			$files = rand(1000,1000000) . ' - ' . $files;
			$path = $path.$files;

            if(!in_array($ext, $invalid_extensions)) {
                move_uploaded_file($tmp,$path);
            } else {
                $process = false;
            }
		}

        if ($process == true) {
            $sql = "INSERT INTO tbl_tracking (name, file)
    		VALUES ('$name', '$files')";
    		if (mysqli_query($conn, $sql)) {
    			$last_id = mysqli_insert_id($conn);

    			$selectData = mysqli_query( $conn,"SELECT * FROM tbl_tracking WHERE ID = $last_id" );
    			if ( mysqli_num_rows($selectData) > 0 ) {
    				$rowData = mysqli_fetch_array($selectData);
                	$data_ID = $rowData['ID'];
                	$data_name = stripcslashes($rowData['name']);

                	$data_file = $rowData['file'];
                    $fileExtension = fileExtension($data_file);
    				$src = $fileExtension['src'];
    				$embed = $fileExtension['embed'];
    				$type = $fileExtension['type'];
    				$file_extension = $fileExtension['file_extension'];
    	            $url = $base_url.'uploads/tracking/';
    	            
    	            $data = '<div class="col-md-2 margin-bottom-15" id="div_'.$data_ID.'">
                        <a href="javascript:;" class="btn btn-danger" onclick="btnDelete('.$data_ID.')" style="position: absolute; z-index: 2;"><i class="fa fa-trash"></i></a>
                        <a data-src="'.$src.$url.rawurlencode($data_file).$embed.'" data-fancybox data-type="'.$type.'" class="modalView">
                            <img src="uploads/bgBlue.png" class="img-thumbnail" />
                            <div class="cover">
                                <h3 class="font-white">'.$data_name.'</h3>
                            </div>
                        </a>
                    </div>';

    				$output = array(
    					"data" => $data
    				);
    			}
    		}
    		echo json_encode($output);
        }
	}
	if( isset($_GET['btnDelete_Tracking']) ) {
		$id = $_GET['btnDelete_Tracking'];

		mysqli_query($conn,"UPDATE tbl_tracking set deleted = 1 WHERE ID = $id");
	}


    // PRICING PAGE
    if( isset($_GET['modalPricing']) ) {
        $frequency = $_GET['modalPricing'];

        if ($frequency == 1) {
            echo '<div class=row>
                <div class="col-md-5 col-md-offset-1">
                    <div class="form-group">
                        <div class="input-group">
                            <input type="text" class="form-control daterange" name="daterange" />
                            <span class="input-group-btn">
                                <button class="btn default date-range-toggle" type="button">
                                    <i class="fa fa-calendar"></i>
                                </button>
                            </span>
                        </div>
                    </div>
                </div>
                <div class="col-md-5">
                    <input type=button id=generate_report_btn class="btn btn-primary btn-sm" onclick="btnGenerate(this)" value="Generate Report">
                </div>
            </div>
            <div class=row>
                <div class="col-md-12">
                    <div class="table-responsive"><table id="main" class="mt-1 table table-borderedx table-sm table-condensed" style="width: calc(100% - 100px);"></table></div>
                </div>
            </div>
            <div class=row>
                <div class="col-md-12">
                    <table id=legend class="table table-borderless">
                     <thead>
                        <tr>
                           <th colspan=2 class=text-left>Legend:</th>
                        </tr>
                     </thead>
                     <tbody>
                        <tr>
                           <td style="width:35px;height:35px;background-color:#16a085";></td>
                           <td class=ps-3>Performed - All is well</td>
                        </tr>
                        <tr>
                           <td style="width:35px;height:35px;background-color:#e59866";></td>
                           <td class=ps-3>Encountered Issue</td>
                        </tr>
                     </tbody>
                  </table>
                </div>
            </div>';
        }
    }
    if( isset($_POST['btnSave_Pricing']) ) {
        $name = addslashes($_POST['name']);
        $process = true;

        $files = $_FILES['file']['name'];
        if (!empty($files)) {
            $path = 'uploads/pricing/';
            $tmp = $_FILES['file']['tmp_name'];
            $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
            $ext = strtolower(pathinfo($files, PATHINFO_EXTENSION));
            $files = rand(1000,1000000) . ' - ' . $files;
            $path = $path.$files;

            if(!in_array($ext, $invalid_extensions)) {
                move_uploaded_file($tmp,$path);
            } else {
                $process = false;
            }
        }

        if ($process == true) {
            $sql = "INSERT INTO tbl_pricing (name, file)
            VALUES ('$name', '$files')";
            if (mysqli_query($conn, $sql)) {
                $last_id = mysqli_insert_id($conn);

                $selectData = mysqli_query( $conn,"SELECT * FROM tbl_pricing WHERE ID = $last_id" );
                if ( mysqli_num_rows($selectData) > 0 ) {
                    $rowData = mysqli_fetch_array($selectData);
                    $data_ID = $rowData['ID'];
                    $data_name = stripcslashes($rowData['name']);

                    $data_file = $rowData['file'];
                    $fileExtension = fileExtension($data_file);
                    $src = $fileExtension['src'];
                    $embed = $fileExtension['embed'];
                    $type = $fileExtension['type'];
                    $file_extension = $fileExtension['file_extension'];
                    $url = $base_url.'uploads/pricing/';
                    
                    $data = '<div class="col-md-2 margin-bottom-15" id="div_'.$data_ID.'">
                        <a href="javascript:;" class="btn btn-danger" onclick="btnDelete('.$data_ID.')" style="position: absolute; z-index: 2;"><i class="fa fa-trash"></i></a>
                        <a data-src="'.$src.$url.rawurlencode($data_file).$embed.'" data-fancybox data-type="'.$type.'" class="modalView">
                            <img src="uploads/bgBlue.png" class="img-thumbnail" />
                            <div class="cover">
                                <h3 class="font-white">'.$data_name.'</h3>
                            </div>
                        </a>
                    </div>';

                    $output = array(
                        "data" => $data
                    );
                }
            }
            echo json_encode($output);
        }
    }
    if( isset($_GET['btnDelete_Pricing']) ) {
        $id = $_GET['btnDelete_Pricing'];

        mysqli_query($conn,"UPDATE tbl_pricing set deleted = 1 WHERE ID = $id");
    }


    // DASHBOARD PAGE
    function itemChild($parent_id, $child_id) {
        global $conn;
		$current_userID = $_COOKIE['ID'];

        $current_client = 0;
        if (isset($_COOKIE['client'])) { $current_client = $_COOKIE['client']; }
		
		// if (!empty($_COOKIE['switchAccount'])) { $user_id = $_COOKIE['switchAccount']; }
		// else { $user_id = $_COOKIE['ID']; }
        // $current_userEmployerID = employerID($user_id);

        if (!empty($_COOKIE['switchAccount'])) {
            $portal_user = $_COOKIE['ID'];
            $user_id = $_COOKIE['switchAccount'];
        }
        else {
            $portal_user = $_COOKIE['ID'];
            $user_id = employerID($portal_user);
        }

        $hasLibrary = mysqli_query( $conn,"SELECT * FROM tbl_library WHERE user_id = $user_id" );
        if ( mysqli_num_rows($hasLibrary) == 0 ) {
            $user_id = 163;
        }

        $current_userEmployerID = $user_id;


        // $resultItem = mysqli_query( $conn,"SELECT * FROM tbl_library WHERE deleted = 0 AND parent_id = $parent_id" );
        $resultItem = mysqli_query( $conn,"SELECT
            l.ID AS l_ID,
            l.portal_user AS l_portal_user,
            l.parent_id AS l_parent_id,
            l.child_id AS l_child_id,
            l.type AS l_type,
            l.free_access AS l_free_access,
            l.reason AS l_reason,
            l.name AS l_name,
            l.description AS l_description,
            COUNT(r.r_ID) AS review_total,
            COALESCE(SUM(r.r_compliant), 0) AS review_sum

            FROM tbl_library AS l

            LEFT JOIN (
                SELECT
                ID AS r_ID,
                library_id AS r_library_id,
                compliant AS r_compliant
                FROM tbl_library_review
                WHERE parent_id = 0
                AND is_deleted = 0
            ) AS r
            ON l.ID = r.r_library_id

            WHERE l.deleted = 0
            AND l.parent_id = $parent_id

            GROUP BY l.ID
            
            ORDER BY FIELD(l.type,1,2,3,5,4) ASC, l.ID ASC" );
        $output = "";
        if ( mysqli_num_rows($resultItem) > 0 ) {
            while($rowItem = mysqli_fetch_array($resultItem)) {
                $item_ID = $rowItem["l_ID"];
                $type = $rowItem["l_type"];
                $new_parent_id = $rowItem["l_parent_id"];
                $new_child_id = $rowItem["l_child_id"];
                $reason = $rowItem["l_reason"];

                $review = 0;
                $review_sum = $rowItem["review_sum"];
                $review_total = $rowItem["review_total"];
                if ($review_total > 0 AND $review_sum > 0) {
                    $review = round(($review_sum / $review_total) * 100);
                }

                $array_child_id = explode(", ", $child_id);
                if (in_array($item_ID, $array_child_id)) {

                    $displayLibrary = false;
                    if (mysqli_num_rows($hasLibrary) == 0) {
                        if ($rowItem["l_portal_user"] == $portal_user OR $rowItem["l_portal_user"] == 163) {
                            if ($rowItem["l_free_access"] == 1) {
                                $displayLibrary = true;
                            }
                        }
                    } else {
                        if ($rowItem["l_free_access"] == 0) {
                            $displayLibrary = true;
                        }
                    }

                    if ($displayLibrary == true) {
                        if ($type == 1) {
                            $panelBG = "bg-blue-chambray bg-font-blue-chambray"; //Program
                        } else if ($type == 2) {
                            $panelBG = "bg-blue-dark bg-font-blue-dark"; //Policy
                        } else if ($type == 3) {
                            $panelBG = "bg-blue-steel bg-font-blue-steel"; //Procedure
                        } else if ($type == 4) {
                            $panelBG = "bg-green-dark bg-font-green-dark"; //Training
                        } else if ($type == 5) {
                            $panelBG = "bg-green-jungle bg-font-green-jungle"; //Form
                        }

                        // $rowExpired = filesExpired($item_ID, $new_child_id, 0);
                        // $rowExpired30 = filesExpiredNear($item_ID, $new_child_id, 0, 0, 30);
                        // $rowExpired90 = filesExpiredNear($item_ID, $new_child_id, 0, 31, 90);
                        $totalCompliance = countCompliance($item_ID);

                        $output .= '<div class="panel panel-default panel_'. $item_ID .'">
                            <div class="panel-heading '. $panelBG .'">
                                <div class="row">
                                    <div class="col-md-10">
                                        <h4 class="panel-title bold">
    		                            	<a class="accordion-toggle font-white" data-toggle="collapse" data-parent="#parent'. $parent_id .'" onclick="selectedAccordion('. $item_ID .')" href="#item_'. $item_ID .'">'. htmlentities($rowItem["l_name"] ?? '');
    		                            		if (!empty($reason)) {
    		                            			$output .= '<i class="fa fa-warning font-red itemWarning" style="margin-left: 5px;"></i>';

    		                            			if ($current_userEmployerID == $user_id) {
    		                            				$output .= '<span class="remark_action itemWarning" style="margin-left: 10px;">
    		                            					<i type="button" class="btn btn-sm font-white" onclick="btnDeleteAction(1, 1, '.$item_ID.')">Accept</i> |
    							                  			<i type="button" class="btn btn-sm font-white" onclick="btnDeleteAction(0, 1, '.$item_ID.')">Reject</i>
    							                  		</span>';
    		                            			}
    		                            		}
    		                            	$output .= '</a>
    		                            </h4>
                                        <ul class="list-inline muted h6">';
                                            // <li><i class="fa fa-calendar-check-o"></i> Compliance (0%)</li>
                                            // <li><i class="fa fa-calendar-times-o"></i> Expires ('. $rowExpired .')</li>
                                            // <li><i class="fa fa-hourglass-1"></i> 1-30 Days ('. $rowExpired30 .')</li>
                                            // <li><i class="fa fa-hourglass-2"></i> 30-90 Days ('. $rowExpired90 .')</li>
                                            $output .= '<li><a href="#modalReport" class="btnReport font-white" data-id="'. $item_ID .'" data-toggle="modal" onclick="btnReport('. $item_ID .')"><i class="fa fa-table"></i> Report</a></li>
                                            <li><a href="#modalCollaborator" class="btnCollaborator font-white" data-toggle="modal" onclick="btnCollaborator('. $item_ID .')"><i class="fa fa-cogs"></i> Collaborator</a></li>
                                            <li><i class="fa fa-list-ol"></i> Compliance '.$totalCompliance.'%</li>
                                            <li><i class="fa fa-calendar-check-o"></i> Annual Review '.$review.'%</li>';

                                            // if ($rowDocs > 0) { $output .= '<li><i class="fa fa-file-o"></i> Docs ('. $rowDocs .')</li>'; }
                                            // if ($rowProgram > 0) { $output .= '<li><i class="fa fa-folder-open-o"></i> Programs ('. $rowProgram .')</li>'; }
                                            // if ($rowPolicy > 0) { $output .= '<li><i class="fa fa-file-text-o"></i> Policy ('. $rowPolicy .')</li>'; }
                                            // if ($rowProcedure > 0) { $output .= '<li><i class="fa fa-file-powerpoint-o"></i> Programs ('. $rowProcedure .')</li>'; }
                                            // if ($rowTraining > 0) { $output .= '<li><i class="fa fa-flag-o"></i> Trainings ('. $rowTraining .')</li>'; }
                                            // if ($rowForm > 0) { $output .= '<li><i class="fa fa-edit"></i> Forms ('. $rowForm .')</li>'; }

                                        $output .= '</ul>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="actions pull-right">
                                            <div class="btn-group">
                                                <a class="btn white btn-outlinex btn-circle btn-sm" href="javascript:;" data-toggle="dropdown" data-hover="dropdown" data-close-others="true">Select Action <i class="fa fa-angle-down"></i></a>
                                                <ul class="dropdown-menu pull-right">
                                                    <li><a href="#modalEdit_SubItem" class="btnEdit_SubItem" data-id="'. $item_ID .'" data-toggle="modal" onclick="btnEdit_SubItem('. $item_ID .')">Edit</a></li>
                                                    <li><a href="javascript:;" class="btnDelete" data-id="'. $item_ID .'" onclick="btnDelete('. $item_ID .')">Delete</a></li>
                                                    <li><a href="#modalReport" class="btnReport" data-id="'. $item_ID .'" data-toggle="modal" onclick="btnReport('. $item_ID .')">Report</a></li>';
                                            
    		                                        if ($current_userID == 1 OR $current_userID == 2 OR $current_userID == 19 OR $user_id == 163 OR $current_userEmployerID == 27 OR $current_userID == 475 OR $user_id == 464 OR $portal_user == 481 OR $portal_user == 1360 OR $portal_user == 1365 OR $portal_user == 1366) {
    		                                        	$output .= '<li><a href="#modalClone" data-toggle="modal" onclick="btnClone('. $item_ID .')">Clone</a></li>';
    		                                        }

                                                    $output .= '<li class="divider"> </li>';

    		                                        if ($current_client == 0) {
    	                                                $output .= '<li><a href="#modalAttached" class="btnAttached" data-id="'. $item_ID .'" data-toggle="modal" onclick="btnAttached('. $item_ID .')">Attach File</a></li>';
    	                                            }
                                                    
                                                    $output .= '<li><a href="#modalCompliance" class="btnCompliance" data-id="'. $item_ID .'" data-toggle="modal" onclick="btnCompliance('. $item_ID .')">Add Compliance</a></li>
                                                    <li><a href="#modalComment" class="btnComment" data-id="'. $item_ID .'" data-toggle="modal" onclick="btnComment('. $item_ID .')">Add Comment</a></li>
                                                    <li><a href="javascript:;" onclick="btnAnnualReviewTemplate('. $item_ID .')">Add Annual Review Template</a></li>

                                                    <li class="divider"> </li>
                                                    
                                                    <li><a href="#modalSubItem" class="btnSubItem" data-id="'. $item_ID .'" data-type="1" data-toggle="modal" onclick="btnSubItem('. $item_ID .', 1)">Add Programs</a></li>
                                                    <li><a href="#modalSubItem" class="btnSubItem" data-id="'. $item_ID .'" data-type="2" data-toggle="modal" onclick="btnSubItem('. $item_ID .', 2)">Add Policy</a></li>
                                                    <li><a href="#modalSubItem" class="btnSubItem" data-id="'. $item_ID .'" data-type="3" data-toggle="modal" onclick="btnSubItem('. $item_ID .', 3)">Add Procedure</a></li>
                                                    <li><a href="#modalSubItem" class="btnSubItem" data-id="'. $item_ID .'" data-type="5" data-toggle="modal" onclick="btnSubItem('. $item_ID .', 5)">Add Form</a></li>
                                                    <li><a href="#modalSubItem" class="btnSubItem" data-id="'. $item_ID .'" data-type="4" data-toggle="modal" onclick="btnSubItem('. $item_ID .', 4)">Add Training</a></li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div id="item_'. $item_ID .'" class="panel-collapse collapse"></div>
                        </div>';
                    }
                }
            }
        }

        return $output;
    }
    function filesExpired($parent_id, $child_id, $initial_count) {
        global $conn;
        $rowExpired_count = $initial_count;

        $resultItemFile = mysqli_query( $conn,"SELECT * FROM tbl_library_file WHERE due_date <= CURDATE() AND deleted = 0 AND library_id = $parent_id" );
        $rowExpired_count += mysqli_num_rows($resultItemFile);

        // Count Including Child Files
        // $resultItem = mysqli_query( $conn,"SELECT * FROM tbl_library WHERE deleted = 0 AND parent_id = $parent_id" );
        // if ( mysqli_num_rows($resultItem) > 0 ) {
        //     while($rowItem = mysqli_fetch_array($resultItem)) {
        //         $item_ID = $rowItem["ID"];
        //         $new_child_id = $rowItem["child_id"];

        //         $array_child_id = explode(", ", $child_id);
        //         if (in_array($item_ID, $array_child_id)) {
        //             $rowExpired_count = filesExpired($item_ID, $new_child_id, $rowExpired_count);
        //         }
        //     }
        // }

        return $rowExpired_count;
    }
    function filesExpiredNear($parent_id, $child_id, $initial_count, $from, $to) {
        global $conn;
        $rowExpired_count = $initial_count;

        $resultItemFile = mysqli_query( $conn,"SELECT * FROM tbl_library_file WHERE due_date > CURDATE() AND deleted = 0 AND library_id = $parent_id" );
        if ( mysqli_num_rows($resultItemFile) > 0 ) {
            while($rowItemFile = mysqli_fetch_array($resultItemFile)) {
                $due_date_id = $rowItemFile["ID"];
                $due_date = $rowItemFile["due_date"];
                $now = date('Y-m-d');

                $diff =  strtotime($now) - strtotime($due_date);
                $number = abs(round($diff / 86400));

                if ($number >= $from AND $number <= $to) {
                    $rowExpired_count ++;
                }
            }
        }

        // Count Including Child Files
        // $resultItem = mysqli_query( $conn,"SELECT * FROM tbl_library WHERE deleted = 0 AND parent_id = $parent_id" );
        // if ( mysqli_num_rows($resultItem) > 0 ) {
        //     while($rowItem = mysqli_fetch_array($resultItem)) {
        //         $item_ID = $rowItem["ID"];
        //         $new_child_id = $rowItem["child_id"];

        //         $array_child_id = explode(", ", $child_id);
        //         if (in_array($item_ID, $array_child_id)) {
        //             $rowExpired_count = filesExpiredNear($item_ID, $new_child_id, $rowExpired_count, $from, $to);
        //         }
        //     }
        // }

        return $rowExpired_count;
    }
    function rowDocs($library_ID) {
        global $conn;

        $countDocs = mysqli_query($conn,"SELECT * FROM tbl_library_file WHERE deleted = 0 AND library_id = $library_ID");
        $rowDocs = mysqli_num_rows($countDocs);

        return $rowDocs;
    }
    function rowType($library_ID, $type) {
        global $conn;

        $countType = mysqli_query($conn,"SELECT * FROM tbl_library WHERE deleted = 0 AND type = $type AND parent_id = $library_ID");
        $rowType = mysqli_num_rows($countProgram);

        return $rowType;
    }
    function fileExtension($file) {
        $extension = pathinfo($file, PATHINFO_EXTENSION);
        $src = 'https://view.officeapps.live.com/op/embed.aspx?src=';
        $embed = '&embedded=true';
        $type = 'iframe';
    	if (strtolower($extension) == "pdf") { $src = ''; $embed = ''; $type = ''; $file_extension = "fa-file-pdf-o"; }
		else if (strtolower($extension) == "doc" OR strtolower($extension) == "docx") { $file_extension = "fa-file-word-o"; }
		else if (strtolower($extension) == "ppt" OR strtolower($extension) == "pptx") { $file_extension = "fa-file-powerpoint-o"; }
		else if (strtolower($extension) == "xls" OR strtolower($extension) == "xlsb" OR strtolower($extension) == "xlsm" OR strtolower($extension) == "xlsx" OR strtolower($extension) == "csv" OR strtolower($extension) == "xlsx") { $file_extension = "fa-file-excel-o"; }
		else if (strtolower($extension) == "gif" OR strtolower($extension) == "jpg"  OR strtolower($extension) == "jpeg" OR strtolower($extension) == "png" OR strtolower($extension) == "ico") { $src = ''; $embed = ''; $type = ''; $file_extension = "fa-file-image-o"; }
		else if (strtolower($extension) == "mp4" OR strtolower($extension) == "mov"  OR strtolower($extension) == "wmv" OR strtolower($extension) == "flv" OR strtolower($extension) == "avi" OR strtolower($extension) == "avchd" OR strtolower($extension) == "webm" OR strtolower($extension) == "mkv") { $src = ''; $embed = ''; $type = ''; $file_extension = "fa-file-video-o"; }
		else { $src = ''; $embed = ''; $type = ''; $file_extension = "fa-file-code-o"; }

		$output['src'] = $src;
	    $output['embed'] = $embed;
	    $output['type'] = $type;
	    $output['file_extension'] = $file_extension;
	    $output['file_mime'] = $extension;
	    return $output;
    }
    function actionHistory($library_id, $action_id, $tab_id, $data_id) {
        global $conn;
		if (!empty($_COOKIE['switchAccount'])) {
			$portal_user = $_COOKIE['ID'];
			$user_id = $_COOKIE['switchAccount'];
		}
		else {
			$portal_user = $_COOKIE['ID'];
			$user_id = employerID($portal_user);
		}

		$sql = "INSERT INTO tbl_library_history (user_id, library_id, user_action, action_id, tab_id, data_id)
		VALUES ('$user_id', '$library_id', '$portal_user', '$action_id', '$tab_id', '$data_id')";
		mysqli_query($conn, $sql);
    }
    function countCompliance($library_ID) {
        global $conn;

    	$compliant = 0;
        $compliant_count = 0;
        $compliant_completed = 0;
        $resultCompliance = mysqli_query( $conn,"SELECT * FROM tbl_library_compliance WHERE parent_id = 0 AND deleted = 0 AND library_id = $library_ID " );
        if ( mysqli_num_rows($resultCompliance) > 0 ) {
            while($rowComplinace = mysqli_fetch_array($resultCompliance)) {
                $compliant_count++;
                $compliance_compliant = $rowComplinace['compliant'];
                if ($compliance_compliant == 1) { $compliant_completed++; }
            }

            if ($compliant_count == $compliant_completed) { $compliant = 100; }
        }

        return $compliant;
    }
    function commentNotification($target_id, $parent_id, $subject, $from, $sender, $data_names, $team, $comment_comment, $data_user_id) {
        global $conn;
        global $base_url;

		// Send to the Collabrator Account Account
		$selectData = mysqli_query( $conn,'SELECT * FROM tbl_library WHERE ID = "'.$parent_id.'" ORDER BY ID LIMIT 1' );
		if ( mysqli_num_rows($selectData) > 0 ) {
			$rowData = mysqli_fetch_array($selectData);
			$data_parent_id = $rowData["parent_id"];
			$data_collaborator_id = $rowData["collaborator_id"];

			// Check if has collab users
			if (!empty($data_collaborator_id )) {

                $output = json_decode($data_collaborator_id, true);
                foreach ($output as $key => $value) {
                    if ($data_user_id == $key) {
                        foreach($value['assigned_to_id'] as $value_id) {
							$selectDataUser = mysqli_query( $conn,'SELECT * FROM tbl_user WHERE employee_id = "'.$value_id.'" ORDER BY ID LIMIT 1' );
							if ( mysqli_num_rows($selectDataUser) > 0 ) {
								$rowDataUser = mysqli_fetch_array($selectDataUser);
								$datauser_fullname = $rowDataUser["first_name"] .' '. $rowDataUser["last_name"];
								$datauser_email = $rowDataUser["email"];
								$datauser_ID = $rowDataUser["ID"];
								$datauser_employer = employerID($datauser_ID);

								if ($team == 1) {
									if ($data_user_id == $datauser_employer) {
										$to = $datauser_email;
										$user = $datauser_fullname;
										$body = 'Hi there,<br><br>

										'.$sender.' has a comment on <b>'.$data_names.'</b><br>
										<i>"'.stripcslashes($comment_comment).'"</i><br><br>

										<a href="'. $base_url .'dashboard?d='. $target_id .'" target="_blank" style="font-weight: 600; padding: 10px 20px!important; text-decoration: none; color: #fff; background-color: #27a4b0; border-color: #208992; display: inline-block;">View Here</a>';

						    			php_mailer_2($to, $user, $subject, $body, $from, $sender);
									}
								} else if ($team == 2) {
									if ($data_user_id <> $datauser_employer) {
										$to = $datauser_email;
										$user = $datauser_fullname;
										$body = 'Hi there,<br><br>

										'.$sender.' has a comment on <b>'.$data_names.'</b><br>
										<i>"'.stripcslashes($comment_comment).'"</i><br><br>

										<a href="'. $base_url .'dashboard?d='. $target_id .'" target="_blank" style="font-weight: 600; padding: 10px 20px!important; text-decoration: none; color: #fff; background-color: #27a4b0; border-color: #208992; display: inline-block;">View Here</a>';

						    			php_mailer_2($to, $user, $subject, $body, $from, $sender);
									}
								}

							}
                        }
                    }
                }
			}

			// Check if has a parent
			if ($data_parent_id > 0) {
				commentNotification($target_id, $data_parent_id, $subject, $from, $sender, $data_names, $team, $comment_comment, $data_user_id);
			}
		}
    }
	if( isset($_GET['modalDashboard']) ) {
		$id = $_GET['modalDashboard'];

		$current_client = 0;
		if (isset($_COOKIE['client'])) { $current_client = $_COOKIE['client']; }

        if (!empty($_COOKIE['switchAccount'])) {
            $portal_user = $_COOKIE['ID'];
            $user_id = $_COOKIE['switchAccount'];
        }
        else {
            $portal_user = $_COOKIE['ID'];
            $user_id = employerID($portal_user);
        }

        $hasLibrary = mysqli_query( $conn,"SELECT * FROM tbl_library WHERE user_id = $user_id" );
        if ( mysqli_num_rows($hasLibrary) == 0 ) {
            $user_id = 163;
            $current_userEmployerID = $user_id;
            $current_userID = $user_id;
        } else {
            $current_userEmployerID = $user_id;
            $current_userID = $_COOKIE['ID'];
        }
		
		// $selectData = mysqli_query( $conn,"SELECT * FROM tbl_library WHERE ID = $id AND deleted = 0 AND user_id = $user_id" );
        $selectData = mysqli_query( $conn,"SELECT
            l.ID AS l_ID,
            l.parent_id AS l_parent_id,
            l.child_id AS l_child_id,
            l.type AS l_type,
            l.reason AS l_reason,
            l.name AS l_name,
            l.description AS l_description,
            l.description_tmp AS l_description_tmp,
            l.description_reviewed AS l_description_reviewed,
            l.description_approved AS l_description_approved,
            l.reviewer AS l_reviewer,
            l.approver AS l_approver,
            COUNT(r.r_ID) AS review_total,
            COALESCE(SUM(r.r_compliant), 0) AS review_sum
            FROM tbl_library AS l

            LEFT JOIN (
                SELECT
                ID AS r_ID,
                library_id AS r_library_id,
                compliant AS r_compliant
                FROM tbl_library_review
                WHERE parent_id = 0
                AND is_deleted = 0
            ) AS r
            ON l.ID = r.r_library_id

            WHERE l.deleted = 0
            AND l.ID = $id
            AND l.user_id = $user_id" );
		if ( mysqli_num_rows($selectData) > 0 ) {
            $row = mysqli_fetch_array($selectData);
            $library_ID = $row["l_ID"];
            $library_parent_id = $row["l_parent_id"];
            $library_child = $row["l_child_id"];
            $reason = $row["l_reason"];

            $review = 0;
            $review_sum = $row["review_sum"];
            $review_total = $row["review_total"];
            if ($review_total > 0 AND $review_sum > 0) {
                $review = round(($review_sum / $review_total) * 100);
            }

            $library_name = $row["l_name"];
            $array_name_id = explode(", ", $library_name);
            if ( count($array_name_id) == 4 ) {
                $data_name = array();

                $selectType = mysqli_query($conn,"SELECT * FROM tbl_library_type WHERE ID = '".$array_name_id[0]."'");
                if ( mysqli_num_rows($selectType) > 0 ) {
                    while($rowType = mysqli_fetch_array($selectType)) {
                        array_push($data_name, $rowType["name"]);
                    }
                }

                $selectCategory = mysqli_query($conn,"SELECT * FROM tbl_library_category WHERE ID = '".$array_name_id[1]."'");
                if ( mysqli_num_rows($selectCategory) > 0 ) {
                    while($rowCategory = mysqli_fetch_array($selectCategory)) {
                        array_push($data_name, $rowCategory["name"]);
                    }
                }

                $selectScope = mysqli_query($conn,"SELECT * FROM tbl_library_scope WHERE ID = '".$array_name_id[2]."'");
                if ( mysqli_num_rows($selectScope) > 0 ) {
                    while($rowScope = mysqli_fetch_array($selectScope)) {
                        array_push($data_name, $rowScope["name"]);
                    }
                }

                $selectModule = mysqli_query($conn,"SELECT * FROM tbl_library_module WHERE ID = '".$array_name_id[3]."'");
                if ( mysqli_num_rows($selectModule) > 0 ) {
                    while($rowModule = mysqli_fetch_array($selectModule)) {
                        array_push($data_name, $rowModule["name"]);
                    }
                }

                $library_name = implode(" - ",$data_name);
            }

            // $rowExpired = filesExpired($library_ID, $library_child, 0);
            // $rowExpired30 = filesExpiredNear($library_ID, $library_child, 0, 0, 30);
            // $rowExpired90 = filesExpiredNear($library_ID, $library_child, 0, 31, 90);

            // $rowProgram = rowType($library_ID, 1);
            // $rowProgram = rowType($library_ID, 2);
            // $rowProgram = rowType($library_ID, 3);
            // $rowProgram = rowType($library_ID, 4);
            // $rowProgram = rowType($library_ID, 5);
            $totalCompliance = countCompliance($library_ID);
            // $totalCompliance = 0;

            echo '<div class="panel panel-default panel_'. $library_ID .'">
                <div class="panel-heading">
                    <div class="row">
                        <div class="col-md-10">
                            <h4 class="panel-title bold">
                            	<a class="accordion-toggle font-dark" data-toggle="collapse" data-parent="#parent" href="#item_'. $library_ID .'">'. htmlentities($library_name ?? '');
                            		if (!empty($reason)) {
                            			echo '<i class="fa fa-warning font-red itemWarning" style="margin-left: 5px;"></i>';

                            			if ($current_userEmployerID == $user_id) {
											echo '<span class="remark_action itemWarning" style="margin-left: 10px;">
												<i type="button" class="btn btn-sm font-dark" onclick="btnDeleteAction(1, 1, '.$library_ID.')">Accept</i> |
												<i type="button" class="btn btn-sm font-dark" onclick="btnDeleteAction(0, 1, '.$library_ID.')">Reject</i>
											</span>';
										}
                            		}
                            	echo '</a>
                            </h4>
                            <ul class="list-inline muted h6">';
                                // <li><i class="fa fa-calendar-check-o"></i> Compliance (0%)</li>
                                // <li><i class="fa fa-calendar-times-o"></i> Expires ('. $rowExpired .')</li>
                                // <li><i class="fa fa-hourglass-1"></i> 1-30 Days ('. $rowExpired30 .')</li>
                                // <li><i class="fa fa-hourglass-2"></i> 30-90 Days ('. $rowExpired90 .')</li>
                                echo '<li><a href="#modalReport" class="btnReport font-dark" data-id="'. $library_ID .'" data-toggle="modal" onclick="btnReport('. $library_ID .')"><i class="fa fa-table"></i> Report</a></li>
                                <li><a href="#modalCollaborator" class="btnCollaborator font-dark" data-toggle="modal" onclick="btnCollaborator('. $library_ID .')"><i class="fa fa-cogs"></i> Collaborator</a></li>
                                <li><i class="fa fa-list-ol"></i> Compliance '.$totalCompliance.'%</li>
                                <li><i class="fa fa-calendar-check-o"></i> Annual Review '.$review.'%</li>';

                                // if ($rowDocs > 0) { echo '<li><i class="fa fa-file-o"></i> Docs ('. $rowDocs .')</li>'; }
                                // if ($rowProgram > 0) { echo '<li><i class="fa fa-folder-open-o"></i> Programs ('. $rowProgram .')</li>'; }
                                // if ($rowPolicy > 0) { echo '<li><i class="fa fa-file-text-o"></i> Policy ('. $rowPolicy .')</li>'; }
                                // if ($rowProcedure > 0) { echo '<li><i class="fa fa-file-powerpoint-o"></i> Programs ('. $rowProcedure .')</li>'; }
                                // if ($rowTraining > 0) { echo '<li><i class="fa fa-flag-o"></i> Trainings ('. $rowTraining .')</li>'; }
                                // if ($rowForm > 0) { echo '<li><i class="fa fa-edit"></i> Forms ('. $rowForm .')</li>'; }
                                
                            echo '</ul>
                        </div>
                        <div class="col-md-2">
                            <div class="actions pull-right">
                                <div class="btn-group">
                                    <a class="btn dark btn-outline btn-circle btn-sm" href="javascript:;" data-toggle="dropdown" data-hover="dropdown" data-close-others="true">Select Action <i class="fa fa-angle-down"></i></a>
                                    <ul class="dropdown-menu pull-right">';
                                    	
                                    	if ($library_parent_id > 0) {
                                    		echo '<li><a href="#modalEdit_SubItem" class="btnEdit_SubItem" data-id="'. $library_ID .'" data-toggle="modal" onclick="btnEdit_SubItem('. $library_ID .')">Edit</a></li>';
                                    	} else {
                                    		echo '<li><a href="#modalEdit" class="btnEdit" data-id="'. $library_ID .'" data-toggle="modal" onclick="btnEdit('. $library_ID .')">Edit</a></li>';
                                    	}
                                    	
                                        echo '<li><a href="javascript:;" class="btnDelete" data-id="'. $library_ID .'" onclick="btnDelete('. $library_ID .')">Delete</a></li>
                                        <li><a href="#modalReport" class="btnReport" data-id="'. $library_ID .'" data-toggle="modal" onclick="btnReport('. $library_ID .')">Report</a></li>';
                                        
                                        if ($current_userID == 1 OR $current_userID == 2 OR $current_userID == 19 OR $user_id == 163 OR $current_userEmployerID == 27 OR $current_userID == 475 OR $user_id == 464 OR $portal_user == 481 OR $portal_user == 1360 OR $portal_user == 1365 OR $portal_user == 1366) {
                                        	echo '<li><a href="#modalClone" data-toggle="modal" onclick="btnClone('. $library_ID .')">Clone</a></li>';
                                        }
                                        
                                        if ($current_userID == 1 OR $current_userEmployerID == 34) {
                                        	echo '<li><a href="javascript:;" onclick="btnDownload('. $library_ID .')">Download Files</a></li>';
                                        }
                                     
                                        echo '<li class="divider"> </li>';

		                                if ($current_client == 0) {
	                                        echo '<li><a href="#modalAttached" class="btnAttached" data-id="'. $library_ID .'" data-toggle="modal" onclick="btnAttached('. $library_ID .')">Attach File</a></li>';
	                                    }
                                        
                                        echo '<li><a href="#modalCompliance" class="btnCompliance" data-id="'. $library_ID .'" data-toggle="modal" onclick="btnCompliance('. $library_ID .')">Add Compliance</a></li>
                                        <li><a href="#modalComment" class="btnComment" data-id="'. $library_ID .'" data-toggle="modal" onclick="btnComment('. $library_ID .')">Add Comment</a></li>
                                        <li><a href="javascript:;" onclick="btnAnnualReviewTemplate('. $library_ID .')">Add Annual Review Template</a></li>

                                        <li class="divider"> </li>
                                        
                                        <li><a href="#modalSubItem" class="btnSubItem" data-id="'. $library_ID .'" data-type="1" data-toggle="modal" onclick="btnSubItem('. $library_ID .', 1)">Add Programs</a></li>
                                        <li><a href="#modalSubItem" class="btnSubItem" data-id="'. $library_ID .'" data-type="2" data-toggle="modal" onclick="btnSubItem('. $library_ID .', 2)">Add Policy</a></li>
                                        <li><a href="#modalSubItem" class="btnSubItem" data-id="'. $library_ID .'" data-type="3" data-toggle="modal" onclick="btnSubItem('. $library_ID .', 3)">Add Procedure</a></li>
                                        <li><a href="#modalSubItem" class="btnSubItem" data-id="'. $library_ID .'" data-type="5" data-toggle="modal" onclick="btnSubItem('. $library_ID .', 5)">Add Form</a></li>
                                        <li><a href="#modalSubItem" class="btnSubItem" data-id="'. $library_ID .'" data-type="4" data-toggle="modal" onclick="btnSubItem('. $library_ID .', 4)">Add Training</a></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="item_'. $library_ID .'" class="panel-collapse collapse">
                    <div class="panel-body">
                        <div class="row">
                            <div class="tabbable-line">
                                <ul class="nav nav-tabs">
                                    <li class="active"><a href="#tabDescription_'. $library_ID .'" data-toggle="tab" aria-expanded="true">Description</a></li>
                                    <li class=""><a href="#tabFiles_'. $library_ID .'" data-toggle="tab" aria-expanded="true">Files</a></li>
                                    <li class="">';

                                		$countComment = 0;
                                    	$team = 1;
                                    	if (!empty($_COOKIE['switchAccount'])) { $team = 2; }
                                		$resultComment = mysqli_query( $conn,"SELECT * FROM tbl_library_comment WHERE deleted = 0 AND library_id = $library_ID AND team = $team ORDER BY ID DESC " );
                                        if ( mysqli_num_rows($resultComment) > 0 ) {
                                            while($rowComment = mysqli_fetch_array($resultComment)) {
                                            	if (!empty($rowComment["seen"])) {
		                                            $comment_seen_arr = explode(", ", $rowComment["seen"]);
		                                            if (!in_array($current_userID, $comment_seen_arr)) {
		                                            	$countComment++;
		                                            }
                                            	} else {
		                                           	$countComment++;
                                            	}
	                                        }
	                                    }

                                    	echo '<a href="#tabComments_'. $library_ID .'" data-toggle="tab" aria-expanded="false" onclick="countComment('.$library_ID.', '.$countComment.')">
                                    		Comments';

		                                    if ($countComment > 0) {
		                                    	echo ' <span class="badge badge-danger">'.$countComment.'</span>';
		                                    }
                                    		
                                    	echo '</a>
                                    </li>
                                    <li class=""><a href="#tabHistory_'. $library_ID .'" data-toggle="tab" aria-expanded="false">History</a></li>
                                    <li class=""><a href="#tabCompliance_'. $library_ID .'" data-toggle="tab" aria-expanded="false">Compliance</a></li>
                                    <li class=""><a href="#tabReview_'. $library_ID .'" data-toggle="tab" aria-expanded="false">Annual Review</a></li>
                                    <li class=""><a href="#tabTemplate_'. $library_ID .'" data-toggle="tab" aria-expanded="false">Templates</a></li>';

		                            if ($current_client == 0) {
	                                    echo '<li class=""><a href="#tabReferences_'. $library_ID .'" data-toggle="tab" aria-expanded="false">References</a></li>
	                                    <li class=""><a href="#tabVideo_'. $library_ID .'" data-toggle="tab" aria-expanded="false">Video</a></li>';
	                                }
                                    
                                    echo '<li class=""><a href="#tabTask_'. $library_ID .'" data-toggle="tab" aria-expanded="false">Task</a></li>
                                </ul>
                                <div class="tab-content">
                                    <div class="tab-pane active" id="tabDescription_'. $library_ID .'">
                                        <h5 style="padding: 0 15px;">'. $row["l_description"] .'</h5>';

                                        if (!empty($row["l_description_tmp"])) {
                                            echo '<a href="#modalChanges" data-toggle="modal" class="btn text-success" onclick="btnChangesView('.$library_ID.')">View Changes</a>';
                                            if (($portal_user == $row["l_reviewer"] AND $row["l_description_reviewed"] == 0) OR ($portal_user == $row["l_approver"] AND $row["l_description_reviewed"] == 1 AND $row["l_description_approved"] == 0)) {
                                                echo ' | <span class="btn text-info" onclick="btnChangesAccept('.$library_ID.')">Accept</span> | <span class="btn text-danger" onclick="btnChangesReject('.$library_ID.')">Reject</span>';
                                            }
                                        }

                                    echo '</div>
                                    <div class="tab-pane" id="tabFiles_'. $library_ID .'">
                                        <div class="mt-actions">';
                                            $resultFiles = mysqli_query( $conn,"SELECT * FROM tbl_library_file WHERE deleted = 0 AND library_id = $library_ID ORDER BY ID DESC" );
                                            if ( mysqli_num_rows($resultFiles) > 0 ) {
                                                while($rowFiles = mysqli_fetch_array($resultFiles)) {
                                                    $file_ID = $rowFiles["ID"];
                                                    $file_name = $rowFiles["name"];
                                                    $file_comment = $rowFiles["comment"];
                                                    $file_reason = $rowFiles["reason"];

                                                    $file_user_id = $rowFiles["user_id"];
                                                    $selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $file_user_id " );
                                                    $rowUser = mysqli_fetch_array($selectUser);
                                                    $file_user = $rowUser["first_name"] .' '. $rowUser["last_name"];
                                                    if (employerID($file_user_id) == 34 AND $user_id != 34) {
                                                        $file_user = 'Compliance';
                                                    }

                                                    $files = '';
                                                    $type = 'iframe';
                                                    $file_extension = 'fa-youtube-play';
                                                    if (!empty($rowFiles["files"])) {
                                                        $arr_filename = explode(' | ', $rowFiles["files"]);
                                                        $arr_filetype = explode(' | ', $rowFiles["filetype"]);
                                                        $str_filename = '';

                                                        foreach($arr_filename as $val_filename) {
                                                            $str_filename = $val_filename;
                                                        }
                                                        foreach($arr_filetype as $val_filetype) {
                                                            $str_filetype = $val_filetype;
                                                        }

                                                        $files = $str_filename;
                                                        if ($str_filetype == 1) {
                                                            $fileExtension = fileExtension($str_filename);
                                                            $src = $fileExtension['src'];
                                                            $embed = $fileExtension['embed'];
                                                            $type = $fileExtension['type'];
                                                            $file_extension = $fileExtension['file_extension'];
                                                            $url = $base_url.'uploads/library/';

                                                            $files = $src.$url.rawurlencode($str_filename).$embed;
                                                        } else if ($str_filetype == 3) {
                                                            $files = preg_replace('#[^/]*$#', '', $str_filename).'preview';
                                                            $file_extension = 'fa-google';
                                                        }
                                                    }

                                                    $file_due_date = $rowFiles["due_date"];
                                                    $file_due = $file_due_date;
                                                    if ($file_due_date != "0000-00-00") {
                                                        $file_due = new DateTime(substr($file_due_date, 0, 10));
                                                        $file_due = $file_due->format('M d, Y');
                                                    }

                                                    $displayLibrary = false;
                                                    if (mysqli_num_rows($hasLibrary) == 0) {
                                                        if ($rowFiles["free_access"] == 1) {
                                                            $displayLibrary = true;
                                                        }
                                                    } else {
                                                        if ($rowFiles["free_access"] == 0) {
                                                            $displayLibrary = true;
                                                        }
                                                    }

                                                    if ($displayLibrary == true) {
                                                        echo '<div class="mt-action mt-action-'. $file_ID .'">
                                                            <div class="mt-action-body">
                                                                <div class="mt-action-row">
                                                                    <div class="mt-action-info">
                                                                        <div class="mt-action-icon">
                                                                            <a href="'.$files.'" data-src="'.$files.'" data-fancybox data-type="'.$type.'"><i class="fa fa-fw '. $file_extension .'"></i></a>
                                                                        </div>
                                                                        <div class="mt-action-details" style="vertical-align: middle;">
                                                                            <span class="mt-action-author">'. $file_name;

    																			if (!empty($file_reason)) {
    																				echo '<i class="fa fa-warning font-red itemWarning" style="margin-left: 5px;"></i>';

    																				if ($current_userEmployerID == $user_id) {
    																					echo '<span class="remark_action itemWarning" style="margin-left: 10px;">
    																						<i type="button" class="btn btn-sm font-dark" onclick="btnDeleteAction(1, 2, '.$file_ID.')">Accept</i> |
    																						<i type="button" class="btn btn-sm font-dark" onclick="btnDeleteAction(0, 2, '.$file_ID.')">Reject</i>
    																					</span>';
    																				}
    																			}

                                                                            echo '</span>
                                                                            <p class="mt-action-desc">
                                                                            	<span class="font-dark">'. htmlentities($file_comment ?? '') .'</span><br>
                                                                            	Uploaded by: '. $file_user .'
                                                                            </p>
                                                                        </div>
                                                                    </div>
                                                                    <div class="mt-action-datetime">
                                                                        <span class="mt-action-date">'. $file_due .'</span>
                                                                    </div>
                                                                    <div class="mt-action-buttons">
                                                                        <div class="btn-group btn-group-circle">
                                                                        	<a href="#modalAttachedEdit" type="button" class="btn btn-outline dark btn-sm" data-toggle="modal" onclick="btnAttachedEdit('. $file_ID .')">Edit</a>
                                                                        	<a href="javascript:;" type="button" class="btn red btn-sm" onclick="btnDeleteFile('. $file_ID .')">Delete</a>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>';
                                                    }
                                                }
                                            }
                                        echo '</div>
                                        <a href="#modalAttached" class="btn btn-circle btn-success btnAttached" data-id="'. $library_ID .'" data-toggle="modal" onclick="btnAttached('. $library_ID .')" style="margin: 15px;">Attach File</a>
                                    </div>
                                   	<div class="tab-pane" id="tabComments_'. $library_ID .'">
                                    	<div class="mt-actions">';

                                    		$resultComment = mysqli_query( $conn,"SELECT * FROM tbl_library_comment WHERE deleted = 0 AND library_id = $library_ID ORDER BY ID DESC" );
                                            if ( mysqli_num_rows($resultComment) > 0 ) {
                                                while($rowComment = mysqli_fetch_array($resultComment)) {
                                                	$comment_ID = $rowComment["ID"];
                                                	$comment_title = $rowComment["title"];
                                                	$comment_comment = $rowComment["comment"];

                                                	$comment_last_modified = $rowComment["last_modified"];
                                                    $comment_last_modified = new DateTime($comment_last_modified);
                                                    $comment_last_modified = $comment_last_modified->format('d M Y \a\t g:ia');

                                                	$comment_user_id = $rowComment["user_id"];
                                                    $resultUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $comment_user_id" );
                                                    $rowUser = mysqli_fetch_array($resultUser);
                                                	$comment_name = $rowUser["first_name"] .' '. $rowUser["last_name"];
                                                    if (employerID($comment_user_id) == 34 AND $user_id != 34) {
                                                        $comment_name = 'Compliance';
                                                    }

                                                	$comment_avatar = "https://via.placeholder.com/200x150/EFEFEF/AAAAAA.png?text=no+image";
                                                	$resultUserInfo = mysqli_query( $conn,"SELECT * FROM tbl_user_info WHERE user_id = $comment_user_id" );
                                                	if ( mysqli_num_rows($resultUserInfo) > 0 ) {
                                                		$rowUserInfo = mysqli_fetch_array($resultUserInfo);
                                                		if ( !empty($rowUserInfo["avatar"]) ) {
                                                            $comment_avatar = $base_url.'uploads/avatar/'. $rowUserInfo["avatar"];
                                                        }
                                                	}

		                                    		echo '<div class="mt-action mt-action-'.$comment_ID.'">
		                                                <div class="mt-action-body" style="padding-right: 15px;">
		                                                    <div class="mt-action-row">
		                                                        <div class="mt-action-info">
		                                                            <div class="mt-action-icon">
		                                                            	<img class="img-circle" src="'. $comment_avatar .'" alt="'.$comment_name.'" style="width: 40px; height: 40px; object-fit: contain;"/>
		                                                            </div>
		                                                            <div class="mt-action-details" style="vertical-align: middle;">
		                                                                <p class="mt-action-desc">
		                                                                	<span class="font-dark"><b>'.htmlentities($comment_title ?? '').'</b> '.htmlentities($comment_comment ?? '').'</span><br>
		                                                                	Commented by: '.$comment_name.'
		                                                                </p>
		                                                            </div>
		                                                        </div>
		                                                        <div class="mt-action-datetime">
		                                                            <span class="mt-action-date">'. $comment_last_modified .'</span>
		                                                        </div>
		                                                    </div>
		                                                </div>
		                                            </div>';
		                                        }
		                                    }

                                    	echo '</div>
                                        <a href="#modalComment" class="btn btn-circle btn-success btnComment" data-id="'. $library_ID .'" data-toggle="modal" onclick="btnComment('. $library_ID .')" style="margin: 15px;">Add Comment</a>
                                    </div>
                                    <div class="tab-pane" id="tabHistory_'. $library_ID .'">
                                        <ul class="todo-task-history">';

                                            $resultHistory = mysqli_query( $conn,"SELECT * FROM tbl_library_history WHERE library_id = $library_ID ORDER BY ID DESC" );
                                           	if ( mysqli_num_rows($resultHistory) > 0 ) {
                                           		while($rowHistory = mysqli_fetch_array($resultHistory)) {
                                                    $history_id = $rowHistory["ID"];

                                                    $history_user_action = $rowHistory["user_action"];
                                                    $selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $history_user_action" );
                                                    $rowUser = mysqli_fetch_array($selectUser);
                                                    $history_user_name = $rowUser["first_name"] .' '. $rowUser["last_name"];
                                                    if (employerID($history_user_action) == 34 AND $user_id != 34) {
                                                        $history_user_name = 'Compliance';
                                                    }

                                                    $history_last_modified = $rowHistory["last_modified"];
                                                    $history_last_modified = new DateTime($history_last_modified);
                                                    $history_last_modified = $history_last_modified->format('M d, Y \a\t g:ia');

                                                    $history_action_id = $rowHistory["action_id"];
                                                	$history_action = array(
                                                        1 => 'Added',
                                                        2 => 'Updated',
                                                        3 => 'Deleted',
                                                        4 => 'Accepted',
                                                        5 => 'Rejected'
                                                    );

                                                    $history_tab_id = $rowHistory["tab_id"];
                                                	$history_tab = array(
                                                        0 => 'tbl_library',
                                                        1 => 'tbl_library_file',
                                                        2 => 'tbl_library_comment',
                                                        3 => 'tbl_library_compliance',
                                                        4 => 'tbl_library_review',
                                                        5 => 'tbl_library_template',
                                                        6 => 'tbl_library_references',
                                                        7 => 'tbl_library_video'
                                                    );
                                                    $history_tab_tbl = $history_tab[$history_tab_id];

                                                    $history_data_id = $rowHistory["data_id"];
                                                    $rowData_text = "";
                                                    $rowData_tab = "";
                                                    $selectData = mysqli_query( $conn,"SELECT * FROM $history_tab_tbl WHERE ID = $history_data_id" );
                                                    if ( mysqli_num_rows($selectData) > 0 ) {
                                                    	$rowData = mysqli_fetch_array($selectData);

                                                    	if ($history_tab_id == 0) {
                                                    		$rowData_tab = 'dashboard';
                                                    		$rowData_parent_id = $rowData["parent_id"];

                                                    		$rowData_type_id = $rowData["type"];
		                                                	$rowData_type = array(
		                                                        0 => 'Dashboard',
		                                                        1 => 'Program',
		                                                        2 => 'Policy',
		                                                        3 => 'Procedure',
		                                                        4 => 'Training',
		                                                        5 => 'Form',
		                                                    );

                                                    		$rowData_name = $rowData["name"];
															$rowData_name_arr = explode(", ", $rowData_name);
															if ( count($rowData_name_arr) == 4 ) {
															    $data_name = array();

															    $selectType = mysqli_query($conn,"SELECT * FROM tbl_library_type WHERE ID = '".$rowData_name_arr[0]."'");
															    if ( mysqli_num_rows($selectType) > 0 ) {
															        while($rowType = mysqli_fetch_array($selectType)) {
															            array_push($data_name, $rowType["name"]);
															        }
															    }

															    $selectCategory = mysqli_query($conn,"SELECT * FROM tbl_library_category WHERE ID = '".$rowData_name_arr[1]."'");
															    if ( mysqli_num_rows($selectCategory) > 0 ) {
															        while($rowCategory = mysqli_fetch_array($selectCategory)) {
															            array_push($data_name, $rowCategory["name"]);
															        }
															    }

															    $selectScope = mysqli_query($conn,"SELECT * FROM tbl_library_scope WHERE ID = '".$rowData_name_arr[2]."'");
															    if ( mysqli_num_rows($selectScope) > 0 ) {
															        while($rowScope = mysqli_fetch_array($selectScope)) {
															            array_push($data_name, $rowScope["name"]);
															        }
															    }

															    $selectModule = mysqli_query($conn,"SELECT * FROM tbl_library_module WHERE ID = '".$rowData_name_arr[3]."'");
															    if ( mysqli_num_rows($selectModule) > 0 ) {
															        while($rowModule = mysqli_fetch_array($selectModule)) {
															            array_push($data_name, $rowModule["name"]);
															        }
															    }

															    $rowData_name = implode(" - ",$data_name);
															}
															$rowData_text = 'a '.$rowData_type[$rowData_type_id].' '. $rowData_name;
                                                    	} else if ($history_tab_id == 1) {
                                                    		$rowData_tab = 'file';
                                                    		$rowData_text = 'a '. $rowData["name"];
                                                    	} else if ($history_tab_id == 2) {
                                                    		$rowData_tab = 'comment';
                                                    		$rowData_text = 'a comment about '. $rowData["title"];
                                                    	} else if ($history_tab_id == 3) {
                                                    		$rowData_tab = 'compliance';
                                                    		$rowData_parent_id = $rowData["parent_id"];
                                                    		$rowData_action_items = $rowData["action_items"];

                                                    		$rowData_type_id = $rowData["type"];
		                                                	$rowData_type = array(
		                                                        0 => 'Observed',
		                                                        1 => 'Performed',
		                                                        2 => 'Verified',
		                                                        3 => 'Reviewed',
		                                                    );

		                                                    if ($rowData_type_id > 0) {
		                                                    	$selectCompliance = mysqli_query( $conn,"SELECT * FROM tbl_library_compliance WHERE ID = $rowData_parent_id" );
		                                                    	$rowComplinace = mysqli_fetch_array($selectCompliance);
                                                    			$rowData_action_items = $rowComplinace["action_items"];
		                                                    }

                                                    		$rowData_text = 'a '.$rowData_type[$rowData_type_id].' action for '. $rowData_action_items;
                                                    	} else if ($history_tab_id == 4) {
                                                    		$rowData_tab = 'annual review';

                                                    		$rowData_type_id = $rowData["type"];
		                                                	$rowData_type = array(
		                                                        0 => 'Observation',
		                                                        1 => 'Correction',
		                                                        2 => 'Verification',
		                                                        3 => 'Approval',
                                                                4 => 'Reviewed'
		                                                    );

                                                    		$rowData_text = 'a '.$rowData_type[$rowData_type_id].' action for '. $rowData["title"];
                                                    	} else if ($history_tab_id == 5) {
                                                    		$rowData_tab = 'template';
                                                    		$rowData_text = 'a file '. $rowData["files"];
                                                    	} else if ($history_tab_id == 6) {
                                                    		$rowData_tab = 'reference';
                                                    		$rowData_text = 'a file '. $rowData["files"];
                                                    	}
                                                    }

                                                    echo '<li>
		                                                <div class="todo-task-history-date-cd"><b>'.$history_user_name.'</b> | <i>'.$history_last_modified.'</i></div>
		                                                <div class="todo-task-history-desc-cd">'.$history_action[$history_action_id].' '.htmlentities($rowData_text).' in the '.$rowData_tab.' tab.</div>
		                                            </li>';
                                                }
                                           	}

                                        echo '</ul>
                                    </div>
                                    <div class="tab-pane" id="tabCompliance_'. $library_ID .'" style="padding: 0 15px;">
                                        <div class="table-scrollable">
                                            <table class="table table-bordered table-hover">
                                                <thead>
                                                    <tr>
                                                        <th class="text-center" style="width: 130px;">Completed</th>
                                                        <th>Requirements</th>
                                                        <th>Action Items</th>
                                                        <th style="width: 300px;">Frequency</th>
                                                        <th class="text-center" style="width: 130px;">Uploaded Files</th>
                                                        <th style="width: 175px;"></th>
                                                    </tr>
                                                </thead>
                                                <tbody>';

                                                    $compliant = 0;
                                                    $resultCompliance = mysqli_query( $conn,"SELECT * FROM tbl_library_compliance WHERE parent_id = 0 AND deleted = 0 AND library_id = $library_ID " );
                                                    if ( mysqli_num_rows($resultCompliance) > 0 ) {
                                                        $compliant_count = 0;
                                                        $compliant_completed = 0;
                                                        while($rowComplinace = mysqli_fetch_array($resultCompliance)) {
                                                            $compliance_ID = $rowComplinace["ID"];
                                                        	$compliance_child_id = $rowComplinace["child_id"];

                                                            $compliance_user_id = $rowComplinace["user_id"];
		                                                    $selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $compliance_user_id " );
		                                                    $rowUser = mysqli_fetch_array($selectUser);
		                                                    $compliance_user = $rowUser["first_name"] .' '. $rowUser["last_name"];
                                                            if (employerID($compliance_user_id) == 34 AND $user_id != 34) {
                                                                $compliance_user = 'Compliance';
                                                            }

                                                            $compliance_compliant = $rowComplinace['compliant'];
                                                            $compliant_count++;
                                                            if ($compliance_compliant == 1) {
                                                                $compliant_completed++;
                                                            }

                                                            $compliance_frequency = $rowComplinace['frequency'];
                                                            $compliance_schedule_id = $rowComplinace['schedule'];
                                                            $array_schedule_id = explode(", ", $compliance_schedule_id);
                                                            $days = array(
                                                                1 => 'Monday',
                                                                2 => 'Tuesday',
                                                                3 => 'Wednesday',
                                                                4 => 'Thursday',
                                                                5 => 'Friday',
                                                                6 => 'Saturday',
                                                                7 => 'Sunday'
                                                            );
                                                            $frequency = $compliance_frequency;
                                                            if ( count($array_schedule_id) == 4 ) {
											                    $time = $array_schedule_id[0];
											                    $time_f = date_create($time);
                                                                $day_ms = $array_schedule_id[1];
                                                                $day_num = $array_schedule_id[2];
                                                                $month = $array_schedule_id[3];

                                                                if ($compliance_frequency == 1) {             // Daily
                                                                    // $sec = 1000;
                                                                    // $min = 60 * $sec;   // 60,000
                                                                    // $hr = 60 * $min;    // 3,600,000
                                                                    // $day = 24 * $hr;    // 86,4000,000

                                                                    // $due_hr = date_format($time,"G") * $hr;
                                                                    // $due_min = date_format($time,"i") * $min;
                                                                    // $due_before = 2 * $hr;
                                                                    // $due = ($due_hr + $due_min) - $due_before;

                                                                    // $cur_time = date("G:i:s");
                                                                    // $cur_hr = 1 * $hr;
                                                                    // $cur_min = 1 * $min;
                                                                    // $cur = ($cur_hr + $cur_min) - $due;

                                                                    // $frequency = 'Every '. date_format($time,"g:i A") .' daily '. $due_hr .' : '. $due_min .' - '. $due_before .' = '. $due .' | '. $cur_time .' : '. $cur_hr .' - '. $cur_min .' = '. $cur;
                                                                    
                                                                    $frequency = 'Daily';
		                                                        	if (!empty($time)) {
		                                                        		$frequency = 'Every '. date_format($time_f,"g:i A") .' daily';
		                                                        	}
                                                                } else if ($compliance_frequency == 2) {      // Weekly

                                                                	$frequency = 'Weekly';
                                                                	if (!empty($day_ms) AND !empty($time)) {
                                                                		$frequency = 'Every '. $days[$day_ms] .' at '. date_format($time_f,"g:i A");
                                                                	}
                                                                } else if ($compliance_frequency == 3) {      // Monthly

                                                                	$frequency = 'Monthly';
                                                                	if (!empty($day_num) AND !empty($time)) {
                                                                		$frequency = 'Every '. $day_num.date("S", mktime(0, 0, 0, 0, intval($day_num), 0)) .' day of the Month at '. date_format($time_f,"g:i A");
                                                                	}
                                                                } else if ($compliance_frequency == 4) {      // Yearly

                                                                	$frequency = 'Yearly';
                                                                	if (!empty($day_num) AND !empty($time) AND !empty($month)) {
                                                                		$frequency = 'Every '. $day_num.date("S", mktime(0, 0, 0, 0, intval($day_num), 0)) .' day of '. date("F", mktime(0, 0, 0, intval($month)+1, 0, 0)) .' at '. date_format($time_f,"g:i A");
                                                                	}
                                                                }
                                                            }

                                                            $filetype = $rowComplinace['filetype'];
                                                            $files = $rowComplinace["files"];
                                                            $type = 'iframe';
                                                            $file_extension = 'fa-youtube-play';
                                                            if (!empty($files)) {
                                                                if ($filetype == 1) {
                                                                    $fileExtension = fileExtension($files);
                                                                    $src = $fileExtension['src'];
                                                                    $embed = $fileExtension['embed'];
                                                                    $type = $fileExtension['type'];
                                                                    $file_extension = $fileExtension['file_extension'];
                                                                    $url = $base_url.'uploads/library/';

                                                                    $files = $src.$url.rawurlencode($files).$embed;
                                                                } else if ($filetype == 3) {
                                                                    $files = preg_replace('#[^/]*$#', '', $files).'preview';
                                                                    $file_extension = 'fa-google';
                                                                }
                                                                $files = '<a href="'.$files.'" data-src="'.$files.'" data-fancybox data-type="'.$type.'">View</a>';
                                                            }

                                                            $displayLibrary = false;
                                                            if (mysqli_num_rows($hasLibrary) == 0) {
                                                                if ($rowComplinace["free_access"] == 1) {
                                                                    $displayLibrary = true;
                                                                }
                                                            } else {
                                                                if ($rowComplinace["free_access"] == 0) {
                                                                    $displayLibrary = true;
                                                                }
                                                            }

                                                            if ($displayLibrary == true) {
                                                                echo '<tr id="tr_'. $compliance_ID .'">
                                                                    <td class="text-center"><input type="checkbox" class="make-switch" name="status" data-on-text="Yes" data-off-text="No" data-on-color="success" onchange="changedStatus(this, '.$compliance_ID.', '. $library_ID .')" data-off-color="danger" '; echo $compliance_compliant === "1" ? "checked" : "";  echo ' readonly /></td>
                                                                    <td>'. htmlentities($rowComplinace["requirements"] ?? '') .'</td>
                                                                    <td>'. htmlentities($rowComplinace["action_items"] ?? '') .'</td>
                                                                    <td>'. $frequency .'</td>
                                                                    <td class="text-center">'.$files.'</td>
                                                                    <td>
                                                                        <div class="btn-group btn-group-circle">
                                                                            <a href="#modalComplianceEdit" type="button" class="btn btn-outline dark btn-sm" data-toggle="modal" onclick="btnComplianceEdit('. $compliance_ID .')">Edit</a>
                                                                            <a href="javascript:;" type="button" class="btn red btn-sm" onclick="btnComplianceDelete('. $compliance_ID .')">Delete</a>';

    														                if ($compliance_compliant == 0) {
    														                	echo '<a href="#modalComplianceMore" type="button" class="btn blue btn-sm" data-toggle="modal" onclick="btnComplianceMore('.$compliance_ID.')">Action</a>';
    														                }

                                                                        echo '</div>
                                                                    </td>
                                                                </tr>';
                                                            }

		                                                    if (!empty($compliance_child_id)) {
		                                                    	$array_child_id = explode(", ", $compliance_child_id);
												                foreach ($array_child_id as $value) {
				                                                    $resultComplianceItem = mysqli_query( $conn,"SELECT * FROM tbl_library_compliance WHERE deleted = 0 AND ID = $value " );
				                                                    if ( mysqli_num_rows($resultComplianceItem) > 0 ) {
				                                                        while($rowComplinaceItem = mysqli_fetch_array($resultComplianceItem)) {
				                                                            $compliance_ID = $rowComplinaceItem["ID"];
				                                                        	$compliance_parent_id = $rowComplinaceItem["parent_id"];
				                                                        	$compliance_comment = $rowComplinaceItem["comment"];
				                                                        	$compliance_remark = $rowComplinaceItem["remark"];

				                                                            $compliance_user_id = $rowComplinaceItem["user_id"];
						                                                    $selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $compliance_user_id " );
						                                                    $rowUser = mysqli_fetch_array($selectUser);
						                                                    $compliance_user = $rowUser["first_name"] .' '. $rowUser["last_name"];
                                                                            if (employerID($compliance_user_id) == 34 AND $user_id != 34) {
                                                                                $compliance_user = 'Compliance';
                                                                            }

                                                                            $filetype = $rowComplinaceItem['filetype'];
                                                                            $files = $rowComplinaceItem["files"];
                                                                            $type = 'iframe';
                                                                            $file_extension = 'fa-youtube-play';
                                                                            if (!empty($files)) {
                                                                                if ($filetype == 1) {
                                                                                    $fileExtension = fileExtension($files);
                                                                                    $src = $fileExtension['src'];
                                                                                    $embed = $fileExtension['embed'];
                                                                                    $type = $fileExtension['type'];
                                                                                    $file_extension = $fileExtension['file_extension'];
                                                                                    $url = $base_url.'uploads/library/';

                                                                                    $files = $src.$url.rawurlencode($files).$embed;
                                                                                } else if ($filetype == 3) {
                                                                                    $files = preg_replace('#[^/]*$#', '', $files).'preview';
                                                                                    $file_extension = 'fa-google';
                                                                                }
                                                                                $files = '<a href="'.$files.'" data-src="'.$files.'" data-fancybox data-type="'.$type.'">View</a>';
                                                                            }

				                                                        	$compliance_type = $rowComplinaceItem["type"];
				                                                        	$ctype = array(
				                                                                0 => 'Observed',
				                                                                1 => 'Performed',
				                                                                2 => 'Verified',
				                                                                3 => 'Reviewed'
				                                                            );

				                                                        	$compliance_last_modified = $rowComplinaceItem["last_modified"];
						                                                    $compliance_last_modified = new DateTime($compliance_last_modified);
						                                                    $compliance_last_modified = $compliance_last_modified->format('M d, Y');

                                                                            $displayLibrary = false;
                                                                            if (mysqli_num_rows($hasLibrary) == 0) {
                                                                                if ($rowComplinaceItem["free_access"] == 1) {
                                                                                    $displayLibrary = true;
                                                                                }
                                                                            } else {
                                                                                if ($rowComplinaceItem["free_access"] == 0) {
                                                                                    $displayLibrary = true;
                                                                                }
                                                                            }

                                                                            if ($displayLibrary == true) {
    				                                                            echo '<tr id="tr_'. $compliance_ID .'" class="child_'.$compliance_parent_id.'">
    				                                                                <td style="border: 0;"></td>
    				                                                                <td colspan="2">
    																					<strong>'.$compliance_user.'</strong> <i>('.$ctype[$compliance_type].')</i><br>';

    																					if (!empty($compliance_comment)) { echo '<span class="text-muted">'.htmlentities($compliance_comment ?? '').'</span><br>'; }
    																					
    																					echo '<div class="remark_action">';
    																						if (!empty($compliance_remark)) {
    																							if ($compliance_remark == "1") { echo '<span class="text-success">Accepted</span>'; }
    																							else { echo '<span class="text-danger">'.htmlentities($compliance_remark ?? '').'</span>'; }
    																						} else {
    																							echo '<a href="javascript:;" type="button" class="btn btn-sm btn-link" onclick="btnComplianceAccept('. $compliance_ID .')">Accept</a> |
    					                                                                		<a href="javascript:;" type="button" class="btn btn-sm btn-link" onclick="btnComplianceReject('. $compliance_ID .')">Reject</a>';
    																						}
    																					echo '</div>';
    																					
    																				echo '</td>
    				                                                                <td>Date: <b>'. $compliance_last_modified .'</b></td>
    				                                                                <td class="text-center">'.$files.'</td>
    				                                                                <td>
    				                                                                    <div class="btn-group btn-group-circle">
    				                                                                        <a href="#modalComplianceMoreEdit" type="button" class="btn btn-outline dark btn-sm" data-toggle="modal" onclick="btnComplianceMoreEdit('. $compliance_ID .')">Edit</a>
    				                                                                        <a href="javascript:;" type="button" class="btn red btn-sm" onclick="btnComplianceDelete('. $compliance_ID .')">Delete</a>
    				                                                                    </div>
    				                                                                </td>
    				                                                            </tr>';
    				                                                        }
                                                                        }
				                                                    }
				                                                }
				                                            }
                                                        }

                                                        if ($compliant_count == $compliant_completed) { $compliant = 100; }
                                                    }
                                                    
                                                echo '</tbody>
                                                <tfoot>
                                                    <tr>
                                                        <th class="text-center">'. $compliant .'%</th>
                                                        <th colspan="5">Compliant</th>
                                                    </tr>
                                                </tfoot>
                                            </table>
                                        </div>
                                        <a href="#modalCompliance" class="btn btn-circle btn-success btnCompliance" data-toggle="modal" onclick="btnCompliance('. $library_ID .')" style="margin: 15px 0;">Add Compliance</a>
                                    </div>
                                    <div class="tab-pane" id="tabReview_'. $library_ID .'" style="padding: 0 15px;">
                                    	<div class="table-scrollable">
                                            <table class="table table-bordered table-hover">
                                                <thead>
                                                    <tr>
                                                        <th style="width: 130px;" class="text-center">Compliant</th>
                                                        <th>Requirements</th>
                                                        <th>Action Items</th>
                                                        <th style="width: 130px;" class="text-center">File</th>
                                                        <th style="width: 180px;"></th>
                                                    </tr>
                                                </thead>
                                                <tbody>';

													$resultReview= mysqli_query( $conn,"SELECT * FROM tbl_library_review WHERE parent_id = 0 AND is_deleted = 0 AND library_id = $library_ID " );
                                                    if ( mysqli_num_rows($resultReview) > 0 ) {
                                                        while($rowReview = mysqli_fetch_array($resultReview)) {
                                                        	$review_ID = $rowReview["ID"];
                                                        	$review_compliant = $rowReview["compliant"];
                                                            $review_title = htmlentities($rowReview["title"] ?? '');
                                                        	$review_child_id = $rowReview["child_id"];
                                                        	$review_action_items = $rowReview["action_items"];
                                                        	$review_requirements = $rowReview["requirements"];

		                                                    $review_user_id = $rowReview["user_id"];
		                                                    $selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $review_user_id " );
		                                                    $rowUser = mysqli_fetch_array($selectUser);
		                                                    $review_name = $rowUser["first_name"] .' '. $rowUser["last_name"];
                                                            if (employerID($review_user_id) == 34 AND $user_id != 34) {
                                                                $review_name = 'Compliance';
                                                            }

															$review_template = $rowReview["template"];
															if ($review_template == 1) {
																$review_comment = "No Changes Noted During Review";
															} else {
																$review_comment = $rowReview["comment"];
															}

                                                        	$review_type = $rowReview["type"];
                                                        	$rtype = array(
                                                                0 => 'Observed',
                                                                1 => 'Corrected',
                                                                2 => 'Verified',
                                                                3 => 'Approved',
                                                                4 => 'Reviewed'
                                                            );

                                                        	$review_last_modified = $rowReview["last_modified"];
		                                                    $review_last_modified = new DateTime($review_last_modified);
		                                                    $review_last_modified = $review_last_modified->format('M d, Y');

                                                            $files = '';
                                                            $type = 'iframe';
                                                            $file_extension = 'fa-youtube-play';
                                                            if (!empty($rowReview["files"])) {
                                                                $arr_filename = explode(' | ', $rowReview["files"]);
                                                                $arr_filetype = explode(' | ', $rowReview["filetype"]);
                                                                $str_filename = '';

                                                                foreach($arr_filename as $val_filename) {
                                                                    $str_filename = $val_filename;
                                                                }
                                                                foreach($arr_filetype as $val_filetype) {
                                                                    $str_filetype = $val_filetype;
                                                                }

                                                                $files = $str_filename;
                                                                if ($str_filetype == 1) {
                                                                    $fileExtension = fileExtension($str_filename);
                                                                    $src = $fileExtension['src'];
                                                                    $embed = $fileExtension['embed'];
                                                                    $type = $fileExtension['type'];
                                                                    $file_extension = $fileExtension['file_extension'];
                                                                    $url = $base_url.'uploads/library/';

                                                                    $files = $src.$url.rawurlencode($str_filename).$embed;
                                                                } else if ($str_filetype == 3) {
                                                                    $files = preg_replace('#[^/]*$#', '', $str_filename).'preview';
                                                                    $file_extension = 'fa-google';
                                                                }
                                                                $files = '<a href="'.$files.'" data-src="'.$files.'" data-fancybox data-type="'.$type.'">View</a>';
                                                            }

                                                            $displayLibrary = false;
                                                            if (mysqli_num_rows($hasLibrary) == 0) {
                                                                if ($rowReview["free_access"] == 1) {
                                                                    $displayLibrary = true;
                                                                }
                                                            } else {
                                                                if ($rowReview["free_access"] == 0) {
                                                                    $displayLibrary = true;
                                                                }
                                                            }

                                                            if ($displayLibrary == true) {
    		                                                    echo '<tr id="tr_'.$review_ID.'">
    																<td class="text-center"><input type="checkbox" class="make-switch" name="status" data-on-text="Yes" data-off-text="No" data-on-color="success" onchange="changedStatus(this, 1, 1)" data-off-color="danger" '; echo $review_compliant == 1 ? 'checked':''; echo ' readonly /></td>
    																<td>'.htmlentities($review_requirements ?? '').'</td>
    																<td>'.htmlentities($review_action_items ?? '').'</td>
    																<td class="text-center">'.$files.'</td>
    																<td>
    														            <div class="btn-group btn-group-circle">
    														                <a href="#modalReviewEdit" type="button" class="btn btn-outline dark btn-sm" data-toggle="modal" onclick="btnReviewEdit('.$review_ID.')">Edit</a>
    														                <a href="javascript:;" type="button" class="btn red btn-sm" onclick="btnReviewDelete('.$review_ID.', '.$library_ID.')">Delete</a>';

    														                if ($review_compliant == 0) {
    														                	echo '<a href="#modalReviewAction" type="button" class="btn blue btn-sm" data-toggle="modal" onclick="btnReviewAction('.$review_ID.')">Review</a>';
    														                }

    														            echo '</div>
    														        </td>
    															</tr>';
                                                            }

		                                                    if (!empty($review_child_id)) {
		                                                    	$array_child_id = explode(", ", $review_child_id);
												                foreach ($array_child_id as $value) {
												                    $selectReviewItem = mysqli_query( $conn,"SELECT * FROM tbl_library_review WHERE is_deleted = 0 AND ID=$value" );
												                    if ( mysqli_num_rows($selectReviewItem) > 0 ) {
												                    	while($rowReviewItem = mysqli_fetch_array($selectReviewItem)) {
				                                                        	$review_ID = $rowReviewItem["ID"];
				                                                        	$review_compliant = $rowReviewItem["compliant"];
				                                                        	$review_title = $rowReviewItem["title"];
				                                                        	$review_parent_id = $rowReviewItem["parent_id"];
				                                                        	$review_child_id = $rowReviewItem["child_id"];

						                                                    $review_user_id = $rowReviewItem["user_id"];
						                                                    $selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $review_user_id " );
						                                                    $rowUser = mysqli_fetch_array($selectUser);
						                                                    $review_name = $rowUser["first_name"] .' '. $rowUser["last_name"];
                                                                            if (employerID($review_user_id) == 34 AND $user_id != 34) {
                                                                                $review_name = 'Compliance';
                                                                            }

																			$review_template = $rowReviewItem["template"];
																			if ($review_template == 1) {
																				$review_comment = "No Changes Noted During Review";
																			} else {
																				$review_comment = $rowReviewItem["comment"];
																			}
				                                            				$review_remark = $rowReviewItem["remark"];

				                                                        	$review_type = $rowReviewItem["type"];
				                                                        	$rtype = array(
				                                                                0 => 'Observed',
				                                                                1 => 'Corrected',
				                                                                2 => 'Verified',
				                                                                3 => 'Approved',
				                                                                4 => 'Reviewed'
				                                                            );

				                                                        	$review_last_modified = $rowReviewItem["last_modified"];
						                                                    $review_last_modified = new DateTime($review_last_modified);
						                                                    $review_last_modified = $review_last_modified->format('M d, Y');

                                                                            $files = '';
                                                                            $type = 'iframe';
                                                                            $file_extension = 'fa-youtube-play';
                                                                            if (!empty($rowReferences["files"])) {
                                                                                $arr_filename = explode(' | ', $rowReviewItem["files"]);
                                                                                $arr_filetype = explode(' | ', $rowReviewItem["filetype"]);
                                                                                $str_filename = '';

                                                                                foreach($arr_filename as $val_filename) {
                                                                                    $str_filename = $val_filename;
                                                                                }
                                                                                foreach($arr_filetype as $val_filetype) {
                                                                                    $str_filetype = $val_filetype;
                                                                                }

                                                                                $files = $str_filename;
                                                                                if ($str_filetype == 1) {
                                                                                    $fileExtension = fileExtension($str_filename);
                                                                                    $src = $fileExtension['src'];
                                                                                    $embed = $fileExtension['embed'];
                                                                                    $type = $fileExtension['type'];
                                                                                    $file_extension = $fileExtension['file_extension'];
                                                                                    $url = $base_url.'uploads/library/';

                                                                                    $files = $src.$url.rawurlencode($str_filename).$embed;
                                                                                } else if ($str_filetype == 3) {
                                                                                    $files = preg_replace('#[^/]*$#', '', $str_filename).'preview';
                                                                                    $file_extension = 'fa-google';
                                                                                }
                                                                                $files = '<a href="'.$files.'" data-src="'.$files.'" data-fancybox data-type="'.$type.'">View</a>';
                                                                            }

                                                                            $displayLibrary = false;
                                                                            if (mysqli_num_rows($hasLibrary) == 0) {
                                                                                if ($rowReviewItem["free_access"] == 1) {
                                                                                    $displayLibrary = true;
                                                                                }
                                                                            } else {
                                                                                if ($rowReviewItem["free_access"] == 0) {
                                                                                    $displayLibrary = true;
                                                                                }
                                                                            }

                                                                            if ($displayLibrary == true) {
    																			echo '<tr id="tr_'. $review_ID .'" class="child_'.$review_parent_id.'">
    																				<td style="border: 0;"></td>
    																				<td colspan="2">
    																					<b>'.$review_name.'</b> <i>('.$rtype[$review_type].')</i> | '.$review_last_modified.'<br>';

    																					if (!empty($review_title)) { echo '<span class="text-muted">'.htmlentities($review_title ?? '').'</span><br>'; }
    																					if (!empty($review_comment)) { echo '<span class="text-muted">'.htmlentities($review_comment ?? '').'</span><br>'; }
    																					
    																					echo '<div class="remark_action">';
    																						if (!empty($review_remark)) {
    																							if ($review_remark == "1") { echo '<span class="text-success">Accepted!</span>'; }
    																							else { echo '<span class="text-danger">'.htmlentities($review_remark ?? '').'</span>'; }
    																						} else {
    																							echo '<a href="javascript:;" type="button" class="btn btn-sm btn-link" onclick="btnReviewAccept('. $review_ID .')">Accept</a> |
    					                                                                		<a href="javascript:;" type="button" class="btn btn-sm btn-link" onclick="btnReviewReject('. $review_ID .')">Reject</a>';
    																						}
    																					echo '</div>
    																				</td>
    																				<td class="text-center">'.$files.'</td>
    																				<td>
    																		            <div class="btn-group btn-group-circle">
    																		                <a href="#modalReviewActionEdit" type="button" class="btn btn-outline dark btn-sm" data-toggle="modal" onclick="btnReviewActionEdit('.$review_ID.')">Edit</a>
    																		                <a href="javascript:;" type="button" class="btn red btn-sm" onclick="btnReviewDelete('.$review_ID.', '.$library_ID.')">Delete</a>';

    																		                if ($review_compliant == 0) {
    																		                	echo '<a href="#modalReviewMore" type="button" class="btn blue btn-sm" data-toggle="modal" onclick="btnReviewMore('.$review_ID.')">Action</a>';
    																		                }
    																		            
    																		            echo '</div>
    																		        </td>
    																			</tr>';
                                                                            }

																			if (!empty($review_child_id)) {
    					                                                    	$array_child_id = explode(", ", $review_child_id);
    															                foreach ($array_child_id as $value) {
    															                    $selectReviewItem = mysqli_query( $conn,"SELECT * FROM tbl_library_review WHERE is_deleted = 0 AND ID=$value" );
    															                    if ( mysqli_num_rows($selectReviewItem) > 0 ) {
    															                    	while($rowReviewItem = mysqli_fetch_array($selectReviewItem)) {
    							                                                        	$review_ID = $rowReviewItem["ID"];
    							                                                        	$review_compliant = $rowReviewItem["compliant"];
    							                                                        	$review_title = $rowReviewItem["title"];
    							                                                        	$review_parent_id_action = $rowReviewItem["parent_id"];
    							                                                        	$review_child_id_action = $rowReviewItem["child_id"];

    									                                                    $review_user_id = $rowReviewItem["user_id"];
    									                                                    $selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $review_user_id " );
    									                                                    $rowUser = mysqli_fetch_array($selectUser);
    									                                                    $review_name = $rowUser["first_name"] .' '. $rowUser["last_name"];
                                                                                            if (employerID($review_user_id) == 34 AND $user_id != 34) {
                                                                                                $review_name = 'Compliance';
                                                                                            }

    																						$review_template = $rowReviewItem["template"];
    																						if ($review_template == 1) {
    																							$review_comment = "No Changes Noted During Review";
    																						} else {
    																							$review_comment = $rowReviewItem["comment"];
    																						}
    							                                            				$review_remark = $rowReviewItem["remark"];

    							                                                        	$review_type = $rowReviewItem["type"];
    							                                                        	$rtype = array(
    							                                                                0 => 'Observed',
    							                                                                1 => 'Corrected',
    							                                                                2 => 'Verified',
    							                                                                3 => 'Approved',
    							                                                                4 => 'Reviewed'
    							                                                            );

    							                                                        	$review_last_modified = $rowReviewItem["last_modified"];
    									                                                    $review_last_modified = new DateTime($review_last_modified);
    									                                                    $review_last_modified = $review_last_modified->format('M d, Y');

                                                                                            $files = '';
                                                                                            $type = 'iframe';
                                                                                            $file_extension = 'fa-youtube-play';
                                                                                            if (!empty($rowReferences["files"])) {
                                                                                                $arr_filename = explode(' | ', $rowReviewItem["files"]);
                                                                                                $arr_filetype = explode(' | ', $rowReviewItem["filetype"]);
                                                                                                $str_filename = '';

                                                                                                foreach($arr_filename as $val_filename) {
                                                                                                    $str_filename = $val_filename;
                                                                                                }
                                                                                                foreach($arr_filetype as $val_filetype) {
                                                                                                    $str_filetype = $val_filetype;
                                                                                                }

                                                                                                $files = $str_filename;
                                                                                                if ($str_filetype == 1) {
                                                                                                    $fileExtension = fileExtension($str_filename);
                                                                                                    $src = $fileExtension['src'];
                                                                                                    $embed = $fileExtension['embed'];
                                                                                                    $type = $fileExtension['type'];
                                                                                                    $file_extension = $fileExtension['file_extension'];
                                                                                                    $url = $base_url.'uploads/library/';

                                                                                                    $files = $src.$url.rawurlencode($str_filename).$embed;
                                                                                                } else if ($str_filetype == 3) {
                                                                                                    $files = preg_replace('#[^/]*$#', '', $str_filename).'preview';
                                                                                                    $file_extension = 'fa-google';
                                                                                                }
                                                                                            }

                                                                                            $displayLibrary = false;
                                                                                            if (mysqli_num_rows($hasLibrary) == 0) {
                                                                                                if ($rowReviewItem["free_access"] == 1) {
                                                                                                    $displayLibrary = true;
                                                                                                }
                                                                                            } else {
                                                                                                if ($rowReviewItem["free_access"] == 0) {
                                                                                                    $displayLibrary = true;
                                                                                                }
                                                                                            }

                                                                                            if ($displayLibrary == true) {
        																						echo '<tr id="tr_'. $review_ID .'" class="child_'.$review_parent_id.' child_action_'.$review_parent_id_action.'">
        																							<td style="border: 0;"></td>
        																							<td colspan="2">
        																								<b>'.$review_name.'</b> <i>('.$rtype[$review_type].')</i> | '.$review_last_modified.'<br>';

        																								if (!empty($review_title)) { echo '<span class="text-muted">'.htmlentities($review_title ?? '').'</span><br>'; }
        																								if (!empty($review_comment)) { echo '<span class="text-muted">'.htmlentities($review_comment ?? '').'</span><br>'; }
        																								
        																								echo '<div class="remark_action">';
        																									if (!empty($review_remark)) {
        																										if ($review_remark == "1") { echo '<span class="text-success">Accepted!</span>'; }
        																										else { echo '<span class="text-danger">'.htmlentities($review_remark ?? '').'</span>'; }
        																									} else {
        																										echo '<a href="javascript:;" type="button" class="btn btn-sm btn-link" onclick="btnReviewAccept('. $review_ID .')">Accept</a> |
        								                                                                		<a href="javascript:;" type="button" class="btn btn-sm btn-link" onclick="btnReviewReject('. $review_ID .')">Reject</a>';
        																									}
        																								echo '</div>
        																							</td>
        																							<td class="text-center">'.$files.'</td>
        																							<td>
        																					            <div class="btn-group btn-group-circle">
        																					                <a href="#modalReviewMoreEdit" type="button" class="btn btn-outline dark btn-sm" data-toggle="modal" onclick="btnReviewMoreEdit('.$review_ID.')">Edit</a>
        																					                <a href="javascript:;" type="button" class="btn red btn-sm" onclick="btnReviewDelete('.$review_ID.', '.$library_ID.')">Delete</a>
        																								</div>
        																					        </td>
        																						</tr>';
                                                                                            }
    														                            }
    														                        }
    														                    }
    					                                                    }
											                            }
											                        }
											                    }
		                                                    }
                                                        }
                                                    }

                                                echo '</tbody>
                                                <tfoot>
                                                    <tr>
                                                        <th class="text-center">'.$review.'%</th>
                                                        <th colspan="4">Annual Review</th>
                                                    </tr>
                                                </tfoot>
                                            </table>
                                        </div>
                                        <a href="#modalReview" class="btn btn-circle btn-success" data-toggle="modal" onclick="btnReview('. $library_ID .')" style="margin: 15px 0;">Add Review</a>
                                    </div>
                                    <div class="tab-pane" id="tabTemplate_'. $library_ID .'">
                                    	<div class="mt-actions">';

                                    		$selectTemplate = mysqli_query( $conn,"SELECT * FROM tbl_library_template WHERE is_deleted = 0 AND library_id = $library_ID ORDER BY ID DESC" );
                                            if ( mysqli_num_rows($selectTemplate) > 0 ) {
                                                while($rowTemplate = mysqli_fetch_array($selectTemplate)) {
                                                    $template_ID = $rowTemplate["ID"];
                                                    $template_description = $rowTemplate["description"];

                                                    $template_user_id = $rowTemplate["user_id"];
                                                    $selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $template_user_id " );
                                                    $rowUser = mysqli_fetch_array($selectUser);
                                                    $template_name = $rowUser["first_name"] .' '. $rowUser["last_name"];
                                                    if (employerID($template_user_id) == 34 AND $user_id != 34) {
                                                        $template_name = 'Compliance';
                                                    }

                                                    $files = '';
                                                    $type = 'iframe';
                                                    $file_extension = 'fa-youtube-play';
                                                    if (!empty($rowTemplate["files"])) {
                                                        $arr_filename = explode(' | ', $rowTemplate["files"]);
                                                        $arr_filetype = explode(' | ', $rowTemplate["filetype"]);
                                                        $str_filename = '';

                                                        foreach($arr_filename as $val_filename) {
                                                            $str_filename = $val_filename;
                                                        }
                                                        foreach($arr_filetype as $val_filetype) {
                                                            $str_filetype = $val_filetype;
                                                        }

                                                        $files = $str_filename;
                                                        if ($str_filetype == 1) {
                                                            $fileExtension = fileExtension($str_filename);
                                                            $src = $fileExtension['src'];
                                                            $embed = $fileExtension['embed'];
                                                            $type = $fileExtension['type'];
                                                            $file_extension = $fileExtension['file_extension'];
                                                            $url = $base_url.'uploads/library/';

                                                            $files = $src.$url.rawurlencode($str_filename).$embed;
                                                        } else if ($str_filetype == 3) {
                                                            $files = preg_replace('#[^/]*$#', '', $str_filename).'preview';
                                                            $file_extension = 'fa-google';
                                                        }
                                                    }

                                                    $template_last_modified = $rowTemplate["last_modified"];
                                                    $template_last_modified = new DateTime($template_last_modified);
                                                    $template_last_modified = $template_last_modified->format('M d, Y');

                                                    $displayLibrary = false;
                                                    if (mysqli_num_rows($hasLibrary) == 0) {
                                                        if ($rowTemplate["free_access"] == 1) {
                                                            $displayLibrary = true;
                                                        }
                                                    } else {
                                                        if ($rowTemplate["free_access"] == 0) {
                                                            $displayLibrary = true;
                                                        }
                                                    }

                                                    if ($displayLibrary == true) {
                                        				echo '<div class="mt-action mt-action-'. $template_ID .'">
                                                            <div class="mt-action-body">
                                                                <div class="mt-action-row">
                                                                    <div class="mt-action-info">
                                                                        <div class="mt-action-icon">
                                                                            <a href="'.$files.'" data-src="'.$files.'" data-fancybox data-type="'.$type.'"><i class="fa fa-fw '. $file_extension .'"></i></a>
                                                                        </div>
                                                                        <div class="mt-action-details" style="vertical-align: middle;">
                                                                            <p class="mt-action-desc">
                                                                            	<span class="font-dark">'. htmlentities($template_description ?? '') .'</span><br>
                                                                            	Uploaded by: '. $template_name .'
                                                                            </p>
                                                                        </div>
                                                                    </div>
                                                                    <div class="mt-action-datetime">
                                                                        <span class="mt-action-date">'. $template_last_modified .'</span>
                                                                    </div>
                                                                    <div class="mt-action-buttons">
                                                                        <div class="btn-group btn-group-circle">
                                                                        	<a href="#modalTemplateEdit" type="button" class="btn btn-outline dark btn-sm" data-toggle="modal" onclick="btnTemplateEdit('. $template_ID .')">Edit</a>
                                                                        	<a href="javascript:;" type="button" class="btn red btn-sm" onclick="btnTemplateDelete('. $template_ID .', '. $library_ID .')">Delete</a>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>';
                                                    }
                                                }
                                            }

                                    	echo '</div>
                                    	<a href="#modalTemplate" class="btn btn-circle btn-success" data-toggle="modal" onclick="btnTemplate('. $library_ID .')" style="margin: 15px;">Add Templates</a>
                                    </div>';

		                            if ($current_client == 0) {
	                                    echo '<div class="tab-pane" id="tabReferences_'. $library_ID .'">
	                                    	<div class="mt-actions">';

	                                    		$selectReferences = mysqli_query( $conn,"SELECT * FROM tbl_library_references WHERE is_deleted = 0 AND library_id = $library_ID ORDER BY ID DESC" );
	                                            if ( mysqli_num_rows($selectReferences) > 0 ) {
	                                                while($rowReferences = mysqli_fetch_array($selectReferences)) {
	                                                    $ref_ID = $rowReferences["ID"];
	                                                    $ref_description = $rowReferences["description"];

	                                                    $ref_user_id = $rowReferences["user_id"];
	                                                    $selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $ref_user_id " );
	                                                    $rowUser = mysqli_fetch_array($selectUser);
	                                                    $ref_name = $rowUser["first_name"] .' '. $rowUser["last_name"];
                                                        if (employerID($ref_user_id) == 34 AND $user_id != 34) {
                                                            $ref_name = 'Compliance';
                                                        }

                                                        $files = '';
                                                        $type = 'iframe';
                                                        $file_extension = 'fa-youtube-play';
                                                        if (!empty($rowReferences["files"])) {
                                                            $arr_filename = explode(' | ', $rowReferences["files"]);
                                                            $arr_filetype = explode(' | ', $rowReferences["filetype"]);
                                                            $str_filename = '';

                                                            foreach($arr_filename as $val_filename) {
                                                                $str_filename = $val_filename;
                                                            }
                                                            foreach($arr_filetype as $val_filetype) {
                                                                $str_filetype = $val_filetype;
                                                            }

                                                            $files = $str_filename;
                                                            if ($str_filetype == 1) {
                                                                $fileExtension = fileExtension($str_filename);
                                                                $src = $fileExtension['src'];
                                                                $embed = $fileExtension['embed'];
                                                                $type = $fileExtension['type'];
                                                                $file_extension = $fileExtension['file_extension'];
                                                                $url = $base_url.'uploads/library/';

                                                                $files = $src.$url.rawurlencode($str_filename).$embed;
                                                            } else if ($str_filetype == 3) {
                                                                $files = preg_replace('#[^/]*$#', '', $str_filename).'preview';
                                                                $file_extension = 'fa-google';
                                                            }
                                                        }

	                                                    $ref_last_modified = $rowReferences["last_modified"];
	                                                    $ref_last_modified = new DateTime($ref_last_modified);
	                                                    $ref_last_modified = $ref_last_modified->format('M d, Y');

                                                        $displayLibrary = false;
                                                        if (mysqli_num_rows($hasLibrary) == 0) {
                                                            if ($rowReferences["free_access"] == 1) {
                                                                $displayLibrary = true;
                                                            }
                                                        } else {
                                                            if ($rowReferences["free_access"] == 0) {
                                                                $displayLibrary = true;
                                                            }
                                                        }

                                                        if ($displayLibrary == true) {
    	                                    				echo '<div class="mt-action mt-action-'. $ref_ID .'">
    	                                                        <div class="mt-action-body">
    	                                                            <div class="mt-action-row">
    	                                                                <div class="mt-action-info">
    	                                                                    <div class="mt-action-icon">
                                                                                <a href="'.$files.'" data-src="'.$files.'" data-fancybox data-type="'.$type.'"><i class="fa fa-fw '. $file_extension .'"></i></a>
    	                                                                    </div>
    	                                                                    <div class="mt-action-details" style="vertical-align: middle;">
    	                                                                        <p class="mt-action-desc">
    	                                                                        	<span class="font-dark">'. htmlentities($ref_description ?? '') .'</span><br>
    	                                                                        	Uploaded by: '. $ref_name .'
    	                                                                        </p>
    	                                                                    </div>
    	                                                                </div>
    	                                                                <div class="mt-action-datetime">
    	                                                                    <span class="mt-action-date">'. $ref_last_modified .'</span>
    	                                                                </div>
    	                                                                <div class="mt-action-buttons">
    	                                                                    <div class="btn-group btn-group-circle">
    	                                                                    	<a href="#modalRefEdit" type="button" class="btn btn-outline dark btn-sm" data-toggle="modal" onclick="btnRefEdit('. $ref_ID .')">Edit</a>
    	                                                                    	<a href="javascript:;" type="button" class="btn red btn-sm" onclick="btnRefDelete('. $ref_ID .', '. $library_ID .')">Delete</a>
    	                                                                    </div>
    	                                                                </div>
    	                                                            </div>
    	                                                        </div>
    	                                                    </div>';
    	                                                }
                                                    }
	                                            }

	                                    	echo '</div>
	                                    	<a href="#modalRef" class="btn btn-circle btn-success" data-toggle="modal" onclick="btnRef('. $library_ID .')" style="margin: 15px;">Add References</a>
	                                    </div>
	                                    <div class="tab-pane" id="tabVideo_'. $library_ID .'">
	                                    	<div class="mt-actions">';

	                                    		$selectVideo = mysqli_query( $conn,"SELECT * FROM tbl_library_video WHERE is_deleted = 0 AND library_id = $library_ID ORDER BY ID DESC" );
	                                            if ( mysqli_num_rows($selectVideo) > 0 ) {
	                                                while($rowVideo = mysqli_fetch_array($selectVideo)) {
	                                                    $video_ID = $rowVideo["ID"];
	                                                    $video_description = $rowVideo["description"];
	                                                    $video_type = $rowVideo["type"];
	                                                    $video_url = $rowVideo["url"];

	                                                    $video_user_id = $rowVideo["user_id"];
	                                                    $selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $video_user_id " );
	                                                    $rowUser = mysqli_fetch_array($selectUser);
	                                                    $video_name = $rowUser["first_name"] .' '. $rowUser["last_name"];
                                                        if (employerID($video_user_id) == 34 AND $user_id != 34) {
                                                            $video_name = 'Compliance';
                                                        }

	                                                    $video_files = $rowVideo["files"];
	                                                    $fileExtension = fileExtension($video_files);
	                                            		$src = $fileExtension['src'];
	                                            		$embed = $fileExtension['embed'];
	                                            		$type = $fileExtension['type'];
	                                            		$file_extension = $fileExtension['file_extension'];
											            $url = $base_url.'uploads/library/';

	                                                    $video_last_modified = $rowVideo["last_modified"];
	                                                    $video_last_modified = new DateTime($video_last_modified);
	                                                    $video_last_modified = $video_last_modified->format('M d, Y');

                                                        $displayLibrary = false;
                                                        if (mysqli_num_rows($hasLibrary) == 0) {
                                                            if ($rowVideo["free_access"] == 1) {
                                                                $displayLibrary = true;
                                                            }
                                                        } else {
                                                            if ($rowVideo["free_access"] == 0) {
                                                                $displayLibrary = true;
                                                            }
                                                        }

                                                        if ($displayLibrary == true) {
    	                                    				echo '<div class="mt-action mt-action-'. $video_ID .'">
    	                                                        <div class="mt-action-body">
    	                                                            <div class="mt-action-row">
    	                                                                <div class="mt-action-info">
    	                                                                    <div class="mt-action-icon">';

    	                                                                    	if ($video_type == 0) {
    	                                                                    		echo '<a href="'.$src.$url.rawurlencode($video_files).$embed.'" data-src="'.$src.$url.rawurlencode($video_files).$embed.'" data-fancybox data-type="'.$type.'"><i class="fa '. $file_extension .'"></i></a>';
    	                                                                    	} else {
    	                                                                    		echo '<a href="'.$video_url.'" data-src="'.$video_url.'" data-fancybox><i class="fa fa-youtube"></i></a>';
    	                                                                    	}
    	                                                                        
    	                                                                    echo '</div>
    	                                                                    <div class="mt-action-details" style="vertical-align: middle;">
    	                                                                        <p class="mt-action-desc">
    	                                                                        	<span class="font-dark">'. htmlentities($video_description ?? '') .'</span><br>
    	                                                                        	Uploaded by: '. $video_name .'
    	                                                                        </p>
    	                                                                    </div>
    	                                                                </div>
    	                                                                <div class="mt-action-datetime">
    	                                                                    <span class="mt-action-date">'. $video_last_modified .'</span>
    	                                                                </div>
    	                                                                <div class="mt-action-buttons">
    	                                                                    <div class="btn-group btn-group-circle">
    	                                                                    	<a href="#modalVideoEdit" type="button" class="btn btn-outline dark btn-sm" data-toggle="modal" onclick="btnVideoEdit('. $video_ID .')">Edit</a>
    	                                                                    	<a href="javascript:;" type="button" class="btn red btn-sm" onclick="btnVideoDelete('. $video_ID .', '. $library_ID .')">Delete</a>
    	                                                                    </div>
    	                                                                </div>
    	                                                            </div>
    	                                                        </div>
    	                                                    </div>';
    	                                                }
                                                    }
	                                            }

	                                    	echo '</div>
	                                    	<a href="#modalVideo" class="btn btn-circle btn-success" data-toggle="modal" onclick="btnVideo('. $library_ID .')" style="margin: 15px;">Add Video</a>
	                                    </div>';
	                                }
                                    
                                    echo '<div class="tab-pane" id="tabTask_'. $library_ID .'">
                                        <div class="mt-actions">';

                                            // $selectTask = mysqli_query( $conn,"SELECT * FROM tbl_MyProject_Services WHERE is_deleted = 0 AND library_id = $library_ID " );
                                            $selectTask = mysqli_query( $conn,"SELECT
                                                h.History_id AS h_ID,
                                                h.library_id AS h_library_ID,
                                                h.filename AS h_name,
                                                h.Assign_to_History AS h_assign_to_id,
                                                h.files AS h_files,
                                                h.Action_date AS h_date_due,
                                                m.Start_Date AS m_date_start
                                                FROM tbl_MyProject_Services AS m

                                                INNER JOIN (
                                                    SELECT
                                                    *
                                                    FROM tbl_MyProject_Services_History
                                                    WHERE is_deleted = 0
                                                ) AS h
                                                ON m.MyPro_id = h.MyPro_PK

                                                WHERE m.is_deleted = 0 
                                                AND m.library_id = $library_ID" );
                                            if ( mysqli_num_rows($selectTask) > 0 ) {
                                                while($rowTask = mysqli_fetch_array($selectTask)) {
                                                    $task_ID = $rowTask["h_ID"];
                                                    $task_description = $rowTask["h_name"];

                                                    $array_name = array();
                                                    $task_assigned = $rowTask["h_assign_to_id"];
                                                    $user_arr = explode(', ', $task_assigned);
                                                    foreach ($user_arr as $value) {
                                                        $selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE employee_id = $value " );
                                                        if ( mysqli_num_rows($selectUser) > 0 ) {
                                                            $rowUser = mysqli_fetch_array($selectUser);
                                                            $assigned_name = $rowUser["first_name"] .' '. $rowUser["last_name"];
                                                            array_push($array_name, $assigned_name);
                                                        }
                                                    }
                                                    $array_name = implode(", ",$array_name);

                                                    $task_files = $rowTask["h_files"];
                                                    if (!empty($task_files)) {
                                                        $fileExtension = fileExtension($task_files);
                                                        $src = $fileExtension['src'];
                                                        $embed = $fileExtension['embed'];
                                                        $type = $fileExtension['type'];
                                                        $file_extension = $fileExtension['file_extension'];
                                                        $url = $base_url.'uploads/task/';
                                                    }

                                                    $task_start_date = $rowTask["m_date_start"];
                                                    $task_start_date = new DateTime($task_start_date);
                                                    $task_start_date = $task_start_date->format('M d, Y');

                                                    $task_desired_date = $rowTask["h_date_due"];
                                                    $task_desired_date = new DateTime($task_desired_date);
                                                    $task_desired_date = $task_desired_date->format('M d, Y');

                                                    echo '<div class="mt-action mt-action-'. $task_ID .'">
                                                        <div class="mt-action-body">
                                                            <div class="mt-action-row">
                                                                <div class="mt-action-info">
                                                                    <div class="mt-action-icon">';

                                                                        if (!empty($task_files)) {
                                                                            echo '<a href="'.$src.$url.rawurlencode($task_files).$embed.'" data-src="'.$src.$url.rawurlencode($task_files).$embed.'" data-fancybox data-type="'.$type.'"><i class="fa '. $file_extension .'"></i></a>';
                                                                        } else {
                                                                            echo '<i class="fa fa-file-code-o" style="visibility: hidden;"></i>';
                                                                        }
                                                                        
                                                                    echo '</div>
                                                                    <div class="mt-action-details" style="vertical-align: middle;">
                                                                        <p class="mt-action-desc">
                                                                            <span class="font-dark"><b>'. htmlentities($task_description ?? '') .'</b></span><br>
                                                                            Assigned to: '. $array_name .'
                                                                        </p>
                                                                    </div>
                                                                </div>
                                                                <div class="mt-action-datetime">
                                                                    <span class="mt-action-date">'. $task_start_date .'</span>
                                                                    <span class="mt-action-dot bg-green"></span>
                                                                    <span class="mt-action-date">'. $task_desired_date .'</span>
                                                                </div>
                                                                <div class="mt-action-buttons">
                                                                    <div class="btn-group btn-group-circle">
                                                                        <a href="#modalTaskEdit" type="button" class="btn btn-outline dark btn-sm" data-toggle="modal" onclick="btnTaskEdit('. $task_ID .')">Edit</a>
                                                                        <a href="javascript:;" type="button" class="btn red btn-sm" onclick="btnTaskDelete('. $task_ID .', '. $library_ID .')">Delete</a>
                                                                        <a href="'.$base_url.'mypro_task.php?view_id='. $task_ID .'" type="button" class="btn btn-success btn-sm" target="_blank">View</a>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>';
                                                }
                                            }

                                        echo '</div>
                                        <a href="#modalTask" class="btn btn-circle btn-success" data-toggle="modal" onclick="btnTask('. $library_ID .')" style="margin: 15px;">Add Task</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="panel-group accordion" id="parent'. $library_ID .'">';

                            echo (itemChild($library_ID, $library_child));

                        echo '</div>
                    </div>
                </div>
            </div>';
        }

        mysqli_close($conn);
	}
	if( isset($_GET['modalDashboardItem']) ) {
		$id = $_GET['modalDashboardItem'];

        $current_client = 0;
        if (isset($_COOKIE['client'])) { $current_client = $_COOKIE['client']; }

		if (!empty($_COOKIE['switchAccount'])) {
			$portal_user = $_COOKIE['ID'];
			$user_id = $_COOKIE['switchAccount'];
		}
		else {
			$portal_user = $_COOKIE['ID'];
			$user_id = employerID($portal_user);
		}

        $hasLibrary = mysqli_query( $conn,"SELECT * FROM tbl_library WHERE user_id = $user_id" );
        if ( mysqli_num_rows($hasLibrary) == 0 ) {
            $user_id = 163;
        }

        $current_userEmployerID = employerID($portal_user);
		$current_userID = $_COOKIE['ID'];

		// $selectData = mysqli_query( $conn,"SELECT * FROM tbl_library WHERE ID = $id" );
        $selectData = mysqli_query( $conn,"SELECT
            l.ID AS l_ID,
            l.parent_id AS l_parent_id,
            l.child_id AS l_child_id,
            l.type AS l_type,
            l.reason AS l_reason,
            l.name AS l_name,
            l.description AS l_description,
            COUNT(r.r_ID) AS review_total,
            COALESCE(SUM(r.r_compliant), 0) AS review_sum
            FROM tbl_library AS l

            LEFT JOIN (
                SELECT
                ID AS r_ID,
                library_id AS r_library_id,
                compliant AS r_compliant
                FROM tbl_library_review
                WHERE parent_id = 0
                AND is_deleted = 0
            ) AS r
            ON l.ID = r.r_library_id

            WHERE l.deleted = 0
            AND l.ID = $id" );
		if ( mysqli_num_rows($selectData) > 0 ) {
            $row = mysqli_fetch_array($selectData);
            $library_ID = $row["l_ID"];
            $library_name = $row["l_name"];
            $library_child = $row["l_child_id"];
            $reason = $row["l_reason"];

            $review = 0;
            $review_sum = $row["review_sum"];
            $review_total = $row["review_total"];
            if ($review_total > 0 AND $review_sum > 0) {
                $review = round(($review_sum / $review_total) * 100);
            }

            $array_name_id = explode(", ", $library_name);
            if ( count($array_name_id) == 4 ) {
                $data_name = array();

                $selectType = mysqli_query($conn,"SELECT * FROM tbl_library_type WHERE ID = '".$array_name_id[0]."'");
                if ( mysqli_num_rows($selectType) > 0 ) {
                    while($rowType = mysqli_fetch_array($selectType)) {
                        array_push($data_name, $rowType["name"]);
                    }
                }

                $selectCategory = mysqli_query($conn,"SELECT * FROM tbl_library_category WHERE ID = '".$array_name_id[1]."'");
                if ( mysqli_num_rows($selectCategory) > 0 ) {
                    while($rowCategory = mysqli_fetch_array($selectCategory)) {
                        array_push($data_name, $rowCategory["name"]);
                    }
                }

                $selectScope = mysqli_query($conn,"SELECT * FROM tbl_library_scope WHERE ID = '".$array_name_id[2]."'");
                if ( mysqli_num_rows($selectScope) > 0 ) {
                    while($rowScope = mysqli_fetch_array($selectScope)) {
                        array_push($data_name, $rowScope["name"]);
                    }
                }

                $selectModule = mysqli_query($conn,"SELECT * FROM tbl_library_module WHERE ID = '".$array_name_id[3]."'");
                if ( mysqli_num_rows($selectModule) > 0 ) {
                    while($rowModule = mysqli_fetch_array($selectModule)) {
                        array_push($data_name, $rowModule["name"]);
                    }
                }

                $library_name = implode(" - ",$data_name);
            }

            // $rowExpired = filesExpired($library_ID, $library_child, 0);
            // $rowExpired30 = filesExpiredNear($library_ID, $library_child, 0, 0, 30);
            // $rowExpired90 = filesExpiredNear($library_ID, $library_child, 0, 31, 90);

            echo '<div class="panel-body">
                <div class="row">
                    <div class="tabbable-line">
                        <ul class="nav nav-tabs">
                            <li class="active"><a href="#tabDescription_'. $library_ID .'" data-toggle="tab" aria-expanded="true">Description</a></li>
                            <li class=""><a href="#tabFiles_'. $library_ID .'" data-toggle="tab" aria-expanded="true">Files</a></li>
                            <li class="">';

                        		$countComment = 0;
                            	$team = 1;
                            	if (!empty($_COOKIE['switchAccount'])) { $team = 2; }
                        		$resultComment = mysqli_query( $conn,"SELECT * FROM tbl_library_comment WHERE deleted = 0 AND library_id = $library_ID AND team = $team ORDER BY ID DESC " );
                                if ( mysqli_num_rows($resultComment) > 0 ) {
                                    while($rowComment = mysqli_fetch_array($resultComment)) {
                                    	if (!empty($rowComment["seen"])) {
                                            $comment_seen_arr = explode(", ", $rowComment["seen"]);
                                            if (!in_array($current_userID, $comment_seen_arr)) {
                                            	$countComment++;
                                            }
                                    	} else {
                                           	$countComment++;
                                    	}
                                    }
                                }

                            	echo '<a href="#tabComments_'. $library_ID .'" data-toggle="tab" aria-expanded="false" onclick="countComment('.$library_ID.', '.$countComment.')">
                            		Comments';

                                    if ($countComment > 0) {
                                    	echo ' <span class="badge badge-danger">'.$countComment.'</span>';
                                    }
                            		
                            	echo '</a>
                            </li>
                            <li class=""><a href="#tabHistory_'. $library_ID .'" data-toggle="tab" aria-expanded="false">History</a></li>
                            <li class=""><a href="#tabCompliance_'. $library_ID .'" data-toggle="tab" aria-expanded="false">Compliance</a></li>
                            <li class=""><a href="#tabReview_'. $library_ID .'" data-toggle="tab" aria-expanded="false">Annual Review</a></li>
                            <li class=""><a href="#tabTemplate_'. $library_ID .'" data-toggle="tab" aria-expanded="false">Templates</a></li>';

		                    if ($current_client == 0) {
	                            echo '<li class=""><a href="#tabReferences_'. $library_ID .'" data-toggle="tab" aria-expanded="false">References</a></li>
	                            <li class=""><a href="#tabVideo_'. $library_ID .'" data-toggle="tab" aria-expanded="false">Video</a></li>';
	                        }
                            
                            echo '<li class=""><a href="#tabTask_'. $library_ID .'" data-toggle="tab" aria-expanded="false">Task</a></li>
                        </ul>
                        <div class="tab-content">
                            <div class="tab-pane active" id="tabDescription_'. $library_ID .'">
                                <h5 style="padding: 0 15px;">'. htmlentities($row["l_description"] ?? '') .'</h5>
                            </div>
                            <div class="tab-pane" id="tabFiles_'. $library_ID .'">
                                <div class="mt-actions">';

                                    $sql_file = '';
                                    if (mysqli_num_rows($hasLibrary) == 0) {
                                        $sql_file = ' AND user_id = '.$portal_user;
                                    }
                                    $resultFiles = mysqli_query( $conn,"SELECT * FROM tbl_library_file WHERE deleted = 0 AND library_id = $library_ID $sql_file ORDER BY ID DESC" );
                                    if ( mysqli_num_rows($resultFiles) > 0 ) {
                                        while($rowFiles = mysqli_fetch_array($resultFiles)) {
                                            $file_ID = $rowFiles["ID"];
                                            $file_name = $rowFiles["name"];
                                            $file_comment = $rowFiles["comment"];
                                            $file_reason = $rowFiles["reason"];

                                            $file_user_id = $rowFiles["user_id"];
                                            $selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $file_user_id " );
                                            $rowUser = mysqli_fetch_array($selectUser);
                                            $file_user = $rowUser["first_name"] .' '. $rowUser["last_name"];
                                            if (employerID($file_user_id) == 34 AND $user_id != 34) {
                                                $file_user = 'Compliance';
                                            }

                                            $files = '';
                                            $type = 'iframe';
                                            $file_extension = 'fa-youtube-play';
                                            if (!empty($rowFiles["files"])) {
                                                $arr_filename = explode(' | ', $rowFiles["files"]);
                                                $arr_filetype = explode(' | ', $rowFiles["filetype"]);
                                                $str_filename = '';

                                                foreach($arr_filename as $val_filename) {
                                                    $str_filename = $val_filename;
                                                }
                                                foreach($arr_filetype as $val_filetype) {
                                                    $str_filetype = $val_filetype;
                                                }

                                                $files = $str_filename;
                                                if ($str_filetype == 1) {
                                                    $fileExtension = fileExtension($str_filename);
                                                    $src = $fileExtension['src'];
                                                    $embed = $fileExtension['embed'];
                                                    $type = $fileExtension['type'];
                                                    $file_extension = $fileExtension['file_extension'];
                                                    $url = $base_url.'uploads/library/';

                                                    $files = $src.$url.rawurlencode($str_filename).$embed;
                                                } else if ($str_filetype == 3) {
                                                    $files = preg_replace('#[^/]*$#', '', $str_filename).'preview';
                                                    $file_extension = 'fa-google';
                                                }
                                            }

                                            $file_due_date = $rowFiles["due_date"];
                                            $file_due = $file_due_date;
                                            if ($file_due_date != "0000-00-00") {
                                                $file_due = new DateTime(substr($file_due_date, 0, 10));
                                                $file_due = $file_due->format('M d, Y');
                                            }

                                            echo '<div class="mt-action mt-action-'. $file_ID .'">
                                                <div class="mt-action-body">
                                                    <div class="mt-action-row">
                                                        <div class="mt-action-info">
                                                            <div class="mt-action-icon">
                                                                <a href="'.$files.'" data-src="'.$files.'" data-fancybox data-type="'.$type.'"><i class="fa fa-fw '. $file_extension .'"></i></a>
                                                            </div>
                                                            <div class="mt-action-details" style="vertical-align: middle;">
                                                                <span class="mt-action-author">'. htmlentities($file_name ?? '');

																	if (!empty($file_reason)) {
																		echo '<i class="fa fa-warning font-red itemWarning" style="margin-left: 5px;"></i>';

																		if ($current_userEmployerID == $user_id) {
																			echo '<span class="remark_action itemWarning" style="margin-left: 10px;">
																				<i type="button" class="btn btn-sm font-dark" onclick="btnDeleteAction(1, 2, '.$file_ID.')">Accept</i> |
																				<i type="button" class="btn btn-sm font-dark" onclick="btnDeleteAction(0, 2, '.$file_ID.')">Reject</i>
																			</span>';
																		}
																	}

                                                                echo '</span>
                                                                <p class="mt-action-desc">
                                                                	<span class="font-dark">'. htmlentities($file_comment ?? '') .'</span><br>
                                                                	Uploaded by: '. $file_user .'
                                                                </p>
                                                            </div>
                                                        </div>
                                                        <div class="mt-action-datetime">
                                                            <span class="mt-action-date">'. $file_due .'</span>
                                                        </div>
                                                        <div class="mt-action-buttons">
                                                            <div class="btn-group btn-group-circle">
                                                            	<a href="#modalAttachedEdit" type="button" class="btn btn-outline dark btn-sm" data-toggle="modal" onclick="btnAttachedEdit('. $file_ID .')">Edit</a>
                                                            	<a href="javascript:;" type="button" class="btn red btn-sm" onclick="btnDeleteFile('. $file_ID .')">Delete</a>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>';
                                        }
                                    }
                                echo '</div>
                                <a href="#modalAttached" class="btn btn-circle btn-success btnAttached" data-id="'. $library_ID .'" data-toggle="modal" onclick="btnAttached('. $library_ID .')" style="margin: 15px;">Attach File</a>
                            </div>
	                        <div class="tab-pane" id="tabComments_'. $library_ID .'">
                            	<div class="mt-actions">';

                                    $sql_comment = '';
                                    if (mysqli_num_rows($hasLibrary) == 0) {
                                        $sql_comment = ' AND user_id = '.$portal_user;
                                    }
                            		$resultComment = mysqli_query( $conn,"SELECT * FROM tbl_library_comment WHERE deleted = 0 AND library_id = $library_ID $sql_comment ORDER BY ID DESC" );
                                    if ( mysqli_num_rows($resultComment) > 0 ) {
                                        while($rowComment = mysqli_fetch_array($resultComment)) {
                                        	$comment_ID = $rowComment["ID"];
                                        	$comment_title = $rowComment["title"];
                                        	$comment_comment = $rowComment["comment"];

                                        	$comment_last_modified = $rowComment["last_modified"];
                                            $comment_last_modified = new DateTime($comment_last_modified);
                                            $comment_last_modified = $comment_last_modified->format('d M Y \a\t g:ia');

                                        	$comment_user_id = $rowComment["user_id"];
                                            $resultUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $comment_user_id" );
                                            $rowUser = mysqli_fetch_array($resultUser);
                                        	$comment_name = $rowUser["first_name"] .' '. $rowUser["last_name"];
                                            if (employerID($comment_user_id) == 34 AND $user_id != 34) {
                                                $comment_name = 'Compliance';
                                            }

                                        	$comment_avatar = "https://via.placeholder.com/200x150/EFEFEF/AAAAAA.png?text=no+image";
                                        	$resultUserInfo = mysqli_query( $conn,"SELECT * FROM tbl_user_info WHERE user_id = $comment_user_id" );
                                        	if ( mysqli_num_rows($resultUserInfo) > 0 ) {
                                        		$rowUserInfo = mysqli_fetch_array($resultUserInfo);
                                        		if ( !empty($rowUserInfo["avatar"]) ) {
                                                    $comment_avatar = $base_url.'uploads/avatar/'. $rowUserInfo["avatar"];
                                                }
                                        	}

                                    		echo '<div class="mt-action mt-action-'.$comment_ID.'">
                                                <div class="mt-action-body" style="padding-right: 15px;">
                                                    <div class="mt-action-row">
                                                        <div class="mt-action-info">
                                                            <div class="mt-action-icon">
                                                            	<img class="img-circle" src="'. $comment_avatar .'" alt="'.$comment_name.'" style="width: 40px; height: 40px; object-fit: contain;"/>
                                                            </div>
                                                            <div class="mt-action-details" style="vertical-align: middle;">
                                                                <p class="mt-action-desc">
                                                                	<span class="font-dark"><b>'.htmlentities($comment_title ?? '').'</b> '.htmlentities($comment_comment ?? '').'</span><br>
                                                                	Commented by: '.$comment_name.'
                                                                </p>
                                                            </div>
                                                        </div>
                                                        <div class="mt-action-datetime">
                                                            <span class="mt-action-date">'. $comment_last_modified .'</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>';
                                        }
                                    }

                            	echo '</div>
                                <a href="#modalComment" class="btn btn-circle btn-success btnComment" data-id="'. $library_ID .'" data-toggle="modal" onclick="btnComment('. $library_ID .')" style="margin: 15px;">Add Comment</a>
                            </div>
                            <div class="tab-pane" id="tabHistory_'. $library_ID .'">
                                <ul class="todo-task-history">';

                                    $resultHistory = mysqli_query( $conn,"SELECT * FROM tbl_library_history WHERE library_id = $library_ID ORDER BY ID DESC" );
                                   	if ( mysqli_num_rows($resultHistory) > 0 ) {
                                   		while($rowHistory = mysqli_fetch_array($resultHistory)) {
                                            $history_id = $rowHistory["ID"];

                                            $history_user_action = $rowHistory["user_action"];
                                            $selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $history_user_action" );
                                            $rowUser = mysqli_fetch_array($selectUser);
                                            $history_user_name = $rowUser["first_name"] .' '. $rowUser["last_name"];
                                            if (employerID($history_user_action) == 34 AND $user_id != 34) {
                                                $history_user_name = 'Compliance';
                                            }

                                            $history_last_modified = $rowHistory["last_modified"];
                                            $history_last_modified = new DateTime($history_last_modified);
                                            $history_last_modified = $history_last_modified->format('M d, Y \a\t g:ia');

                                            $history_action_id = $rowHistory["action_id"];
                                        	$history_action = array(
                                                1 => 'Added',
                                                2 => 'Updated',
                                                3 => 'Deleted',
                                                4 => 'Accepted',
                                                5 => 'Rejected'
                                            );

                                            $history_tab_id = $rowHistory["tab_id"];
                                        	$history_tab = array(
                                                0 => 'tbl_library',
                                                1 => 'tbl_library_file',
                                                2 => 'tbl_library_comment',
                                                3 => 'tbl_library_compliance',
                                                4 => 'tbl_library_review',
                                                5 => 'tbl_library_template',
                                                6 => 'tbl_library_references',
                                                7 => 'tbl_library_video'
                                            );
                                            $history_tab_tbl = $history_tab[$history_tab_id];

                                            $history_data_id = $rowHistory["data_id"];
                                            $rowData_text = "";
                                            $rowData_tab = "";
                                            $selectData = mysqli_query( $conn,"SELECT * FROM $history_tab_tbl WHERE ID = $history_data_id" );
                                            if ( mysqli_num_rows($selectData) > 0 ) {
                                            	$rowData = mysqli_fetch_array($selectData);

                                            	if ($history_tab_id == 0) {
                                            		$rowData_tab = 'dashboard';
                                            		$rowData_parent_id = $rowData["parent_id"];

                                            		$rowData_type_id = $rowData["type"];
                                                	$rowData_type = array(
                                                        0 => 'Dashboard',
                                                        1 => 'Program',
                                                        2 => 'Policy',
                                                        3 => 'Procedure',
                                                        4 => 'Training',
                                                        5 => 'Form',
                                                    );

                                            		$rowData_name = $rowData["name"];
													$rowData_name_arr = explode(", ", $rowData_name);
													if ( count($rowData_name_arr) == 4 ) {
													    $data_name = array();

													    $selectType = mysqli_query($conn,"SELECT * FROM tbl_library_type WHERE ID = '".$rowData_name_arr[0]."'");
													    if ( mysqli_num_rows($selectType) > 0 ) {
													        while($rowType = mysqli_fetch_array($selectType)) {
													            array_push($data_name, $rowType["name"]);
													        }
													    }

													    $selectCategory = mysqli_query($conn,"SELECT * FROM tbl_library_category WHERE ID = '".$rowData_name_arr[1]."'");
													    if ( mysqli_num_rows($selectCategory) > 0 ) {
													        while($rowCategory = mysqli_fetch_array($selectCategory)) {
													            array_push($data_name, $rowCategory["name"]);
													        }
													    }

													    $selectScope = mysqli_query($conn,"SELECT * FROM tbl_library_scope WHERE ID = '".$rowData_name_arr[2]."'");
													    if ( mysqli_num_rows($selectScope) > 0 ) {
													        while($rowScope = mysqli_fetch_array($selectScope)) {
													            array_push($data_name, $rowScope["name"]);
													        }
													    }

													    $selectModule = mysqli_query($conn,"SELECT * FROM tbl_library_module WHERE ID = '".$rowData_name_arr[3]."'");
													    if ( mysqli_num_rows($selectModule) > 0 ) {
													        while($rowModule = mysqli_fetch_array($selectModule)) {
													            array_push($data_name, $rowModule["name"]);
													        }
													    }

													    $rowData_name = implode(" - ",$data_name);
													}
													$rowData_text = 'a '.$rowData_type[$rowData_type_id].' '. $rowData_name;
                                            	} else if ($history_tab_id == 1) {
                                            		$rowData_tab = 'file';
                                            		$rowData_text = 'a '. $rowData["name"];
                                            	} else if ($history_tab_id == 2) {
                                            		$rowData_tab = 'comment';
                                            		$rowData_text = 'a comment about '. $rowData["title"];
                                            	} else if ($history_tab_id == 3) {
                                            		$rowData_tab = 'compliance';
                                            		$rowData_parent_id = $rowData["parent_id"];
                                            		$rowData_action_items = $rowData["action_items"];

                                            		$rowData_type_id = $rowData["type"];
                                                	$rowData_type = array(
                                                        0 => 'Observed',
                                                        1 => 'Performed',
                                                        2 => 'Verified',
                                                        3 => 'Reviewed',
                                                    );

                                                    if ($rowData_type_id > 0) {
                                                    	$selectCompliance = mysqli_query( $conn,"SELECT * FROM tbl_library_compliance WHERE ID = $rowData_parent_id" );
                                                    	$rowComplinace = mysqli_fetch_array($selectCompliance);
                                            			$rowData_action_items = $rowComplinace["action_items"];
                                                    }

                                            		$rowData_text = 'a '.$rowData_type[$rowData_type_id].' action for '. $rowData_action_items;
                                            	} else if ($history_tab_id == 4) {
                                            		$rowData_tab = 'annual review';

                                            		$rowData_type_id = $rowData["type"];
                                                	$rowData_type = array(
                                                        0 => 'Observation',
                                                        1 => 'Correction',
                                                        2 => 'Verification',
                                                        3 => 'Approval',
                                                        4 => 'Reviewed'
                                                    );

                                            		$rowData_text = 'a '.$rowData_type[$rowData_type_id].' action for '. $rowData["title"];
                                            	} else if ($history_tab_id == 5) {
                                            		$rowData_tab = 'template';
                                            		$rowData_text = 'a file '. $rowData["files"];
                                            	} else if ($history_tab_id == 6) {
                                            		$rowData_tab = 'reference';
                                            		$rowData_text = 'a file '. $rowData["files"];
                                            	}
                                            }

                                            echo '<li>
                                                <div class="todo-task-history-date-cd"><b>'.$history_user_name.'</b> | <i>'.$history_last_modified.'</i></div>
                                                <div class="todo-task-history-desc-cd">'.$history_action[$history_action_id].' '.htmlentities($rowData_text).' in the '.$rowData_tab.' tab.</div>
                                            </li>';
                                        }
                                   	}

                                echo '</ul>
                            </div>
                            <div class="tab-pane" id="tabCompliance_'. $library_ID .'" style="padding: 0 15px;">
                                <div class="table-scrollable">
                                    <table class="table table-bordered table-hover">
                                        <thead>
                                            <tr>
                                                <th class="text-center" style="width: 130px;">Completed</th>
                                                <th>Requirements</th>
                                                <th>Action Items</th>
                                                <th style="width: 300px;">Frequency</th>
                                                <th class="text-center" style="width: 130px;">Uploaded Files</th>
                                                <th style="width: 175px;"></th>
                                            </tr>
                                        </thead>
                                        <tbody>';

                                            $sql_compliant = '';
                                            if (mysqli_num_rows($hasLibrary) == 0) {
                                                $sql_compliant = ' AND user_id = '.$portal_user;
                                            }
                                            $compliant = 0;
                                            $resultCompliance = mysqli_query( $conn,"SELECT * FROM tbl_library_compliance WHERE parent_id = 0 AND deleted = 0 AND library_id = $library_ID $sql_compliant" );
                                            if ( mysqli_num_rows($resultCompliance) > 0 ) {
                                                $compliant_count = 0;
                                                $compliant_completed = 0;
                                                while($rowComplinace = mysqli_fetch_array($resultCompliance)) {
                                                    $compliance_ID = $rowComplinace["ID"];
                                                	$compliance_child_id = $rowComplinace["child_id"];

                                                    $compliance_user_id = $rowComplinace["user_id"];
                                                    $selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $compliance_user_id " );
                                                    $rowUser = mysqli_fetch_array($selectUser);
                                                    $compliance_user = $rowUser["first_name"] .' '. $rowUser["last_name"];
                                                    if (employerID($compliance_user_id) == 34 AND $user_id != 34) {
                                                        $compliance_user = 'Compliance';
                                                    }

                                                    $compliance_compliant = $rowComplinace['compliant'];
                                                    $compliant_count++;
                                                    if ($compliance_compliant == 1) {
                                                        $compliant_completed++;
                                                    }

                                                    $compliance_frequency = $rowComplinace['frequency'];
                                                    $compliance_schedule_id = $rowComplinace['schedule'];
                                                    $array_schedule_id = explode(", ", $compliance_schedule_id);
                                                    $days = array(
                                                        1 => 'Monday',
                                                        2 => 'Tuesday',
                                                        3 => 'Wednesday',
                                                        4 => 'Thursday',
                                                        5 => 'Friday',
                                                        6 => 'Saturday',
                                                        7 => 'Sunday'
                                                    );
                                                    $frequency = $compliance_frequency;
                                                    if ( count($array_schedule_id) == 4 ) {
									                    $time = $array_schedule_id[0];
									                    $time_f = date_create($time);
                                                        $day_ms = $array_schedule_id[1];
                                                        $day_num = $array_schedule_id[2];
                                                        $month = $array_schedule_id[3];

                                                        if ($compliance_frequency == 1) {             // Daily
                                                            // $sec = 1000;
                                                            // $min = 60 * $sec;   // 60,000
                                                            // $hr = 60 * $min;    // 3,600,000
                                                            // $day = 24 * $hr;    // 86,4000,000

                                                            // $due_hr = date_format($time,"G") * $hr;
                                                            // $due_min = date_format($time,"i") * $min;
                                                            // $due_before = 2 * $hr;
                                                            // $due = ($due_hr + $due_min) - $due_before;

                                                            // $cur_time = date("G:i:s");
                                                            // $cur_hr = 1 * $hr;
                                                            // $cur_min = 1 * $min;
                                                            // $cur = ($cur_hr + $cur_min) - $due;

                                                            // $frequency = 'Every '. date_format($time,"g:i A") .' daily '. $due_hr .' : '. $due_min .' - '. $due_before .' = '. $due .' | '. $cur_time .' : '. $cur_hr .' - '. $cur_min .' = '. $cur;
                                                            
                                                            $frequency = 'Daily';
                                                        	if (!empty($time)) {
                                                        		$frequency = 'Every '. date_format($time_f,"g:i A") .' daily';
                                                        	}
                                                        } else if ($compliance_frequency == 2) {      // Weekly

                                                        	$frequency = 'Weekly';
                                                        	if (!empty($day_ms) AND !empty($time)) {
                                                        		$frequency = 'Every '. $days[$day_ms] .' at '. date_format($time_f,"g:i A");
                                                        	}
                                                        } else if ($compliance_frequency == 3) {      // Monthly

                                                        	$frequency = 'Monthly';
                                                        	if (!empty($day_num) AND !empty($time)) {
                                                        		$frequency = 'Every '. $day_num.date("S", mktime(0, 0, 0, 0, intval($day_num), 0)) .' day of the Month at '. date_format($time_f,"g:i A");
                                                        	}
                                                        } else if ($compliance_frequency == 4) {      // Yearly

                                                        	$frequency = 'Yearly';
                                                        	if (!empty($day_num) AND !empty($time) AND !empty($month)) {
                                                        		$frequency = 'Every '. $day_num.date("S", mktime(0, 0, 0, 0, intval($day_num), 0)) .' day of '. date("F", mktime(0, 0, 0, intval($month)+1, 0, 0)) .' at '. date_format($time_f,"g:i A");
                                                        	}
                                                        }
                                                    }

                                                    $filetype = $rowComplinace['filetype'];
                                                    $files = $rowComplinace["files"];
                                                    $type = 'iframe';
                                                    $file_extension = 'fa-youtube-play';
                                                    if (!empty($files)) {
                                                        if ($filetype == 1) {
                                                            $fileExtension = fileExtension($files);
                                                            $src = $fileExtension['src'];
                                                            $embed = $fileExtension['embed'];
                                                            $type = $fileExtension['type'];
                                                            $file_extension = $fileExtension['file_extension'];
                                                            $url = $base_url.'uploads/library/';

                                                            $files = $src.$url.rawurlencode($files).$embed;
                                                        } else if ($filetype == 3) {
                                                            $files = preg_replace('#[^/]*$#', '', $files).'preview';
                                                            $file_extension = 'fa-google';
                                                        }
                                                        $files = '<a href="'.$files.'" data-src="'.$files.'" data-fancybox data-type="'.$type.'">View</a>';
                                                    }

                                                    echo '<tr id="tr_'. $compliance_ID .'">
                                                        <td class="text-center"><input type="checkbox" class="make-switch" name="status" data-on-text="Yes" data-off-text="No" data-on-color="success" onchange="changedStatus(this, '.$compliance_ID.', '. $library_ID .')" data-off-color="danger" '; echo $compliance_compliant === "1" ? "checked" : "";  echo ' readonly /></td>
                                                        <td>'. htmlentities($rowComplinace["requirements"] ?? '') .'</td>
                                                        <td>'. htmlentities($rowComplinace["action_items"] ?? '') .'</td>
                                                        <td>'. $frequency .'</td>
                                                        <td class="text-center">'.$files.'</td>
                                                        <td>
                                                            <div class="btn-group btn-group-circle">
                                                                <a href="#modalComplianceEdit" type="button" class="btn btn-outline dark btn-sm" data-toggle="modal" onclick="btnComplianceEdit('. $compliance_ID .')">Edit</a>
                                                                <a href="javascript:;" type="button" class="btn red btn-sm" onclick="btnComplianceDelete('. $compliance_ID .')">Delete</a>';

												                if ($compliance_compliant == 0) {
												                	echo '<a href="#modalComplianceMore" type="button" class="btn blue btn-sm" data-toggle="modal" onclick="btnComplianceMore('.$compliance_ID.')">Action</a>';
												                }

                                                            echo '</div>
                                                        </td>
                                                    </tr>';

                                                    if (!empty($compliance_child_id)) {
                                                    	$array_child_id = explode(", ", $compliance_child_id);
										                foreach ($array_child_id as $value) {
		                                                    $resultComplianceItem = mysqli_query( $conn,"SELECT * FROM tbl_library_compliance WHERE deleted = 0 AND ID = $value " );
		                                                    if ( mysqli_num_rows($resultComplianceItem) > 0 ) {
		                                                        while($rowComplinaceItem = mysqli_fetch_array($resultComplianceItem)) {
		                                                            $compliance_ID = $rowComplinaceItem["ID"];
		                                                        	$compliance_parent_id = $rowComplinaceItem["parent_id"];
		                                                        	$compliance_comment = $rowComplinaceItem["comment"];
		                                                        	$compliance_remark = $rowComplinaceItem["remark"];

		                                                            $compliance_user_id = $rowComplinaceItem["user_id"];
				                                                    $selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $compliance_user_id " );
				                                                    $rowUser = mysqli_fetch_array($selectUser);
				                                                    $compliance_user = $rowUser["first_name"] .' '. $rowUser["last_name"];
                                                                    if (employerID($compliance_user_id) == 34 AND $user_id != 34) {
                                                                        $compliance_user = 'Compliance';
                                                                    }

                                                                    $filetype = $rowComplinaceItem['filetype'];
                                                                    $files = $rowComplinaceItem["files"];
                                                                    $type = 'iframe';
                                                                    $file_extension = 'fa-youtube-play';
                                                                    if (!empty($files)) {
                                                                        if ($filetype == 1) {
                                                                            $fileExtension = fileExtension($files);
                                                                            $src = $fileExtension['src'];
                                                                            $embed = $fileExtension['embed'];
                                                                            $type = $fileExtension['type'];
                                                                            $file_extension = $fileExtension['file_extension'];
                                                                            $url = $base_url.'uploads/library/';

                                                                            $files = $src.$url.rawurlencode($files).$embed;
                                                                        } else if ($filetype == 3) {
                                                                            $files = preg_replace('#[^/]*$#', '', $files).'preview';
                                                                            $file_extension = 'fa-google';
                                                                        }
                                                                        $files = '<a href="'.$files.'" data-src="'.$files.'" data-fancybox data-type="'.$type.'">View</a>';
                                                                    }

		                                                        	$compliance_type = $rowComplinaceItem["type"];
		                                                        	$ctype = array(
		                                                                0 => 'Observed',
		                                                                1 => 'Performed',
		                                                                2 => 'Verified',
		                                                                3 => 'Reviewed'
		                                                            );

		                                                        	$compliance_last_modified = $rowComplinaceItem["last_modified"];
				                                                    $compliance_last_modified = new DateTime($compliance_last_modified);
				                                                    $compliance_last_modified = $compliance_last_modified->format('M d, Y');

		                                                            echo '<tr id="tr_'. $compliance_ID .'" class="child_'.$compliance_parent_id.'">
		                                                                <td style="border: 0;"></td>
		                                                                <td colspan="2">
																			<strong>'.$compliance_user.'</strong> <i>('.$ctype[$compliance_type].')</i><br>';

																			if (!empty($compliance_comment)) { echo '<span class="text-muted">'.htmlentities($compliance_comment ?? '').'</span><br>'; }
																			
																			echo '<div class="remark_action">';
																				if (!empty($compliance_remark)) {
																					if ($compliance_remark == "1") { echo '<span class="text-success">Accepted</span>'; }
																					else { echo '<span class="text-danger">'.$compliance_remark.'</span>'; }
																				} else {
																					echo '<a href="javascript:;" type="button" class="btn btn-sm btn-link" onclick="btnComplianceAccept('. $compliance_ID .')">Accept</a> |
			                                                                		<a href="javascript:;" type="button" class="btn btn-sm btn-link" onclick="btnComplianceReject('. $compliance_ID .')">Reject</a>';
																				}
																			echo '</div>';
																			
																		echo '</td>
		                                                                <td>Date: <b>'. $compliance_last_modified .'</b></td>
		                                                                <td class="text-center">'.$files.'</td>
		                                                                <td>
		                                                                    <div class="btn-group btn-group-circle">
		                                                                        <a href="#modalComplianceMoreEdit" type="button" class="btn btn-outline dark btn-sm" data-toggle="modal" onclick="btnComplianceMoreEdit('. $compliance_ID .')">Edit</a>
		                                                                        <a href="javascript:;" type="button" class="btn red btn-sm" onclick="btnComplianceDelete('. $compliance_ID .')">Delete</a>
		                                                                    </div>
		                                                                </td>
		                                                            </tr>';
		                                                        }
		                                                    }
		                                                }
		                                            }
                                                }

                                                if ($compliant_count == $compliant_completed) { $compliant = 100; }
                                            }
                                            
                                        echo '</tbody>
                                        <tfoot>
                                            <tr>
                                                <th class="text-center">'. $compliant .'%</th>
                                                <th colspan="5">Compliant</th>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                                <a href="#modalCompliance" class="btn btn-circle btn-success btnCompliance" data-toggle="modal" onclick="btnCompliance('. $library_ID .')" style="margin: 15px 0;">Add Compliance</a>
                            </div>
                            <div class="tab-pane" id="tabReview_'. $library_ID .'" style="padding: 0 15px;">
                            	<div class="table-scrollable">
                                    <table class="table table-bordered table-hover">
                                        <thead>
                                            <tr>
                                                <th style="width: 130px;" class="text-center">Compliant</th>
                                                <th>Requirements</th>
                                                <th>Action Items</th>
                                                <th style="width: 130px;" class="text-center">File</th>
                                                <th style="width: 180px;"></th>
                                            </tr>
                                        </thead>
                                        <tbody>';

                                            $sql_review = '';
                                            if (mysqli_num_rows($hasLibrary) == 0) {
                                                $sql_review = ' AND user_id = '.$portal_user;
                                            }
											$resultReview= mysqli_query( $conn,"SELECT * FROM tbl_library_review WHERE parent_id = 0 AND is_deleted = 0 AND library_id = $library_ID $sql_review" );
                                            if ( mysqli_num_rows($resultReview) > 0 ) {
                                                while($rowReview = mysqli_fetch_array($resultReview)) {
                                                	$review_ID = $rowReview["ID"];
                                                	$review_compliant = $rowReview["compliant"];
                                                    $review_title = htmlentities($rowReview["title"] ?? '');
                                                	$review_child_id = $rowReview["child_id"];
                                                	$review_action_items = $rowReview["action_items"];
                                                	$review_requirements = $rowReview["requirements"];

                                                    $review_user_id = $rowReview["user_id"];
                                                    $selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $review_user_id " );
                                                    $rowUser = mysqli_fetch_array($selectUser);
                                                    $review_name = $rowUser["first_name"] .' '. $rowUser["last_name"];
                                                    if (employerID($review_user_id) == 34 AND $user_id != 34) {
                                                        $review_name = 'Compliance';
                                                    }

													$review_template = $rowReview["template"];
													if ($review_template == 1) {
														$review_comment = "No Changes Noted During Review";
													} else {
														$review_comment = $rowReview["comment"];
													}

                                                	$review_type = $rowReview["type"];
                                                	$rtype = array(
                                                        0 => 'Observed',
                                                        1 => 'Corrected',
                                                        2 => 'Verified',
                                                        3 => 'Approved',
                                                        4 => 'Reviewed'
                                                    );

                                                	$review_last_modified = $rowReview["last_modified"];
                                                    $review_last_modified = new DateTime($review_last_modified);
                                                    $review_last_modified = $review_last_modified->format('M d, Y');

                                                    $files = '';
                                                    $type = 'iframe';
                                                    $file_extension = 'fa-youtube-play';
                                                    if (!empty($rowReview["files"])) {
                                                        $arr_filename = explode(' | ', $rowReview["files"]);
                                                        $arr_filetype = explode(' | ', $rowReview["filetype"]);
                                                        $str_filename = '';

                                                        foreach($arr_filename as $val_filename) {
                                                            $str_filename = $val_filename;
                                                        }
                                                        foreach($arr_filetype as $val_filetype) {
                                                            $str_filetype = $val_filetype;
                                                        }

                                                        $files = $str_filename;
                                                        if ($str_filetype == 1) {
                                                            $fileExtension = fileExtension($str_filename);
                                                            $src = $fileExtension['src'];
                                                            $embed = $fileExtension['embed'];
                                                            $type = $fileExtension['type'];
                                                            $file_extension = $fileExtension['file_extension'];
                                                            $url = $base_url.'uploads/library/';

                                                            $files = $src.$url.rawurlencode($str_filename).$embed;
                                                        } else if ($str_filetype == 3) {
                                                            $files = preg_replace('#[^/]*$#', '', $str_filename).'preview';
                                                            $file_extension = 'fa-google';
                                                        }
                                                        $files = '<a href="'.$files.'" data-src="'.$files.'" data-fancybox data-type="'.$type.'">View</a>';
                                                    }

                                                    echo '<tr id="tr_'.$review_ID.'">
														<td class="text-center"><input type="checkbox" class="make-switch" name="status" data-on-text="Yes" data-off-text="No" data-on-color="success" onchange="changedStatus(this, 1, 1)" data-off-color="danger" '; echo $review_compliant == 1 ? 'checked':''; echo ' readonly /></td>
														<td>'.htmlentities($review_requirements ?? '').'</td>
														<td>'.htmlentities($review_action_items ?? '').'</td>
														<td class="text-center">'.$files.'</td>
														<td>
												            <div class="btn-group btn-group-circle">
												                <a href="#modalReviewEdit" type="button" class="btn btn-outline dark btn-sm" data-toggle="modal" onclick="btnReviewEdit('.$review_ID.')">Edit</a>
												                <a href="javascript:;" type="button" class="btn red btn-sm" onclick="btnReviewDelete('.$review_ID.', '.$library_ID.')">Delete</a>';

												                if ($review_compliant == 0) {
												                	echo '<a href="#modalReviewAction" type="button" class="btn blue btn-sm" data-toggle="modal" onclick="btnReviewAction('.$review_ID.')">Review</a>';
												                }

												            echo '</div>
												        </td>
													</tr>';

                                                    if (!empty($review_child_id)) {
                                                    	$array_child_id = explode(", ", $review_child_id);
										                foreach ($array_child_id as $value) {
										                    $selectReviewItem = mysqli_query( $conn,"SELECT * FROM tbl_library_review WHERE is_deleted = 0 AND ID=$value" );
										                    if ( mysqli_num_rows($selectReviewItem) > 0 ) {
										                    	while($rowReviewItem = mysqli_fetch_array($selectReviewItem)) {
		                                                        	$review_ID = $rowReviewItem["ID"];
		                                                        	$review_compliant = $rowReviewItem["compliant"];
		                                                        	$review_title = $rowReviewItem["title"];
		                                                        	$review_parent_id = $rowReviewItem["parent_id"];
		                                                        	$review_child_id = $rowReviewItem["child_id"];

				                                                    $review_user_id = $rowReviewItem["user_id"];
				                                                    $selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $review_user_id " );
				                                                    $rowUser = mysqli_fetch_array($selectUser);
				                                                    $review_name = $rowUser["first_name"] .' '. $rowUser["last_name"];
                                                                    if (employerID($review_user_id) == 34 AND $user_id != 34) {
                                                                        $review_name = 'Compliance';
                                                                    }

																	$review_template = $rowReviewItem["template"];
																	if ($review_template == 1) {
																		$review_comment = "No Changes Noted During Review";
																	} else {
																		$review_comment = $rowReviewItem["comment"];
																	}
		                                            				$review_remark = $rowReviewItem["remark"];

		                                                        	$review_type = $rowReviewItem["type"];
		                                                        	$rtype = array(
		                                                                0 => 'Observed',
		                                                                1 => 'Corrected',
		                                                                2 => 'Verified',
		                                                                3 => 'Approved',
		                                                                4 => 'Reviewed'
		                                                            );

		                                                        	$review_last_modified = $rowReviewItem["last_modified"];
				                                                    $review_last_modified = new DateTime($review_last_modified);
				                                                    $review_last_modified = $review_last_modified->format('M d, Y');

                                                                    $files = '';
                                                                    $type = 'iframe';
                                                                    $file_extension = 'fa-youtube-play';
                                                                    if (!empty($rowReferences["files"])) {
                                                                        $arr_filename = explode(' | ', $rowReviewItem["files"]);
                                                                        $arr_filetype = explode(' | ', $rowReviewItem["filetype"]);
                                                                        $str_filename = '';

                                                                        foreach($arr_filename as $val_filename) {
                                                                            $str_filename = $val_filename;
                                                                        }
                                                                        foreach($arr_filetype as $val_filetype) {
                                                                            $str_filetype = $val_filetype;
                                                                        }

                                                                        $files = $str_filename;
                                                                        if ($str_filetype == 1) {
                                                                            $fileExtension = fileExtension($str_filename);
                                                                            $src = $fileExtension['src'];
                                                                            $embed = $fileExtension['embed'];
                                                                            $type = $fileExtension['type'];
                                                                            $file_extension = $fileExtension['file_extension'];
                                                                            $url = $base_url.'uploads/library/';

                                                                            $files = $src.$url.rawurlencode($str_filename).$embed;
                                                                        } else if ($str_filetype == 3) {
                                                                            $files = preg_replace('#[^/]*$#', '', $str_filename).'preview';
                                                                            $file_extension = 'fa-google';
                                                                        }
                                                                        $files = '<a href="'.$files.'" data-src="'.$files.'" data-fancybox data-type="'.$type.'">View</a>';
                                                                    }

																	echo '<tr id="tr_'. $review_ID .'" class="child_'.$review_parent_id.'">
																		<td style="border: 0;"></td>
																		<td colspan="2">
																			<b>'.$review_name.'</b> <i>('.$rtype[$review_type].')</i> | '.$review_last_modified.'<br>';

																			if (!empty($review_title)) { echo '<span class="text-muted">'.htmlentities($review_title ?? '').'</span><br>'; }
																			if (!empty($review_comment)) { echo '<span class="text-muted">'.htmlentities($review_comment ?? '').'</span><br>'; }
																			
																			echo '<div class="remark_action">';
																				if (!empty($review_remark)) {
																					if ($review_remark == "1") { echo '<span class="text-success">Accepted!</span>'; }
																					else { echo '<span class="text-danger">'.htmlentities($review_remark ?? '').'</span>'; }
																				} else {
																					echo '<a href="javascript:;" type="button" class="btn btn-sm btn-link" onclick="btnReviewAccept('. $review_ID .')">Accept</a> |
			                                                                		<a href="javascript:;" type="button" class="btn btn-sm btn-link" onclick="btnReviewReject('. $review_ID .')">Reject</a>';
																				}
																			echo '</div>
																		</td>
																		<td class="text-center">'.$files.'</td>
																		<td>
																            <div class="btn-group btn-group-circle">
																                <a href="#modalReviewActionEdit" type="button" class="btn btn-outline dark btn-sm" data-toggle="modal" onclick="btnReviewActionEdit('.$review_ID.')">Edit</a>
																                <a href="javascript:;" type="button" class="btn red btn-sm" onclick="btnReviewDelete('.$review_ID.', '.$library_ID.')">Delete</a>';

																                if ($review_compliant == 0) {
																                	echo '<a href="#modalReviewMore" type="button" class="btn blue btn-sm" data-toggle="modal" onclick="btnReviewMore('.$review_ID.')">Action</a>';
																                }
																            
																            echo '</div>
																        </td>
																	</tr>';

																	if (!empty($review_child_id)) {
    			                                                    	$array_child_id = explode(", ", $review_child_id);
    													                foreach ($array_child_id as $value) {
    													                    $selectReviewItem = mysqli_query( $conn,"SELECT * FROM tbl_library_review WHERE is_deleted = 0 AND ID=$value" );
    													                    if ( mysqli_num_rows($selectReviewItem) > 0 ) {
    													                    	while($rowReviewItem = mysqli_fetch_array($selectReviewItem)) {
    					                                                        	$review_ID = $rowReviewItem["ID"];
    					                                                        	$review_compliant = $rowReviewItem["compliant"];
    					                                                        	$review_title = $rowReviewItem["title"];
    					                                                        	$review_parent_id_action = $rowReviewItem["parent_id"];
    					                                                        	$review_child_id_action = $rowReviewItem["child_id"];

    							                                                    $review_user_id = $rowReviewItem["user_id"];
    							                                                    $selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $review_user_id " );
    							                                                    $rowUser = mysqli_fetch_array($selectUser);
    							                                                    $review_name = $rowUser["first_name"] .' '. $rowUser["last_name"];
                                                                                    if (employerID($review_user_id) == 34 AND $user_id != 34) {
                                                                                        $review_name = 'Compliance';
                                                                                    }

    																				$review_template = $rowReviewItem["template"];
    																				if ($review_template == 1) {
    																					$review_comment = "No Changes Noted During Review";
    																				} else {
    																					$review_comment = $rowReviewItem["comment"];
    																				}
    					                                            				$review_remark = $rowReviewItem["remark"];

    					                                                        	$review_type = $rowReviewItem["type"];
    					                                                        	$rtype = array(
    					                                                                0 => 'Observed',
    					                                                                1 => 'Corrected',
    					                                                                2 => 'Verified',
    					                                                                3 => 'Approved',
    					                                                                4 => 'Reviewed'
    					                                                            );

    					                                                        	$review_last_modified = $rowReviewItem["last_modified"];
    							                                                    $review_last_modified = new DateTime($review_last_modified);
    							                                                    $review_last_modified = $review_last_modified->format('M d, Y');

                                                                                    $files = '';
                                                                                    $type = 'iframe';
                                                                                    $file_extension = 'fa-youtube-play';
                                                                                    if (!empty($rowReferences["files"])) {
                                                                                        $arr_filename = explode(' | ', $rowReviewItem["files"]);
                                                                                        $arr_filetype = explode(' | ', $rowReviewItem["filetype"]);
                                                                                        $str_filename = '';

                                                                                        foreach($arr_filename as $val_filename) {
                                                                                            $str_filename = $val_filename;
                                                                                        }
                                                                                        foreach($arr_filetype as $val_filetype) {
                                                                                            $str_filetype = $val_filetype;
                                                                                        }

                                                                                        $files = $str_filename;
                                                                                        if ($str_filetype == 1) {
                                                                                            $fileExtension = fileExtension($str_filename);
                                                                                            $src = $fileExtension['src'];
                                                                                            $embed = $fileExtension['embed'];
                                                                                            $type = $fileExtension['type'];
                                                                                            $file_extension = $fileExtension['file_extension'];
                                                                                            $url = $base_url.'uploads/library/';

                                                                                            $files = $src.$url.rawurlencode($str_filename).$embed;
                                                                                        } else if ($str_filetype == 3) {
                                                                                            $files = preg_replace('#[^/]*$#', '', $str_filename).'preview';
                                                                                            $file_extension = 'fa-google';
                                                                                        }
                                                                                        $files = '<a href="'.$files.'" data-src="'.$files.'" data-fancybox data-type="'.$type.'">View</a>';
                                                                                    }

    																				echo '<tr id="tr_'. $review_ID .'" class="child_'.$review_parent_id.' child_action_'.$review_parent_id_action.'">
    																					<td style="border: 0;"></td>
    																					<td colspan="2">
    																						<b>'.$review_name.'</b> <i>('.$rtype[$review_type].')</i> | '.$review_last_modified.'<br>';

    																						if (!empty($review_title)) { echo '<span class="text-muted">'.$review_title.'</span><br>'; }
    																						if (!empty($review_comment)) { echo '<span class="text-muted">'.$review_comment.'</span><br>'; }
    																						
    																						echo '<div class="remark_action">';
    																							if (!empty($review_remark)) {
    																								if ($review_remark == "1") { echo '<span class="text-success">Accepted!</span>'; }
    																								else { echo '<span class="text-danger">'.$review_remark.'</span>'; }
    																							} else {
    																								echo '<a href="javascript:;" type="button" class="btn btn-sm btn-link" onclick="btnReviewAccept('. $review_ID .')">Accept</a> |
    						                                                                		<a href="javascript:;" type="button" class="btn btn-sm btn-link" onclick="btnReviewReject('. $review_ID .')">Reject</a>';
    																							}
    																						echo '</div>
    																					</td>
    																					<td class="text-center">'.$files.'</td>
    																					<td>
    																			            <div class="btn-group btn-group-circle">
    																			                <a href="#modalReviewMoreEdit" type="button" class="btn btn-outline dark btn-sm" data-toggle="modal" onclick="btnReviewMoreEdit('.$review_ID.')">Edit</a>
    																			                <a href="javascript:;" type="button" class="btn red btn-sm" onclick="btnReviewDelete('.$review_ID.', '.$library_ID.')">Delete</a>
    																						</div>
    																			        </td>
    																				</tr>';
    												                            }
    												                        }
    												                    }
    			                                                    }
									                            }
									                        }
									                    }
                                                    }
                                                }
                                            }

                                        echo '</tbody>
                                        <tfoot>
                                            <tr>
                                                <th class="text-center">'.$review.'%</th>
                                                <th colspan="4">Annual Review</th>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                                <a href="#modalReview" class="btn btn-circle btn-success" data-toggle="modal" onclick="btnReview('. $library_ID .')" style="margin: 15px 0;">Add Review</a>
                            </div>
                            <div class="tab-pane" id="tabTemplate_'. $library_ID .'">
                            	<div class="mt-actions">';

                            		$selectTemplate = mysqli_query( $conn,"SELECT * FROM tbl_library_template WHERE is_deleted = 0 AND library_id = $library_ID ORDER BY ID DESC" );
                                    if ( mysqli_num_rows($selectTemplate) > 0 ) {
                                        while($rowTemplate = mysqli_fetch_array($selectTemplate)) {
                                            $template_ID = $rowTemplate["ID"];
                                            $template_description = $rowTemplate["description"];

                                            $template_user_id = $rowTemplate["user_id"];
                                            $selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $template_user_id " );
                                            $rowUser = mysqli_fetch_array($selectUser);
                                            $template_name = $rowUser["first_name"] .' '. $rowUser["last_name"];
                                            if (employerID($template_user_id) == 34 AND $user_id != 34) {
                                                $template_name = 'Compliance';
                                            }

                                            $files = '';
                                            $type = 'iframe';
                                            $file_extension = 'fa-youtube-play';
                                            if (!empty($rowTemplate["files"])) {
                                                $arr_filename = explode(' | ', $rowTemplate["files"]);
                                                $arr_filetype = explode(' | ', $rowTemplate["filetype"]);
                                                $str_filename = '';

                                                foreach($arr_filename as $val_filename) {
                                                    $str_filename = $val_filename;
                                                }
                                                foreach($arr_filetype as $val_filetype) {
                                                    $str_filetype = $val_filetype;
                                                }

                                                $files = $str_filename;
                                                if ($str_filetype == 1) {
                                                    $fileExtension = fileExtension($str_filename);
                                                    $src = $fileExtension['src'];
                                                    $embed = $fileExtension['embed'];
                                                    $type = $fileExtension['type'];
                                                    $file_extension = $fileExtension['file_extension'];
                                                    $url = $base_url.'uploads/library/';

                                                    $files = $src.$url.rawurlencode($str_filename).$embed;
                                                } else if ($str_filetype == 3) {
                                                    $files = preg_replace('#[^/]*$#', '', $str_filename).'preview';
                                                    $file_extension = 'fa-google';
                                                }
                                            }

                                            $template_last_modified = $rowTemplate["last_modified"];
                                            $template_last_modified = new DateTime($template_last_modified);
                                            $template_last_modified = $template_last_modified->format('M d, Y');

                            				echo '<div class="mt-action mt-action-'. $template_ID .'">
                                                <div class="mt-action-body">
                                                    <div class="mt-action-row">
                                                        <div class="mt-action-info">
                                                            <div class="mt-action-icon">
                                                                <a href="'.$files.'" data-src="'.$files.'" data-fancybox data-type="'.$type.'"><i class="fa fa-fw '. $file_extension .'"></i></a>
                                                            </div>
                                                            <div class="mt-action-details" style="vertical-align: middle;">
                                                                <p class="mt-action-desc">
                                                                	<span class="font-dark">'. htmlentities($template_description ?? '') .'</span><br>
                                                                	Uploaded by: '. $template_name .'
                                                                </p>
                                                            </div>
                                                        </div>
                                                        <div class="mt-action-datetime">
                                                            <span class="mt-action-date">'. $template_last_modified .'</span>
                                                        </div>
                                                        <div class="mt-action-buttons">
                                                            <div class="btn-group btn-group-circle">
                                                            	<a href="#modalTemplateEdit" type="button" class="btn btn-outline dark btn-sm" data-toggle="modal" onclick="btnTemplateEdit('. $template_ID .')">Edit</a>
                                                            	<a href="javascript:;" type="button" class="btn red btn-sm" onclick="btnTemplateDelete('. $template_ID .', '. $library_ID .')">Delete</a>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>';
                                        }
                                    }

                            	echo '</div>
                            	<a href="#modalTemplate" class="btn btn-circle btn-success" data-toggle="modal" onclick="btnTemplate('. $library_ID .')" style="margin: 15px;">Add Templates</a>
                            </div>';

		                    if ($current_client == 0) {
	                            echo '<div class="tab-pane" id="tabReferences_'. $library_ID .'">
	                            	<div class="mt-actions">';

                                        $sql_ref = '';
                                        if (mysqli_num_rows($hasLibrary) == 0) {
                                            $sql_ref = ' AND user_id = '.$portal_user;
                                        }
	                            		$selectReferences = mysqli_query( $conn,"SELECT * FROM tbl_library_references WHERE is_deleted = 0 AND library_id = $library_ID $sql_ref ORDER BY ID DESC" );
	                                    if ( mysqli_num_rows($selectReferences) > 0 ) {
	                                        while($rowReferences = mysqli_fetch_array($selectReferences)) {
	                                            $ref_ID = $rowReferences["ID"];
	                                            $ref_description = $rowReferences["description"];

	                                            $ref_user_id = $rowReferences["user_id"];
	                                            $selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $ref_user_id " );
	                                            $rowUser = mysqli_fetch_array($selectUser);
	                                            $ref_name = $rowUser["first_name"] .' '. $rowUser["last_name"];
                                                if (employerID($ref_user_id) == 34 AND $user_id != 34) {
                                                    $ref_name = 'Compliance';
                                                }

                                                $files = '';
                                                $type = 'iframe';
                                                $file_extension = 'fa-youtube-play';
                                                if (!empty($rowReferences["files"])) {
                                                    $arr_filename = explode(' | ', $rowReferences["files"]);
                                                    $arr_filetype = explode(' | ', $rowReferences["filetype"]);
                                                    $str_filename = '';

                                                    foreach($arr_filename as $val_filename) {
                                                        $str_filename = $val_filename;
                                                    }
                                                    foreach($arr_filetype as $val_filetype) {
                                                        $str_filetype = $val_filetype;
                                                    }

                                                    $files = $str_filename;
                                                    if ($str_filetype == 1) {
                                                        $fileExtension = fileExtension($str_filename);
                                                        $src = $fileExtension['src'];
                                                        $embed = $fileExtension['embed'];
                                                        $type = $fileExtension['type'];
                                                        $file_extension = $fileExtension['file_extension'];
                                                        $url = $base_url.'uploads/library/';

                                                        $files = $src.$url.rawurlencode($str_filename).$embed;
                                                    } else if ($str_filetype == 3) {
                                                        $files = preg_replace('#[^/]*$#', '', $str_filename).'preview';
                                                        $file_extension = 'fa-google';
                                                    }
                                                }

	                                            $ref_last_modified = $rowReferences["last_modified"];
	                                            $ref_last_modified = new DateTime($ref_last_modified);
	                                            $ref_last_modified = $ref_last_modified->format('M d, Y');

	                            				echo '<div class="mt-action mt-action-'. $ref_ID .'">
	                                                <div class="mt-action-body">
	                                                    <div class="mt-action-row">
	                                                        <div class="mt-action-info">
	                                                            <div class="mt-action-icon">
	                                                                <a href="'.$files.'" data-src="'.$files.'" data-fancybox data-type="'.$type.'"><i class="fa fa-fw '. $file_extension .'"></i></a>
	                                                            </div>
	                                                            <div class="mt-action-details" style="vertical-align: middle;">
	                                                                <p class="mt-action-desc">
	                                                                	<span class="font-dark">'. htmlentities($ref_description ?? '') .'</span><br>
	                                                                	Uploaded by: '. $ref_name .'
	                                                                </p>
	                                                            </div>
	                                                        </div>
	                                                        <div class="mt-action-datetime">
	                                                            <span class="mt-action-date">'. $ref_last_modified .'</span>
	                                                        </div>
	                                                        <div class="mt-action-buttons">
	                                                            <div class="btn-group btn-group-circle">
	                                                            	<a href="#modalRefEdit" type="button" class="btn btn-outline dark btn-sm" data-toggle="modal" onclick="btnRefEdit('. $ref_ID .')">Edit</a>
	                                                            	<a href="javascript:;" type="button" class="btn red btn-sm" onclick="btnRefDelete('. $ref_ID .', '. $library_ID .')">Delete</a>
	                                                            </div>
	                                                        </div>
	                                                    </div>
	                                                </div>
	                                            </div>';
	                                        }
	                                    }

	                            	echo '</div>
	                            	<a href="#modalRef" class="btn btn-circle btn-success" data-toggle="modal" onclick="btnRef('. $library_ID .')" style="margin: 15px;">Add References</a>
	                            </div>
	                            <div class="tab-pane" id="tabVideo_'. $library_ID .'">
	                            	<div class="mt-actions">';

                                        $sql_video = '';
                                        if (mysqli_num_rows($hasLibrary) == 0) {
                                            $sql_video = ' AND user_id = '.$portal_user;
                                        }
	                            		$selectVideo = mysqli_query( $conn,"SELECT * FROM tbl_library_video WHERE is_deleted = 0 AND library_id = $library_ID $sql_video ORDER BY ID DESC" );
	                                    if ( mysqli_num_rows($selectVideo) > 0 ) {
	                                        while($rowVideo = mysqli_fetch_array($selectVideo)) {
	                                            $video_ID = $rowVideo["ID"];
	                                            $video_description = $rowVideo["description"];
	                                            $video_type = $rowVideo["type"];
	                                            $video_url = $rowVideo["url"];

	                                            $video_user_id = $rowVideo["user_id"];
	                                            $selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $video_user_id " );
	                                            $rowUser = mysqli_fetch_array($selectUser);
	                                            $video_name = $rowUser["first_name"] .' '. $rowUser["last_name"];
                                                if (employerID($video_user_id) == 34 AND $user_id != 34) {
                                                    $video_name = 'Compliance';
                                                }

	                                            $video_files = $rowVideo["files"];
	                                            $fileExtension = fileExtension($video_files);
	                                    		$src = $fileExtension['src'];
	                                    		$embed = $fileExtension['embed'];
	                                    		$type = $fileExtension['type'];
	                                    		$file_extension = $fileExtension['file_extension'];
									            $url = $base_url.'uploads/library/';

	                                            $video_last_modified = $rowVideo["last_modified"];
	                                            $video_last_modified = new DateTime($video_last_modified);
	                                            $video_last_modified = $video_last_modified->format('M d, Y');

	                            				echo '<div class="mt-action mt-action-'. $video_ID .'">
	                                                <div class="mt-action-body">
	                                                    <div class="mt-action-row">
	                                                        <div class="mt-action-info">
	                                                            <div class="mt-action-icon">';

	                                                            	if ($video_type == 0) {
	                                                            		echo '<a href="'.$src.$url.rawurlencode($video_files).$embed.'" data-src="'.$src.$url.rawurlencode($video_files).$embed.'" data-fancybox data-type="'.$type.'"><i class="fa '. $file_extension .'"></i></a>';
	                                                            	} else {
	                                                            		echo '<a href="'.$video_url.'" data-src="'.$video_url.'" data-fancybox><i class="fa fa-youtube"></i></a>';
	                                                            	}
	                                                                
	                                                            echo '</div>
	                                                            <div class="mt-action-details" style="vertical-align: middle;">
	                                                                <p class="mt-action-desc">
	                                                                	<span class="font-dark">'. htmlentities($video_description ?? '') .'</span><br>
	                                                                	Uploaded by: '. $video_name .'
	                                                                </p>
	                                                            </div>
	                                                        </div>
	                                                        <div class="mt-action-datetime">
	                                                            <span class="mt-action-date">'. $video_last_modified .'</span>
	                                                        </div>
	                                                        <div class="mt-action-buttons">
	                                                            <div class="btn-group btn-group-circle">
	                                                            	<a href="#modalVideoEdit" type="button" class="btn btn-outline dark btn-sm" data-toggle="modal" onclick="btnVideoEdit('. $video_ID .')">Edit</a>
	                                                            	<a href="javascript:;" type="button" class="btn red btn-sm" onclick="btnVideoDelete('. $video_ID .', '. $library_ID .')">Delete</a>
	                                                            </div>
	                                                        </div>
	                                                    </div>
	                                                </div>
	                                            </div>';
	                                        }
	                                    }

	                            	echo '</div>
	                            	<a href="#modalVideo" class="btn btn-circle btn-success" data-toggle="modal" onclick="btnVideo('. $library_ID .')" style="margin: 15px;">Add Video</a>
	                            </div>';
	                        }
                            
                            echo '<div class="tab-pane" id="tabTask_'. $library_ID .'">
                                <div class="mt-actions">';

                                    // $selectTask = mysqli_query( $conn,"SELECT * FROM tbl_MyProject_Services WHERE is_deleted = 0 AND library_id = $library_ID " );
                                    $selectTask = mysqli_query( $conn,"SELECT
                                        h.History_id AS h_ID,
                                        h.library_id AS h_library_ID,
                                        h.filename AS h_name,
                                        h.Assign_to_History AS h_assign_to_id,
                                        h.files AS h_files,
                                        h.Action_date AS h_date_due,
                                        m.Start_Date AS m_date_start
                                        FROM tbl_MyProject_Services AS m

                                        INNER JOIN (
                                            SELECT
                                            *
                                            FROM tbl_MyProject_Services_History
                                            WHERE is_deleted = 0
                                        ) AS h
                                        ON m.MyPro_id = h.MyPro_PK

                                        WHERE m.is_deleted = 0 
                                        AND m.library_id = $library_ID" );
                                    if ( mysqli_num_rows($selectTask) > 0 ) {
                                        while($rowTask = mysqli_fetch_array($selectTask)) {
                                            $task_ID = $rowTask["h_ID"];
                                            $task_description = $rowTask["h_name"];

                                            $array_name = array();
                                            $task_assigned = $rowTask["h_assign_to_id"];
                                            $user_arr = explode(', ', $task_assigned);
                                            foreach ($user_arr as $value) {
                                                $selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE employee_id = $value " );
                                                if ( mysqli_num_rows($selectUser) > 0 ) {
                                                    $rowUser = mysqli_fetch_array($selectUser);
                                                    $assigned_name = $rowUser["first_name"] .' '. $rowUser["last_name"];
                                                    array_push($array_name, $assigned_name);
                                                }
                                            }
                                            $array_name = implode(", ",$array_name);

                                            $task_files = $rowTask["h_files"];
                                            if (!empty($task_files)) {
                                                $fileExtension = fileExtension($task_files);
                                                $src = $fileExtension['src'];
                                                $embed = $fileExtension['embed'];
                                                $type = $fileExtension['type'];
                                                $file_extension = $fileExtension['file_extension'];
                                                $url = $base_url.'uploads/task/';
                                            }

                                            $task_start_date = $rowTask["m_date_start"];
                                            $task_start_date = new DateTime($task_start_date);
                                            $task_start_date = $task_start_date->format('M d, Y');

                                            $task_desired_date = $rowTask["h_date_due"];
                                            $task_desired_date = new DateTime($task_desired_date);
                                            $task_desired_date = $task_desired_date->format('M d, Y');

                                            echo '<div class="mt-action mt-action-'. $task_ID .'">
                                                <div class="mt-action-body">
                                                    <div class="mt-action-row">
                                                        <div class="mt-action-info">
                                                            <div class="mt-action-icon">';

                                                                if (!empty($task_files)) {
                                                                    echo '<a href="'.$src.$url.rawurlencode($task_files).$embed.'" data-src="'.$src.$url.rawurlencode($task_files).$embed.'" data-fancybox data-type="'.$type.'"><i class="fa '. $file_extension .'"></i></a>';
                                                                } else {
                                                                    echo '<i class="fa fa-file-code-o" style="visibility: hidden;"></i>';
                                                                }
                                                                
                                                            echo '</div>
                                                            <div class="mt-action-details" style="vertical-align: middle;">
                                                                <p class="mt-action-desc">
                                                                    <span class="font-dark"><b>'. htmlentities($task_description ?? '') .'</b></span><br>
                                                                    Assigned to: '. $array_name .'
                                                                </p>
                                                            </div>
                                                        </div>
                                                        <div class="mt-action-datetime">
                                                            <span class="mt-action-date">'. $task_start_date .'</span>
                                                            <span class="mt-action-dot bg-green"></span>
                                                            <span class="mt-action-date">'. $task_desired_date .'</span>
                                                        </div>
                                                        <div class="mt-action-buttons">
                                                            <div class="btn-group btn-group-circle">
                                                                <a href="#modalTaskEdit" type="button" class="btn btn-outline dark btn-sm" data-toggle="modal" onclick="btnTaskEdit('. $task_ID .')">Edit</a>
                                                                <a href="javascript:;" type="button" class="btn red btn-sm" onclick="btnTaskDelete('. $task_ID .', '. $library_ID .')">Delete</a>
                                                                <a href="'.$base_url.'mypro_task.php?view_id='. $task_ID .'" type="button" class="btn btn-success btn-sm" target="_blank">View</a>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>';
                                        }
                                    }

                                echo '</div>
                                <a href="#modalTask" class="btn btn-circle btn-success" data-toggle="modal" onclick="btnTask('. $library_ID .')" style="margin: 15px;">Add Task</a>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="panel-group accordion" id="parent'. $library_ID .'">';

                    echo (itemChild($library_ID, $library_child));

                echo '</div>
            </div>';
        }

        mysqli_close($conn);
	}
	if( isset($_GET['modalDashboardAction']) ) {
		if (!empty($_COOKIE['switchAccount'])) {
			$portal_user = $_COOKIE['ID'];
			$user_id = $_COOKIE['switchAccount'];
		}
		else {
			$portal_user = $_COOKIE['ID'];
			$user_id = employerID($portal_user);
		}

		$action = $_GET['modalDashboardAction'];
		$id = $_GET['i'];
		$type = $_GET['t'];
		$tbl = array(
            1 => 'tbl_library',
            2 => 'tbl_library_file',
        );

    	$current_userID = $_COOKIE['ID'];

    	if ($action == 1) {
    		mysqli_query( $conn,"UPDATE $tbl[$type] SET deleted = 1 WHERE ID = $id" );
    	} else {
    		mysqli_query( $conn,"UPDATE $tbl[$type] SET reason = '' WHERE ID = $id" );
    	}
	}

	// JSTree Display at Once (JSON Format)
	if( isset($_GET['jstreeList']) ) {
		if (!empty($_COOKIE['switchAccount'])) { $user_id = $_COOKIE['switchAccount']; }
		else { $user_id = $_COOKIE['ID']; }

		$collabUser = $_GET['jstreeList'];
        $current_userEmployeeID = employeeID($user_id);
        $current_userEmployerID = employerID($user_id);
		$result = array();

		$resultTree = mysqli_query( $conn,"SELECT * FROM tbl_library WHERE parent_id = 0 AND deleted = 0 AND user_id = $current_userEmployerID" );
		if ($collabUser == 1 AND !isset($_COOKIE['switchAccount'])) { $resultTree = mysqli_query( $conn,"SELECT * FROM tbl_library WHERE deleted = 0 AND collaborator_id <> ''" ); }

		if ( mysqli_num_rows($resultTree) > 0 ) {
            while($rowTree = mysqli_fetch_array($resultTree)) {
                $library_ID = $rowTree["ID"];
                $library_name = $rowTree["name"];
                $library_collaborator_id = $rowTree["collaborator_id"];

                $library_child = false;
                if (!empty($rowTree["child_id"])) { $library_child = true; }

                $array_name_id = explode(", ", $library_name);
                if ( count($array_name_id) == 4 ) {
                    $data_name = array();

                    $selectType = mysqli_query($conn,"SELECT * FROM tbl_library_type WHERE ID = '".$array_name_id[0]."'");
                    if ( mysqli_num_rows($selectType) > 0 ) {
                        while($rowType = mysqli_fetch_array($selectType)) {
                            array_push($data_name, $rowType["name"]);
                        }
                    }

                    $selectCategory = mysqli_query($conn,"SELECT * FROM tbl_library_category WHERE ID = '".$array_name_id[1]."'");
                    if ( mysqli_num_rows($selectCategory) > 0 ) {
                        while($rowCategory = mysqli_fetch_array($selectCategory)) {
                            array_push($data_name, $rowCategory["name"]);
                        }
                    }

                    $selectScope = mysqli_query($conn,"SELECT * FROM tbl_library_scope WHERE ID = '".$array_name_id[2]."'");
                    if ( mysqli_num_rows($selectScope) > 0 ) {
                        while($rowScope = mysqli_fetch_array($selectScope)) {
                            array_push($data_name, $rowScope["name"]);
                        }
                    }

                    $selectModule = mysqli_query($conn,"SELECT * FROM tbl_library_module WHERE ID = '".$array_name_id[3]."'");
                    if ( mysqli_num_rows($selectModule) > 0 ) {
                        while($rowModule = mysqli_fetch_array($selectModule)) {
                            array_push($data_name, $rowModule["name"]);
                        }
                    }

                    $library_name = implode(" - ",$data_name);
                }

                if($collabUser == 1 AND !isset($_COOKIE['switchAccount'])) {
                    if (!empty($library_collaborator_id)) {
                        $collab = json_decode($library_collaborator_id, true);
                        foreach ($collab as $key => $value) {
                            if ($current_userEmployerID == $key) {
                                if (in_array($current_userEmployeeID, $value['assigned_to_id'])) {
                                	$output = array(
										"id" => $library_ID,
										"parent" => '#',
										"children" => $library_child,
										"state" => 'close',
										"text" => $library_name
									);
									array_push($result, $output);
									break;
                                }
                            }
                        }
                    }
                } else {
					$output = array(
						"id" => $library_ID,
						"parent" => '#',
						"children" => $library_child,
						"state" => 'close',
						"text" => $library_name
					);
					array_push($result, $output);
                }
            }
		}
		echo json_encode($result);
	}
	if( isset($_GET['jstreeListItem']) ) {
		$id = $_GET['jstreeListItem'];
		$user_id = $_COOKIE['ID'];
        $user_id = employerID($user_id);
		$result = array();

		$selectLibrary = mysqli_query( $conn,"SELECT * FROM tbl_library WHERE ID=$id" );
		$rowLibrary = mysqli_fetch_array($selectLibrary);
		$library_parent_id = $rowLibrary["ID"];
		$library_child_id = $rowLibrary["child_id"];

		$selectFile = mysqli_query( $conn,"SELECT * FROM tbl_library_file WHERE deleted = 0 AND library_id = $library_parent_id" );
		if ( mysqli_num_rows($selectFile) > 0 ) {
			while($rowFile = mysqli_fetch_array($selectFile)) {
				$file_ID = $rowFile["ID"];
				$file_name = $rowFile["name"];

				$output = array(
					"id" => $file_ID,
					"parent" => $library_parent_id,
					"children" => false,
					"state" => 'close',
					"text" => $file_name,
					"type" => 'file'
				);
				array_push($result, $output);
	        }
		}
		if (!empty($library_child_id)) {
			$resultTreeItem = mysqli_query( $conn,"SELECT * FROM tbl_library WHERE deleted = 0 AND parent_id = $library_parent_id" );
			if ( mysqli_num_rows($resultTreeItem) > 0 ) {
				while($rowTreeItem = mysqli_fetch_array($resultTreeItem)) {
		            $item_ID = $rowTreeItem["ID"];
		            $item_name = $rowTreeItem["name"];
		            $item_parent_id = $rowTreeItem["parent_id"];
		            $item_child = false;
		            if (!empty($rowTreeItem["child_id"])) { $item_child = true; }

		            $array_child_id = explode(", ", $library_child_id);
		            if (in_array($item_ID, $array_child_id)) {
						$output = array(
							"id" => $item_ID,
							"parent" => $item_parent_id,
							"children" => $item_child,
							"state" => 'close',
							"text" => $item_name
						);
						array_push($result, $output);
		            }
	            }
	        }
        }
		echo json_encode($result);
	}

	// JSTree Display all (HTML Format)
	function tree_items($parent_id) {
        global $conn;
        global $base_url;
        $output = '';

        $resultTreeItem = mysqli_query( $conn,"SELECT * FROM tbl_library WHERE deleted = 0 AND parent_id = $parent_id" );
        if ( mysqli_num_rows($resultTreeItem) > 0 ) {
            $output .= '<ul>';
                while($rowTreeItem = mysqli_fetch_array($resultTreeItem)) {
                    $item_ID = $rowTreeItem["ID"];
                    $item_name = $rowTreeItem["name"];
                    $item_parent_id = $rowTreeItem["parent_id"];
                    $item_child_id = $rowTreeItem["child_id"];

                    $item_child = false;
                    if (!empty($rowTreeItem["child_id"])) { $item_child = true; }

                    $output .= '<li id="'.$item_ID .'">'. $item_name;

		            	$selectFile = mysqli_query( $conn,"SELECT * FROM tbl_library_file WHERE deleted = 0 AND library_id = $item_ID" );
		            	if ( mysqli_num_rows($selectFile) > 0 ) {
		            		$output .= '<ul>';
		            		while($rowFile = mysqli_fetch_array($selectFile)) {
		            			$file_ID = $rowFile["ID"];
		            			$file_name = $rowFile["name"];
		            			$files = $rowFile["files"];
					            $fileExtension = fileExtension($files);
								$src = $fileExtension['src'];
								$embed = $fileExtension['embed'];
								$type = $fileExtension['type'];
								$file_extension = $fileExtension['file_extension'];
					            $url = $base_url.'uploads/library/';

					            $output .= '<li id="'. $file_ID .'" data-jstree=\'{"type":"file"}\' data-type="file"><a data-src="'.$src.$url.rawurlencode($files).$embed.'" data-fancybox data-ftype="'.$type.'">'. $file_name .'</a></li>';
							}
		            		$output .= '</ul>';
		            	}

                        if (!empty($item_child_id)) {
                            $output .= tree_items($item_ID);
                        }

                    $output .= '</li>';
                }
            $output .= '</ul>';
        }

        return $output;
    }
	if( isset($_GET['jstree_HTML']) ) {
		if (!empty($_COOKIE['switchAccount'])) { $user_id = $_COOKIE['switchAccount']; }
		else { $user_id = $_COOKIE['ID']; }

		$collabUser = $_GET['jstree_HTML'];
        $current_userEmployeeID = employeeID($user_id);
        $current_userEmployerID = employerID($user_id);

        $hasLibrary = mysqli_query( $conn,"SELECT * FROM tbl_library WHERE user_id = $user_id" );
        if ( mysqli_num_rows($hasLibrary) > 0 ) {
            $resultTree = mysqli_query( $conn,"SELECT * FROM tbl_library WHERE parent_id = 0 AND deleted = 0 AND user_id = $current_userEmployerID" );
            if ($collabUser == 1 AND !isset($_COOKIE['switchAccount'])) { $resultTree = mysqli_query( $conn,"SELECT * FROM tbl_library WHERE deleted = 0 AND collaborator_id <> ''" ); }
        } else {
            $resultTree = mysqli_query( $conn,"SELECT * FROM tbl_library WHERE ID = 116706101" );
            $current_userEmployeeID = employeeID(163);
            $current_userEmployerID = employerID(163);
            $collabUser = 0;
        }

	    if ( mysqli_num_rows($resultTree) > 0 ) {
	        while($rowTree = mysqli_fetch_array($resultTree)) {
	            $library_ID = $rowTree["ID"];
	            $library_name = $rowTree["name"];
	            $library_collaborator_id = $rowTree["collaborator_id"];

	            $library_child = false;
	            if (!empty($rowTree["child_id"])) { $library_child = true; }

	            $array_name_id = explode(", ", $library_name);
	            if ( count($array_name_id) == 4 ) {
	                $data_name = array();

	                $selectType = mysqli_query($conn,"SELECT * FROM tbl_library_type WHERE ID = '".$array_name_id[0]."'");
	                if ( mysqli_num_rows($selectType) > 0 ) {
	                    while($rowType = mysqli_fetch_array($selectType)) {
	                        array_push($data_name, $rowType["name"]);
	                    }
	                }

	                $selectCategory = mysqli_query($conn,"SELECT * FROM tbl_library_category WHERE ID = '".$array_name_id[1]."'");
	                if ( mysqli_num_rows($selectCategory) > 0 ) {
	                    while($rowCategory = mysqli_fetch_array($selectCategory)) {
	                        array_push($data_name, $rowCategory["name"]);
	                    }
	                }

	                $selectScope = mysqli_query($conn,"SELECT * FROM tbl_library_scope WHERE ID = '".$array_name_id[2]."'");
	                if ( mysqli_num_rows($selectScope) > 0 ) {
	                    while($rowScope = mysqli_fetch_array($selectScope)) {
	                        array_push($data_name, $rowScope["name"]);
	                    }
	                }

	                $selectModule = mysqli_query($conn,"SELECT * FROM tbl_library_module WHERE ID = '".$array_name_id[3]."'");
	                if ( mysqli_num_rows($selectModule) > 0 ) {
	                    while($rowModule = mysqli_fetch_array($selectModule)) {
	                        array_push($data_name, $rowModule["name"]);
	                    }
	                }

	                $library_name = implode(" - ",$data_name);
	            }

	            if($collabUser == 1 AND !isset($_COOKIE['switchAccount'])) {
                    if (!empty($library_collaborator_id)) {
                        $collab = json_decode($library_collaborator_id, true);
                        foreach ($collab as $key => $value) {
                            if ($current_userEmployerID == $key) {
                                if (in_array($current_userEmployeeID, $value['assigned_to_id'])) {
									echo '<li id="'. $library_ID .'">'. $library_name;

										$selectFile = mysqli_query( $conn,"SELECT * FROM tbl_library_file WHERE deleted = 0 AND library_id = $library_ID" );
										if ( mysqli_num_rows($selectFile) > 0 ) {
											echo '<ul>';
											while($rowFile = mysqli_fetch_array($selectFile)) {
												$file_ID = $rowFile["ID"];
												$file_name = $rowFile["name"];
												$files = $rowFile["files"];
									            $fileExtension = fileExtension($files);
												$src = $fileExtension['src'];
												$embed = $fileExtension['embed'];
												$type = $fileExtension['type'];
												$file_extension = $fileExtension['file_extension'];
									            $url = $base_url.'uploads/library/';

									            echo '<li id="'. $file_ID .'" data-jstree=\'{"type":"file"}\' data-type="file"><a data-src="'.$src.$url.rawurlencode($files).$embed.'" data-fancybox data-ftype="'.$type.'">'. $file_name .'</a></li>';
											}
											echo '</ul>';
										}

									    if ($library_child == true) {
									        echo tree_items($library_ID);
									    }

									echo '</li>';
                                }
                            }
                        }
                    }
                } else {
					echo '<li id="'. $library_ID .'">'. $library_name;

						$selectFile = mysqli_query( $conn,"SELECT * FROM tbl_library_file WHERE deleted = 0 AND library_id = $library_ID" );
						if ( mysqli_num_rows($selectFile) > 0 ) {
							echo '<ul>';
							while($rowFile = mysqli_fetch_array($selectFile)) {
								$file_ID = $rowFile["ID"];
								$file_name = $rowFile["name"];
								$files = $rowFile["files"];
					            $fileExtension = fileExtension($files);
								$src = $fileExtension['src'];
								$embed = $fileExtension['embed'];
								$type = $fileExtension['type'];
								$file_extension = $fileExtension['file_extension'];
					            $url = $base_url.'uploads/library/';

					            echo '<li id="'. $file_ID .'" data-jstree=\'{"type":"file"}\' data-type="file"><a data-src="'.$src.$url.rawurlencode($files).$embed.'" data-fancybox data-ftype="'.$type.'">'. $file_name .'</a></li>';
							}
							echo '</ul>';
						}

					    if ($library_child == true) {
					        echo tree_items($library_ID);
					    }

					echo '</li>';
		        }
	        }
	    }
	}
	if( isset($_GET['jstree_HTML2']) ) {
		if (!empty($_COOKIE['switchAccount'])) {
			$portal_user = $_COOKIE['ID'];
			$user_id = $_COOKIE['switchAccount'];
		}
		else {
			$portal_user = $_COOKIE['ID'];
			$user_id = employerID($portal_user);
		}
		$collabUser = $_GET['jstree_HTML2'];
        $current_userEmployeeID = employeeID($portal_user);
        $current_userEmployerID = employerID($portal_user);

        $hasLibrary = mysqli_query( $conn,"SELECT * FROM tbl_library WHERE user_id = $user_id" );
        if ( mysqli_num_rows($hasLibrary) > 0 ) {
            $resultTree = mysqli_query( $conn,"SELECT * FROM tbl_library WHERE parent_id = 0 AND deleted = 0 AND user_id = $user_id" );
            if ($collabUser == 1 AND !isset($_COOKIE['switchAccount'])) { $resultTree = mysqli_query( $conn,"SELECT * FROM tbl_library WHERE deleted = 0 AND collaborator_id <> '' AND user_id = $user_id" ); }
            if ($current_userEmployerID == 27) { $resultTree = mysqli_query( $conn,"SELECT * FROM tbl_library WHERE parent_id = 0 AND deleted = 0 AND user_id = $user_id" ); }
        } else {
            $customID = 116706101;
            if ($_COOKIE['client'] == 3) { $customID = 116713042; }

            $resultTree = mysqli_query( $conn,"SELECT * FROM tbl_library WHERE ID = $customID" );
            $user_id = 163;
            $current_userEmployeeID = employeeID($user_id);
            $current_userEmployerID = employerID($user_id);
            $collabUser = 0;
        }

		$result = array();
	    if ( mysqli_num_rows($resultTree) > 0 ) {
	        while($rowTree = mysqli_fetch_array($resultTree)) {
	            $library_ID = $rowTree["ID"];
	            $library_name = $rowTree["name"];
	            $library_collaborator_id = $rowTree["collaborator_id"];

	            $library_child = false;
	            if (!empty($rowTree["child_id"])) { $library_child = true; }


                // if ($user_id == 266) {
                //     $selectFile = mysqli_query( $conn,"WITH RECURSIVE cte (mainID, parentID, childIDs, parentCollab, parentName) AS
                //         (
                //             SELECT 
                //                 t1.ID AS mainID,
                //                 t1.parent_id AS parentID,
                //                 t1.child_id AS childIDs,
                //                 t1.collaborator_id AS parentCollab,
                //                 t1.name AS parentName
                //             FROM tbl_library AS t1
                //             WHERE t1.deleted = 0 AND t1.user_id = 337 AND t1.parent_id = 0 AND t1.ID = 26966
                            
                //             UNION ALL
                            
                //             SELECT 
                //                 t2.ID AS mainID,
                //                 t2.parent_id AS parentID,
                //                 t2.child_id AS childIDs,
                //                 t2.collaborator_id AS parentCollab,
                //                 t2.name AS parentName
                //             FROM tbl_library AS t2
                //             JOIN cte ON cte.mainID = t2.parent_id
                //             WHERE t2.deleted = 0 AND t2.user_id = 337
                //         )
                //         SELECT 
                //         mainID, parentID, childIDs, parentCollab, parentName,
                //         fileID, files, name
                //         FROM cte

                //         LEFT JOIN (
                //             SELECT ID AS fileID, library_id, files, name, last_modified, due_date FROM tbl_library_file WHERE deleted = 0
                //         ) AS f
                //         ON cte.mainID = f.library_id
                //         -- WHERE f.name IS NOT NULL
                //         ORDER BY mainID, parentID" );
                // } else {
                $selectFile = mysqli_query( $conn,"WITH RECURSIVE cte (mainID, portal_userID, parentID, childIDs, type, free_access, parentCollab, parentName) AS
                    (
                        SELECT 
                            t1.ID AS mainID,
                            t1.portal_user AS portal_userID,
                            t1.parent_id AS parentID,
                            t1.child_id AS childIDs,
                            t1.type AS type,
                            t1.free_access AS free_access,
                            t1.collaborator_id AS parentCollab,
                            t1.name AS parentName
                        FROM tbl_library AS t1
                        WHERE t1.deleted = 0 AND t1.user_id = $user_id AND t1.parent_id = 0 AND t1.ID = $library_ID
                        
                        UNION ALL
                        
                        SELECT 
                            t2.ID AS mainID,
                            t2.portal_user AS portal_userID,
                            t2.parent_id AS parentID,
                            t2.child_id AS childIDs,
                            t2.type AS type,
                            t2.free_access AS free_access,
                            t2.collaborator_id AS parentCollab,
                            t2.name AS parentName
                        FROM tbl_library AS t2
                        JOIN cte ON cte.mainID = t2.parent_id
                        WHERE t2.deleted = 0 AND t2.user_id = $user_id
                    )
                    SELECT 
                    mainID, portal_userID, parentID, childIDs, type, free_access, parentCollab, parentName,
                    fileID, files, name
                    FROM cte

                    LEFT JOIN (
                        SELECT ID AS fileID, library_id, files, name, last_modified, due_date FROM tbl_library_file WHERE deleted = 0
                    ) AS f
                    ON cte.mainID = f.library_id
                    -- WHERE f.name IS NOT NULL
                    -- ORDER BY mainID, parentID
                    ORDER BY FIELD(type,1,2,3,5,4) ASC, mainID ASC, parentID ASC" );
                // }
				if ( mysqli_num_rows($selectFile) > 0 ) {
					$list_array = array();
					// array_push($list_array, $library_ID);

					while($rowFile = mysqli_fetch_array($selectFile)) {
						$mainID = $rowFile["mainID"];
						$parentID = $rowFile["parentID"];
						$parentName = $rowFile["parentName"];
                        $type_id = $rowFile["type"];
						$file_ID = $rowFile["fileID"];
						$file_name = $rowFile["name"];

						$files = $rowFile["files"];
			            // $fileExtension = fileExtension($files);
						// $src = $fileExtension['src'];
						// $embed = $fileExtension['embed'];
						// $type = $fileExtension['type'];
						// $file_extension = $fileExtension['file_extension'];
			            // $url = $base_url.'uploads/library/';

						$childIDs = $rowFile["childIDs"];
			            $item_child = false;
			            if (!empty($childIDs)) { $item_child = true; }

                        $displayLibrary = false;
                        if (mysqli_num_rows($hasLibrary) == 0) {
                            if ($rowFile["portal_userID"] == $portal_user OR $rowFile["portal_userID"] == 163) {
                                $displayLibrary = true;
                            }
                        } else {
                            if ($rowFile["free_access"] == 0) {
                                $displayLibrary = true;
                            }
                        }

                        if ($displayLibrary == true) {
                            if ($collabUser == 1) {
                                if (!empty($library_collaborator_id)) {
                                    $collab = json_decode($library_collaborator_id, true);
                                    foreach ($collab as $key => $value) {
                                        if ($current_userEmployerID == $key) {
                                            if (in_array($current_userEmployeeID, $value['assigned_to_id'])) {
                                                if (!in_array($mainID, $list_array)) {
                                                    array_push($list_array, $mainID);

                                                    $array_name_id = explode(", ", $parentName);
                                                    // if ( count($array_name_id) == 4 AND $type_id == 0 ) {
                                                    if ( count($array_name_id) == 4 ) {
                                                        $data_name = array();

                                                        $selectType = mysqli_query($conn,"SELECT * FROM tbl_library_type WHERE ID = '".$array_name_id[0]."'");
                                                        if ( mysqli_num_rows($selectType) > 0 ) {
                                                            while($rowType = mysqli_fetch_array($selectType)) {
                                                                array_push($data_name, $rowType["name"]);
                                                            }
                                                        }

                                                        $selectCategory = mysqli_query($conn,"SELECT * FROM tbl_library_category WHERE ID = '".$array_name_id[1]."'");
                                                        if ( mysqli_num_rows($selectCategory) > 0 ) {
                                                            while($rowCategory = mysqli_fetch_array($selectCategory)) {
                                                                array_push($data_name, $rowCategory["name"]);
                                                            }
                                                        }

                                                        $selectScope = mysqli_query($conn,"SELECT * FROM tbl_library_scope WHERE ID = '".$array_name_id[2]."'");
                                                        if ( mysqli_num_rows($selectScope) > 0 ) {
                                                            while($rowScope = mysqli_fetch_array($selectScope)) {
                                                                array_push($data_name, $rowScope["name"]);
                                                            }
                                                        }

                                                        $selectModule = mysqli_query($conn,"SELECT * FROM tbl_library_module WHERE ID = '".$array_name_id[3]."'");
                                                        if ( mysqli_num_rows($selectModule) > 0 ) {
                                                            while($rowModule = mysqli_fetch_array($selectModule)) {
                                                                array_push($data_name, $rowModule["name"]);
                                                            }
                                                        }

                                                        $parentName = implode(" - ",$data_name);
                                                    }

                                                    if($parentID == 0) { $parentID = '#'; }

                                                    $output = array(
                                                        "id" => $mainID,
                                                        "parent" => $parentID,
                                                        "state" => 'close',
                                                        "text" => htmlentities($parentName ?? '')
                                                    );
                                                    array_push($result, $output);
                                                }
                                                // if (!empty($file_name)) {
                                                //     $output = array(
                                                //         // "id" => $file_ID,
                                                //         "id" => $mainID.'_'.$file_ID,
                                                //         "parent" => $mainID,
                                                //         "state" => 'close',
                                                //         "text" => htmlentities($file_name ?? ''),
                                                //         "type" => 'file'
                                                //     );
                                                //     array_push($result, $output);
                                                // }
                                            }
                                        }
                                    }
                                }
                            } else {
                                if (!in_array($mainID, $list_array)) {
                                    array_push($list_array, $mainID);

                                    $array_name_id = explode(", ", $parentName);
                                    if ( count($array_name_id) == 4 AND $type_id == 0 ) {
                                        $data_name = array();

                                        $selectType = mysqli_query($conn,"SELECT * FROM tbl_library_type WHERE ID = '".$array_name_id[0]."'");
                                        if ( mysqli_num_rows($selectType) > 0 ) {
                                            while($rowType = mysqli_fetch_array($selectType)) {
                                                array_push($data_name, $rowType["name"]);
                                            }
                                        }

                                        $selectCategory = mysqli_query($conn,"SELECT * FROM tbl_library_category WHERE ID = '".$array_name_id[1]."'");
                                        if ( mysqli_num_rows($selectCategory) > 0 ) {
                                            while($rowCategory = mysqli_fetch_array($selectCategory)) {
                                                array_push($data_name, $rowCategory["name"]);
                                            }
                                        }

                                        $selectScope = mysqli_query($conn,"SELECT * FROM tbl_library_scope WHERE ID = '".$array_name_id[2]."'");
                                        if ( mysqli_num_rows($selectScope) > 0 ) {
                                            while($rowScope = mysqli_fetch_array($selectScope)) {
                                                array_push($data_name, $rowScope["name"]);
                                            }
                                        }

                                        $selectModule = mysqli_query($conn,"SELECT * FROM tbl_library_module WHERE ID = '".$array_name_id[3]."'");
                                        if ( mysqli_num_rows($selectModule) > 0 ) {
                                            while($rowModule = mysqli_fetch_array($selectModule)) {
                                                array_push($data_name, $rowModule["name"]);
                                            }
                                        }

                                        $parentName = implode(" - ",$data_name);
                                    }

                                    if($parentID == 0) { $parentID = '#'; }

                                    $output = array(
                                        "id" => $mainID,
                                        "parent" => $parentID,
                                        "state" => 'close',
                                        "text" => htmlentities($parentName ?? '')
                                    );
                                    array_push($result, $output);
                                }
                                // if (!empty($file_name)) {
                                //     // if (!in_array($file_ID, $list_array)) {
                                //     //     array_push($list_array, $file_ID);
                                //         $output = array(
                                //             "id" => $mainID.'_'.$file_ID,
                                //             "parent" => $mainID,
                                //             "state" => 'close',
                                //             "text" => htmlentities($file_name ?? ''),
                                //             "type" => 'file'
                                //         );
                                //         array_push($result, $output);
                                //     // }
                                // }
                            }
                        }
			         }
				}
	        }
	    }

		echo json_encode($result);
	}

	// Item Section
    if( isset($_GET['modalChanges_Area']) ) {
        $ID = $_GET['modalChanges_Area'];

        $selectData = mysqli_query( $conn,"SELECT * FROM tbl_library WHERE ID = $ID" );
        if ( mysqli_num_rows($selectData) > 0 ) {
            $row = mysqli_fetch_array($selectData);
            $arr_tmp = json_decode($row["description_tmp"],true);
            $lastDescription = end($arr_tmp)['description'];

            $lastStatus = 'Pending';
            if (end($arr_tmp)['approved'] > 0) { $lastStatus = 'Approved'; }
            if (end($arr_tmp)['reviewed'] > 0) { $lastStatus = 'Reviewed'; }

            $lastComment = 'No comment';
            if (!empty(end($arr_tmp)['comment'])) {
                $lastComment = '<ul>';

                    $items = explode(' | ',end($arr_tmp)['comment']);
                    foreach($items as $item){
                        $lastComment .= '<li>'.$item.'</li>';
                    }

                $lastComment .= '</ul>';
            }

            echo '<input type="hidden" name="ID" value="'.$ID.'" />
            <b>Changes:</b><br>'.$lastDescription.'<br><br>
            <b>Status:</b> '.$lastStatus.'<br><br>
            <b>Comment(s):</b><br>'.$lastComment.'<br><br>

            <textarea class="form-control margin-bottom-15" name="comment"></textarea>
            <button type="submit" class="btn green ladda-button" name="btnComment_changes" id="btnComment_changes" data-style="zoom-out"><span class="ladda-label">Comment</span></button>';
        }
    }
    if( isset($_GET['modalChangesAccept_Area']) ) {
        $ID = $_GET['modalChangesAccept_Area'];

        if (!empty($_COOKIE['switchAccount'])) {
            $portal_user = $_COOKIE['ID'];
            $user_id = $_COOKIE['switchAccount'];
        }
        else {
            $portal_user = $_COOKIE['ID'];
            $user_id = employerID($portal_user);
        }

        $selectData = mysqli_query( $conn,"SELECT * FROM tbl_library WHERE ID = $ID" );
        if ( mysqli_num_rows($selectData) > 0 ) {
            $row = mysqli_fetch_array($selectData);
            $jsonArray = $row["description_tmp"];
            $phpArray = json_decode($jsonArray, true);
            $lastDescription = end($phpArray)['description'];
            $description_reviewed = 0;
            $description_approved = 0;
            if ($row["reviewer"] == $portal_user) {
                $description_reviewed = 1;
                $phpArray[key($phpArray)]['reviewed'] = 1;
            }
            if ($row["approver"] == $portal_user) {
                $description_approved = 1;
                $phpArray[key($phpArray)]['approved'] = 1;
            }
            $jsonArray = json_encode($phpArray, JSON_HEX_APOS | JSON_UNESCAPED_UNICODE);
            mysqli_query( $conn,"UPDATE tbl_library set description_tmp='". $jsonArray ."', description_reviewed = $description_reviewed, description_approved = $description_approved WHERE ID = $ID" );


            if ($description_reviewed == 1 AND $description_approved == 1) {
                mysqli_query( $conn,"UPDATE tbl_library set description = '".$lastDescription."' WHERE ID = $ID" );
            }
        }
    }
    if( isset($_GET['modalChangesReject_Area']) ) {
        $ID = $_GET['modalChangesReject_Area'];

        if (!empty($_COOKIE['switchAccount'])) {
            $portal_user = $_COOKIE['ID'];
            $user_id = $_COOKIE['switchAccount'];
        }
        else {
            $portal_user = $_COOKIE['ID'];
            $user_id = employerID($portal_user);
        }

        $selectData = mysqli_query( $conn,"SELECT * FROM tbl_library WHERE ID = $ID" );
        if ( mysqli_num_rows($selectData) > 0 ) {
            $row = mysqli_fetch_array($selectData);
            $jsonArray = $row["description_tmp"];
            $phpArray = json_decode($jsonArray, true);
            $lastDescription = end($phpArray)['description'];
            $description_reviewed = 1;
            $description_approved = 1;
            if ($row["reviewer"] == $portal_user) {
                $description_reviewed = 0;
                $phpArray[key($phpArray)]['reviewed'] = 0;
            }
            if ($row["approver"] == $portal_user) {
                $description_approved = 0;
                $phpArray[key($phpArray)]['approved'] = 0;
            }
            $jsonArray = json_encode($phpArray, JSON_HEX_APOS | JSON_UNESCAPED_UNICODE);
            mysqli_query( $conn,"UPDATE tbl_library set description_tmp='". $jsonArray ."', description_reviewed = $description_reviewed, description_approved = $description_approved WHERE ID = $ID" );


            if ($description_reviewed == 1 AND $description_approved == 1) {
                mysqli_query( $conn,"UPDATE tbl_library set description = '".$lastDescription."' WHERE ID = $ID" );
            }
        }
    }
	if( isset($_GET['modalEdit_Area']) ) {
		$id = $_GET['modalEdit_Area'];

        if (!empty($_COOKIE['switchAccount'])) {
            $portal_user = $_COOKIE['ID'];
            $user_id = $_COOKIE['switchAccount'];
        }
        else {
            $portal_user = $_COOKIE['ID'];
            $user_id = employerID($portal_user);
        }

        $current_client = 0;
        if (isset($_COOKIE['client'])) { $current_client = $_COOKIE['client']; }

		$selectData = mysqli_query( $conn,"SELECT * FROM tbl_library WHERE ID = $id" );
		if ( mysqli_num_rows($selectData) > 0 ) {
            $row = mysqli_fetch_array($selectData);
            $library_name = $row["name"];
            $array_name_id = explode(", ", $library_name);
        }

		echo '<input class="form-control" type="hidden" name="ID" value="'. $row['ID'] .'" />
		<div class="form-group">
            <label class="col-md-3 control-label">Business Type</label>
            <div class="col-md-8">';

            	if ($current_client == 1) {
            		$resultType = mysqli_query( $conn,"SELECT * FROM tbl_library_type WHERE ID = $array_name_id[0] ORDER BY name" );
                    if ( mysqli_num_rows($resultType) > 0 ) {
                        while($rowType = mysqli_fetch_array($resultType)) {
                        	$type_ID = $rowType["ID"];
	                        $type_name = $rowType["name"];
                        }
                    }
                    echo '<input type="hidden" class="hide" name="type" value="16" />
                    <input type="text" class="form-control" name="type_others" value="'.$type_name.'" />';
            	} else {
            		echo '<select class="form-control" name="type" onchange="changedType(this.value)">
	                    <option value="">Select</option>';

	                    $resultType = mysqli_query( $conn,"SELECT * FROM tbl_library_type WHERE ID<>16 ORDER BY name" );
	                    if ( mysqli_num_rows($resultType) > 0 ) {
	                        while($rowType = mysqli_fetch_array($resultType)) {
	                            $type_ID = $rowType["ID"];
	                            $type_name = $rowType["name"];

	                            if ($array_name_id[0] == $type_ID) {
	                            	echo '<option value="'.$type_ID.'" SELECTED>'.$type_name.'</option>';
	                            } else {
	                            	echo '<option value="'.$type_ID.'">'.$type_name.'</option>';
	                            }
	                        }
	                    }

	                	echo '<option value="16">Others</option>
	                </select>
	                <input type="text" class="form-control hide type_others" name="type_others" placeholder="Enter Business Type Name" style="margin-top: 15px;" />
	                <span class="help-block" style="margin: 0;">Services / Product</span>';
            	}
                
            echo '</div>
        </div>
        <div class="form-group '; echo $current_client == 1 ? 'hide':''; echo '">
            <label class="col-md-3 control-label">Category</label>
            <div class="col-md-8">
                <select class="form-control" name="category" onchange="changedCategory(this.value)">
                    <option value="">Select</option>';
                    
                    $resultCategory = mysqli_query( $conn,"SELECT * FROM tbl_library_category WHERE ID<>9 ORDER BY name" );
                    if ( mysqli_num_rows($resultCategory) > 0 ) {
                        while($rowCategory = mysqli_fetch_array($resultCategory)) {
                            $category_ID = $rowCategory["ID"];
                            $category_name = $rowCategory["name"];

                            if ($array_name_id[1] == $category_ID) {
                            	echo '<option value="'.$category_ID.'" SELECTED>'.$category_name.'</option>';
                            } else {
                            	echo '<option value="'.$category_ID.'">'.$category_name.'</option>';
                            }
                        }
                    }
                    
                	echo '<option value="9">Others</option>
                </select>
                <input type="text" class="form-control hide category_others" name="category_others" placeholder="Enter Category Name" style="margin-top: 15px;" />
            </div>
        </div>
        <div class="form-group '; echo $current_client == 1 ? 'hide':''; echo '">
            <label class="col-md-3 control-label">Scope</label>
            <div class="col-md-8">
                <select class="form-control" name="scope" onchange="changedScope(this.value)">
                    <option value="">Select</option>';
                    
                    $resultScope = mysqli_query( $conn,"SELECT * FROM tbl_library_scope WHERE ID<>5 ORDER BY name" );
                    if ( mysqli_num_rows($resultScope) > 0 ) {
                        while($rowScope = mysqli_fetch_array($resultScope)) {
                            $scope_ID = $rowScope["ID"];
                            $scope_name = $rowScope["name"];

                            if ($array_name_id[2] == $scope_ID) {
                            	echo '<option value="'.$scope_ID.'" SELECTED>'.$scope_name.'</option>';
                            } else {
                            	echo '<option value="'.$scope_ID.'">'.$scope_name.'</option>';
                            }
                        }
                    }
                    
                	echo '<option value="5">Others</option>
                </select>
                <input type="text" class="form-control hide scope_others" name="scope_others" placeholder="Enter Scope Name" style="margin-top: 15px;" />
                <span class="help-block" style="margin: 0;">Certification / Accreditation / Regulatory</span>
            </div>
        </div>
        <div class="form-group '; echo $current_client == 1 ? 'hide':''; echo '">
            <label class="col-md-3 control-label">Module / Section</label>
            <div class="col-md-8">
                <select class="form-control" name="module" onchange="changedModule(this.value)">
                    <option value="">Select</option>';
                    
                    $resultModule = mysqli_query( $conn,"SELECT * FROM tbl_library_module WHERE ID<>13 ORDER BY name" );
                    if ( mysqli_num_rows($resultModule) > 0 ) {
                        while($rowModule = mysqli_fetch_array($resultModule)) {
                            $module_ID = $rowModule["ID"];
                            $module_name = $rowModule["name"];

                            if ($array_name_id[3] == $module_ID) {
                            	echo '<option value="'.$module_ID.'" SELECTED>'.$module_name.'</option>';
                            } else {
                            	echo '<option value="'.$module_ID.'">'.$module_name.'</option>';
                            }
                        }
                    }
                   	
                	echo '<option value="13">Others</option>
                </select>
                <input type="text" class="form-control hide module_others" name="module_others" placeholder="Enter Module / Section Name" style="margin-top: 15px;" />
            </div>
        </div>
        <div class="form-group '; echo $user_id == 464 ? '':'hide'; echo '">
            <label class="col-md-3 control-label">Reviewer</label>
            <div class="col-md-8">
                <input type="hidden" name="reviewer_tmp" value="'.$row["reviewer"].'" />
                <select class="form-control mt-multiselect" name="reviewer">
                    <option value="">Select</option>';
                    $selectEmployeee = mysqli_query( $conn,"SELECT 
                        u.ID AS u_ID,
                        e.ID AS e_ID,
                        e.first_name AS e_first_name,
                        e.last_name AS e_last_name
                        FROM tbl_hr_employee AS e

                        INNER JOIN (
                            SELECT
                            *
                            FROM tbl_user
                        ) AS u
                        ON e.ID = u.employee_id

                        WHERE e.suspended = 0 
                        AND e.status = 1 
                        AND e.user_id = $user_id 

                        ORDER BY e.first_name" );
                    if ( mysqli_num_rows($selectEmployeee) > 0 ) {
                        while($rowEmployee = mysqli_fetch_array($selectEmployeee)) {
                            $emp_ID = $rowEmployee["u_ID"];
                            $emp_name = $rowEmployee["e_first_name"] .' '. $rowEmployee["e_last_name"];

                            echo '<option value="'.$emp_ID.'" '; echo $row["reviewer"] == $emp_ID ? 'selected':''; echo '>'.$emp_name.'</option>';
                        }
                    }
                echo '</select>
            </div>
        </div>
        <div class="form-group '; echo $user_id == 464 ? '':'hide'; echo '">
            <label class="col-md-3 control-label">Approver</label>
            <div class="col-md-8">
                <input type="hidden" name="approver_tmp" value="'.$row["approver"].'" />
                <select class="form-control mt-multiselect" name="approver">
                    <option value="">Select</option>';
                    $selectEmployeee = mysqli_query( $conn,"SELECT 
                        u.ID AS u_ID,
                        e.ID AS e_ID,
                        e.first_name AS e_first_name,
                        e.last_name AS e_last_name
                        FROM tbl_hr_employee AS e

                        INNER JOIN (
                            SELECT
                            *
                            FROM tbl_user
                        ) AS u
                        ON e.ID = u.employee_id

                        WHERE e.suspended = 0 
                        AND e.status = 1 
                        AND e.user_id = $user_id 

                        ORDER BY e.first_name" );
                    if ( mysqli_num_rows($selectEmployeee) > 0 ) {
                        while($rowEmployee = mysqli_fetch_array($selectEmployeee)) {
                            $emp_ID = $rowEmployee["u_ID"];
                            $emp_name = $rowEmployee["e_first_name"] .' '. $rowEmployee["e_last_name"];

                            echo '<option value="'.$emp_ID.'" '; echo $row["approver"] == $emp_ID ? 'selected':''; echo '>'.$emp_name.'</option>';
                        }
                    }
                echo '</select>
            </div>
        </div>
        <div class="form-group">
            <label class="col-md-3 control-label">Description</label>
            <div class="col-md-8">
                <input type="hidden" name="description_tmp" value="'.$row['description'].'">
                <textarea class="form-control summernote" name="description" onkeyup="description_count(\'Edit\')">'. $row['description'] .'</textarea>
                <span class="words_count label label-sm label-info hide"><span class="textcount">'.strlen($row['description']).'</span></span>
            </div>
        </div>';

        mysqli_close($conn);
	}
	if( isset($_GET['modalSubItem_Area']) ) {
		$id = $_GET['modalSubItem_Area'];
		$type = $_GET['type'];
		$today = date('Y-m-d');

		echo '<input class="form-control" type="hidden" name="parent_id" value="'. $id .'" />
		<input class="form-control" type="hidden" name="type" value="'. $type .'" />
		<div class="form-group">
            <label class="col-md-3 control-label">Item Name</label>
            <div class="col-md-8">
                <input class="form-control" type="text" name="name" required />
            </div>
        </div>
        <div class="form-group">
            <label class="col-md-3 control-label">Item Description</label>
            <div class="col-md-8">
                <textarea class="form-control" name="description" required></textarea>
            </div>
        </div>
        <div class="form-group">
            <label class="col-md-3 control-label">Due Date</label>
            <div class="col-md-8">
                <input class="form-control" type="date" name="due_date" value="'.$today.'" required />
            </div>
        </div>';
	}
	if( isset($_GET['modalEdit_SubItem']) ) {
		$id = $_GET['modalEdit_SubItem'];
		$current_userID = $_COOKIE['ID'];

		$selectData = mysqli_query( $conn,"SELECT * FROM tbl_library WHERE ID = $id" );
		if ( mysqli_num_rows($selectData) > 0 ) {
            $row = mysqli_fetch_array($selectData);
        }

		echo '<input class="form-control" type="hidden" name="parent_id" value="'. $id .'" />
		<div class="form-group">
            <label class="col-md-3 control-label">Item Type</label>
            <div class="col-md-8">
            	<select class="form-control" name="type" required>
            		<option value="1" '; echo $row['type'] === "1" ? "SELECTED" : ""; echo '>Program</option>
            		<option value="2" '; echo $row['type'] === "2" ? "SELECTED" : ""; echo '>Policy</option>
            		<option value="3" '; echo $row['type'] === "3" ? "SELECTED" : ""; echo '>Procedure</option>
            		<option value="4" '; echo $row['type'] === "4" ? "SELECTED" : ""; echo '>Training</option>
            		<option value="5" '; echo $row['type'] === "5" ? "SELECTED" : ""; echo '>Form</option>
            	</select>
            </div>
        </div>
		<div class="form-group">
            <label class="col-md-3 control-label">Item Name</label>
            <div class="col-md-8">
                <input class="form-control" type="text" name="name" value="'. $row['name'] .'" required />
            </div>
        </div>
        <div class="form-group">
            <label class="col-md-3 control-label">Item Description</label>
            <div class="col-md-8">
                <textarea class="form-control" name="description" required>'. $row['description'] .'</textarea>
            </div>
        </div>
        <div class="form-group">
            <label class="col-md-3 control-label">Due Date</label>
            <div class="col-md-8">
                <input class="form-control" type="date" name="due_date" value="'. date("Y-m-d", strtotime($row['due_date'])) .'" required />
            </div>
        </div>';

        mysqli_close($conn);
	}
	if( isset($_GET['btnDelete_Area']) ) {
		if (!empty($_COOKIE['switchAccount'])) {
			$portal_user = $_COOKIE['ID'];
			$user_id = $_COOKIE['switchAccount'];
		}
		else {
			$portal_user = $_COOKIE['ID'];
			$user_id = employerID($portal_user);
		}
		
		$id = $_GET['btnDelete_Area'];
    	$current_userID = $_COOKIE['ID'];
		$reason = addslashes($_GET['reason']);

        $message = array();
		array_push($message, $current_userID);
		array_push($message, $reason);
		$message = implode(" | ",$message);

		mysqli_query( $conn,"UPDATE tbl_library SET reason = '". $message ."' WHERE ID='". $id ."'" );

		$selectData = mysqli_query( $conn,'SELECT * FROM tbl_library WHERE ID="'. $id .'"' );
		$rowData = mysqli_fetch_array($selectData);
        $data_parent_id = $rowData['parent_id'];

        if ($data_parent_id > 0) {
        	$data_parent = $rowData['parent_id'];
        } else {
        	$data_parent = $id;
        }
		
		// Update History Data
		actionHistory($data_parent, 3, 0, $id);
		
		
		// EMAIL NOTIFICATION
		// Data
		$selectLibrary = mysqli_query( $conn,"SELECT * FROM tbl_library WHERE ID = $id" );
		if ( mysqli_num_rows($selectLibrary) > 0 ) {
		    $rowLibrary = mysqli_fetch_array($selectLibrary);
		    $library_name = $rowLibrary['name'];

            $array_name_id = explode(", ", $library_name);
            if ( count($array_name_id) == 4 ) {
                $data_name = array();

                $selectType = mysqli_query($conn,"SELECT * FROM tbl_library_type WHERE ID = '".$array_name_id[0]."'");
                if ( mysqli_num_rows($selectType) > 0 ) {
                    while($rowType = mysqli_fetch_array($selectType)) {
                        array_push($data_name, $rowType["name"]);
                    }
                }

                $selectCategory = mysqli_query($conn,"SELECT * FROM tbl_library_category WHERE ID = '".$array_name_id[1]."'");
                if ( mysqli_num_rows($selectCategory) > 0 ) {
                    while($rowCategory = mysqli_fetch_array($selectCategory)) {
                        array_push($data_name, $rowCategory["name"]);
                    }
                }

                $selectScope = mysqli_query($conn,"SELECT * FROM tbl_library_scope WHERE ID = '".$array_name_id[2]."'");
                if ( mysqli_num_rows($selectScope) > 0 ) {
                    while($rowScope = mysqli_fetch_array($selectScope)) {
                        array_push($data_name, $rowScope["name"]);
                    }
                }

                $selectModule = mysqli_query($conn,"SELECT * FROM tbl_library_module WHERE ID = '".$array_name_id[3]."'");
                if ( mysqli_num_rows($selectModule) > 0 ) {
                    while($rowModule = mysqli_fetch_array($selectModule)) {
                        array_push($data_name, $rowModule["name"]);
                    }
                }

                $library_name = implode(" - ",$data_name);
            }
		}

		// Requester
		$selectUserReq = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $portal_user" );
		if ( mysqli_num_rows($selectUserReq) > 0 ) {
		    $rowUserReq = mysqli_fetch_array($selectUserReq);
		    $user_name_req = $rowUserReq['first_name'] .' '. $rowUserReq['last_name'];
		}

		// Employer (Receiver)
		$selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $user_id" );
		if ( mysqli_num_rows($selectUser) > 0 ) {
		    $rowUser = mysqli_fetch_array($selectUser);
		    $user_name = $rowUser['first_name'] .' '. $rowUser['last_name'];
		    $user_email = $rowUser['email'];
		}

		$to = $user_email;
		$user = $user_name;
		$subject = 'Delete Request for Dashboard Item';
		$body = 'Hi '.$user.',<br><br>

		'.$user_name_req.' is requesting to delete <b>'.$library_name.'</b> dashboard item. The reason is '.$reason.'.<br><br>

		Please click the button below to view the item<br><br>

		<a href="'. $base_url .'dashboard?d='. $id .'" target="_blank" style="font-weight: 600; padding: 10px 20px!important; text-decoration: none; color: #fff; background-color: #27a4b0; border-color: #208992; display: inline-block;">View</a>';

		$mail = php_mailer($to, $user, $subject, $body);
	}
	if( isset($_POST['btnSave_Area']) ) {
		if (!empty($_COOKIE['switchAccount'])) {
			$portal_user = $_COOKIE['ID'];
			$user_id = $_COOKIE['switchAccount'];
		}
		else {
			$portal_user = $_COOKIE['ID'];
			$user_id = employerID($portal_user);
		}

        $hasLibrary = mysqli_query( $conn,"SELECT * FROM tbl_library WHERE user_id = $user_id" );
        if ( mysqli_num_rows($hasLibrary) == 0 ) {
            $user_id = 163;
        }

		$description = addslashes($_POST['description']);


        $reviewer = 0;
        if (!empty($_POST['reviewer'])) {
            $reviewer = $_POST['reviewer'];
        }

        $approver = 0;
        if (!empty($_POST['approver'])) {
            $approver = $_POST['approver'];
        }
        
		$due_date = "0000-00-00";
		$last_modified = date('Y-m-d');

		$type = $_POST['type'];
		if ($type == 16 AND !empty($_POST['type_others'])) {
			$type_others = addslashes($_POST['type_others']);
			$sql = "INSERT INTO tbl_library_type (name) VALUES ('$type_others')";
			if (mysqli_query($conn, $sql)) { $type = mysqli_insert_id($conn); }
		}

		$category = $_POST['category'];
		if ($category == 9 AND !empty($_POST['category_others'])) {
			$category_others = addslashes($_POST['category_others']);
			$sql = "INSERT INTO tbl_library_category (name) VALUES ('$category_others')";
			if (mysqli_query($conn, $sql)) { $category = mysqli_insert_id($conn); }
		}

		$scope = $_POST['scope'];
		if ($scope == 5 AND !empty($_POST['scope_others'])) {
			$scope_others = addslashes($_POST['scope_others']);
			$sql = "INSERT INTO tbl_library_scope (name) VALUES ('$scope_others')";
			if (mysqli_query($conn, $sql)) { $scope = mysqli_insert_id($conn); }
		}

		$module = $_POST['module'];
		if ($module == 13 AND !empty($_POST['module_others'])) {
			$module_others = addslashes($_POST['module_others']);
			$sql = "INSERT INTO tbl_library_module (name) VALUES ('$module_others')";
			if (mysqli_query($conn, $sql)) { $module = mysqli_insert_id($conn); }
		}

		$name_id = array();
		array_push($name_id, $type);
		array_push($name_id, $category);
		array_push($name_id, $scope);
		array_push($name_id, $module);
		$name_id = implode(", ",$name_id);

		$sql = "INSERT INTO tbl_library (user_id, portal_user, name, description, reviewer, approver, due_date, last_modified)
		VALUES ('$user_id', '$portal_user', '$name_id', '$description', '$reviewer', '$approver', '$due_date', '$last_modified')";
		
		if (mysqli_query($conn, $sql)) {

			$last_id = mysqli_insert_id($conn);

			$selectData = mysqli_query( $conn,'SELECT * FROM tbl_library WHERE user_id="'. $user_id .'" AND ID="'. $last_id .'" ORDER BY ID LIMIT 1' );
			if ( mysqli_num_rows($selectData) > 0 ) {
				$rowData = mysqli_fetch_array($selectData);
				$data_ID = $rowData['ID'];
				$data_name = $rowData['name'];
				$data_description = $rowData['description'];

				$data_name = array();
				if (!empty($type)) {
					$selectType = mysqli_query( $conn,'SELECT * FROM tbl_library_type WHERE ID="'. $type .'"' );
					$rowType = mysqli_fetch_array($selectType);
					$data_type = $rowType['name'];
					array_push($data_name, $data_type);
				}
				if (!empty($category)) {
					$selectCategory = mysqli_query( $conn,'SELECT * FROM tbl_library_category WHERE ID="'. $category .'"' );
					$rowCategory = mysqli_fetch_array($selectCategory);
					$data_category = $rowCategory['name'];
					array_push($data_name, $data_category);
				}
				if (!empty($scope)) {
					$selectScope = mysqli_query( $conn,'SELECT * FROM tbl_library_scope WHERE ID="'. $scope .'"' );
					$rowScope = mysqli_fetch_array($selectScope);
					$data_scope = $rowScope['name'];
					array_push($data_name, $data_scope);
				}
				if (!empty($module)) {
					$selecwModule = mysqli_query( $conn,'SELECT * FROM tbl_library_module WHERE ID="'. $module .'"' );
					$rowModule = mysqli_fetch_array($selecwModule);
					$data_module = $rowModule['name'];
					array_push($data_name, $data_module);
				}
				$data_name = implode(" - ",$data_name);

				$output = array(
					"ID" => $data_ID,
					"name" => stripcslashes($data_name),
					"description" => stripcslashes($data_description)
				);
				echo json_encode($output);

				// Update History Data
				actionHistory($data_ID, 1, 0, $data_ID);
			}
		} else {
            echo "Error: " . $sql . "<br>" . mysqli_error($conn);
        }
		mysqli_close($conn);
	}
	if( isset($_POST['btnUpdate_Area']) ) {
		$ID = $_POST['ID'];

        if (!empty($_COOKIE['switchAccount'])) {
            $portal_user = $_COOKIE['ID'];
            $user_id = $_COOKIE['switchAccount'];
        }
        else {
            $portal_user = $_COOKIE['ID'];
            $user_id = employerID($portal_user);
        }

		$type = $_POST['type'];
		if ($type == 16 AND !empty($_POST['type_others'])) {
			$type_others = addslashes($_POST['type_others']);
			$sql = "INSERT INTO tbl_library_type (name) VALUES ('$type_others')";
			if (mysqli_query($conn, $sql)) { $type = mysqli_insert_id($conn); }
		}

		$category = $_POST['category'];
		if ($category == 9 AND !empty($_POST['category_others'])) {
			$category_others = addslashes($_POST['category_others']);
			$sql = "INSERT INTO tbl_library_category (name) VALUES ('$category_others')";
			if (mysqli_query($conn, $sql)) { $category = mysqli_insert_id($conn); }
		}

		$scope = $_POST['scope'];
		if ($scope == 5 AND !empty($_POST['scope_others'])) {
			$scope_others = addslashes($_POST['scope_others']);
			$sql = "INSERT INTO tbl_library_scope (name) VALUES ('$scope_others')";
			if (mysqli_query($conn, $sql)) { $scope = mysqli_insert_id($conn); }
		}

		$module = $_POST['module'];
		if ($module == 13 AND !empty($_POST['module_others'])) {
			$module_others = addslashes($_POST['module_others']);
			$sql = "INSERT INTO tbl_library_module (name) VALUES ('$module_others')";
			if (mysqli_query($conn, $sql)) { $module = mysqli_insert_id($conn); }
		}

		$name_id = array();
		array_push($name_id, $type);
		array_push($name_id, $category);
		array_push($name_id, $scope);
		array_push($name_id, $module);
		$name_id = implode(", ",$name_id);

        mysqli_query( $conn,"UPDATE tbl_library set name='". $name_id ."' WHERE ID='". $ID ."'" );

        if ($_POST['reviewer'] <> $_POST['reviewer_tmp']) {
            $reviewer = $_POST['reviewer'];
            mysqli_query( $conn,"UPDATE tbl_library set description_reviewed = 0, description_approved = 0, reviewer = '".$reviewer."' WHERE ID = $ID" );
        }
        if ($_POST['approver'] <> $_POST['approver_tmp']) {
            $approver = $_POST['approver'];
            mysqli_query( $conn,"UPDATE tbl_library set description_approved = 0, approver = '".$approver."' WHERE ID = $ID" );
        }

        $description = addslashes($_POST['description']);
        $description_tmp = addslashes($_POST['description_tmp']);
        if ($user_id == 464) {
            if ($description <> $description_tmp) {
                $arr_tmp = array();
                $selectDesc = mysqli_query( $conn,"SELECT * FROM tbl_library WHERE ID=$ID" );
                $rowDesc = mysqli_fetch_array($selectDesc);
                if (!empty($rowDesc["description_tmp"])) {
                    $arr_tmp = json_decode($rowDesc["description_tmp"],true);
                }

                $desc_tmp = array (
                    'reviewed'   =>  0,
                    'approved'   =>  0,
                    'description'  =>  addslashes($description),
                    'comment'  =>  ''
                );
                array_push($arr_tmp, $desc_tmp);
                $description = json_encode($arr_tmp, JSON_HEX_APOS | JSON_UNESCAPED_UNICODE);

                mysqli_query( $conn,"UPDATE tbl_library set description_reviewed = 0, description_approved = 0, description_tmp = '".$description."' WHERE ID = $ID" );
            }
        } else {
            mysqli_query( $conn,"UPDATE tbl_library set description_reviewed = 0, description_approved = 0, description = '".$description."' WHERE ID = $ID" );
            $description_tmp = $description;
        }
		
		if (!mysqli_error($conn)) {
			$data_name = array();
			if (!empty($type)) {
				$selectType = mysqli_query( $conn,'SELECT * FROM tbl_library_type WHERE ID="'. $type .'"' );
				$rowType = mysqli_fetch_array($selectType);
				$data_type = $rowType['name'];
				array_push($data_name, $data_type);
			}
			if (!empty($category)) {
				$selectCategory = mysqli_query( $conn,'SELECT * FROM tbl_library_category WHERE ID="'. $category .'"' );
				$rowCategory = mysqli_fetch_array($selectCategory);
				$data_category = $rowCategory['name'];
				array_push($data_name, $data_category);
			}
			if (!empty($scope)) {
				$selectScope = mysqli_query( $conn,'SELECT * FROM tbl_library_scope WHERE ID="'. $scope .'"' );
				$rowScope = mysqli_fetch_array($selectScope);
				$data_scope = $rowScope['name'];
				array_push($data_name, $data_scope);
			}
			if (!empty($module)) {
				$selecwModule = mysqli_query( $conn,'SELECT * FROM tbl_library_module WHERE ID="'. $module .'"' );
				$rowModule = mysqli_fetch_array($selecwModule);
				$data_module = $rowModule['name'];
				array_push($data_name, $data_module);
			}
			$data_name = implode(" - ",$data_name);

			$output = array(
				'ID' => $ID,
				'name' => stripcslashes($data_name),
				'description' => stripcslashes($description_tmp)
			);
			echo json_encode($output);

			// Update History Data
			actionHistory($ID, 2, 0, $ID);
		}

		mysqli_close($conn);
	}
	if( isset($_POST['btnSave_SubItem']) ) {
		if (!empty($_COOKIE['switchAccount'])) {
			$portal_user = $_COOKIE['ID'];
			$user_id = $_COOKIE['switchAccount'];
		}
		else {
			$portal_user = $_COOKIE['ID'];
			$user_id = employerID($portal_user);
		}

        $free_access = 0;
        $hasLibrary = mysqli_query( $conn,"SELECT * FROM tbl_library WHERE user_id = $user_id" );
        if ( mysqli_num_rows($hasLibrary) == 0 ) {
            $user_id = 163;
            $free_access = 1;
        }

		$parent_id = $_POST['parent_id'];
		$type = $_POST['type'];
		$name = addslashes($_POST['name']);
		$description = addslashes($_POST['description']);
		$due_date = $_POST['due_date'];
		$last_modified = date('Y-m-d');

        $sql = "INSERT INTO tbl_library (user_id, portal_user, parent_id, type, free_access, name, description, due_date, last_modified)
        VALUES ('$user_id', '$portal_user', '$parent_id', '$type', '$free_access', '$name', '$description', '$due_date', '$last_modified')";
		
		//->>>>>>>  START Brandon Auto service log for creating subitem <<<<<<<<-
        
		$current_userID = $_COOKIE['ID'];
		$action = "created";
		$minutes = 1;
		$companyname = "";
		date_default_timezone_set('America/New_York');
		$datenow = date('Y-m-d') ;
		$comment = "Item Name : ".$name . " with the description of : ". $description. " and due date of : " . $due_date . "date uploaded: ".$datenow ;

		if (!empty($_COOKIE['switchAccount'])) {
			$portal_user = $_COOKIE['ID'];
			$user_id_account = $_COOKIE['switchAccount'];
		}
		else {
			$portal_user = $_COOKIE['ID'];
			$user_id_account = employerID($portal_user);
		}

		$resultaccountname = mysqli_query( $conn,'SELECT * FROM tblEnterpiseDetails WHERE users_entities = "'.$user_id_account.'" LIMIT 1 ');
		if ( mysqli_num_rows($resultaccountname) > 0 ) {
			$rowComment = mysqli_fetch_array($resultaccountname);
			$companyname = $rowComment["company_code"];
		}

		$finaldescription = $companyname." - ".$name. "- ".$datenow;

		$sql_subitem_autolog = "INSERT INTO tbl_service_logs_draft (`user_id`, `description`,`action`, `comment`, `account`, `minute` , `task_date`) 
		VALUES ('$current_userID', '$finaldescription','$action','$comment','$companyname','$minutes','$datenow')";

		mysqli_query($conn, $sql_subitem_autolog);


		//->>>>>>> END Brandon Auto service log for  creating subitem <<<<<<<<-

		
		if (mysqli_query($conn, $sql)) {
			$last_id = mysqli_insert_id($conn);

			// Select existing Child IDs and push to an array
			$selectParent = mysqli_query( $conn,'SELECT * FROM tbl_library WHERE ID="'. $parent_id .'"' );
			$rowParent = mysqli_fetch_array($selectParent);

			$child_id = array();
			if ( !empty($rowParent['child_id']) ) {
				array_push($child_id, $rowParent['child_id']);
			}
			array_push($child_id, $last_id);

			// Update parent's record
			$child_id = implode(", ",$child_id);
			mysqli_query( $conn,"UPDATE tbl_library set child_id='". $child_id ."' WHERE ID='". $parent_id ."'" );

			$selectData = mysqli_query( $conn,'SELECT * FROM tbl_library WHERE user_id="'. $user_id .'" AND ID="'. $last_id .'" ORDER BY ID LIMIT 1' );
			if ( mysqli_num_rows($selectData) > 0 ) {
				$rowData = mysqli_fetch_array($selectData);
				$data_ID = $rowData['ID'];
				$data_parent_id = $rowData['parent_id'];
				$data_type = $rowData['type'];
				$data_name = $rowData['name'];
				$data_description = $rowData['description'];

				$output = array(
					"item_id" => $data_ID,
					"parent_id" => $data_parent_id,
					"type" => $data_type,
                    "name" => stripcslashes(htmlentities($data_name ?? '')),
                    "description" => stripcslashes(htmlentities($data_description ?? '')),
				);

				// Update History Data
				actionHistory($data_parent_id, 1, 0, $data_ID);
			}
		}
		mysqli_close($conn);

		echo json_encode($output);
	}
	if( isset($_POST['btnUpdate_Area_SubItem']) ) {
		$parent_id = $_POST['parent_id'];
		$type = $_POST['type'];
		$name = addslashes($_POST['name']);
		$description = addslashes($_POST['description']);
		$due_date = $_POST['due_date'];
		$last_modified = date('Y-m-d');

		mysqli_query( $conn,"UPDATE tbl_library SET type='". $type ."', name='". $name ."', description='". $description ."', due_date='". $due_date ."', last_modified='". $last_modified ."' WHERE ID='". $parent_id ."'" );
		if (!mysqli_error($conn)) {
			$output = array(
				'ID' => $parent_id,
				'type' => $type,
                'name' => stripcslashes(htmlentities($name ?? '')),
                'description' => stripcslashes(htmlentities($description ?? ''))
			);
			echo json_encode($output);

			$selectData = mysqli_query( $conn,'SELECT * FROM tbl_library WHERE ID="'. $parent_id .'"' );
			$rowData = mysqli_fetch_array($selectData);
	        $data_library_id = $rowData['parent_id'];
			
			// Update History Data
			actionHistory($data_library_id, 2, 0, $parent_id);
		}

		//->>>>>>>  START Brandon Auto service log for Editing Subitem in the dashboard <<<<<<<<-
        
		$current_userID = $_COOKIE['ID'];
		$action = "Edited";
		$minutes = 1;
		$companyname = "";
		$comment = "File name : ".$name . " with the description of : ". $description . "Document Last Modified Date: ". $last_modified . " and due date of: ". $due_date;
		date_default_timezone_set('America/New_York');
		$datenow = date('Y-m-d') ;

		if (!empty($_COOKIE['switchAccount'])) {
			$portal_user = $_COOKIE['ID'];
			$user_id_account = $_COOKIE['switchAccount'];
		}
		else {
			$portal_user = $_COOKIE['ID'];
			$user_id_account = employerID($portal_user);
		}

		$resultaccountname = mysqli_query( $conn,'SELECT * FROM tblEnterpiseDetails WHERE users_entities = "'.$user_id_account.'" LIMIT 1 ');
		if ( mysqli_num_rows($resultaccountname) > 0 ) {
			$rowComment = mysqli_fetch_array($resultaccountname);
			$companyname = $rowComment["company_code"];
		}

        // $finaldescription = $companyname. "-" .$filesrowname;
       	$finaldescription = $companyname."-". $name ."-". $datenow;

		$sql_subitem_autolog = "INSERT INTO tbl_service_logs_draft (`user_id`, `description`,`action`, `comment`, `account`, `minute` , `task_date`) 
		VALUES ('$current_userID', '$finaldescription','$action','$comment','$companyname','$minutes','$datenow')";

		mysqli_query($conn, $sql_subitem_autolog);


		//->>>>>>> END Brandon Auto service log for Editing Subitem in the dashboard <<<<<<<<-


		mysqli_close($conn);
	}
    if( isset($_POST['btnComment_changes']) ) {
        $ID = $_POST['ID'];
        $comment = addslashes($_POST['comment']);

        if (!empty($comment)) {
            $selectData = mysqli_query( $conn,"SELECT * FROM tbl_library WHERE ID=$ID" );
            $row = mysqli_fetch_array($selectData);
            $jsonArray = $row["description_tmp"];

            // Convert JSON to PHP array
            $phpArray = json_decode($jsonArray, true);

            // Get the last item's comment value
            $lastComment = end($phpArray)['comment'];

            // Update the last comment
            $updatedComment = array();
            if (!empty(end($phpArray)['comment'])) {
                $updatedComment = explode(' | ',end($phpArray)['comment']);
            }
            array_push($updatedComment, $comment);
            $updatedComment = implode(' | ', $updatedComment);
            // $updatedComment = $lastComment . ' | updated_comment';

            // Update the array with the new comment
            $phpArray[key($phpArray)]['comment'] = $updatedComment;

            // Convert back to JSON
            // $jsonArray = json_encode($phpArray);
            $jsonArray = json_encode($phpArray, JSON_HEX_APOS | JSON_UNESCAPED_UNICODE);

            mysqli_query( $conn,"UPDATE tbl_library SET description_tmp='". $jsonArray ."' WHERE ID='". $ID ."'" );
            if (!mysqli_error($conn)) {
                echo 'done';
            }
        }
    }

	// File Section
	if( isset($_GET['modalAttached']) ) {
		$id = $_GET['modalAttached'];
		$today = date('Y-m-d');
        $futureDate = date('Y-m-d', strtotime('+1 year'));
        $futureDate = date('Y-m-d', strtotime($futureDate.'-1 day'));

		echo '<input class="form-control" type="hidden" name="parent_id" value="'. $id .'" />
		<div class="form-group">
            <label class="col-md-3 control-label">Select File</label>
            <div class="col-md-8">
                <select class="form-control" name="filetype" onchange="changeType(this)" required>
                    <option value="0">Select option</option>
                    <option value="1">Manual Upload</option>
                    <option value="3">Google Drive URL</option>
                </select>
                <input class="form-control margin-top-15 fileUpload" type="file" name="file" style="display: none;" />
                <input class="form-control margin-top-15 fileURL" type="url" name="fileurl" style="display: none;" placeholder="https://" />
            </div>
        </div>
		<div class="form-group">
            <label class="col-md-3 control-label">File Name</label>
            <div class="col-md-8">
                <input class="form-control" type="text" name="name" required />
            </div>
        </div>
		<div class="form-group">
            <label class="col-md-3 control-label">Document Date</label>
            <div class="col-md-8">
                <input class="form-control" type="date" name="last_modified" value="'.$today.'" required />
            </div>
        </div>
        <div class="form-group">
            <label class="col-md-3 control-label">Due Date</label>
            <div class="col-md-8">
                <input class="form-control" type="date" name="due_date" value="'.$futureDate.'" required />
            </div>
        </div>
        <div class="form-group">
            <label class="col-md-3 control-label">Comment</label>
            <div class="col-md-8">
                <textarea class="form-control" name="comment"></textarea>
            </div>
        </div>
        <div class="form-group hide">
            <p class="col-md-offset-3 col-md-8"><strong>ASSIGNED TO</strong></p>
        </div>';

        mysqli_close($conn);
	}
	if( isset($_GET['modalAttached_Edit']) ) {
		$id = $_GET['modalAttached_Edit'];
        $current_userID = $_COOKIE['ID'];
		$selectData = mysqli_query( $conn,"SELECT * FROM tbl_library_file WHERE ID = $id" );
		if ( mysqli_num_rows($selectData) > 0 ) {
            $row = mysqli_fetch_array($selectData);
            $library_id = $row["library_id"];
            $name = $row["name"];
            $comment = $row["comment"];
            $last_modified = $row["last_modified"];
            $due_date = $row["due_date"];

            $files = '';
            $type = 'iframe';
            if (!empty($row["files"])) {
                $arr_filename = explode(' | ', $row["files"]);
                $arr_filetype = explode(' | ', $row["filetype"]);
                $str_filename = '';

                foreach($arr_filename as $val_filename) {
                    $str_filename = $val_filename;
                }
                foreach($arr_filetype as $val_filetype) {
                    $str_filetype = $val_filetype;
                }

                $files = $str_filename;
                if ($str_filetype == 1) {
                    $fileExtension = fileExtension($str_filename);
                    $src = $fileExtension['src'];
                    $embed = $fileExtension['embed'];
                    $type = $fileExtension['type'];
                    $file_extension = $fileExtension['file_extension'];
                    $url = $base_url.'uploads/library/';

                    $files = $src.$url.rawurlencode($str_filename).$embed;
                } else if ($str_filetype == 3) {
                    $files = preg_replace('#[^/]*$#', '', $str_filename).'preview';
                }
            }
        }

		echo '<input class="form-control" type="hidden" name="ID" value="'. $id .'" />
		<input class="form-control" type="hidden" name="parent_id" value="'. $library_id .'" />
		<div class="form-group">
            <label class="col-md-3 control-label">Select File</label>
            <div class="col-md-8">
                <select class="form-control '; echo !empty($files) ? 'hide':''; echo '" name="filetype" onchange="changeType(this)" required>
                    <option value="0">Select option</option>
                    <option value="1">Manual Upload</option>
                    <option value="3">Google Drive URL</option>
                </select>
                <input class="form-control margin-top-15 fileUpload" type="file" name="file" style="display: none;" />
                <input class="form-control margin-top-15 fileURL" type="url" name="fileurl" style="display: none;" placeholder="https://" />
                <p class="'; echo !empty($files) ? '':'hide'; echo '" style="margin: 0;"><a href="'.$files.'" data-src="'.$files.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a> | <button type="button" class="btn btn-link uploadNew" onclick="uploadNew(this)">Upload New</button></p>
            </div>
        </div>
		<div class="form-group">
            <label class="col-md-3 control-label">File Name</label>
            <div class="col-md-8">
                <input class="form-control" type="text" name="name" value="'. $name .'" required />
            </div>
        </div>
		<div class="form-group">
            <label class="col-md-3 control-label">Document Date</label>
            <div class="col-md-8">
                <input class="form-control" type="date" name="last_modified" value="'. $last_modified .'" required />
            </div>
        </div>
        <div class="form-group">
            <label class="col-md-3 control-label">Due Date</label>
            <div class="col-md-8">
                <input class="form-control" type="date" name="due_date" value="'. $due_date .'" required />
            </div>
        </div>
        <div class="form-group">
            <label class="col-md-3 control-label">Comment</label>
            <div class="col-md-8">
                <textarea class="form-control" name="comment">'. $comment .'</textarea>
            </div>
        </div>';

        mysqli_close($conn);
	}
	if( isset($_GET['btnDelete_File']) ) {
		if (!empty($_COOKIE['switchAccount'])) {
			$portal_user = $_COOKIE['ID'];
			$user_id = $_COOKIE['switchAccount'];
		}
		else {
			$portal_user = $_COOKIE['ID'];
			$user_id = employerID($portal_user);
		}
		
		$id = $_GET['btnDelete_File'];
    	$current_userID = $_COOKIE['ID'];
		$reason = addslashes($_GET['reason']);

        $message = array();
		array_push($message, $current_userID);
		array_push($message, $reason);
		$message = implode(" | ",$message);

		mysqli_query( $conn,"UPDATE tbl_library_file SET reason = '". $message ."' WHERE ID='". $id ."'" );

		$selectData = mysqli_query( $conn,'SELECT * FROM tbl_library_file WHERE ID="'. $id .'"' );
		$rowData = mysqli_fetch_array($selectData);
        $data_library_id = $rowData['library_id'];
        $data_name = $rowData['name'];
		
		// Update History Data
		actionHistory($data_library_id, 3, 1, $id);


		// EMAIL NOTIFICATION
		// Requester
		$selectUserReq = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $portal_user" );
		if ( mysqli_num_rows($selectUserReq) > 0 ) {
		    $rowUserReq = mysqli_fetch_array($selectUserReq);
		    $user_name_req = $rowUserReq['first_name'] .' '. $rowUserReq['last_name'];
		}

		// Employer (Receiver)
		$selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $user_id" );
		if ( mysqli_num_rows($selectUser) > 0 ) {
		    $rowUser = mysqli_fetch_array($selectUser);
		    $user_name = $rowUser['first_name'] .' '. $rowUser['last_name'];
		    $user_email = $rowUser['email'];
		}

		$to = $user_email;
		$user = $user_name;
        if ($_COOKIE['client'] == 1) {
            $subject = 'Delete Request for Dashboard Item';
            $body = 'Hi '.$user.',<br><br>

            '.$user_name_req.' is requesting to delete <b>'.$data_name.'</b>. The reason is '.$reason.'.<br><br>

            Please click the button below to view the item<br><br>

            <a href="'. $base_url .'dashboard?d='. $data_library_id .'" target="_blank" style="font-weight: 600; padding: 10px 20px!important; text-decoration: none; color: #fff; background-color: #27a4b0; border-color: #208992; display: inline-block;">View</a><br><br>

            Cann OS Team';
        } else {
            $subject = 'Delete Request for Dashboard File Item';
            $body = 'Hi '.$user.',<br><br>

            '.$user_name_req.' is requesting to delete <b>'.$data_name.'</b> dashboard file item. The reason is '.$reason.'.<br><br>

            Please click the button below to view the item<br><br>

            <a href="'. $base_url .'dashboard?d='. $data_library_id .'" target="_blank" style="font-weight: 600; padding: 10px 20px!important; text-decoration: none; color: #fff; background-color: #27a4b0; border-color: #208992; display: inline-block;">View</a>';
        }
		$mail = php_mailer($to, $user, $subject, $body);
	}
	if( isset($_POST['btnSave_Attached']) ) {
        if (!empty($_COOKIE['switchAccount'])) {
            $portal_user = $_COOKIE['ID'];
            $user_id = $_COOKIE['switchAccount'];
        }
        else {
            $portal_user = $_COOKIE['ID'];
            $user_id = employerID($portal_user);
        }

    	$current_userID = $_COOKIE['ID'];
		$parent_id = $_POST['parent_id'];
		$name = addslashes($_POST['name']);
		$comment = addslashes($_POST['comment']);
		$last_modified = $_POST['last_modified'];
		$due_date = $_POST['due_date'];
        $arr_item = array();
        $process = true;

        $free_access = 0;
        $hasLibrary = mysqli_query( $conn,"SELECT * FROM tbl_library WHERE user_id = $user_id" );
        if ( mysqli_num_rows($hasLibrary) == 0 ) {
            $user_id = 163;
            $free_access = 1;
        }

        $filetype = $_POST['filetype'];
        if ($filetype == 1) {
            $files = $_FILES['file']['name'];
            if (!empty($files)) {
                $path = 'uploads/library/';
                $filesize = $_FILES['file']['size'];
                $tmp = $_FILES['file']['tmp_name'];
                $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                $ext = strtolower(pathinfo($files, PATHINFO_EXTENSION));
                $files = rand(1000,1000000) . ' - ' . $files;
                $path = $path.$files;

                if(!in_array($ext, $invalid_extensions)) {
                    move_uploaded_file($tmp,$path);
                } else {
                    $process = false;
                }
            }
        } else {
            $files = $_POST['fileurl'];
            $filesize = 0;
        }

        if ($process == true) {
            $output = array (
                'type'  =>  $filetype,
                'name' =>  $files,
                'size' =>  $filesize,
                'date' =>  $local_date
            );
            array_push($arr_item, $output);
            $file_history = json_encode($arr_item, JSON_HEX_APOS | JSON_UNESCAPED_UNICODE);

            $sql = "INSERT INTO tbl_library_file (user_id, library_id, free_access, files, filetype, filesize, file_history, name, comment, due_date, last_modified)
            VALUES ('$current_userID', '$parent_id', '$free_access', '$files', '$filetype', '$filesize', '$file_history', '$name', '$comment', '$due_date', '$last_modified')";
    	
    		//->>>>>>>  START Brandon Auto service log for uploading file to dashboard <<<<<<<<-
            
    		$current_userID = $_COOKIE['ID'];
    		$action = "uploaded";
    		$minutes = 1;
    		$companyname = "";
    		$comment = "File name : ".$name . " with the comment of : ". $comment . "Document Last Modified Date: ". $last_modified . " and due date of: ". $due_date;
    		date_default_timezone_set('America/New_York');
    		$datenow = date('Y-m-d') ;

    		if (!empty($_COOKIE['switchAccount'])) {
    			$portal_user = $_COOKIE['ID'];
    			$user_id_account = $_COOKIE['switchAccount'];
    		}
    		else {
    			$portal_user = $_COOKIE['ID'];
    			$user_id_account = employerID($portal_user);
    		}

    		$resultaccountname = mysqli_query( $conn,'SELECT * FROM tblEnterpiseDetails WHERE users_entities = "'.$user_id_account.'" LIMIT 1 ');
    		if ( mysqli_num_rows($resultaccountname) > 0 ) {
    			$rowComment = mysqli_fetch_array($resultaccountname);
    			$companyname = $rowComment["company_code"];
    		}

            // $finaldescription = $companyname. "-" .$filesrowname;
            $finaldescription = $name;

    		$sql_subitem_autolog = "INSERT INTO tbl_service_logs_draft (`user_id`, `description`,`action`, `comment`, `account`, `minute` , `task_date`) 
    		VALUES ('$current_userID', '$finaldescription','$action','$comment','$companyname','$minutes','$datenow')";

    		mysqli_query($conn, $sql_subitem_autolog);


    		//->>>>>>> END Brandon Auto service log for  uploading file to dashboard <<<<<<<<-

    		if (mysqli_query($conn, $sql)) {
    			$last_id = mysqli_insert_id($conn);

                $resultFiles = mysqli_query( $conn,"SELECT * FROM tbl_library_file WHERE user_id = $current_userID AND ID = $last_id ORDER BY ID LIMIT 1" );
                if ( mysqli_num_rows($resultFiles) > 0 ) {
                    while($rowFiles = mysqli_fetch_array($resultFiles)) {
                        $file_ID = $rowFiles["ID"];
                        $file_name = $rowFiles["name"];
                        $file_comment = $rowFiles["comment"];
                        $file_reason = $rowFiles["reason"];

                        $file_user_id = $rowFiles["user_id"];
                        $selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $file_user_id " );
                        $rowUser = mysqli_fetch_array($selectUser);
                        $file_user = $rowUser["first_name"] .' '. $rowUser["last_name"];

                        $file_due_date = $rowFiles["due_date"];
                        $file_due = $file_due_date;
                        if ($file_due_date != "0000-00-00") {
                            $file_due = new DateTime(substr($file_due_date, 0, 10));
                            $file_due = $file_due->format('M d, Y');
                        }

                        $filetype = $rowFiles['filetype'];
                        $files = $rowFiles["files"];
                        $type = 'iframe';
                        $file_extension = 'fa-youtube-play';
                        if (!empty($files)) {
                            if ($filetype == 1) {
                                $fileExtension = fileExtension($files);
                                $src = $fileExtension['src'];
                                $embed = $fileExtension['embed'];
                                $type = $fileExtension['type'];
                                $file_extension = $fileExtension['file_extension'];
                                $url = $base_url.'uploads/library/';

                                $files = $src.$url.rawurlencode($files).$embed;
                            } else if ($filetype == 3) {
                                $files = preg_replace('#[^/]*$#', '', $files).'preview';
                                $file_extension = 'fa-google';
                            }
                        }

                        $data = '<div class="mt-action mt-action-'.$file_ID.'">
                            <div class="mt-action-body">
                                <div class="mt-action-row">
                                    <div class="mt-action-info">
                                        <div class="mt-action-icon">
                                            <a href="'.$files.'" data-src="'.$files.'" data-fancybox data-type="'.$type.'"><i class="fa fa-fw '. $file_extension .'"></i></a>
                                        </div>
                                        <div class="mt-action-details" style="vertical-align: middle;">
                                            <span class="mt-action-author">'.stripcslashes(htmlentities($file_name)).'</span>
                                            <p class="mt-action-desc">
                                                <span class="font-dark">'.stripcslashes(htmlentities($file_comment)).'</span><br>
                                                Uploaded by: '.$file_user.'
                                            </p>
                                        </div>
                                    </div>
                                    <div class="mt-action-datetime">
                                        <span class="mt-action-date">'.$file_due.'</span>
                                    </div>
                                    <div class="mt-action-buttons">
                                        <div class="btn-group btn-group-circle">
                                            <a href="#modalAttachedEdit" type="button" class="btn btn-outline dark btn-sm" data-toggle="modal" onclick="btnAttachedEdit('.$file_ID.')">Edit</a>
                                            <a href="javascript:;" type="button" class="btn red btn-sm" onclick="btnDeleteFile('.$file_ID.')">Delete</a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>';

                        $output = array(
                            'ID' => $file_ID,
                            'data' => $data,
                            'parent_id' => $parent_id
                        );
    					echo json_encode($output);

    					// Update History Data
    					actionHistory($parent_id, 1, 1, $file_ID);
                    }
                }
    		}
    		mysqli_close($conn);
        }
	}
	if( isset($_POST['btnUpdate_Attached']) ) {
    	$current_userID = $_COOKIE['ID'];
    	$ID = $_POST['ID'];
		$parent_id = $_POST['parent_id'];
		$name = addslashes($_POST['name']);
		$comment = addslashes($_POST['comment']);
		$last_modified = $_POST['last_modified'];
		$due_date = $_POST['due_date'];
        $process = true;

		mysqli_query( $conn,"UPDATE tbl_library_file SET name='". $name ."', comment='". $comment ."', due_date='". $due_date ."', last_modified='". $last_modified ."' WHERE ID='". $ID ."'" );

        $resultFiles = mysqli_query( $conn,"SELECT * FROM tbl_library_file WHERE ID = $ID ORDER BY ID LIMIT 1" );
        if ( mysqli_num_rows($resultFiles) > 0 ) {
            while($rowFiles = mysqli_fetch_array($resultFiles)) {
                $file_ID = $rowFiles["ID"];
                $file_name = $rowFiles["name"];
                $file_comment = $rowFiles["comment"];
                $file_reason = $rowFiles["reason"];
                $str_filename = $rowFiles["files"];
                $str_filetype = $rowFiles["filetype"];

                $file_user_id = $rowFiles["user_id"];
                $selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $file_user_id " );
                $rowUser = mysqli_fetch_array($selectUser);
                $file_user = $rowUser["first_name"] .' '. $rowUser["last_name"];

                $file_due_date = $rowFiles["due_date"];
                $file_due = $file_due_date;
                if ($file_due_date != "0000-00-00") {
                    $file_due = new DateTime(substr($file_due_date, 0, 10));
                    $file_due = $file_due->format('M d, Y');
                }

                $files = '';
                $arr_item = array();
                if (!empty($rowFiles["file_history"])) {
                    $arr_item = json_decode($rowFiles["file_history"],true);
                }
                
                $filetype = $_POST['filetype'];
                if ($filetype > 0) {
                    if ($filetype == 1) {
                        $files = $_FILES['file']['name'];
                        if (!empty($files)) {
                            $path = 'uploads/library/';
                            $filesize = $_FILES['file']['size'];
                            $tmp = $_FILES['file']['tmp_name'];
                            $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                            $ext = strtolower(pathinfo($files, PATHINFO_EXTENSION));
                            $files = rand(1000,1000000) . ' - ' . $files;
                            $path = $path.$files;
                            $str_filename = $files;
                            $str_filetype = 1;

                            if(!in_array($ext, $invalid_extensions)) {
                                move_uploaded_file($tmp,$path);
                                $filesize_tot = $filesize + $rowFiles["filesize"];
                                mysqli_query( $conn,"UPDATE tbl_library_file SET filesize='". $filesize_tot ."' WHERE ID='". $ID ."'" );
                            } else {
                                $process = false;
                            }
                        }
                    } else {
                        $str_filetype = $filetype;
                        $files = $_POST['fileurl'];
                        $filesize = 0;
                    }

                    if (!empty($files) AND $process == true) {
                        $output = array (
                            'type'  =>  $filetype,
                            'name' =>  $files,
                            'size' =>  $filesize,
                            'date' =>  $local_date
                        );
                        array_push($arr_item, $output);
                        $file_history = json_encode($arr_item, JSON_HEX_APOS | JSON_UNESCAPED_UNICODE);

                        mysqli_query( $conn,"UPDATE tbl_library_file SET files='". $files ."', filetype='". $filetype ."', file_history='". $file_history ."' WHERE ID='". $ID ."'" );
                    }
                }

                if ($process == true) {
                    $filetype = $str_filetype;
                    $files = $str_filename;
                    $type = 'iframe';
                    $file_extension = 'fa-file-image-o';
                    if (!empty($files)) {
                        if ($filetype == 1) {
                            $fileExtension = fileExtension($files);
                            $src = $fileExtension['src'];
                            $embed = $fileExtension['embed'];
                            $type = $fileExtension['type'];
                            $file_extension = $fileExtension['file_extension'];
                            $url = $base_url.'uploads/library/';

                            $files = $src.$url.rawurlencode($files).$embed;
                        } else if ($filetype == 3) {
                            $files = preg_replace('#[^/]*$#', '', $files).'preview';
                            $file_extension = 'fa-google';
                        }
                    }

                    $data = '<div class="mt-action-body">
                        <div class="mt-action-row">
                            <div class="mt-action-info">
                                <div class="mt-action-icon">
                                    <a href="'.$files.'" data-src="'.$files.'" data-fancybox data-type="'.$type.'"><i class="fa fa-fw '. $file_extension .'"></i></a>
                                </div>
                                <div class="mt-action-details" style="vertical-align: middle;">
                                    <span class="mt-action-author">'.stripcslashes(htmlentities($file_name)).'</span>
                                    <p class="mt-action-desc">
                                        <span class="font-dark">'.stripcslashes(htmlentities($file_comment)).'</span><br>
                                        Uploaded by: '.$file_user.'
                                    </p>
                                </div>
                            </div>
                            <div class="mt-action-datetime">
                                <span class="mt-action-date">'.$file_due.'</span>
                            </div>
                            <div class="mt-action-buttons">
                                <div class="btn-group btn-group-circle">
                                    <a href="#modalAttachedEdit" type="button" class="btn btn-outline dark btn-sm" data-toggle="modal" onclick="btnAttachedEdit('.$file_ID.')">Edit</a>
                                    <a href="javascript:;" type="button" class="btn red btn-sm" onclick="btnDeleteFile('.$file_ID.')">Delete</a>
                                </div>
                            </div>
                        </div>
                    </div>';

                    $output = array(
                        'ID' => $file_ID,
                        'data' => $data,
                        'parent_id' => $parent_id
                    );
    				echo json_encode($output);
    			
    				// Update History Data
    				actionHistory($parent_id, 2, 1, $file_ID);
                }
            }
        }
        
        if ($process == true) {

            //->>>>>>>  START Brandon Auto service log for uploading file to dashboard <<<<<<<<-
    		$current_userID = $_COOKIE['ID'];
    		$action = "Updated";
    		$minutes = 1;
    		$companyname = "";
    		$comment = "File name : ".$files . " with the comment of : ". $comment . "Document Last Modified Date: ". $last_modified . " and due date of: ". $due_date;
    		date_default_timezone_set('America/New_York');
    		$datenow = date('Y-m-d') ;

    		if (!empty($_COOKIE['switchAccount'])) {
    			$portal_user = $_COOKIE['ID'];
    			$user_id_account = $_COOKIE['switchAccount'];
    		}
    		else {
    			$portal_user = $_COOKIE['ID'];
    			$user_id_account = employerID($portal_user);
    		}

    		$resultaccountname = mysqli_query( $conn,'SELECT * FROM tblEnterpiseDetails WHERE users_entities = "'.$user_id_account.'" LIMIT 1 ');
    		if ( mysqli_num_rows($resultaccountname) > 0 ) {
    			$rowComment = mysqli_fetch_array($resultaccountname);
    			$companyname = $rowComment["company_code"];
    		}

            // $finaldescription = $companyname. "-" .$filesrowname;
            $finaldescription = $name;

    		$sql_subitem_autolog = "INSERT INTO tbl_service_logs_draft (`user_id`, `description`,`action`, `comment`, `account`, `minute` , `task_date`) 
    		VALUES ('$current_userID', '$finaldescription','$action','$comment','$companyname','$minutes','$datenow')";

    		mysqli_query($conn, $sql_subitem_autolog);

    		//->>>>>>> END Brandon Auto service log for  uploading file to dashboard <<<<<<<<-
    	}
    }

    // Comment Section
	if( isset($_GET['modalComment']) ) {
		$id = $_GET['modalComment'];

		echo '<input class="form-control" type="hidden" name="parent_id" value="'. $id .'" />
		<div class="form-group">
            <label class="col-md-3 control-label">Title</label>
            <div class="col-md-8">
                <input class="form-control" type="text" name="title" required />
            </div>
        </div>
        <div class="form-group">
            <label class="col-md-3 control-label">Comment</label>
            <div class="col-md-8">
                <textarea class="form-control" name="comment" required></textarea>
            </div>
        </div>
        <div class="form-group">
            <label class="col-md-3 control-label">Sent To</label>
            <div class="col-md-8">
            	<select class="form-control" name="team" required>
            		<option value="">Select Team</option>
            		<option value="1">In-house Team</option>
            		<option value="2">Consultare Team</option>
            	</select>
            </div>
        </div>';

        mysqli_close($conn);
	}
	if( isset($_GET['modalCommentCount']) ) {
		$id = $_GET['modalCommentCount'];

		if (!empty($_COOKIE['switchAccount'])) { $user_id = $_COOKIE['switchAccount']; }
		else { $user_id = $_COOKIE['ID']; }
        $current_userEmployerID = employerID($user_id);
		$current_userID = $_COOKIE['ID'];

		$countComment = 0;
    	$team = 1;
    	if (!empty($_COOKIE['switchAccount'])) { $team = 2; }
		$resultComment = mysqli_query( $conn,"SELECT * FROM tbl_library_comment WHERE deleted = 0 AND library_id = $id AND team = $team ORDER BY ID DESC " );
        if ( mysqli_num_rows($resultComment) > 0 ) {
            while($rowComment = mysqli_fetch_array($resultComment)) {
            	if (!empty($rowComment["seen"])) {
                    $comment_seen_arr = explode(", ", $rowComment["seen"]);
                    if (!in_array($current_userID, $comment_seen_arr)) {
                    	$countComment_id = $rowComment["ID"];
                    	$countComment_seen = $rowComment["seen"];

                    	if (!empty($rowComment["seen"])) {
                    		// $arr_seen = array();
                    		$countComment_seen_arr = explode(', ', $rowComment["seen"]);
                    		array_push($countComment_seen_arr, $current_userID);

                    		$countComment_seen_arr = implode(', ', $countComment_seen_arr);
                    		mysqli_query( $conn,"UPDATE tbl_library_comment SET seen = '".$countComment_seen_arr."' WHERE ID = $countComment_id" );
                    	} else {
                    		mysqli_query( $conn,"UPDATE tbl_library_comment SET seen = $current_userID WHERE ID = $countComment_id" );
                    	}
                    }
            	}
            	else {
                	$countComment_id = $rowComment["ID"];
                	$countComment_seen = $rowComment["seen"];

                	if (!empty($rowComment["seen"])) {
                		// $arr_seen = array();
                		$countComment_seen_arr = explode(', ', $rowComment["seen"]);
                		array_push($countComment_seen_arr, $current_userID);

                		$countComment_seen_arr = implode(', ', $countComment_seen_arr);
                		mysqli_query( $conn,"UPDATE tbl_library_comment SET seen = $current_userID WHERE ID = $countComment_id" );
                	} else {
                		mysqli_query( $conn,"UPDATE tbl_library_comment SET seen = $current_userID WHERE ID = $countComment_id" );
                	}
            	}
            }
        }

        mysqli_close($conn);
	}
	if( isset($_POST['btnSave_Comment']) ) {
    	$current_userID = $_COOKIE['ID'];
		$parent_id = $_POST['parent_id'];
		$title = addslashes($_POST['title']);
		$comment = addslashes($_POST['comment']);
		$team = $_POST['team'];

		$sql = "INSERT INTO tbl_library_comment (user_id, library_id, title, comment, team, seen)
		VALUES ('$current_userID', '$parent_id', '$title', '$comment', '$team', '$current_userID')";
		
		// START Brandon Auto service log for comment
        
		$action = "commented";
		$account = "Test";
		$minutes = 1;
		$companyname = "";
		$comment = "title: ".$title . " with comment content: ". $comment;
		date_default_timezone_set('America/New_York');
        $datenow = date('Y-m-d') ;

		if (!empty($_COOKIE['switchAccount'])) {
			$portal_user = $_COOKIE['ID'];
			$user_id_account = $_COOKIE['switchAccount'];
		}
		else {
			$portal_user = $_COOKIE['ID'];
			$user_id_account = employerID($portal_user);
		}

		$resultaccountname = mysqli_query( $conn,'SELECT * FROM tblEnterpiseDetails WHERE users_entities = "'.$user_id_account.'" LIMIT 1 ');
		if ( mysqli_num_rows($resultaccountname) > 0 ) {
			$rowComment = mysqli_fetch_array($resultaccountname);
			$companyname = $rowComment["company_code"];
		}

		$finaldescription = $companyname."-".$title;

		$sql_comment_autolog = "INSERT INTO tbl_service_logs_draft (`user_id`, `description`,`action`, `comment`, `account`, `minute` , `task_date`) 
        VALUES ('$current_userID', '$finaldescription','$action','$comment','$companyname','$minutes','$datenow')";

        mysqli_query($conn, $sql_comment_autolog);
	  

		// END Brandon Auto service log for comment
		
		if (mysqli_query($conn, $sql)) {
			$last_id = mysqli_insert_id($conn);
			$resultComment = mysqli_query( $conn,'SELECT * FROM tbl_library_comment WHERE user_id = "'.$current_userID.'" AND ID = "'.$last_id.'" ORDER BY ID LIMIT 1' );
			if ( mysqli_num_rows($resultComment) > 0 ) {
				$rowComment = mysqli_fetch_array($resultComment);
				$comment_ID = $rowComment["ID"];
            	$comment_title = $rowComment["title"];
            	$comment_comment = $rowComment["comment"];

            	$comment_last_modified = $rowComment["last_modified"];
                $comment_last_modified = new DateTime($comment_last_modified);
                $comment_last_modified = $comment_last_modified->format('d M Y \a\t g:ia');

            	$comment_user_id = $rowComment["user_id"];
                $resultUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $comment_user_id" );
                $rowUser = mysqli_fetch_array($resultUser);
            	$comment_name = $rowUser["first_name"] .' '. $rowUser["last_name"];
            	$comment_email = $rowUser["email"];

            	$comment_avatar = "https://via.placeholder.com/200x150/EFEFEF/AAAAAA.png?text=no+image";
            	$resultUserInfo = mysqli_query( $conn,"SELECT * FROM tbl_user_info WHERE user_id = $comment_user_id" );
            	if ( mysqli_num_rows($resultUserInfo) > 0 ) {
            		$rowUserInfo = mysqli_fetch_array($resultUserInfo);
            		if ( !empty($rowUserInfo["avatar"]) ) {
                        $comment_avatar = $base_url.'uploads/avatar/'. $rowUserInfo["avatar"];
                    }
            	}

				$output = array(
					"parent_id" => $parent_id,
					"ID" => $comment_ID,
                    "title" => stripcslashes(htmlentities($comment_title)),
                    "comment" => stripcslashes(htmlentities($comment_comment)),
					"last_modified" => $comment_last_modified,
					"name" => $comment_name,
					"avatar" => $comment_avatar
				);
				echo json_encode($output);

				// Update History Data
				actionHistory($parent_id, 1, 2, $comment_ID);


				// Send to the Main Account
				$selectData = mysqli_query( $conn,'SELECT * FROM tbl_library WHERE ID = "'.$parent_id.'" ORDER BY ID LIMIT 1' );
				if ( mysqli_num_rows($selectData) > 0 ) {
					$rowData = mysqli_fetch_array($selectData);
					$data_user_id = $rowData["user_id"];

		            $data_names = $rowData["name"];
		            $array_name_id = explode(", ", $data_names);
		            if ( count($array_name_id) == 4 ) {
		                $data_name = array();

		                $selectType = mysqli_query($conn,"SELECT * FROM tbl_library_type WHERE ID = '".$array_name_id[0]."'");
		                if ( mysqli_num_rows($selectType) > 0 ) {
		                    while($rowType = mysqli_fetch_array($selectType)) {
		                        array_push($data_name, $rowType["name"]);
		                    }
		                }

		                $selectCategory = mysqli_query($conn,"SELECT * FROM tbl_library_category WHERE ID = '".$array_name_id[1]."'");
		                if ( mysqli_num_rows($selectCategory) > 0 ) {
		                    while($rowCategory = mysqli_fetch_array($selectCategory)) {
		                        array_push($data_name, $rowCategory["name"]);
		                    }
		                }

		                $selectScope = mysqli_query($conn,"SELECT * FROM tbl_library_scope WHERE ID = '".$array_name_id[2]."'");
		                if ( mysqli_num_rows($selectScope) > 0 ) {
		                    while($rowScope = mysqli_fetch_array($selectScope)) {
		                        array_push($data_name, $rowScope["name"]);
		                    }
		                }

		                $selectModule = mysqli_query($conn,"SELECT * FROM tbl_library_module WHERE ID = '".$array_name_id[3]."'");
		                if ( mysqli_num_rows($selectModule) > 0 ) {
		                    while($rowModule = mysqli_fetch_array($selectModule)) {
		                        array_push($data_name, $rowModule["name"]);
		                    }
		                }

		                $data_names = implode(" - ",$data_name);
		            }

					$selectDataUser = mysqli_query( $conn,'SELECT * FROM tbl_user WHERE ID = "'.$data_user_id.'" ORDER BY ID LIMIT 1' );
					if ( mysqli_num_rows($selectDataUser) > 0 ) {
						$rowDataUser = mysqli_fetch_array($selectDataUser);
						$datauser_fullname = $rowDataUser["first_name"] .' '. $rowDataUser["last_name"];
						$datauser_email = $rowDataUser["email"];

						$from = $comment_email;
						$sender = $comment_name;
						$to = $datauser_email;
						$user = $datauser_fullname;
						$subject = 'New Dashboard Comment';
						$body = 'Hi there,<br><br>

						'.$sender.' has a comment on <b>'.$data_names.'</b><br>
						<i>"'.stripcslashes($comment_comment).'"</i><br><br>

						<a href="'. $base_url .'dashboard?d='. $parent_id .'" target="_blank" style="font-weight: 600; padding: 10px 20px!important; text-decoration: none; color: #fff; background-color: #27a4b0; border-color: #208992; display: inline-block;">View Here</a>';
		    
                        if ($_COOKIE['client'] == 1) { $body .= '<br><br>Cann OS Team'; }
                        else if ($_COOKIE['client'] == 2) { $body .= '<br><br>FoodSafety360 Team'; }
                        else if ($_COOKIE['client'] == 3) { $body .= '<br><br>SafeCannabis360 Team'; }
                        else if ($_COOKIE['client'] == 4) { $body .= '<br><br>Exim360 Team'; }
                        
		    			php_mailer_1($to, $user, $subject, $body, $from, $sender);
					}
				}

				commentNotification($parent_id, $parent_id, $subject, $from, $sender, $data_names, $team, $comment_comment, $data_user_id);
			}
		}
		mysqli_close($conn);
	}

	// Compliance Section
	if( isset($_GET['compliant']) ) {
		$id = $_GET['compliant'];
		$val = $_GET['v'];

		mysqli_query( $conn,"UPDATE tbl_library_compliance SET compliant='". $val ."' WHERE ID='". $id ."'" );
	}
	if( isset($_GET['modalCompliance']) ) {
		$id = $_GET['modalCompliance'];

		echo '<input class="form-control" type="hidden" name="parent_id" value="'. $id .'" />
        <div class="form-group">
            <label class="col-md-3 control-label">Requirements</label>
            <div class="col-md-8">
            	<input type="text" class="form-control tagsinput" id="requirements" name="requirements" data-role="tagsinput" required />
                <span class="form-text text-muted">Enter multiple requirements separated by comma</span>
            </div>
        </div>
		<div class="form-group">
            <label class="col-md-3 control-label">Compliance Action Items</label>
            <div class="col-md-8">
            	<input type="text" class="form-control tagsinput" id="action_items" name="action_items" data-role="tagsinput" required />
                <span class="form-text text-muted">Enter multiple action items separated by comma</span>
            </div>
        </div>
        <div class="form-group">
            <label class="col-md-3 control-label">Frequency</label>
            <div class="col-md-8">
            	<select class="form-control" name="frequency" onchange="changedFrequency(this.value)" required>
            		<option value="">Select</option>
            		<option value="1">Daily</option>
            		<option value="2">Weekly</option>
            		<option value="3">Monthly</option>
            		<option value="4">Yearly</option>
            	</select>
            </div>
        </div>
        <div class="form-group hide frequency frequency-container">
            <label class="col-md-3 control-label">Select Schedule</label>
            <div class="col-md-8" style="display: flex;">
		        <input class="form-control hide frequency frequency-time" name="time" type="time" />

				<select class="form-control hide frequency frequency-days" name="days">
					<option value="">Select Day</option>
					<option value="1">Monday</option>
					<option value="2">Tuesday</option>
					<option value="3">Wednesday</option>
					<option value="4">Thursday</option>
					<option value="5">Friday</option>
					<option value="6">Saturday</option>
					<option value="7">Sunday</option>
				</select>

				<select class="form-control hide frequency frequency-day" name="day">
					<option value="">Select Day</option>';

					for ($i=1; $i <= 28; $i++) {
						echo '<option value="'. $i .'">'. $i.date("S", mktime(0, 0, 0, 0, $i, 0)) .'</option>';
					}

				echo '</select>

		        <select class="form-control hide frequency frequency-month" name="month">
		        	<option value="">Select Month</option>
		        	<option value="1">January</option>
		        	<option value="2">February</option>
		        	<option value="3">March</option>
		        	<option value="4">April</option>
		        	<option value="5">May</option>
		        	<option value="6">June</option>
		        	<option value="7">July</option>
		        	<option value="8">August</option>
		        	<option value="9">September</option>
		        	<option value="10">October</option>
		        	<option value="11">November</option>
		        	<option value="12">December</option>
		        </select>
            </div>
        </div>
        <div class="form-group">
            <label class="col-md-3 control-label">Upload Document</label>
            <div class="col-md-8">
                <select class="form-control" name="filetype" onchange="changeType(this)" required>
                    <option value="0">Select option</option>
                    <option value="1">Manual Upload</option>
                    <option value="3">Google Drive URL</option>
                </select>
                <input class="form-control margin-top-15 fileUpload" type="file" name="file" style="display: none;" />
                <input class="form-control margin-top-15 fileURL" type="url" name="fileurl" style="display: none;" placeholder="https://" />
            </div>
        </div>';

        mysqli_close($conn);
	}
	if( isset($_GET['modalCompliance_Edit']) ) {
		$id = $_GET['modalCompliance_Edit'];

		$selectData = mysqli_query( $conn,"SELECT * FROM tbl_library_compliance WHERE ID = $id" );
		if ( mysqli_num_rows($selectData) > 0 ) {
            $row = mysqli_fetch_array($selectData);
            $frequency = $row['frequency'];
            $schedule_id = $row['schedule'];
            $assigned_to_id = $row["assigned_to_id"];
            $array_schedule_id = explode(", ", $schedule_id);

            $filetype = $row['filetype'];
            $files = $row["files"];
            $type = 'iframe';
            if (!empty($files)) {
                if ($filetype == 1) {
                    $fileExtension = fileExtension($files);
                    $src = $fileExtension['src'];
                    $embed = $fileExtension['embed'];
                    $type = $fileExtension['type'];
                    $file_extension = $fileExtension['file_extension'];
                    $url = $base_url.'uploads/library/';

                    $files = $src.$url.rawurlencode($files).$embed;
                } else if ($filetype == 3) {
                    $files = preg_replace('#[^/]*$#', '', $files).'preview';
                }
            }
        }

		echo '<input class="form-control" type="hidden" name="ID" value="'. $row['ID'] .'" />
		<input class="form-control" type="hidden" name="parent_id" value="'. $row['library_id'] .'" />
		<div class="form-group">
            <label class="col-md-3 control-label">Requirements</label>
            <div class="col-md-8">
            	<input type="text" class="form-control tagsinput" id="requirements" name="requirements" data-role="tagsinput" value="'. $row['requirements'] .'" required />
                <span class="form-text text-muted">Enter multiple requirements separated by comma</span>
            </div>
        </div>
		<div class="form-group">
            <label class="col-md-3 control-label">Compliance Action Items</label>
            <div class="col-md-8">
            	<input type="text" class="form-control tagsinput" id="action_items" name="action_items" data-role="tagsinput" value="'. $row['action_items'] .'" required />
                <span class="form-text text-muted">Enter multiple action items separated by comma</span>
            </div>
        </div>
        <div class="form-group">
            <label class="col-md-3 control-label">Frequency</label>
            <div class="col-md-8">
            	<select class="form-control" name="frequency" onchange="changedFrequency(this.value)" required>
            		<option value="">Select</option>
            		<option value="1" '; echo $frequency == 1 ? 'SELECTED' : ''; echo '>Daily</option>
            		<option value="2" '; echo $frequency == 2 ? 'SELECTED' : ''; echo '>Weekly</option>
            		<option value="3" '; echo $frequency == 3 ? 'SELECTED' : ''; echo '>Monthly</option>
            		<option value="4" '; echo $frequency == 4 ? 'SELECTED' : ''; echo '>Yearly</option>
            	</select>
            </div>
        </div>
        <div class="form-group frequency frequency-container '; echo empty($frequency) ? 'hide' : ''; echo '">
            <label class="col-md-3 control-label">Select Schedule</label>
            <div class="col-md-8" style="display: flex;">
		        <input class="form-control frequency frequency-time '; echo empty($array_schedule_id[0]) ? 'hide' : ''; echo '" name="time" type="time" value="'. $array_schedule_id[0] .'" />

				<select class="form-control frequency frequency-days '; echo empty($array_schedule_id[1]) ? 'hide' : ''; echo '" name="days">
					<option value="">Select Day</option>
					<option value="1" '; echo $array_schedule_id[1] == 1 ? 'SELECTED' : ''; echo '>Monday</option>
					<option value="2" '; echo $array_schedule_id[1] == 2 ? 'SELECTED' : ''; echo '>Tuesday</option>
					<option value="3" '; echo $array_schedule_id[1] == 3 ? 'SELECTED' : ''; echo '>Wednesday</option>
					<option value="4" '; echo $array_schedule_id[1] == 4 ? 'SELECTED' : ''; echo '>Thursday</option>
					<option value="5" '; echo $array_schedule_id[1] == 5 ? 'SELECTED' : ''; echo '>Friday</option>
					<option value="6" '; echo $array_schedule_id[1] == 6 ? 'SELECTED' : ''; echo '>Saturday</option>
					<option value="7" '; echo $array_schedule_id[1] == 7 ? 'SELECTED' : ''; echo '>Sunday</option>
				</select>

				<select class="form-control frequency frequency-day '; echo empty($array_schedule_id[2]) ? 'hide' : ''; echo '" name="day">
					<option value="">Select Day</option>';

					for ($i=1; $i <= 28; $i++) {
						echo '<option value="'. $i .'" '; echo $array_schedule_id[2] == $i ? 'SELECTED' : ''; echo '>'. $i.date("S", mktime(0, 0, 0, 0, $i, 0)) .'</option>';
					}

				echo '</select>

		        <select class="form-control frequency frequency-month '; echo empty($array_schedule_id[3]) ? 'hide' : ''; echo '" name="month">
		        	<option value="">Select Month</option>
		        	<option value="1" '; echo $array_schedule_id[3] == 1 ? 'SELECTED' : ''; echo '>January</option>
		        	<option value="2" '; echo $array_schedule_id[3] == 2 ? 'SELECTED' : ''; echo '>February</option>
		        	<option value="3" '; echo $array_schedule_id[3] == 3 ? 'SELECTED' : ''; echo '>March</option>
		        	<option value="4" '; echo $array_schedule_id[3] == 4 ? 'SELECTED' : ''; echo '>April</option>
		        	<option value="5" '; echo $array_schedule_id[3] == 5 ? 'SELECTED' : ''; echo '>May</option>
		        	<option value="6" '; echo $array_schedule_id[3] == 6 ? 'SELECTED' : ''; echo '>June</option>
		        	<option value="7" '; echo $array_schedule_id[3] == 7 ? 'SELECTED' : ''; echo '>July</option>
		        	<option value="8" '; echo $array_schedule_id[3] == 8 ? 'SELECTED' : ''; echo '>August</option>
		        	<option value="9" '; echo $array_schedule_id[3] == 9 ? 'SELECTED' : ''; echo '>September</option>
		        	<option value="10" '; echo $array_schedule_id[3] == 10 ? 'SELECTED' : ''; echo '>October</option>
		        	<option value="11" '; echo $array_schedule_id[3] == 11 ? 'SELECTED' : ''; echo '>November</option>
		        	<option value="12" '; echo $array_schedule_id[3] == 12 ? 'SELECTED' : ''; echo '>December</option>
		        </select>
            </div>
        </div>
        <div class="form-group">
            <label class="col-md-3 control-label">Upload Document</label>
            <div class="col-md-8">
                <select class="form-control '; echo !empty($files) ? 'hide':''; echo '" name="filetype" onchange="changeType(this)" required>
                    <option value="0">Select option</option>
                    <option value="1">Manual Upload</option>
                    <option value="3">Google Drive URL</option>
                </select>
                <input class="form-control margin-top-15 fileUpload" type="file" name="file" style="display: none;" />
                <input class="form-control margin-top-15 fileURL" type="url" name="fileurl" style="display: none;" placeholder="https://" />
                <p class="'; echo !empty($files) ? '':'hide'; echo '" style="margin: 0;"><a href="'.$files.'" data-src="'.$files.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a> | <button type="button" class="btn btn-link uploadNew" onclick="uploadNew(this)">Upload New</button></p>
            </div>
        </div>';

        mysqli_close($conn);
	}
	if( isset($_GET['modalCompliance_More']) ) {
		$id = $_GET['modalCompliance_More'];

		$selectData = mysqli_query( $conn,"SELECT * FROM tbl_library_compliance WHERE ID = $id" );
		if ( mysqli_num_rows($selectData) > 0 ) {
            $row = mysqli_fetch_array($selectData);
            $library_id = $row["library_id"];
        }

		echo '<input class="form-control" type="hidden" name="ID" value="'. $id .'" />
		<input class="form-control" type="hidden" name="library_id" value="'. $library_id .'" />
        <div class="form-group">
            <label class="col-md-3 control-label">Select Action</label>
            <div class="col-md-8">
            	<select class="form-control" name="type">
            		<option value="1">Perfomer</option>
            		<option value="2">Verifier</option>
            		<option value="3">Reviewer</option>
            	</select>
            </div>
        </div>
        <div class="form-group">
            <label class="col-md-3 control-label">Upload Document</label>
            <div class="col-md-8">
                <select class="form-control" name="filetype" onchange="changeType(this)" required>
                    <option value="0">Select option</option>
                    <option value="1">Manual Upload</option>
                    <option value="3">Google Drive URL</option>
                </select>
                <input class="form-control margin-top-15 fileUpload" type="file" name="file" style="display: none;" />
                <input class="form-control margin-top-15 fileURL" type="url" name="fileurl" style="display: none;" placeholder="https://" />
            </div>
        </div>
        <div class="form-group">
            <label class="col-md-3 control-label">Comment</label>
            <div class="col-md-8">
            	<textarea class="form-control" name="comment" placeholder="Add some remarks if any"></textarea>
            </div>
        </div>';

        mysqli_close($conn);
	}
	if( isset($_GET['modalCompliance_MoreEdit']) ) {
		$id = $_GET['modalCompliance_MoreEdit'];

		$selectData = mysqli_query( $conn,"SELECT * FROM tbl_library_compliance WHERE ID = $id" );
		if ( mysqli_num_rows($selectData) > 0 ) {
            $row = mysqli_fetch_array($selectData);
            $library_id = $row["library_id"];
            $ctype = $row["type"];
            $comment = $row["comment"];

            $filetype = $row['filetype'];
            $files = $row["files"];
            $type = 'iframe';
            if (!empty($files)) {
                if ($filetype == 1) {
                    $fileExtension = fileExtension($files);
                    $src = $fileExtension['src'];
                    $embed = $fileExtension['embed'];
                    $type = $fileExtension['type'];
                    $file_extension = $fileExtension['file_extension'];
                    $url = $base_url.'uploads/library/';

                    $files = $src.$url.rawurlencode($files).$embed;
                } else if ($filetype == 3) {
                    $files = preg_replace('#[^/]*$#', '', $files).'preview';
                }
            }
        }

		echo '<input class="form-control" type="hidden" name="ID" value="'. $id .'" />
		<input class="form-control" type="hidden" name="library_id" value="'. $library_id .'" />
        <div class="form-group">
            <label class="col-md-3 control-label">Select Action</label>
            <div class="col-md-8">
            	<select class="form-control" name="type">
            		<option value="1" '; echo $ctype == 1 ? 'SELECTED':''; echo '>Perfomer</option>
            		<option value="2" '; echo $ctype == 2 ? 'SELECTED':''; echo '>Verifier</option>
            		<option value="3" '; echo $ctype == 3 ? 'SELECTED':''; echo '>Reviewer</option>
            	</select>
            </div>
        </div>
        <div class="form-group">
            <label class="col-md-3 control-label">Upload Document</label>
            <div class="col-md-8">
                <select class="form-control '; echo !empty($files) ? 'hide':''; echo '" name="filetype" onchange="changeType(this)" required>
                    <option value="0">Select option</option>
                    <option value="1">Manual Upload</option>
                    <option value="3">Google Drive URL</option>
                </select>
                <input class="form-control margin-top-15 fileUpload" type="file" name="file" style="display: none;" />
                <input class="form-control margin-top-15 fileURL" type="url" name="fileurl" style="display: none;" placeholder="https://" />
                <p class="'; echo !empty($files) ? '':'hide'; echo '" style="margin: 0;"><a href="'.$files.'" data-src="'.$files.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a> | <button type="button" class="btn btn-link uploadNew" onclick="uploadNew(this)">Upload New</button></p>
            </div>
        </div>
        <div class="form-group">
            <label class="col-md-3 control-label">Comment</label>
            <div class="col-md-8">
            	<textarea class="form-control" name="comment" placeholder="Add some remarks if any">'.$comment.'</textarea>
            </div>
        </div>';

        mysqli_close($conn);
	}
	if( isset($_GET['btnDelete_Compliance']) ) {
		$id = $_GET['btnDelete_Compliance'];
    	$current_userID = $_COOKIE['ID'];
		$reason = addslashes($_GET['reason']);

        $message = array();
		array_push($message, $current_userID);
		array_push($message, $reason);
		$message = implode(" | ",$message);

		mysqli_query( $conn,"UPDATE tbl_library_compliance SET deleted = 1, reason = '". $message ."' WHERE ID='". $id ."'" );

		$selectData = mysqli_query( $conn,'SELECT * FROM tbl_library_compliance WHERE ID="'. $id .'"' );
		$rowData = mysqli_fetch_array($selectData);
        $data_library_id = $rowData['library_id'];
			
		// Update History Data
		actionHistory($data_library_id, 3, 3, $id);
	}
	if( isset($_GET['btnAccept_Compliance']) ) {
		$id = $_GET['btnAccept_Compliance'];
    	$current_userID = $_COOKIE['ID'];

        if (!empty($_COOKIE['switchAccount'])) {
            $portal_user = $_COOKIE['ID'];
            $user_id = $_COOKIE['switchAccount'];
        }
        else {
            $portal_user = $_COOKIE['ID'];
            $user_id = employerID($portal_user);
        }

        $hasLibrary = mysqli_query( $conn,"SELECT * FROM tbl_library WHERE user_id = $user_id" );
        if ( mysqli_num_rows($hasLibrary) == 0 ) {
            $user_id = 163;
        }

		mysqli_query( $conn,"UPDATE tbl_library_compliance SET remark = '1', remark_user = '". $current_userID ."' WHERE ID='". $id ."'" );

		// $selectData = mysqli_query( $conn,'SELECT * FROM tbl_library_compliance WHERE ID="'. $id .'"' );
        $selectData = mysqli_query( $conn, "SELECT
            l.ID AS l_ID,
            c.ID AS c_ID,
            c.type AS c_type,
            p.ID AS p_ID,
            p.action_items AS p_action_items,
            p.requirements AS p_requirements,
            p.frequency AS p_frequency

            FROM tbl_library_compliance AS c 

            LEFT JOIN (
                SELECT
                *
                FROM tbl_library_compliance
            ) AS p
            ON p.ID = c.parent_id

            LEFT JOIN (
                SELECT
                *
                FROM tbl_library
                WHERE deleted = 0
            ) AS l
            ON l.ID = c.library_id

            WHERE c.ID = $id");
		$rowData = mysqli_fetch_array($selectData);
        $data_library_id = $rowData['l_ID'];
        $data_compliance_type = $rowData['c_type'];
        $requirements = $rowData['p_requirements'];
        $action_items = $rowData['p_action_items'];
        $frequency = $rowData['p_frequency'];

		// Update History Data
		actionHistory($data_library_id, 4, 3, $id);

        $selectLibrary = mysqli_query( $conn,"SELECT * FROM tbl_library WHERE deleted = 0 AND ID = $parent_id" );
        if ( mysqli_num_rows($selectLibrary) > 0 ) {
            $rowLibrary = mysqli_fetch_array($selectLibrary);
            $library_type = $rowLibrary["type"];
        }
        $array_library_type = array(
            0 => 'Main',
            1 => 'Programs',
            2 => 'Policy',
            3 => 'Procedure',
            4 => 'Freelance',
            5 => 'Form'
        );
        $array_frequency = array(
            1 => 'Daily',
            2 => 'Weekly',
            3 => 'Monthly',
            4 => 'Yearly'
        );
        $array_type = array(
            0 => 'Performed',
            1 => 'Verified',
            2 => 'Reviewed'
        );
        $selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $user_id" );
        if ( mysqli_num_rows($selectUser) > 0 ) {
            $rowUser = mysqli_fetch_array($selectUser);
            $to = $rowUser["email"];
            $user = $rowUser["first_name"].' '.$rowUser["last_name"];

            $subject = 'Compliance Requirement  Ready to be '.$array_type[$data_compliance_type].'!';
            $body = 'Hi '.$user.',<br><br>

            The following compliance requirement is ready to be '.$array_type[$data_compliance_type].':<br><br>

            Type - '.$array_library_type[$library_type].'<br>
            Requirements  '.stripcslashes($requirements).'<br>
            Action Items  '.stripcslashes($action_items).'<br>
            Frequency  '.$array_frequency[$frequency].'<br><br>';

            if ($_COOKIE['client'] == 1) {
                $from = 'CannOS@begreenlegal.com';
                $name = 'BeGreenLegal';
                $body .= 'Cann OS Team';
            } else if ($_COOKIE['client'] == 2) {
                $from = 'foodsafety360r@gmail.com';
                $name = 'Food Safety 360';
                $body .= 'Food Safety 360';
            } else if ($_COOKIE['client'] == 3) {
                $from = 'cannabis360r@gmail.com';
                $name = 'SafeCannabis360';
                $body .= 'SafeCannabis360';
            } else if ($_COOKIE['client'] == 4) {
                $from = 'exim360r@gmail.com';
                $name = 'Exim360';
                $body .= 'Exim360';
            } else {
                $from = 'services@interlinkiq.com';
                $name = 'InterlinkIQ';
                $body .= 'InterlinkIQ.com Team<br>
                Consultare Inc.';
            }
            php_mailer_1($to, $user, $subject, $body, $from, $name);
        }
	}
	if( isset($_GET['btnReject_Compliance']) ) {
		$id = $_GET['btnReject_Compliance'];
    	$current_userID = $_COOKIE['ID'];
		$reason = addslashes($_GET['reason']);

		mysqli_query( $conn,"UPDATE tbl_library_compliance SET remark = '".$reason."', remark_user = '". $current_userID ."' WHERE ID='". $id ."'" );

		$selectData = mysqli_query( $conn,'SELECT * FROM tbl_library_compliance WHERE ID="'. $id .'"' );
		$rowData = mysqli_fetch_array($selectData);
        $data_library_id = $rowData['library_id'];

		// Update History Data
		actionHistory($data_library_id, 5, 3, $id);
	}
	if( isset($_POST['btnSave_Compliance']) ) {
        if (!empty($_COOKIE['switchAccount'])) {
            $portal_user = $_COOKIE['ID'];
            $user_id = $_COOKIE['switchAccount'];
        }
        else {
            $portal_user = $_COOKIE['ID'];
            $user_id = employerID($portal_user);
        }

        $free_access = 0;
        $hasLibrary = mysqli_query( $conn,"SELECT * FROM tbl_library WHERE user_id = $user_id" );
        if ( mysqli_num_rows($hasLibrary) == 0 ) {
            $user_id = 163;
            $free_access = 1;
        }

    	$current_userID = $_COOKIE['ID'];
		$parent_id = $_POST['parent_id'];
		$action_items = addslashes($_POST['action_items']);
		$requirements = addslashes($_POST['requirements']);
		$last_modified = date('Y-m-d');
        $arr_item = array();
        $filesize = 0;
        $process = true;

		$frequency = $_POST['frequency'];
		$time = $_POST['time'];
		$days = $_POST['days'];
		$day = $_POST['day'];
		$month = $_POST['month'];

		$frequency_id = array();
		array_push($frequency_id, $time);
		array_push($frequency_id, $days);
		array_push($frequency_id, $day);
		array_push($frequency_id, $month);
		$frequency_id = implode(", ",$frequency_id);

        $filetype = $_POST['filetype'];
        if ($filetype == 1) {
            $files = $_FILES['file']['name'];
            if (!empty($files)) {
                $path = 'uploads/library/';
                $filesize = $_FILES['file']['size'];
                $tmp = $_FILES['file']['tmp_name'];
                $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                $ext = strtolower(pathinfo($files, PATHINFO_EXTENSION));
                $files = rand(1000,1000000) . ' - ' . $files;
                $path = $path.$files;

                if(!in_array($ext, $invalid_extensions)) {
                    move_uploaded_file($tmp,$path);
                } else {
                    $process = false;
                }
            }
        } else {
            $files = $_POST['fileurl'];
        }

        if ($process == true) {
            $output = array (
                'type' =>  $filetype,
                'name' =>  $files,
                'size' =>  $filesize,
                'date' =>  $local_date
            );
            array_push($arr_item, $output);
            $file_history = json_encode($arr_item, JSON_HEX_APOS | JSON_UNESCAPED_UNICODE);

    		$sql = "INSERT INTO tbl_library_compliance (user_id, library_id, free_access, action_items, requirements, frequency, files, filetype, filesize, file_history, schedule, last_modified)
            VALUES ('$current_userID', '$parent_id', '$free_access', '$action_items', '$requirements', '$frequency', '$files', '$filetype', '$filesize', '$file_history', '$frequency_id', '$last_modified')";
            
    		//->>>>>>>  START Brandon Auto service log for adding compliance in dashboard <<<<<<<<-
    				
    		$current_userID = $_COOKIE['ID'];
    		$action = "created";
    		$minutes = 1;
    		$companyname = "";
    		$itemnamedescription = "";
    		$comment = "Requirements : ".$requirements . " with the compliance action items : ". $action_items. " Frequency of: ".$frequency." and added a file with a name: ".$files;
    		date_default_timezone_set('America/New_York');
    		$datenow = date('Y-m-d') ;

    		if (!empty($_COOKIE['switchAccount'])) {
    			$portal_user = $_COOKIE['ID'];
    			$user_id_account = $_COOKIE['switchAccount'];
    		}
    		else {
    			$portal_user = $_COOKIE['ID'];
    			$user_id_account = employerID($portal_user);
    		}

    		$resultaccountname = mysqli_query( $conn,'SELECT * FROM tblEnterpiseDetails WHERE users_entities = "'.$user_id_account.'" LIMIT 1 ');
    		if ( mysqli_num_rows($resultaccountname) > 0 ) {
    			$rowComment = mysqli_fetch_array($resultaccountname);
    			$companyname = $rowComment["company_code"];
    		}

    			
    		$getitemname = mysqli_query( $conn,'SELECT * FROM tbl_library WHERE ID = "'.$parent_id.'" LIMIT 1 ');
    		if ( mysqli_num_rows($getitemname) > 0 ) {
    			$rowitemname = mysqli_fetch_array($getitemname);
    			$itemnamedescription = $rowitemname["description"];
    		}

    		$finaldescription = $companyname."-". $itemnamedescription ."-". $datenow;

    		$sql_subitem_autolog = "INSERT INTO tbl_service_logs_draft (`user_id`, `description`,`action`, `comment`, `account`, `minute` , `task_date`) 
    		VALUES ('$current_userID', '$finaldescription','$action','$comment','$companyname','$minutes','$datenow')";

    		mysqli_query($conn, $sql_subitem_autolog);


    		//->>>>>>> END Brandon Auto service log for  compliance in dashboard<<<<<<<<-
    		
    		if (mysqli_query($conn, $sql)) {
    			$last_id = mysqli_insert_id($conn);
    			$selectData = mysqli_query( $conn,'SELECT * FROM tbl_library_compliance WHERE user_id="'. $current_userID .'" AND ID="'. $last_id .'" ORDER BY ID LIMIT 1' );
    			if ( mysqli_num_rows($selectData) > 0 ) {
    				$rowData = mysqli_fetch_array($selectData);
                    $compliance_compliant = $rowData['compliant'];
                    $compliance_frequency = $rowData['frequency'];
                    $compliance_schedule_id = $rowData['schedule'];
                    $array_schedule_id = explode(", ", $compliance_schedule_id);
    				$days = array(
    	                1 => 'Monday',
    	                2 => 'Tuesday',
    	                3 => 'Wednesday',
    	                4 => 'Thursday',
    	                5 => 'Friday',
    	                6 => 'Saturday',
    	                7 => 'Sunday'
    	            );

    				$frequency = $compliance_frequency;
    				if ( count($array_schedule_id) == 4 ) {
                        $time = $array_schedule_id[0];
                        $time_f = date_create($time);
                        $day_ms = $array_schedule_id[1];
                        $day_num = $array_schedule_id[2];
                        $month = $array_schedule_id[3];

                        if ($compliance_frequency == 1) {             // Daily

                            $frequency = 'Daily';
                        	if (!empty($time)) {
                        		$frequency = 'Every '. date_format($time_f,"g:i A") .' daily';
                        	}
                        } else if ($compliance_frequency == 2) {      // Weekly

                        	$frequency = 'Weekly';
                        	if (!empty($day_ms) AND !empty($time)) {
                        		$frequency = 'Every '. $days[$day_ms] .' at '. date_format($time_f,"g:i A");
                        	}
                        } else if ($compliance_frequency == 3) {      // Monthly

                        	$frequency = 'Monthly';
                        	if (!empty($day_num) AND !empty($time)) {
                        		$frequency = 'Every '. $day_num.date("S", mktime(0, 0, 0, 0, intval($day_num), 0)) .' day of the Month at '. date_format($time_f,"g:i A");
                        	}
                        } else if ($compliance_frequency == 4) {      // Yearly

                        	$frequency = 'Yearly';
                        	if (!empty($day_num) AND !empty($time) AND !empty($month)) {
                        		$frequency = 'Every '. $day_num.date("S", mktime(0, 0, 0, 0, intval($day_num), 0)) .' day of '. date("F", mktime(0, 0, 0, intval($month)+1, 0, 0)) .' at '. date_format($time_f,"g:i A");
                        	}
                        }
                    }

                    $filetype = $rowData['filetype'];
                    $files = $rowData["files"];
                    $type = 'iframe';
                    $file_extension = 'fa-youtube-play';
                    if (!empty($files)) {
                        if ($filetype == 1) {
                            $fileExtension = fileExtension($files);
                            $src = $fileExtension['src'];
                            $embed = $fileExtension['embed'];
                            $type = $fileExtension['type'];
                            $file_extension = $fileExtension['file_extension'];
                            $url = $base_url.'uploads/library/';

                            $files = $src.$url.rawurlencode($files).$embed;
                        } else if ($filetype == 3) {
                            $files = preg_replace('#[^/]*$#', '', $files).'preview';
                            $file_extension = 'fa-google';
                        }
                        $files = '<a href="'.$files.'" data-src="'.$files.'" data-fancybox data-type="'.$type.'">View</a>';
                    }

                    $selectLibrary = mysqli_query( $conn,"SELECT * FROM tbl_library WHERE deleted = 0 AND ID = $parent_id" );
                    if ( mysqli_num_rows($selectLibrary) > 0 ) {
                        $rowLibrary = mysqli_fetch_array($selectLibrary);
                        $library_type = $rowLibrary["type"];
                    }
                    $array_library_type = array(
                        0 => 'Main',
                        1 => 'Programs',
                        2 => 'Policy',
                        3 => 'Procedure',
                        4 => 'Freelance',
                        5 => 'Form'
                    );
                    $selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $user_id" );
                    if ( mysqli_num_rows($selectUser) > 0 ) {
                        $rowUser = mysqli_fetch_array($selectUser);
                        $to = $rowUser["email"];
                        $user = $rowUser["first_name"].' '.$rowUser["last_name"];

                        $subject = 'New Compliance Requirement added!';
                        $body = 'Hi '.$user.',<br><br>

                        The following compliance requirement has been added:<br><br>

                        Type - '.$array_library_type[$library_type].'<br>
                        Requirements  '.stripcslashes($requirements).'<br>
                        Action Items  '.stripcslashes($action_items).'<br>
                        Frequency  '.$frequency.'<br><br>';

                        if ($_COOKIE['client'] == 1) {
                            $from = 'CannOS@begreenlegal.com';
                            $name = 'BeGreenLegal';
                            $body .= 'Cann OS Team';
                        } else if ($_COOKIE['client'] == 2) {
                            $from = 'foodsafety360r@gmail.com';
                            $name = 'Food Safety 360';
                            $body .= 'Food Safety 360';
                        } else if ($_COOKIE['client'] == 3) {
                            $from = 'cannabis360r@gmail.com';
                            $name = 'SafeCannabis360';
                            $body .= 'SafeCannabis360';
                        } else if ($_COOKIE['client'] == 4) {
                            $from = 'exim360r@gmail.com';
                            $name = 'Exim360';
                            $body .= 'Exim360';
                        } else {
                            $from = 'services@interlinkiq.com';
                            $name = 'InterlinkIQ';
                            $body .= 'InterlinkIQ.com Team<br>
                            Consultare Inc.';
                        }
                        php_mailer_1($to, $user, $subject, $body, $from, $name);
                    }

    				$output = array(
    					"ID" => $last_id,
    					"parent_id" => $parent_id,
    					"requirements" => stripcslashes($requirements),
    					"action_items" => stripcslashes($action_items),
    					'compliant' => $compliance_compliant,
    					"frequency" => $frequency,
    					"files" => $files
    				);

                        $body .= '<br><br><a href="'. $base_url .'dashboard?d='. $last_id .'" target="_blank" style="font-weight: 600; padding: 10px 20px!important; text-decoration: none; color: #fff; background-color: #27a4b0; border-color: #208992; display: inline-block;">View Here</a>';

    				// Update History Data
    				actionHistory($parent_id, 1, 3, $last_id);
    			}
    		}
    		mysqli_close($conn);

    		echo json_encode($output);
        }
	}
	if( isset($_POST['btnUpdate_Compliance']) ) {
    	$ID = $_POST['ID'];
		$parent_id = $_POST['parent_id'];
		$action_items = addslashes($_POST['action_items']);
		$requirements = addslashes($_POST['requirements']);

		$frequency = $_POST['frequency'];
		$time = $_POST['time'];
		$days = $_POST['days'];
		$day = $_POST['day'];
		$month = $_POST['month'];
		$last_modified = date('Y-m-d');
        $process = true;

		$frequency_id = array();
		array_push($frequency_id, $time);
		array_push($frequency_id, $days);
		array_push($frequency_id, $day);
		array_push($frequency_id, $month);
		$frequency_id = implode(", ",$frequency_id);

		mysqli_query( $conn,"UPDATE tbl_library_compliance SET action_items='". $action_items ."', requirements='". $requirements ."', frequency='". $frequency ."', schedule='". $frequency_id ."', last_modified='". $last_modified ."' WHERE ID='". $ID ."'" );

		$selectData = mysqli_query( $conn,'SELECT * FROM tbl_library_compliance WHERE ID="'. $ID .'" ORDER BY ID LIMIT 1' );
		if ( mysqli_num_rows($selectData) > 0 ) {
			$rowData = mysqli_fetch_array($selectData);
            $compliant = $rowData['compliant'];
            $compliance_frequency = $rowData['frequency'];
            $compliance_schedule_id = $rowData['schedule'];
            $array_schedule_id = explode(", ", $compliance_schedule_id);
			$days = array(
                1 => 'Monday',
                2 => 'Tuesday',
                3 => 'Wednesday',
                4 => 'Thursday',
                5 => 'Friday',
                6 => 'Saturday',
                7 => 'Sunday'
            );

			$frequency = $compliance_frequency;
			if ( count($array_schedule_id) == 4 ) {
                $time = $array_schedule_id[0];
                $time_f = date_create($time);
                $day_ms = $array_schedule_id[1];
                $day_num = $array_schedule_id[2];
                $month = $array_schedule_id[3];

                if ($compliance_frequency == 1) {             // Daily

                    $frequency = 'Daily';
                	if (!empty($time)) {
                		$frequency = 'Every '. date_format($time_f,"g:i A") .' daily';
                	}
                } else if ($compliance_frequency == 2) {      // Weekly

                	$frequency = 'Weekly';
                	if (!empty($day_ms) AND !empty($time)) {
                		$frequency = 'Every '. $days[$day_ms] .' at '. date_format($time_f,"g:i A");
                	}
                } else if ($compliance_frequency == 3) {      // Monthly

                	$frequency = 'Monthly';
                	if (!empty($day_num) AND !empty($time)) {
                		$frequency = 'Every '. $day_num.date("S", mktime(0, 0, 0, 0, intval($day_num), 0)) .' day of the Month at '. date_format($time_f,"g:i A");
                	}
                } else if ($compliance_frequency == 4) {      // Yearly

                	$frequency = 'Yearly';
                	if (!empty($day_num) AND !empty($time) AND !empty($month)) {
                		$frequency = 'Every '. $day_num.date("S", mktime(0, 0, 0, 0, intval($day_num), 0)) .' day of '. date("F", mktime(0, 0, 0, intval($month)+1, 0, 0)) .' at '. date_format($time_f,"g:i A");
                	}
                }
            }


            $files = '';
            $arr_item = array();
            if (!empty($rowData["file_history"])) {
                $arr_item = json_decode($rowData["file_history"],true);
            }

            $filetype = $_POST['filetype'];
            if ($filetype > 0) {
                if ($filetype == 1) {
                    $files = $_FILES['file']['name'];
                    if (!empty($files)) {
                        $path = 'uploads/library/';
                        $filesize = $_FILES['file']['size'];
                        $tmp = $_FILES['file']['tmp_name'];
                        $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                        $ext = strtolower(pathinfo($files, PATHINFO_EXTENSION));
                        $files = rand(1000,1000000) . ' - ' . $files;
                        $path = $path.$files;

                        if(!in_array($ext, $invalid_extensions)) {
                            move_uploaded_file($tmp,$path);

                            $filesize_tot = $filesize + $rowData["filesize"];

                            mysqli_query( $conn,"UPDATE tbl_library_compliance SET filesize='". $filesize_tot ."' WHERE ID='". $ID ."'" );
                        } else {
                            $process = false;
                        }
                    }
                } else {
                    $files = $_POST['fileurl'];
                    $filesize = 0;
                }

                if (!empty($files) AND $process == true) {
                    $output = array (
                        'type' =>  $filetype,
                        'name' =>  $files,
                        'size' =>  $filesize,
                        'date' =>  $local_date
                    );
                    array_push($arr_item, $output);
                    $file_history = json_encode($arr_item, JSON_HEX_APOS | JSON_UNESCAPED_UNICODE);

                    mysqli_query( $conn,"UPDATE tbl_library_compliance SET files='". $files ."', filetype='". $filetype ."', file_history='". $file_history ."' WHERE ID='". $ID ."'" );
                }
            }

            if ($process == true) {
                $filetype = $rowData['filetype'];
                $files = $rowData["files"];
                $type = 'iframe';
                $file_extension = 'fa-youtube-play';
                if (!empty($files)) {
                    if ($filetype == 1) {
                        $fileExtension = fileExtension($files);
                        $src = $fileExtension['src'];
                        $embed = $fileExtension['embed'];
                        $type = $fileExtension['type'];
                        $file_extension = $fileExtension['file_extension'];
                        $url = $base_url.'uploads/library/';

                        $files = $src.$url.rawurlencode($files).$embed;
                    } else if ($filetype == 3) {
                        $files = preg_replace('#[^/]*$#', '', $files).'preview';
                        $file_extension = 'fa-google';
                    }
                    $files = '<a href="'.$files.'" data-src="'.$files.'" data-fancybox data-type="'.$type.'">View</a>';
                }

    			$output = array(
    				"ID" => $ID,
    				"parent_id" => $parent_id,
    				"requirements" => stripcslashes($requirements),
    				"action_items" => stripcslashes($action_items),
    				"compliant" => $compliant,
    				"frequency" => $frequency,
    				"files" => $files
    			);
    			echo json_encode($output);
    			
    			// Update History Data
    			actionHistory($parent_id, 2, 3, $ID);
                mysqli_close($conn);
    		}
        }
	}
	if( isset($_POST['btnSaveMore_Compliance']) ) {
        if (!empty($_COOKIE['switchAccount'])) {
            $portal_user = $_COOKIE['ID'];
            $user_id = $_COOKIE['switchAccount'];
        }
        else {
            $portal_user = $_COOKIE['ID'];
            $user_id = employerID($portal_user);
        }

        $free_access = 0;
        $hasLibrary = mysqli_query( $conn,"SELECT * FROM tbl_library WHERE user_id = $user_id" );
        if ( mysqli_num_rows($hasLibrary) == 0 ) {
            $user_id = 163;
            $free_access = 1;
        }

    	$current_userID = $_COOKIE['ID'];
		$library_id = $_POST['library_id'];
		$type = $_POST['type'];
		$comment = addslashes($_POST['comment']);
		$ID = $_POST['ID'];
		$last_modified = date('Y-m-d');
        $process = true;

        $filetype = $_POST['filetype'];
        if ($filetype == 1) {
            $files = $_FILES['file']['name'];
            if (!empty($files)) {
                $path = 'uploads/library/';
                $tmp = $_FILES['file']['tmp_name'];
                $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                $ext = strtolower(pathinfo($files, PATHINFO_EXTENSION));
                $files = rand(1000,1000000) . ' - ' . $files;
                $path = $path.$files;

                if(!in_array($ext, $invalid_extensions)) {
                    move_uploaded_file($tmp,$path);
                } else {
                    $process = false;
                }
            }
        } else {
            $files = $_POST['fileurl'];
        }

        if ($process == true) {
    		$sql = "INSERT INTO tbl_library_compliance (user_id, library_id, free_access, comment, files, filetype, type, parent_id, last_modified)
    		VALUES ('$current_userID', '$library_id', '$free_access', '$comment', '$files', '$filetype', '$type', '$ID', '$last_modified')";
    		
    		if (mysqli_query($conn, $sql)) {
    			$last_id = mysqli_insert_id($conn);

    			// Select Compliance Parent
    			$selectData = mysqli_query( $conn,'SELECT * FROM tbl_library_compliance WHERE ID="'. $ID .'" ORDER BY ID LIMIT 1' );
    			$rowData = mysqli_fetch_array($selectData);

    			$new_child_id = array();
    			if ( !empty($rowData['child_id']) ) {
    				array_push($new_child_id, $rowData['child_id']);
    			}
    			array_push($new_child_id, $last_id);
    			$new_child_id = implode(", ",$new_child_id);

    			// Update Selected Compliance Parent
    			mysqli_query( $conn,"UPDATE tbl_library_compliance set child_id='". $new_child_id ."' WHERE ID='". $ID ."'" );
    			if ($type == 3) { mysqli_query( $conn,"UPDATE tbl_library_compliance set compliant = 1 WHERE ID='". $ID ."'" ); }
    			else { mysqli_query( $conn,"UPDATE tbl_library_compliance set compliant = 0 WHERE ID='". $ID ."'" ); }

    			// Select Review Compliance Data
    			$selectData = mysqli_query( $conn,'SELECT * FROM tbl_library_compliance WHERE user_id="'. $current_userID .'" AND ID="'. $last_id .'" ORDER BY ID LIMIT 1' );
    			if ( mysqli_num_rows($selectData) > 0 ) {
    				$rowData = mysqli_fetch_array($selectData);
                    $compliance_parent_id = $rowData['parent_id'];
                    $compliance_compliant = $rowData['compliant'];
                    $compliance_requirements = $rowData['requirements'];
                    $compliance_action_items = $rowData['action_items'];

                    $compliance_user_id = $rowData["user_id"];
                    $selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $compliance_user_id " );
                    $rowUser = mysqli_fetch_array($selectUser);
                    $compliance_user = $rowUser["first_name"] .' '. $rowUser["last_name"];

                    $compliance_type = $rowData["type"];
    				$ctype = array(
                        0 => 'Observed',
                        1 => 'Performed',
                        2 => 'Verified',
                        3 => 'Reviewed'
    				);

                    $filetype = $rowData['filetype'];
                    $files = $rowData["files"];
                    $type = 'iframe';
                    $file_extension = 'fa-youtube-play';
                    if (!empty($files)) {
                        if ($filetype == 1) {
                            $fileExtension = fileExtension($files);
                            $src = $fileExtension['src'];
                            $embed = $fileExtension['embed'];
                            $type = $fileExtension['type'];
                            $file_extension = $fileExtension['file_extension'];
                            $url = $base_url.'uploads/library/';

                            $files = $src.$url.rawurlencode($files).$embed;
                        } else if ($filetype == 3) {
                            $files = preg_replace('#[^/]*$#', '', $files).'preview';
                            $file_extension = 'fa-google';
                        }
                        $files = '<a href="'.$files.'" data-src="'.$files.'" data-fancybox data-type="'.$type.'">View</a>';
                    }

                	$compliance_last_modified = $rowData["last_modified"];
                    $compliance_last_modified = new DateTime($compliance_last_modified);
                    $compliance_last_modified = $compliance_last_modified->format('M d, Y');


                    $selectLibrary = mysqli_query( $conn,"SELECT * FROM tbl_library WHERE deleted = 0 AND ID = $library_id" );
                    if ( mysqli_num_rows($selectLibrary) > 0 ) {
                        $rowLibrary = mysqli_fetch_array($selectLibrary);
                        $library_type = $rowLibrary["type"];
                    }
                    $array_library_type = array(
                        1 => 'Programs',
                        2 => 'Policy',
                        3 => 'Procedure',
                        4 => 'Freelance',
                        5 => 'Form'
                    );
                    $selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $user_id" );
                    if ( mysqli_num_rows($selectUser) > 0 ) {
                        $rowUser = mysqli_fetch_array($selectUser);
                        $to = $rowUser["email"];
                        $user = $rowUser["first_name"].' '.$rowUser["last_name"];

                        $subject = 'Compliance Requirement  Ready to be Performed!';
                        $body = 'Hi '.$user.',<br><br>

                        The following compliance requirement is ready to be performed:<br><br>

                        Type - '.$array_library_type[$library_type].'<br>
                        Requirements  '.stripcslashes($compliance_requirements).'<br>
                        Action Items  '.stripcslashes($compliance_action_items).'<br>
                        Frequency  '.$frequency.'<br><br>';

                        if ($_COOKIE['client'] == 1) {
                            $from = 'CannOS@begreenlegal.com';
                            $name = 'BeGreenLegal';
                            $body .= 'Cann OS Team';
                        } else if ($_COOKIE['client'] == 2) {
                            $from = 'foodsafety360r@gmail.com';
                            $name = 'Food Safety 360';
                            $body .= 'Food Safety 360';
                        } else if ($_COOKIE['client'] == 3) {
                            $from = 'cannabis360r@gmail.com';
                            $name = 'SafeCannabis360';
                            $body .= 'SafeCannabis360';
                        } else if ($_COOKIE['client'] == 4) {
                            $from = 'exim360r@gmail.com';
                            $name = 'Exim360';
                            $body .= 'Exim360';
                        } else {
                            $from = 'services@interlinkiq.com';
                            $name = 'InterlinkIQ';
                            $body .= 'InterlinkIQ.com Team<br>
                            Consultare Inc.';
                        }

                        $body .= '<br><br><a href="'. $base_url .'dashboard?d='. $last_id .'" target="_blank" style="font-weight: 600; padding: 10px 20px!important; text-decoration: none; color: #fff; background-color: #27a4b0; border-color: #208992; display: inline-block;">View Here</a>';

                        php_mailer_1($to, $user, $subject, $body, $from, $name);
                    }

    				$output = array(
    					"ID" => $last_id,
    					"library_id" => $library_id,
    					"parent_id" => $compliance_parent_id,
    					'user' => $compliance_user,
    					'type' => $ctype[$compliance_type],
    					'type_id' => $compliance_type,
    					'compliant' => $compliance_compliant,
    					"files" => $files,
    					"comment" => stripcslashes($comment),
    					'last_modified' => $compliance_last_modified
    				);

    				// Update History Data
    				actionHistory($library_id, 1, 3, $last_id);
    			}
    		}
    		mysqli_close($conn);

    		echo json_encode($output);
        }
	}
	if( isset($_POST['btnUpdateMore_Compliance']) ) {
        if (!empty($_COOKIE['switchAccount'])) {
            $portal_user = $_COOKIE['ID'];
            $user_id = $_COOKIE['switchAccount'];
        }
        else {
            $portal_user = $_COOKIE['ID'];
            $user_id = employerID($portal_user);
        }

        $hasLibrary = mysqli_query( $conn,"SELECT * FROM tbl_library WHERE user_id = $user_id" );
        if ( mysqli_num_rows($hasLibrary) == 0 ) {
            $user_id = 163;
        }

    	$current_userID = $_COOKIE['ID'];
		$library_id = $_POST['library_id'];
		$type = $_POST['type'];
		$comment = addslashes($_POST['comment']);
		$ID = $_POST['ID'];
		$last_modified = date('Y-m-d');
        $process = true;

        $filetype = $_POST['filetype'];
        if ($filetype > 0) {
            if ($filetype == 1) {
                $files = $_FILES['file']['name'];
                if (!empty($files)) {
                    $path = 'uploads/library/';
                    $tmp = $_FILES['file']['tmp_name'];
                    $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                    $ext = strtolower(pathinfo($files, PATHINFO_EXTENSION));
                    $files = rand(1000,1000000) . ' - ' . $files;
                    $path = $path.$files;

                    if(!in_array($ext, $invalid_extensions)) {
                        move_uploaded_file($tmp,$path);

                        mysqli_query( $conn,"UPDATE tbl_library_compliance set files='". $files ."', filetype='". $filetype ."' WHERE ID='". $ID ."'" );
                    } else {
                        $process = false;
                    }
                }
            } else {
                $files = $_POST['fileurl'];
                if (!empty($files)) {
                    mysqli_query( $conn,"UPDATE tbl_library_compliance set files='". $files ."', filetype='". $filetype ."' WHERE ID='". $ID ."'" );
                }
            }
        }

        if ($process == true) {
    		mysqli_query( $conn,"UPDATE tbl_library_compliance SET user_id='". $current_userID ."', comment='". $comment ."', type='". $type ."', last_modified='". $last_modified ."' WHERE ID='". $ID ."'" );
    		
    		$selectData = mysqli_query( $conn,'SELECT * FROM tbl_library_compliance WHERE ID="'. $ID .'" ORDER BY ID LIMIT 1' );
    		if ( mysqli_num_rows($selectData) > 0 ) {
    			$rowData = mysqli_fetch_array($selectData);
                $compliance_parent_id = $rowData['parent_id'];
                $compliance_remark = $rowData['remark'];

                $compliance_user_id = $rowData["user_id"];
                $selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $compliance_user_id " );
                $rowUser = mysqli_fetch_array($selectUser);
                $compliance_user = $rowUser["first_name"] .' '. $rowUser["last_name"];

                $compliance_type = $rowData["type"];
    			$ctype = array(
                    0 => 'Observed',
                    1 => 'Performed',
                    2 => 'Verified',
                    3 => 'Reviewed'
    			);
    			if ($compliance_type == 3) { mysqli_query( $conn,"UPDATE tbl_library_compliance set compliant = 1 WHERE ID='". $compliance_parent_id ."'" ); }
    			else { mysqli_query( $conn,"UPDATE tbl_library_compliance set compliant = 0 WHERE ID='". $compliance_parent_id ."'" ); }

                $filetype = $rowData['filetype'];
                $files = $rowData["files"];
                $type = 'iframe';
                $file_extension = 'fa-youtube-play';
                if (!empty($files)) {
                    if ($filetype == 1) {
                        $fileExtension = fileExtension($files);
                        $src = $fileExtension['src'];
                        $embed = $fileExtension['embed'];
                        $type = $fileExtension['type'];
                        $file_extension = $fileExtension['file_extension'];
                        $url = $base_url.'uploads/library/';

                        $files = $src.$url.rawurlencode($files).$embed;
                    } else if ($filetype == 3) {
                        $files = preg_replace('#[^/]*$#', '', $files).'preview';
                        $file_extension = 'fa-google';
                    }
                    $files = '<a href="'.$files.'" data-src="'.$files.'" data-fancybox data-type="'.$type.'">View</a>';
                }

            	$compliance_last_modified = $rowData["last_modified"];
                $compliance_last_modified = new DateTime($compliance_last_modified);
                $compliance_last_modified = $compliance_last_modified->format('M d, Y');

                $compliance_action = '';
    			if (!empty($compliance_remark)) {
    				if ($compliance_remark == "1") { $compliance_action .= '<span class="text-success">Accepted</span>'; }
    				else { $compliance_action .= '<span class="text-danger">'.$compliance_remark.'</span>'; }
    			} else {
    				$compliance_action .= '<a href="javascript:;" type="button" class="btn btn-sm btn-link" onclick="btnComplianceAccept('. $ID .')">Accept</a> |
            		<a href="javascript:;" type="button" class="btn btn-sm btn-link" onclick="btnComplianceReject('. $ID .')">Reject</a>';
    			}

    			$output = array(
    				"ID" => $ID,
    				"library_id" => $library_id,
    				"parent_id" => $compliance_parent_id,
    				'user' => $compliance_user,
    				'type' => $ctype[$compliance_type],
    				'type_id' => $compliance_type,
    				"files" => $files,
    				"comment" => stripcslashes($comment),
    				"action" => $compliance_action,
    				'last_modified' => $compliance_last_modified
    			);

    			// Update History Data
    			actionHistory($library_id, 2, 3, $ID);
    		}

    		mysqli_close($conn);

    		echo json_encode($output);
    	}
    }

	// Annual Review Section
    if( isset($_GET['AnnualReviewTemplate']) ) {
        $ID = $_GET['AnnualReviewTemplate'];
        $last_modified = date('Y-m-d');

        if (!empty($_COOKIE['switchAccount'])) {
            $portal_user = $_COOKIE['ID'];
            $user_id = $_COOKIE['switchAccount'];
        }
        else {
            $portal_user = $_COOKIE['ID'];
            $user_id = employerID($portal_user);
        }

        $hasLibrary = mysqli_query( $conn,"SELECT * FROM tbl_library WHERE user_id = $user_id" );
        if ( mysqli_num_rows($hasLibrary) == 0 ) {
            $user_id = 163;
        }

        $selectData = mysqli_query( $conn,"WITH RECURSIVE cte (mainID, parentID, childIDs, type, parentCollab, parentName) AS
            (
                SELECT 
                    t1.ID AS mainID,
                    t1.parent_id AS parentID,
                    t1.child_id AS childIDs,
                    t1.type AS type,
                    t1.collaborator_id AS parentCollab,
                    t1.name AS parentName
                FROM tbl_library AS t1
                WHERE t1.deleted = 0 AND t1.user_id = $user_id AND t1.ID = $ID
                
                UNION ALL
                
                SELECT 
                    t2.ID AS mainID,
                    t2.parent_id AS parentID,
                    t2.child_id AS childIDs,
                    t2.type AS type,
                    t2.collaborator_id AS parentCollab,
                    t2.name AS parentName
                FROM tbl_library AS t2
                JOIN cte ON cte.mainID = t2.parent_id
                WHERE t2.deleted = 0 AND t2.user_id = $user_id
            )
            SELECT 
            mainID, parentID, childIDs, type, parentCollab, parentName
            FROM cte" );
        if ( mysqli_num_rows($selectData) > 0 ) {
            while($rowComp = mysqli_fetch_array($selectData)) {
                $comp_ID = $rowComp["mainID"];

                $sql_review = "INSERT INTO tbl_library_review (user_id, library_id, action_items, requirements, filetype, last_modified)
                SELECT '$portal_user', '$comp_ID', item, requirement, 0, '$last_modified'
                FROM tbl_library_review_default
                WHERE deleted = 0";
                mysqli_query($conn, $sql_review);

                // echo $sql_review;
            }
        }
    }
	if( isset($_GET['modalReview']) ) {
		$id = $_GET['modalReview'];

		echo '<input class="form-control" type="hidden" name="parent_id" value="'. $id .'" />
		<div class="form-group">
            <label class="col-md-3 control-label">Requirements</label>
            <div class="col-md-8">
            	<input type="text" class="form-control tagsinput" id="requirements" name="requirements" data-role="tagsinput" required />
                <span class="form-text text-muted">Enter multiple requirements separated by comma</span>
            </div>
        </div>
		<div class="form-group">
            <label class="col-md-3 control-label">Compliance Action Items</label>
            <div class="col-md-8">
            	<input type="text" class="form-control tagsinput" id="action_items" name="action_items" data-role="tagsinput" required />
                <span class="form-text text-muted">Enter multiple action items separated by comma</span>
            </div>
        </div>
		<div class="form-group">
            <label class="col-md-3 control-label">Upload Document</label>
            <div class="col-md-8">
                <select class="form-control" name="filetype" onchange="changeType(this)" required>
                    <option value="0">Select option</option>
                    <option value="1">Manual Upload</option>
                    <option value="3">Google Drive URL</option>
                </select>
                <input class="form-control margin-top-15 fileUpload" type="file" name="file" style="display: none;" />
                <input class="form-control margin-top-15 fileURL" type="url" name="fileurl" style="display: none;" placeholder="https://" />
            </div>
        </div>';

        mysqli_close($conn);
	}
	if( isset($_GET['modalReview_Edit']) ) {
		$id = $_GET['modalReview_Edit'];

		$selectData = mysqli_query( $conn,"SELECT * FROM tbl_library_review WHERE ID = $id" );
		if ( mysqli_num_rows($selectData) > 0 ) {
            $row = mysqli_fetch_array($selectData);
            $library_id = $row["library_id"];
            $requirements = $row["requirements"];
            $action_items = $row["action_items"];
            $compliant = $row["compliant"];
            $title = $row["title"];
            $template = $row["template"];
            $comment = $row["comment"];
            $last_modified = $row["last_modified"];

            $files = '';
            $type = 'iframe';
            if (!empty($row["files"])) {
                $arr_filename = explode(' | ', $row["files"]);
                $arr_filetype = explode(' | ', $row["filetype"]);
                $str_filename = '';

                foreach($arr_filename as $val_filename) {
                    $str_filename = $val_filename;
                }
                foreach($arr_filetype as $val_filetype) {
                    $str_filetype = $val_filetype;
                }

                $files = $str_filename;
                if ($str_filetype == 1) {
                    $fileExtension = fileExtension($str_filename);
                    $src = $fileExtension['src'];
                    $embed = $fileExtension['embed'];
                    $type = $fileExtension['type'];
                    $file_extension = $fileExtension['file_extension'];
                    $url = $base_url.'uploads/library/';

                    $files = $src.$url.rawurlencode($str_filename).$embed;
                } else if ($str_filetype == 3) {
                    $files = preg_replace('#[^/]*$#', '', $str_filename).'preview';
                }
            }
        }

		echo '<input class="form-control" type="hidden" name="ID" value="'. $id .'" />
		<input class="form-control" type="hidden" name="parent_id" value="'. $library_id .'" />
		<div class="form-group">
            <label class="col-md-3 control-label">Requirements</label>
            <div class="col-md-8">
            	<input type="text" class="form-control tagsinput" id="requirements" name="requirements" value="'. $requirements .'" data-role="tagsinput" required />
                <span class="form-text text-muted">Enter multiple requirements separated by comma</span>
            </div>
        </div>
		<div class="form-group">
            <label class="col-md-3 control-label">Compliance Action Items</label>
            <div class="col-md-8">
            	<input type="text" class="form-control tagsinput" id="action_items" name="action_items" value="'. $action_items .'" data-role="tagsinput" required />
                <span class="form-text text-muted">Enter multiple action items separated by comma</span>
            </div>
        </div>
		<div class="form-group">
            <label class="col-md-3 control-label">Upload Document</label>
            <div class="col-md-8">
                <select class="form-control '; echo !empty($files) ? 'hide':''; echo '" name="filetype" onchange="changeType(this)" required>
                    <option value="0">Select option</option>
                    <option value="1">Manual Upload</option>
                    <option value="3">Google Drive URL</option>
                </select>
                <input class="form-control margin-top-15 fileUpload" type="file" name="file" style="display: none;" />
                <input class="form-control margin-top-15 fileURL" type="url" name="fileurl" style="display: none;" placeholder="https://" />
                <p class="'; echo !empty($files) ? '':'hide'; echo '" style="margin: 0;"><a href="'.$files.'" data-src="'.$files.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a> | <button type="button" class="btn btn-link uploadNew" onclick="uploadNew(this)">Upload New</button></p>
           </div>
        </div>
		<div class="form-group">
            <label class="col-md-3 control-label">Date</label>
            <div class="col-md-8">
                <input class="form-control" type="date" name="date" value="'.$last_modified.'" required />
            </div>
        </div>';

        mysqli_close($conn);
	}
	if( isset($_GET['modalReview_Action']) ) {
		$id = $_GET['modalReview_Action'];
		$today = date('Y-m-d');

		$selectData = mysqli_query( $conn,"SELECT * FROM tbl_library_review WHERE ID = $id" );
		if ( mysqli_num_rows($selectData) > 0 ) {
            $row = mysqli_fetch_array($selectData);
            $library_id = $row["library_id"];
            $title = $row["title"];
        }

		echo '<input class="form-control" type="hidden" name="ID" value="'. $id .'" />
		<input class="form-control" type="hidden" name="library_id" value="'. $library_id .'" />
		<div class="form-group">
            <label class="col-md-3 control-label">Compliant</label>
            <div class="col-md-8">
                <input type="checkbox" class="make-switch" name="compliant" data-on-text="Yes" data-off-text="No" data-on-color="success" data-off-color="danger" checked/>
            </div>
        </div>
		<div class="form-group">
            <label class="col-md-3 control-label">Observation Title</label>
            <div class="col-md-8">
                <input class="form-control" type="text" name="title" required />
            </div>
        </div>
		<div class="form-group">
            <label class="col-md-3 control-label">Comment</label>
            <div class="col-md-8">
                <textarea class="form-control description_template" name="comment" placeholder="Enter your detailed comment here" required></textarea>
            </div>
        </div>
        <div class="form-group">
            <label class="col-md-3 control-label">Upload Document</label>
            <div class="col-md-8">
                <select class="form-control" name="filetype" onchange="changeType(this)" required>
                    <option value="0">Select option</option>
                    <option value="1">Manual Upload</option>
                    <option value="3">Google Drive URL</option>
                </select>
                <input class="form-control margin-top-15 fileUpload" type="file" name="file" style="display: none;" />
                <input class="form-control margin-top-15 fileURL" type="url" name="fileurl" style="display: none;" placeholder="https://" />
            </div>
        </div>
		<div class="form-group">
            <label class="col-md-3 control-label">Date</label>
            <div class="col-md-8">
                <input class="form-control" type="date" name="date" value="'. $today .'" required />
            </div>
        </div>';

        mysqli_close($conn);
	}
	if( isset($_GET['modalReview_ActionEdit']) ) {
		$id = $_GET['modalReview_ActionEdit'];

		$selectData = mysqli_query( $conn,"SELECT * FROM tbl_library_review WHERE ID = $id" );
		if ( mysqli_num_rows($selectData) > 0 ) {
            $row = mysqli_fetch_array($selectData);
            $library_id = $row["library_id"];
            $compliant = $row["compliant"];
            $title = $row["title"];
            $comment = $row["comment"];
            $type = $row["type"];
            $last_modified = $row["last_modified"];

            $files = '';
            $type = 'iframe';
            if (!empty($row["files"])) {
                $arr_filename = explode(' | ', $row["files"]);
                $arr_filetype = explode(' | ', $row["filetype"]);
                $str_filename = '';

                foreach($arr_filename as $val_filename) {
                    $str_filename = $val_filename;
                }
                foreach($arr_filetype as $val_filetype) {
                    $str_filetype = $val_filetype;
                }

                $files = $str_filename;
                if ($str_filetype == 1) {
                    $fileExtension = fileExtension($str_filename);
                    $src = $fileExtension['src'];
                    $embed = $fileExtension['embed'];
                    $type = $fileExtension['type'];
                    $file_extension = $fileExtension['file_extension'];
                    $url = $base_url.'uploads/library/';

                    $files = $src.$url.rawurlencode($str_filename).$embed;
                } else if ($str_filetype == 3) {
                    $files = preg_replace('#[^/]*$#', '', $str_filename).'preview';
                }
            }
        }

		echo '<input class="form-control" type="hidden" name="ID" value="'. $id .'" />
		<input class="form-control" type="hidden" name="library_id" value="'. $library_id .'" />
		<div class="form-group">
            <label class="col-md-3 control-label">Compliant</label>
            <div class="col-md-8">
                <input type="checkbox" class="make-switch" name="compliant" data-on-text="Yes" data-off-text="No" data-on-color="success" data-off-color="danger"'; echo $compliant == 1 ? 'checked':''; echo '/>
            </div>
        </div>
		<div class="form-group">
            <label class="col-md-3 control-label">Observation Title</label>
            <div class="col-md-8">
                <input class="form-control" type="text" name="title" value="'.$title.'" required />
            </div>
        </div>
		<div class="form-group">
            <label class="col-md-3 control-label">Comment</label>
            <div class="col-md-8">
                <textarea class="form-control description_template" name="comment" placeholder="Enter your detailed comment here" required>'.$comment.'</textarea>
            </div>
        </div>
        <div class="form-group">
            <label class="col-md-3 control-label">Upload Document</label>
            <div class="col-md-8">
                <select class="form-control '; echo !empty($files) ? 'hide':''; echo '" name="filetype" onchange="changeType(this)" required>
                    <option value="0">Select option</option>
                    <option value="1">Manual Upload</option>
                    <option value="3">Google Drive URL</option>
                </select>
                <input class="form-control margin-top-15 fileUpload" type="file" name="file" style="display: none;" />
                <input class="form-control margin-top-15 fileURL" type="url" name="fileurl" style="display: none;" placeholder="https://" />
                <p class="'; echo !empty($files) ? '':'hide'; echo '" style="margin: 0;"><a href="'.$files.'" data-src="'.$files.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a> | <button type="button" class="btn btn-link uploadNew" onclick="uploadNew(this)">Upload New</button></p>
            </div>
        </div>
		<div class="form-group">
            <label class="col-md-3 control-label">Date</label>
            <div class="col-md-8">
                <input class="form-control" type="date" name="date" value="'. $last_modified .'" required />
            </div>
        </div>';

        mysqli_close($conn);
	}
	if( isset($_GET['modalReview_More']) ) {
		$id = $_GET['modalReview_More'];
		$today = date('Y-m-d');

		$selectData = mysqli_query( $conn,"SELECT * FROM tbl_library_review WHERE ID = $id" );
		if ( mysqli_num_rows($selectData) > 0 ) {
            $row = mysqli_fetch_array($selectData);
            $library_id = $row["library_id"];
            $parent_id = $row["parent_id"];
            $title = $row["title"];
        }

		echo '<input class="form-control" type="hidden" name="ID" value="'. $id .'" />
		<input class="form-control" type="hidden" name="library_id" value="'. $library_id .'" />
		<input class="form-control" type="hidden" name="parent_id" value="'. $parent_id .'" />
		<div class="form-group">
            <label class="col-md-3 control-label">Select Action</label>
            <div class="col-md-8">
            	<select class="form-control" name="type">
            		<option value="1">Correction</option>
            		<option value="2">Verification</option>
            		<option value="3">Approve</option>
            	</select>
            </div>
        </div>
		<div class="form-group">
            <label class="col-md-3 control-label">Action Title</label>
            <div class="col-md-8">
                <input class="form-control" type="text" name="title" value="'.$title.'" required />
            </div>
        </div>
		<div class="form-group">
            <label class="col-md-3 control-label">Comment</label>
            <div class="col-md-8">
                <textarea class="form-control" name="comment" placeholder="Enter your detailed comment here" required></textarea>
            </div>
        </div>
        <div class="form-group">
            <label class="col-md-3 control-label">Upload Document</label>
            <div class="col-md-8">
                <select class="form-control" name="filetype" onchange="changeType(this)" required>
                    <option value="0">Select option</option>
                    <option value="1">Manual Upload</option>
                    <option value="3">Google Drive URL</option>
                </select>
                <input class="form-control margin-top-15 fileUpload" type="file" name="file" style="display: none;" />
                <input class="form-control margin-top-15 fileURL" type="url" name="fileurl" style="display: none;" placeholder="https://" />
            </div>
        </div>
		<div class="form-group">
            <label class="col-md-3 control-label">Date</label>
            <div class="col-md-8">
                <input class="form-control" type="date" name="date" value="'.$today.'" required />
            </div>
        </div>';

        mysqli_close($conn);
	}
	if( isset($_GET['modalReview_MoreEdit']) ) {
		$id = $_GET['modalReview_MoreEdit'];

		$selectData = mysqli_query( $conn,"SELECT * FROM tbl_library_review WHERE ID = $id" );
		if ( mysqli_num_rows($selectData) > 0 ) {
            $row = mysqli_fetch_array($selectData);
            $library_id = $row["library_id"];
            $parent_id = $row["parent_id"];
            $title = $row["title"];
            $comment = $row["comment"];
            $type = $row["type"];
            $last_modified = $row["last_modified"];

            $files = '';
            $type = 'iframe';
            if (!empty($row["files"])) {
                $arr_filename = explode(' | ', $row["files"]);
                $arr_filetype = explode(' | ', $row["filetype"]);
                $str_filename = '';

                foreach($arr_filename as $val_filename) {
                    $str_filename = $val_filename;
                }
                foreach($arr_filetype as $val_filetype) {
                    $str_filetype = $val_filetype;
                }

                $files = $str_filename;
                if ($str_filetype == 1) {
                    $fileExtension = fileExtension($str_filename);
                    $src = $fileExtension['src'];
                    $embed = $fileExtension['embed'];
                    $type = $fileExtension['type'];
                    $file_extension = $fileExtension['file_extension'];
                    $url = $base_url.'uploads/library/';

                    $files = $src.$url.rawurlencode($str_filename).$embed;
                } else if ($str_filetype == 3) {
                    $files = preg_replace('#[^/]*$#', '', $str_filename).'preview';
                }
            }
        }

		echo '<input class="form-control" type="hidden" name="ID" value="'. $id .'" />
		<input class="form-control" type="hidden" name="library_id" value="'. $library_id .'" />
		<input class="form-control" type="hidden" name="parent_id" value="'. $parent_id .'" />
		<div class="form-group">
            <label class="col-md-3 control-label">Select Action</label>
            <div class="col-md-8">
            	<select class="form-control" name="type">
            		<option value="1" '; echo $type == 1 ? 'SELECTED':''; echo '>Correction</option>
            		<option value="2" '; echo $type == 2 ? 'SELECTED':''; echo '>Verification</option>
            		<option value="3" '; echo $type == 3 ? 'SELECTED':''; echo '>Approve</option>
            	</select>
            </div>
        </div>
		<div class="form-group">
            <label class="col-md-3 control-label">Action Title</label>
            <div class="col-md-8">
                <input class="form-control" type="text" name="title" value="'.$title.'" required />
            </div>
        </div>
		<div class="form-group">
            <label class="col-md-3 control-label">Comment</label>
            <div class="col-md-8">
                <textarea class="form-control" name="comment" placeholder="Enter your detailed comment here" required>'.$comment.'</textarea>
            </div>
        </div>
        <div class="form-group">
            <label class="col-md-3 control-label">Upload Document</label>
            <div class="col-md-8">
                <select class="form-control '; echo !empty($files) ? 'hide':''; echo '" name="filetype" onchange="changeType(this)" required>
                    <option value="0">Select option</option>
                    <option value="1">Manual Upload</option>
                    <option value="3">Google Drive URL</option>
                </select>
                <input class="form-control margin-top-15 fileUpload" type="file" name="file" style="display: none;" />
                <input class="form-control margin-top-15 fileURL" type="url" name="fileurl" style="display: none;" placeholder="https://" />
                <p class="'; echo !empty($files) ? '':'hide'; echo '" style="margin: 0;"><a href="'.$files.'" data-src="'.$files.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a> | <button type="button" class="btn btn-link uploadNew" onclick="uploadNew(this)">Upload New</button></p>
            </div>
        </div>
		<div class="form-group">
            <label class="col-md-3 control-label">Date</label>
            <div class="col-md-8">
                <input class="form-control" type="date" name="date" value="'.$last_modified.'" required />
            </div>
        </div>';

        mysqli_close($conn);
	}
	if( isset($_GET['btnDelete_Review']) ) {
		$id = $_GET['btnDelete_Review'];
    	$current_userID = $_COOKIE['ID'];
		$reason = addslashes($_GET['reason']);

        $message = array();
		array_push($message, $current_userID);
		array_push($message, $reason);
		$message = implode(" | ",$message);

		mysqli_query( $conn,"UPDATE tbl_library_review SET is_deleted = 1, reason = '". $message ."' WHERE ID='". $id ."'" );

		$selectData = mysqli_query( $conn,'SELECT * FROM tbl_library_review WHERE ID="'. $id .'"' );
		$rowData = mysqli_fetch_array($selectData);
        $data_library_id = $rowData['library_id'];
			
		// Update History Data
		actionHistory($data_library_id, 3, 4, $id);
	}
	if( isset($_GET['btnAccept_Review']) ) {
		$id = $_GET['btnAccept_Review'];
    	$current_userID = $_COOKIE['ID'];

		mysqli_query( $conn,"UPDATE tbl_library_review SET remark = '1', remark_user = '". $current_userID ."' WHERE ID='". $id ."'" );

		$selectData = mysqli_query( $conn,'SELECT * FROM tbl_library_review WHERE ID="'. $id .'"' );
		$rowData = mysqli_fetch_array($selectData);
        $data_library_id = $rowData['library_id'];

		// Update History Data
		actionHistory($data_library_id, 4, 4, $id);
	}
	if( isset($_GET['btnReject_Review']) ) {
		$id = $_GET['btnReject_Review'];
    	$current_userID = $_COOKIE['ID'];
		$reason = addslashes($_GET['reason']);

		mysqli_query( $conn,"UPDATE tbl_library_review SET remark = '".$reason."', remark_user = '". $current_userID ."' WHERE ID='". $id ."'" );

		$selectData = mysqli_query( $conn,'SELECT * FROM tbl_library_review WHERE ID="'. $id .'"' );
		$rowData = mysqli_fetch_array($selectData);
        $data_library_id = $rowData['library_id'];

		// Update History Data
		actionHistory($data_library_id, 5, 4, $id);
	}
	if( isset($_POST['btnSave_Review']) ) {
        if (!empty($_COOKIE['switchAccount'])) {
            $portal_user = $_COOKIE['ID'];
            $user_id = $_COOKIE['switchAccount'];
        }
        else {
            $portal_user = $_COOKIE['ID'];
            $user_id = employerID($portal_user);
        }

        $free_access = 0;
        $hasLibrary = mysqli_query( $conn,"SELECT * FROM tbl_library WHERE user_id = $user_id" );
        if ( mysqli_num_rows($hasLibrary) == 0 ) {
            $user_id = 163;
            $free_access = 1;
        }

    	$current_userID = $_COOKIE['ID'];
		$parent_id = $_POST['parent_id'];
		$requirements = addslashes($_POST['requirements']);
		$action_items = addslashes($_POST['action_items']);
		$last_modified = date('Y-m-d');
        $arr_item = array();
        $process = true;

        $filetype = $_POST['filetype'];
        if ($filetype == 1) {
            $files = $_FILES['file']['name'];
            if (!empty($files)) {
                $path = 'uploads/library/';
                $filesize = $_FILES['file']['size'];
                $tmp = $_FILES['file']['tmp_name'];
                $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                $ext = strtolower(pathinfo($files, PATHINFO_EXTENSION));
                $files = rand(1000,1000000) . ' - ' . $files;
                $path = $path.$files;

                if(!in_array($ext, $invalid_extensions)) {
                    move_uploaded_file($tmp,$path);
                } else {
                    $process = false;
                }
            }
        } else {
            $files = $_POST['fileurl'];
            $filesize = 0;
        }

        if ($process == true) {
            $output = array (
                'type' =>  $filetype,
                'name' =>  $files,
                'size' =>  $filesize,
                'date' =>  $local_date
            );
            array_push($arr_item, $output);
            $file_history = json_encode($arr_item, JSON_HEX_APOS | JSON_UNESCAPED_UNICODE);

            $sql = "INSERT INTO tbl_library_review (user_id, library_id, free_access, action_items, requirements, files, filetype, filesize, file_history, last_modified)
            VALUES ('$current_userID', '$parent_id', '$free_access', '$action_items', '$requirements', '$files', '$filetype', '$filesize', '$file_history', '$last_modified')";
    		
    		//->>>>>>>  START Brandon Auto service log for creating annual review in dashboard<<<<<<<<-
            
    		$current_userID = $_COOKIE['ID'];
    		$action = "created";
    		$minutes = 1;
    		$companyname = "";
    		$comment = "Requirements : ".$requirements . " with the compliance action items: ". $action_items. " and file upload with a name: ".$files;
    		date_default_timezone_set('America/New_York');
    		$datenow = date('Y-m-d') ;

    		if (!empty($_COOKIE['switchAccount'])) {
    			$portal_user = $_COOKIE['ID'];
    			$user_id_account = $_COOKIE['switchAccount'];
    		}
    		else {
    			$portal_user = $_COOKIE['ID'];
    			$user_id_account = employerID($portal_user);
    		}

    		$resultaccountname = mysqli_query( $conn,'SELECT * FROM tblEnterpiseDetails WHERE users_entities = "'.$user_id_account.'" LIMIT 1 ');
    		if ( mysqli_num_rows($resultaccountname) > 0 ) {
    			$rowComment = mysqli_fetch_array($resultaccountname);
    			$companyname = $rowComment["company_code"];
    		}

    		$finaldescription = $companyname."-Adding annual review requirements: " . $requirements;
    		$sql_subitem_autolog = "INSERT INTO tbl_service_logs_draft (`user_id`, `description`,`action`, `comment`, `account`, `minute` , `task_date`) 
    		VALUES ('$current_userID', '$finaldescription','$action','$comment','$companyname','$minutes','$datenow')";

    		mysqli_query($conn, $sql_subitem_autolog);


    		//->>>>>>> END Brandon Auto service log for creating annual review in dashboard<<<<<<<<-
    		
    		if (mysqli_query($conn, $sql)) {
    			$last_id = mysqli_insert_id($conn);
    			$selectData = mysqli_query( $conn,'SELECT * FROM tbl_library_review WHERE ID="'. $last_id .'" ORDER BY ID LIMIT 1' );
    			if ( mysqli_num_rows($selectData) > 0 ) {
    				$rowReview = mysqli_fetch_array($selectData);
    				$review_ID = $rowReview["ID"];
    				$review_compliant = $rowReview["compliant"];
    				$review_parent_id = $rowReview["parent_id"];
    				$review_child_id = $rowReview["child_id"];

                    $filetype = $rowReview['filetype'];
                    $files = $rowReview["files"];
                    $type = 'iframe';
                    $file_extension = 'fa-youtube-play';
                    if (!empty($files)) {
                        if ($filetype == 1) {
                            $fileExtension = fileExtension($files);
                            $src = $fileExtension['src'];
                            $embed = $fileExtension['embed'];
                            $type = $fileExtension['type'];
                            $file_extension = $fileExtension['file_extension'];
                            $url = $base_url.'uploads/library/';

                            $files = $src.$url.rawurlencode($files).$embed;
                        } else if ($filetype == 3) {
                            $files = preg_replace('#[^/]*$#', '', $files).'preview';
                            $file_extension = 'fa-google';
                        }
                        $files = '<a href="'.$files.'" data-src="'.$files.'" data-fancybox data-type="'.$type.'">View</a>';
                    }

    				$output = array(
    					'ID' => $review_ID,
    					"parent_id" => $parent_id,
    					"requirements" => stripcslashes($requirements),
    					"action_items" => stripcslashes($action_items),
    					'compliant' => $review_compliant,
    					'files' => $files
    				);
    				echo json_encode($output);

    				// Update History Data
    				actionHistory($parent_id, 1, 4, $review_ID);
    			}
    		}
    		mysqli_close($conn);
        }
	}
	if( isset($_POST['btnUpdate_Review']) ) {
		$ID = $_POST['ID'];
    	$current_userID = $_COOKIE['ID'];
		$parent_id = $_POST['parent_id'];
		$requirements = addslashes($_POST['requirements']);
		$action_items = addslashes($_POST['action_items']);
    	$last_modified = $_POST['date'];
        $process = true;

    	mysqli_query( $conn,"UPDATE tbl_library_review SET user_id='". $current_userID ."', action_items='". $action_items ."', requirements='". $requirements ."', last_modified='". $last_modified ."' WHERE ID='". $ID ."'" );
		
		$selectData = mysqli_query( $conn,'SELECT * FROM tbl_library_review WHERE ID="'. $ID .'" ORDER BY ID LIMIT 1' );
		if ( mysqli_num_rows($selectData) > 0 ) {
			$rowReview = mysqli_fetch_array($selectData);
			$review_ID = $rowReview["ID"];
			$review_library_id = $rowReview["library_id"];
            $review_action_items = $rowReview["action_items"];
			$review_compliant = $rowReview["compliant"];

			$review_last_modified = $rowReview["last_modified"];
			$review_last_modified = new DateTime($review_last_modified);
			$review_last_modified = $review_last_modified->format('M d, Y');

            $files = '';
            $arr_item = array();
            if (!empty($rowReview["file_history"])) {
                $arr_item = json_decode($rowReview["file_history"],true);
            }

            $filetype = $_POST['filetype'];
            if ($filetype > 0) {
                if ($filetype == 1) {
                    $files = $_FILES['file']['name'];
                    if (!empty($files)) {
                        $path = 'uploads/library/';
                        $filesize = $_FILES['file']['size'];
                        $tmp = $_FILES['file']['tmp_name'];
                        $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                        $ext = strtolower(pathinfo($files, PATHINFO_EXTENSION));
                        $files = rand(1000,1000000) . ' - ' . $files;
                        $path = $path.$files;

                        if(!in_array($ext, $invalid_extensions)) {
                            move_uploaded_file($tmp,$path);

                            $filesize_tot = $filesize + $rowReview["filesize"];

                            mysqli_query( $conn,"UPDATE tbl_library_review SET filesize='". $filesize_tot ."' WHERE ID='". $ID ."'" );
                        } else {
                            $process = false;
                        }
                    }
                } else {
                    $files = $_POST['fileurl'];
                    $filesize = 0;
                }

                if (!empty($files) AND $process == true) {
                    $output = array (
                        'type' =>  $filetype,
                        'name' =>  $files,
                        'size' =>  $filesize,
                        'date' =>  $local_date
                    );
                    array_push($arr_item, $output);
                    $file_history = json_encode($arr_item, JSON_HEX_APOS | JSON_UNESCAPED_UNICODE);

                    mysqli_query( $conn,"UPDATE tbl_library_review SET files='". $files ."', filetype='". $filetype ."', file_history='". $file_history ."' WHERE ID='". $ID ."'" );
                }
            }

            if ($process == true) {
                $type = 'iframe';
                $file_extension = 'fa-youtube-play';
                if (!empty($files)) {
                    if ($filetype == 1) {
                        $fileExtension = fileExtension($files);
                        $src = $fileExtension['src'];
                        $embed = $fileExtension['embed'];
                        $type = $fileExtension['type'];
                        $file_extension = $fileExtension['file_extension'];
                        $url = $base_url.'uploads/library/';

                        $files = $src.$url.rawurlencode($files).$embed;
                    } else if ($filetype == 3) {
                        $files = preg_replace('#[^/]*$#', '', $files).'preview';
                        $file_extension = 'fa-google';
                    }
                    $files = '<a href="'.$files.'" data-src="'.$files.'" data-fancybox data-type="'.$type.'">View</a>';
                }

    			$output = array(
    				'ID' => $review_ID,
    				"parent_id" => $parent_id,
    				"requirements" => stripcslashes($requirements),
    				"action_items" => stripcslashes($action_items),
    				'compliant' => $review_compliant,
    				'files' => $files
    			);
    			echo json_encode($output);
    			
    			// Update History Data
    			actionHistory($review_library_id, 2, 4, $review_ID);
            }
		}

		//->>>>>>>  START Brandon Auto service log for uploading file to dashboard <<<<<<<<-
        if ($process == true) {
    		$current_userID = $_COOKIE['ID'];
    		$action = "Updated";
    		$minutes = 1;
    		$companyname = "";
    		$comment = "Item name : ".$review_action_items . " with the requirements of of : ". $requirements . "and action items of: ". $action_items . " and last date modified of: ". $last_modified;
    		date_default_timezone_set('America/New_York');
    		$datenow = date('Y-m-d') ;

    		if (!empty($_COOKIE['switchAccount'])) {
    			$portal_user = $_COOKIE['ID'];
    			$user_id_account = $_COOKIE['switchAccount'];
    		}
    		else {
    			$portal_user = $_COOKIE['ID'];
    			$user_id_account = employerID($portal_user);
    		}

    		$resultaccountname = mysqli_query( $conn,'SELECT * FROM tblEnterpiseDetails WHERE users_entities = "'.$user_id_account.'" LIMIT 1 ');
    		if ( mysqli_num_rows($resultaccountname) > 0 ) {
    			$rowComment = mysqli_fetch_array($resultaccountname);
    			$companyname = $rowComment["company_code"];
    		}

    		$resultitemname = mysqli_query( $conn,'SELECT * FROM tbl_library WHERE ID = "'.$parent_id.'" LIMIT 1 ');
    		if ( mysqli_num_rows($resultitemname) > 0 ) {
    			$rowComment = mysqli_fetch_array($resultitemname);
    			$name = $rowComment["name"];
    		}

            // $finaldescription = $companyname. "-" .$filesrowname;
            $finaldescription = $name . $datenow;

    		$sql_subitem_autolog = "INSERT INTO tbl_service_logs_draft (`user_id`, `description`,`action`, `comment`, `account`, `minute` , `task_date`) 
    		VALUES ('$current_userID', '$finaldescription','$action','$comment','$companyname','$minutes','$datenow')";

    		mysqli_query($conn, $sql_subitem_autolog);


    		//->>>>>>> END Brandon Auto service log for  uploading file to dashboard <<<<<<<<-

    		mysqli_close($conn);
        }
	}
	if( isset($_POST['btnSaveAction_Review']) ) {
        if (!empty($_COOKIE['switchAccount'])) {
            $portal_user = $_COOKIE['ID'];
            $user_id = $_COOKIE['switchAccount'];
        }
        else {
            $portal_user = $_COOKIE['ID'];
            $user_id = employerID($portal_user);
        }

        $free_access = 0;
        $hasLibrary = mysqli_query( $conn,"SELECT * FROM tbl_library WHERE user_id = $user_id" );
        if ( mysqli_num_rows($hasLibrary) == 0 ) {
            $user_id = 163;
            $free_access = 1;
        }

    	$current_userID = $_COOKIE['ID'];
		$ID = $_POST['ID'];
		$library_id = $_POST['library_id'];
		$compliant = isset($_POST['compliant']) ? 1 : 0;
		$title = addslashes($_POST['title']);
		$comment = addslashes($_POST['comment']);
		$type = 4;
    	$last_modified = $_POST['date'];
        $arr_item = array();
        $process = true;

        $filetype = $_POST['filetype'];
        if ($filetype == 1) {
            $files = $_FILES['file']['name'];
            if (!empty($files)) {
                $path = 'uploads/library/';
                $filesize = $_FILES['file']['size'];
                $tmp = $_FILES['file']['tmp_name'];
                $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                $ext = strtolower(pathinfo($files, PATHINFO_EXTENSION));
                $files = rand(1000,1000000) . ' - ' . $files;
                $path = $path.$files;

                if(!in_array($ext, $invalid_extensions)) {
                    move_uploaded_file($tmp,$path);
                } else {
                    $process = false;
                }
            }
        } else {
            $files = $_POST['fileurl'];
            $filesize = 0;
        }

        if ($process == true) {
            $output = array (
                'type'  =>  $filetype,
                'name' =>  $files,
                'size' =>  $filesize,
                'date' =>  $local_date
            );
            array_push($arr_item, $output);
            $file_history = json_encode($arr_item, JSON_HEX_APOS | JSON_UNESCAPED_UNICODE);

            $sql = "INSERT INTO tbl_library_review (user_id, library_id, free_access, compliant, title, template, comment, type, parent_id, files, filetype, filesize, file_history, last_modified)
            VALUES ('$current_userID', '$library_id', '$free_access', '$compliant', '$title', '2', '$comment', '$type', '$ID', '$files', '$filetype', '$filesize', '$file_history', '$last_modified')";
    		
    		if (mysqli_query($conn, $sql)) {
    			$last_id = mysqli_insert_id($conn);

    			// Select Review Parent
    			$selectData = mysqli_query( $conn,'SELECT * FROM tbl_library_review WHERE ID="'. $ID .'" ORDER BY ID LIMIT 1' );
    			$rowData = mysqli_fetch_array($selectData);

    			$new_child_id = array();
    			if ( !empty($rowData['child_id']) ) {
    				array_push($new_child_id, $rowData['child_id']);
    			}
    			array_push($new_child_id, $last_id);

    			// Insert Child to Selected Review Parent
    			$new_child_id = implode(", ",$new_child_id);
    			mysqli_query( $conn,"UPDATE tbl_library_review set compliant='". $compliant ."', child_id='". $new_child_id ."' WHERE ID='". $ID ."'" );

    			// Select Review Child Data
    			$selectData = mysqli_query( $conn,'SELECT * FROM tbl_library_review WHERE ID="'. $last_id .'" ORDER BY ID LIMIT 1' );
    			if ( mysqli_num_rows($selectData) > 0 ) {
    				$rowReview = mysqli_fetch_array($selectData);
    				$review_ID = $rowReview["ID"];
    				$review_compliant = $rowReview["compliant"];
    				$review_title = $rowReview["title"];
    				$review_comment = $rowReview["comment"];
    				$review_parent_id = $rowReview["parent_id"];

    				$review_user_id = $rowReview["user_id"];
    				$selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $review_user_id " );
    				$rowUser = mysqli_fetch_array($selectUser);
    				$review_name = $rowUser["first_name"] .' '. $rowUser["last_name"];

    				$review_type = $rowReview["type"];
    				$rtype = array(
    				    0 => 'Observed',
    				    1 => 'Corrected',
    				    2 => 'Verified',
    				    3 => 'Approved',
    				    4 => 'Reviewed'
    				);

    				$review_last_modified = $rowReview["last_modified"];
    				$review_last_modified = new DateTime($review_last_modified);
    				$review_last_modified = $review_last_modified->format('M d, Y');

                    $filetype = $rowReview['filetype'];
                    $files = $rowReview["files"];
                    $type = 'iframe';
                    $file_extension = 'fa-youtube-play';
                    if (!empty($files)) {
                        if ($filetype == 1) {
                            $fileExtension = fileExtension($files);
                            $src = $fileExtension['src'];
                            $embed = $fileExtension['embed'];
                            $type = $fileExtension['type'];
                            $file_extension = $fileExtension['file_extension'];
                            $url = $base_url.'uploads/library/';

                            $files = $src.$url.rawurlencode($files).$embed;
                        } else if ($filetype == 3) {
                            $files = preg_replace('#[^/]*$#', '', $files).'preview';
                            $file_extension = 'fa-google';
                        }
                        $files = '<a href="'.$files.'" data-src="'.$files.'" data-fancybox data-type="'.$type.'">View</a>';
                    }

    				$output = array(
    					'ID' => $review_ID,
    					"library_id" => $library_id,
    					"review_parent_id" => $review_parent_id,
    					'compliant' => $review_compliant,
    					'title' => stripcslashes($review_title),
    					'comment' => stripcslashes($review_comment),
    					'name' => $review_name,
    					'type' => $rtype[$review_type],
    					'type_id' => $review_type,
    					'last_modified' => $review_last_modified,
    					'files' => $files
    				);
    				echo json_encode($output);

    				// Update History Data
    				actionHistory($library_id, 1, 4, $review_ID);
    			}
    		}
    		mysqli_close($conn);
        }
	}
	if( isset($_POST['btnUpdateAction_Review']) ) {
    	$current_userID = $_COOKIE['ID'];
		$ID = $_POST['ID'];
		$library_id = $_POST['library_id'];
        $compliant = isset($_POST['compliant']) ? 1 : 0;
		$title = addslashes($_POST['title']);
		$comment = addslashes($_POST['comment']);
    	$last_modified = $_POST['date'];
        $process = true;

    	mysqli_query( $conn,"UPDATE tbl_library_review SET user_id='". $current_userID ."', compliant='". $compliant ."', title='". $title ."', comment='". $comment ."', last_modified='". $last_modified ."' WHERE ID='". $ID ."'" );
		
		$selectData = mysqli_query( $conn,'SELECT * FROM tbl_library_review WHERE ID="'. $ID .'" ORDER BY ID LIMIT 1' );
		if ( mysqli_num_rows($selectData) > 0 ) {
			$rowReview = mysqli_fetch_array($selectData);
			$review_ID = $rowReview["ID"];
			$review_compliant = $rowReview["compliant"];
			$review_title = $rowReview["title"];
			$review_comment = $rowReview["comment"];
			$review_parent_id = $rowReview["parent_id"];

			$review_user_id = $rowReview["user_id"];
			$selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $review_user_id " );
			$rowUser = mysqli_fetch_array($selectUser);
			$review_name = $rowUser["first_name"] .' '. $rowUser["last_name"];

			$review_type = $rowReview["type"];
			$rtype = array(
			    0 => 'Observed',
			    1 => 'Corrected',
			    2 => 'Verified',
			    3 => 'Approved',
				4 => 'Reviewed'
			);

			$review_last_modified = $rowReview["last_modified"];
			$review_last_modified = new DateTime($review_last_modified);
			$review_last_modified = $review_last_modified->format('M d, Y');

            $compliance_action = '';
			if (!empty($compliance_remark)) {
				if ($compliance_remark == "1") { $compliance_action .= '<span class="text-success">Accepted</span>'; }
				else { $compliance_action .= '<span class="text-danger">'.$compliance_remark.'</span>'; }
			} else {
				$compliance_action .= '<a href="javascript:;" type="button" class="btn btn-sm btn-link" onclick="btnReviewAccept('. $ID .')">Accept</a> |
        		<a href="javascript:;" type="button" class="btn btn-sm btn-link" onclick="btnReviewReject('. $ID .')">Reject</a>';
			}

            $files = '';
            $arr_item = array();
            if (!empty($rowReview["file_history"])) {
                $arr_item = json_decode($rowReview["file_history"],true);
            }

            $filetype = $_POST['filetype'];
            if ($filetype > 0) {
                if ($filetype == 1) {
                    $files = $_FILES['file']['name'];
                    if (!empty($files)) {
                        $path = 'uploads/library/';
                        $filesize = $_FILES['file']['size'];
                        $tmp = $_FILES['file']['tmp_name'];
                        $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                        $ext = strtolower(pathinfo($files, PATHINFO_EXTENSION));
                        $files = rand(1000,1000000) . ' - ' . $files;
                        $path = $path.$files;

                        if(!in_array($ext, $invalid_extensions)) {
                            move_uploaded_file($tmp,$path);

                            $filesize_tot = $filesize + $rowReview["filesize"];

                            mysqli_query( $conn,"UPDATE tbl_library_review SET filesize='". $filesize_tot ."' WHERE ID='". $ID ."'" );
                        } else {
                            $process = false;
                        }
                    }
                } else {
                    $files = $_POST['fileurl'];
                    $filesize = 0;
                }

                if (!empty($files) AND $process == true) {
                    $output = array (
                        'type'  =>  $filetype,
                        'name' =>  $files,
                        'size' =>  $filesize,
                        'date' =>  $local_date
                    );
                    array_push($arr_item, $output);
                    $file_history = json_encode($arr_item, JSON_HEX_APOS | JSON_UNESCAPED_UNICODE);

                    mysqli_query( $conn,"UPDATE tbl_library_review SET files='". $files ."', filetype='". $filetype ."', file_history='". $file_history ."' WHERE ID='". $ID ."'" );
                }
            }

            if ($process == true) {
                $type = 'iframe';
                $file_extension = 'fa-youtube-play';
                if (!empty($files)) {
                    if ($filetype == 1) {
                        $fileExtension = fileExtension($files);
                        $src = $fileExtension['src'];
                        $embed = $fileExtension['embed'];
                        $type = $fileExtension['type'];
                        $file_extension = $fileExtension['file_extension'];
                        $url = $base_url.'uploads/library/';

                        $files = $src.$url.rawurlencode($files).$embed;
                    } else if ($filetype == 3) {
                        $files = preg_replace('#[^/]*$#', '', $files).'preview';
                        $file_extension = 'fa-google';
                    }
                    $files = '<a href="'.$files.'" data-src="'.$files.'" data-fancybox data-type="'.$type.'">View</a>';
                }

    			$output = array(
    				'ID' => $review_ID,
    				"library_id" => $library_id,
    				"review_parent_id" => $review_parent_id,
    				'compliant' => $review_compliant,
    				'title' => stripcslashes($review_title),
    				'comment' => stripcslashes($review_comment),
    				"action" => $compliance_action,
    				'name' => $review_name,
    				'type' => $rtype[$review_type],
    				'type_id' => $review_type,
    				'last_modified' => $review_last_modified,
    				'files' => $files
    			);
    			echo json_encode($output);

    			// Update History Data
    			actionHistory($library_id, 2, 4, $review_ID);
                mysqli_close($conn);
    		}
        }
	}
	if( isset($_POST['btnSaveMore_Review']) ) {
        if (!empty($_COOKIE['switchAccount'])) {
            $portal_user = $_COOKIE['ID'];
            $user_id = $_COOKIE['switchAccount'];
        }
        else {
            $portal_user = $_COOKIE['ID'];
            $user_id = employerID($portal_user);
        }

        $free_access = 0;
        $hasLibrary = mysqli_query( $conn,"SELECT * FROM tbl_library WHERE user_id = $user_id" );
        if ( mysqli_num_rows($hasLibrary) == 0 ) {
            $user_id = 163;
            $free_access = 1;
        }

    	$current_userID = $_COOKIE['ID'];
		$ID = $_POST['ID'];
		$library_id = $_POST['library_id'];
		$parent_id = $_POST['parent_id'];
		$title = addslashes($_POST['title']);
		$comment = addslashes($_POST['comment']);
		$type = $_POST['type'];
    	$last_modified = $_POST['date'];
        $arr_item = array();
        $process = true;

        $filetype = $_POST['filetype'];
        if ($filetype == 1) {
            $files = $_FILES['file']['name'];
            if (!empty($files)) {
                $path = 'uploads/library/';
                $filesize = $_FILES['file']['size'];
                $tmp = $_FILES['file']['tmp_name'];
                $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                $ext = strtolower(pathinfo($files, PATHINFO_EXTENSION));
                $files = rand(1000,1000000) . ' - ' . $files;
                $path = $path.$files;

                if(!in_array($ext, $invalid_extensions)) {
                    move_uploaded_file($tmp,$path);
                } else {
                    $process = false;
                }
            }
        } else {
            $files = $_POST['fileurl'];
            $filesize = 0;
        }

        if ($process == true) {
            $output = array (
                'type'  =>  $filetype,
                'name' =>  $files,
                'size' =>  $filesize,
                'date' =>  $local_date
            );
            array_push($arr_item, $output);
            $file_history = json_encode($arr_item, JSON_HEX_APOS | JSON_UNESCAPED_UNICODE);

            $sql = "INSERT INTO tbl_library_review (user_id, library_id, free_access, compliant, title, template, comment, type, parent_id, files, filetype, filesize, file_history, last_modified)
            VALUES ('$current_userID', '$library_id', '$free_access', '0', '$title', '2', '$comment', '$type', '$ID', '$files', '$filetype', '$filesize', '$file_history', '$last_modified')";
            
    		if (mysqli_query($conn, $sql)) {
    			$last_id = mysqli_insert_id($conn);

    			// Select Review Parent
    			$selectData = mysqli_query( $conn,'SELECT * FROM tbl_library_review WHERE ID="'. $ID .'" ORDER BY ID LIMIT 1' );
    			$rowData = mysqli_fetch_array($selectData);

    			$new_child_id = array();
    			if ( !empty($rowData['child_id']) ) {
    				array_push($new_child_id, $rowData['child_id']);
    			}
    			array_push($new_child_id, $last_id);

    			// Insert Child to Selected Review Parent
    			$new_child_id = implode(", ",$new_child_id);
    			mysqli_query( $conn,"UPDATE tbl_library_review set child_id='". $new_child_id ."' WHERE ID='". $ID ."'" );
    			
    			if ($type == 3) { mysqli_query( $conn,"UPDATE tbl_library_review set compliant=1 WHERE ID='". $ID ."'" ); }

    			// Select Review Child Data
    			$selectData = mysqli_query( $conn,'SELECT * FROM tbl_library_review WHERE ID="'. $last_id .'" ORDER BY ID LIMIT 1' );
    			if ( mysqli_num_rows($selectData) > 0 ) {
    				$rowReview = mysqli_fetch_array($selectData);
    				$review_ID = $rowReview["ID"];
    				$review_title = $rowReview["title"];
    				$review_comment = $rowReview["comment"];
    				$review_parent_id = $rowReview["parent_id"];

    				$review_user_id = $rowReview["user_id"];
    				$selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $review_user_id " );
    				$rowUser = mysqli_fetch_array($selectUser);
    				$review_name = $rowUser["first_name"] .' '. $rowUser["last_name"];

    				$review_type = $rowReview["type"];
    				$rtype = array(
    				    0 => 'Observed',
    				    1 => 'Corrected',
    				    2 => 'Verified',
    				    3 => 'Approved'
    				);

    				$review_last_modified = $rowReview["last_modified"];
    				$review_last_modified = new DateTime($review_last_modified);
    				$review_last_modified = $review_last_modified->format('M d, Y');

                    $filetype = $rowReview['filetype'];
                    $files = $rowReview["files"];
                    $type = 'iframe';
                    $file_extension = 'fa-youtube-play';
                    if (!empty($files)) {
                        if ($filetype == 1) {
                            $fileExtension = fileExtension($files);
                            $src = $fileExtension['src'];
                            $embed = $fileExtension['embed'];
                            $type = $fileExtension['type'];
                            $file_extension = $fileExtension['file_extension'];
                            $url = $base_url.'uploads/library/';

                            $files = $src.$url.rawurlencode($files).$embed;
                        } else if ($filetype == 3) {
                            $files = preg_replace('#[^/]*$#', '', $files).'preview';
                            $file_extension = 'fa-google';
                        }
                        $files = '<a href="'.$files.'" data-src="'.$files.'" data-fancybox data-type="'.$type.'">View</a>';
                    }

    				$output = array(
    					'ID' => $review_ID,
    					"library_id" => $library_id,
    					"parent_id" => $parent_id,
    					"review_parent_id" => $review_parent_id,
    					'title' => stripcslashes($review_title),
    					'comment' => stripcslashes($review_comment),
    					'name' => $review_name,
    					'type' => $rtype[$review_type],
    					'type_id' => $review_type,
    					'last_modified' => $review_last_modified,
    					'files' => $files
    				);
    				echo json_encode($output);

    				// Update History Data
    				actionHistory($library_id, 1, 4, $review_ID);
    			}
    		}
    		mysqli_close($conn);
        }
	}
	if( isset($_POST['btnUpdateMore_Review']) ) {
    	$current_userID = $_COOKIE['ID'];
		$ID = $_POST['ID'];
		$library_id = $_POST['library_id'];
		$parent_id = $_POST['parent_id'];
		$title = addslashes($_POST['title']);
		$comment = addslashes($_POST['comment']);
		$type = $_POST['type'];
    	$last_modified = $_POST['date'];
        $process = true;

    	mysqli_query( $conn,"UPDATE tbl_library_review SET user_id='". $current_userID ."', title='". $title ."', comment='". $comment ."', type='". $type ."', last_modified='". $last_modified ."' WHERE ID='". $ID ."'" );
		
		$selectData = mysqli_query( $conn,'SELECT * FROM tbl_library_review WHERE ID="'. $ID .'" ORDER BY ID LIMIT 1' );
		if ( mysqli_num_rows($selectData) > 0 ) {
			$rowReview = mysqli_fetch_array($selectData);
			$review_ID = $rowReview["ID"];
			$review_title = $rowReview["title"];
			$review_comment = $rowReview["comment"];
			$review_parent_id = $rowReview["parent_id"];
			$reviewparent_ID = $rowReview["parent_id"];

			if ($type == 3) { 
				mysqli_query( $conn,"UPDATE tbl_library_review set compliant=1 WHERE ID='". $review_parent_id ."'" );

				$selectDataParent = mysqli_query( $conn,'SELECT * FROM tbl_library_review WHERE ID="'. $review_parent_id .'" ORDER BY ID LIMIT 1' );
				$rowReviewParent = mysqli_fetch_array($selectDataParent);
				$reviewparent_ID = $rowReviewParent["parent_id"];

				mysqli_query( $conn,"UPDATE tbl_library_review set compliant=1 WHERE ID='". $reviewparent_ID ."'" ); 
			}

			$review_user_id = $rowReview["user_id"];
			$selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $review_user_id " );
			$rowUser = mysqli_fetch_array($selectUser);
			$review_name = $rowUser["first_name"] .' '. $rowUser["last_name"];

			$review_type = $rowReview["type"];
			$rtype = array(
			    0 => 'Observed',
			    1 => 'Corrected',
			    2 => 'Verified',
			    3 => 'Approved'
			);

			$review_last_modified = $rowReview["last_modified"];
			$review_last_modified = new DateTime($review_last_modified);
			$review_last_modified = $review_last_modified->format('M d, Y');

            $compliance_action = '';
			if (!empty($compliance_remark)) {
				if ($compliance_remark == "1") { $compliance_action .= '<span class="text-success">Accepted</span>'; }
				else { $compliance_action .= '<span class="text-danger">'.$compliance_remark.'</span>'; }
			} else {
				$compliance_action .= '<a href="javascript:;" type="button" class="btn btn-sm btn-link" onclick="btnReviewAccept('. $ID .')">Accept</a> |
        		<a href="javascript:;" type="button" class="btn btn-sm btn-link" onclick="btnReviewReject('. $ID .')">Reject</a>';
			}

            $files = '';
            $arr_item = array();
            if (!empty($rowReview["file_history"])) {
                $arr_item = json_decode($rowReview["file_history"],true);
            }

            $filetype = $_POST['filetype'];
            if ($filetype > 0) {
                if ($filetype == 1) {
                    $files = $_FILES['file']['name'];
                    if (!empty($files)) {
                        $path = 'uploads/library/';
                        $filesize = $_FILES['file']['size'];
                        $tmp = $_FILES['file']['tmp_name'];
                        $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                        $ext = strtolower(pathinfo($files, PATHINFO_EXTENSION));
                        $files = rand(1000,1000000) . ' - ' . $files;
                        $path = $path.$files;

                        if(!in_array($ext, $invalid_extensions)) {
                            move_uploaded_file($tmp,$path);

                            $filesize_tot = $filesize + $rowReview["filesize"];

                            mysqli_query( $conn,"UPDATE tbl_library_review SET filesize='". $filesize_tot ."' WHERE ID='". $ID ."'" );
                        } else {
                            $process = false;
                        }
                    }
                } else {
                    $files = $_POST['fileurl'];
                    $filesize = 0;
                }

                if (!empty($files) AND $process == true) {
                    $output = array (
                        'type'  =>  $filetype,
                        'name' =>  $files,
                        'size' =>  $filesize,
                        'date' =>  $local_date
                    );
                    array_push($arr_item, $output);
                    $file_history = json_encode($arr_item, JSON_HEX_APOS | JSON_UNESCAPED_UNICODE);

                    mysqli_query( $conn,"UPDATE tbl_library_review SET files='". $files ."', filetype='". $filetype ."', file_history='". $file_history ."' WHERE ID='". $ID ."'" );
                }
            }

            if ($process == true) {
                $type = 'iframe';
                $file_extension = 'fa-youtube-play';
                if (!empty($files)) {
                    if ($filetype == 1) {
                        $fileExtension = fileExtension($files);
                        $src = $fileExtension['src'];
                        $embed = $fileExtension['embed'];
                        $type = $fileExtension['type'];
                        $file_extension = $fileExtension['file_extension'];
                        $url = $base_url.'uploads/library/';

                        $files = $src.$url.rawurlencode($files).$embed;
                    } else if ($filetype == 3) {
                        $files = preg_replace('#[^/]*$#', '', $files).'preview';
                        $file_extension = 'fa-google';
                    }
                    $files = '<a href="'.$files.'" data-src="'.$files.'" data-fancybox data-type="'.$type.'">View</a>';
                }

    			$output = array(
    				'ID' => $review_ID,
    				"library_id" => $library_id,
    				"parent_id" => $reviewparent_ID,
    				"review_parent_id" => $parent_id,
    				'title' => stripcslashes($review_title),
    				'comment' => stripcslashes($review_comment),
    				"action" => $compliance_action,
    				'name' => $review_name,
    				'type' => $rtype[$review_type],
    				'type_id' => $review_type,
    				'last_modified' => $review_last_modified,
    				'files' => $files
    			);
    			echo json_encode($output);

    			// Update History Data
    			actionHistory($library_id, 2, 4, $review_ID);
                mysqli_close($conn);
    		}
        }
	}

	// Template Section
	if( isset($_GET['modalTemplate']) ) {
		$id = $_GET['modalTemplate'];

		echo '<input class="form-control" type="hidden" name="parent_id" value="'. $id .'" />
		<div class="form-group">
            <label class="col-md-3 control-label">Select File</label>
            <div class="col-md-8">
                <select class="form-control" name="filetype" onchange="changeType(this)" required>
                    <option value="0">Select option</option>
                    <option value="1">Manual Upload</option>
                    <option value="3">Google Drive URL</option>
                </select>
                <input class="form-control margin-top-15 fileUpload" type="file" name="file" style="display: none;" />
                <input class="form-control margin-top-15 fileURL" type="url" name="fileurl" style="display: none;" placeholder="https://" />
            </div>
        </div>
        <div class="form-group">
            <label class="col-md-3 control-label">File Description</label>
            <div class="col-md-8">
                <textarea class="form-control" name="description" required></textarea>
            </div>
        </div>';

        mysqli_close($conn);
	}
	if( isset($_GET['modalTemplate_Edit']) ) {
		$id = $_GET['modalTemplate_Edit'];

		$selectData = mysqli_query( $conn,"SELECT * FROM tbl_library_template WHERE ID = $id" );
		if ( mysqli_num_rows($selectData) > 0 ) {
            $row = mysqli_fetch_array($selectData);
            $description = $row["description"];

            $files = '';
            $type = 'iframe';
            if (!empty($row["files"])) {
                $arr_filename = explode(' | ', $row["files"]);
                $arr_filetype = explode(' | ', $row["filetype"]);
                $str_filename = '';

                foreach($arr_filename as $val_filename) {
                    $str_filename = $val_filename;
                }
                foreach($arr_filetype as $val_filetype) {
                    $str_filetype = $val_filetype;
                }

                $files = $str_filename;
                if ($str_filetype == 1) {
                    $fileExtension = fileExtension($str_filename);
                    $src = $fileExtension['src'];
                    $embed = $fileExtension['embed'];
                    $type = $fileExtension['type'];
                    $file_extension = $fileExtension['file_extension'];
                    $url = $base_url.'uploads/library/';

                    $files = $src.$url.rawurlencode($str_filename).$embed;
                } else if ($str_filetype == 3) {
                    $files = preg_replace('#[^/]*$#', '', $str_filename).'preview';
                }
            }
        }

		echo '<input class="form-control" type="hidden" name="ID" value="'. $id .'" />
		<div class="form-group">
            <label class="col-md-3 control-label">Select File</label>
            <div class="col-md-8">
                <select class="form-control '; echo !empty($files) ? 'hide':''; echo '" name="filetype" onchange="changeType(this)" required>
                    <option value="0">Select option</option>
                    <option value="1">Manual Upload</option>
                    <option value="3">Google Drive URL</option>
                </select>
                <input class="form-control margin-top-15 fileUpload" type="file" name="file" style="display: none;" />
                <input class="form-control margin-top-15 fileURL" type="url" name="fileurl" style="display: none;" placeholder="https://" />
                <p class="'; echo !empty($files) ? '':'hide'; echo '" style="margin: 0;"><a href="'.$files.'" data-src="'.$files.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a> | <button type="button" class="btn btn-link uploadNew" onclick="uploadNew(this)">Upload New</button></p>
            </div>
        </div>
        <div class="form-group">
            <label class="col-md-3 control-label">File Description</label>
            <div class="col-md-8">
                <textarea class="form-control" name="description" required>'.$description.'</textarea>
            </div>
        </div>';

        mysqli_close($conn);
	}
	if( isset($_GET['btnDelete_Template']) ) {
		$id = $_GET['btnDelete_Template'];
    	$current_userID = $_COOKIE['ID'];
		$reason = addslashes($_GET['reason']);

        $message = array();
		array_push($message, $current_userID);
		array_push($message, $reason);
		$message = implode(" | ",$message);

		mysqli_query( $conn,"UPDATE tbl_library_template SET is_deleted = 1, reason = '". $message ."' WHERE ID='". $id ."'" );

		$selectData = mysqli_query( $conn,'SELECT * FROM tbl_library_template WHERE ID="'. $id .'"' );
		$rowData = mysqli_fetch_array($selectData);
        $data_library_id = $rowData['library_id'];
			
		// Update History Data
		actionHistory($data_library_id, 3, 5, $id);
	}
	if( isset($_POST['btnSave_Template']) ) {
        if (!empty($_COOKIE['switchAccount'])) {
            $portal_user = $_COOKIE['ID'];
            $user_id = $_COOKIE['switchAccount'];
        }
        else {
            $portal_user = $_COOKIE['ID'];
            $user_id = employerID($portal_user);
        }

        $free_access = 0;
        $hasLibrary = mysqli_query( $conn,"SELECT * FROM tbl_library WHERE user_id = $user_id" );
        if ( mysqli_num_rows($hasLibrary) == 0 ) {
            $user_id = 163;
            $free_access = 1;
        }

    	$current_userID = $_COOKIE['ID'];
		$parent_id = $_POST['parent_id'];
		$description = addslashes($_POST['description']);
    	$last_modified = date('Y-m-d');
        $arr_item = array();
        $process = true;

        $filetype = $_POST['filetype'];
        if ($filetype == 1) {
            $files = $_FILES['file']['name'];
            if (!empty($files)) {
                $path = 'uploads/library/';
                $filesize = $_FILES['file']['size'];
                $tmp = $_FILES['file']['tmp_name'];
                $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                $ext = strtolower(pathinfo($files, PATHINFO_EXTENSION));
                $files = rand(1000,1000000) . ' - ' . $files;
                $path = $path.$files;

                if(!in_array($ext, $invalid_extensions)) {
                    move_uploaded_file($tmp,$path);
                } else {
                    $process = false;
                }
            }
        } else {
            $files = $_POST['fileurl'];
            $filesize = 0;
        }

        if ($process == true) {

            $output = array (
                'type'  =>  $filetype,
                'name' =>  $files,
                'size' =>  $filesize,
                'date' =>  $local_date
            );
            array_push($arr_item, $output);
            $file_history = json_encode($arr_item, JSON_HEX_APOS | JSON_UNESCAPED_UNICODE);

            $sql = "INSERT INTO tbl_library_template (user_id, library_id, free_access, files, filetype, filesize, file_history, description, last_modified)
            VALUES ('$current_userID', '$parent_id', '$free_access', '$files', '$filetype', '$filesize', '$file_history', '$description', '$last_modified')";
            
    		//->>>>>>>  START Brandon Auto service log for uploading template <<<<<<<<-
            
    		$current_userID = $_COOKIE['ID'];
    		$action = "uploaded";
    		$minutes = 1;
    		$companyname = "";
    		$comment = "Template Description : ".$description . " and uploaded a file with a name of : ". $files;
    		date_default_timezone_set('America/New_York');
    		$datenow = date('Y-m-d') ;

    		if (!empty($_COOKIE['switchAccount'])) {
    			$portal_user = $_COOKIE['ID'];
    			$user_id_account = $_COOKIE['switchAccount'];
    		}
    		else {
    			$portal_user = $_COOKIE['ID'];
    			$user_id_account = employerID($portal_user);
    		}

    		$resultaccountname = mysqli_query( $conn,'SELECT * FROM tblEnterpiseDetails WHERE users_entities = "'.$user_id_account.'" LIMIT 1 ');
    		if ( mysqli_num_rows($resultaccountname) > 0 ) {
    			$rowComment = mysqli_fetch_array($resultaccountname);
    			$companyname = $rowComment["company_code"];
    		}

    		$finaldescription = $files;
    		$sql_subitem_autolog = "INSERT INTO tbl_service_logs_draft (`user_id`, `description`,`action`, `comment`, `account`, `minute` , `task_date`) 
    		VALUES ('$current_userID', '$finaldescription','$action','$comment','$companyname','$minutes','$datenow')";

    		mysqli_query($conn, $sql_subitem_autolog);

    		//->>>>>>> END Brandon Auto service log for  uploading template <<<<<<<<-
    		
    		if (mysqli_query($conn, $sql)) {
    			$last_id = mysqli_insert_id($conn);
    			$selectData = mysqli_query( $conn,'SELECT * FROM tbl_library_template WHERE ID="'. $last_id .'" ORDER BY ID LIMIT 1' );
    			if ( mysqli_num_rows($selectData) > 0 ) {
    				$rowData = mysqli_fetch_array($selectData);
    				$data_ID = $rowData['ID'];
    				$data_library_id = $rowData['library_id'];
    				$data_description = $rowData['description'];

    				$data_user_id = $rowData['user_id'];
                    $selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $data_user_id " );
                    $rowUser = mysqli_fetch_array($selectUser);
                    $ref_name = $rowUser["first_name"] .' '. $rowUser["last_name"];

    				$data_last_modified = $rowData['last_modified'];
                    $data_last_modified = new DateTime($data_last_modified);
                    $data_last_modified = $data_last_modified->format('M d, Y');

                    $filetype = $rowData['filetype'];
                    $files = $rowData["files"];
                    $type = 'iframe';
                    $file_extension = 'fa-youtube-play';
                    if (!empty($files)) {
                        if ($filetype == 1) {
                            $fileExtension = fileExtension($files);
                            $src = $fileExtension['src'];
                            $embed = $fileExtension['embed'];
                            $type = $fileExtension['type'];
                            $file_extension = $fileExtension['file_extension'];
                            $url = $base_url.'uploads/library/';

                            $files = $src.$url.rawurlencode($files).$embed;
                        } else if ($filetype == 3) {
                            $files = preg_replace('#[^/]*$#', '', $files).'preview';
                            $file_extension = 'fa-google';
                        }
                    }

                    $data = '<div class="mt-action mt-action-'.$data_ID.'">
                        <div class="mt-action-body">
                            <div class="mt-action-row">
                                <div class="mt-action-info">
                                    <div class="mt-action-icon">
                                        <a href="'.$files.'" data-src="'.$files.'" data-fancybox data-type="'.$type.'"><i class="fa fa-fw '. $file_extension .'"></i></a>
                                    </div>
                                    <div class="mt-action-details" style="vertical-align: middle;">
                                        <p class="mt-action-desc">
                                            <span class="font-dark">'.stripcslashes(htmlentities($data_description)).'</span><br>
                                            Uploaded by: '.$ref_name.'
                                        </p>
                                    </div>
                                </div>
                                <div class="mt-action-datetime">
                                    <span class="mt-action-date">'.$data_last_modified.'</span>
                                </div>
                                <div class="mt-action-buttons">
                                    <div class="btn-group btn-group-circle">
                                        <a href="#modalTemplateEdit" type="button" class="btn btn-outline dark btn-sm" data-toggle="modal" onclick="btnTemplateEdit('.$data_ID.')">Edit</a>
                                        <a href="javascript:;" type="button" class="btn red btn-sm" onclick="btnTemplateDelete('.$data_ID.', '.$data_library_id.')">Delete</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>';

                    $output = array(
                        'ID' => $data_ID,
                        'data' => $data,
                        'parent_id' => $data_library_id
                    );
    				echo json_encode($output);

    				// Update History Data
    				actionHistory($data_library_id, 1, 5, $data_ID);
    			}
    		}
    		mysqli_close($conn);
        }
	}
	if( isset($_POST['btnUpdate_Template']) ) {
		$ID = $_POST['ID'];
    	$current_userID = $_COOKIE['ID'];
		$description = addslashes($_POST['description']);
    	$last_modified = date('Y-m-d');
        $process = true;
		
		mysqli_query( $conn,"UPDATE tbl_library_template SET user_id='". $current_userID ."', description='". $description ."', last_modified='". $last_modified ."'  WHERE ID='". $ID ."'" );

		$selectData = mysqli_query( $conn,'SELECT * FROM tbl_library_template WHERE ID="'. $ID .'" ORDER BY ID LIMIT 1' );
		if ( mysqli_num_rows($selectData) > 0 ) {
			$rowData = mysqli_fetch_array($selectData);
			$data_ID = $rowData['ID'];
			$data_library_id = $rowData['library_id'];
			$data_description = $rowData['description'];

			$data_user_id = $rowData['user_id'];
            $selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $data_user_id " );
            $rowUser = mysqli_fetch_array($selectUser);
            $ref_name = $rowUser["first_name"] .' '. $rowUser["last_name"];

			$data_last_modified = $rowData['last_modified'];
            $data_last_modified = new DateTime($data_last_modified);
            $data_last_modified = $data_last_modified->format('M d, Y');

            $files = '';
            $arr_item = array();
            if (!empty($rowData["file_history"])) {
                $arr_item = json_decode($rowData["file_history"],true);
            }

            $filetype = $_POST['filetype'];
            if ($filetype > 0) {
                if ($filetype == 1) {
                    $files = $_FILES['file']['name'];
                    if (!empty($files)) {
                        $path = 'uploads/library/';
                        $filesize = $_FILES['file']['size'];
                        $tmp = $_FILES['file']['tmp_name'];
                        $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                        $ext = strtolower(pathinfo($files, PATHINFO_EXTENSION));
                        $files = rand(1000,1000000) . ' - ' . $files;
                        $path = $path.$files;

                        if(!in_array($ext, $invalid_extensions)) {
                            move_uploaded_file($tmp,$path);

                            $filesize_tot = $filesize + $rowData["filesize"];

                            mysqli_query( $conn,"UPDATE tbl_library_template SET filesize='". $filesize_tot ."' WHERE ID='". $ID ."'" );
                        } else {
                            $process = false;
                        }
                    }
                } else {
                    $files = $_POST['fileurl'];
                    $filesize = 0;
                }

                if (!empty($files) AND $process == true) {
                    $output = array (
                        'type'  =>  $filetype,
                        'name' =>  $files,
                        'size' =>  $filesize,
                        'date' =>  $local_date
                    );
                    array_push($arr_item, $output);
                    $file_history = json_encode($arr_item, JSON_HEX_APOS | JSON_UNESCAPED_UNICODE);

                    mysqli_query( $conn,"UPDATE tbl_library_template SET files='". $files ."', filetype='". $filetype ."', file_history='". $file_history ."' WHERE ID='". $ID ."'" );
                }
            }

            if ($process == true) {
                $type = 'iframe';
                $file_extension = 'fa-youtube-play';
                if (!empty($files)) {
                    if ($filetype == 1) {
                        $fileExtension = fileExtension($files);
                        $src = $fileExtension['src'];
                        $embed = $fileExtension['embed'];
                        $type = $fileExtension['type'];
                        $file_extension = $fileExtension['file_extension'];
                        $url = $base_url.'uploads/library/';

                        $files = $src.$url.rawurlencode($files).$embed;
                    } else if ($filetype == 3) {
                        $files = preg_replace('#[^/]*$#', '', $files).'preview';
                        $file_extension = 'fa-google';
                    }
                }

                $data = '<div class="mt-action-body">
                    <div class="mt-action-row">
                        <div class="mt-action-info">
                            <div class="mt-action-icon">
                                <a href="'.$files.'" data-src="'.$files.'" data-fancybox data-type="'.$type.'"><i class="fa fa-fw '. $file_extension .'"></i></a>
                            </div>
                            <div class="mt-action-details" style="vertical-align: middle;">
                                <p class="mt-action-desc">
                                    <span class="font-dark">'.stripcslashes(htmlentities($data_description)).'</span><br>
                                    Uploaded by: '.$ref_name.'
                                </p>
                            </div>
                        </div>
                        <div class="mt-action-datetime">
                            <span class="mt-action-date">'.$data_last_modified.'</span>
                        </div>
                        <div class="mt-action-buttons">
                            <div class="btn-group btn-group-circle">
                                <a href="#modalTemplateEdit" type="button" class="btn btn-outline dark btn-sm" data-toggle="modal" onclick="btnTemplateEdit('.$data_ID.')">Edit</a>
                                <a href="javascript:;" type="button" class="btn red btn-sm" onclick="btnTemplateDelete('.$data_ID.', '.$data_library_id.')">Delete</a>
                            </div>
                        </div>
                    </div>
                </div>';

                $output = array(
                    'ID' => $data_ID,
                    'data' => $data,
                    'parent_id' => $data_library_id
                );
    			echo json_encode($output);
    			
    			// Update History Data
    			actionHistory($data_library_id, 2, 5, $data_ID);
                mysqli_close($conn);
    		}
        }
	}

	// References Section
	if( isset($_GET['modalRef']) ) {
		$id = $_GET['modalRef'];

		echo '<input class="form-control" type="hidden" name="parent_id" value="'. $id .'" />
		<div class="form-group">
            <label class="col-md-3 control-label">Select File</label>
            <div class="col-md-8">
                <select class="form-control" name="filetype" onchange="changeType(this)" required>
                    <option value="0">Select option</option>
                    <option value="1">Manual Upload</option>
                    <option value="2">Youtube URL</option>
                    <option value="3">Google Drive URL</option>
                </select>
                <input class="form-control margin-top-15 fileUpload" type="file" name="file" style="display: none;" />
                <input class="form-control margin-top-15 fileURL" type="url" name="fileurl" style="display: none;" placeholder="https://" />
            </div>
        </div>
        <div class="form-group">
            <label class="col-md-3 control-label">File Description</label>
            <div class="col-md-8">
                <textarea class="form-control" name="description" required></textarea>
            </div>
        </div>';

        mysqli_close($conn);
	}
	if( isset($_GET['modalRef_Edit']) ) {
		$id = $_GET['modalRef_Edit'];

		$selectData = mysqli_query( $conn,"SELECT * FROM tbl_library_references WHERE ID = $id" );
		if ( mysqli_num_rows($selectData) > 0 ) {
            $row = mysqli_fetch_array($selectData);
            $description = $row["description"];

            $files = '';
            $type = 'iframe';
            if (!empty($row["files"])) {
                $arr_filename = explode(' | ', $row["files"]);
                $arr_filetype = explode(' | ', $row["filetype"]);
                $str_filename = '';

                foreach($arr_filename as $val_filename) {
                    $str_filename = $val_filename;
                }
                foreach($arr_filetype as $val_filetype) {
                    $str_filetype = $val_filetype;
                }

                $files = $str_filename;
                if ($str_filetype == 1) {
                    $fileExtension = fileExtension($str_filename);
                    $src = $fileExtension['src'];
                    $embed = $fileExtension['embed'];
                    $type = $fileExtension['type'];
                    $file_extension = $fileExtension['file_extension'];
                    $url = $base_url.'uploads/library/';

                    $files = $src.$url.rawurlencode($str_filename).$embed;
                } else if ($str_filetype == 3) {
                    $files = preg_replace('#[^/]*$#', '', $str_filename).'preview';
                }
            }
        }

		echo '<input class="form-control" type="hidden" name="ID" value="'. $id .'" />
		<div class="form-group">
            <label class="col-md-3 control-label">Select File</label>
            <div class="col-md-8">
                <select class="form-control '; echo !empty($files) ? 'hide':''; echo '" name="filetype" onchange="changeType(this)" required>
                    <option value="0">Select option</option>
                    <option value="1">Manual Upload</option>
                    <option value="2">Youtube URL</option>
                    <option value="3">Google Drive URL</option>
                </select>
                <input class="form-control margin-top-15 fileUpload" type="file" name="file" style="display: none;" />
                <input class="form-control margin-top-15 fileURL" type="url" name="fileurl" style="display: none;" placeholder="https://" />
                <p class="'; echo !empty($files) ? '':'hide'; echo '" style="margin: 0;"><a href="'.$files.'" data-src="'.$files.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a> | <button type="button" class="btn btn-link uploadNew" onclick="uploadNew(this)">Upload New</button></p>
            </div>
        </div>
        <div class="form-group">
            <label class="col-md-3 control-label">File Description</label>
            <div class="col-md-8">
                <textarea class="form-control" name="description" required>'.$description.'</textarea>
            </div>
        </div>';

        mysqli_close($conn);
	}
	if( isset($_GET['btnDelete_Ref']) ) {
		$id = $_GET['btnDelete_Ref'];
    	$current_userID = $_COOKIE['ID'];
		$reason = addslashes($_GET['reason']);

        $message = array();
		array_push($message, $current_userID);
		array_push($message, $reason);
		$message = implode(" | ",$message);

		mysqli_query( $conn,"UPDATE tbl_library_references SET is_deleted = 1, reason = '". $message ."' WHERE ID='". $id ."'" );

		$selectData = mysqli_query( $conn,'SELECT * FROM tbl_library_references WHERE ID="'. $id .'"' );
		$rowData = mysqli_fetch_array($selectData);
        $data_library_id = $rowData['library_id'];
			
		// Update History Data
		actionHistory($data_library_id, 3, 6, $id);
	}
	if( isset($_POST['btnSave_Ref']) ) {
        if (!empty($_COOKIE['switchAccount'])) {
            $portal_user = $_COOKIE['ID'];
            $user_id = $_COOKIE['switchAccount'];
        }
        else {
            $portal_user = $_COOKIE['ID'];
            $user_id = employerID($portal_user);
        }

        $free_access = 0;
        $hasLibrary = mysqli_query( $conn,"SELECT * FROM tbl_library WHERE user_id = $user_id" );
        if ( mysqli_num_rows($hasLibrary) == 0 ) {
            $user_id = 163;
            $free_access = 1;
        }

    	$current_userID = $_COOKIE['ID'];
		$parent_id = $_POST['parent_id'];
		$description = addslashes($_POST['description']);
    	$last_modified = date('Y-m-d');
        $arr_item = array();
        $process = true;

        $filetype = $_POST['filetype'];
        if ($filetype == 1) {
            $files = $_FILES['file']['name'];
            if (!empty($files)) {
                $path = 'uploads/library/';
                $filesize = $_FILES['file']['size'];
                $tmp = $_FILES['file']['tmp_name'];
                $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                $ext = strtolower(pathinfo($files, PATHINFO_EXTENSION));
                $files = rand(1000,1000000) . ' - ' . $files;
                $path = $path.$files;

                if(!in_array($ext, $invalid_extensions)) {
                    move_uploaded_file($tmp,$path);
                } else {
                    $process = false;
                }
            }
        } else {
            $files = $_POST['fileurl'];
            $filesize = 0;
        }

        if ($process == true) {
            $output = array (
                'type'  =>  $filetype,
                'name' =>  $files,
                'size' =>  $filesize,
                'date' =>  $local_date
            );
            array_push($arr_item, $output);
            $file_history = json_encode($arr_item, JSON_HEX_APOS | JSON_UNESCAPED_UNICODE);

            $sql = "INSERT INTO tbl_library_references (user_id, library_id, free_access, files, filetype, filesize, file_history, description, last_modified)
            VALUES ('$current_userID', '$parent_id', '$free_access', '$files', '$filetype', '$filesize', '$file_history', '$description', '$last_modified')";
    		
    		//->>>>>>>  START Brandon Auto service log for uploading ref document <<<<<<<<-
            
    		$current_userID = $_COOKIE['ID'];
    		$action = "uploaded";
    		$minutes = 1;
    		$companyname = "";
    		$comment = "File Description : ".$description . " and uploaded a file with a name : ". $files;
    		date_default_timezone_set('America/New_York');
    		$datenow = date('Y-m-d') ;

    		if (!empty($_COOKIE['switchAccount'])) {
    			$portal_user = $_COOKIE['ID'];
    			$user_id_account = $_COOKIE['switchAccount'];
    		}
    		else {
    			$portal_user = $_COOKIE['ID'];
    			$user_id_account = employerID($portal_user);
    		}

    		$resultaccountname = mysqli_query( $conn,'SELECT * FROM tblEnterpiseDetails WHERE users_entities = "'.$user_id_account.'" LIMIT 1 ');
    		if ( mysqli_num_rows($resultaccountname) > 0 ) {
    			$rowComment = mysqli_fetch_array($resultaccountname);
    			$companyname = $rowComment["company_code"];
    		}


    		$finaldescription = $companyname."-".$files;
    		$sql_subitem_autolog = "INSERT INTO tbl_service_logs_draft (`user_id`, `description`,`action`, `comment`, `account`, `minute` , `task_date`) 
    		VALUES ('$current_userID', '$finaldescription','$action','$comment','$companyname','$minutes','$datenow')";

    		mysqli_query($conn, $sql_subitem_autolog);


    		//->>>>>>> END Brandon Auto service log for  uploading ref document <<<<<<<<-

    		
    		if (mysqli_query($conn, $sql)) {
    			$last_id = mysqli_insert_id($conn);
    			$selectData = mysqli_query( $conn,'SELECT * FROM tbl_library_references WHERE ID="'. $last_id .'" ORDER BY ID LIMIT 1' );
    			if ( mysqli_num_rows($selectData) > 0 ) {
    				$rowData = mysqli_fetch_array($selectData);
    				$data_ID = $rowData['ID'];
    				$data_library_id = $rowData['library_id'];
    				$data_description = $rowData['description'];

    				$data_user_id = $rowData['user_id'];
                    $selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $data_user_id " );
                    $rowUser = mysqli_fetch_array($selectUser);
                    $ref_name = $rowUser["first_name"] .' '. $rowUser["last_name"];
                    
                    $data_last_modified = $rowData['last_modified'];
                    $data_last_modified = new DateTime($data_last_modified);
                    $data_last_modified = $data_last_modified->format('M d, Y');

                    $filetype = $rowData['filetype'];
                    $files = $rowData["files"];
                    $type = 'iframe';
                    $file_extension = 'fa-youtube-play';
                    if (!empty($files)) {
                        if ($filetype == 1) {
                            $fileExtension = fileExtension($files);
                            $src = $fileExtension['src'];
                            $embed = $fileExtension['embed'];
                            $type = $fileExtension['type'];
                            $file_extension = $fileExtension['file_extension'];
                            $url = $base_url.'uploads/library/';

                            $files = $src.$url.rawurlencode($files).$embed;
                        } else if ($filetype == 3) {
                            $files = preg_replace('#[^/]*$#', '', $files).'preview';
                            $file_extension = 'fa-google';
                        }
                    }

                    $data = '<div class="mt-action mt-action-'.$data_ID.'">
                        <div class="mt-action-body">
                            <div class="mt-action-row">
                                <div class="mt-action-info">
                                    <div class="mt-action-icon">
                                        <a href="'.$files.'" data-src="'.$files.'" data-fancybox data-type="'.$type.'"><i class="fa fa-fw '. $file_extension .'"></i></a>
                                    </div>
                                    <div class="mt-action-details" style="vertical-align: middle;">
                                        <p class="mt-action-desc">
                                            <span class="font-dark">'.stripcslashes(htmlentities($data_description)).'</span><br>
                                            Uploaded by: '.$ref_name.'
                                        </p>
                                    </div>
                                </div>
                                <div class="mt-action-datetime">
                                    <span class="mt-action-date">'.$data_last_modified.'</span>
                                </div>
                                <div class="mt-action-buttons">
                                    <div class="btn-group btn-group-circle">
                                        <a href="#modalRefEdit" type="button" class="btn btn-outline dark btn-sm" data-toggle="modal" onclick="btnRefEdit('.$data_ID.')">Edit</a>
                                        <a href="javascript:;" type="button" class="btn red btn-sm" onclick="btnRefDelete('.$data_ID.', '.$data_library_id.')">Delete</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>';

    				$output = array(
                        'ID' => $data_ID,
                        'data' => $data,
                        'parent_id' => $data_library_id
                    );
    				echo json_encode($output);

    				// Update History Data
    				actionHistory($parent_id, 1, 6, $data_ID);
    			}
    		}
    		mysqli_close($conn);
        }
	}
	if( isset($_POST['btnUpdate_Ref']) ) {
		$ID = $_POST['ID'];
    	$current_userID = $_COOKIE['ID'];
		$description = addslashes($_POST['description']);
    	$last_modified = date('Y-m-d');
        $process = true;
		
		mysqli_query( $conn,"UPDATE tbl_library_references SET user_id='". $current_userID ."', description='". $description ."', last_modified='". $last_modified ."'  WHERE ID='". $ID ."'" );

		$selectData = mysqli_query( $conn,'SELECT * FROM tbl_library_references WHERE ID="'. $ID .'" ORDER BY ID LIMIT 1' );
		if ( mysqli_num_rows($selectData) > 0 ) {
			$rowData = mysqli_fetch_array($selectData);
			$data_ID = $rowData['ID'];
			$data_library_id = $rowData['library_id'];
			$data_description = $rowData['description'];

			$data_user_id = $rowData['user_id'];
            $selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $data_user_id " );
            $rowUser = mysqli_fetch_array($selectUser);
            $ref_name = $rowUser["first_name"] .' '. $rowUser["last_name"];

            $data_last_modified = $rowData['last_modified'];
            $data_last_modified = new DateTime($data_last_modified);
            $data_last_modified = $data_last_modified->format('M d, Y');

            $files = '';
            $arr_item = array();
            if (!empty($rowData["file_history"])) {
                $arr_item = json_decode($rowData["file_history"],true);
            }
            
            $filetype = $_POST['filetype'];
            if ($filetype > 0) {
                if ($filetype == 1) {
                    $files = $_FILES['file']['name'];
                    if (!empty($files)) {
                        $path = 'uploads/library/';
                        $filesize = $_FILES['file']['size'];
                        $tmp = $_FILES['file']['tmp_name'];
                        $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                        $ext = strtolower(pathinfo($files, PATHINFO_EXTENSION));
                        $files = rand(1000,1000000) . ' - ' . $files;
                        $path = $path.$files;

                        if(!in_array($ext, $invalid_extensions)) {
                            move_uploaded_file($tmp,$path);

                            $filesize_tot = $filesize + $rowData["filesize"];

                            mysqli_query( $conn,"UPDATE tbl_library_references SET filesize='". $filesize_tot ."' WHERE ID='". $ID ."'" );
                        } else {
                            $process = false;
                        }
                    }
                } else if ($filetype == 1) {
                    $files = $_POST['fileurl'];
                    $filesize = 0;
                }

                if (!empty($files) AND $process == true) {
                    $output = array (
                        'type'  =>  $filetype,
                        'name' =>  $files,
                        'size' =>  $filesize,
                        'date' =>  $local_date
                    );
                    array_push($arr_item, $output);
                    $file_history = json_encode($arr_item, JSON_HEX_APOS | JSON_UNESCAPED_UNICODE);

                    mysqli_query( $conn,"UPDATE tbl_library_references SET files='". $files ."', filetype='". $filetype ."', file_history='". $file_history ."' WHERE ID='". $ID ."'" );
                }
            }

            if ($process == true) {
                $type = 'iframe';
                $file_extension = 'fa-youtube-play';
                if (!empty($files)) {
                    if ($filetype == 1) {
                        $fileExtension = fileExtension($files);
                        $src = $fileExtension['src'];
                        $embed = $fileExtension['embed'];
                        $type = $fileExtension['type'];
                        $file_extension = $fileExtension['file_extension'];
                        $url = $base_url.'uploads/library/';

                        $files = $src.$url.rawurlencode($files).$embed;
                    } else if ($filetype == 3) {
                        $files = preg_replace('#[^/]*$#', '', $files).'preview';
                        $file_extension = 'fa-google';
                    }
                }

                $data = '<div class="mt-action-body">
                    <div class="mt-action-row">
                        <div class="mt-action-info">
                            <div class="mt-action-icon">
                                <a href="'.$files.'" data-src="'.$files.'" data-fancybox data-type="'.$type.'"><i class="fa fa-fw '. $file_extension .'"></i></a>
                            </div>
                            <div class="mt-action-details" style="vertical-align: middle;">
                                <p class="mt-action-desc">
                                    <span class="font-dark">'.stripcslashes(htmlentities($data_description)).'</span><br>
                                    Uploaded by: '.$ref_name.'
                                </p>
                            </div>
                        </div>
                        <div class="mt-action-datetime">
                            <span class="mt-action-date">'.$data_last_modified.'</span>
                        </div>
                        <div class="mt-action-buttons">
                            <div class="btn-group btn-group-circle">
                                <a href="#modalRefEdit" type="button" class="btn btn-outline dark btn-sm" data-toggle="modal" onclick="btnRefEdit('.$data_ID.')">Edit</a>
                                <a href="javascript:;" type="button" class="btn red btn-sm" onclick="btnRefDelete('.$data_ID.', '.$data_library_id.')">Delete</a>
                            </div>
                        </div>
                    </div>
                </div>';

    			$output = array(
    				'ID' => $data_ID,
                    'data' => $data,
                    'parent_id' => $data_library_id
    			);
    			echo json_encode($output);
    			
    			// Update History Data
    			actionHistory($data_library_id, 2, 6, $data_ID);
                mysqli_close($conn);
    		}
        }
	}

	// Video Section
	if( isset($_GET['modalVideo']) ) {
		$id = $_GET['modalVideo'];

		echo '<input class="form-control" type="hidden" name="parent_id" value="'. $id .'" />
        <div class="form-group">
            <label class="col-md-3 control-label">Title</label>
            <div class="col-md-8">
                <input class="form-control" type="text" name="description" required />
            </div>
        </div>
		<div class="form-group">
            <label class="col-md-3 control-label">Select Type</label>
            <div class="col-md-8">
                <select class="form-control" name="type" onchange="selectType(this.value, 1)">
                	<option value="0">Upload Video</option>
                	<option value="1">Youtube URL</option>
                </select>
            </div>
        </div>
		<div class="form-group selVideo" id="selFile_1">
            <label class="col-md-3 control-label">Select File</label>
            <div class="col-md-8">
                <input class="form-control" type="file" name="file" required />
            </div>
        </div>
		<div class="form-group selVideo hide" id="selURL_1">
            <label class="col-md-3 control-label">Enter URL</label>
            <div class="col-md-8">
                <input class="form-control" type="text" name="url" required />
            </div>
        </div>';

        mysqli_close($conn);
	}
	if( isset($_GET['modalVideo_Edit']) ) {
		$id = $_GET['modalVideo_Edit'];

		$selectData = mysqli_query( $conn,"SELECT * FROM tbl_library_video WHERE ID = $id" );
		if ( mysqli_num_rows($selectData) > 0 ) {
            $row = mysqli_fetch_array($selectData);
            $description = $row["description"];

            $type_id = $row["type"];
            $youtube = $row["url"];
            $files = $row["files"];
            $fileExtension = fileExtension($files);
			$src = $fileExtension['src'];
			$embed = $fileExtension['embed'];
			$type = $fileExtension['type'];
			$file_extension = $fileExtension['file_extension'];
            $url = $base_url.'uploads/library/';
        }

		echo '<input class="form-control" type="hidden" name="ID" value="'. $id .'" />
        <div class="form-group">
            <label class="col-md-3 control-label">Title</label>
            <div class="col-md-8">
                <input class="form-control" type="text" name="description" value="'.$description.'" required />
            </div>
        </div>
		<div class="form-group">
            <label class="col-md-3 control-label">Select Type</label>
            <div class="col-md-8">
                <select class="form-control" name="type" onchange="selectType(this.value, 2)">
                	<option value="0" '; echo $type_id == 0 ? 'SELECTED':''; echo '>Upload Video</option>
                	<option value="1" '; echo $type_id == 1 ? 'SELECTED':''; echo '>Youtube URL</option>
                </select>
            </div>
        </div>
		<div class="form-group selVideo '; echo $type_id == 0 ? '':'hide'; echo '" id="selFile_1">
            <label class="col-md-3 control-label">Select File</label>
            <div class="col-md-8">
                <input class="form-control '; echo !empty($files) ? 'hide':''; echo '" type="file" name="file" />
                <p class="'; echo !empty($files) ? '':'hide'; echo '" style="margin: 0;"><a data-src="'.$src.$url.rawurlencode($files).$embed.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a> | <button type="button" class="btn btn-link uploadNew" onclick="uploadNewOld(this)">Upload New</button></p>
            </div>
        </div>
		<div class="form-group selVideo '; echo $type_id == 1 ? '':'hide'; echo '" id="selURL_2">
            <label class="col-md-3 control-label">Enter URL</label>
            <div class="col-md-8">
                <input class="form-control" type="text" name="url" value="'.$youtube.'" required />
            </div>
        </div>';

        mysqli_close($conn);
	}
	if( isset($_GET['btnDelete_Video']) ) {
		$id = $_GET['btnDelete_Video'];
    	$current_userID = $_COOKIE['ID'];
		$reason = addslashes($_GET['reason']);

        $message = array();
		array_push($message, $current_userID);
		array_push($message, $reason);
		$message = implode(" | ",$message);

		mysqli_query( $conn,"UPDATE tbl_library_video SET is_deleted = 1, reason = '". $message ."' WHERE ID='". $id ."'" );

		$selectData = mysqli_query( $conn,'SELECT * FROM tbl_library_video WHERE ID="'. $id .'"' );
		$rowData = mysqli_fetch_array($selectData);
        $data_library_id = $rowData['library_id'];
			
		// Update History Data
		actionHistory($data_library_id, 3, 7, $id);
	}
	if( isset($_POST['btnSave_Video']) ) {
        if (!empty($_COOKIE['switchAccount'])) {
            $portal_user = $_COOKIE['ID'];
            $user_id = $_COOKIE['switchAccount'];
        }
        else {
            $portal_user = $_COOKIE['ID'];
            $user_id = employerID($portal_user);
        }

        $free_access = 0;
        $hasLibrary = mysqli_query( $conn,"SELECT * FROM tbl_library WHERE user_id = $user_id" );
        if ( mysqli_num_rows($hasLibrary) == 0 ) {
            $user_id = 163;
            $free_access = 1;
        }

    	$current_userID = $_COOKIE['ID'];
		$parent_id = $_POST['parent_id'];
		$description = addslashes($_POST['description']);
		$youtube = $_POST['url'];
		$type = addslashes($_POST['type']);
    	$last_modified = date('Y-m-d');
        $arr_item = array();
        $filesize = 0;
        $process = true;

        $files = $_FILES['file']['name'];
        if ($type == 0) {
            if (!empty($files)) {
                $path = 'uploads/library/';
                $filesize = $_FILES['file']['size'];
                $tmp = $_FILES['file']['tmp_name'];
                $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                $ext = strtolower(pathinfo($files, PATHINFO_EXTENSION));
                $files = rand(1000,1000000) . ' - ' . $files;
                $path = $path.$files;

                if(!in_array($ext, $invalid_extensions)) {
                    move_uploaded_file($tmp,$path);
                } else {
                    $process = false;
                }
            }
        }

        if ($process == true) {
            $output = array (
                'type'  =>  $type,
                'name' =>  $files,
                'url' =>  $youtube,
                'size' =>  $filesize,
                'date' =>  $local_date
            );
            array_push($arr_item, $output);
            $file_history = json_encode($arr_item, JSON_HEX_APOS | JSON_UNESCAPED_UNICODE);

            $sql = "INSERT INTO tbl_library_video (user_id, library_id, free_access, files, type, filesize, file_history, url, description, last_modified)
            VALUES ('$current_userID', '$parent_id', '$free_access', '$files', '$type', '$filesize', '$file_history', '$youtube', '$description', '$last_modified')";
            
    		//->>>>>>>  START Brandon Auto service log for uploading video <<<<<<<<-
            
    		$current_userID = $_COOKIE['ID'];
    		$action = "uploaded";
    		$minutes = 1;
    		$companyname = "";
    		$comment = "Video description : ".$description . " with the yutube url  of : ". $youtube . " and file name of: ".$files;
    		date_default_timezone_set('America/New_York');
    		$datenow = date('Y-m-d') ;

    		if (!empty($_COOKIE['switchAccount'])) {
    			$portal_user = $_COOKIE['ID'];
    			$user_id_account = $_COOKIE['switchAccount'];
    		}
    		else {
    			$portal_user = $_COOKIE['ID'];
    			$user_id_account = employerID($portal_user);
    		}

    		$resultaccountname = mysqli_query( $conn,'SELECT * FROM tblEnterpiseDetails WHERE users_entities = "'.$user_id_account.'" LIMIT 1 ');
    		if ( mysqli_num_rows($resultaccountname) > 0 ) {
    			$rowComment = mysqli_fetch_array($resultaccountname);
    			$companyname = $rowComment["company_code"];
    		}


    		$finaldescription = $companyname."-".$type;
    		$sql_subitem_autolog = "INSERT INTO tbl_service_logs_draft (`user_id`, `description`,`action`, `comment`, `account`, `minute` , `task_date`) 
    		VALUES ('$current_userID', '$finaldescription','$action','$comment','$companyname','$minutes','$datenow')";

    		mysqli_query($conn, $sql_subitem_autolog);


    		//->>>>>>> END Brandon Auto service log for  uploading video<<<<<<<<-

    		
    		if (mysqli_query($conn, $sql)) {
    			$last_id = mysqli_insert_id($conn);
    			$selectData = mysqli_query( $conn,'SELECT * FROM tbl_library_video WHERE ID="'. $last_id .'" ORDER BY ID LIMIT 1' );
    			if ( mysqli_num_rows($selectData) > 0 ) {
    				$rowData = mysqli_fetch_array($selectData);
    				$data_ID = $rowData['ID'];
    				$data_library_id = $rowData['library_id'];
    				$data_description = $rowData['description'];
                    $data_type = $rowData['type'];
                    $data_url = $rowData['url'];

    				$data_user_id = $rowData['user_id'];
                    $selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $data_user_id " );
                    $rowUser = mysqli_fetch_array($selectUser);
                    $video_name = $rowUser["first_name"] .' '. $rowUser["last_name"];

    				$data_files = $rowData['files'];
                    $fileExtension = fileExtension($data_files);
        			$src = $fileExtension['src'];
        			$embed = $fileExtension['embed'];
        			$type = $fileExtension['type'];
        			$file_extension = $fileExtension['file_extension'];
    	            $url = $base_url.'uploads/library/';
    	            $files = '<a data-src="'.$src.$url.rawurlencode($data_files).$embed.'" data-fancybox data-type="'.$type.'"><i class="fa '. $file_extension .'"></i></a>';

    				$data_last_modified = $rowData['last_modified'];
                    $data_last_modified = new DateTime($data_last_modified);
                    $data_last_modified = $data_last_modified->format('M d, Y');

    				$output = array(
    					'ID' => $data_ID,
    					'parent_id' => $data_library_id,
    					'files' => $files,
    					'name' => $video_name,
    					'type' => $data_type,
    					'url' => $data_url,
    					'description' => stripcslashes($data_description),
    					'last_modified' => $data_last_modified
    				);
    				echo json_encode($output);

    				// Update History Data
    				actionHistory($parent_id, 1, 7, $data_ID);
    			}
    		}
    		mysqli_close($conn);
        }
	}
	if( isset($_POST['btnUpdate_Video']) ) {
		$ID = $_POST['ID'];
    	$current_userID = $_COOKIE['ID'];
		$description = addslashes($_POST['description']);
		$type = $_POST['type'];
		$youtube = addslashes($_POST['url']);
    	$last_modified = date('Y-m-d');
        $process = true;
		
		mysqli_query( $conn,"UPDATE tbl_library_video SET user_id='". $current_userID ."', type='". $type ."', url='". $youtube ."', description='". $description ."', last_modified='". $last_modified ."'  WHERE ID='". $ID ."'" );

		$selectData = mysqli_query( $conn,'SELECT * FROM tbl_library_video WHERE ID="'. $ID .'" ORDER BY ID LIMIT 1' );
		if ( mysqli_num_rows($selectData) > 0 ) {
			$rowData = mysqli_fetch_array($selectData);
			$data_ID = $rowData['ID'];
			$data_library_id = $rowData['library_id'];
			$data_description = $rowData['description'];
			$data_type = $rowData['type'];
			$data_url = $rowData['url'];
            $data_files = $rowData['files'];

			$data_user_id = $rowData['user_id'];
            $selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $data_user_id " );
            $rowUser = mysqli_fetch_array($selectUser);
            $video_name = $rowUser["first_name"] .' '. $rowUser["last_name"];

            $files = $_FILES['file']['name'];
            $arr_item = array();
            if (!empty($rowData["file_history"])) {
                $arr_item = json_decode($rowData["file_history"],true);
            }
            
            if (!empty($files)) {
                $path = 'uploads/library/';
                $filesize = $_FILES['file']['size'];
                $tmp = $_FILES['file']['tmp_name'];
                $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
                $ext = strtolower(pathinfo($files, PATHINFO_EXTENSION));
                $files = rand(1000,1000000) . ' - ' . $files;
                $path = $path.$files;

                if(!in_array($ext, $invalid_extensions)) {
                    move_uploaded_file($tmp,$path);

                    $output = array (
                        'type'  =>  $type,
                        'name' =>  $files,
                        'url' =>  $youtube,
                        'size' =>  $filesize,
                        'date' =>  $local_date
                    );
                    array_push($arr_item, $output);
                    $file_history = json_encode($arr_item, JSON_HEX_APOS | JSON_UNESCAPED_UNICODE);

                    $filesize += $rowData["filesize"];
                    $data_files = $files;

                    mysqli_query( $conn,"UPDATE tbl_library_video SET files='". $files ."', filesize='". $filesize ."', file_history='". $file_history ."' WHERE ID='". $ID ."'" );
                } else {
                    $process = false;
                }
            }

            if ($process == true) {
    			$data_files = $data_files;
                $fileExtension = fileExtension($data_files);
    			$src = $fileExtension['src'];
    			$embed = $fileExtension['embed'];
    			$type = $fileExtension['type'];
    			$file_extension = $fileExtension['file_extension'];
                $url = $base_url.'uploads/library/';
                $files = '<a data-src="'.$src.$url.rawurlencode($data_files).$embed.'" data-fancybox data-type="'.$type.'"><i class="fa '. $file_extension .'"></i></a>';

    			$data_last_modified = $rowData['last_modified'];
                $data_last_modified = new DateTime($data_last_modified);
                $data_last_modified = $data_last_modified->format('M d, Y');

    			$output = array(
    				'ID' => $data_ID,
    				'parent_id' => $data_library_id,
    				'files' => $files,
    				'name' => $video_name,
    				'type' => $data_type,
    				'url' => $data_url,
    				'description' => stripcslashes($data_description),
    				'last_modified' => $data_last_modified
    			);
    			echo json_encode($output);
    			
    			// Update History Data
    			actionHistory($data_library_id, 2, 7, $data_ID);
                mysqli_close($conn);
    		}
        }
	}

	// Task Section
	if( isset($_GET['modalTask']) ) {
		$id = $_GET['modalTask'];

        if (!empty($_COOKIE['switchAccount'])) {
			$portal_user = $_COOKIE['ID'];
			$user_id = $_COOKIE['switchAccount'];
		}
		else {
			$portal_user = $_COOKIE['ID'];
			$user_id = employerID($portal_user);
		}

        $free_access = 0;
        $hasLibrary = mysqli_query( $conn,"SELECT * FROM tbl_library WHERE user_id = $user_id" );
        if ( mysqli_num_rows($hasLibrary) == 0 ) {
            $user_id = 163;
            $free_access = 1;
        }

		$selectDashboard = mysqli_query( $conn,"SELECT * FROM tbl_library WHERE ID = $id" );
		if ( mysqli_num_rows($selectDashboard) > 0 ) {
			$rowDashboard = mysqli_fetch_array($selectDashboard);
            $dashboard_name = $rowDashboard["name"];
            $array_name_id = explode(", ", $dashboard_name);
            if ( count($array_name_id) == 4 ) {
                $data_name = array();

                $selectType = mysqli_query($conn,"SELECT * FROM tbl_library_type WHERE ID = '".$array_name_id[0]."'");
                if ( mysqli_num_rows($selectType) > 0 ) {
                    while($rowType = mysqli_fetch_array($selectType)) {
                        array_push($data_name, $rowType["name"]);
                    }
                }

                $selectCategory = mysqli_query($conn,"SELECT * FROM tbl_library_category WHERE ID = '".$array_name_id[1]."'");
                if ( mysqli_num_rows($selectCategory) > 0 ) {
                    while($rowCategory = mysqli_fetch_array($selectCategory)) {
                        array_push($data_name, $rowCategory["name"]);
                    }
                }

                $selectScope = mysqli_query($conn,"SELECT * FROM tbl_library_scope WHERE ID = '".$array_name_id[2]."'");
                if ( mysqli_num_rows($selectScope) > 0 ) {
                    while($rowScope = mysqli_fetch_array($selectScope)) {
                        array_push($data_name, $rowScope["name"]);
                    }
                }

                $selectModule = mysqli_query($conn,"SELECT * FROM tbl_library_module WHERE ID = '".$array_name_id[3]."'");
                if ( mysqli_num_rows($selectModule) > 0 ) {
                    while($rowModule = mysqli_fetch_array($selectModule)) {
                        array_push($data_name, $rowModule["name"]);
                    }
                }

                $dashboard_name = implode(" - ",$data_name);
            }
		}

		echo '<input class="form-control" type="hidden" name="parent_id" value="'. $id .'" />
        <div class="form-group">
            <label class="col-md-3 control-label">Project Name</label>
            <div class="col-md-8">
                <input class="form-control" type="text" name="name" value="'.$dashboard_name.'" required />
            </div>
        </div>
		<div class="form-group">
            <label class="col-md-3 control-label">Image/File</label>
            <div class="col-md-8">
                <input class="form-control" type="file" name="file" />
                <small><i class="text-primary">( Sample/Supporting files )</i></small>
            </div>
        </div>
        <div class="form-group">
            <label class="col-md-3 control-label">Task Description</label>
            <div class="col-md-8">
                <textarea class="form-control" name="description" required></textarea>
            </div>
        </div>
        <div class="form-group">
            <label class="col-md-3 control-label">Start Date</label>
            <div class="col-md-8">
                <input class="form-control" type="date" name="start_date" value="'.date('Y-m-d').'" required />
            </div>
        </div>
        <div class="form-group">
            <label class="col-md-3 control-label">Desired Deliver Date</label>
            <div class="col-md-8">
                <input class="form-control" type="date" name="desired_date" value="'.date('Y-m-d').'" required />
            </div>
        </div>
        <div class="form-group">
            <label class="col-md-3 control-label">Assigned To</label>
            <div class="col-md-8">
            	<select class="form-control mt-multiselect btn btn-default" name="assigned_to_id[]" required >';

	                $selectEmployee = mysqli_query( $conn,"SELECT * FROM tbl_hr_employee WHERE status = 1 AND user_id=$user_id" );
	                if ( mysqli_num_rows($selectEmployee) > 0 ) {
	                    while($rowEmployee = mysqli_fetch_array($selectEmployee)) {
	                        $rowEmployeeID = $rowEmployee["ID"];
	                        $rowEmployeeFName = $rowEmployee["first_name"];
	                        $rowEmployeeLName = $rowEmployee["last_name"];

	                        echo '<option value="'. $rowEmployeeID .'">'. $rowEmployeeFName .' '. $rowEmployeeLName .'</option>';
	                    }

	                    if (!empty($_COOKIE['switchAccount'])) {
	                    	$selectEmployeeSwitch = mysqli_query( $conn,"SELECT * FROM tbl_hr_employee WHERE status = 1 AND ID = 90 OR ID = 91 OR ID = 75 OR ID = 79 OR ID = 71 OR ID = 81 OR ID = 68 OR ID = 69" );
			                if ( mysqli_num_rows($selectEmployeeSwitch) > 0 ) {
			                    while($rowEmployeeSwitch = mysqli_fetch_array($selectEmployeeSwitch)) {
			                        $rowEmployeeIDSwitch = $rowEmployeeSwitch["ID"];
			                        $rowEmployeeFNameSwitch = $rowEmployeeSwitch["first_name"];
			                        $rowEmployeeLNameSwitch = $rowEmployeeSwitch["last_name"];

	                        		echo '<option value="'. $rowEmployeeIDSwitch .'">'. $rowEmployeeFNameSwitch .' '. $rowEmployeeLNameSwitch .'</option>';
			                    }
			                }
	                    }
	                } else {
	                    echo '<option disabled>No Available</option>';
	                }

	            echo '</select>
            </div>
        </div>';

        mysqli_close($conn);
	}
	if( isset($_GET['modalTask_Edit']) ) {
		$id = $_GET['modalTask_Edit'];

        if (!empty($_COOKIE['switchAccount'])) {
			$portal_user = $_COOKIE['ID'];
			$user_id = $_COOKIE['switchAccount'];
		}
		else {
			$portal_user = $_COOKIE['ID'];
			$user_id = employerID($portal_user);
		}

        $hasLibrary = mysqli_query( $conn,"SELECT * FROM tbl_library WHERE user_id = $user_id" );
        if ( mysqli_num_rows($hasLibrary) == 0 ) {
            $user_id = 163;
        }

		// $selectData = mysqli_query( $conn,"SELECT * FROM tbl_MyProject_Services WHERE MyPro_id = $id" );
        $selectData = mysqli_query( $conn,"SELECT
            h.History_id AS h_ID,
            h.library_id AS h_library_ID,
            h.filename AS h_name,
            h.Assign_to_History AS h_assign_to_id,
            h.files AS h_files,
            h.Action_date AS h_date_due,
            m.Start_Date AS m_date_start,
            m.Project_Name AS m_name
            FROM tbl_MyProject_Services AS m

            LEFT JOIN (
                SELECT
                *
                FROM tbl_MyProject_Services_History
                WHERE is_deleted = 0
            ) AS h
            ON m.MyPro_id = h.MyPro_PK

            WHERE m.is_deleted = 0 
            AND h.History_id = $id" );
        if ( mysqli_num_rows($selectData) > 0 ) {
            $row = mysqli_fetch_array($selectData);
            $parent_id = $row["h_library_ID"];
            $name = $row["m_name"];
            $description = $row["h_name"];

            $data_start_date = $row["m_date_start"];
            $data_start_date = new DateTime($data_start_date);
            $data_start_date = $data_start_date->format('Y-m-d');

            $data_desired_date = $row["h_date_due"];
            $data_desired_date = new DateTime($data_desired_date);
            $data_desired_date = $data_desired_date->format('Y-m-d');

            $files = $row["h_files"];
            $type = '';
            if (!empty($files)) {
                $fileExtension = fileExtension($files);
                $src = $fileExtension['src'];
                $embed = $fileExtension['embed'];
                $type = $fileExtension['type'];
                $file_extension = $fileExtension['file_extension'];
                $url = $base_url.'uploads/task/';

                $files = $src.$url.rawurlencode($files).$embed;
            }

            $assigned_to_id = explode(', ', $row["h_assign_to_id"]);
        }

        echo '<input class="form-control" type="hidden" name="ID" value="'. $id .'" />
        <input class="form-control" type="hidden" name="parent_id" value="'. $parent_id .'" />
        <div class="form-group">
            <label class="col-md-3 control-label">Project Name</label>
            <div class="col-md-8">
                <input class="form-control" type="text" name="name" value="'.$name.'" required />
            </div>
        </div>
		<div class="form-group">
            <label class="col-md-3 control-label">Image/file</label>
            <div class="col-md-8">
                <input class="form-control '; echo !empty($files) ? 'hide':''; echo '" type="file" name="file" />
                <p class="'; echo !empty($files) ? '':'hide'; echo '" style="margin: 0;"><a data-src="'.$files.'" data-fancybox data-type="'.$type.'" class="btn btn-link">View</a> | <button type="button" class="btn btn-link uploadNew" onclick="uploadNew(this)">Upload New</button></p>
                <small><i class="text-primary">( Sample/Supporting files )</i></small>
            </div>
        </div>
        <div class="form-group">
            <label class="col-md-3 control-label">Task Description</label>
            <div class="col-md-8">
                <textarea class="form-control" name="description" required>'.$description.'</textarea>
            </div>
        </div>
        <div class="form-group">
            <label class="col-md-3 control-label">Start Date</label>
            <div class="col-md-8">
                <input class="form-control" type="date" name="start_date" value="'.$data_start_date.'" required />
            </div>
        </div>
        <div class="form-group">
            <label class="col-md-3 control-label">Desired Deliver Date</label>
            <div class="col-md-8">
                <input class="form-control" type="date" name="desired_date" value="'.$data_desired_date.'" required />
            </div>
        </div>
        <div class="form-group">
            <label class="col-md-3 control-label">Assigned To</label>
            <div class="col-md-8">
            	<select class="form-control mt-multiselect btn btn-default" name="assigned_to_id[]" required >';

	                $selectEmployee = mysqli_query( $conn,"SELECT * FROM tbl_hr_employee WHERE status = 1 AND user_id=$user_id" );
	                if ( mysqli_num_rows($selectEmployee) > 0 ) {
	                    while($rowEmployee = mysqli_fetch_array($selectEmployee)) {
	                        $rowEmployeeID = $rowEmployee["ID"];
	                        $rowEmployeeFName = $rowEmployee["first_name"];
	                        $rowEmployeeLName = $rowEmployee["last_name"];

	                        if (in_array($rowEmployeeID, $assigned_to_id)) {
	                        	echo '<option value="'. $rowEmployeeID .'" SELECTED>'. $rowEmployeeFName .' '. $rowEmployeeLName .'</option>';
	                        } else {
	                        	echo '<option value="'. $rowEmployeeID .'">'. $rowEmployeeFName .' '. $rowEmployeeLName .'</option>';
	                        }
	                    }

	                    if (!empty($_COOKIE['switchAccount'])) {
	                    	$selectEmployeeSwitch = mysqli_query( $conn,"SELECT * FROM tbl_hr_employee WHERE status = 1 AND ID = 90 OR ID = 91 OR ID = 75 OR ID = 79 OR ID = 71 OR ID = 81 OR ID = 68 OR ID = 69" );
			                if ( mysqli_num_rows($selectEmployeeSwitch) > 0 ) {
			                    while($rowEmployeeSwitch = mysqli_fetch_array($selectEmployeeSwitch)) {
			                        $rowEmployeeIDSwitch = $rowEmployeeSwitch["ID"];
			                        $rowEmployeeFNameSwitch = $rowEmployeeSwitch["first_name"];
			                        $rowEmployeeLNameSwitch = $rowEmployeeSwitch["last_name"];

			                        if (in_array($rowEmployeeIDSwitch, $assigned_to_id)) {
			                        	echo '<option value="'. $rowEmployeeIDSwitch .'" SELECTED>'. $rowEmployeeFNameSwitch .' '. $rowEmployeeLNameSwitch .'</option>';
			                        } else {
			                        	echo '<option value="'. $rowEmployeeIDSwitch .'">'. $rowEmployeeFNameSwitch .' '. $rowEmployeeLNameSwitch .'</option>';
			                        }
			                    }
			                }
	                    }
	                } else {
	                    echo '<option disabled>No Available</option>';
	                }

	            echo '</select>
            </div>
        </div>';

        mysqli_close($conn);
	}
	if( isset($_GET['btnDelete_Task']) ) {
		$id = $_GET['btnDelete_Task'];
    	$current_userID = $_COOKIE['ID'];
		$reason = addslashes($_GET['reason']);

        $message = array();
		array_push($message, $current_userID);
		array_push($message, $reason);
		$message = implode(" | ",$message);

		mysqli_query( $conn,"UPDATE tbl_MyProject_Services_History SET is_deleted = 1, reason = '". $message ."' WHERE History_id='". $id ."'" );

		$selectData = mysqli_query( $conn,'SELECT * FROM tbl_MyProject_Services WHERE MyPro_id="'. $id .'"' );
		$rowData = mysqli_fetch_array($selectData);
        $data_library_id = $rowData['library_id'];
			
		// Update History Data
		// actionHistory($data_library_id, 3, 8, $id);
	}
	if( isset($_POST['btnSave_Task']) ) {
        if (!empty($_COOKIE['switchAccount'])) {
            $portal_user = $_COOKIE['ID'];
            $user_id = $_COOKIE['switchAccount'];
        }
        else {
            $portal_user = $_COOKIE['ID'];
            $user_id = employerID($portal_user);
        }

        $hasLibrary = mysqli_query( $conn,"SELECT * FROM tbl_library WHERE user_id = $user_id" );
        if ( mysqli_num_rows($hasLibrary) == 0 ) {
            $user_id = 163;
        }

    	$current_userID = $_COOKIE['ID'];
		$parent_id = $_POST['parent_id'];
		$name = addslashes($_POST['name']);
		$description = addslashes($_POST['description']);
		$start_date = $_POST['start_date'];
		$desired_date = $_POST['desired_date'];
    	$last_modified = date('Y-m-d');
        $rand_id = rand(10,1000000);
        $process = true;

		$files = $_FILES['file']['name'];
		if (!empty($files)) {
			$path = 'uploads/task/';
			$tmp = $_FILES['file']['tmp_name'];
            $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
            $ext = strtolower(pathinfo($files, PATHINFO_EXTENSION));
			$files = rand(1000,1000000) . ' - ' . $files;
			$path = $path.$files;

            if(!in_array($ext, $invalid_extensions)) {
                move_uploaded_file($tmp,$path);
            } else {
                $process = false;
            }
		}

        if ($process == true) {
    		$assigned_to_id = '';
    		if (!empty($_POST['assigned_to_id'])) {
    			$assigned_to_id = implode(", ",$_POST['assigned_to_id']);
    		}

            $h_accounts = 'Others';
            if ($user_id == 34) {
                $h_accounts = 'CONSULTAREINC';
            }

            $selectData = mysqli_query( $conn,"SELECT * FROM tbl_MyProject_Services WHERE is_deleted = 0 AND library_id = $parent_id" );
            if ( mysqli_num_rows($selectData) > 0 ) {
                $rowData = mysqli_fetch_array($selectData);
                $data_ID = $rowData['MyPro_id'];

                $sql_history = "INSERT INTO tbl_MyProject_Services_History (user_id, library_id, MyPro_PK, files, filename, description, Estimated_Time, Action_taken, Action_date, Assign_to_history, Services_History_Status, rand_id, h_accounts)
                VALUES ('$portal_user', '$parent_id', '$data_ID', '$files', '$description', '$description', '0', '0', '$desired_date', '$assigned_to_id', 1, '$rand_id', '$h_accounts')";
            } else {
                $sql = "INSERT INTO tbl_MyProject_Services (portal_user, user_id, user_cookies, switch_id, library_id, Project_Name, Project_Description, Start_Date, Desired_Deliver_Date, Sample_Documents, Collaborator_PK, last_modified)
                VALUES ('$portal_user', '$user_id', '$portal_user', '$user_id', '$parent_id', '$name', '$name', '$start_date', '$desired_date', '$files', '$assigned_to_id', '$last_modified')";

                if (mysqli_query($conn, $sql)) {
                    $last_id = mysqli_insert_id($conn);

                    $sql_history = "INSERT INTO tbl_MyProject_Services_History (user_id, library_id, MyPro_PK, files, filename, description, Estimated_Time, Action_taken, Action_date, Assign_to_history, Services_History_Status, rand_id, h_accounts)
                    VALUES ('$portal_user', '$parent_id', '$last_id', '$files', '$description', '$description', '0', '0', '$desired_date', '$assigned_to_id', 1, '$rand_id', '$h_accounts')";
                } else {
                    $message = "Error: " . $sql . "<br>" . mysqli_error($conn);
                }
            }
    		if (mysqli_query($conn, $sql_history)) {
                $last_history_id = mysqli_insert_id($conn);
                $selectDataHistory = mysqli_query( $conn,"SELECT * FROM tbl_MyProject_Services_History WHERE History_id = $last_history_id" );
                if ( mysqli_num_rows($selectDataHistory) > 0 ) {
                    $rowDataHistory = mysqli_fetch_array($selectDataHistory);
                    // $data_ID = $rowDataHistory['MyPro_id'];

                    $resultUserS = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $user_id" );
                    $rowUserS = mysqli_fetch_array($resultUserS);
                    $sender_name = $rowUserS["first_name"] .' '. $rowUserS["last_name"];
                    $sender_email = $rowUserS["email"];

                    $subject = 'New Dashboard Task';
                    $mail_sent = 0;

                    $array_name = array();
                    $user_arr = explode(', ', $assigned_to_id);
                    foreach ($user_arr as $value) {
                        $selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE employee_id = $value " );
                        if ( mysqli_num_rows($selectUser) > 0 ) {
                            $rowUser = mysqli_fetch_array($selectUser);
                            $assigned_email = $rowUser["email"];
                            $assigned_name = $rowUser["first_name"] .' '. $rowUser["last_name"];
                            array_push($array_name, $assigned_name);

                            $to = $assigned_email;
                            $user = $assigned_name;
                            $body = 'Hi there,<br><br>

                            '.$sender_name.' assigned a task<br><br>

                            Project Name: '.stripcslashes($name).'<br>
                            Task Description: '.stripcslashes($description).'<br><br>

                            <a href="'. $base_url .'dashboard?d='. $parent_id .'" target="_blank" style="font-weight: 600; padding: 10px 20px!important; text-decoration: none; color: #fff; background-color: #27a4b0; border-color: #208992; display: inline-block;">View Here</a><br><br>';
                
                            if ($_COOKIE['client'] == 1) {
                                $from = 'CannOS@begreenlegal.com';
                                $name = 'BeGreenLegal';
                                $body .= 'Cann OS Team';
                            }  else if ($_COOKIE['client'] == 2) {
                                $from = 'foodsafety360r@gmail.com';
                                $name = 'Food Safety 360';
                                $body .= 'Food Safety 360';
                            } else if ($_COOKIE['client'] == 3) {
                                $from = 'cannabis360r@gmail.com';
                                $name = 'SafeCannabis360';
                                $body .= 'SafeCannabis360';
                            } else if ($_COOKIE['client'] == 4) {
                                $from = 'exim360r@gmail.com';
                                $name = 'Exim360';
                                $body .= 'Exim360';
                            } else {
                                $from = 'services@interlinkiq.com';
                                $name = 'InterlinkIQ';
                                $body .= 'InterlinkIQ.com Team<br>
                                Consultare Inc.';
                            }

                            if ($mail_sent > 0) {
                                php_mailer_2($to, $user, $subject, $body, $from, $name);
                                $mail_sent++;
                            } else {
                                php_mailer_1($to, $user, $subject, $body, $from, $name);
                                $mail_sent++;
                            }
                        }
                    }
                    $array_name = implode(", ",$array_name);

                    $files = '<i class="fa fa-file-code-o" style="visibility: hidden;"></i>';
                    $data_files = $rowDataHistory['files'];
                    if (!empty($data_files)) {
                        $fileExtension = fileExtension($data_files);
                        $src = $fileExtension['src'];
                        $embed = $fileExtension['embed'];
                        $type = $fileExtension['type'];
                        $file_extension = $fileExtension['file_extension'];
                        $url = $base_url.'uploads/task/';
                        $files = '<a data-src="'.$src.$url.rawurlencode($data_files).$embed.'" data-fancybox data-type="'.$type.'"><i class="fa '. $file_extension .'"></i></a>';
                    }

                    $data_start_date = $start_date;
                    $data_start_date = new DateTime($data_start_date);
                    $data_start_date = $data_start_date->format('M d, Y');

                    $data_desired_date = $desired_date;
                    $data_desired_date = new DateTime($data_desired_date);
                    $data_desired_date = $data_desired_date->format('M d, Y');

                    $data_last_modified = $last_modified;
                    $data_last_modified = new DateTime($data_last_modified);
                    $data_last_modified = $data_last_modified->format('M d, Y');

                    $output = array(
                        'ID' => $last_history_id,
                        'parent_id' => $parent_id,
                        'files' => $files,
                        'name' => stripcslashes($name),
                        'description' => stripcslashes($description),
                        'start_date' => $data_start_date,
                        'desired_date' => $data_desired_date,
                        'assigned_name' => $array_name,
                        'last_modified' => $data_last_modified
                    );
                    echo json_encode($output);

                    // Update History Data
                    // actionHistory($parent_id, 1, 8, $data_ID);
                }
            } else {
                $message = "Error: " . $sql_history . "<br>" . mysqli_error($conn);
                echo $message;
            }
            mysqli_close($conn);
        }
	}
	if( isset($_POST['btnUpdate_Task']) ) {
        if (!empty($_COOKIE['switchAccount'])) {
            $portal_user = $_COOKIE['ID'];
            $user_id = $_COOKIE['switchAccount'];
        }
        else {
            $portal_user = $_COOKIE['ID'];
            $user_id = employerID($portal_user);
        }

        $hasLibrary = mysqli_query( $conn,"SELECT * FROM tbl_library WHERE user_id = $user_id" );
        if ( mysqli_num_rows($hasLibrary) == 0 ) {
            $user_id = 163;
        }

		$ID = $_POST['ID'];
        $parent_id = $_POST['parent_id'];
    	$current_userID = $_COOKIE['ID'];
		$name = addslashes($_POST['name']);
		$description = addslashes($_POST['description']);
		$start_date = $_POST['start_date'];
		$desired_date = $_POST['desired_date'];
    	$last_modified = date('Y-m-d');
        $process = true;

		$files = $_FILES['file']['name'];
        if (!empty($files)) {
            $path = 'uploads/task/';
            $tmp = $_FILES['file']['tmp_name'];
            $invalid_extensions = array('php', 'php3', 'php4', 'php5', 'phtml', 'cgi', 'pl', 'sh', 'py', 'rb', 'exe', 'dll');
            $ext = strtolower(pathinfo($files, PATHINFO_EXTENSION));
            $files = rand(1000,1000000) . ' - ' . $files;
            $path = $path.$files;

            if(!in_array($ext, $invalid_extensions)) {
                move_uploaded_file($tmp,$path);

                mysqli_query( $conn,"UPDATE tbl_MyProject_Services_History SET files='". $files ."' WHERE History_id='". $ID ."'" );
            } else {
                $process = false;
            }
        }

        if ($process == true) {
    		$assigned_to_id = '';
    		if (!empty($_POST['assigned_to_id'])) {
    			$assigned_to_id = implode(", ",$_POST['assigned_to_id']);
    		}

    		mysqli_query( $conn,"UPDATE tbl_MyProject_Services SET Project_Name='". $name ."', Project_Description='". $name ."', Start_Date='". $start_date ."', Desired_Deliver_Date='". $desired_date ."', Collaborator_PK='". $assigned_to_id ."', last_modified='". $last_modified ."' WHERE library_id='". $parent_id ."'" );
            mysqli_query( $conn,"UPDATE tbl_MyProject_Services_History SET filename='". $description ."', description='". $description ."', Action_date='". $desired_date ."', Assign_to_history='". $assigned_to_id ."' WHERE History_id='". $ID ."'" );

    		$selectData = mysqli_query( $conn,"SELECT
                h.History_id AS h_ID,
                h.library_id AS h_library_ID,
                h.filename AS h_name,
                h.Assign_to_History AS h_assign_to_id,
                h.files AS h_files,
                h.Action_date AS h_date_due,
                m.Start_Date AS m_date_start,
                m.Project_Name AS m_name
                FROM tbl_MyProject_Services AS m

                LEFT JOIN (
                    SELECT
                    *
                    FROM tbl_MyProject_Services_History
                    WHERE is_deleted = 0
                ) AS h
                ON m.MyPro_id = h.MyPro_PK

                WHERE m.is_deleted = 0 
                AND h.History_id = $ID" );
            if ( mysqli_num_rows($selectData) > 0 ) {
                $rowData = mysqli_fetch_array($selectData);
                $data_ID = $rowData['h_ID'];
                $data_library_id = $rowData['h_library_ID'];

                $resultUserS = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE ID = $user_id" );
                $rowUserS = mysqli_fetch_array($resultUserS);
                $sender_name = $rowUserS["first_name"] .' '. $rowUserS["last_name"];
                $sender_email = $rowUserS["email"];

                $subject = 'Updated Dashboard Task';
                $mail_sent = 0;

                $array_name = array();
                $user_arr = explode(', ', $assigned_to_id);
                foreach ($user_arr as $value) {
                    $selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE employee_id = $value " );
                    if ( mysqli_num_rows($selectUser) > 0 ) {
                        $rowUser = mysqli_fetch_array($selectUser);
                        $assigned_email = $rowUser["email"];
                        $assigned_name = $rowUser["first_name"] .' '. $rowUser["last_name"];
                        array_push($array_name, $assigned_name);

                        $to = $assigned_email;
                        $user = $assigned_name;
                        $body = 'Hi there,<br><br>

                        '.$sender_name.' assigned a task<br><br>

                        Project Name: '.stripcslashes($name).'<br>
                        Task Description: '.stripcslashes($description).'<br><br>

                        <a href="'. $base_url .'dashboard?d='. $parent_id .'" target="_blank" style="font-weight: 600; padding: 10px 20px!important; text-decoration: none; color: #fff; background-color: #27a4b0; border-color: #208992; display: inline-block;">View Here</a><br><br>';
            
                        if ($_COOKIE['client'] == 1) {
                            $from = 'CannOS@begreenlegal.com';
                            $name = 'BeGreenLegal';
                            $body .= 'Cann OS Team';
                        } else if ($_COOKIE['client'] == 2) {
                            $from = 'foodsafety360r@gmail.com';
                            $name = 'Food Safety 360';
                            $body .= 'Food Safety 360';
                        } else if ($_COOKIE['client'] == 3) {
                            $from = 'cannabis360r@gmail.com';
                            $name = 'SafeCannabis360';
                            $body .= 'SafeCannabis360';
                        } else if ($_COOKIE['client'] == 4) {
                            $from = 'exim360r@gmail.com';
                            $name = 'Exim360';
                            $body .= 'Exim360';
                        } else {
                            $from = 'services@interlinkiq.com';
                            $name = 'InterlinkIQ';
                            $body .= 'InterlinkIQ.com Team<br>
                            Consultare Inc.';
                        }

                        if ($mail_sent > 0) {
                            php_mailer_2($to, $user, $subject, $body, $from, $name);
                            $mail_sent++;
                        } else {
                            php_mailer_1($to, $user, $subject, $body, $from, $name);
                            $mail_sent++;
                        }
                    }
                }
                $array_name = implode(", ",$array_name);

                $files = '<i class="fa fa-file-code-o" style="visibility: hidden;"></i>';
                $data_files = $rowData['h_files'];
                if (!empty($data_files)) {
                    $fileExtension = fileExtension($data_files);
                    $src = $fileExtension['src'];
                    $embed = $fileExtension['embed'];
                    $type = $fileExtension['type'];
                    $file_extension = $fileExtension['file_extension'];
                    $url = $base_url.'uploads/task/';
                    $files = '<a data-src="'.$src.$url.rawurlencode($data_files).$embed.'" data-fancybox data-type="'.$type.'"><i class="fa '. $file_extension .'"></i></a>';
                }

                $data_start_date = $start_date;
                $data_start_date = new DateTime($data_start_date);
                $data_start_date = $data_start_date->format('M d, Y');

                $data_desired_date = $desired_date;
                $data_desired_date = new DateTime($data_desired_date);
                $data_desired_date = $data_desired_date->format('M d, Y');

                $data_last_modified = $last_modified;
                $data_last_modified = new DateTime($data_last_modified);
                $data_last_modified = $data_last_modified->format('M d, Y');

                $output = array(
                    'ID' => $data_ID,
                    'parent_id' => $data_library_id,
                    'files' => $files,
                    'name' => stripcslashes($name),
                    'description' => stripcslashes($description),
                    'start_date' => $data_start_date,
                    'desired_date' => $data_desired_date,
                    'assigned_name' => $array_name,
                    'last_modified' => $data_last_modified
                );
                echo json_encode($output);

                // Update History Data
                // actionHistory($parent_id, 2, 8, $data_ID);
            }
    		mysqli_close($conn);
    	}
    }
	
	// Clone Section
	function cloneChild($req_user_id, $parent_id, $last_id, $include) {
		global $conn;

		$resultChild = mysqli_query( $conn,"SELECT * FROM tbl_library WHERE deleted = 0 AND parent_id = $parent_id");
        if ( mysqli_num_rows($resultChild) > 0 ) {
            while($rowChild = mysqli_fetch_array($resultChild)) {

            	$new_parent_id = $rowChild["ID"];

            	// CHILD CLONING
            	$sql = "INSERT INTO tbl_library (user_id, parent_id, child_id, type, name, program, description, assigned_to_id, due_date, last_modified)
				SELECT $req_user_id, $last_id, '', type, name, program, description, assigned_to_id, due_date, last_modified
				FROM tbl_library
				WHERE ID = $new_parent_id";

				if (mysqli_query($conn, $sql)) {
					$new_last_id = mysqli_insert_id($conn);

					// Includes
					if (!empty($include)) {
						$includes = implode(', ', $include);
						$include_arr = explode(", ", $includes);
			            foreach ($include_arr as $value) {
			                if ( $value == 1 ) { cloneFile($req_user_id, $new_parent_id, $new_last_id); }
			                else if ( $value == 2 ) { cloneComment($req_user_id, $new_parent_id, $new_last_id); }
			                else if ( $value == 3 ) { cloneCompliance($req_user_id, $new_parent_id, $new_last_id); }
			                else if ( $value == 4 ) { cloneReview($req_user_id, $new_parent_id, $new_last_id); }
			                else if ( $value == 5 ) { cloneTemplate($req_user_id, $new_parent_id, $new_last_id); }
			                else if ( $value == 6 ) { cloneReference($req_user_id, $new_parent_id, $new_last_id); }
			            }
					}

					$selectData = mysqli_query( $conn,"SELECT * FROM tbl_library WHERE ID = $last_id");
					if ( mysqli_num_rows($selectData) > 0 ) {
						$rowData = mysqli_fetch_array($selectData);

						$child_id = array();
						if ( !empty($rowData['child_id']) ) {
							array_push($child_id, $rowData['child_id']);
						}
						array_push($child_id, $new_last_id);

						// Update parent's record
						$child_id = implode(", ",$child_id);
						mysqli_query( $conn,"UPDATE tbl_library set child_id='". $child_id ."' WHERE ID='". $last_id ."'" );
					}
					cloneChild($req_user_id, $new_parent_id, $new_last_id, $include);
				}
            }
        }
	}
	function cloneFile($req_user_id, $parent_id, $last_id) {
		global $conn;

		$resultFile = mysqli_query( $conn,"SELECT * FROM tbl_library_file WHERE deleted = 0 AND library_id = $parent_id");
        if ( mysqli_num_rows($resultFile) > 0 ) {
            while($rowFile = mysqli_fetch_array($resultFile)) {
            	$new_file_id = $rowFile["ID"];

            	$sql = "INSERT INTO tbl_library_file (user_id, library_id, type, files, name, comment, due_date, last_modified)
				SELECT $req_user_id, $last_id, type, files, name, comment, due_date, last_modified
				FROM tbl_library_file
				WHERE deleted = 0 AND ID = $new_file_id";

				mysqli_query($conn, $sql);
            }
        }
	}
	function cloneComment($req_user_id, $parent_id, $last_id) {
		global $conn;

		$resultComment = mysqli_query( $conn,"SELECT * FROM tbl_library_comment WHERE deleted = 0 AND library_id = $parent_id");
        if ( mysqli_num_rows($resultComment) > 0 ) {
            while($rowComment = mysqli_fetch_array($resultComment)) {
            	$new_comment_id = $rowComment["ID"];

            	$sql = "INSERT INTO tbl_library_comment (user_id, library_id, title, comment, last_modified)
				SELECT $req_user_id, $last_id, title, comment, last_modified
				FROM tbl_library_comment
				WHERE deleted = 0 AND ID = $new_comment_id";

				mysqli_query($conn, $sql);
            }
        }
	}
	function cloneCompliance($req_user_id, $parent_id, $last_id) {
		global $conn;

		$selectData = mysqli_query( $conn,"SELECT * FROM tbl_library_compliance WHERE deleted = 0 AND library_id = $parent_id");
        if ( mysqli_num_rows($selectData) > 0 ) {
            while($rowData = mysqli_fetch_array($selectData)) {
            	$new_id = $rowData["ID"];

            	$sql = "INSERT INTO tbl_library_compliance (user_id, library_id, action_items, requirements, compliant, comment, remark, remark_user, frequency, files, schedule, type, parent_id, child_id, assigned_to_id, last_modified)
				SELECT $req_user_id, $last_id, action_items, requirements, compliant, comment, remark, remark_user, frequency, files, schedule, type, parent_id, child_id, assigned_to_id, last_modified
				FROM tbl_library_compliance
				WHERE deleted = 0 AND ID = $new_id";

				mysqli_query($conn, $sql);
            }
        }
	}
	function cloneReview($req_user_id, $parent_id, $last_id) {
		global $conn;

		$selectData = mysqli_query( $conn,"SELECT * FROM tbl_library_review WHERE is_deleted = 0 AND library_id = $parent_id");
        if ( mysqli_num_rows($selectData) > 0 ) {
            while($rowData = mysqli_fetch_array($selectData)) {
            	$new_id = $rowData["ID"];

            	$sql = "INSERT INTO tbl_library_review (user_id, library_id, action_items, requirements, compliant, title, template, comment, remark, remark_user, files, type, parent_id, child_id, last_modified)
				SELECT $req_user_id, $last_id, action_items, requirements, compliant, title, template, comment, remark, remark_user, files, type, parent_id, child_id, last_modified
				FROM tbl_library_review
				WHERE is_deleted = 0 AND ID = $new_id";

				mysqli_query($conn, $sql);
            }
        }
	}
	function cloneTemplate($req_user_id, $parent_id, $last_id) {
		global $conn;

		$selectData = mysqli_query( $conn,"SELECT * FROM tbl_library_template WHERE is_deleted = 0 AND library_id = $parent_id");
        if ( mysqli_num_rows($selectData) > 0 ) {
            while($rowData = mysqli_fetch_array($selectData)) {
            	$new_id = $rowData["ID"];

            	$sql = "INSERT INTO tbl_library_template (user_id, library_id, files, description, last_modified)
				SELECT $req_user_id, $last_id, files, description, last_modified
				FROM tbl_library_template
				WHERE is_deleted = 0 AND ID = $new_id";

				mysqli_query($conn, $sql);
            }
        }
	}
	function cloneReference($req_user_id, $parent_id, $last_id) {
		global $conn;

		$selectData = mysqli_query( $conn,"SELECT * FROM tbl_library_references WHERE is_deleted = 0 AND library_id = $parent_id");
        if ( mysqli_num_rows($selectData) > 0 ) {
            while($rowData = mysqli_fetch_array($selectData)) {
            	$new_id = $rowData["ID"];

            	$sql = "INSERT INTO tbl_library_references (user_id, library_id, files, description, last_modified)
				SELECT $req_user_id, $last_id, files, description, last_modified
				FROM tbl_library_references
				WHERE is_deleted = 0 AND ID = $new_id";

				mysqli_query($conn, $sql);
            }
        }
	}
	function cloneVideo($req_user_id, $parent_id, $last_id) {
		global $conn;

		$selectData = mysqli_query( $conn,"SELECT * FROM tbl_library_video WHERE is_deleted = 0 AND library_id = $parent_id");
        if ( mysqli_num_rows($selectData) > 0 ) {
            while($rowData = mysqli_fetch_array($selectData)) {
            	$new_id = $rowData["ID"];

            	$sql = "INSERT INTO tbl_library_video (user_id, library_id, type, url, files, description, last_modified)
				SELECT $req_user_id, $last_id, type, url, files, description, last_modified
				FROM tbl_library_video
				WHERE is_deleted = 0 AND ID = $new_id";

				mysqli_query($conn, $sql);
            }
        }
	}
	if( isset($_GET['btnClone']) ) {
		$id = $_GET['btnClone'];

		if (!empty($_COOKIE['switchAccount'])) {
			$portal_user = $_COOKIE['ID'];
			$user_id = $_COOKIE['switchAccount'];
		}
		else {
			$portal_user = $_COOKIE['ID'];
			$user_id = employerID($portal_user);
		}

		$current_userEmployerID = employerID($_COOKIE['ID']);
		$current_client = 0;
		if (!empty($_COOKIE['client'])) { $current_client = 1; }

		echo '<input class="form-control" type="hidden" name="ID" value="'. $id .'" />
		<div class="form-group">
            <label class="col-md-3 control-label">Select User</label>
            <div class="col-md-8">
                <select class="form-control mt-multiselect btn btn-default" name="user" required>
                	<option value="">Select</option>';

		            if ($portal_user == 1 OR $portal_user == 2 OR $portal_user == 19 OR $portal_user == 163 OR $current_userEmployerID == 27 OR $user_id == 464 OR $portal_user == 481) {
                		$selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE employee_id = 0 AND is_verified = 1 AND is_active = 1" );
                		if ($current_client == 1) { $selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE employee_id = 0 AND is_verified = 1 AND is_active = 1 AND client = 1" ); }

	                    if ( mysqli_num_rows($selectUser) > 0 ) {
	                        while($rowUser = mysqli_fetch_array($selectUser)) {
	                            $user_ID = $rowUser["ID"];
	                            $user_name = $rowUser["first_name"] .' '.$rowUser["last_name"];

	                            echo '<option value="'.$user_ID.'">'.$user_name.'</option>';
	                        }
	                    }
                	} else {
                		$selectSupplier = mysqli_query( $conn,"SELECT * FROM tbl_supplier WHERE page = 2 AND is_deleted = 0 AND status = 1 AND user_id = $portal_user" );
	                    if ( mysqli_num_rows($selectSupplier) > 0 ) {
	                        while($rowSupplier = mysqli_fetch_array($selectSupplier)) {
	                            $supplier_email = $rowSupplier["email"];

	                            $selectUser = mysqli_query( $conn,"SELECT * FROM tbl_user WHERE is_verified = 1 AND is_active = 1 AND email = '".$supplier_email."'" );
			                    if ( mysqli_num_rows($selectUser) > 0 ) {
			                        $rowUser = mysqli_fetch_array($selectUser);
		                            $user_ID = $rowUser["ID"];
		                            $user_name = $rowUser["first_name"] .' '.$rowUser["last_name"];

		                            echo '<option value="'.$user_ID.'">'.$user_name.'</option>';
			                    }
	                        }
	                    }
                	}

                echo '</select>
            </div>
        </div>
        <div class="form-group">
            <label class="col-md-3 control-label">Include(s)</label>
            <div class="col-md-8">
                <div class="mt-checkbox-list margin-top-10">
					<label class="mt-checkbox mt-checkbox-outline"> Files
					    <input type="checkbox" value="1" name="include[]" checked />
					    <span></span>
					</label>
					<label class="mt-checkbox mt-checkbox-outline"> Comments
					    <input type="checkbox" value="2" name="include[]" checked />
					    <span></span>
					</label>
					<label class="mt-checkbox mt-checkbox-outline"> Compliance
					    <input type="checkbox" value="3" name="include[]" checked />
					    <span></span>
					</label>
					<label class="mt-checkbox mt-checkbox-outline"> Annual Review
					    <input type="checkbox" value="4" name="include[]" checked />
					    <span></span>
					</label>
					<label class="mt-checkbox mt-checkbox-outline"> Templates
					    <input type="checkbox" value="5" name="include[]" checked />
					    <span></span>
					</label>
					<label class="mt-checkbox mt-checkbox-outline"> References
					    <input type="checkbox" value="6" name="include[]" checked />
					    <span></span>
					</label>
					<label class="mt-checkbox mt-checkbox-outline"> Video
					    <input type="checkbox" value="7" name="include[]" checked />
					    <span></span>
					</label>
				</div>
            </div>
        </div>';
	}
	if( isset($_POST['btnSave_Clone']) ) {
		$ID = $_POST['ID'];
		$user = $_POST['user'];
		$include = $_POST['include'];

		$sql = "INSERT INTO tbl_library (user_id, parent_id, child_id, type, name, program, description, assigned_to_id, due_date, last_modified)
		SELECT $user, '0', '', type, name, program, description, assigned_to_id, due_date, last_modified
		FROM tbl_library
		WHERE ID = $ID";

		if (mysqli_query($conn, $sql)) {
			$last_id = mysqli_insert_id($conn);

			// Includes
			if (!empty($include)) {
				$includes = implode(', ', $include);
				$include_arr = explode(", ", $includes);
	            foreach ($include_arr as $value) {
	                if ( $value == 1 ) { cloneFile($user, $ID, $last_id); }
	                else if ( $value == 2 ) { cloneComment($user, $ID, $last_id); }
	                else if ( $value == 3 ) { cloneCompliance($user, $ID, $last_id); }
	                else if ( $value == 4 ) { cloneReview($user, $ID, $last_id); }
	                else if ( $value == 5 ) { cloneTemplate($user, $ID, $last_id); }
	                else if ( $value == 6 ) { cloneReference($user, $ID, $last_id); }
	                else if ( $value == 7 ) { cloneVideo($user, $ID, $last_id); }
	            }
			}

			// Parent
			$selectData = mysqli_query( $conn,"SELECT * FROM tbl_library WHERE ID=$ID");
			if ( mysqli_num_rows($selectData) > 0 ) {
				$rowData = mysqli_fetch_array($selectData);
				$data_child_id = $rowData['child_id'];

				// Child
				if (!empty($data_child_id)) {
					cloneChild($user, $ID, $last_id, $include);
				}
			}

			echo 'Done';
		}
	}

	// Report Section
    function itemReport($parent_id, $child_id) {
        global $conn;
        global $base_url;

        $resultTreeItem = mysqli_query( $conn,"SELECT * FROM tbl_library WHERE deleted = 0 AND parent_id = $parent_id" );
        $output = "";
        if ( mysqli_num_rows($resultTreeItem) > 0 ) {
            while($rowTreeItem = mysqli_fetch_array($resultTreeItem)) {
                $item_ID = $rowTreeItem["ID"];
                $new_parent_id = $rowTreeItem["parent_id"];
                $new_child_id = $rowTreeItem["child_id"];

                $type_id = $rowTreeItem["type"];
                $rtype = "";
                $name = $rowTreeItem["name"];
                $comment = "Not Specified";
                $files = "";
                $files_uploaded = "";
			    $due_date = $rowTreeItem['due_date'];

			    $array_name_id = explode(", ", $name);
                if ( count($array_name_id) == 4 ) {
                    $data_name = array();

                    $selectType = mysqli_query($conn,"SELECT * FROM tbl_library_type WHERE ID = '".$array_name_id[0]."'");
                    if ( mysqli_num_rows($selectType) > 0 ) {
                        while($rowType = mysqli_fetch_array($selectType)) {
                            array_push($data_name, $rowType["name"]);
                        }
                    }

                    $selectCategory = mysqli_query($conn,"SELECT * FROM tbl_library_category WHERE ID = '".$array_name_id[1]."'");
                    if ( mysqli_num_rows($selectCategory) > 0 ) {
                        while($rowCategory = mysqli_fetch_array($selectCategory)) {
                            array_push($data_name, $rowCategory["name"]);
                        }
                    }

                    $selectScope = mysqli_query($conn,"SELECT * FROM tbl_library_scope WHERE ID = '".$array_name_id[2]."'");
                    if ( mysqli_num_rows($selectScope) > 0 ) {
                        while($rowScope = mysqli_fetch_array($selectScope)) {
                            array_push($data_name, $rowScope["name"]);
                        }
                    }

                    $selectModule = mysqli_query($conn,"SELECT * FROM tbl_library_module WHERE ID = '".$array_name_id[3]."'");
                    if ( mysqli_num_rows($selectModule) > 0 ) {
                        while($rowModule = mysqli_fetch_array($selectModule)) {
                            array_push($data_name, $rowModule["name"]);
                        }
                    }

                    $name = implode(" - ",$data_name);
                }

                if ($type_id == 0) { $rtype = "Company"; }
                else if ($type_id == 1) { $rtype = "Program"; }
                else if ($type_id == 2) { $rtype = "Policy"; }
                else if ($type_id == 3) { $rtype = "Procedure"; }
                else if ($type_id == 4) { $rtype = "Training"; }
                else if ($type_id == 5) { $rtype = "Form"; }

                $resultItemComment = mysqli_query( $conn,"SELECT * FROM tbl_library_comment WHERE deleted = 0 AND library_id = $item_ID" );
		        if ( mysqli_num_rows($resultItemComment) > 0 ) {
		            while($rowItemComment = mysqli_fetch_array($resultItemComment)) {
		            	$comment = $rowItemComment["comment"];
		            }
		        }

                $resultItemFile = mysqli_query( $conn,"SELECT * FROM tbl_library_file WHERE deleted = 0 AND library_id = $item_ID" );
		        if ( mysqli_num_rows($resultItemFile) > 0 ) {
		            while($rowItemComment = mysqli_fetch_array($resultItemFile)) {
		            	$files_name = $rowItemComment["name"];
		            	$file_comment = $rowItemComment["comment"];
		            	$files_uploaded = $rowItemComment["last_modified"];

		            	$files = $rowItemComment["files"];
		                $fileExtension = fileExtension($files);
						$src = $fileExtension['src'];
						$embed = $fileExtension['embed'];
						$type = $fileExtension['type'];
						$file_extension = $fileExtension['file_extension'];
			            $url = $base_url.'uploads/library/';
			            $files = '<a data-src="'.$src.$url.rawurlencode($files).$embed.'" data-fancybox data-type="'.$type.'">'.$files_name.'</a>';
		            }
		        }

				$rowExpired = filesExpired($item_ID, $new_child_id, 0);
				$rowExpired30 = filesExpiredNear($item_ID, $new_child_id, 0, 0, 30);
				$rowExpired90 = filesExpiredNear($item_ID, $new_child_id, 0, 31, 90);
				$totalCompliance = countCompliance($item_ID);

                $array_child_id = explode(", ", $child_id);
                if (in_array($item_ID, $array_child_id)) {
                	$output .= '<tr>';
                        $output .= '<td>'. $name .'</td>';
                        $output .= '<td>'. $rtype .'</td>';
                        $output .= '<td>'. $comment .'</td>';
		                $output .= '<td>'. $files .'</td>';
                        $output .= '<td class="text-center">'. $files_uploaded .'</td>';
                        $output .= '<td class="text-center">'. $due_date .'</td>';
                        $output .= '<td class="text-center">'. $totalCompliance .'%</td>';
		                $output .= '<td class="text-center">';
                        	if ($rowExpired > 0) {
                        		$output .= '<b class="font-red">'.$rowExpired.'</b>';
                        	} else {
                        		$output .= $rowExpired;
                        	}
		                $output .= '</td>';
		                $output .= '<td class="text-center">';
                        	if ($rowExpired30 > 0) {
                        		$output .= '<b class="font-red">'.$rowExpired30.'</b>';
                        	} else {
                        		$output .= $rowExpired30;
                        	}
		                $output .= '</td>';
		                $output .= '<td class="text-center">';
	                    	if ($rowExpired90 > 0) {
	                    		$output .= '<b class="font-red">'.$rowExpired90.'</b>';
	                    	} else {
	                    		$output .= $rowExpired90;
	                    	}
		                $output .= '</td>';
                    $output .= '</tr>';
                    
                    $output .= itemReport($item_ID, $new_child_id);
                }
            }
        }

        return $output;
    }
	if( isset($_GET['modalReport']) ) {
		$id = $_GET['modalReport'];

        if (!empty($_COOKIE['switchAccount'])) {
            $portal_user = $_COOKIE['ID'];
            $user_id = $_COOKIE['switchAccount'];
        }
        else {
            $portal_user = $_COOKIE['ID'];
            $user_id = employerID($portal_user);
        }

	    echo '<div class="table-scrollablex">
            <table class="table table-bordered table-hover" id="table2excel">
                <thead>
                    <tr>
                        <th>ITEM NAME</th>
                        <th style="width: 100px;">ITEM TYPE</th>
                        <th>LAST COMMENT</th>
                        <th class="text-center">TEMPLATE</th>
                        <th>DOCUMENT ATTACHED</th>
                        <th style="width: 150px;" class="text-center">UPLOADED DATE</th>
                        <th style="width: 150px;" class="text-center">REVIEW DUE DATE</th>
                        <th style="width: 100px;" class="text-center">COMPLIANCE</th>
                        <th style="width: 100px;" class="text-center">EXPIRED</th>
                        <th style="width: 100px;" class="text-center">1-30 DAYS</th>
                        <th style="width: 100px;" class="text-center">30-90 DAYS</th>
                    </tr>
                </thead>
                <tbody>';

					$resultItem = mysqli_query( $conn,"SELECT
                        mainID, parentID, childID, parentCollab, parentName, libType,
                        com_Total,

                        c_ID,
                        c2.comment AS c_comment,

                        t_ID,
                        t2.files AS t_files,
                        t2.filetype AS t_filetype,

                        f_ID,
                        f2.name AS f_name,
                        f2.comment AS f_comment,
                        f2.last_modified AS f_last_modified,
                        f2.due_date AS f_due_date,
                        f2.filetype AS f_filetype,
                        f2.files AS f_files,

                        x_ID,
                        x30_ID,
                        x90_ID

                        FROM
                        (
                            SELECT
                            mainID, parentID, childID, parentCollab, parentName, libType,
                            com_Total,
                            c.ID AS c_ID,
                            t.ID AS t_ID,
                            f.ID AS f_ID,
                            COALESCE(COUNT(x.ID), 0) AS x_ID,
                            COALESCE(COUNT(x30.COUNT_30), 0) AS x30_ID,
                            COALESCE(COUNT(x90.COUNT_90), 0) AS x90_ID
                            FROM
                            (
                                WITH RECURSIVE cte (mainID, parentID, childID, parentCollab, parentName, libType) AS
                                (
                                    SELECT 
                                        t1.ID AS mainID,
                                        t1.parent_id AS parentID,
                                        t1.child_id AS childID,
                                        t1.collaborator_id AS parentCollab,
                                        t1.name AS parentName,
                                        t1.type AS libType
                                    FROM tbl_library AS t1
                                    WHERE t1.deleted = 0 AND t1.user_id = $user_id AND t1.ID = $id
                                    
                                    UNION ALL
                                    
                                    SELECT 
                                        t2.ID AS mainID,
                                        t2.parent_id AS parentID,
                                        t2.child_id AS childID,
                                        t2.collaborator_id AS parentCollab,
                                        t2.name AS parentName,
                                        t2.type AS libType
                                    FROM tbl_library AS t2
                                    JOIN cte ON cte.mainID = t2.parent_id
                                    WHERE t2.deleted = 0 AND t2.user_id = $user_id
                                )
                                SELECT 
                                mainID, parentID, childID, parentCollab, parentName, libType,
                                COALESCE(COUNT(com.ID), 0) AS com_Count,
                                COALESCE(SUM(com.compliant), 0) AS com_Sum,
                                CASE WHEN COALESCE(COUNT(com.ID), 0) > 0 AND COALESCE(COUNT(com.ID), 0) = COALESCE(SUM(com.compliant), 0) THEN 100 ELSE 0 END AS com_Total

                                FROM cte

                                LEFT JOIN (
                                    SELECT
                                    *
                                    FROM tbl_library_compliance 
                                    WHERE parent_id = 0 
                                    AND deleted = 0
                                ) AS com
                                ON cte.mainID = com.library_id

                                GROUP BY cte.mainID
                            ) o

                            LEFT JOIN (
                                SELECT 
                                MAX(ID) AS ID,
                                library_id
                                FROM tbl_library_comment 
                                WHERE deleted = 0
                                GROUP BY library_id
                                ORDER BY ID DESC
                            ) AS c
                            ON o.mainID = c.library_id

                            LEFT JOIN (
                                SELECT 
                                MAX(ID) AS ID,
                                library_id
                                FROM tbl_library_template 
                                WHERE is_deleted = 0
                                GROUP BY library_id
                                ORDER BY ID DESC
                            ) AS t
                            ON o.mainID = t.library_id

                            LEFT JOIN (
                                SELECT
                                MAX(ID) AS ID,
                                library_id
                                FROM tbl_library_file 
                                WHERE deleted = 0
                                GROUP BY library_id
                                ORDER BY ID DESC
                            ) AS f
                            ON o.mainID = f.library_id

                            LEFT JOIN (
                                SELECT 
                                *
                                FROM tbl_library_file 
                                WHERE due_date <= CURDATE() 
                                AND deleted = 0 
                            ) AS x
                            ON o.mainID = x.library_id

                            LEFT JOIN (
                                SELECT
                                COUNT(*) AS COUNT_30,
                                DATE_FORMAT(due_date, '%m/%d/%Y'),
                                library_id
                                FROM tbl_library_file 
                                WHERE deleted = 0
                                AND due_date BETWEEN CURDATE() - INTERVAL 30 DAY AND CURDATE()
                            ) AS x30
                            ON o.mainID = x30.library_id

                            LEFT JOIN (
                                SELECT
                                COUNT(*) AS COUNT_90,
                                DATE_FORMAT(due_date, '%m/%d/%Y'),
                                library_id
                                FROM tbl_library_file 
                                WHERE deleted = 0
                                AND due_date BETWEEN CURDATE() - INTERVAL 90 DAY AND CURDATE() - INTERVAL 31 DAY
                            ) AS x90
                            ON o.mainID = x90.library_id

                            GROUP BY o.mainID
                        ) r

                        LEFT JOIN (
                            SELECT
                            *
                            FROM tbl_library_comment
                        ) AS c2
                        ON r.c_ID = c2.ID

                        LEFT JOIN (
                            SELECT
                            *
                            FROM tbl_library_template
                        ) AS t2
                        ON r.t_ID = t2.ID

                        LEFT JOIN (
                            SELECT
                            *
                            FROM tbl_library_file
                        ) AS f2
                        ON r.f_ID = f2.ID

                        ORDER BY parentName" );
                    if ( mysqli_num_rows($resultItem) > 0 ) {
			            while($rowItem = mysqli_fetch_array($resultItem)) {
                            $item_ID = $rowItem["mainID"];
                            $rtype = "";
                            $comment = "Not Specified";
                            $files = "";
                            $new_parent_id = $rowItem["parentID"];
                            $new_child_id = $rowItem["childID"];

                            $comment = $rowItem["c_comment"];

                            $files_name = htmlentities($rowItem["f_name"] ?? '');
                            $file_comment = $rowItem["f_comment"];

                            $files_uploaded = '';
                            if (!empty($rowItem["f_last_modified"])) {
                                $files_uploaded = $rowItem["f_last_modified"];
                                $files_uploaded = new DateTime($files_uploaded);
                                $files_uploaded = $files_uploaded->format('Y-d-m');
                            }

                            $due_date = '';
                            if (!empty($rowItem["f_due_date"])) {
                                $due_date = $rowItem["f_due_date"];
                                $due_date = new DateTime($due_date);
                                $due_date = $due_date->format('Y-d-m');
                            }

                            $filetype = $rowItem['f_filetype'];
                            $files = $rowItem["f_files"];
                            $type = 'iframe';
                            if ($filetype == 1) {
                                $fileExtension = fileExtension($files);
                                $src = $fileExtension['src'];
                                $embed = $fileExtension['embed'];
                                $type = $fileExtension['type'];
                                $file_extension = $fileExtension['file_extension'];
                                $url = $base_url.'uploads/library/';

                                $files = '<a data-src="'.$src.$url.rawurlencode($files).$embed.'" data-fancybox data-type="'.$type.'">'.$files_name.'</a>';
                            } else if ($filetype == 3) {
                                $files = '<a data-src="'.preg_replace('#[^/]*$#', '', $files).'preview" data-fancybox data-type="'.$type.'">'.$files_name.'</a>';
                            }

                            $t_files = $rowItem["t_files"];
                            $t_filetype = $rowItem['t_filetype'];
                            $type = 'iframe';
                            if ($t_filetype == 1) {
                                if (!empty($t_files)) {
                                    $fileExtension = fileExtension($t_files);
                                    $src = $fileExtension['src'];
                                    $embed = $fileExtension['embed'];
                                    $type = $fileExtension['type'];
                                    $file_extension = $fileExtension['file_extension'];
                                    $url = $base_url.'uploads/library/';

                                    $t_files = '<a data-src="'.$src.$url.rawurlencode($t_files).$embed.'" data-fancybox data-type="'.$type.'">View</a>';
                                }
                            } else if ($t_filetype == 3) {
                                $t_files = '<a data-src="'.preg_replace('#[^/]*$#', '', $t_files).'preview" data-fancybox data-type="'.$type.'">View</a>';
                            }

                            $name = $rowItem["parentName"];
                            $type_id = $rowItem["libType"];
			                $array_name_id = explode(", ", $name);
                            if (count($array_name_id) == 4 AND $type_id == 0) {
                                $data_name = array();

                                $selectType = mysqli_query($conn,"SELECT * FROM tbl_library_type WHERE ID = '".$array_name_id[0]."'");
                                if ( mysqli_num_rows($selectType) > 0 ) {
                                    while($rowType = mysqli_fetch_array($selectType)) {
                                        array_push($data_name, $rowType["name"]);
                                    }
                                }

                                $selectCategory = mysqli_query($conn,"SELECT * FROM tbl_library_category WHERE ID = '".$array_name_id[1]."'");
                                if ( mysqli_num_rows($selectCategory) > 0 ) {
                                    while($rowCategory = mysqli_fetch_array($selectCategory)) {
                                        array_push($data_name, $rowCategory["name"]);
                                    }
                                }

                                $selectScope = mysqli_query($conn,"SELECT * FROM tbl_library_scope WHERE ID = '".$array_name_id[2]."'");
                                if ( mysqli_num_rows($selectScope) > 0 ) {
                                    while($rowScope = mysqli_fetch_array($selectScope)) {
                                        array_push($data_name, $rowScope["name"]);
                                    }
                                }

                                $selectModule = mysqli_query($conn,"SELECT * FROM tbl_library_module WHERE ID = '".$array_name_id[3]."'");
                                if ( mysqli_num_rows($selectModule) > 0 ) {
                                    while($rowModule = mysqli_fetch_array($selectModule)) {
                                        array_push($data_name, $rowModule["name"]);
                                    }
                                }

                                $name = implode(" - ",$data_name);
                            }

			                if ($type_id == 0) { $rtype = ""; }
			                else if ($type_id == 1) { $rtype = "Program"; }
			                else if ($type_id == 2) { $rtype = "Policy"; }
			                else if ($type_id == 3) { $rtype = "Procedure"; }
			                else if ($type_id == 4) { $rtype = "Training"; }
			                else if ($type_id == 5) { $rtype = "Form"; }

                            $rowExpired = $rowItem["x_ID"];
                            $rowExpired30 = $rowItem["x30_ID"];
                            $rowExpired90 = $rowItem["x90_ID"];
                            $totalCompliance = $rowItem["com_Total"];

			                echo '<tr>
                                <td>'. htmlentities($name ?? '') .'</td>
                                <td>'. $rtype .'</td>
                                <td>'. htmlentities($comment ?? '') .'</td>
                                <td class="text-center">'. $t_files .'</td>
                                <td>'. $files .'</td>
		                        <td class="text-center">'. $files_uploaded .'</td>
		                        <td class="text-center">'. $due_date .'</td>
		                        <td class="text-center">'. $totalCompliance .'%</td>
		                        <td class="text-center">';
		                        	if ($rowExpired > 0) {
		                        		echo '<b class="font-red">'.$rowExpired.'</b>';
		                        	} else {
		                        		echo $rowExpired;
		                        	}
		                        echo '</td>
		                        <td class="text-center">';
		                        	if ($rowExpired30 > 0) {
		                        		echo '<b class="font-red">'.$rowExpired30.'</b>';
		                        	} else {
		                        		echo $rowExpired30;
		                        	}
		                        echo '</td>
		                        <td class="text-center">';
		                        	if ($rowExpired90 > 0) {
		                        		echo '<b class="font-red">'.$rowExpired90.'</b>';
		                        	} else {
		                        		echo $rowExpired90;
		                        	}
		                        echo '</td>
		                    </tr>';
			            }
			        } else {
			        	echo '<tr class="text-center text-default"><td colspan="6">Empty Record</td></tr>';
			        }                    
                    
                echo '</tbody>
            </table>
        </div>';

        mysqli_close($conn);
	}
	

	// Download File
	if( isset($_GET['modalDownload']) ) {
		$ID = $_GET['modalDownload'];

		$resultItem = mysqli_query( $conn,"SELECT * FROM tbl_library WHERE deleted = 0 AND ID = $ID" );
		if ( mysqli_num_rows($resultItem) > 0 ) {
        	$rowItem = mysqli_fetch_array($resultItem);
            $item_ID = $rowItem["ID"];
            $new_parent_id = $rowItem["parent_id"];
            $new_child_id = $rowItem["child_id"];

            $name = $rowItem["name"];
            $array_name_id = explode(", ", $name);
            if ( count($array_name_id) == 4 ) {
                $data_name = array();

                $selectType = mysqli_query($conn,"SELECT * FROM tbl_library_type WHERE ID = '".$array_name_id[0]."'");
                if ( mysqli_num_rows($selectType) > 0 ) {
                    while($rowType = mysqli_fetch_array($selectType)) {
                        array_push($data_name, $rowType["name"]);
                    }
                }

                $selectCategory = mysqli_query($conn,"SELECT * FROM tbl_library_category WHERE ID = '".$array_name_id[1]."'");
                if ( mysqli_num_rows($selectCategory) > 0 ) {
                    while($rowCategory = mysqli_fetch_array($selectCategory)) {
                        array_push($data_name, $rowCategory["name"]);
                    }
                }

                $selectScope = mysqli_query($conn,"SELECT * FROM tbl_library_scope WHERE ID = '".$array_name_id[2]."'");
                if ( mysqli_num_rows($selectScope) > 0 ) {
                    while($rowScope = mysqli_fetch_array($selectScope)) {
                        array_push($data_name, $rowScope["name"]);
                    }
                }

                $selectModule = mysqli_query($conn,"SELECT * FROM tbl_library_module WHERE ID = '".$array_name_id[3]."'");
                if ( mysqli_num_rows($selectModule) > 0 ) {
                    while($rowModule = mysqli_fetch_array($selectModule)) {
                        array_push($data_name, $rowModule["name"]);
                    }
                }

                $name = implode(" - ",$data_name);
            }
			$file_zip_name = date('Y-m-d') .'_backup_'.$name.'.zip';
			$file_path = 'uploads/library/';
			$file_names = array();
			$file_names_child = array();

			$file_names = array_merge($file_names, fileList($item_ID));
			if (!empty($new_child_id)) {
				$new_child_id_arr = explode(', ', $new_child_id);
				foreach($new_child_id_arr as $child_id){
					$file_names = array_merge($file_names, fileParent($child_id, $file_names_child));
				}
			}

			// echo $file_zip_name;
			// if (count($file_names) > 0) {
			// 	echo '<ol>';
			// 		foreach($file_names as $files) {
			// 			echo '<li>'.$files.'</li>';
			// 	    }
			// 	echo '</ol>';
			// }


			// // $selectData = mysqli_query( $conn,"SELECT * FROM tbl_library_file WHERE deleted = 0 AND library_id = 1 AND ID = 155");
			// $selectData = mysqli_query( $conn,"SELECT * FROM tbl_library_file WHERE deleted = 0 AND library_id = $item_ID");
			// if ( mysqli_num_rows($selectData) > 0 ) {
			// 	while($rowData = mysqli_fetch_array($selectData)) {
			// 		$data_files = urldecode($rowData['files']);
			// 		array_push($file_names, $data_files);
			// 	}
			// 	// zipFilesAndDownload($file_names, $file_zip_name, $file_path);
			// }


			// if (!empty($new_child_id)) {
			// 	$new_child_id_arr = explode(', ', $new_child_id);
			// 	foreach($new_child_id_arr as $child_id){
			// 		$resultItemChild = mysqli_query( $conn,"SELECT * FROM tbl_library WHERE deleted = 0 AND ID = $child_id" );
			// 		if ( mysqli_num_rows($resultItemChild) > 0 ) {
			// 			$rowItemChild = mysqli_fetch_array($resultItemChild);
			//             $item_ID = $rowItemChild["ID"];
			//             $new_parent_id = $rowItemChild["parent_id"];
			//             $new_child_id = $rowItemChild["child_id"];

			// 			$selectData = mysqli_query( $conn,"SELECT * FROM tbl_library_file WHERE deleted = 0 AND library_id = $item_ID");
			// 			if ( mysqli_num_rows($selectData) > 0 ) {
			// 				while($rowData = mysqli_fetch_array($selectData)) {
			// 					$data_files = urldecode($rowData['files']);
			// 					array_push($file_names, $data_files);
			// 				}
			// 			}
			// 		}
			// 	}
			// }

			if ( count($file_names) > 0 ) {
				zipFilesAndDownload($file_names, $file_zip_name, $file_path);
			}
		}
	}
	function fileList($item_ID) {
        global $conn;
        $file_names = array();

		$selectData = mysqli_query( $conn,"SELECT * FROM tbl_library_file WHERE deleted = 0 AND library_id = $item_ID");
		if ( mysqli_num_rows($selectData) > 0 ) {
			while($rowData = mysqli_fetch_array($selectData)) {
				$data_files = urldecode($rowData['files']);
				array_push($file_names, $data_files);
			}
		}

		return $file_names;
	}
	function fileParent($child_id, $file_names_child) {
        global $conn;

		$resultItemChild = mysqli_query( $conn,"SELECT * FROM tbl_library WHERE deleted = 0 AND ID = $child_id" );
		if ( mysqli_num_rows($resultItemChild) > 0 ) {
			$rowItemChild = mysqli_fetch_array($resultItemChild);
	        $item_ID = $rowItemChild["ID"];
	        $new_parent_id = $rowItemChild["parent_id"];
	        $new_child_id = $rowItemChild["child_id"];
			$file_names_child_new = array();

			$file_names_child = array_merge($file_names_child, fileList($item_ID));

			if (!empty($new_child_id)) {
				$new_child_id_arr = explode(', ', $new_child_id);
				foreach($new_child_id_arr as $child_id_new){
					$file_names_child = array_merge($file_names_child, fileParent($child_id_new, $file_names_child_new));
				}
			}
		}

		return $file_names_child;
	}
	function zipFilesAndDownload($file_names, $file_zip_name, $file_path) {
	    //echo $file_path;die;
	    $zip = new \ZipArchive();
	    //create the file and throw the error if unsuccessful
	    if ($zip->open($file_zip_name, ZIPARCHIVE::CREATE )!==TRUE) {
	        exit("cannot open <$file_zip_name>\n");
	    }
	    //add each files of $file_name array to archive
	    foreach($file_names as $files)
	    {
	        $zip->addFile($file_path.$files, $files);
	        //echo $file_path.$files,$files."

	    }
	    $zip->close();
	    //then send the headers to force download the zip file
	    header("Content-type: application/zip"); 
		header("Content-Disposition: attachment; filename=$file_zip_name");
		header("Content-length: " . filesize($file_zip_name));
		header("Pragma: no-cache"); 
		header("Expires: 0"); 
		readfile("$file_zip_name");
	    exit;
	}

	// File Uploads and Compliance Checking
	if( isset($_GET['modalFileUploads']) ) {
		$ID = $_GET['modalFileUploads'];
		$types = $_GET['type'];
		$data = '';

		if (!empty($_COOKIE['switchAccount'])) {
			$portal_user = $_COOKIE['ID'];
			$user_id = $_COOKIE['switchAccount'];
		}
		else {
			$portal_user = $_COOKIE['ID'];
			$user_id = employerID($portal_user);
		}

	    if ($types == 1) {
        	$selectFileJoin = 'SELECT library_id, files, name, last_modified, due_date FROM tbl_library_file WHERE deleted = 0';
        } else if ($types == 2) {
        	$selectFileJoin = 'SELECT library_id, files, name, last_modified, due_date FROM tbl_library_file WHERE deleted = 0 AND due_date < CURDATE()';
        } else if ($types == 3) {
        	$selectFileJoin = 'SELECT library_id, files, name, last_modified, due_date FROM tbl_library_file WHERE deleted = 0 AND DATEDIFF(CURDATE(), DATE_SUB(due_date, INTERVAL 30 DAY)) >= 0 AND DATEDIFF(CURDATE(), DATE_SUB(due_date, INTERVAL 30 DAY)) <= 30';
        } else if ($types == 4) {
        	$selectFileJoin = 'SELECT library_id, files, name, last_modified, due_date FROM tbl_library_file WHERE deleted = 0 AND DATEDIFF(CURDATE(), DATE_SUB(due_date, INTERVAL 30 DAY)) >= 60 AND DATEDIFF(CURDATE(), DATE_SUB(due_date, INTERVAL 30 DAY)) <= 90';
        }

	    $selectFile = mysqli_query( $conn,"WITH RECURSIVE cte (mainID, parentID, parentCollab, parentName) AS
	    	(
			    SELECT 
			        t1.ID AS mainID,
			        t1.parent_id AS parentID,
			        t1.collaborator_id AS parentCollab,
			        t1.name AS parentName
			    FROM tbl_library AS t1
			    WHERE t1.deleted = 0 AND t1.user_id = $user_id AND t1.parent_id = 0 AND t1.ID = $ID
			    
			    UNION ALL
			    
			    SELECT 
			        t2.ID AS mainID,
			        t2.parent_id AS parentID,
			        t2.collaborator_id AS parentCollab,
			        t2.name AS parentName
			    FROM tbl_library AS t2
			    JOIN cte ON cte.mainID = t2.parent_id
			    WHERE t2.deleted = 0 AND t2.user_id = $user_id
			)
			SELECT 
			mainID, parentID, parentCollab, parentName,
			f.files AS fileSource,
			f.name AS fileName,
			f.last_modified AS fileDocDate,
			f.due_date AS fileDueDate
			FROM cte

			LEFT JOIN (
			    $selectFileJoin
			) AS f
			ON cte.mainID = f.library_id
			WHERE f.name IS NOT NULL");
	    if ( mysqli_num_rows($selectFile) > 0 ) {
	    	while($rowFile = mysqli_fetch_array($selectFile)) {
			    $dashboard_ID = $rowFile["mainID"];
	            $file_name = $rowFile["fileName"];
	            $file_last_modified = $rowFile["fileDocDate"];
	            $file_due_date = $rowFile["fileDueDate"];

                $dashboard_name = $rowFile["parentName"];
                $array_name_id = explode(", ", $dashboard_name);
                if ( count($array_name_id) == 4 ) {
                    $data_name = array();

                    $selectType = mysqli_query($conn,"SELECT * FROM tbl_library_type WHERE ID = '".$array_name_id[0]."'");
                    if ( mysqli_num_rows($selectType) > 0 ) {
                        while($rowType = mysqli_fetch_array($selectType)) {
                            array_push($data_name, $rowType["name"]);
                        }
                    }

                    $selectCategory = mysqli_query($conn,"SELECT * FROM tbl_library_category WHERE ID = '".$array_name_id[1]."'");
                    if ( mysqli_num_rows($selectCategory) > 0 ) {
                        while($rowCategory = mysqli_fetch_array($selectCategory)) {
                            array_push($data_name, $rowCategory["name"]);
                        }
                    }

                    $selectScope = mysqli_query($conn,"SELECT * FROM tbl_library_scope WHERE ID = '".$array_name_id[2]."'");
                    if ( mysqli_num_rows($selectScope) > 0 ) {
                        while($rowScope = mysqli_fetch_array($selectScope)) {
                            array_push($data_name, $rowScope["name"]);
                        }
                    }

                    $selectModule = mysqli_query($conn,"SELECT * FROM tbl_library_module WHERE ID = '".$array_name_id[3]."'");
                    if ( mysqli_num_rows($selectModule) > 0 ) {
                        while($rowModule = mysqli_fetch_array($selectModule)) {
                            array_push($data_name, $rowModule["name"]);
                        }
                    }

                    $dashboard_name = implode(" - ",$data_name);
                }

                $file_files = $rowFile["fileSource"];
                $fileExtension = fileExtension($file_files);
        		$src = $fileExtension['src'];
        		$embed = $fileExtension['embed'];
        		$type = $fileExtension['type'];
        		$file_extension = $fileExtension['file_extension'];
	            $url = $base_url.'uploads/library/';

	            $data .= '<tr>
	            	<td><a href="'.$base_url.'dashboard?d='.$dashboard_ID.'" target="_blank">'.$dashboard_name.'</a></td>
	            	<td><a href="'.$src.$url.rawurlencode($file_files).$embed.'" data-src="'.$src.$url.rawurlencode($file_files).$embed.'" data-fancybox data-type="'.$type.'">'.$file_name.'</a></td>
	            	<td class="text-center">'.$file_last_modified.'</td>
	            	<td class="text-center">'.$file_due_date.'</td>
	            </tr>';
	    	}
	    }
		echo $data;
	}
    if( isset($_GET['modalFileUploadOther']) ) {
        $ID = $_GET['modalFileUploadOther'];
        $section = $_GET['section'];
        $types = $_GET['type'];
        $data = '';

        if (!empty($_COOKIE['switchAccount'])) {
            $portal_user = $_COOKIE['ID'];
            $switch_user_id = $_COOKIE['switchAccount'];
        }
        else {
            $portal_user = $_COOKIE['ID'];
            $switch_user_id = employerID($portal_user);
        }


        if ($section == 1) {
            if ($ID > 0) {
                $sql_extra = '';
                if ($types == 2) {
                    $sql_extra = ' AND (expiry_date IS NULL OR LENGTH(expiry_date) = 0 OR DATE(expiry_date) < CURDATE())';
                } else if ($types == 3) {
                    $sql_extra = ' AND expiry_date IS NOT NULL
                    AND LENGTH(expiry_date) > 0
                    AND expiry_date BETWEEN CURDATE() AND CURDATE() - INTERVAL 30 DAY';
                } else if ($types == 4) {
                    $sql_extra = ' AND expiry_date IS NOT NULL
                    AND LENGTH(expiry_date) > 0
                    AND expiry_date BETWEEN CURDATE() - INTERVAL 31 DAY AND CURDATE() - INTERVAL 90 DAY';
                }

                $selectEnterprise = mysqli_query( $conn,"SELECT
                    table_entities AS type,
                    registration_name AS name,
                    supporting_file AS file,
                    registration_date AS date_start,
                    expiry_date AS date_end

                    FROM tblFacilityDetails_registration 

                    WHERE ownedby = $switch_user_id
                    AND table_entities = $ID".$sql_extra );
            } else {
                $sql_extra = '';
                if ($types == 2) {
                    $sql_extra = ' AND (DocumentDueDate IS NULL OR LENGTH(DocumentDueDate) = 0 OR DATE(DocumentDueDate) < CURDATE())';
                } else if ($types == 3) {
                    $sql_extra = ' AND DocumentDueDate IS NOT NULL
                    AND LENGTH(DocumentDueDate) > 0
                    AND DocumentDueDate BETWEEN CURDATE() AND CURDATE() - INTERVAL 30 DAY';
                } else if ($types == 4) {
                    $sql_extra = ' AND DocumentDueDate IS NOT NULL
                    AND LENGTH(DocumentDueDate) > 0
                    AND DocumentDueDate BETWEEN CURDATE() - INTERVAL 31 DAY AND CURDATE() - INTERVAL 90 DAY';
                }

                $selectEnterprise = mysqli_query( $conn,"SELECT
                    DocumentTitle AS name,
                    EnterpriseRecordsFile AS file,
                    rec_date_added AS date_start,
                    DocumentDueDate AS date_end
                    FROM tblEnterpiseDetails_Records

                    WHERE user_cookies = $switch_user_id".$sql_extra );
            }
            if ( mysqli_num_rows($selectEnterprise) > 0 ) {
                while($rowEnterprise = mysqli_fetch_array($selectEnterprise)) {
                    $name = $rowEnterprise["name"];

                    $type = '';
                    $file = $rowEnterprise["file"];
                    if (!empty($file)) {
                        $fileExtension = fileExtension($file);
                        $src = $fileExtension['src'];
                        $embed = $fileExtension['embed'];
                        $type = $fileExtension['type'];
                        $file_extension = $fileExtension['file_extension'];
                        $url = $base_url.'companyDetailsFolder/';

                        $file = $src.$url.rawurlencode($file).$embed;
                    }

                    $date_start = $rowEnterprise["date_start"];
                    $date_start = new DateTime($date_start);
                    $date_start = $date_start->format('M d, Y');

                    $date_end = $rowEnterprise["date_end"];
                    $date_end = new DateTime($date_end);
                    $date_end = $date_end->format('M d, Y');

                    echo '<tr>
                        <td><a href="'.$file.'" data-src="'.$file.'" data-fancybox data-type="'.$type.'">'.$name.'</a></td>
                        <td class="text-center">'.$date_start.'</td>
                        <td class="text-center">'.$date_end.'</td>
                    </tr>';
                }
            }
        } else if ($section == 2) {
            if ($ID == 1) {
                $sql_extra = '';
                if ($types == 2) {
                    $sql_extra = ' AND (Expiration_Date_Type_Accreditation IS NULL OR LENGTH(Expiration_Date_Type_Accreditation) = 0 OR DATE(Expiration_Date_Type_Accreditation) < CURDATE())';
                } else if ($types == 3) {
                    $sql_extra = ' AND Expiration_Date_Type_Accreditation IS NOT NULL
                    AND LENGTH(Expiration_Date_Type_Accreditation) > 0
                    AND Expiration_Date_Type_Accreditation BETWEEN CURDATE() AND CURDATE() - INTERVAL 30 DAY';
                } else if ($types == 4) {
                    $sql_extra = ' AND Expiration_Date_Type_Accreditation IS NOT NULL
                    AND LENGTH(Expiration_Date_Type_Accreditation) > 0
                    AND Expiration_Date_Type_Accreditation BETWEEN CURDATE() - INTERVAL 31 DAY AND CURDATE() - INTERVAL 90 DAY';
                }

                $selectEnterprise = mysqli_query( $conn,"SELECT
                    Descriptions_Accreditation AS name,
                    Accreditation AS file,
                    Issue_Date_Type_Accreditation AS date_start,
                    Expiration_Date_Type_Accreditation AS date_end
                    FROM tblFacilityDetails_Accreditation
            
                    WHERE user_cookies = $switch_user_id".$sql_extra );
            } else if ($ID == 2) {
                $sql_extra = '';
                if ($types == 2) {
                    $sql_extra = ' AND (Expiration_Date_Certification IS NULL OR LENGTH(Expiration_Date_Certification) = 0 OR DATE(Expiration_Date_Certification) < CURDATE())';
                } else if ($types == 3) {
                    $sql_extra = ' AND Expiration_Date_Certification IS NOT NULL
                    AND LENGTH(Expiration_Date_Certification) > 0
                    AND Expiration_Date_Certification BETWEEN CURDATE() AND CURDATE() - INTERVAL 30 DAY';
                } else if ($types == 4) {
                    $sql_extra = ' AND Expiration_Date_Certification IS NOT NULL
                    AND LENGTH(Expiration_Date_Certification) > 0
                    AND Expiration_Date_Certification BETWEEN CURDATE() - INTERVAL 31 DAY AND CURDATE() - INTERVAL 90 DAY';
                }

                $selectEnterprise = mysqli_query( $conn,"SELECT
                    Descriptions_Certification AS name,
                    Certification AS file,
                    Issue_Date_Certification AS date_start,
                    Expiration_Date_Certification AS date_end
                    FROM tblFacilityDetails_Certification
            
                    WHERE user_cookies = $switch_user_id".$sql_extra );
            } else if ($ID == 3) {
                $sql_extra = '';
                if ($types == 2) {
                    $sql_extra = ' AND (Expiration_Date IS NULL OR LENGTH(Expiration_Date) = 0 OR DATE(Expiration_Date) < CURDATE())';
                } else if ($types == 3) {
                    $sql_extra = ' AND Expiration_Date IS NOT NULL
                    AND LENGTH(Expiration_Date) > 0
                    AND Expiration_Date BETWEEN CURDATE() AND CURDATE() - INTERVAL 30 DAY';
                } else if ($types == 4) {
                    $sql_extra = ' AND Expiration_Date IS NOT NULL
                    AND LENGTH(Expiration_Date) > 0
                    AND Expiration_Date BETWEEN CURDATE() - INTERVAL 31 DAY AND CURDATE() - INTERVAL 90 DAY';
                }

                $selectEnterprise = mysqli_query( $conn,"SELECT
                    Descriptions AS name,
                    Permits AS file,
                    Issue_Date AS date_start,
                    Expiration_Date AS date_end
                    FROM tblFacilityDetails_Permits
            
                    WHERE user_cookies = $switch_user_id".$sql_extra );
            } else if ($ID == 4) {
                $sql_extra = '';
                if ($types == 2) {
                    $sql_extra = ' AND (expiry_date IS NULL OR LENGTH(expiry_date) = 0 OR DATE(expiry_date) < CURDATE())';
                } else if ($types == 3) {
                    $sql_extra = ' AND expiry_date IS NOT NULL
                    AND LENGTH(expiry_date) > 0
                    AND expiry_date BETWEEN CURDATE() AND CURDATE() - INTERVAL 30 DAY';
                } else if ($types == 4) {
                    $sql_extra = ' AND expiry_date IS NOT NULL
                    AND LENGTH(expiry_date) > 0
                    AND expiry_date BETWEEN CURDATE() - INTERVAL 31 DAY AND CURDATE() - INTERVAL 90 DAY';
                }

                $selectEnterprise = mysqli_query( $conn,"SELECT
                    registration_name AS name,
                    supporting_file AS file,
                    registration_date AS date_start,
                    expiry_date AS date_end
                    FROM tblFacilityDetails_registration
            
                    WHERE ownedby = $switch_user_id
                    AND table_entities = 2".$sql_extra );
            }
            if ( mysqli_num_rows($selectEnterprise) > 0 ) {
                while($rowEnterprise = mysqli_fetch_array($selectEnterprise)) {
                    $name = $rowEnterprise["name"];

                    $type = '';
                    $file = $rowEnterprise["file"];
                    if (!empty($file)) {
                        $fileExtension = fileExtension($file);
                        $src = $fileExtension['src'];
                        $embed = $fileExtension['embed'];
                        $type = $fileExtension['type'];
                        $file_extension = $fileExtension['file_extension'];
                        $url = $base_url.'facility_files_Folder/';

                        $file = $src.$url.rawurlencode($file).$embed;
                    }

                    $date_start = $rowEnterprise["date_start"];
                    $date_start = new DateTime($date_start);
                    $date_start = $date_start->format('M d, Y');

                    $date_end = $rowEnterprise["date_end"];
                    $date_end = new DateTime($date_end);
                    $date_end = $date_end->format('M d, Y');

                    echo '<tr>
                        <td><a href="'.$file.'" data-src="'.$file.'" data-fancybox data-type="'.$type.'">'.$name.'</a></td>
                        <td class="text-center">'.$date_start.'</td>
                        <td class="text-center">'.$date_end.'</td>
                    </tr>';
                }
            }
        }
    }
	if( isset($_GET['modalComplianceList']) ) {
		$ID = $_GET['modalComplianceList'];
		$data = '';

		if (!empty($_COOKIE['switchAccount'])) {
			$portal_user = $_COOKIE['ID'];
			$user_id = $_COOKIE['switchAccount'];
		}
		else {
			$portal_user = $_COOKIE['ID'];
			$user_id = employerID($portal_user);
		}

	    $selectDashboard = mysqli_query( $conn,"WITH RECURSIVE cte (mainID, parentID, parentCollab, parentName) AS
	    	(
			    SELECT 
			        t1.ID AS mainID,
			        t1.parent_id AS parentID,
			        t1.collaborator_id AS parentCollab,
			        t1.name AS parentName
			    FROM tbl_library AS t1
			    WHERE t1.deleted = 0 AND t1.user_id = $user_id AND t1.parent_id = 0 AND t1.ID = $ID
			    
			    UNION ALL
			    
			    SELECT 
			        t2.ID AS mainID,
			        t2.parent_id AS parentID,
			        t2.collaborator_id AS parentCollab,
			        t2.name AS parentName
			    FROM tbl_library AS t2
			    JOIN cte ON cte.mainID = t2.parent_id
			    WHERE t2.deleted = 0 AND t2.user_id = $user_id
			)
			SELECT 
			mainID, parentID, parentCollab, parentName,
			COALESCE(c.percent_compliant, 0) as complyPercentage
			FROM cte

			LEFT JOIN (
			SELECT
			    ID,
			    library_id,
			    action_items,
			    COUNT(ID) AS count_ID, 
			    SUM(compliant) as sum_compliant,
			    CASE WHEN COUNT(ID) = SUM(compliant = 1) THEN 100 ELSE 0 END AS percent_compliant 
			    FROM tbl_library_compliance 
			    WHERE deleted = 0
			    AND parent_id = 0
			    GROUP BY library_id
			) AS c 
			ON cte.mainID = c.library_id");
	    if ( mysqli_num_rows($selectDashboard) > 0 ) {
	    	while($rowDashboard = mysqli_fetch_array($selectDashboard)) {
	            $dashboard_ID = $rowDashboard["mainID"];
	            $dashboard_complyPercentage = $rowDashboard["complyPercentage"];

                $dashboard_name = $rowDashboard["parentName"];
                $array_name_id = explode(", ", $dashboard_name);
                if ( count($array_name_id) == 4 ) {
                    $data_name = array();

                    $selectType = mysqli_query($conn,"SELECT * FROM tbl_library_type WHERE ID = '".$array_name_id[0]."'");
                    if ( mysqli_num_rows($selectType) > 0 ) {
                        while($rowType = mysqli_fetch_array($selectType)) {
                            array_push($data_name, $rowType["name"]);
                        }
                    }

                    $selectCategory = mysqli_query($conn,"SELECT * FROM tbl_library_category WHERE ID = '".$array_name_id[1]."'");
                    if ( mysqli_num_rows($selectCategory) > 0 ) {
                        while($rowCategory = mysqli_fetch_array($selectCategory)) {
                            array_push($data_name, $rowCategory["name"]);
                        }
                    }

                    $selectScope = mysqli_query($conn,"SELECT * FROM tbl_library_scope WHERE ID = '".$array_name_id[2]."'");
                    if ( mysqli_num_rows($selectScope) > 0 ) {
                        while($rowScope = mysqli_fetch_array($selectScope)) {
                            array_push($data_name, $rowScope["name"]);
                        }
                    }

                    $selectModule = mysqli_query($conn,"SELECT * FROM tbl_library_module WHERE ID = '".$array_name_id[3]."'");
                    if ( mysqli_num_rows($selectModule) > 0 ) {
                        while($rowModule = mysqli_fetch_array($selectModule)) {
                            array_push($data_name, $rowModule["name"]);
                        }
                    }

                    $dashboard_name = implode(" - ",$data_name);
                }

	            $data .= '<tr>
	            	<td><a href="'.$base_url.'dashboard?d='.$dashboard_ID.'" target="_blank">'.$dashboard_name.'</a></td>
	            	<td class="text-center">'.$dashboard_complyPercentage.'%</td>
	            </tr>';

	    	}
	    }
		echo $data;
	}
?>